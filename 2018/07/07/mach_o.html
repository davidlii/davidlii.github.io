<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="This is Davidli&#39;s blog ~">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" type="image/ico" href="/image/logo.png"> 
  
  <title>
    
      Mach-O | Davidli
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  <script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png">
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Davidli</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Davidli</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">归档</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">标签</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">关于</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Davidli</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">归档</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">标签</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">关于</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Mach-O</h2>
  <p class="post-date">2018-07-07</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>&emsp;Xcode 构建一个程序的过程中，会把源文件 (.m 和 .h) 文件转换为一个可执行文件（Mach-O executable）。这个可执行文件中包含的字节码将会被 CPU (iOS 设备中的 ARM 处理器或 Mac 上的 Intel 处理器) 执行。当然，我们也可以不使用 Xcode，而是通过苹果提供的命令行工具（command line tools）来构建一个程序。</p>
<h2 id="1-不使用-Xcode-的-Hello-World"><a href="#1-不使用-Xcode-的-Hello-World" class="headerlink" title="#1 不使用 Xcode 的 Hello World"></a>#1 不使用 Xcode 的 Hello World</h2><p>通过终端 (Terminal)，创建一个包含一个 C 文件的文件夹：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir command-line</span><br><span class="line">$ cd !$</span><br><span class="line">$ touch helloworld.c</span><br></pre></td></tr></table></figure>
<p>使用文本编辑器来编辑这个文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open -e helloworld.c</span><br></pre></td></tr></table></figure>
<p>输入如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;Hello World!\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保存并返回到终端，然后运行如下命令编译 helloworld.c 文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ xcrun clang helloworld.c</span><br></pre></td></tr></table></figure>
<p>这里会产生一个名为 a.out 的文件，使用file命令查看其信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file a.out </span><br><span class="line">a.out: Mach-O 64-bit executable x86_64</span><br></pre></td></tr></table></figure>
<p>这个 a.out 文件就是使用 clang 编译器将 helloworld.c 编译后产生的一个 Mach-O 格式的二进制文件。注意，如果没有指定名字，那么编译器会默认的将其指定为 a.out。</p>
<p>然后我们执行此二进制文件，终端中的输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out </span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2-Mach-O（可执行文件格式）"><a href="#2-Mach-O（可执行文件格式）" class="headerlink" title="#2 Mach-O（可执行文件格式）"></a>#2 Mach-O（可执行文件格式）</h2><p>Mach-O 是 Mach object 文件格式的缩写，类似于 windows 环境下的 PE 格式、Linux 环境下的 ELF 格式。我们平时见到的可执行文件、dSYM符号文件、Dylib动态库、Framework 等使用的都是这种格式。</p>
<blockquote>
<p>Mach-O提供更多的可扩展性和更快的符号表信息存取。</p>
</blockquote>
<blockquote>
<p>Mach-O应用在基于Mach核心的系统上，目前NeXTSTEP、Darwin、Mac OS X（iPhone）都是使用这种可执行文件格式。</p>
</blockquote>
<p>Mach-O 文件的结构由 Header、Load commands、Data（包含Segement的具体数据）组成。</p>
<p><img src="https://davidlii.nos-eastchina1.126.net/pic_mach_o.jpg" alt="image"></p>
<p>上面我们编译出的可执行文件 a.out 使用的也是这种格式。</p>
<p>#示例1：使用 otool 命令查看 a.out 文件的内部结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line">$ otool -l a.out </span><br><span class="line">a.out:</span><br><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line"> 0xfeedfacf 16777223          3  0x80           2    15       1200 0x00200085</span><br><span class="line">Load command 0</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 72</span><br><span class="line">  segname __PAGEZERO</span><br><span class="line">   vmaddr 0x0000000000000000</span><br><span class="line">   vmsize 0x0000000100000000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 0</span><br><span class="line">  maxprot 0x00000000</span><br><span class="line"> initprot 0x00000000</span><br><span class="line">   nsects 0</span><br><span class="line">    flags 0x0</span><br><span class="line">Load command 1</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 472</span><br><span class="line">  segname __TEXT</span><br><span class="line">   vmaddr 0x0000000100000000</span><br><span class="line">   vmsize 0x0000000000001000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 4096</span><br><span class="line">  maxprot 0x00000007</span><br><span class="line"> initprot 0x00000005</span><br><span class="line">   nsects 5</span><br><span class="line">    flags 0x0</span><br><span class="line">Section</span><br><span class="line">  sectname __text</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100000f50</span><br><span class="line">      size 0x0000000000000034</span><br><span class="line">    offset 3920</span><br><span class="line">     align 2^4 (16)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x80000400</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __stubs</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100000f84</span><br><span class="line">      size 0x0000000000000006</span><br><span class="line">    offset 3972</span><br><span class="line">     align 2^1 (2)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x80000408</span><br><span class="line"> reserved1 0 (index into indirect symbol table)</span><br><span class="line"> reserved2 6 (size of stubs)</span><br><span class="line">Section</span><br><span class="line">  sectname __stub_helper</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100000f8c</span><br><span class="line">      size 0x000000000000001a</span><br><span class="line">    offset 3980</span><br><span class="line">     align 2^2 (4)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x80000400</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __cstring</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100000fa6</span><br><span class="line">      size 0x000000000000000e</span><br><span class="line">    offset 4006</span><br><span class="line">     align 2^0 (1)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x00000002</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __unwind_info</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100000fb4</span><br><span class="line">      size 0x0000000000000048</span><br><span class="line">    offset 4020</span><br><span class="line">     align 2^2 (4)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x00000000</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Load command 2</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 232</span><br><span class="line">  segname __DATA</span><br><span class="line">   vmaddr 0x0000000100001000</span><br><span class="line">   vmsize 0x0000000000001000</span><br><span class="line">  fileoff 4096</span><br><span class="line"> filesize 4096</span><br><span class="line">  maxprot 0x00000007</span><br><span class="line"> initprot 0x00000003</span><br><span class="line">   nsects 2</span><br><span class="line">    flags 0x0</span><br><span class="line">Section</span><br><span class="line">  sectname __nl_symbol_ptr</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100001000</span><br><span class="line">      size 0x0000000000000010</span><br><span class="line">    offset 4096</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x00000006</span><br><span class="line"> reserved1 1 (index into indirect symbol table)</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __la_symbol_ptr</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100001010</span><br><span class="line">      size 0x0000000000000008</span><br><span class="line">    offset 4112</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x00000007</span><br><span class="line"> reserved1 3 (index into indirect symbol table)</span><br><span class="line"> reserved2 0</span><br><span class="line">Load command 3</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 72</span><br><span class="line">  segname __LINKEDIT</span><br><span class="line">   vmaddr 0x0000000100002000</span><br><span class="line">   vmsize 0x0000000000001000</span><br><span class="line">  fileoff 8192</span><br><span class="line"> filesize 240</span><br><span class="line">  maxprot 0x00000007</span><br><span class="line"> initprot 0x00000001</span><br><span class="line">   nsects 0</span><br><span class="line">    flags 0x0</span><br><span class="line">Load command 4</span><br><span class="line">            cmd LC_DYLD_INFO_ONLY</span><br><span class="line">        cmdsize 48</span><br><span class="line">     rebase_off 8192</span><br><span class="line">    rebase_size 8</span><br><span class="line">       bind_off 8200</span><br><span class="line">      bind_size 24</span><br><span class="line">  weak_bind_off 0</span><br><span class="line"> weak_bind_size 0</span><br><span class="line">  lazy_bind_off 8224</span><br><span class="line"> lazy_bind_size 16</span><br><span class="line">     export_off 8240</span><br><span class="line">    export_size 48</span><br><span class="line">Load command 5</span><br><span class="line">     cmd LC_SYMTAB</span><br><span class="line"> cmdsize 24</span><br><span class="line">  symoff 8296</span><br><span class="line">   nsyms 4</span><br><span class="line">  stroff 8376</span><br><span class="line"> strsize 56</span><br><span class="line">Load command 6</span><br><span class="line">            cmd LC_DYSYMTAB</span><br><span class="line">        cmdsize 80</span><br><span class="line">      ilocalsym 0</span><br><span class="line">      nlocalsym 0</span><br><span class="line">     iextdefsym 0</span><br><span class="line">     nextdefsym 2</span><br><span class="line">      iundefsym 2</span><br><span class="line">      nundefsym 2</span><br><span class="line">         tocoff 0</span><br><span class="line">           ntoc 0</span><br><span class="line">      modtaboff 0</span><br><span class="line">        nmodtab 0</span><br><span class="line">   extrefsymoff 0</span><br><span class="line">    nextrefsyms 0</span><br><span class="line"> indirectsymoff 8360</span><br><span class="line">  nindirectsyms 4</span><br><span class="line">      extreloff 0</span><br><span class="line">        nextrel 0</span><br><span class="line">      locreloff 0</span><br><span class="line">        nlocrel 0</span><br><span class="line">Load command 7</span><br><span class="line">          cmd LC_LOAD_DYLINKER</span><br><span class="line">      cmdsize 32</span><br><span class="line">         name /usr/lib/dyld (offset 12)</span><br><span class="line">Load command 8</span><br><span class="line">     cmd LC_UUID</span><br><span class="line"> cmdsize 24</span><br><span class="line">    uuid 6122E2B2-9651-3991-B2BA-15B45ADC0C6B</span><br><span class="line">Load command 9</span><br><span class="line">      cmd LC_VERSION_MIN_MACOSX</span><br><span class="line">  cmdsize 16</span><br><span class="line">  version 10.13</span><br><span class="line">      sdk 10.13</span><br><span class="line">Load command 10</span><br><span class="line">      cmd LC_SOURCE_VERSION</span><br><span class="line">  cmdsize 16</span><br><span class="line">  version 0.0</span><br><span class="line">Load command 11</span><br><span class="line">       cmd LC_MAIN</span><br><span class="line">   cmdsize 24</span><br><span class="line">  entryoff 3920</span><br><span class="line"> stacksize 0</span><br><span class="line">Load command 12</span><br><span class="line">          cmd LC_LOAD_DYLIB</span><br><span class="line">      cmdsize 56</span><br><span class="line">         name /usr/lib/libSystem.B.dylib (offset 24)</span><br><span class="line">   time stamp 2 Thu Jan  1 08:00:02 1970</span><br><span class="line">      current version 1252.50.4</span><br><span class="line">compatibility version 1.0.0</span><br><span class="line">Load command 13</span><br><span class="line">      cmd LC_FUNCTION_STARTS</span><br><span class="line">  cmdsize 16</span><br><span class="line">  dataoff 8288</span><br><span class="line"> datasize 8</span><br><span class="line">Load command 14</span><br><span class="line">      cmd LC_DATA_IN_CODE</span><br><span class="line">  cmdsize 16</span><br><span class="line">  dataoff 8296</span><br><span class="line"> datasize 0</span><br></pre></td></tr></table></figure>
<h3 id="2-1-Header"><a href="#2-1-Header" class="headerlink" title="##2.1.Header"></a>##2.1.Header</h3><p>头部主要用来规定这个文件是什么，以及文件是如何被加载的（通过 otool -h 可以打印出头信息）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ otool -h a.out </span><br><span class="line">Mach header</span><br><span class="line">      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags</span><br><span class="line"> 0xfeedfacf 16777223          3  0x80           2    15       1200 0x00200085</span><br></pre></td></tr></table></figure>
<ul>
<li>32 位架构下 Header 的数据结构：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct mach_header &#123;</span><br><span class="line">    uint32_t    magic;      /* mach magic number identifier */</span><br><span class="line">    cpu_type_t  cputype;    /* cpu specifier */</span><br><span class="line">    cpu_subtype_t   cpusubtype; /* machine specifier */</span><br><span class="line">    uint32_t    filetype;   /* type of file */</span><br><span class="line">    uint32_t    ncmds;      /* number of load commands */</span><br><span class="line">    uint32_t    sizeofcmds; /* the size of all the load commands */</span><br><span class="line">    uint32_t    flags;      /* flags */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>64 位架构下 Header 的数据结构：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct mach_header &#123;</span><br><span class="line">    uint32_t    magic;      /* mach magic number identifier */</span><br><span class="line">    cpu_type_t  cputype;    /* cpu specifier */</span><br><span class="line">    cpu_subtype_t   cpusubtype; /* machine specifier */</span><br><span class="line">    uint32_t    filetype;   /* type of file */</span><br><span class="line">    uint32_t    ncmds;      /* number of load commands */</span><br><span class="line">    uint32_t    sizeofcmds; /* the size of all the load commands */</span><br><span class="line">    uint32_t    flags;      /* flags */</span><br><span class="line">    uint32_t    reserved;   /* reserved */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>64 位架构只比 32 位架构多了一个 reserved 字段。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：magic</span><br></pre></td></tr></table></figure>
<p>表示当前二进制文件的类型，不同类型的二进制文件有自己独特的”魔数值”。加载器通过这个魔数值来判断这是什么样的文件，例如32位 Mach-O 文件的魔术值是 0xfeedface、64位 Mach-O 文件的魔术值是 0xfeedfacf、胖二进制文件的魔数值是 0xcafebabe。所以这个字段也可以用于快速确认该文件用于64位还是32位。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：cputype</span><br></pre></td></tr></table></figure>
<p>cup的类型（如 iOS设备的ARM、Mac上的Intel）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：cpusubtype</span><br></pre></td></tr></table></figure>
<p>cup的子类型（如armv7、arm64等）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：filetype</span><br></pre></td></tr></table></figure>
<p>文件类型（如可执行文件、库文件、dSYM文件等），具体枚举如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* Constants for the filetype field of the mach_header</span><br><span class="line"> */</span><br><span class="line">#define MH_OBJECT   0x1     /* relocatable object file */</span><br><span class="line">#define MH_EXECUTE  0x2     /* demand paged executable file */</span><br><span class="line">#define MH_FVMLIB   0x3     /* fixed VM shared library file */</span><br><span class="line">#define MH_CORE     0x4     /* core file */</span><br><span class="line">#define MH_PRELOAD  0x5     /* preloaded executable file */</span><br><span class="line">#define MH_DYLIB    0x6     /* dynamically bound shared library */</span><br><span class="line">#define MH_DYLINKER 0x7     /* dynamic link editor */</span><br><span class="line">#define MH_BUNDLE   0x8     /* dynamically bound bundle file */</span><br><span class="line">#define MH_DYLIB_STUB   0x9     /* shared library stub for static */</span><br><span class="line">#define MH_DSYM     0xa     /* companion file with only debug */</span><br><span class="line">#define MH_KEXT_BUNDLE  0xb     /* x86_64 kexts */</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：ncmds</span><br></pre></td></tr></table></figure>
<p>指的是加载命令(Load Commands)的数量，如上面#示例1中 a.out 文件的 ncmds 是 15 个，编号为 0-14。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：sizeofcmds</span><br></pre></td></tr></table></figure>
<p>表示 N 个 Load Commands 的总字节大小， Load Commands 区域是紧接着 Header 区域的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：flags</span><br></pre></td></tr></table></figure>
<p>标志位，具体枚举值定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define MH_NOUNDEFS  0x1 //目前没有未定义的符号，不存在链接依赖</span><br><span class="line">#define MH_DYLDLINK  0x4 //该文件是dyld的输入文件，无法被再次静态链接</span><br><span class="line">#define MH_PIE 0x200000  //加载程序在随机地址空间（ASLR），只在 MH_EXECUTE中使用</span><br><span class="line">#define MH_TWOLEVEL 0x80 // 两级名称空间</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="2-2-Load-commands"><a href="#2-2-Load-commands" class="headerlink" title="##2.2. Load commands"></a>##2.2. Load commands</h3><p>Load commands 跟在 Header 部分的后面，这些加载指令负责在 Mach-O 文件加载解析时告诉加载器如何处理二进制数据：有些命令是由内核处理的，有些是由动态链接器处理的，最终会根据 cmd 字段的不同类型，使用不同的函数来加载。</p>
<p>Load commands 的结构定义如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct load_command &#123;</span><br><span class="line">    uint32_t cmd;       /* type of load command */</span><br><span class="line">    uint32_t cmdsize;   /* total size of command in bytes */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：cmd</span><br></pre></td></tr></table></figure>
<p>代表 Load commands 的类型，如 LC_SEGMENT_64、LC_UUID、LC-CODE-SIGNATURE 等等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：cmdsize</span><br></pre></td></tr></table></figure>
<p>代表 Load commands 的大小。</p>
<p>下面列举几个看上去比较熟悉的 Load commands…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 将文件的32位 或 64位的段映射到进程地址空间</span><br><span class="line">#define LC_SEGMENT  0x1 </span><br><span class="line">#define LC_SEGMENT_64   0x19    </span><br><span class="line"></span><br><span class="line">// 唯一的 UUID，标示二进制文件</span><br><span class="line">#define LC_UUID  0x1b    /* the uuid */</span><br><span class="line"></span><br><span class="line">// 启动动态加载连接器</span><br><span class="line">#define LC_LOAD_DYLINKER 0xe /* load a dynamic linker */</span><br><span class="line"></span><br><span class="line">// 代码签名和加密</span><br><span class="line">#define LC_CODE_SIGNATURE 0x1d   /* local of code signature */</span><br><span class="line">#define LC_ENCRYPTION_INFO 0x21 /* encrypted segment information */</span><br></pre></td></tr></table></figure>
<p>以 LC_SEGMENT_64 类型为例，它代表将文件中64位的段映射到进程的地址空间。它的结构定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct segment_command_64 &#123; /* for 64-bit architectures */</span><br><span class="line">    uint32_t    cmd;        /* LC_SEGMENT_64 */</span><br><span class="line">    uint32_t    cmdsize;    /* includes sizeof section_64 structs */</span><br><span class="line">    char        segname[16];    /* segment name */</span><br><span class="line">    uint64_t    vmaddr;     /* memory address of this segment */</span><br><span class="line">    uint64_t    vmsize;     /* memory size of this segment */</span><br><span class="line">    uint64_t    fileoff;    /* file offset of this segment */</span><br><span class="line">    uint64_t    filesize;   /* amount to map from the file */</span><br><span class="line">    vm_prot_t   maxprot;    /* maximum VM protection */</span><br><span class="line">    vm_prot_t   initprot;   /* initial VM protection */</span><br><span class="line">    uint32_t    nsects;     /* number of sections in segment */</span><br><span class="line">    uint32_t    flags;      /* flags */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>下面解释一下各参数的作用。。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：segname</span><br></pre></td></tr></table></figure>
<p>段的名称，下面的##2.3小结中有更详细的介绍。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：vmaddr</span><br></pre></td></tr></table></figure>
<p>段的虚拟内存地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：vmsize</span><br></pre></td></tr></table></figure>
<p>段的虚拟内存大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：fileoff</span><br></pre></td></tr></table></figure>
<p>段在文件中偏移量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：filesize</span><br></pre></td></tr></table></figure>
<p>段在文件中的大小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：nsects</span><br></pre></td></tr></table></figure>
<p>段中有多少 secetion。</p>
<p>以上面 <strong>#示例1</strong> 中的 Load command 0 为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Load command 0</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 72</span><br><span class="line">  segname __PAGEZERO</span><br><span class="line">   vmaddr 0x0000000000000000</span><br><span class="line">   vmsize 0x0000000100000000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 0</span><br><span class="line">  maxprot 0x00000000</span><br><span class="line"> initprot 0x00000000</span><br><span class="line">   nsects 0</span><br><span class="line">    flags 0x0</span><br></pre></td></tr></table></figure>
<p>它就是告诉加载器将该段文件的内容加载到内存中：从 fileoff 处加载 filesize 大小到虚拟内存 vmaddr 处。由于这里在内存地址空间中是 _PAGEZERO 段（这个段不具有访问权限，用来处理空指针）所以各参数都是零。</p>
<h3 id="2-3-Segments（段数据）"><a href="#2-3-Segments（段数据）" class="headerlink" title="##2.3. Segments（段数据）"></a>##2.3. Segments（段数据）</h3><p>Segments 包含了很多 segment，每一个 segment 定义了一些 Mach-O 文件的数据、地址和内存保护属性，这些数据在动态链接器加载程序时被映射到了虚拟内存中。每个段都有不同的功能，一般包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__PAGEZERO</span><br></pre></td></tr></table></figure>
<p>空指针陷阱段，映射到虚拟内存空间的第一页，用于捕捉对NULL指针的引用；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__TEXT</span><br></pre></td></tr></table></figure>
<p>包含了执行代码以及其他只读数据。 为了让内核将它直接从可执行文件映射到共享内存， 静态连接器设置该段的虚拟内存权限为不允许写。当这个段被映射到内存后可以被所有进程共享（这主要用在 Frameworks、 Bundles和共享库等程序中，也可以为同一个可执行文件的多个进程拷贝使用）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__DATA</span><br></pre></td></tr></table></figure>
<p>包含了程序数据，该段可写；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__OBJC</span><br></pre></td></tr></table></figure>
<p>Objective-C运行时支持库；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__LINKEDIT</span><br></pre></td></tr></table></figure>
<p>含有为动态链接库使用的原始数据，比如符号，字符串，重定位表条目等等。</p>
<h3 id="2-4-section（区数据）"><a href="#2-4-section（区数据）" class="headerlink" title="##2.4. section（区数据）"></a>##2.4. section（区数据）</h3><p>一般段又会按不同的功能划分为几个区（section）。区的字母为小写，同样加两个下划线作为前缀。下面列出段中可能包含的 section：</p>
<ul>
<li>__TEXT段</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__text, __cstring, __picsymbol_stub, __symbol_stub, __const, __litera14, __litera18;</span><br></pre></td></tr></table></figure>
<ul>
<li>__DATA段</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__data, __la_symbol_ptr, __nl_symbol_ptr, __dyld, __const, </span><br><span class="line">__mod_init_func, __mod_term_func, __bss, __commom;</span><br></pre></td></tr></table></figure>
<ul>
<li>__IMPORT段</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__jump_table, __pointers;</span><br></pre></td></tr></table></figure>
<p>其中 __TEXT 段中的 __text 是实际上的代码部分；__DATA 段的 __data 是实际的初始数据。</p>
<p>section 的数据结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct section &#123; /* for 32-bit architectures */</span><br><span class="line">    char        sectname[16];   /* name of this section */</span><br><span class="line">    char        segname[16];    /* segment this section goes in */</span><br><span class="line">    uint32_t    addr;       /* memory address of this section */</span><br><span class="line">    uint32_t    size;       /* size in bytes of this section */</span><br><span class="line">    uint32_t    offset;     /* file offset of this section */</span><br><span class="line">    uint32_t    align;      /* section alignment (power of 2) */</span><br><span class="line">    uint32_t    reloff;     /* file offset of relocation entries */</span><br><span class="line">    uint32_t    nreloc;     /* number of relocation entries */</span><br><span class="line">    uint32_t    flags;      /* flags (section type and attributes)*/</span><br><span class="line">    uint32_t    reserved1;  /* reserved (for offset or index) */</span><br><span class="line">    uint32_t    reserved2;  /* reserved (for count or sizeof) */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中部分参数的介绍:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：sectname</span><br></pre></td></tr></table></figure>
<p>section 的名字，如上面提到的 __text、__cstring等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：segname</span><br></pre></td></tr></table></figure>
<p>section 所属的 segment，比如 __TEXT。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：addr</span><br></pre></td></tr></table></figure>
<p>section 在内存的起始位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：size</span><br></pre></td></tr></table></figure>
<p>section 的大小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参数：offset</span><br></pre></td></tr></table></figure>
<p>section 的文件偏移量。</p>
<p>#示例2：通过 otool –s查看某个 section 的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ otool -s __TEXT __text a.out</span><br><span class="line">a.out:</span><br><span class="line">Contents of (__TEXT,__text) section</span><br><span class="line">0000000100000f50  55 48 89 e5 48 83 ec 20 48 8d 05 47 00 00 00 c7 </span><br><span class="line">0000000100000f60  45 fc 00 00 00 00 89 7d f8 48 89 75 f0 48 89 c7 </span><br><span class="line">0000000100000f70  b0 00 e8 0d 00 00 00 31 c9 89 45 ec 89 c8 48 83 </span><br><span class="line">0000000100000f80  c4 20 5d c3</span><br></pre></td></tr></table></figure>
<p>由于-s __TEXT __text 很常见，otool 对其设置了一个缩写 -t 。我们还可以通过添加 -v 来查看反汇编代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ otool -t -v a.out</span><br><span class="line">a.out:</span><br><span class="line">(__TEXT,__text) section</span><br><span class="line">_main:</span><br><span class="line">0000000100000f50  pushq %rbp</span><br><span class="line">0000000100000f51  movq  %rsp, %rbp</span><br><span class="line">0000000100000f54  subq  $0x20, %rsp</span><br><span class="line">0000000100000f58  leaq  0x47(%rip), %rax</span><br><span class="line">0000000100000f5f  movl  $0x0, -0x4(%rbp)</span><br><span class="line">0000000100000f66  movl  %edi, -0x8(%rbp)</span><br><span class="line">0000000100000f69  movq  %rsi, -0x10(%rbp)</span><br><span class="line">0000000100000f6d  movq  %rax, %rdi</span><br><span class="line">0000000100000f70  movb  $0x0, %al</span><br><span class="line">0000000100000f72  callq 0x100000f84</span><br><span class="line">0000000100000f77  xorl  %ecx, %ecx</span><br><span class="line">0000000100000f79  movl  %eax, -0x14(%rbp)</span><br><span class="line">0000000100000f7c  movl  %ecx, %eax</span><br><span class="line">0000000100000f7e  addq  $0x20, %rsp</span><br><span class="line">0000000100000f82  popq  %rbp</span><br><span class="line">0000000100000f83  retq</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="3-Mach-O-amp-胖文件"><a href="#3-Mach-O-amp-胖文件" class="headerlink" title="#3 Mach-O &amp; 胖文件"></a>#3 Mach-O &amp; 胖文件</h2><p>OS X 有两种类型的目标文件：Mach-O 和 <strong>universal binary</strong> ，后者就是通用二进制文件，也叫胖文件。区别在于：</p>
<ul>
<li><p>Mach-O 文件只包含一种架构（i386、x86_64、arm64 等等）的对象代码；</p>
</li>
<li><p>胖文件可能同时包含若干“包含不同架构（i386、arm、arm64 等等）对象代码”的对象文件。</p>
</li>
</ul>
<p>实际上 universal binary 文件只不过是将支持不同架构的 Mach-O 文件打包在一起，再在文件起始位置加上 fat_header 来说明所包含的 Mach-O 文件支持的架构和偏移地址信息。</p>
<p>胖文件的结构︰</p>
<table>
<thead>
<tr>
<th style="text-align:center">fat_header</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">fat_arch</td>
</tr>
<tr>
<td style="text-align:center">fat_arch</td>
</tr>
<tr>
<td style="text-align:center">。。。</td>
</tr>
</tbody>
</table>
<p>其中 fat_header 的数据结构在 mach-o\/fat.h 头文件上定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#define FAT_MAGIC   0xcafebabe</span><br><span class="line">#define FAT_CIGAM  0xbebafeca  /* NXSwapLong(FAT_MAGIC) */</span><br><span class="line"> </span><br><span class="line">struct fat_header &#123;</span><br><span class="line">    uint32_t    magic;        /* FAT_MAGIC */</span><br><span class="line">    uint32_t    nfat_arch;    /* number of structs that follow */</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">struct fat_arch &#123;</span><br><span class="line">    cpu_type_t  cputype;  /* cpu specifier (int) */</span><br><span class="line">    cpu_subtype_t   cpusubtype;   /* machine specifier (int) */</span><br><span class="line">    uint32_t    offset;       /* file offset to this object file */</span><br><span class="line">    uint32_t    size;     /* size of this object file */</span><br><span class="line">    uint32_t    align;        /* alignment as a power of 2 */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>参数说明:</p>
<ul>
<li>magic字段</li>
</ul>
<p>就是上面说的魔数，加载器通过这个魔数值来判断这是什么样的文件，胖二进制文件的魔数值是0xcafebabe；</p>
<ul>
<li>nfat_arch字段</li>
</ul>
<p>是指当前的胖二进制文件包含了多少个不同架构的 Mach-O 文件。有多少个不同架构的 Mach-O 文件，就有多少个 fat_arch，用于说明对应 Mach-O 文件大小、支持的CPU架构、偏移地址等；</p>
<p>大部分情况下，xxx.app/xxx 文件并不是 Mach-O 格式文件，由于现在需要支持不同 CPU 架构的 iOS 设备，我们编译打包出来的执行文件一般都是胖文件。当然，支持的架构越多，最终打出来的包就会越大，所以项目里的 Architectures 和 Valid Architectures 选项要根据需求来配置哟。</p>
<p>#示例3：WeChat.app/WeChat 文件的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ file WeChat</span><br><span class="line">WeChat: Mach-O universal binary with 2 architectures: </span><br><span class="line">[arm_v7:Mach-O executable arm_v7] [arm64]</span><br><span class="line">WeChat (for architecture armv7):  Mach-O executable arm_v7</span><br><span class="line">WeChat (for architecture arm64):  Mach-O 64-bit executable arm64</span><br></pre></td></tr></table></figure>
<p>最后，了解 Mach-O 文件对于使用 dSYM 解析崩溃日志、逆向工程、bitcode、应用瘦身等会有很大的帮助！更多相关的内容之后继续慢慢研究。。</p>
<hr>
<p>相关参考：</p>
<p>#<a href="https://developer.apple.com/videos/play/wwdc2016/406/?time=90" target="_blank" rel="noopener">©WWDC 2016</a></p>
<p>#<a href="http://wiki.jikexueyuan.com/project/objc/Build-tool/6-3.html" target="_blank" rel="noopener">©极客学院</a></p>
<p>#<a href="https://www.jianshu.com/p/bcc7ba20f900" target="_blank" rel="noopener">©简书1</a></p>
<p>#<a href="https://www.jianshu.com/p/54d842db3f69" target="_blank" rel="noopener">©简书2</a></p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#逆向工程">
    <span class="tag-code">逆向工程</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2018/06/22/autolayout.html">
        <span class="nav-arrow">← </span>
        
          约束与布局
        
      </a>
    
    
      <a class="nav-right" href="/2018/07/11/dsym.html">
        
          结合dSYM文件分析crash日志
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
    <!-- 二维码 END -->
    
      <!-- No Comment -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-不使用-Xcode-的-Hello-World"><span class="toc-nav-text">#1 不使用 Xcode 的 Hello World</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#2-Mach-O（可执行文件格式）"><span class="toc-nav-text">#2 Mach-O（可执行文件格式）</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-1-Header"><span class="toc-nav-text">##2.1.Header</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-2-Load-commands"><span class="toc-nav-text">##2.2. Load commands</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-3-Segments（段数据）"><span class="toc-nav-text">##2.3. Segments（段数据）</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-4-section（区数据）"><span class="toc-nav-text">##2.4. section（区数据）</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#3-Mach-O-amp-胖文件"><span class="toc-nav-text">#3 Mach-O &amp; 胖文件</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://yoursite.com/2018/07/07/mach_o.html';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()
        
        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "Mach-O",
        owner: "",
        repo: "",
        oauth: {
          client_id: "",
          client_secret: ""
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2019 | <a href="https://github.com/davidlii" target="_blank">Davidli</a>
    <br>
    <a href="https://hexo.io" target="_blank">Hexo</a> | Theme-<a href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>
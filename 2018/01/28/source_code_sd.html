

<!DOCTYPE html>
<html lang="zh-Hans" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="Davidli">
  
    <meta name="description" content="一、导入 SD库：12345platform :ios, &amp;#x27;10.0&amp;#x27;&#x2F;&#x2F;ASDF替换为自己项目的target名target ‘ASDF’ dopod &amp;#x27;SDWebImage&amp;#x27;, &amp;#x27;~&gt; 3.7.3&amp;#x27;end  二、下载类的实现以常用的UIImageView设置图片为例： 12345- (void)sd_setImageWithURL">
<meta property="og:type" content="article">
<meta property="og:title" content="SDWebImage">
<meta property="og:url" content="http://yoursite.com/2018/01/28/source_code_sd.html">
<meta property="og:site_name" content="Davidli">
<meta property="og:description" content="一、导入 SD库：12345platform :ios, &amp;#x27;10.0&amp;#x27;&#x2F;&#x2F;ASDF替换为自己项目的target名target ‘ASDF’ dopod &amp;#x27;SDWebImage&amp;#x27;, &amp;#x27;~&gt; 3.7.3&amp;#x27;end  二、下载类的实现以常用的UIImageView设置图片为例： 12345- (void)sd_setImageWithURL">
<meta property="og:locale">
<meta property="article:published_time" content="2018-01-27T17:44:07.000Z">
<meta property="article:modified_time" content="2019-09-24T11:22:34.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>SDWebImage - Davidli</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Davidli</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SDWebImage"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2018-01-28 01:44" pubdate>
          January 28, 2018 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          28k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          237 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SDWebImage</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="一、导入-SD库："><a href="#一、导入-SD库：" class="headerlink" title="一、导入 SD库："></a>一、导入 <a target="_blank" rel="noopener" href="https://github.com/rs/SDWebImage">SD库</a>：</h3><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs delphi"><span class="hljs-keyword">platform</span> :ios, <span class="hljs-string">&#x27;10.0&#x27;</span><br><span class="hljs-comment">//ASDF替换为自己项目的target名</span><br>target ‘ASDF’ <span class="hljs-keyword">do</span><br>pod <span class="hljs-string">&#x27;SDWebImage&#x27;</span>, <span class="hljs-string">&#x27;~&gt; 3.7.3&#x27;</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h3 id="二、下载类的实现"><a href="#二、下载类的实现" class="headerlink" title="二、下载类的实现"></a>二、下载类的实现</h3><p>以常用的<code>UIImageView</code>设置图片为例：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(void)</span>sd_setImageWithURL:<span class="hljs-params">(NSURL *)</span>url <br>          placeholderImage:<span class="hljs-params">(UIImage *)</span>placeholder <br>                   options:<span class="hljs-params">(SDWebImageOptions)</span>options <br>                  progress:<span class="hljs-params">(SDWebImageDownloaderProgressBlock)</span>progressBlock <br>                 completed:<span class="hljs-params">(SDWebImageCompletionBlock)</span>completedBlock;<br></code></pre></td></tr></table></figure>

<p>参数</p>
<ul>
<li>url为图片地址。</li>
<li>placeholder为占位图。</li>
<li>progressBlock为进度。</li>
<li>completedBlock下载完成或有缓存时的回调。</li>
<li>options为额外选项，一般使用 SDWebImageRetryFailed | SDWebImageLowPriority，具体如下：</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">typedef NS_OPTIONS(NSUInteger, SDWebImageOptions) &#123;<br><br>    SDWebImageRetryFailed = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>,    <span class="hljs-regexp">//</span>下载失败了会再次尝试下载(默认情况下失败的图片链接不会再重新下载)<br>    WebImageLowPriority = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,      <span class="hljs-regexp">//</span>UIScrollView等正在滚动时延迟下载图片（默认情况下不延迟，立刻开始）<br>    SDWebImageCacheMemoryOnly = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,<span class="hljs-regexp">//</span>只缓存到内存中<br>    SDWebImageProgressiveDownload = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,<span class="hljs-regexp">//</span> 图片会边下边显示<br>    SDWebImageRefreshCached = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>, <span class="hljs-regexp">//</span>强制重新请求图片并刷新缓存，将硬盘缓存交给系统自带的NSURLCache去处理<br>    SDWebImageContinueInBackground = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,<span class="hljs-regexp">//</span>后台下载<br>    SDWebImageHandleCookies = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>, <span class="hljs-regexp">//</span>处理cookie，请求的request.HTTPShouldHandleCookies 会被置为 YES;<br>    SDWebImageAllowInvalidSSLCertificates = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,<span class="hljs-regexp">//</span> 允许不受信任的SSL证书<br>    SDWebImageHighPriority = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>,  <span class="hljs-regexp">//</span>优先下载，下载任务的优先级为高<br>    SDWebImageDelayPlaceholder = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>,<span class="hljs-regexp">//</span>延迟占位符<br>    SDWebImageTransformAnimatedImage = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">10</span>,<span class="hljs-regexp">//</span>改变动画形象<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="2-1-UIImageView-WebCache"><a href="#2-1-UIImageView-WebCache" class="headerlink" title="2.1.UIImageView+WebCache"></a>2.1.UIImageView+WebCache</h4><p>主要负责对外暴露设置图片的接口，本类中具体处理的事项包括：</p>
<ul>
<li>step.1 在新的图片加载前，取消本视图上一个正在进行的下载任务；</li>
<li>step.2 交由 SDWebImageManager 处理真正的图片下载逻辑；</li>
<li>step.3 保存此次下载操作；</li>
<li>step.4 图片下载成功或失败，回到主线程回调数据并给视图设置图片；</li>
</ul>
<p>源码摘要：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// UIImageView+WebCache.m</span><br><br>- (<span class="hljs-type">void</span>)sd_setImageWithURL:(<span class="hljs-built_in">NSURL</span> *)url<br>placeholderImage:(<span class="hljs-built_in">UIImage</span> *)placeholder<br>options:(SDWebImageOptions)options<br>progress:(SDWebImageDownloaderProgressBlock)progressBlock<br>completed:(SDWebImageCompletionBlock)completedBlock<br>&#123;<br>    <span class="hljs-comment">//step.1 取消之前正在下载的操作</span><br>    [<span class="hljs-keyword">self</span> sd_cancelCurrentImageLoad];<br>    <span class="hljs-comment">//保存该视图用到的图片URL</span><br>    objc_setAssociatedObject(<span class="hljs-keyword">self</span>, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);<br>    <span class="hljs-comment">/*...*/</span><br>    <span class="hljs-keyword">if</span> (url) &#123;<br>        __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>)wself = <span class="hljs-keyword">self</span>;<br>        <span class="hljs-comment">//step.2 由SDWebImageManager下载图片</span><br>        <span class="hljs-type">id</span> &lt;SDWebImageOperation&gt; operation = [SDWebImageManager.sharedManager<br>        downloadImageWithURL:url<br>        options:options<br>        progress:progressBlock<br>        completed:^(<span class="hljs-built_in">UIImage</span> *image,<br>        <span class="hljs-built_in">NSError</span> *error, SDImageCacheType cacheType,<br>        <span class="hljs-type">BOOL</span> finished, <span class="hljs-built_in">NSURL</span> *imageURL)<br>        &#123;<br>            <span class="hljs-comment">/*step.4 图片下载结果返回，回到主线层*/</span><br>        &#125;];<br>        <span class="hljs-comment">//step.3 保存此次下载操作</span><br>        [<span class="hljs-keyword">self</span> sd_setImageLoadOperation:operation forKey:<span class="hljs-string">@&quot;UIImageViewImageLoad&quot;</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现细节：</p>
<ul>
<li>1、创建下载任务</li>
</ul>
<p>图片的下载任务是由 SDWebImageManager 执行的，它的实现细节后面会讲，这里只需要知道下载的操作经过两次封装，最终被封装到 SDWebImageCombinedOperation 对象中：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@protocol</span> SDWebImageOperation &lt;NSObject&gt;<br>- (void)cancel; <span class="hljs-comment">// 只定义了这么一个取消的方法~~</span><br><span class="hljs-variable">@end</span><br><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">SDWebImageCombinedOperation </span>: NSObject &lt;SDWebImageOperation&gt;<br><br><span class="hljs-variable">@property</span> (assign, nonatomic, getter = isCancelled) BOOL cancelled;<br><span class="hljs-variable">@property</span> (copy, nonatomic) SDWebImageNoParamsBlock cancelBlock; <span class="hljs-comment">// 在创建任务时会被赋值</span><br><span class="hljs-variable">@property</span> (strong, nonatomic) NSOperation *cacheOperation; <span class="hljs-comment">// 真正执行下载任务的类</span><br><br><span class="hljs-variable">@end</span><br></code></pre></td></tr></table></figure>

<p>在视图的分类中调用 SDWebImageManager 进行下载时，会返回一个 SDWebImageCombinedOperation 任务对象：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs erlang">// SDWebImageManager.m<br>- <span class="hljs-params">(id &lt;SDWebImageOperation&gt;)</span>downloadImageWithURL:<span class="hljs-params">(NSURL *)</span>url<br>                                         options:<span class="hljs-params">(SDWebImageOptions)</span>options<br>                                        progress:<span class="hljs-params">(SDWebImageDownloaderProgressBlock)</span>progressBlock<br>                                       completed:<span class="hljs-params">(SDWebImageCompletionWithFinishedBlock)</span>completedBlock&#123;<br>                                       <br>                        __block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];<br>                        // 略...<br>                        return operation;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>2、保存下载任务</li>
</ul>
<p>上面返回的 SDWebImageCombinedOperation 任务对象会被保存到当前视图的对象中：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> UIImageView+WebCache.m<br>[self sd_setImageLoadOperation:operation forKey:@<span class="hljs-string">&quot;UIImageViewImageLoad&quot;</span>];<br></code></pre></td></tr></table></figure>

<p>保存接口的具体逻辑如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// 属性Getter</span><br>- (<span class="hljs-built_in">NSMutableDictionary</span> *)operationDictionary &#123;<br>    <span class="hljs-comment">// 如果关联对象存在，则返回它</span><br>    <span class="hljs-built_in">NSMutableDictionary</span> *operations = objc_getAssociatedObject(<span class="hljs-keyword">self</span>, &amp;loadOperationKey);<br>    <span class="hljs-keyword">if</span> (operations) &#123;<br>        <span class="hljs-keyword">return</span> operations;<br>    &#125;<br>    <span class="hljs-comment">// 如果关联对象不存在，则创建一个新的并返回它</span><br>    operations = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>    objc_setAssociatedObject(<span class="hljs-keyword">self</span>, &amp;loadOperationKey, operations, OBJC_ASSOCIATION_RETAIN_NONATOMIC);<br>    <span class="hljs-keyword">return</span> operations;<br>&#125;<br><br><span class="hljs-comment">// 保存任务</span><br>- (<span class="hljs-type">void</span>)sd_setImageLoadOperation:(<span class="hljs-type">id</span>)operation forKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-comment">// 如果同一个视图之前有下载任务，则先取消之前的任务</span><br>    [<span class="hljs-keyword">self</span> sd_cancelImageLoadOperationWithKey:key];<br>    <span class="hljs-built_in">NSMutableDictionary</span> *operationDictionary = [<span class="hljs-keyword">self</span> operationDictionary];<br>    [operationDictionary setObject:operation forKey:key];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下载任务会被保存到当前分类中的 operationDictionary 字典属性中，此属性使用了对象关联技术提供了Getter和Setter的实现。</p>
<ul>
<li>3、取消上一个正在进行的下载任务；</li>
</ul>
<p>场景：cell 被重用时上一张图片尚未加载完，需要取消上一次的加载任务并加载新的图片。<br><br/></p>
<p>当前视图中所有的下载任务都保存在<code>operationDictionary</code>中，取消任务时要先从此字典中取出之前的任务，再执行取消方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)sd_cancelCurrentImageLoad &#123;<br>    [<span class="hljs-keyword">self</span> sd_cancelImageLoadOperationWithKey:<span class="hljs-string">@&quot;UIImageViewImageLoad&quot;</span>];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)sd_cancelImageLoadOperationWithKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-comment">// Cancel in progress downloader from queue</span><br>    <span class="hljs-built_in">NSMutableDictionary</span> *operationDictionary = [<span class="hljs-keyword">self</span> operationDictionary];<br>    <span class="hljs-comment">// 取出任务</span><br>    <span class="hljs-type">id</span> operations = [operationDictionary objectForKey:key];<br>    <span class="hljs-keyword">if</span> (operations) &#123;<br>        <span class="hljs-keyword">if</span> ([operations isKindOfClass:[<span class="hljs-built_in">NSArray</span> <span class="hljs-keyword">class</span>]]) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">id</span> &lt;SDWebImageOperation&gt; operation <span class="hljs-keyword">in</span> operations) &#123;<br>                <span class="hljs-keyword">if</span> (operation) &#123;<br>                    [operation cancel]; <span class="hljs-comment">// 取消</span><br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([operations conformsToProtocol:<span class="hljs-class"><span class="hljs-keyword">@protocol</span>(<span class="hljs-title">SDWebImageOperation</span>)])</span>&#123;<br>            [(<span class="hljs-type">id</span>&lt;SDWebImageOperation&gt;) operations cancel]; <span class="hljs-comment">// 取消</span><br>        &#125;<br>        [operationDictionary removeObjectForKey:key];  <span class="hljs-comment">//从字典中移除上一个任务</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>取消操作调用的是 SDWebImageCombinedOperation 对象 的 cancel 方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">SDWebImageCombinedOperation</span></span><br><br>- (<span class="hljs-type">void</span>)cancel &#123;<br>    <span class="hljs-keyword">self</span>.cancelled = <span class="hljs-literal">YES</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.cacheOperation) &#123;<br>        [<span class="hljs-keyword">self</span>.cacheOperation cancel];<br>        <span class="hljs-keyword">self</span>.cacheOperation = <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.cancelBlock) &#123;<br>        <span class="hljs-keyword">self</span>.cancelBlock();<br>        <br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> this is a temporary fix to #809.</span><br>        <span class="hljs-comment">// Until we can figure the exact cause of the crash, going with the ivar instead of the setter</span><br><span class="hljs-comment">//        self.cancelBlock = nil;</span><br>        _cancelBlock = <span class="hljs-literal">nil</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以，最终取消的是真正的图片下载任务<code>cacheOperation</code>对象，这是一个 NSOperation 实例。</p>
<h4 id="2-2-SDWebImageManager"><a href="#2-2-SDWebImageManager" class="headerlink" title="2.2.SDWebImageManager"></a>2.2.SDWebImageManager</h4><p>上面视图分类中只简单的取消和保存了任务的实例，具体的下载任务交给了<code>SDWebImageManager</code>。本章节就来讲解此类的具体业务：<br><br/></p>
<p>此类主要用来做具体下载前的各项检测和准备以及处理图片下载成功后的变换、缓存等：</p>
<ul>
<li>step.1 检测URL之前是否下载失败（失效过的链接不再重复下载）；</li>
<li>step.2 根据URL生成对应的key查询缓存，有缓存且不要求强制刷新缓存时直接使用缓存图片；</li>
<li>step.3 没有缓存时，交给 SDWebImageDownloader，封装请求并创建任务和队列，发起网络请求；</li>
<li>step.4 下载完成后对图片做变换、缓存图片、返回主线程；</li>
</ul>
<p>源码摘要：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// SDWebImageManager.m</span><br><br>- (<span class="hljs-type">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="hljs-built_in">NSURL</span> *)url<br>options:(SDWebImageOptions)options<br>progress:(SDWebImageDownloaderProgressBlock)progressBlock<br>completed:(SDWebImageCompletionWithFinishedBlock)completedBlock<br>&#123;<br>    <span class="hljs-comment">/*...*/</span><br>    __block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];<br><br>    <span class="hljs-comment">//step.1 检测URL之前是否下载失败</span><br>    <span class="hljs-type">BOOL</span> isFailedUrl = <span class="hljs-literal">NO</span>;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>.failedURLs) &#123;<br>        isFailedUrl = [<span class="hljs-keyword">self</span>.failedURLs containsObject:url];<br>    &#125;<br>    <br>    <span class="hljs-comment">//URL错误或之前下载失败过，则不再重复下载失效的URL</span><br>    <span class="hljs-keyword">if</span> (url.absoluteString.length == <span class="hljs-number">0</span> || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;<br>        dispatch_main_sync_safe(^&#123;<br>            <span class="hljs-built_in">NSError</span> *error = ...;<br>            completedBlock(<span class="hljs-literal">nil</span>, error, SDImageCacheTypeNone, <span class="hljs-literal">YES</span>, url);<br>        &#125;);<br>        <span class="hljs-keyword">return</span> operation;<br>    &#125;<br><br>    <span class="hljs-comment">//将当前下载 operation 加入到数组中</span><br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>.runningOperations) &#123;<br>        [<span class="hljs-keyword">self</span>.runningOperations addObject:operation];<br>    &#125;<br>    <br>    <span class="hljs-comment">//step.2 根据URL生成对应的key查询缓存 没有缓存则开始下载</span><br>    <span class="hljs-built_in">NSString</span> *key = [<span class="hljs-keyword">self</span> cacheKeyForURL:url];<br>    operation.cacheOperation = [<span class="hljs-keyword">self</span>.imageCache queryDiskCacheForKey:key<br>                                                done:^(<span class="hljs-built_in">UIImage</span> *image, SDImageCacheType cacheType)&#123;<br>    <span class="hljs-comment">/*...*/</span><br>    <span class="hljs-keyword">if</span> ((!image || options &amp; SDWebImageRefreshCached) &amp;&amp;<br>    (![<span class="hljs-keyword">self</span>.delegate respondsToSelector:<br>    <span class="hljs-keyword">@selector</span>(imageManager:shouldDownloadImageForURL:)] ||<br>    [<span class="hljs-keyword">self</span>.delegate imageManager:<span class="hljs-keyword">self</span> shouldDownloadImageForURL:url]))<br>    &#123;<br>        <span class="hljs-comment">/*如果有缓存但采用了 RefreshCached 策略，</span><br><span class="hljs-comment">        则执行回调并继续下载，以便让服务器刷新 NSURLCache 里的内容。*/</span><br>        <span class="hljs-keyword">if</span> (image &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;<br>            dispatch_main_sync_safe(^&#123;<br>                completedBlock(image, <span class="hljs-literal">nil</span>, cacheType, <span class="hljs-literal">YES</span>, url);<br>            &#125;);<br>        &#125;<br>        <span class="hljs-comment">/*...*/</span><br>        <span class="hljs-comment">//step.4 使用imageDownloader开启网络下载</span><br>        <span class="hljs-type">id</span> &lt;SDWebImageOperation&gt; subOperation = [<span class="hljs-keyword">self</span>.imageDownloader<br>        downloadImageWithURL:url<br>        options:downloaderOptions<br>        progress:progressBlock<br>        completed:^(<span class="hljs-built_in">UIImage</span> *downloadedImage, <span class="hljs-built_in">NSData</span> *data, <span class="hljs-built_in">NSError</span> *error, <span class="hljs-type">BOOL</span> finished)<br>        &#123;<br>            <span class="hljs-comment">//step.5 图片下载完成，根据设置进行图片转换和缓存</span><br>            /.../<br>            <span class="hljs-keyword">if</span> (downloadedImage &amp;&amp; finished) &#123;<br>                <span class="hljs-comment">//step.5 图片下载完成，不需要转换时，将图片保存到缓存中并返回主线程</span><br>                [<span class="hljs-keyword">self</span>.imageCache storeImage:downloadedImage<br>                recalculateFromImage:<span class="hljs-literal">NO</span><br>                imageData:data<br>                forKey:key<br>                toDisk:cacheOnDisk];<br>            &#125;<br>            dispatch_main_sync_safe(^&#123;<br>                <span class="hljs-keyword">if</span> (!weakOperation.isCancelled) &#123;<br>                    completedBlock(downloadedImage, <span class="hljs-literal">nil</span>, SDImageCacheTypeNone, finished, url);<br>            &#125;<br>            &#125;);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/*...*/</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (image) &#123;<br>        <span class="hljs-comment">//step.3 有缓存且不要求强制刷新缓存时，在缓存中找到图片，直接返回</span><br>        dispatch_main_sync_safe(^&#123;<br>            <span class="hljs-keyword">if</span> (!weakOperation.isCancelled) &#123;<br>                completedBlock(image, <span class="hljs-literal">nil</span>, cacheType, <span class="hljs-literal">YES</span>, url);<br>            &#125;<br>        &#125;);<br>    &#125;<br>    &#125;];<br>    <span class="hljs-keyword">return</span> operation;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>大致的实现逻辑已在上面的代码中标明，图片下载完成后所做的转换和缓存，其具体实现逻辑会在后面讲到。</p>
<h4 id="2-3-SDWebImageDownloader"><a href="#2-3-SDWebImageDownloader" class="headerlink" title="2.3.SDWebImageDownloader"></a>2.3.SDWebImageDownloader</h4><p>主要业务：</p>
<ul>
<li>step.1 设置 URLRequest。</li>
<li>step.2 创建下载任务 SDWebImageDownloaderOperation，加入到最大并发数&#x3D;6的 Queue 中，开始下载任务。</li>
<li>step.3 下载成功，调用 CompletedBlock。</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// SDWebImageDownloader.m</span><br><br>- (<span class="hljs-keyword">instancetype</span>)initWithSessionConfiguration:(<span class="hljs-built_in">NSURLSessionConfiguration</span> *)sessionConfiguration &#123;<br>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init])) &#123;<br>        _operationClass = [SDWebImageDownloaderOperation <span class="hljs-keyword">class</span>];<br>        _shouldDecompressImages = <span class="hljs-literal">YES</span>; <span class="hljs-comment">//默认解压缩下载到的图片</span><br>        _executionOrder = SDWebImageDownloaderFIFOExecutionOrder;<br>        _downloadQueue = [<span class="hljs-built_in">NSOperationQueue</span> new];<br>        _downloadQueue.maxConcurrentOperationCount = <span class="hljs-number">6</span>; <span class="hljs-comment">//最大下载并发数</span><br>        _downloadQueue.name = <span class="hljs-string">@&quot;com.hackemist.SDWebImageDownloader&quot;</span>;<br>        <span class="hljs-comment">// 省略。。。</span><br>        _HTTPHeaders = headerDictionary;<br>        _operationsLock = dispatch_semaphore_create(<span class="hljs-number">1</span>);<br>        _headersLock = dispatch_semaphore_create(<span class="hljs-number">1</span>);<br>        _downloadTimeout = <span class="hljs-number">15.0</span>;<br><br>        [<span class="hljs-keyword">self</span> createNewSessionWithConfiguration:sessionConfiguration];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)createNewSessionWithConfiguration:(<span class="hljs-built_in">NSURLSessionConfiguration</span> *)sessionConfiguration &#123;<br>    [<span class="hljs-keyword">self</span> cancelAllDownloads];<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.session) &#123;<br>        [<span class="hljs-keyword">self</span>.session invalidateAndCancel];<br>    &#125;<br>    <span class="hljs-keyword">self</span>.session = [<span class="hljs-built_in">NSURLSession</span> sessionWithConfiguration:sessionConfiguration<br>                                                 delegate:<span class="hljs-keyword">self</span><br>                                            delegateQueue:<span class="hljs-literal">nil</span>];<br>&#125;<br><br>- (<span class="hljs-type">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="hljs-built_in">NSURL</span> *)url<br>                                         options:(SDWebImageDownloaderOptions)options<br>                                        progress:(SDWebImageDownloaderProgressBlock)progressBlock<br>                                       completed:(SDWebImageDownloaderCompletedBlock)completedBlock<br>&#123;<br>    <span class="hljs-comment">/*...*/</span><br>    <span class="hljs-comment">//step.1 设置request</span><br>    <span class="hljs-built_in">NSMutableURLRequest</span> *request = [[<span class="hljs-built_in">NSMutableURLRequest</span> alloc]<br>                                    initWithURL:url<br>                                    cachePolicy:(options &amp; SDWebImageDownloaderUseNSURLCache ?<br>    <span class="hljs-built_in">NSURLRequestUseProtocolCachePolicy</span> :<span class="hljs-built_in">NSURLRequestReloadIgnoringLocalCacheData</span>)<br>                                timeoutInterval:timeoutInterval];<br><br>    request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);<br>    request.HTTPShouldUsePipelining = <span class="hljs-literal">YES</span>;<br>    request.allHTTPHeaderFields = wself.HTTPHeaders;<br><br>    <span class="hljs-comment">//step.2 创建下载 Operation</span><br>    operation = [[SDWebImageDownloaderOperation alloc] initWithRequest:request<br>        options:options<br>        progress:^(<span class="hljs-built_in">NSInteger</span> receivedSize, <span class="hljs-built_in">NSInteger</span> expectedSize) &#123;...&#125;<br>        completed:^(<span class="hljs-built_in">UIImage</span> *image, <span class="hljs-built_in">NSData</span> *data, <span class="hljs-built_in">NSError</span> *error, <span class="hljs-type">BOOL</span> finished) &#123;<br>        <br>        SDWebImageDownloader *sself = wself;<br>        <span class="hljs-keyword">if</span> (!sself) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-comment">//step.3 下载成功，执行完成的callback</span><br>        __block <span class="hljs-built_in">NSArray</span> *callbacksForURL;<br>        dispatch_barrier_sync(sself.barrierQueue, ^&#123;<br>            callbacksForURL = [sself.URLCallbacks[url] <span class="hljs-keyword">copy</span>];<br>            <span class="hljs-keyword">if</span> (finished) &#123;<br>                [sself.URLCallbacks removeObjectForKey:url];<br>            &#125;<br>        &#125;);<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSDictionary</span> *callbacks <span class="hljs-keyword">in</span> callbacksForURL) &#123;<br>            SDWebImageDownloaderCompletedBlock callback = callbacks[kCompletedCallbackKey];<br>            <span class="hljs-keyword">if</span> (callback)<br>            callback(image, data, error, finished);<br>        &#125;<br>    &#125;<br>        cancelled:^&#123;...&#125;];<br><br>    operation.shouldDecompressImages = wself.shouldDecompressImages;<span class="hljs-comment">//是否需要解码</span><br>    <span class="hljs-comment">//设置任务优先级</span><br>    <span class="hljs-keyword">if</span> (options &amp; SDWebImageDownloaderHighPriority) &#123;<br>        operation.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityHigh</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options &amp; SDWebImageDownloaderLowPriority) &#123;<br>        operation.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityLow</span>;<br>    &#125;<br>    <span class="hljs-comment">//任务加到队列中</span><br>    [wself.downloadQueue addOperation:operation];<br>    <span class="hljs-keyword">if</span> (wself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) &#123;<br>        <span class="hljs-comment">//如果设置了后进的任务先执行，则添加依赖关系，前一个任务依赖当前任务</span><br>        [wself.lastAddedOperation addDependency:operation];<br>        wself.lastAddedOperation = operation;<br>    &#125;<br>    &#125;];<br>    <span class="hljs-keyword">return</span> operation;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-4-任务和请求"><a href="#2-4-任务和请求" class="headerlink" title="2.4.任务和请求"></a>2.4.任务和请求</h4><p>SDWebImageDownloaderOperation，这是真正执行图片下载任务的地方。</p>
<ul>
<li>重写了<code>start</code>函数；</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)start &#123;<br>    <span class="hljs-meta">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.isCancelled) &#123;<br>            <span class="hljs-keyword">self</span>.finished <span class="hljs-operator">=</span> <span class="hljs-type">YES</span>;<br>            [<span class="hljs-keyword">self</span> reset];<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br><span class="hljs-keyword">#if</span> <span class="hljs-type">TARGET_OS_IPHONE</span> <span class="hljs-operator">&amp;&amp;</span> __IPHONE_OS_VERSION_MAX_ALLOWED <span class="hljs-operator">&gt;=</span> __IPHONE_4_0<br>        <span class="hljs-type">Class</span> <span class="hljs-type">UIApplicationClass</span> <span class="hljs-operator">=</span> <span class="hljs-type">NSClassFromString</span>(@<span class="hljs-string">&quot;UIApplication&quot;</span>);<br>        <span class="hljs-type">BOOL</span> hasApplication <span class="hljs-operator">=</span> <span class="hljs-type">UIApplicationClass</span> <span class="hljs-operator">&amp;&amp;</span> <br>                        [<span class="hljs-type">UIApplicationClass</span> respondsToSelector:<span class="hljs-meta">@selector</span>(sharedApplication)];<br>        <br>        <span class="hljs-comment">// 进入后台时，开启后台模式</span><br>        <span class="hljs-keyword">if</span> (hasApplication <span class="hljs-operator">&amp;&amp;</span> [<span class="hljs-keyword">self</span> shouldContinueWhenAppEntersBackground]) &#123;<br>            __weak __typeof__ (<span class="hljs-keyword">self</span>) wself <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>;<br>            <span class="hljs-type">UIApplication</span> <span class="hljs-operator">*</span> app <span class="hljs-operator">=</span> [<span class="hljs-type">UIApplicationClass</span> performSelector:<span class="hljs-meta">@selector</span>(sharedApplication)];<br>            <span class="hljs-keyword">self</span>.backgroundTaskId <span class="hljs-operator">=</span> [app beginBackgroundTaskWithExpirationHandler:<span class="hljs-operator">^</span>&#123;<br>                __strong __typeof (wself) sself <span class="hljs-operator">=</span> wself;<br><br>                <span class="hljs-keyword">if</span> (sself) &#123;<br>                    [sself cancel];<br><br>                    [app endBackgroundTask:sself.backgroundTaskId];<br>                    sself.backgroundTaskId <span class="hljs-operator">=</span> <span class="hljs-type">UIBackgroundTaskInvalid</span>;<br>                &#125;<br>            &#125;];<br>        &#125;<br><span class="hljs-keyword">#endif</span><br><br>        <span class="hljs-comment">// 创建下载请求</span><br>        <span class="hljs-keyword">self</span>.executing <span class="hljs-operator">=</span> <span class="hljs-type">YES</span>;<br>        <span class="hljs-keyword">self</span>.connection <span class="hljs-operator">=</span> [[<span class="hljs-type">NSURLConnection</span> alloc] initWithRequest:<span class="hljs-keyword">self</span>.request <br>                                                          delegate:<span class="hljs-keyword">self</span> startImmediately:<span class="hljs-type">NO</span>];<br>        <span class="hljs-keyword">self</span>.thread <span class="hljs-operator">=</span> [<span class="hljs-type">NSThread</span> currentThread];<br>    &#125;<br><br>    <span class="hljs-comment">// 启动</span><br>    [<span class="hljs-keyword">self</span>.connection start];<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.connection) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.progressBlock) &#123;<br>            <span class="hljs-keyword">self</span>.progressBlock(<span class="hljs-number">0</span>, <span class="hljs-type">NSURLResponseUnknownLength</span>);<br>        &#125;<br>        dispatch_async(dispatch_get_main_queue(), <span class="hljs-operator">^</span>&#123;<br>            [[<span class="hljs-type">NSNotificationCenter</span> defaultCenter] postNotificationName:<br>            <span class="hljs-type">SDWebImageDownloadStartNotification</span> object:<span class="hljs-keyword">self</span>];<br>        &#125;);<br><br>        <span class="hljs-comment">// 在默认模式下运行当前runlooprun，直到调用CFRunLoopStop停止运行</span><br>        <span class="hljs-keyword">if</span> (floor(<span class="hljs-type">NSFoundationVersionNumber</span>) <span class="hljs-operator">&lt;=</span> <span class="hljs-type">NSFoundationVersionNumber_iOS_5_1</span>) &#123;<br>            <span class="hljs-comment">// Make sure to run the runloop in our background thread so it can process downloaded data</span><br>            <span class="hljs-comment">// Note: we use a timeout to work around an issue with NSURLConnection cancel under iOS 5</span><br>            <span class="hljs-comment">// not waking up the runloop, leading to dead threads</span><br>            <span class="hljs-type">CFRunLoopRunInMode</span>(kCFRunLoopDefaultMode, <span class="hljs-number">10</span>, <span class="hljs-literal">false</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">CFRunLoopRun</span>();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span><span class="hljs-keyword">self</span>.isFinished) &#123;<br>            [<span class="hljs-keyword">self</span>.connection cancel];<br>            [<span class="hljs-keyword">self</span> connection:<span class="hljs-keyword">self</span>.connection didFailWithError:<br>            [<span class="hljs-type">NSError</span> errorWithDomain:<span class="hljs-type">NSURLErrorDomain</span> code:<span class="hljs-type">NSURLErrorTimedOut</span> <br>            userInfo:@&#123;<span class="hljs-type">NSURLErrorFailingURLErrorKey</span> : <span class="hljs-keyword">self</span>.request.<span class="hljs-type">URL</span>&#125;]];<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.completedBlock) &#123;<br>            <span class="hljs-keyword">self</span>.completedBlock(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, [<span class="hljs-type">NSError</span> errorWithDomain:<span class="hljs-type">NSURLErrorDomain</span> <br>                code:<span class="hljs-number">0</span> userInfo:@&#123;NSLocalizedDescriptionKey : @<span class="hljs-string">&quot;Connection can&#x27;t be initialized&quot;</span>&#125;], <span class="hljs-type">YES</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">#if</span> <span class="hljs-type">TARGET_OS_IPHONE</span> <span class="hljs-operator">&amp;&amp;</span> __IPHONE_OS_VERSION_MAX_ALLOWED <span class="hljs-operator">&gt;=</span> __IPHONE_4_0<br>    <span class="hljs-type">Class</span> <span class="hljs-type">UIApplicationClass</span> <span class="hljs-operator">=</span> <span class="hljs-type">NSClassFromString</span>(@<span class="hljs-string">&quot;UIApplication&quot;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-operator">!</span><span class="hljs-type">UIApplicationClass</span> <span class="hljs-operator">||</span> <span class="hljs-operator">!</span>[<span class="hljs-type">UIApplicationClass</span> respondsToSelector:<span class="hljs-meta">@selector</span>(sharedApplication)]) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.backgroundTaskId <span class="hljs-operator">!=</span> <span class="hljs-type">UIBackgroundTaskInvalid</span>) &#123;<br>        <span class="hljs-type">UIApplication</span> <span class="hljs-operator">*</span> app <span class="hljs-operator">=</span> [<span class="hljs-type">UIApplication</span> performSelector:<span class="hljs-meta">@selector</span>(sharedApplication)];<br>        [app endBackgroundTask:<span class="hljs-keyword">self</span>.backgroundTaskId];<br>        <span class="hljs-keyword">self</span>.backgroundTaskId <span class="hljs-operator">=</span> <span class="hljs-type">UIBackgroundTaskInvalid</span>;<br>    &#125;<br><span class="hljs-keyword">#endif</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>收到数据的回调</li>
</ul>
<p>下载过程中，通过代理-connection: didReceiveData:接收数据并保存到一个 NSMutableData 对象中。如果设置了“边下载边显示”，那么这里会渐进式的绘制图片、缩放图片，默认情况下还会对图片进行解码。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection didReceiveData:(<span class="hljs-built_in">NSData</span> *)data &#123;<br>[<span class="hljs-keyword">self</span>.imageData appendData:data];<br>...<br><span class="hljs-comment">//绘制图片</span><br><span class="hljs-built_in">CGImageSourceRef</span> imageSource = <span class="hljs-built_in">CGImageSourceCreateWithData</span>((__bridge <span class="hljs-built_in">CFDataRef</span>)<span class="hljs-keyword">self</span>.imageData, <span class="hljs-literal">NULL</span>);<br>...<br><span class="hljs-built_in">CGImageRef</span> partialImageRef = <span class="hljs-built_in">CGImageSourceCreateImageAtIndex</span>(imageSource, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>...<br><span class="hljs-comment">//图片缩放</span><br><span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> imageWithCGImage:partialImageRef scale:<span class="hljs-number">1</span> orientation:orientation];<br><span class="hljs-built_in">NSString</span> *key = [[SDWebImageManager sharedManager] cacheKeyForURL:<span class="hljs-keyword">self</span>.request.URL];<br><span class="hljs-built_in">UIImage</span> *scaledImage = [<span class="hljs-keyword">self</span> scaledImageForKey:key image:image];<br><br><span class="hljs-comment">//图片解码</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.shouldDecompressImages) &#123;<br>image = [<span class="hljs-built_in">UIImage</span> decodedImageWithImage:scaledImage];<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>image = scaledImage;<br>&#125;<br><span class="hljs-built_in">CGImageRelease</span>(partialImageRef);<br>dispatch_main_sync_safe(^&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.completedBlock) &#123;<br><span class="hljs-keyword">self</span>.completedBlock(image, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">NO</span>);<br>&#125;<br>&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>图片下载完成的回调</li>
</ul>
<p>下载完成后，在代理-connectionDidFinishLoading中完成图片的缩放、解码并返回。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)connectionDidFinishLoading:(<span class="hljs-built_in">NSURLConnection</span> *)aConnection &#123;<br>SDWebImageDownloaderCompletedBlock completionBlock = <span class="hljs-keyword">self</span>.completedBlock;<br><span class="hljs-keyword">@synchronized</span>(<span class="hljs-keyword">self</span>) &#123;<br><span class="hljs-built_in">CFRunLoopStop</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>());<br>...<br>&#125;);<br>&#125;<br>...<br><span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> sd_imageWithData:<span class="hljs-keyword">self</span>.imageData];<br><br><span class="hljs-built_in">NSString</span> *key = [[SDWebImageManager sharedManager]<br>cacheKeyForURL:<span class="hljs-keyword">self</span>.request.URL];<br>image = [<span class="hljs-keyword">self</span> scaledImageForKey:key image:image];<br><br><span class="hljs-comment">// Do not force decoding animated GIFs</span><br><span class="hljs-keyword">if</span> (!image.images) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.shouldDecompressImages) &#123;<br>image = [<span class="hljs-built_in">UIImage</span> decodedImageWithImage:image];<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">CGSizeEqualToSize</span>(image.size, <span class="hljs-built_in">CGSizeZero</span>)) &#123;<br>completionBlock(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, [<span class="hljs-built_in">NSError</span>...], <span class="hljs-literal">YES</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>completionBlock(image, <span class="hljs-keyword">self</span>.imageData, <span class="hljs-literal">nil</span>, <span class="hljs-literal">YES</span>);<br>&#125;<br>...<br><span class="hljs-keyword">self</span>.completionBlock = <span class="hljs-literal">nil</span>;<br>[<span class="hljs-keyword">self</span> done];<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-5-图片缩放与解码"><a href="#2-5-图片缩放与解码" class="headerlink" title="2.5.图片缩放与解码"></a>2.5.图片缩放与解码</h4><ul>
<li>图片缩放</li>
</ul>
<p>上面两个下载的回调中调用了一个共同的方法：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs maxima">- (UIImage *)scaledImageForKey:(NSString *)<span class="hljs-built_in">key</span> <span class="hljs-built_in">image</span>:(UIImage *)<span class="hljs-built_in">image</span> &#123;<br>    <span class="hljs-built_in">return</span> SDScaledImageForKey(<span class="hljs-built_in">key</span>, <span class="hljs-built_in">image</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>作用</strong>：根据图片URL字符串推断图片的scale，按此scale绘制一张新图。<br><br/></p>
<p>为啥要做这个操作呢？这里要提到三个关于图片尺寸信息的概念：<br><br/></p>
<p>1、<strong>pixel dimensions</strong><br><br/></p>
<p>这是指图片的<code>实际像素尺寸</code>，就是在文件夹中显示的真实图片尺寸。比如@1x图的尺寸是40*40，那么@2x的实际尺寸就是80*80，@3x的实际尺寸就是120*120。图片的清晰度只和图片本身的像素尺寸有关，实际尺寸越大则图片显示越清晰。<br><br/></p>
<p>2、<strong>size</strong><br><br/></p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/uiimage/1624105-size">官方文档</a>中是这么描述的：</p>
<blockquote>
<p>The logical dimensions of the image, measured in points.</p>
</blockquote>
<p>This value reflects the logical size of the image and takes the image’s current orientation into account. Multiply the size values by the value in the scale property to get the pixel dimensions of the image.<br><br/></p>
<p>size 是图片的<code>逻辑尺寸</code>，而图片的实际尺寸要在size对应字段的基础上再乘以scale，比如：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">实际宽度 <span class="hljs-operator">=</span> size.width * scale<span class="hljs-comment">;</span><br>size.width <span class="hljs-operator">=</span> 实际宽度 / scale<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>根据上面的公式，图片的size需要在实际像素尺寸的基础上除以其scale。如果@1x图的实际尺寸是40*40，则其size为40*40；@2x图的实际尺寸是80*80，则其size也为40*40；@3x图的实际尺寸是120*120，则其size还是40*40；这样，如果设置了imageview的frame自适应其素材的大小，就能保证在不同分辨率的设备上imageview.frame.size的一致性。<br><br/></p>
<p>3、<strong>scale</strong><br><br/></p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/uiimage/1624110-scale">官方文档</a>中是这么描述的：</p>
<blockquote>
<p>The scale factor of the image.</p>
</blockquote>
<p>If you load an image from a file whose name includes the @2x modifier, the scale is set to 2.0. You can also specify an explicit scale factor when initializing an image from a Core Graphics image. All other images are assumed to have a scale factor of 1.0.<br>If you multiply the logical size of the image (stored in the size property) by the value in this property, you get the dimensions of the image in pixels.</p>
<br/>

<p>这是图片的缩放比例，是一个CGFloat数值，依图片本身的命名而定。如果图片名为 park@2x.png 则图片的scale就是2；如果图片名为 park@3x.png 则图片的scale就是3。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">UIImage <span class="hljs-symbol">*</span>p1 = [UIImage imageNamed:<span class="hljs-meta">@&quot;park</span><span class="hljs-meta">@2x&quot;];</span><br>UIImage <span class="hljs-symbol">*</span>p2 = [UIImage imageNamed:<span class="hljs-meta">@&quot;park</span><span class="hljs-meta">@3x&quot;];</span><br>NSLog(<span class="hljs-meta">@&quot;+++</span><span class="hljs-meta">@2x.scale:%.0f,</span> <span class="hljs-meta">@3x.scale:%.0f&quot;,p1.scale,p2.scale);</span><br>// 日志：+++<span class="hljs-meta">@2x.scale:2,</span> <span class="hljs-meta">@3x.scale:3</span><br></code></pre></td></tr></table></figure>

<p>需要注意的是：<strong>除以@2x和@3x命名的图片外，其他所有图片的scale都是1.0</strong>。这里标了粗体，因为这句话很重要，这意味着我们以 park.png 命名，或者<strong>从网络上下载的图片，它们的scale默认都是1.0</strong> ！！！这也正是SD库中下载完图片或者从缓存中取出图片后，执行上面的方法重置图片scale属性的原因所在~<br><br/></p>
<p>为了适配不同尺寸的iPhone，我们的素材需要提供三个版本，park.png，park@2x.png，part@3x.png。使用素材时：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">UIImage</span> *img = [<span class="hljs-built_in">UIImage</span> imageNamed:<span class="hljs-string">@&quot;park&quot;</span>];<br></code></pre></td></tr></table></figure>

<p>系统会自动根据当前屏幕的scale选择对应后缀的图片素材。在4&#x2F;4s之后的手机上系统会自动加载以@2x为后缀的图片；在6p 之后的plus版本手机上系统会自动加载以@3x为后缀的图片。<br><br/></p>
<p>问题来了，从网络上下载的图片其scale默认是1.0，而其实际尺寸是确定的。根据公式：<code>size</code> &#x3D; <code>实际尺寸</code> &#x2F; <code>scale</code>，<strong>同一张图，scale越小其size就越大</strong>。如果设置了imageview自适应素材的大小，则本该使用@2x或@3x素材的视图，其frame.size会比预想的要大，所以为了效果的准确性，还是需要正确设置图片的scale参数。<br><br/></p>
<p>SD中重置图片scale的具体实现如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">inline</span> <span class="hljs-built_in">UIImage</span> *SDScaledImageForKey(<span class="hljs-built_in">NSString</span> *key, <span class="hljs-built_in">UIImage</span> *image) &#123;<br>    <span class="hljs-keyword">if</span> (!image) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-comment">//数组不空，则返回一个动图</span><br>    <span class="hljs-keyword">if</span> ([image.images count] &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">NSMutableArray</span> *scaledImages = [<span class="hljs-built_in">NSMutableArray</span> array];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">UIImage</span> *tempImage <span class="hljs-keyword">in</span> image.images) &#123;<br>            [scaledImages addObject:SDScaledImageForKey(key, tempImage)];<br>        &#125;<br>        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIImage</span> animatedImageWithImages:scaledImages duration:image.duration];<br>    &#125;<br>    <span class="hljs-comment">//根据图片URL，判断图片比例，重新绘制新图并返回</span><br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> ([[<span class="hljs-built_in">UIScreen</span> mainScreen] respondsToSelector:<span class="hljs-keyword">@selector</span>(scale)]) &#123;<br>            <span class="hljs-built_in">CGFloat</span> scale = [<span class="hljs-built_in">UIScreen</span> mainScreen].scale;<br>            <br>            <span class="hljs-comment">// &quot;@2x.png&quot; 或者 &quot;@2x.png&quot; 字符串的长度=7，加上@符号之前的名字，必定&gt;=8</span><br>            <span class="hljs-keyword">if</span> (key.length &gt;= <span class="hljs-number">8</span>) &#123;<br>                <span class="hljs-built_in">NSRange</span> range = [key rangeOfString:<span class="hljs-string">@&quot;@2x.&quot;</span>];<br>                <span class="hljs-keyword">if</span> (range.location != <span class="hljs-built_in">NSNotFound</span>) &#123;<span class="hljs-comment">//URL包含@2x，推测为2倍图</span><br>                    scale = <span class="hljs-number">2.0</span>;<br>                &#125;<br>                range = [key rangeOfString:<span class="hljs-string">@&quot;@3x.&quot;</span>];<br>                <span class="hljs-keyword">if</span> (range.location != <span class="hljs-built_in">NSNotFound</span>) &#123;<span class="hljs-comment">//URL包含@3x，推测为3倍图</span><br>                    scale = <span class="hljs-number">3.0</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-built_in">UIImage</span> *scaledImage = [[<span class="hljs-built_in">UIImage</span> alloc] initWithCGImage:image.CGImage <br>                                                              scale:scale <br>                                                              orientation:image.imageOrientation];<br>            image = scaledImage;<br>        &#125;<br>        <span class="hljs-keyword">return</span> image;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>图片解码</li>
</ul>
<p>默认情况下，SD会对下载的图片执行<code>[UIImage decodedImageWithImage:scaledImage]</code>，即图片解码（动图除外）。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-built_in">UIImage</span> *)decodedImageWithImage:(<span class="hljs-built_in">UIImage</span> *)image &#123;<br>    <span class="hljs-comment">// while downloading huge amount of images</span><br>    <span class="hljs-comment">// autorelease the bitmap context</span><br>    <span class="hljs-comment">// and all vars to help system to free memory</span><br>    <span class="hljs-comment">// when there are memory warning.</span><br>    <span class="hljs-comment">// on iOS7, do not forget to call</span><br>    <span class="hljs-comment">// [[SDImageCache sharedImageCache] clearMemory];</span><br>    <span class="hljs-keyword">@autoreleasepool</span>&#123;<br>        <span class="hljs-comment">// do not decode animated images</span><br>        <span class="hljs-keyword">if</span> (image.images) &#123; <span class="hljs-keyword">return</span> image; &#125;<br>    <br>        <span class="hljs-built_in">CGImageRef</span> imageRef = image.CGImage;<br>    <br>        <span class="hljs-comment">//图片如果有alpha通道，就返回原始image，因为jpg图片有alpha的话，就不压缩</span><br>        <span class="hljs-built_in">CGImageAlphaInfo</span> alpha = <span class="hljs-built_in">CGImageGetAlphaInfo</span>(imageRef);<br>        <span class="hljs-type">BOOL</span> anyAlpha = (alpha == kCGImageAlphaFirst ||<br>                         alpha == kCGImageAlphaLast ||<br>                         alpha == kCGImageAlphaPremultipliedFirst ||<br>                         alpha == kCGImageAlphaPremultipliedLast);<br>    <br>        <span class="hljs-keyword">if</span> (anyAlpha) &#123; <span class="hljs-keyword">return</span> image; &#125;<br>    <br>        size_t width = <span class="hljs-built_in">CGImageGetWidth</span>(imageRef);<br>        size_t height = <span class="hljs-built_in">CGImageGetHeight</span>(imageRef);<br>    <br>        <span class="hljs-comment">// current</span><br>        <span class="hljs-built_in">CGColorSpaceModel</span> imageColorSpaceModel = <span class="hljs-built_in">CGColorSpaceGetModel</span>(<span class="hljs-built_in">CGImageGetColorSpace</span>(imageRef));<br>        <span class="hljs-built_in">CGColorSpaceRef</span> colorspaceRef = <span class="hljs-built_in">CGImageGetColorSpace</span>(imageRef);<br>        <br>        <span class="hljs-type">bool</span> unsupportedColorSpace = (imageColorSpaceModel == <span class="hljs-number">0</span> || <br>                                    imageColorSpaceModel == <span class="hljs-number">-1</span> || <br>                                    imageColorSpaceModel == kCGColorSpaceModelCMYK || <br>                                    imageColorSpaceModel == kCGColorSpaceModelIndexed);<br>        <span class="hljs-keyword">if</span> (unsupportedColorSpace)<span class="hljs-comment">//如果属于上述不支持的ColorSpace，则ColorSpace就使用RGB</span><br>            colorspaceRef = <span class="hljs-built_in">CGColorSpaceCreateDeviceRGB</span>();<br>    <br>        <span class="hljs-built_in">CGContextRef</span> context = <span class="hljs-built_in">CGBitmapContextCreate</span>(<span class="hljs-literal">NULL</span>, width,<br>                                                     height,<br>                                                     <span class="hljs-built_in">CGImageGetBitsPerComponent</span>(imageRef),<br>                                                     <span class="hljs-number">0</span>,<br>                                                     colorspaceRef,<br>                                                     kCGBitmapByteOrderDefault | <br>                                                     kCGImageAlphaPremultipliedFirst);<br>    <br>        <span class="hljs-comment">// Draw the image into the context and retrieve the new image, which will now have an alpha layer</span><br>        <span class="hljs-built_in">CGContextDrawImage</span>(context, <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), imageRef);<br>        <span class="hljs-built_in">CGImageRef</span> imageRefWithAlpha = <span class="hljs-built_in">CGBitmapContextCreateImage</span>(context);<br>        <span class="hljs-built_in">UIImage</span> *imageWithAlpha = [<span class="hljs-built_in">UIImage</span> imageWithCGImage:imageRefWithAlpha <br>                                                      scale:image.scale orientation:image.imageOrientation];<br>    <br>        <span class="hljs-keyword">if</span> (unsupportedColorSpace)<br>            <span class="hljs-built_in">CGColorSpaceRelease</span>(colorspaceRef);<br>        <br>        <span class="hljs-built_in">CGContextRelease</span>(context);<br>        <span class="hljs-built_in">CGImageRelease</span>(imageRefWithAlpha);<br>        <br>        <span class="hljs-keyword">return</span> imageWithAlpha;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>SD为啥“多此一举”呢？<a target="_blank" rel="noopener" href="https://www.cnblogs.com/chmhml/p/6817383.html">这里</a> 有种解释：</p>
<blockquote>
<p>一般下载的图片或者我们手动拖进主 bundle 的图片都是 PNG 或者 JPG 格式的图片，这些图片都是经过编码压缩后的图片数据，并不是控件可以直接显示的位图。如果我们直接使用 “[UIImage imageNamed:]” 来加载图片，系统默认会在主线程立即进行图片的解码工作，这个过程就是把图片数据解码成可供控件直接显示的位图数据。由于这个解码操作比较耗时，并且默认是在主线程进行，所以当在主线程大量调用时就会产生卡顿。同时由于位图体积较大，所以在磁盘缓存中不会直接缓存位图数据，而是编码压缩过的PNG 或者 JPG 数据。</p>
</blockquote>
<p>这里更准确的说，[UIImage imageNamed:] 加载图片时，不是立即解码的，而是在图片设置到<code>UIImageView</code>或者<code>CALayer.contents</code>中，并且 CALayer 被提交到GPU进行渲染前才会解码。另外，使用这种方式加载图片时，系统会自动缓存一份该图片，后面再使用此图时会直接从缓存中取，不再次解码。即使如此，使用这种方式加载图片时，最后的解码部分仍然时在主线程中进行的，所以当大量加载图片时，仍然有可能会出现卡顿现象。<br><br/></p>
<p>SD 这里所做的正是对图片进行解码，而且是在异步线程里。SD缓存图片到内存时保存的是解码后的图片，缓存是通过 NSCache 实现的。这一步的目的是提高加载图片的速度和效率，需要注意的是，它在解码时会占用相当一部分内存，是典型的空间换时间。如果你遇到了内存问题，可以尝试禁止自动解码或者清空缓存：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs inform7"><span class="hljs-comment">[<span class="hljs-comment">[SDImageCache sharedImageCache]</span> setShouldDecompressImages:NO]</span>;<br><span class="hljs-comment">[<span class="hljs-comment">[SDWebImageDownloader sharedDownloader]</span> setShouldDecompressImages:NO]</span>;<br><span class="hljs-comment">[<span class="hljs-comment">[SDImageCache sharedImageCache]</span> clearMemory]</span>;<br></code></pre></td></tr></table></figure>

<h3 id="三、缓存类的实现"><a href="#三、缓存类的实现" class="headerlink" title="三、缓存类的实现"></a>三、缓存类的实现</h3><p>写这篇文章时最新sd版本为3.7.3，缓存相关功能主要由 SDImageCache 类提供。这里的缓存包括了内存和磁盘两种方式。其中，内存缓存使用的是继承自 NSCache 的 AutoPurgeCache 类；磁盘缓存的操作被单独放在一个串行队列 ioQueue 中。这个类中主要的方法及实现如下：</p>
<h4 id="3-1-查询图片缓存"><a href="#3-1-查询图片缓存" class="headerlink" title="3.1.查询图片缓存"></a>3.1.查询图片缓存</h4><ul>
<li>step.1 从内存中检测；</li>
<li>step.2 从磁盘中检测（异步+串行队列）；</li>
<li>step.3 磁盘中检测到缓存后，根据需要缓存到内存中；</li>
<li>step.4 返回结果；</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-built_in">NSOperation</span> *)queryDiskCacheForKey:(<span class="hljs-built_in">NSString</span> *)key<br>done:(SDWebImageQueryCompletedBlock)doneBlock<br>&#123;<br>...<br>    <span class="hljs-comment">//step.1 先从内存中检测</span><br>    <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-keyword">self</span> imageFromMemoryCacheForKey:key];<br>    <span class="hljs-keyword">if</span> (image) &#123;<br>        doneBlock(image, SDImageCacheTypeMemory);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//step.2 内存中没有再从磁盘中检测</span><br>    <span class="hljs-built_in">NSOperation</span> *operation = [<span class="hljs-built_in">NSOperation</span> new];<br>    <span class="hljs-built_in">dispatch_async</span>(<span class="hljs-keyword">self</span>.ioQueue, ^&#123;<br>        <span class="hljs-keyword">if</span> (operation.isCancelled) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>            <span class="hljs-built_in">UIImage</span> *diskImage = [<span class="hljs-keyword">self</span> diskImageForKey:key];<br>            <span class="hljs-comment">//step.3 磁盘中检测到缓存后 根据需要缓存到内存中</span><br>            <span class="hljs-keyword">if</span> (diskImage &amp;&amp; <span class="hljs-keyword">self</span>.shouldCacheImagesInMemory) &#123;<br>                <span class="hljs-built_in">NSUInteger</span> cost = SDCacheCostForImage(diskImage);<br>                [<span class="hljs-keyword">self</span>.memCache setObject:diskImage forKey:key cost:cost];<br>            &#125;<br><br>            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>                doneBlock(diskImage, SDImageCacheTypeDisk);<br>            &#125;);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> operation;<br>&#125;<br><br>- (<span class="hljs-built_in">UIImage</span> *)imageFromMemoryCacheForKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span>.memCache objectForKey:key];<br>&#125;<br><br>- (<span class="hljs-built_in">UIImage</span> *)diskImageForKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-keyword">self</span> diskImageDataBySearchingAllPathsForKey:key];<br>    <span class="hljs-keyword">if</span> (data) &#123;<br>        <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> sd_imageWithData:data];<br>         <span class="hljs-comment">// 重置图片scale</span><br>        image = [<span class="hljs-keyword">self</span> scaledImageForKey:key image:image];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.shouldDecompressImages) &#123;<br>            <span class="hljs-comment">// 图片解码</span><br>            image = [<span class="hljs-built_in">UIImage</span> decodedImageWithImage:image];<br>        &#125;<br>        <span class="hljs-keyword">return</span> image;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-保存图片"><a href="#3-2-保存图片" class="headerlink" title="3.2.保存图片"></a>3.2.保存图片</h4><p>图片下载成功后，默认会保存到内存中。保存到磁盘时，会先检测图片的格式，文件名为URL对应的MD5值。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)storeImage:(<span class="hljs-built_in">UIImage</span> *)image<br>recalculateFromImage:(<span class="hljs-type">BOOL</span>)recalculate<br>         imageData:(<span class="hljs-built_in">NSData</span> *)imageData<br>            forKey:(<span class="hljs-built_in">NSString</span> *)key<br>            toDisk:(<span class="hljs-type">BOOL</span>)toDisk<br>&#123;<br>    ...<br>    <span class="hljs-comment">//保存到内存 NSCache，cost为像素值</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.shouldCacheImagesInMemory) &#123;<br>        <span class="hljs-built_in">NSUInteger</span> cost = SDCacheCostForImage(image);<br>        [<span class="hljs-keyword">self</span>.memCache setObject:image forKey:key cost:cost];<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (toDisk) &#123;<br>        <span class="hljs-built_in">dispatch_async</span>(<span class="hljs-keyword">self</span>.ioQueue, ^&#123;<br>            <span class="hljs-built_in">NSData</span> *data = imageData;<br><br>            <span class="hljs-keyword">if</span> (image &amp;&amp; (recalculate || !data)) &#123;<br>            <span class="hljs-meta">#<span class="hljs-keyword">if</span> TARGET_OS_IPHONE</span><br><br>                <span class="hljs-type">int</span> alphaInfo = <span class="hljs-built_in">CGImageGetAlphaInfo</span>(image.CGImage);<br>                <span class="hljs-type">BOOL</span> hasAlpha = !(alphaInfo == kCGImageAlphaNone ||<br>                alphaInfo == kCGImageAlphaNoneSkipFirst ||<br>                alphaInfo == kCGImageAlphaNoneSkipLast);<br>                <span class="hljs-type">BOOL</span> imageIsPng = hasAlpha;<br><br>                <span class="hljs-comment">//检测 图片data 的前缀是否是 PNG 格式</span><br>                <span class="hljs-keyword">if</span> ([imageData length] &gt;= [kPNGSignatureData length]) &#123;<br>                    imageIsPng = ImageDataHasPNGPreffix(imageData);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (imageIsPng) &#123;<br>                    data = <span class="hljs-built_in">UIImagePNGRepresentation</span>(image);<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    data = <span class="hljs-built_in">UIImageJPEGRepresentation</span>(image, (<span class="hljs-built_in">CGFloat</span>)<span class="hljs-number">1.0</span>);<br>                &#125;<br>            <span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>                data = [<span class="hljs-built_in">NSBitmapImageRep</span> representationOfImageRepsInArray:<br>                image.representations<br>                usingType: <span class="hljs-built_in">NSJPEGFileType</span> properties:<span class="hljs-literal">nil</span>];<br>            <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            &#125;<br><br>            <span class="hljs-comment">// get cache Path for image key</span><br>            <span class="hljs-built_in">NSString</span> *cachePathForKey = [<span class="hljs-keyword">self</span> defaultCachePathForKey:key];<br>            <span class="hljs-comment">// transform to NSUrl</span><br>            <span class="hljs-built_in">NSURL</span> *fileURL = [<span class="hljs-built_in">NSURL</span> fileURLWithPath:cachePathForKey];<br><br>            <span class="hljs-comment">// 保存到磁盘中</span><br>            [_fileManager createFileAtPath:cachePathForKey contents:data attributes:<span class="hljs-literal">nil</span>];<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>保存到磁盘时，图片的命名规则如下：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs prolog">- (<span class="hljs-symbol">NSString</span> *)cachedFileNameForKey:(<span class="hljs-symbol">NSString</span> *)key &#123;<br>    const char *str = [key <span class="hljs-symbol">UTF8String</span>];<br>    if (str == <span class="hljs-symbol">NULL</span>) &#123;<br>        str = <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    unsigned char r[<span class="hljs-symbol">CC_MD5_DIGEST_LENGTH</span>];<br>    <span class="hljs-symbol">CC_MD5</span>(str, (<span class="hljs-symbol">CC_LONG</span>)strlen(str), r);<br>    <span class="hljs-symbol">NSString</span> *filename = [<span class="hljs-symbol">NSString</span> stringWithFormat:<br>    @<span class="hljs-string">&quot;%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%@&quot;</span>,<br>    r[<span class="hljs-number">0</span>], r[<span class="hljs-number">1</span>], r[<span class="hljs-number">2</span>], r[<span class="hljs-number">3</span>], r[<span class="hljs-number">4</span>], r[<span class="hljs-number">5</span>],<br>    r[<span class="hljs-number">6</span>], r[<span class="hljs-number">7</span>], r[<span class="hljs-number">8</span>], r[<span class="hljs-number">9</span>], r[<span class="hljs-number">10</span>],<br>    r[<span class="hljs-number">11</span>], r[<span class="hljs-number">12</span>], r[<span class="hljs-number">13</span>], r[<span class="hljs-number">14</span>], r[<span class="hljs-number">15</span>],<br>    [[key pathExtension] isEqualToString:@<span class="hljs-string">&quot;&quot;</span>] ?<br>    @<span class="hljs-string">&quot;&quot;</span> : [<span class="hljs-symbol">NSString</span> stringWithFormat:@<span class="hljs-string">&quot;.%@&quot;</span>,<br>    [key pathExtension]]];<br>    return filename;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-3-清除缓存"><a href="#3-3-清除缓存" class="headerlink" title="3.3.清除缓存"></a>3.3.清除缓存</h4><p>程序出现内存警告时会清除内存中的缓存；退出应用、进入后台时则根据下面的策略清除相关磁盘缓存：</p>
<ul>
<li>清除过期的文件，默认一星期;</li>
<li>如果设置了最大缓存，且当前缓存文件超过了此限制，则删除最旧的文件，直到当前缓存文件的大小为最大缓存大小的一半;</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)cleanDiskWithCompletionBlock:(SDWebImageNoParamsBlock)completionBlock<br>&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(<span class="hljs-keyword">self</span>.ioQueue, ^&#123;<br>        <span class="hljs-comment">/*...*/</span><br>        <span class="hljs-built_in">NSDate</span> *expirationDate = [<span class="hljs-built_in">NSDate</span> dateWithTimeIntervalSinceNow:<br>        -<span class="hljs-keyword">self</span>.maxCacheAge];<br>        <span class="hljs-built_in">NSMutableDictionary</span> *cacheFiles = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>        <span class="hljs-built_in">NSUInteger</span> currentCacheSize = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">//遍历缓存目录中的所有文件</span><br>        <span class="hljs-built_in">NSMutableArray</span> *urlsToDelete = [[<span class="hljs-built_in">NSMutableArray</span> alloc] init];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSURL</span> *fileURL <span class="hljs-keyword">in</span> fileEnumerator) &#123;<br>            <span class="hljs-built_in">NSDictionary</span> *resourceValues = [fileURL resourceValuesForKeys:resourceKeys<br>            error:<span class="hljs-literal">NULL</span>];<br>            <span class="hljs-comment">/*...*/</span><br>            <span class="hljs-comment">// 删除过期的文件</span><br>            <span class="hljs-built_in">NSDate</span> *modificationDate = resourceValues[<span class="hljs-built_in">NSURLContentModificationDateKey</span>];<br>            <span class="hljs-keyword">if</span> ([[modificationDate laterDate:expirationDate]<br>            isEqualToDate:expirationDate]) &#123;<br>                [urlsToDelete addObject:fileURL];<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">/*...*/</span><br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSURL</span> *fileURL <span class="hljs-keyword">in</span> urlsToDelete) &#123;<br>            [_fileManager removeItemAtURL:fileURL error:<span class="hljs-literal">nil</span>];<br>        &#125;<br><br>        <span class="hljs-comment">//如果剩下的磁盘缓存超过最大限制，再次删掉最老的文件，</span><br>        <span class="hljs-comment">//直到当前缓存文件的大小为最大缓存大小的一半;</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.maxCacheSize &gt; <span class="hljs-number">0</span> &amp;&amp; currentCacheSize &gt; <span class="hljs-keyword">self</span>.maxCacheSize) &#123;<br>            <span class="hljs-keyword">const</span> <span class="hljs-built_in">NSUInteger</span> desiredCacheSize = <span class="hljs-keyword">self</span>.maxCacheSize / <span class="hljs-number">2</span>;<br><br>            <span class="hljs-built_in">NSArray</span> *sortedFiles = [cacheFiles keysSortedByValueWithOptions:<br>            <span class="hljs-built_in">NSSortConcurrent</span><br>            usingComparator:^<span class="hljs-built_in">NSComparisonResult</span>(<span class="hljs-type">id</span> obj1, <span class="hljs-type">id</span> obj2) &#123;<br>                <span class="hljs-keyword">return</span> [obj1[<span class="hljs-built_in">NSURLContentModificationDateKey</span>]<br>                compare:obj2[<span class="hljs-built_in">NSURLContentModificationDateKey</span>]];<br>            &#125;];<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSURL</span> *fileURL <span class="hljs-keyword">in</span> sortedFiles) &#123;<br>                <span class="hljs-keyword">if</span> ([_fileManager removeItemAtURL:fileURL error:<span class="hljs-literal">nil</span>])&#123;<br>                    <span class="hljs-built_in">NSDictionary</span> *resourceValues = cacheFiles[fileURL];<br>                    <span class="hljs-built_in">NSNumber</span> *totalAllocatedSize =<br>                    resourceValues[<span class="hljs-built_in">NSURLTotalFileAllocatedSizeKey</span>];<br><br>                    currentCacheSize -= [totalAllocatedSize unsignedIntegerValue];<br><br>                    <span class="hljs-keyword">if</span> (currentCacheSize &lt; desiredCacheSize) &#123;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (completionBlock) &#123;<br>            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>                completionBlock();<br>            &#125;);<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="四、后记"><a href="#四、后记" class="headerlink" title="四、后记"></a>四、后记</h3><p>SD 是一个优秀的网络图片下载库，它使在按钮等视图中加载网络图片或本地缓存变得异常轻松，有很多值得学习的地方：</p>
<ul>
<li>库中各类职责清晰；</li>
<li>网络图片的下载、解码及缓存等都使用异步的方式进行，保证了主线程的流畅性；</li>
<li>大量使用了 NSOperation 和 GCD，为我们在多线程中执行任务和处理线程同步问题提供了范例；</li>
<li>图片加载前，先在异步线程中解码成位图，为我们优化图片加载提供了灵感；</li>
<li>设计良好的缓存策略，提高了应用的性能表现；</li>
</ul>
<p>本文是根据原项目中使用的 3.7.3 版本来分析的，目前SD的最新版本号为 4.4.1。大致看了下最新的版本，网络下载部分已经使用了 URLSession，也新增了很多新的类，后面有时间会继续研究一下~</p>
<hr>
<p>相关参考：</p>
<p>#<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/uiimage#//apple_ref/occ/instp/UIImage/scale">©AppleDev-UIImage</a></p>
<p>#<a target="_blank" rel="noopener" href="https://www.cnblogs.com/chmhml/p/6817383.html">©CHM-SD图片解码</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BA%90%E7%A0%81/">#源码</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SDWebImage</div>
      <div>http://yoursite.com/2018/01/28/source_code_sd.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>January 28, 2018</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>Licensed under</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/01/31/source_code_afn.html" title="AFNetworking">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">AFNetworking</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/01/21/autoreleasepool.html" title="OC中的内存管理">
                        <span class="hidden-mobile">OC中的内存管理</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/davidlii" target="_blank" rel="nofollow noopener"><span>Davidlii</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>

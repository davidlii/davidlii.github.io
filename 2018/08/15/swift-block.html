

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Davidli">
  <meta name="keywords" content="Davidli">
  
    <meta name="description" content="1.闭包闭包(Closures)是自包含的功能代码块，可以在代码中使用或者用来作为参数传值。 1.1.语法123&amp;#123;(parameters) -&gt; return type in   statements&amp;#125; 示例： 12345let divide &#x3D; &amp;#123;(param1: Int, param2: Int) -&gt; Int in    return param1">
<meta property="og:type" content="article">
<meta property="og:title" content="Swift闭包">
<meta property="og:url" content="https://davidlii.cn/2018/08/15/swift-block.html">
<meta property="og:site_name" content="Davidli">
<meta property="og:description" content="1.闭包闭包(Closures)是自包含的功能代码块，可以在代码中使用或者用来作为参数传值。 1.1.语法123&amp;#123;(parameters) -&gt; return type in   statements&amp;#125; 示例： 12345let divide &#x3D; &amp;#123;(param1: Int, param2: Int) -&gt; Int in    return param1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://davidlii.nos-eastchina1.126.net/pic_swift.png">
<meta property="article:published_time" content="2018-08-15T14:02:17.000Z">
<meta property="article:modified_time" content="2022-07-31T18:08:17.000Z">
<meta property="article:author" content="Davidli">
<meta property="article:tag" content="block">
<meta property="article:tag" content="循环引用">
<meta property="article:tag" content="Swift">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://davidlii.nos-eastchina1.126.net/pic_swift.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Swift闭包 - Davidli</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"davidlii.cn","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>嵇风</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Swift闭包"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2018-08-15 22:02" pubdate>
          2018年8月15日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          92 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Swift闭包</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="1-闭包"><a href="#1-闭包" class="headerlink" title="1.闭包"></a>1.闭包</h3><p>闭包(Closures)是自包含的功能代码块，可以在代码中使用或者用来作为参数传值。</p>
<h4 id="1-1-语法"><a href="#1-1-语法" class="headerlink" title="1.1.语法"></a>1.1.语法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">&#123;(parameters) -&gt; <span class="hljs-keyword">return</span> type <span class="hljs-keyword">in</span><br>   statements<br>&#125;<br></code></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">let</span> divide <span class="hljs-operator">=</span> &#123;(param1: <span class="hljs-type">Int</span>, param2: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> <span class="hljs-keyword">in</span> <br>   <span class="hljs-keyword">return</span> param1 <span class="hljs-operator">/</span> param2 <br>&#125;<br><span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> divide(<span class="hljs-number">200</span>, <span class="hljs-number">20</span>)<br>print (result) <span class="hljs-comment">// 输出：10</span><br></code></pre></td></tr></table></figure>

<h4 id="1-2-优化"><a href="#1-2-优化" class="headerlink" title="1.2.优化"></a>1.2.优化</h4><p>Swift对闭包做了很多优化:</p>
<ul>
<li>根据上下文推断参数和返回值类型；</li>
<li>从单行表达式闭包中隐式返回（闭包体只有一行代码，可以省略return）；</li>
<li>可以使用简化参数名，如$0, $1(从0开始，表示第i个参数)；</li>
<li>提供了尾随闭包语法(Trailing closure syntax)；</li>
</ul>
<p>示例：</p>
<p>版本1：对数组内元素做排序</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">func</span> <span class="hljs-title function_">backward</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">s1</span>: <span class="hljs-type">String</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">s2</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Bool</span> &#123;<br>    <span class="hljs-keyword">return</span> s1 <span class="hljs-operator">&gt;</span> s2<br>&#125;<br><span class="hljs-keyword">var</span> reversedNames <span class="hljs-operator">=</span> names.sorted(by: backward)<br><span class="hljs-comment">// reversedNames is equal to [&quot;Ewa&quot;, &quot;Daniella&quot;, &quot;Chris&quot;, &quot;Barry&quot;, &quot;Alex&quot;]</span><br></code></pre></td></tr></table></figure>

<p>版本2：使用闭包</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">reversedNames <span class="hljs-operator">=</span> names.sorted(by: &#123; (s1: <span class="hljs-type">String</span>, s2: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Bool</span> <span class="hljs-keyword">in</span><br>    <span class="hljs-keyword">return</span> s1 <span class="hljs-operator">&gt;</span> s2<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>版本3：写在一行</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">reversedNames <span class="hljs-operator">=</span> names.sorted(by: &#123; (s1: <span class="hljs-type">String</span>, s2: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Bool</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">return</span> s1 <span class="hljs-operator">&gt;</span> s2 &#125; )<br></code></pre></td></tr></table></figure>

<p>版本4：根据上下文推断参数和返回值类型</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">reversedNames <span class="hljs-operator">=</span> names.sorted(by: &#123; s1, s2 <span class="hljs-keyword">in</span> <span class="hljs-keyword">return</span> s1 <span class="hljs-operator">&gt;</span> s2 &#125; )<br></code></pre></td></tr></table></figure>

<p>版本5：闭包体只有一行代码，可以省略<code>return</code>关键字</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">reversedNames <span class="hljs-operator">=</span> names.sorted(by: &#123; s1, s2 <span class="hljs-keyword">in</span> s1 <span class="hljs-operator">&gt;</span> s2 &#125; )<br></code></pre></td></tr></table></figure>

<p>版本6：使用简化参数名</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">reversedNames <span class="hljs-operator">=</span> names.sorted(by: &#123; <span class="hljs-variable">$0</span> <span class="hljs-operator">&gt;</span> <span class="hljs-variable">$1</span> &#125; )<br></code></pre></td></tr></table></figure>

<p>甚至还可以继续简化：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">reversedNames <span class="hljs-operator">=</span> names.sorted(by: <span class="hljs-operator">&gt;</span>)<br></code></pre></td></tr></table></figure>

<p>版本7：使用尾随闭包语法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">reversedNames <span class="hljs-operator">=</span> names.sorted() &#123; <span class="hljs-variable">$0</span> <span class="hljs-operator">&gt;</span> <span class="hljs-variable">$1</span> &#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-escaping"><a href="#2-escaping" class="headerlink" title="2.@escaping"></a>2.@escaping</h3><blockquote>
<p>A closure is said to escape a function when the closure is passed as an argument to the function, but is called after the function returns. When you declare a function that takes a closure as one of its parameters, you can write @escaping before the parameter’s type to indicate that the closure is allowed to escape.</p>
</blockquote>
<p>当闭包作为函数的参数，在函数<code>return</code>之后被调用时，我们就说这个闭包从函数中逃离，即<code>逃逸闭包</code>，使用<code>@escaping</code>来标示。</p>
<p>这种情况常见于函数中发起了一个异步请求并把闭包作为异步操作的回调。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-comment">// 逃逸闭包示例</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetHelper</span> &#123; <span class="hljs-comment">//网络工具类</span><br>    <br>    <span class="hljs-keyword">var</span> statusOK <span class="hljs-operator">=</span> <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">httpRequest</span>(<span class="hljs-params">withUrl</span> <span class="hljs-params">url</span>:<span class="hljs-type">String</span>,<br>                     <span class="hljs-params">succeesCallback</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Data</span>?,<span class="hljs-type">URLResponse</span>?)-&gt;(),<br>                     <span class="hljs-params">failCallback</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Error</span>?)-&gt;()) &#123;<br>        <span class="hljs-comment">//逃逸闭包必须用@escaping声明;</span><br>        <span class="hljs-comment">//否则编译时报错 Escaping closure captures non-escaping parameter &#x27;succeesCallback&#x27;</span><br>        <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>url.isEmpty <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++URL is nil~&quot;</span>)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++task start&quot;</span>)<br>        <span class="hljs-keyword">let</span> urlT:<span class="hljs-type">URL</span>? <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: url)<br>        <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>.shared.dataTask(with: urlT<span class="hljs-operator">!</span>) &#123;(data:<span class="hljs-type">Data</span>?, response:<span class="hljs-type">URLResponse</span>?, error:<span class="hljs-type">Error</span>?) <span class="hljs-keyword">in</span><br>            <span class="hljs-keyword">if</span> error <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-keyword">self</span>.statusOK <span class="hljs-operator">=</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// 逃逸闭包中使用到闭包所在类型时 需要显式的调用self 以便提醒自己捕获了self, 不写编译器会报错!</span><br>                failCallback(error) <span class="hljs-comment">//调用逃逸闭包</span><br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">self</span>.statusOK <span class="hljs-operator">=</span> <span class="hljs-literal">true</span><br>                succeesCallback(data,response) <span class="hljs-comment">//调用逃逸闭包</span><br>            &#125;<br>        &#125;<br>        task.resume() <span class="hljs-comment">// 开始任务</span><br>    &#125;<br>&#125;<br><span class="hljs-comment">// 发起网络请求</span><br><span class="hljs-keyword">var</span> netHelper <span class="hljs-operator">=</span> <span class="hljs-type">NetHelper</span>()<br>netHelper.httpRequest(withUrl: <span class="hljs-string">&quot;https://www.baidu.com&quot;</span>, succeesCallback: &#123; (data, response) <span class="hljs-keyword">in</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++Network finished successfully~<span class="hljs-subst">\n</span> response:<span class="hljs-subst">\(response<span class="hljs-operator">!</span>)</span>&quot;</span>)<br>&#125;) &#123; (error) <span class="hljs-keyword">in</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++error:<span class="hljs-subst">\(error<span class="hljs-operator">!</span>)</span>&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-autoclosure"><a href="#3-autoclosure" class="headerlink" title="3.autoclosure"></a>3.autoclosure</h3><blockquote>
<p>An autoclosure is a closure that’s automatically created to wrap an expression that’s being passed as an argument to a function. It doesn’t take any arguments, and when it’s called, it returns the value of the expression that’s wrapped inside of it. This syntactic convenience lets you omit braces around a function’s parameter by writing a normal expression instead of an explicit closure.</p>
</blockquote>
<p>自动闭包，一种自动创建的闭包，用来把作为函数参数的<code>表达式</code>自动封装成<code>闭包</code>。</p>
<p>示例1：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">func</span> <span class="hljs-title function_">logIfTrue</span>(<span class="hljs-params">predicate</span>: ()-&gt;<span class="hljs-type">Bool</span>)&#123;<br>    <span class="hljs-keyword">if</span> predicate() &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;TRUE&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>示例分析：</p>
<ol>
<li>函数接受一个闭包作为参数；</li>
<li>闭包不接受任何参数；</li>
<li>闭包被调用时，返回一个值；</li>
<li>值为true时，执行打印；</li>
</ol>
<p>示例调用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">logIfTrue(predicate: &#123; () <span class="hljs-keyword">in</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span><br>    &#125;<br>)<br></code></pre></td></tr></table></figure>

<p>优化闭包的调用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">logIfTrue(predicate: &#123;<span class="hljs-number">2</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>&#125;) <span class="hljs-comment">//写成一行并省略return关键字</span><br></code></pre></td></tr></table></figure>

<p>继续优化，使用尾随闭包写法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">logIfTrue&#123; <span class="hljs-number">2</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>&#125;<br></code></pre></td></tr></table></figure>

<p>但调用时不管怎么优化，要么书写起来十分麻烦，要么表达上不太清晰，于是自动闭包登场了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">func</span> <span class="hljs-title function_">logIfTrue</span>(<span class="hljs-params">predicate</span>: <span class="hljs-keyword">@autoclosure</span> ()-&gt;<span class="hljs-type">Bool</span>)&#123;<br>    <span class="hljs-keyword">if</span> predicate() &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;TRUE&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里改换了原方法的参数，在闭包的类型前加上<code>@autoclosure</code>关键字，再次调用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT">logIfTrue( predicate: <span class="hljs-number">2</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>Swift 会把<code>2 &gt; 1</code>这个表达式自动转换为<code>()-&gt;Bool</code>类型的闭包。</p>
<p>自动闭包的好处是：</p>
<ol>
<li>调用时写法简单，表意清楚；</li>
<li>允许延迟处理，对于闭包内有副作用或占用资源的代码，直到你调用闭包时才会运行。</li>
</ol>
<p>示例2：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">var</span> customersInLine <span class="hljs-operator">=</span> [<span class="hljs-string">&quot;Chris&quot;</span>,<span class="hljs-string">&quot;Alex&quot;</span>,<span class="hljs-string">&quot;Ewa&quot;</span>,<span class="hljs-string">&quot;Barry&quot;</span>,<span class="hljs-string">&quot;Daniella&quot;</span>]<br> <br><span class="hljs-comment">//定义block，其类型为()-&gt;String，此时尚未执行</span><br><span class="hljs-keyword">let</span> customProvider <span class="hljs-operator">=</span> &#123;customersInLine.remove(at: <span class="hljs-number">0</span>)&#125;<br> <br><span class="hljs-comment">//定义函数，接受一个()-&gt;String类型的block作为参数，使用非自动闭包的写法</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">serve</span>(<span class="hljs-params">custom</span> <span class="hljs-params">customerProvider</span>:() -&gt;<span class="hljs-type">String</span>)&#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Now serving<span class="hljs-subst">\(customerProvider())</span>!&quot;</span>)<br>&#125;<br><span class="hljs-comment">// 调用</span><br>serve(custom: &#123;customersInLine.remove(at: <span class="hljs-number">0</span>)&#125;)<br><span class="hljs-comment">// 打印结果 &quot;Now serving Chris!&quot;</span><br></code></pre></td></tr></table></figure>

<p>自动闭包的写法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-comment">//将闭包参数标记为@autoclosure</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">serve</span>(<span class="hljs-params">custom</span> <span class="hljs-params">customerProvider</span>: <span class="hljs-keyword">@autoclosure</span> () -&gt;<span class="hljs-type">String</span> )&#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Now serving <span class="hljs-subst">\(customerProvider())</span>!&quot;</span>)<br>&#125;<br><span class="hljs-comment">//调用函数时，不需要再写花括号&#123;&#125;，@autoclosure会根据上面的定义，自动将其转换为闭包</span><br>serve(custom: customersInLine.remove(at: <span class="hljs-number">0</span>))<br></code></pre></td></tr></table></figure>

<p>注意：自动闭包不接受任何参数，只有形如<code>()-&gt;T</code>的参数才能使用这个特性进行简化。</p>
<h3 id="4-捕获变量"><a href="#4-捕获变量" class="headerlink" title="4.捕获变量"></a>4.捕获变量</h3><h4 id="4-1-捕获引用"><a href="#4-1-捕获引用" class="headerlink" title="4.1.捕获引用"></a>4.1.捕获引用</h4><p>A closure can capture constants and variables from the surrounding context in which it is defined. The closure can then refer to and modify the values of those constants and variables from within its body, even if the original scope that defined the constants and variables no longer exists.</p>
<p>As an optimization, Swift may instead capture and store a copy of a value if that value is not mutated by a closure, and if the value is not mutated after the closure is created.</p>
<p>Swift also handles all memory management involved in disposing of variables when they are no longer needed.</p>
<p>OC 中 block 会捕获变量，且捕获的是变量的值。</p>
<p>Swift 的闭包也会自动捕获其上下文中定义的变量，但默认捕获的是<code>变量的引用</code>，这样就可以在闭包内修改它们的值。换句话说，Swift 闭包中变量的默认行为与 OC 中<code>__block</code> 变量一致。</p>
<p>#示例：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-comment">// Block 引用变量</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">blockRetain</span>() &#123;<br>    <span class="hljs-keyword">var</span> num <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">let</span> block1 <span class="hljs-operator">=</span> &#123; <span class="hljs-comment">// 最简单的闭包 内部引用了变量</span><br>        num <span class="hljs-operator">+=</span> <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(num)</span>&quot;</span>)<br>    &#125;<br>    num <span class="hljs-operator">+=</span> <span class="hljs-number">1</span><br>    block1()<br>&#125;<br>blockRetain() <span class="hljs-comment">// 打印 &quot;3&quot;</span><br></code></pre></td></tr></table></figure>

<p><code>num</code>是局部变量，它在<code>block1</code>中和之后都被修改了，而这两处改变也都影响了最终打印的信息。这说明<code>block1</code>中是对<code>num</code>变量进行了引用，而非值的复制，这与OC中 block 对变量的捕获有很大的不同。</p>
<h4 id="4-2-强制捕获值"><a href="#4-2-强制捕获值" class="headerlink" title="4.2.强制捕获值"></a>4.2.强制捕获值</h4><p>如果不想被引用而是被复制，则可以使用<code>捕获列表</code>：</p>
<p>#示例：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-comment">// Block 捕获变量</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">blockCapture</span>() &#123;<br>    <span class="hljs-keyword">var</span> num <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">let</span> block2 <span class="hljs-operator">=</span> &#123; [num] <span class="hljs-keyword">in</span> <span class="hljs-comment">//声明捕获列表 捕获变量的值 而非引用</span><br>        <span class="hljs-comment">//num += 1 // 此处会报错:Left side of mutating operator isn&#x27;t mutable: &#x27;num&#x27; is an immutable capture</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(num)</span>&quot;</span>)<br>    &#125;<br>    num <span class="hljs-operator">+=</span> <span class="hljs-number">1</span><br>    block2()<br>&#125;<br>blockCapture() <span class="hljs-comment">// 打印 &quot;1&quot;</span><br></code></pre></td></tr></table></figure>

<p>定义捕获列表之后，<code>num</code>在闭包中被捕获，但这次是被复制且成为了一个常量，不能在闭包内被修改。闭包之后的修改也并未影响到闭包内的打印结果，这才有点像OC中的 block。</p>
<p>Swift 出于性能考虑会对闭包做一些优化，比如它会自动判断你是否在闭包内或闭包外修改了变量，如果没有则会直接持有一份该变量的拷贝。</p>
<h3 id="5-循环引用"><a href="#5-循环引用" class="headerlink" title="5.循环引用"></a>5.循环引用</h3><h4 id="5-1-原因"><a href="#5-1-原因" class="headerlink" title="5.1.原因"></a>5.1.原因</h4><p>A strong reference cycle can also occur if you assign a closure to a property of a class instance, and the body of that closure captures the instance. This capture might occur because the closure’s body accesses a property of the instance, such as self.someProperty, or because the closure calls a method on the instance, such as self.someMethod(). In either case, these accesses cause the closure to “capture” self, creating a strong reference cycle.</p>
<p>与 OC 中的 block 类似，Swift 闭包也会强引用被它捕获的对象，从而引发可能的循环引用问题。</p>
<p>比如对象持有一个闭包属性，而闭包体中通过<code>self.</code>调用了对象的属性或方法，从而捕获了self 本身，造成循环引用。</p>
<p>#示例1：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> &#123;<br><br>    <span class="hljs-keyword">var</span> name :<span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span><br>    <span class="hljs-keyword">var</span> sBlock:(()-&gt;())<span class="hljs-operator">?</span> <span class="hljs-comment">//定义闭包属性，VC强引用闭包</span><br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() &#123;<br>        <span class="hljs-keyword">super</span>.viewDidLoad()<br>        sBlock <span class="hljs-operator">=</span> &#123;<br>            <span class="hljs-comment">//闭包访问VC的其他成员，闭包捕获并强引用self对象</span><br>            <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;x&quot;</span> <br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">deinit</span>&#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++ deinited !&quot;</span>)<span class="hljs-comment">//因为闭包的循环引用，这里析构并不会执行</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-2-解决方案1-捕获列表"><a href="#5-2-解决方案1-捕获列表" class="headerlink" title="5.2.解决方案1:捕获列表"></a>5.2.解决方案1:捕获列表</h4><p>You resolve a strong reference cycle between a closure and a class instance by defining a capture list as part of the closure’s definition.Each item in a capture list is a pairing of the weak or unowned keyword with a reference to a class instance (such as self) or a variable initialized with some value (such as delegate &#x3D; self.delegate!). </p>
<p><code>捕获列表</code>也可以解决闭包的循环引用问题，把被捕获的变量标记为<code>weak</code> 或 <code>unowned</code>即可。</p>
<ul>
<li>给带参数的闭包定义捕获列表：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">var</span> aClosure: (<span class="hljs-type">Int</span>, <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">String</span> <span class="hljs-operator">=</span> &#123;<br>    [<span class="hljs-keyword">unowned</span> <span class="hljs-keyword">self</span>, <span class="hljs-keyword">weak</span> delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.delegate<span class="hljs-operator">!</span>] (index: <span class="hljs-type">Int</span>, stringToProcess: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">String</span> <span class="hljs-keyword">in</span><br>    <span class="hljs-comment">//闭包具体内容</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>给不带参数的闭包定义捕获列表：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">var</span> aClosure: () -&gt; <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> &#123;<br>    [<span class="hljs-keyword">unowned</span> <span class="hljs-keyword">self</span>, <span class="hljs-keyword">weak</span> delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.delegate<span class="hljs-operator">!</span>] <span class="hljs-keyword">in</span><br>    <span class="hljs-comment">//闭包具体内容</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以，上面#示例1中的问题可以这样解决：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> &#123;<br><br>    <span class="hljs-keyword">var</span> name :<span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s&quot;</span><br>    <span class="hljs-keyword">var</span> sBlock:(()-&gt;())<span class="hljs-operator">?</span><br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() &#123;<br>        <span class="hljs-keyword">super</span>.viewDidLoad()<br>        sBlock <span class="hljs-operator">=</span> &#123;<br>            [<span class="hljs-keyword">unowned</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span> <span class="hljs-comment">//定义捕获列表</span><br>            <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;x&quot;</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">deinit</span>&#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++ deinited !&quot;</span>) <span class="hljs-comment">//能正常析构</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>VC虽然强引用了闭包，但是闭包对VC的引用变成了弱引用，不增加VC的引用计数，当指向VC的其他强引用都被移除后，其引用计数为0，即可正常销毁。</p>
<p>区分<code>weak</code>与<code>unowned</code>：</p>
<ul>
<li>weak</li>
</ul>
<p>A weak reference is a reference that does not keep a strong hold on the instance it refers to, and so does not stop ARC from disposing of the referenced instance. </p>
<p>Use a weak reference when the other instance has a shorter lifetime—that is, when the other instance can be deallocated first. </p>
<ul>
<li>unowned</li>
</ul>
<p>Like a weak reference, an unowned reference does not keep a strong hold on the instance it refers to. Unlike a weak reference, however, an unowned reference is used when the other instance has the same lifetime or a longer lifetime.</p>
<p>Use an unowned reference only when you are sure that the reference always refers to an instance that has not been deallocated.</p>
<p>If you try to access the value of an unowned reference after that instance has been deallocated, you’ll get a runtime error.</p>
<p><code>weak</code>与<code>unowned</code>的作用类似，都是用来解决循环引用问题。区别在于：</p>
<p><strong>1.生命周期：</strong></p>
<p><strong>weak</strong> 对象的生命周期一般 &lt; weak 对象所在的类的实例的生命周期，当访问该 weak 对象时它可能已经被释放了，比如 delegate、房子中的租客。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123; <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name &#125;<br>    <span class="hljs-keyword">var</span> apartment: <span class="hljs-type">Apartment</span>?<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(name)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Apartment</span> &#123;<br>    <span class="hljs-keyword">let</span> unit: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">unit</span>: <span class="hljs-type">String</span>) &#123; <span class="hljs-keyword">self</span>.unit <span class="hljs-operator">=</span> unit &#125;<br>    <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> tenant: <span class="hljs-type">Person</span>?<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Apartment <span class="hljs-subst">\(unit)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> john: <span class="hljs-type">Person</span>?<br><span class="hljs-keyword">var</span> unit4A: <span class="hljs-type">Apartment</span>?<br>john <span class="hljs-operator">=</span> <span class="hljs-type">Person</span>(name: <span class="hljs-string">&quot;John Appleseed&quot;</span>)<br>unit4A <span class="hljs-operator">=</span> <span class="hljs-type">Apartment</span>(unit: <span class="hljs-string">&quot;4A&quot;</span>)<br><br><span class="hljs-comment">// 相互持有</span><br>john<span class="hljs-operator">!</span>.apartment <span class="hljs-operator">=</span> unit4A<br>unit4A<span class="hljs-operator">!</span>.tenant <span class="hljs-operator">=</span> john<br><br><span class="hljs-comment">// 看看是否能调用各自的析构函数</span><br>john <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>unit4A <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight mizar"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mizar">John Appleseed <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br>Apartment 4A <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br></code></pre></td></tr></table></figure>

<p>说明两个对象都已经顺利释放了~</p>
<p><strong>unowned</strong> 对象的生命周期一般 &gt;&#x3D; unowned 对象所在的类的实例的生命周期。比如 Customer 与 CreditCard，人可能没有信用卡，但信用卡一定得有个主人，Customer的生命周期比 CreditCard 长。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> &#123;<br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">var</span> card: <span class="hljs-type">CreditCard</span>?<br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(name)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCard</span> &#123;<br>    <span class="hljs-keyword">let</span> number: <span class="hljs-type">UInt64</span><br>    <span class="hljs-keyword">unowned</span> <span class="hljs-keyword">let</span> customer: <span class="hljs-type">Customer</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">number</span>: <span class="hljs-type">UInt64</span>, <span class="hljs-params">customer</span>: <span class="hljs-type">Customer</span>) &#123;<br>        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> number<br>        <span class="hljs-keyword">self</span>.customer <span class="hljs-operator">=</span> customer<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Card #<span class="hljs-subst">\(number)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-comment">// 相互持有</span><br><span class="hljs-keyword">var</span> john: <span class="hljs-type">Customer</span>? <span class="hljs-operator">=</span> <span class="hljs-type">Customer</span>(name: <span class="hljs-string">&quot;John Appleseed&quot;</span>)<br>john<span class="hljs-operator">!</span>.card <span class="hljs-operator">=</span> <span class="hljs-type">CreditCard</span>(number: <span class="hljs-number">1234_5678_9012_3456</span>, customer: john<span class="hljs-operator">!</span>)<br><span class="hljs-comment">// 尝试看Customer和CreditCard对象是否能顺利析构</span><br>john <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight mizar"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mizar">John Appleseed <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br>Card #1234567890123456 <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br></code></pre></td></tr></table></figure>

<p>两个实例都顺利析构并释放内存~</p>
<p><strong>2.野指针问题</strong></p>
<p><strong>weak</strong> 修饰可选对象，当对象释放时弱引用也随即消失，继续访问该对象时会得到 nil，不会闪退。</p>
<p><strong>unowned</strong> 相当于OC中的<code>unsafe_unretained</code>，也不会增加引用计数，其修饰的对象被释放后，依然会有一个无效的引用指向该对象，它不能是 optional 也不指向 nil，继续访问该对象会闪退。</p>
<h4 id="5-3-解决方案2-用结构体"><a href="#5-3-解决方案2-用结构体" class="headerlink" title="5.3.解决方案2:用结构体"></a>5.3.解决方案2:用结构体</h4><p>循环引用，从其命名来看实际上是两个问题：</p>
<ul>
<li>循环</li>
<li>引用</li>
</ul>
<p>即对象之间出现了相互引用的怪圈。在解决此类问题时，我们的第一反应往往是使用<code>weak</code>或<code>unowned</code>来弱引用对象，从而打破这个环，这解决了第一个问题；</p>
<p>其实我们也可以从第二个问题来入手：仔细回想一下，我们所见到的循环引用一般都是出现在两个或多个<code>引用</code>类型之间，比如<code>闭包</code>和<code>类</code>之间。所以换个角度来想，如果将引用类型改成值类型，那么也就不存在相互<code>引用</code>的情况了，比如可能的话，将某些<code>类</code>改成值类型的<code>结构体</code>来实现:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs SWIFT"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Customer</span> &#123; <span class="hljs-comment">// 将此类改成由结构体来实现</span><br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">var</span> card: <span class="hljs-type">CreditCard</span>?<br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCard</span> &#123;<br>    <span class="hljs-keyword">let</span> number: <span class="hljs-type">UInt64</span><br>    <span class="hljs-keyword">let</span> customer: <span class="hljs-type">Customer</span> <span class="hljs-comment">// 这里也不再需要 unowned 修饰了</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">number</span>: <span class="hljs-type">UInt64</span>, <span class="hljs-params">customer</span>: <span class="hljs-type">Customer</span>) &#123;<br>        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> number<br>        <span class="hljs-keyword">self</span>.customer <span class="hljs-operator">=</span> customer<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Card #<span class="hljs-subst">\(number)</span> is being deinitialized&quot;</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// playground中定义的方法</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">tryStruct</span>()&#123;<br>    <span class="hljs-keyword">var</span> customer <span class="hljs-operator">=</span> <span class="hljs-type">Customer</span>(name: <span class="hljs-string">&quot;XXX&quot;</span>)<br>    <span class="hljs-keyword">let</span> card <span class="hljs-operator">=</span> <span class="hljs-type">CreditCard</span>(number: <span class="hljs-number">10</span>, customer: customer)<br>    customer.card <span class="hljs-operator">=</span> card;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">tryStruct</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">Card <span class="hljs-string">#10</span> <span class="hljs-keyword">is</span> being deinitialized<br></code></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>客户对象是结构体，作为信用卡的参数时是值的拷贝而非引用，因此不存在相互引用一说；</li>
<li>作为值类型的客户对象，在出了方法体之后被自动释放。</li>
</ul>
<p>综上，解决循环引用问题时，可以从弱化引用和替换成值类型两处入手~</p>
<hr>
<p>相关参考：</p>
<p>#<a target="_blank" rel="noopener" href="https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html#ID52">©Swift:ARC</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Swift/" class="category-chain-item">Swift</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/block/">#block</a>
      
        <a href="/tags/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8/">#循环引用</a>
      
        <a href="/tags/Swift/">#Swift</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Swift闭包</div>
      <div>https://davidlii.cn/2018/08/15/swift-block.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Davidli</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2018年8月15日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/08/18/swift-unwrap.html" title="Swift可选拆包">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Swift可选拆包</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/08/12/swift-basic.html" title="Swift一览">
                        <span class="hidden-mobile">Swift一览</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/davidli-" target="_blank" rel="nofollow noopener"><span>嵇风</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>



<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Davidli">
  <meta name="keywords" content="Davidli">
  
    <meta name="description" content="1.闭包中的变量捕获1.1.闭包默认引用变量 A closure can capture constants and variables from the surrounding context in which it is defined. The closure can then refer to and modify the values of those constants and var">
<meta property="og:type" content="article">
<meta property="og:title" content="Swift闭包捕获变量&amp;循环引用">
<meta property="og:url" content="https://davidlii.cn/2018/08/20/swift-refcycle.html">
<meta property="og:site_name" content="Davidli">
<meta property="og:description" content="1.闭包中的变量捕获1.1.闭包默认引用变量 A closure can capture constants and variables from the surrounding context in which it is defined. The closure can then refer to and modify the values of those constants and var">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://davidlii.nos-eastchina1.126.net/pic_swift.png">
<meta property="article:published_time" content="2018-08-20T14:02:17.000Z">
<meta property="article:modified_time" content="2022-07-31T18:08:17.000Z">
<meta property="article:author" content="Davidli">
<meta property="article:tag" content="循环引用">
<meta property="article:tag" content="swift">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://davidlii.nos-eastchina1.126.net/pic_swift.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Swift闭包捕获变量&amp;循环引用 - Davidli</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"davidlii.cn","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Davidlii</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/IMG_0.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Swift闭包捕获变量&amp;循环引用"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2018-08-20 22:02" pubdate>
          2018年8月20日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          54 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Swift闭包捕获变量&amp;循环引用</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="1-闭包中的变量捕获"><a href="#1-闭包中的变量捕获" class="headerlink" title="1.闭包中的变量捕获"></a>1.闭包中的变量捕获</h3><h4 id="1-1-闭包默认引用变量"><a href="#1-1-闭包默认引用变量" class="headerlink" title="1.1.闭包默认引用变量"></a>1.1.闭包默认引用变量</h4><blockquote>
<p>A closure can capture constants and variables from the surrounding context in which it is defined. The closure can then refer to and modify the values of those constants and variables from within its body, even if the original scope that defined the constants and variables no longer exists.</p>
</blockquote>
<blockquote>
<p>As an optimization, Swift may instead capture and store a copy of a value if that value is not mutated by a closure, and if the value is not mutated after the closure is created.</p>
</blockquote>
<blockquote>
<p>Swift also handles all memory management involved in disposing of variables when they are no longer needed.</p>
</blockquote>
<p>如你所知，OC 中 block 会捕获变量，且捕获的是变量的值。</p>
<p>Swift 的闭包也会自动捕获其上下文中定义的变量，但与 OC 中 block 不同的是，闭包默认捕获的是<strong>变量的引用</strong>，这样就可以在闭包内修改它们的值。换句话说，Swift 闭包中变量的默认行为与 OC 中<code>__block</code> 变量一致。</p>
<p>#示例1：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// Block 引用变量</span><br>func <span class="hljs-built_in">blockRetain</span>() &#123;<br>    <span class="hljs-selector-tag">var</span> num = <span class="hljs-number">1</span><br>    let block1 = &#123; <span class="hljs-comment">// 最简单的闭包 内部引用了变量</span><br>        num += <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\(num)&quot;</span>)<br>    &#125;<br>    num += <span class="hljs-number">1</span><br>    <span class="hljs-built_in">block1</span>()<br>&#125;<br><span class="hljs-function"><span class="hljs-title">blockRetain</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// 打印 &quot;3&quot;</span><br></code></pre></td></tr></table></figure>

<p>可以看到，<code>num</code>是局部变量，它在<code>block1</code>中和之后都被修改了，而这两处改变也都影响了最终打印的信息。这说明<code>block1</code>中是对<code>num</code>变量进行了引用，而非值的复制，这与OC中 block 对变量的捕获有很大的不同。</p>
<h4 id="1-2-闭包捕获变量"><a href="#1-2-闭包捕获变量" class="headerlink" title="1.2.闭包捕获变量"></a>1.2.闭包捕获变量</h4><p>如果不想被引用而是被复制，则可以使用<code>捕获列表</code>：</p>
<p>#示例2：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// Block 捕获变量</span><br>func <span class="hljs-built_in">blockCapture</span>() &#123;<br>    <span class="hljs-selector-tag">var</span> num = <span class="hljs-number">1</span><br>    let block2 = &#123; <span class="hljs-selector-attr">[num]</span> <span class="hljs-keyword">in</span> <span class="hljs-comment">//声明捕获列表 捕获变量 而非引用</span><br>        <span class="hljs-comment">//num += 1 // 此处会报错:Left side of mutating operator isn&#x27;t mutable: &#x27;num&#x27; is an immutable capture</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\(num)&quot;</span>)<br>    &#125;<br>    num += <span class="hljs-number">1</span><br>    <span class="hljs-built_in">block2</span>()<br>&#125;<br><span class="hljs-function"><span class="hljs-title">blockCapture</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// 打印 &quot;1&quot;</span><br></code></pre></td></tr></table></figure>

<p>可以看到，定义捕获列表之后，<code>num</code>在 block 中被捕获，但这次是被复制且成为了一个常量，不能在 block 内被修改。block 之后的修改也并未影响到 block 内的打印结果，这才有点像OC中的 block。</p>
<h4 id="1-3-闭包的优化"><a href="#1-3-闭包的优化" class="headerlink" title="1.3.闭包的优化"></a>1.3.闭包的优化</h4><p>Swift 出于性能考虑会对闭包做一些优化，比如它会自动判断你是否在闭包内或闭包外修改了变量，如果没有则会直接持有一份该<strong>变量的拷贝</strong>。</p>
<h3 id="2-闭包的循环引用"><a href="#2-闭包的循环引用" class="headerlink" title="2.闭包的循环引用"></a>2.闭包的循环引用</h3><h4 id="2-1-产生原因"><a href="#2-1-产生原因" class="headerlink" title="2.1.产生原因"></a>2.1.产生原因</h4><p>A strong reference cycle can also occur if you assign a closure to a property of a class instance, and the body of that closure captures the instance. This capture might occur because the closure’s body accesses a property of the instance, such as self.someProperty, or because the closure calls a method on the instance, such as self.someMethod(). In either case, these accesses cause the closure to “capture” self, creating a strong reference cycle.</p>
<p>与 OC 中的 block 类似，Swift 闭包也会强引用被它捕获的对象，从而引发可能的循环引用问题。</p>
<p>比如对象持有一个闭包属性，而闭包体中通过<code>self.</code>调用了对象的属性或方法，从而捕获了self 本身，造成循环引用问题。</p>
<p>#示例1：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: UIViewController &#123;<br><br>    <span class="hljs-keyword">var</span> name :<span class="hljs-built_in">String</span>? = <span class="hljs-string">&quot;s&quot;</span><br>    <span class="hljs-keyword">var</span> sBlock:<span class="hljs-function"><span class="hljs-params">(()-&gt;())</span>? //定义闭包属性，<span class="hljs-title">VC</span>强引用闭包</span><br><span class="hljs-function">    </span><br><span class="hljs-function">    <span class="hljs-title">override</span> <span class="hljs-title">func</span> <span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">super</span>.<span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span></span><br><span class="hljs-function">        <span class="hljs-title">sBlock</span> = &#123;</span><br><span class="hljs-function">            //闭包访问<span class="hljs-title">VC</span>的其他成员，闭包捕获并强引用<span class="hljs-title">self</span>对象</span><br><span class="hljs-function">            <span class="hljs-title">self</span>.<span class="hljs-title">name</span> = &quot;<span class="hljs-title">x</span>&quot; </span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">deinit</span>&#123;</span><br><span class="hljs-function">        <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;++ deinited !&quot;</span>)</span>//因为闭包的循环引用，这里析构并不会执行</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-解决方案"><a href="#2-2-解决方案" class="headerlink" title="2.2.解决方案"></a>2.2.解决方案</h4><p>You resolve a strong reference cycle between a closure and a class instance by defining a capture list as part of the closure’s definition.Each item in a capture list is a pairing of the weak or unowned keyword with a reference to a class instance (such as self) or a variable initialized with some value (such as delegate &#x3D; self.delegate!). </p>
<p><strong>捕获列表</strong>也可以解决闭包的循环引用问题，把被捕获的变量标记为<code>weak</code> 或 <code>unowned</code>即可。</p>
<ul>
<li>给带参数的闭包定义捕获列表：</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">var</span> aClosure: <span class="hljs-function"><span class="hljs-params">(Int, <span class="hljs-built_in">String</span>)</span> -&gt;</span> <span class="hljs-built_in">String</span> = &#123;<br>    [unowned self, weak delegate = self.delegate!] <span class="hljs-function"><span class="hljs-params">(index: Int, stringToProcess: <span class="hljs-built_in">String</span>)</span> -&gt;</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">in</span><br>    <span class="hljs-regexp">//闭包具体内容</span><br><span class="hljs-regexp">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>给不带参数的闭包定义捕获列表：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> aClosure: () -&gt; <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> &#123;<br>    [<span class="hljs-keyword">unowned</span> <span class="hljs-keyword">self</span>, <span class="hljs-keyword">weak</span> delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.delegate<span class="hljs-operator">!</span>] <span class="hljs-keyword">in</span><br>    <span class="hljs-comment">//闭包具体内容</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以，上面#示例1中的问题可以这样解决：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: UIViewController &#123;<br><br>    <span class="hljs-keyword">var</span> name :<span class="hljs-built_in">String</span>? = <span class="hljs-string">&quot;s&quot;</span><br>    <span class="hljs-keyword">var</span> sBlock:<span class="hljs-function"><span class="hljs-params">(()-&gt;())</span>?</span><br><span class="hljs-function">    </span><br><span class="hljs-function">    <span class="hljs-title">override</span> <span class="hljs-title">func</span> <span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">super</span>.<span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span></span><br><span class="hljs-function">        <span class="hljs-title">sBlock</span> = &#123;</span><br><span class="hljs-function">            [<span class="hljs-title">unowned</span> <span class="hljs-title">self</span>] <span class="hljs-title">in</span> //定义捕获列表</span><br><span class="hljs-function">            <span class="hljs-title">self</span>.<span class="hljs-title">name</span> = &quot;<span class="hljs-title">x</span>&quot;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">    </span><br><span class="hljs-function">    <span class="hljs-title">deinit</span>&#123;</span><br><span class="hljs-function">        <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;++ deinited !&quot;</span>)</span> //能正常析构</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-weak-与-unowned-的区别"><a href="#3-weak-与-unowned-的区别" class="headerlink" title="3.weak 与 unowned 的区别"></a>3.weak 与 unowned 的区别</h3><p><strong>weak</strong></p>
<p>A weak reference is a reference that does not keep a strong hold on the instance it refers to, and so does not stop ARC from disposing of the referenced instance. </p>
<p>Use a weak reference when the other instance has a shorter lifetime—that is, when the other instance can be deallocated first. </p>
<p><strong>unowned</strong></p>
<p>Like a weak reference, an unowned reference does not keep a strong hold on the instance it refers to. Unlike a weak reference, however, an unowned reference is used when the other instance has the same lifetime or a longer lifetime.</p>
<p>Use an unowned reference only when you are sure that the reference always refers to an instance that has not been deallocated.</p>
<p>If you try to access the value of an unowned reference after that instance has been deallocated, you’ll get a runtime error.</p>
<p>weak 与 unowned 的作用类似，都是用来解决循环引用问题。区别在于：</p>
<p><strong>生命周期：</strong></p>
<p><strong>weak</strong> 对象的生命周期一般 &lt; weak 对象所在的类的实例的生命周期，当访问该 weak 对象时它可能已经被释放了，比如 delegate、房子中的租客。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123; <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name &#125;<br>    <span class="hljs-keyword">var</span> apartment: <span class="hljs-type">Apartment</span>?<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(name)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Apartment</span> &#123;<br>    <span class="hljs-keyword">let</span> unit: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">unit</span>: <span class="hljs-type">String</span>) &#123; <span class="hljs-keyword">self</span>.unit <span class="hljs-operator">=</span> unit &#125;<br>    <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> tenant: <span class="hljs-type">Person</span>?<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Apartment <span class="hljs-subst">\(unit)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> john: <span class="hljs-type">Person</span>?<br><span class="hljs-keyword">var</span> unit4A: <span class="hljs-type">Apartment</span>?<br>john <span class="hljs-operator">=</span> <span class="hljs-type">Person</span>(name: <span class="hljs-string">&quot;John Appleseed&quot;</span>)<br>unit4A <span class="hljs-operator">=</span> <span class="hljs-type">Apartment</span>(unit: <span class="hljs-string">&quot;4A&quot;</span>)<br><br><span class="hljs-comment">// 相互持有</span><br>john<span class="hljs-operator">!</span>.apartment <span class="hljs-operator">=</span> unit4A<br>unit4A<span class="hljs-operator">!</span>.tenant <span class="hljs-operator">=</span> john<br><br><span class="hljs-comment">// 看看是否能调用各自的析构函数</span><br>john <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>unit4A <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight mizar"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mizar">John Appleseed <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br>Apartment 4A <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br></code></pre></td></tr></table></figure>

<p>说明两个对象都已经顺利释放了~</p>
<p><strong>unowned</strong> 对象的生命周期一般 &gt;&#x3D; unowned 对象所在的类的实例的生命周期。比如 Customer 与 CreditCard，人可能没有信用卡，但信用卡一定得有个主人，Customer的生命周期比 CreditCard 长。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> &#123;<br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">var</span> card: <span class="hljs-type">CreditCard</span>?<br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(name)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCard</span> &#123;<br>    <span class="hljs-keyword">let</span> number: <span class="hljs-type">UInt64</span><br>    <span class="hljs-keyword">unowned</span> <span class="hljs-keyword">let</span> customer: <span class="hljs-type">Customer</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">number</span>: <span class="hljs-type">UInt64</span>, <span class="hljs-params">customer</span>: <span class="hljs-type">Customer</span>) &#123;<br>        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> number<br>        <span class="hljs-keyword">self</span>.customer <span class="hljs-operator">=</span> customer<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Card #<span class="hljs-subst">\(number)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-comment">// 相互持有</span><br><span class="hljs-keyword">var</span> john: <span class="hljs-type">Customer</span>? <span class="hljs-operator">=</span> <span class="hljs-type">Customer</span>(name: <span class="hljs-string">&quot;John Appleseed&quot;</span>)<br>john<span class="hljs-operator">!</span>.card <span class="hljs-operator">=</span> <span class="hljs-type">CreditCard</span>(number: <span class="hljs-number">1234_5678_9012_3456</span>, customer: john<span class="hljs-operator">!</span>)<br><span class="hljs-comment">// 尝试看Customer和CreditCard对象是否能顺利析构</span><br>john <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight mizar"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mizar">John Appleseed <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br>Card #1234567890123456 <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br></code></pre></td></tr></table></figure>

<p>两个实例都顺利析构并释放内存~</p>
<p><strong>野指针问题</strong></p>
<p><strong>weak</strong> 对象释放后弱引用也随即消失，继续访问该对象时程序会得到 nil，不会崩溃。</p>
<p><strong>unowned</strong> 对象在释放后，依然有一个无效的引用指向对象，它不是 Optional 也不指向 nil。如果继续访问该对象就会崩溃。</p>
<h3 id="4-反思"><a href="#4-反思" class="headerlink" title="4.反思"></a>4.反思</h3><p>循环引用，从其命名来看实际上是两个问题：</p>
<ul>
<li>循环</li>
<li>引用</li>
</ul>
<p>即对象之间出现了相互引用的怪圈。在解决此类问题时，我们的第一反应往往是使用<code>weak</code>或<code>unowned</code>来弱引用对象，从而打破这个环，这解决了第一个问题；</p>
<p>其实我们也可以从第二个问题来入手：仔细回想一下，我们所见到的循环引用一般都是出现在两个或多个<code>引用</code>类型之间，比如<code>闭包</code>和<code>类</code>之间。所以换个角度来想，如果将引用类型改成值类型，那么也就不存在相互<code>引用</code>的情况了，比如可能的话，将某些<code>类</code>改成值类型的<code>结构体</code>来实现:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Customer</span> &#123; <span class="hljs-comment">// 将此类改成由结构体来实现</span><br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">var</span> card: <span class="hljs-type">CreditCard</span>?<br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCard</span> &#123;<br>    <span class="hljs-keyword">let</span> number: <span class="hljs-type">UInt64</span><br>    <span class="hljs-keyword">let</span> customer: <span class="hljs-type">Customer</span> <span class="hljs-comment">// 这里也不再需要 unowned 修饰了</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">number</span>: <span class="hljs-type">UInt64</span>, <span class="hljs-params">customer</span>: <span class="hljs-type">Customer</span>) &#123;<br>        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> number<br>        <span class="hljs-keyword">self</span>.customer <span class="hljs-operator">=</span> customer<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Card #<span class="hljs-subst">\(number)</span> is being deinitialized&quot;</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// playground中定义的方法</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">tryStruct</span>()&#123;<br>    <span class="hljs-keyword">var</span> customer <span class="hljs-operator">=</span> <span class="hljs-type">Customer</span>(name: <span class="hljs-string">&quot;XXX&quot;</span>)<br>    <span class="hljs-keyword">let</span> card <span class="hljs-operator">=</span> <span class="hljs-type">CreditCard</span>(number: <span class="hljs-number">10</span>, customer: customer)<br>    customer.card <span class="hljs-operator">=</span> card;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">tryStruct</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">Card <span class="hljs-string">#10</span> <span class="hljs-keyword">is</span> being deinitialized<br></code></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>客户对象是结构体，作为信用卡的参数时是值的拷贝而非引用，因此不存在相互引用一说；</li>
<li>作为值类型的客户对象，在出了方法体之后被自动释放。</li>
</ul>
<p>综上，解决循环引用问题时，可以从弱化引用和替换成值类型两处入手~</p>
<hr>
<p>相关参考：</p>
<p>#<a target="_blank" rel="noopener" href="https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html#ID52">©Swift:ARC</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8/">#循环引用</a>
      
        <a href="/tags/swift/">#swift</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Swift闭包捕获变量&amp;循环引用</div>
      <div>https://davidlii.cn/2018/08/20/swift-refcycle.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Davidli</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2018年8月20日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/08/31/swift-kvo-observer.html" title="Swift 中监听属性变化">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Swift 中监听属性变化</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/08/18/swift-error.html" title="Swift中Error异常">
                        <span class="hidden-mobile">Swift中Error异常</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/davidli-" target="_blank" rel="nofollow noopener"><span>Davidlii</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>

<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>iOSé›†æˆflutteræ¨¡å—</title>
    <link href="/2023/04/23/flutter-embedin-ios.html"/>
    <url>/2023/04/23/flutter-embedin-ios.html</url>
    
    <content type="html"><![CDATA[<h4 id="1-é›†æˆæ–¹å¼"><a href="#1-é›†æˆæ–¹å¼" class="headerlink" title="1.é›†æˆæ–¹å¼"></a>1.é›†æˆæ–¹å¼</h4><p>ç°æœ‰iOSå·¥ç¨‹ä¸­ï¼Œå¯ä»¥æ·»åŠ <code>flutter_module</code>ä»¥é›†æˆflutteræ¨¡å—ã€‚è¿™äº›æ¨¡å—ä¼šä»¥frameworkçš„å½¢å¼è¢«é›†æˆåˆ°iOSå·¥ç¨‹ä¸­ã€‚åŒæ—¶åœ¨é›†æˆflutteræ¨¡å—å‰ï¼Œéœ€è¦å¯¼å…¥ä¾èµ–çš„Flutter engineç­‰ã€‚ä¸ºå®Œæˆè¿™äº›å·¥ä½œï¼ŒFlutteræ ¹æ®ä¸åŒéœ€æ±‚æä¾›äº†ä¸‰ç§æ–¹å¼ï¼š</p><p>1.å…¨è‡ªåŠ¨</p><p>CocoaPodsç®¡ç†ä¾èµ–ï¼Œè¿™ç§æ–¹å¼ä¸‹æ¯æ¬¡æˆ‘ä»¬buildåº”ç”¨æ—¶ï¼Œ<code>flutter_module</code>æ¨¡å—ä¸­çš„æ–‡ä»¶éƒ½ä¼šè¢«è‡ªåŠ¨ç¼–è¯‘ã€‚è¿™ç›¸å½“äºæ‡’äººæ¨¡å¼ï¼ŒCocoaPodså¸®æˆ‘ä»¬ä¸€é”®å¯¼å…¥ï¼Œè¿™ä¹Ÿæ˜¯Flutterå®˜æ–¹æ¨èçš„æ–¹å¼ã€‚</p><p>2.å…¨æ‰‹åŠ¨</p><p>å¯¹äºå¹¶éæ¯ä¸ªäººéƒ½å®‰è£…äº†CocoaPodsçš„å›¢é˜Ÿï¼Œå¯ä»¥é€‰æ‹©åœ¨flutteræ¨¡å—ä¸­æ‰‹åŠ¨æ‰§è¡Œ<code>flutter build ios-framework</code>å‘½ä»¤ï¼Œä¸ºFlutter engineã€ ä½ çš„Dartä»£ç ã€Flutteræ’ä»¶åˆ›å»ºframeworkï¼Œé›†æˆè¿™äº›frameworkåˆ°ç°æœ‰å·¥ç¨‹å¹¶æ‰‹åŠ¨æ›´æ–°å·¥ç¨‹é…ç½®ã€‚</p><p>3.åŠè‡ªåŠ¨</p><p>æ‰‹åŠ¨ä¸ºä½ çš„Dartä»£ç ã€Flutteræ’ä»¶åˆ›å»ºframeworkï¼ŒåŒæ—¶å°†Flutter engineä½œä¸ºpodspecï¼Œç”¨Cocoapodsè‡ªåŠ¨é›†æˆåˆ°å·¥ç¨‹ä¸­ã€‚</p><h4 id="2-åˆ›å»ºflutteræ¨¡å—"><a href="#2-åˆ›å»ºflutteræ¨¡å—" class="headerlink" title="2.åˆ›å»ºflutteræ¨¡å—"></a>2.åˆ›å»ºflutteræ¨¡å—</h4><p>é¦–å…ˆè¦åˆ‡æ¢åˆ°ç°æœ‰iOSå·¥ç¨‹çš„æ ¹ç›®å½•:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /Desktop/Hello<br></code></pre></td></tr></table></figure><p>åœ¨æ ¹ç›®å½•ä¸­åˆ›å»ºFlutteræ¨¡å—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">flutter create --template module flutters  //æˆ‘è¿™é‡Œç»™flutteræ¨¡å—èµ·åflutters<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤è¡Œä¹‹åï¼Œä¼šåœ¨<code>/flutters</code>ç›®å½•ä¸­åˆ›å»ºflutteræ¨¡å—çš„å­å·¥ç¨‹ã€‚å…¶ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">â””â”€â”€ flutters<br>â”œâ”€â”€ .ios/<br>â”‚   â”œâ”€â”€ Runner<span class="hljs-selector-class">.xcworkspace</span><br>â”‚   â””â”€â”€ Flutter/podhelper<span class="hljs-selector-class">.rb</span><br>â”œâ”€â”€ README<span class="hljs-selector-class">.md</span><br>â”œâ”€â”€ analysis_options<span class="hljs-selector-class">.yaml</span><br>â”œâ”€â”€ build<br>â”‚   â””â”€â”€ b6b68957fc5ed9202596a46ebc5bde9b<br>â”œâ”€â”€ flutters<span class="hljs-selector-class">.iml</span><br>â”œâ”€â”€ flutters_android<span class="hljs-selector-class">.iml</span><br>â”œâ”€â”€ lib<br>â”‚   â”œâ”€â”€ login<span class="hljs-selector-class">.dart</span> <span class="hljs-comment">//è¿™æ˜¯æˆ‘åæœŸåˆ›å»ºçš„Flutter UIä»£ç </span><br>â”‚   â””â”€â”€ <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.dart</span><br>â”œâ”€â”€ pubspec<span class="hljs-selector-class">.lock</span><br>â”œâ”€â”€ pubspec<span class="hljs-selector-class">.yaml</span><br>â””â”€â”€ test<br>    â””â”€â”€ widget_test.dart<br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„<code>/lib</code>ç›®å½•ç”¨äºå­˜æ”¾æˆ‘ä»¬çš„Dartä»£ç ï¼Œä¾‹å¦‚<code>login.dart</code>å°±æ˜¯æˆ‘åé¢åˆ›å»ºçš„ç™»å½•UIã€‚</p><p><code>pubspec.yaml</code>æ˜¯Flutterç”¨åˆ°çš„ä¾èµ–ï¼Œå¦‚åŒ…å’Œæ’ä»¶ã€‚</p><p>æœ‰ä¸ªéšè—çš„<code>/.ios</code>ç›®å½•ï¼Œéœ€è¦è§£é™¤éšè—è®¾ç½®åæ‰èƒ½çœ‹åˆ°(ä½¿ç”¨<code>command</code>+<code>shift</code>+<code>.</code>å¿«æ·é”®)ã€‚è¿™é‡Œå­˜ç€çš„æ˜¯æˆ‘ä»¬ç¼–å†™çš„flutter UIå¯¹åº”çš„iOSå·¥ç¨‹ï¼Œå®ƒå¯ä»¥é€šè¿‡é…ç½®çš„è„šæœ¬å¸®æˆ‘ä»¬æŠŠDartä»£ç ç¼–è¯‘æˆframeworkï¼Œå¹¶ç”¨CocoaPodsæŠŠæˆ‘ä»¬çš„flutteræ¨¡å—é›†æˆåˆ°ç°æœ‰iOSå·¥ç¨‹ä¸­ã€‚è¿™ä¸ªç›®å½•ä¸‹çš„ä»£ç æ— éœ€åŠ å…¥Gitç®¡ç†ä¸­ï¼Œå®ƒæ˜¯Flutterè‡ªåŠ¨ç”Ÿæˆçš„ã€‚åœ¨æ–°è®¾å¤‡ä¸­è¿è¡Œæˆ‘ä»¬çš„iOSåŸç”Ÿå·¥ç¨‹å‰ï¼Œéœ€è¦å…ˆåœ¨<code>/flutters</code>ç›®å½•ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä»¥ä¾¿é‡æ–°ç”Ÿæˆè¯¥<code>/.ios</code>ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">flutter pub get<br></code></pre></td></tr></table></figure><h4 id="3-å¯¼å…¥frameworkåˆ°iOSå·¥ç¨‹ä¸­"><a href="#3-å¯¼å…¥frameworkåˆ°iOSå·¥ç¨‹ä¸­" class="headerlink" title="3.å¯¼å…¥frameworkåˆ°iOSå·¥ç¨‹ä¸­"></a>3.å¯¼å…¥frameworkåˆ°iOSå·¥ç¨‹ä¸­</h4><p>è¿™é‡Œæ¨èçš„æ˜¯ä½¿ç”¨CocoaPodså¯¼å…¥æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦é…ç½®Podfileæ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Pods">//é…ç½®flutteræ¨¡å—çš„è·¯å¾„<br>flutter_application_path = &#x27;./flutters/&#x27;<br>load File.join(flutter_application_path, &#x27;.ios&#x27;, &#x27;Flutter&#x27;, &#x27;podhelper.rb&#x27;)<br><br>target &#x27;Hello&#x27; do<br>  use_frameworks!<br>  #è¿™é‡Œæ˜¯åŸç”Ÿå·¥ç¨‹çš„ä¾èµ–åº“<br>  pod &#x27;RxSwift&#x27;<br>  pod &#x27;RxCocoa&#x27;<br>  pod &#x27;RxAlamofire&#x27;<br><br>  #æ¯ä¸ªéœ€è¦é›†æˆFlutterçš„targetéƒ½éœ€è¦ä¸‹é¢è¿™æ¡<br>  install_all_flutter_pods(flutter_application_path)<br>end<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>pod install</code>ã€‚è¿™é‡Œ<code>podhelper.rb</code>è„šæœ¬ä¼šæŠŠflutteræ¨¡å—ä¸­çš„æ’ä»¶ã€<code>Flutter.framework</code>ã€<code>App.framework</code>åµŒå…¥åˆ°æˆ‘ä»¬çš„åŸç”Ÿå·¥ç¨‹é‡Œã€‚</p><p>å…¶ä¸­<code>Flutter.framework</code>æ˜¯Flutter engineæ‰€åœ¨çš„ç›®å½•ï¼Œ<code>App.framework</code>æ˜¯flutterå­é¡¹ç›®ç¼–è¯‘åçš„Dartä»£ç æ‰€åœ¨çš„ç›®å½•ã€‚</p><p>æ³¨æ„ï¼Œé€šè¿‡CocoaPodsè¿™ç§æ–¹å¼é›†æˆæ—¶ï¼Œéœ€è¦æœ¬åœ°å®‰è£…å¥½<code>Flutter SDK</code>ã€‚</p><p>å¦‚æœ<code>pubspec.yaml</code>ä¸­æ›´æ–°äº†ä¾èµ–çš„æ’ä»¶ï¼Œåˆ™éœ€è¦åœ¨flutteræ¨¡å—çš„ç›®å½•<code>/flutters</code>ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç æ¥æ›´æ–°<code>podhelper.rb</code>è¦ç”¨åˆ°çš„æ’ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">flutter pub get<br></code></pre></td></tr></table></figure><p>å®Œäº†å†åœ¨iOSåŸç”Ÿé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä¸€æ¬¡<code>pod install</code>ï¼ŒåŒæ­¥flutteræ¨¡å—çš„æ›´æ–°ã€‚</p><h4 id="4-åˆ›å»ºflutteré¡µé¢"><a href="#4-åˆ›å»ºflutteré¡µé¢" class="headerlink" title="4.åˆ›å»ºflutteré¡µé¢"></a>4.åˆ›å»ºflutteré¡µé¢</h4><p><code>/lib</code>ç›®å½•ä¸‹<code>main.dart</code>æ˜¯Flutterè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆçš„ä¸€ä¸ªé¡µé¢ï¼Œæ˜¯é»˜è®¤çš„flutteré¡µé¢ä¸»å…¥å£ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Dart"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:flutter/material.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;login.dart&#x27;</span>;<br><br><span class="hljs-keyword">void</span> main() =&gt; runApp(<span class="hljs-keyword">const</span> MyApp());<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> MyApp(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br>  <span class="hljs-comment">// This widget is the root of your application.</span><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>      title: <span class="hljs-string">&#x27;Flutter Demo&#x27;</span>,<br>      theme: ThemeData(<br>        primarySwatch: Colors.blue,<br>      ),<br>      home: <span class="hljs-keyword">const</span> LoginPage(), <span class="hljs-comment">//å±•ç¤ºç™»å½•é¡µ</span><br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªç™»å½•é¡µé¢<code>login.dart</code>ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs Dart"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:flutter/material.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:flutter/services.dart&#x27;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> LoginPage(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br><br>  <span class="hljs-meta">@override</span><br>  _LoginPageState createState() =&gt; _LoginPageState();<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LoginPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">LoginPage</span>&gt; </span>&#123;<br>  <span class="hljs-comment">// æ§åˆ¶å™¨</span><br>  <span class="hljs-keyword">final</span> TextEditingController _usernameController = TextEditingController();<br>  <span class="hljs-keyword">final</span> TextEditingController _passwordController = TextEditingController();<br><br>  <span class="hljs-comment">// åŸç”ŸSwiftæ¥å£</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> platform = MethodChannel(<span class="hljs-string">&#x27;com.Hello.flutters&#x27;</span>);<br><br>  <span class="hljs-comment">// ç‚¹å‡»ç™»å½•æŒ‰é’®çš„å›è°ƒå‡½æ•°</span><br>  <span class="hljs-keyword">void</span> _handleLogin() <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-built_in">String</span> username = _usernameController.text;<br>    <span class="hljs-built_in">String</span> password = _passwordController.text;<br>    <span class="hljs-built_in">String</span> response;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// è°ƒç”¨åŸç”ŸSwiftæ¥å£</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> result = <span class="hljs-keyword">await</span> platform<br>          .invokeMethod(<span class="hljs-string">&#x27;login&#x27;</span>, &#123;<span class="hljs-string">&#x27;username&#x27;</span>: username, <span class="hljs-string">&#x27;password&#x27;</span>: password&#125;);<br>      response = <span class="hljs-string">&#x27;ç™»å½•æˆåŠŸï¼Œæ¬¢è¿å›æ¥ï¼Œ<span class="hljs-subst">$result</span>ï¼&#x27;</span>;<br>    &#125; <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) &#123;<br>      response = <span class="hljs-string">&#x27;ç™»å½•å¤±è´¥ï¼š<span class="hljs-subst">$&#123;e.message&#125;</span>&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// åœ¨æ§åˆ¶å°ä¸­æ‰“å°å“åº”ä¿¡æ¯</span><br>    <span class="hljs-built_in">print</span>(response);<br>  &#125;<br><br>  <span class="hljs-comment">// ç‚¹å‡»è¿”å›æŒ‰é’®</span><br>  <span class="hljs-keyword">void</span> _handleBack() &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      platform.invokeMethod(<span class="hljs-string">&quot;back&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;error: <span class="hljs-subst">$e</span>.message&#x27;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      appBar: AppBar(<br>        leading: IconButton(<br>            icon: <span class="hljs-keyword">const</span> Icon(Icons.arrow_back_ios), onPressed: _handleBack),<br>        title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;ç”¨æˆ·ç™»å½•&#x27;</span>),<br>      ),<br>      body: Padding(<br>        padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16.0</span>),<br>        child: Column(<br>          mainAxisAlignment: MainAxisAlignment.center,<br>          children: [<br>            TextField(<br>              controller: _usernameController,<br>              decoration: <span class="hljs-keyword">const</span> InputDecoration(<br>                hintText: <span class="hljs-string">&#x27;è¯·è¾“å…¥ç”¨æˆ·å&#x27;</span>,<br>              ),<br>            ),<br>            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">20.0</span>),<br>            TextField(<br>              controller: _passwordController,<br>              obscureText: <span class="hljs-keyword">true</span>,<br>              decoration: <span class="hljs-keyword">const</span> InputDecoration(<br>                hintText: <span class="hljs-string">&#x27;è¯·è¾“å…¥å¯†ç &#x27;</span>,<br>              ),<br>            ),<br>            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">20.0</span>),<br>            ElevatedButton(<br>              onPressed: _handleLogin,<br>              child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;ç™»å½•&#x27;</span>),<br>            ),<br>          ],<br>        ),<br>      ),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-é›†æˆflutteré¡µé¢"><a href="#5-é›†æˆflutteré¡µé¢" class="headerlink" title="5.é›†æˆflutteré¡µé¢"></a>5.é›†æˆflutteré¡µé¢</h4><p>é›†æˆflutteré¡µé¢åˆ°iOSå·¥ç¨‹ï¼Œéœ€è¦<code>FlutterEngine</code>å’Œ<code>FlutterViewController</code>ã€‚<code>FlutterEngine</code>å……å½“Dart VMå’ŒFlutterè¿è¡Œæ—¶çš„ä¸»æœºï¼Œ<code>FlutterViewController</code>ç”¨æ¥å‘Flutterä¼ é€’ç”¨æˆ·è¾“å…¥äº‹ä»¶å’Œå±•ç¤º<code>FlutterEngine</code>æ¸²æŸ“çš„ç”»é¢ã€‚</p><h5 id="1-åˆ›å»ºFlutterEngine"><a href="#1-åˆ›å»ºFlutterEngine" class="headerlink" title="1.åˆ›å»ºFlutterEngine"></a>1.åˆ›å»ºFlutterEngine</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Swift"><span class="hljs-keyword">import</span> UIKit<br><span class="hljs-keyword">import</span> Flutter<br><span class="hljs-keyword">import</span> FlutterPluginRegistrant<br><br><span class="hljs-keyword">@UIApplicationMain</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">FlutterAppDelegate</span> &#123;<br>    <br>    <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">var</span> flutterEngine <span class="hljs-operator">=</span> <span class="hljs-type">FlutterEngine</span>(name: <span class="hljs-string">&quot;FlutterInSwift&quot;</span>)<br>   <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> &#123;<br>        <br>        <span class="hljs-comment">// æ³¨å†ŒFlutterå¼•æ“</span><br>        flutterEngine.run()<br>        <span class="hljs-type">GeneratedPluginRegistrant</span>.register(with: flutterEngine)<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-å±•ç¤ºFlutterViewController"><a href="#2-å±•ç¤ºFlutterViewController" class="headerlink" title="2.å±•ç¤ºFlutterViewController"></a>2.å±•ç¤ºFlutterViewController</h5><p>åˆ›å»ºSwifté¡µé¢ï¼Œæä¾›å…¥å£ä»¥ä¾¿è·³è½¬åˆ°flutteré¡µé¢ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs Swift"><span class="hljs-keyword">import</span> UIKit<br><span class="hljs-keyword">import</span> Flutter<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DKFlutterInSwiftController</span>: <span class="hljs-title class_">UIViewController</span> &#123;<br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() &#123;<br>        <span class="hljs-keyword">super</span>.viewDidLoad()<br>        <br>        <span class="hljs-keyword">let</span> button <span class="hljs-operator">=</span> <span class="hljs-type">UIButton</span>.<span class="hljs-keyword">init</span>(type: .custom)<br>        button.setTitle(<span class="hljs-string">&quot;Click to flutter page&quot;</span>, for: .normal)<br>        button.setTitleColor(<span class="hljs-type">UIColor</span>.white, for: .normal)<br>        button.backgroundColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.systemBlue<br>        button.layer.cornerRadius <span class="hljs-operator">=</span> <span class="hljs-number">6</span><br>        button.addTarget(<span class="hljs-keyword">self</span>, action: <span class="hljs-keyword">#selector</span>(handleClick), for: .touchUpInside)<br>        button.sizeToFit()<br>        view.addSubview(button)<br>        view.backgroundColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>.white<br>        <br>        <span class="hljs-keyword">let</span> width:<span class="hljs-type">CGFloat</span>  <span class="hljs-operator">=</span> button.frame.size.width<span class="hljs-operator">+</span><span class="hljs-number">20</span><br>        <span class="hljs-keyword">let</span> height:<span class="hljs-type">CGFloat</span> <span class="hljs-operator">=</span> <span class="hljs-number">45.0</span><br>        <span class="hljs-keyword">let</span> frame <span class="hljs-operator">=</span> <span class="hljs-type">CGRect</span>.<span class="hljs-keyword">init</span>(x: (view.frame.size.width <span class="hljs-operator">-</span> width) <span class="hljs-operator">/</span> <span class="hljs-number">2.0</span>, y: (view.frame.size.height <span class="hljs-operator">-</span> height) <span class="hljs-operator">/</span> <span class="hljs-number">2.0</span>, width: width, height: height)<br>        button.frame <span class="hljs-operator">=</span> frame<br>    &#125;<br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewWillAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) &#123;<br>        <span class="hljs-keyword">super</span>.viewWillAppear(animated)<br>        navigationController<span class="hljs-operator">?</span>.setNavigationBarHidden(<span class="hljs-literal">false</span>, animated: <span class="hljs-literal">true</span>)<br>    &#125;<br>        <br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleClick</span>()&#123;<br>        <span class="hljs-comment">//è·³è½¬Flutteré¡µé¢</span><br>        <span class="hljs-keyword">let</span> flutterEngine <span class="hljs-operator">=</span> (<span class="hljs-type">UIApplication</span>.shared.delegate <span class="hljs-keyword">as!</span> <span class="hljs-type">AppDelegate</span>).flutterEngine<br>        <span class="hljs-keyword">let</span> flutterController <span class="hljs-operator">=</span> <span class="hljs-type">FlutterViewController</span>(engine: flutterEngine, nibName: <span class="hljs-literal">nil</span>, bundle: <span class="hljs-literal">nil</span>)<br>        navigationController<span class="hljs-operator">?</span>.setNavigationBarHidden(<span class="hljs-literal">true</span>, animated: <span class="hljs-literal">true</span>)<br>        navigationController<span class="hljs-operator">?</span>.pushViewController(flutterController, animated: <span class="hljs-literal">true</span>)<br><br>        <span class="hljs-comment">//Swiftä¸Flutteré€šä¿¡</span><br>        <span class="hljs-keyword">let</span> channel <span class="hljs-operator">=</span> <span class="hljs-type">FlutterMethodChannel</span>(name: <span class="hljs-string">&quot;com.Hello.flutters&quot;</span>, binaryMessenger: flutterController <span class="hljs-keyword">as!</span> <span class="hljs-type">FlutterBinaryMessenger</span>)<br>        channel.setMethodCallHandler &#123; [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] (call:<span class="hljs-type">FlutterMethodCall</span>, result:<span class="hljs-keyword">@escaping</span> <span class="hljs-type">FlutterResult</span>) <span class="hljs-keyword">in</span><br>           <span class="hljs-comment">//ç™»å½•è¿”å›</span><br>           <span class="hljs-keyword">if</span> (call.method <span class="hljs-operator">==</span> <span class="hljs-string">&quot;back&quot;</span>) &#123;<br>               <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.navigationController<span class="hljs-operator">?</span>.popViewController(animated: <span class="hljs-literal">true</span>)<br>           &#125;<br>           <span class="hljs-comment">//ç™»å½•</span><br>           <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (call.method <span class="hljs-operator">==</span> <span class="hljs-string">&quot;login&quot;</span>) &#123;<br>               result(<span class="hljs-string">&quot;This is a response from Swift&quot;</span>);<br>           &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨Swifté¡µé¢ä¸­æ”¾ç½®äº†ä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»åä¼šè·³è½¬åˆ°flutteré¡µé¢ã€‚å…·ä½“æ˜¯å“ªä¸ªflutteré¡µé¢å‘¢ï¼Ÿè¿™æ˜¯ç”±Dartçš„ä¸»å…¥å£å‡½æ•°å†³å®šçš„ã€‚<code>FlutterEngine</code>ä¼šåŠ è½½Dartåº“ä¸­é»˜è®¤çš„ä¸»å…¥å£<code>main()</code>å‡½æ•°ã€‚å‰é¢çš„flutteræ¨¡å—ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨<code>main.dart</code>ä¸­æ˜¾ç¤ºçš„æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç™»å½•é¡µé¢<code>login.dart</code>ã€‚å› æ­¤ï¼Œ<code>FlutterViewController</code>æœ€ç»ˆå±•ç¤ºçš„å°±æ˜¯è¿™ä¸ªç™»å½•é¡µé¢ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å°†flutteræ¨¡å—ä¸­çš„ç™»å½•é¡µé¢é›†æˆåˆ°iOSå·¥ç¨‹ä¸­äº†~</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_flutterinios_login.gif" alt="flutterç™»å½•é¡µ"></p><h4 id="6-ä¿®æ”¹å¯åŠ¨é…ç½®"><a href="#6-ä¿®æ”¹å¯åŠ¨é…ç½®" class="headerlink" title="6.ä¿®æ”¹å¯åŠ¨é…ç½®"></a>6.ä¿®æ”¹å¯åŠ¨é…ç½®</h4><p>ä¸Šé¢é›†æˆflutteré¡µé¢æ—¶ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„å¯åŠ¨é…ç½®ï¼Œå³åŠ è½½<code>main()</code>å…¥å£ï¼Œå±•ç¤ºå…¶<code>home</code>ï¼šç™»å½•é¡µã€‚</p><p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰Dartå…¥å£ï¼Œæˆ–è€…åŠ è½½<code>home</code>ä»¥å¤–çš„å…¶ä»–flutteré¡µé¢ã€‚è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ä¿®æ”¹å¯¹åº”çš„å¯åŠ¨é…ç½®ã€‚</p><h5 id="1-ä¿®æ”¹å…¥å£"><a href="#1-ä¿®æ”¹å…¥å£" class="headerlink" title="1.ä¿®æ”¹å…¥å£"></a>1.ä¿®æ”¹å…¥å£</h5><p>ä½¿ç”¨<code>lib/main.dart</code>æ–‡ä»¶ä¸­<code>main()</code>ä»¥å¤–çš„å‡½æ•°ä½œä¸ºä¸»å…¥å£æ—¶ï¼Œéœ€è¦å¯¹æ­¤å‡½æ•°åšç‰¹æ®Šæ ‡è®°ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Dart"><span class="hljs-meta">@pragma</span>(<span class="hljs-string">&#x27;vm:entry-point&#x27;</span>)<br><span class="hljs-keyword">void</span> myNewEntry() &#123; ... &#125;;<br></code></pre></td></tr></table></figure><h5 id="2-é‡æ–°æŒ‡å®šå…¥å£"><a href="#2-é‡æ–°æŒ‡å®šå…¥å£" class="headerlink" title="2.é‡æ–°æŒ‡å®šå…¥å£"></a>2.é‡æ–°æŒ‡å®šå…¥å£</h5><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>flutterEngine.run()</code>æ¥åŠ è½½é»˜è®¤å…¥å£å‡½æ•°<code>main()</code>ã€‚æ ‡è®°å¹¶ä¿®æ”¹å…¥å£å‡½æ•°åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Swiftä¸­ä½¿ç”¨<code>run(withEntrypoint:)</code>æ¥é‡æ–°æŒ‡å®šå…¥å£ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Swift">flutterEngine.run(withEntrypoint: <span class="hljs-string">&quot;myNewEntry&quot;</span>, libraryURI: <span class="hljs-string">&quot;main2.dart&quot;</span>)<br></code></pre></td></tr></table></figure><p>è¿™æ ·æœ€ç»ˆå±•ç¤ºçš„å°±æ˜¯<code>myNewEntry</code>å‡½æ•°ä¸­è®¾ç½®çš„æ ¹è·¯ç”±é¡µé¢äº†ã€‚</p><h5 id="3-ä¿®æ”¹é»˜è®¤è·¯ç”±"><a href="#3-ä¿®æ”¹é»˜è®¤è·¯ç”±" class="headerlink" title="3.ä¿®æ”¹é»˜è®¤è·¯ç”±"></a>3.ä¿®æ”¹é»˜è®¤è·¯ç”±</h5><p>Dartä¸­é™¤äº†æ ¹è·¯ç”±å¤–è¿˜æœ‰å…¶ä»–é¡µé¢ï¼Œå¯ä»¥ç»™è¿™äº›é¡µé¢å‘½åå¹¶æ³¨å†Œåˆ°è·¯ç”±è¡¨ä¸­ï¼Œä»¥ä¾¿é€šè¿‡åå­—ç›´æ¥åŠ è½½è¿™äº›é¡µé¢ã€‚æˆ‘ä»¬åœ¨iOSå·¥ç¨‹ä¸­å±•ç¤ºçš„flutteré¡µé¢è‚¯å®šä¹Ÿä¸æ­¢ä¸€ä¸ªï¼Œä½¿ç”¨å‘½åè·¯ç”±å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æŒ‡å®šéœ€è¦è·³è½¬çš„é¡µé¢ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å†è‡ªå®šä¹‰ä¸€ä¸ªflutteré¡µé¢ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Dart"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:flutter/material.dart&#x27;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WelcomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> WelcomePage(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      appBar: AppBar(<br>        leading: IconButton(<br>            icon: <span class="hljs-keyword">const</span> Icon(Icons.arrow_back_ios), onPressed: () &#123;&#125;),<br>        title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;æ–°è·¯ç”±&#x27;</span>),<br>      ),<br>      body: <span class="hljs-keyword">const</span> Center(<br>        child: Text(<br>          <span class="hljs-string">&quot;æ¬¢è¿~&quot;</span>,<br>          style: TextStyle(<br>              fontSize: <span class="hljs-number">25</span>, fontWeight: FontWeight.bold, color: Colors.blue),<br>        ),<br>      ),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„æ¬¢è¿é¡µé¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹<code>main()</code>ä¸­çš„è·¯ç”±é…ç½®ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:flutter/material.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;login.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;welcome.dart&#x27;</span>;<br><br><span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>() =&gt; <span class="hljs-title function_">runApp</span>(<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyApp</span>());<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">StatelessWidget</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title class_">MyApp</span>(&#123;<span class="hljs-title class_">Key</span>? key&#125;) : <span class="hljs-variable language_">super</span>(<span class="hljs-attr">key</span>: key);<br><br>  <span class="hljs-comment">// This widget is the root of your application.</span><br>  <span class="hljs-meta">@override</span><br>  <span class="hljs-title class_">Widget</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">BuildContext context</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MaterialApp</span>(<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Flutter Demo&#x27;</span>,<br>        <span class="hljs-attr">theme</span>: <span class="hljs-title class_">ThemeData</span>(<br>          <span class="hljs-attr">primarySwatch</span>: <span class="hljs-title class_">Colors</span>.<span class="hljs-property">blue</span>,<br>        ),<br>        <span class="hljs-attr">initialRoute</span>: <span class="hljs-string">&quot;/&quot;</span>,<br>        <span class="hljs-comment">//æ³¨å†Œè·¯ç”±è¡¨</span><br>        <span class="hljs-attr">routes</span>: &#123;<br>          <span class="hljs-string">&quot;/&quot;</span>: <span class="hljs-function">(<span class="hljs-params">context</span>) =&gt;</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LoginPage</span>(), <span class="hljs-comment">//æ³¨å†Œé¦–é¡µè·¯ç”±</span><br>          <span class="hljs-string">&quot;welcome&quot;</span>: <span class="hljs-function">(<span class="hljs-params">context</span>) =&gt;</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">WelcomePage</span>(),<br>        &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åå­—<code>welcome</code>æ¥åŠ è½½è¿™ä¸ªflutteræ¬¢è¿é¡µäº†ã€‚</p><p>ç¬¬ä¸€æ˜¯ç§ä¿®æ”¹<code>FlutterEngine</code>çš„<code>run</code>æ–¹æ³•ï¼›</p><p>ç¬¬äºŒæ˜¯ç§ä¿®æ”¹<code>FlutterViewController</code>çš„åˆå§‹åŒ–æ–¹æ³•ã€‚</p><p>äºŒè€…é€‰å…¶ä¸€å³å¯ï¼Œæ¯”å¦‚ï¼š</p><h6 id="3-1-ä¿®æ”¹FlutterEngine"><a href="#3-1-ä¿®æ”¹FlutterEngine" class="headerlink" title="3.1.ä¿®æ”¹FlutterEngine"></a>3.1.ä¿®æ”¹FlutterEngine</h6><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Swift"><span class="hljs-keyword">import</span> Flutter<br><span class="hljs-keyword">import</span> FlutterPluginRegistrant<br><br><span class="hljs-keyword">@UIApplicationMain</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">FlutterAppDelegate</span> &#123;<br>    <br>    <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">var</span> flutterEngine <span class="hljs-operator">=</span> <span class="hljs-type">FlutterEngine</span>(name: <span class="hljs-string">&quot;FlutterInSwift&quot;</span>)<br>   <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> &#123;<br>        <br>        <span class="hljs-comment">// ç»™Flutterå¼•æ“æŒ‡å®šè·¯ç”±å</span><br>        flutterEngine.run(withEntrypoint: <span class="hljs-string">&quot;main&quot;</span>, initialRoute: <span class="hljs-string">&quot;welcome&quot;</span>)<br>        <span class="hljs-comment">//è¿™é‡Œ&quot;main&quot;æ˜¯Dartä¸»å…¥å£ï¼Œ&quot;welcome&quot;æ˜¯flutteré¡µé¢å</span><br>        <span class="hljs-type">GeneratedPluginRegistrant</span>.register(with: flutterEngine)<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ä¿®æ”¹äº†FlutterEngineçš„<code>run</code>æ–¹æ³•ï¼Œ<code>FlutterViewController</code>å¤„ä¸åšä¿®æ”¹ã€‚</p><h6 id="3-2-ä¿®æ”¹FlutterViewController"><a href="#3-2-ä¿®æ”¹FlutterViewController" class="headerlink" title="3.2.ä¿®æ”¹FlutterViewController"></a>3.2.ä¿®æ”¹FlutterViewController</h6><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Swift"><span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleClick</span>()&#123;<br>    <span class="hljs-comment">//è·³è½¬Flutteré¡µé¢</span><br>    <span class="hljs-keyword">let</span> flutterController <span class="hljs-operator">=</span> <span class="hljs-type">FlutterViewController</span>(<br>            project: <span class="hljs-literal">nil</span>, initialRoute: <span class="hljs-string">&quot;welcome&quot;</span>, nibName: <span class="hljs-literal">nil</span>, bundle: <span class="hljs-literal">nil</span>)<br>    navigationController<span class="hljs-operator">?</span>.setNavigationBarHidden(<span class="hljs-literal">true</span>, animated: <span class="hljs-literal">true</span>)<br>    navigationController<span class="hljs-operator">?</span>.pushViewController(flutterController, animated: <span class="hljs-literal">true</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ç»™FlutterViewControlleræŒ‡å®šåŠ è½½åå­—ä¸º<code>welcome</code>çš„flutteré¡µé¢ã€‚AppDelegateçš„FlutterEngineå¤„ä¸ä½œä¿®æ”¹ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_flutterinios_welcome.gif" alt="flutteræ¬¢è¿é¡µ"></p><p>ä»¥ä¸Šå°±æ˜¯åœ¨iOSå·¥ç¨‹ä¸­é›†æˆflutteré¡µé¢çš„æ€è·¯æ€»ç»“ã€‚å®Œç»“æ’’èŠ±~</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Flutter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çƒ­é‡è½½æ··ç¼–ä¸­çš„flutteræ¨¡å—</title>
    <link href="/2023/03/29/flutter-hot-reload-in-native.html"/>
    <url>/2023/03/29/flutter-hot-reload-in-native.html</url>
    
    <content type="html"><![CDATA[<h4 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1.èƒŒæ™¯"></a>1.èƒŒæ™¯</h4><p><code>hot-reload</code>ï¼Œçƒ­é‡è½½ï¼Œå…è®¸å¼€å‘è€…åœ¨åº”ç”¨è¿è¡Œæ—¶æ›´æ”¹æºä»£ç ï¼Œå¹¶å®æ—¶è§‚çœ‹æ•ˆæœã€‚ç›®å‰<code>SwiftUI</code>ä¸<code>Flutter</code>éƒ½å…·å¤‡çƒ­é‡è½½çš„èƒ½åŠ›ï¼Œå¼€å‘é˜¶æ®µè°ƒè¯•UIçš„æ•ˆç‡æé«˜ã€‚åœ¨åŸç”ŸiOSåº”ç”¨ä¸­æ··ç¼–<code>flutter</code>æ¨¡å—æ—¶ï¼ŒåŸç”Ÿéƒ¨åˆ†(éSwiftUIçš„)åœ¨ä¿®æ”¹åè¿˜æ˜¯éœ€è¦é€šè¿‡é‡æ–°<code>Run</code>æ¥æŸ¥çœ‹æ•ˆæœï¼Œè€Œå…¶ä¸­çš„ flutter éƒ¨åˆ†åˆ™æ˜¯å¯ä»¥åŸºäº<code>flutter attach</code>å®ç°çƒ­é‡è½½çš„ï¼Œæœ¬æ–‡å°±ç®€å•çš„åšä¸€æ¬¡é…ç½®è®°å½•ã€‚</p><h4 id="2-é…ç½®Info-plist"><a href="#2-é…ç½®Info-plist" class="headerlink" title="2.é…ç½®Info.plist"></a>2.é…ç½®Info.plist</h4><p>On iOS 14 and higher, enable the Dart multicast DNS service in the Debug version of your app to addÂ <a href="https://docs.flutter.dev/development/add-to-app/debugging">debugging functionalities such as hot-reload and DevTools</a>Â viaÂ flutter attach.</p><p>é…ç½®æœ¬åœ°ç½‘ç»œä½¿ç”¨æƒé™ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;key&gt;NSBonjourServices&lt;/key&gt;<br>        &lt;array&gt;<br>            &lt;string&gt;_dartobservatory._tcp&lt;/string&gt;<br>        &lt;/array&gt;<br>    &lt;key&gt;NSLocalNetworkUsageDescription&lt;/key&gt;<br>    &lt;string&gt;éœ€è¦è®¿é—®æœ¬åœ°ç½‘ç»œæƒé™&lt;/string&gt;<br></code></pre></td></tr></table></figure><p>ä¸Šæ¶å‰é¡»åˆ æ‰ä»¥ä¸Šé…ç½®ï¼Œå¦åˆ™å®¡æ ¸ä¼šè¢«æ‹’ã€‚</p><p>ä¸ºæ–¹ä¾¿èµ·è§ï¼Œå¯é…ç½®ä¸¤ä»½<code>Info.plist</code>ï¼Œåªåœ¨å¼€å‘ç¯å¢ƒä¸­ä¿ç•™ä¸Šè¿°é…ç½®ã€‚</p><p><strong>é…ç½®æ­¥éª¤ï¼š</strong></p><ol><li><p>å¤åˆ¶Info.plistæ–‡ä»¶å¹¶åˆ†åˆ«é‡å‘½åä¸º<code>Info-dubug.plist</code>å’Œ<code>Info-release.plist</code>ï¼›</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_flutter_attach_2list.png" alt="å¤åˆ¶plist"></p></li><li><p>åœ¨<code>Info-dubug.plist</code>ä¸­åŠ å…¥ä¸Šè¿°é…ç½®ï¼Œ<code>Info-release.plist</code>ä¿æŒåŸæ ·ä¸å˜ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_flutter_attach_Info-dubug.png" alt="debugé…ç½®"></p></li><li><p><strong>TARGET-&gt;Build Settings</strong> ä¸­æœç´¢<code>INFOPLIST_FILE</code>ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_flutter_attach_infoplist.png" alt="åŒºåˆ†ç¯å¢ƒ"></p></li><li><p><strong>Build Settings -&gt; Build Phases -&gt; Copy BundleÂ Resources</strong>ä¸­ç§»é™¤å¤šä½™çš„plistèµ„æºï¼›</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_flutter_attach_copybundleres.png" alt="ç§»é™¤å¤šä½™plist"></p></li></ol><h4 id="3-RunåŸç”Ÿåº”ç”¨"><a href="#3-RunåŸç”Ÿåº”ç”¨" class="headerlink" title="3.RunåŸç”Ÿåº”ç”¨"></a>3.RunåŸç”Ÿåº”ç”¨</h4><p>è¿è¡ŒåŸç”Ÿåº”ç”¨å¹¶è·³è½¬åˆ° flutter æ‰€åœ¨æ¨¡å—ï¼Œä»¥ä¾¿åé¢è§‚çœ‹çƒ­é‡è½½åçš„æ•ˆæœã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_flutter_attach_reload_demo.png" alt="åŸç”Ÿä¸­çš„flutteræ¨¡å—"></p><h4 id="4-flutter-attach"><a href="#4-flutter-attach" class="headerlink" title="4.flutter attach"></a>4.flutter attach</h4><p>æ‰“å¼€ç»ˆç«¯ï¼Œcdåˆ°åŸç”Ÿé¡¹ç›®çš„flutteræ¨¡å—æ‰€åœ¨æ ¹ç›®å½•ï¼Œæˆ‘çš„æ˜¯<code>flutters</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">â”œâ”€â”€ Hello<br>â”‚Â Â  â”œâ”€â”€ Hello<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Assets.xcassets<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Base.lproj<br>â”‚Â Â  â”œâ”€â”€ Hello.xcodeproj<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ project.xcworkspace<br>â”‚Â Â  â”œâ”€â”€ Hello.xcworkspace<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ xcshareddata<br>â”‚Â Â  â”œâ”€â”€ Pods<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ RxSwift<br>â”‚Â Â  â””â”€â”€ flutters<br>â”‚Â Â      â”œâ”€â”€ build<br>â”‚Â Â      â”œâ”€â”€ lib<br>â”‚Â Â      â””â”€â”€ <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><p>åœ¨<code>Hello/flutters</code>ç›®å½•ä¸‹æ‰§è¡Œ<code>flutter attach</code>å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">% flutter attach<br><br>Syncing files to device 12...                                      36.2s<br><br>Flutter run key commands.<br>r Hot reload. ğŸ”¥ğŸ”¥ğŸ”¥<br>R Hot restart.<br>h List all available interactive commands.<br>d Detach (terminate <span class="hljs-string">&quot;flutter run&quot;</span> but leave application running).<br>c Clear the screen<br>q Quit (terminate the application on the device).<br><br>ğŸ’ª Running with sound null safety ğŸ’ª<br></code></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥ä¿®æ”¹ flutter æ¨¡å—ä¸­çš„ä»£ç äº†ï¼Œè®°å¾—ä¿å­˜ï¼›</p><p>ç¬¬ä¸€æ¬¡ä¿®æ”¹å®Œä¹‹åï¼Œç»ˆç«¯é‡Œè¾“å…¥<code>R</code> - Hot restart é¡µé¢æŸ¥çœ‹æ•ˆæœ;</p><p>ä¹‹åå†ä¿®æ”¹æ—¶ï¼Œè¾“å…¥<code>r</code> - Hot reload å³å¯æŸ¥çœ‹æ•ˆæœï¼›</p><h4 id="5-æ³¨æ„äº‹é¡¹ï¼š"><a href="#5-æ³¨æ„äº‹é¡¹ï¼š" class="headerlink" title="5.æ³¨æ„äº‹é¡¹ï¼š"></a>5.æ³¨æ„äº‹é¡¹ï¼š</h4><p>ç»æµ‹è¯•ï¼ŒAPPè¿è¡Œæ—¶ï¼Œç¬¬ä¸€æ¬¡ä¿®æ”¹å®Œflutteræ¨¡å—åï¼Œé¡»åœ¨ç»ˆç«¯è¾“å…¥<code>R</code>é‡å¯æ‰èƒ½æ­£å¸¸æŸ¥çœ‹ä¿®æ”¹æ•ˆæœï¼Œè¾“å…¥å°å†™çš„<code>r</code>æ—¶é¡µé¢ä¼šæŠ¥é”™ã€‚ç»è¿‡ç¬¬ä¸€æ¬¡çš„<code>R</code>é‡å¯ä¹‹åï¼Œå†ä¿®æ”¹flutteræ¨¡å—åï¼Œç›´æ¥<code>r</code>å°±èƒ½æ­£å¸¸çƒ­åŠ è½½äº†ã€‚</p><p>Runäº†åº”ç”¨å¹¶ä¸”æ‰§è¡Œ<code>flutter attach</code>ä¹‹åï¼Œå¦‚æœå…³é—­äº†åº”ç”¨ï¼Œåˆ™ç»ˆç«¯é‡Œä¼šæç¤ºâ€Lost connection to deviceâ€ï¼Œå¦‚æœå†æƒ³çœ‹flutteræ¨¡å—ä¿®æ”¹åçš„æ•ˆæœï¼Œåˆ™éœ€è¦é‡æ–°æ‰§è¡Œ<code>Run</code>-&gt;<code>flutter attach</code>-&gt;<code>R</code>-&gt;<code>r</code>è¿™ä¸€æµç¨‹ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://docs.flutter.dev/development/add-to-app/ios/project-setup#local-network-privacy-permissions">Â©Apple-Add Flutter to existing app</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Flutter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Dart-?ç©ºå®‰å…¨</title>
    <link href="/2022/09/05/dart-nullsafety.html"/>
    <url>/2022/09/05/dart-nullsafety.html</url>
    
    <content type="html"><![CDATA[<h4 id="1-ç©ºå®‰å…¨"><a href="#1-ç©ºå®‰å…¨" class="headerlink" title="1.ç©ºå®‰å…¨"></a>1.ç©ºå®‰å…¨</h4><p>æœ€è¿‘æ‰“å¼€å¾ˆæ—©ä¹‹å‰çš„Flutterå·¥ç¨‹ï¼Œå‘ç°å¤§é¢ç§¯æŠ¥é”™ï¼Œæ— æ³•è¿è¡Œã€‚çœ‹äº†ä¸‹æŠ¥é”™ä¿¡æ¯ï¼Œå¾ˆå¤šéƒ½æ˜¯è¯´å˜é‡ä¸èƒ½ä¸ºç©ºï¼Œæ„é€ å‡½æ•°ä¸­å‘½åå‚æ•°ä¸èƒ½ä¸ºç©ºã€‚ä¸€ç•ªæœç´¢ä¹‹åï¼Œå‘ç°æ˜¯Dart2.1.2å’ŒFlutter2.0ç‰ˆæœ¬å¼€å§‹æ¨å‡ºä¸€ä¸ªé‡å¤§æ›´æ–°ï¼šæ”¯æŒ<code>null safety</code>äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸Swiftä¸­<code>optional</code>ç±»ä¼¼çš„<code>ç©ºå®‰å…¨</code>ç‰¹æ€§ã€‚å®ƒæ˜¯ç¼–è¯‘é˜¶æ®µå¯¹å±æ€§ã€å‚æ•°ã€è¿”å›å€¼ç­‰å¯èƒ½ä¸ºç©º<code>null</code>çš„ç±»å‹çš„ç‰¹æ®Šå¤„ç†ã€‚</p><h4 id="2-ä½œç”¨"><a href="#2-ä½œç”¨" class="headerlink" title="2.ä½œç”¨"></a>2.ä½œç”¨</h4><p>åœ¨ç©ºå®‰å…¨æœºåˆ¶ä¸‹ï¼š</p><ul><li><strong>é»˜è®¤æ‰€æœ‰ç±»å‹éƒ½æ˜¯éç©ºçš„</strong>ï¼›</li><li>é™¤éä½ æ˜ç¡®æŒ‡å‡ºå˜é‡å¯ä»¥ä¸ºç©ºï¼Œå¦åˆ™å®ƒå°±ä¸èƒ½æ˜¯nullï¼›</li><li>ä¸€æ—¦éç©ºå˜é‡ä¸ºnullï¼Œç¼–è¯‘å™¨å³ä¼šæŠ¥é”™ï¼›</li></ul><p>ä¾‹å¦‚ï¼Œåœ¨æ²¡æœ‰ç©ºå®‰å…¨æœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å†™ä»£ç é€šå¸¸æ˜¯è¿™æ ·ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// æ²¡æœ‰ null safety æœºåˆ¶å‰ï¼š</span><br><span class="hljs-built_in">bool</span> is<span class="hljs-constructor">Empty(String <span class="hljs-params">string</span>)</span> =&gt; <span class="hljs-built_in">string</span>.length<span class="hljs-operator"> == </span><span class="hljs-number">0</span>;<br><br>main<span class="hljs-literal">()</span> &#123;<br>  is<span class="hljs-constructor">Empty(<span class="hljs-params">null</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åœ¨ç¼–è¯‘æ—¶ä¸ä¼šæŠ¥é”™ï¼Œä½†è¿è¡Œèµ·æ¥åå°±ä¼šåœ¨<code>string.length</code>å¤„æŠ¥é”™<code>NoSuchMethodError</code>ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ é€’ç»™<code>isEmpty()</code>æ–¹æ³•çš„æ˜¯ä¸ªnullï¼Œè€Œnullæ²¡æœ‰<code>length</code>æ–¹æ³•ã€‚</p><p>åœ¨æ”¯æŒç©ºå®‰å…¨ä¹‹åï¼Œç¼–è¯‘å™¨ä¼šåœ¨è°ƒç”¨<code>isEmpty(null)</code>æ—¶æ˜ç¡®å‘Šè¯‰ä½ <code>The argument type &#39;Null&#39; can&#39;t be assigned to the parameter type &#39;String&#39;</code>ï¼Œå³stringå‚æ•°å£°æ˜ä¸º<code>String</code>ç±»å‹ï¼Œä¸èƒ½æ¥æ”¶ä¸º<code>null</code>çš„å‚æ•°ã€‚è¿™æ ·åˆ©ç”¨ç©ºå®‰å…¨æœºåˆ¶ï¼Œæˆ‘ä»¬å°±èƒ½æå‰å‘ç°å¹¶æ”¹æ­£ä¼ å€¼ä¸º<code>null</code>çš„æƒ…å†µã€‚</p><h4 id="3-ç”¨æ³•"><a href="#3-ç”¨æ³•" class="headerlink" title="3.ç”¨æ³•"></a>3.ç”¨æ³•</h4><h5 id="3-1"><a href="#3-1" class="headerlink" title="3.1.?"></a>3.1.?</h5><p>ä¸Swiftä¸€æ ·ï¼Œå£°æ˜å˜é‡æ—¶ï¼Œå¦‚æœæ­¤å˜é‡å¯ä»¥ä¸ºç©ºï¼Œåœ¨ç±»å‹åé¢åŠ <code>?</code>å·ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-built_in">int</span> a = <span class="hljs-number">1</span>;<br><span class="hljs-built_in">int</span>? b = <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><p>åŒç†ï¼Œå‚æ•°æˆ–è¿”å›å€¼å¯ä»¥ä¸ºnullæ—¶ï¼Œä¹Ÿæ˜¯åœ¨ç±»å‹å‰åŠ <code>?</code>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NullableIdx</span>&#123;<br>  <br>  int? idxText;<br>  <br>  <span class="hljs-comment">//å·¥å‚æ–¹æ³•</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-title class_">NullableIdx</span>? <span class="hljs-title function_">setParam</span>(<span class="hljs-params">&#123;int? idxText&#125;</span>)&#123;<br>    <span class="hljs-keyword">if</span> (idxText == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">//å¯èƒ½è¿”å›ç©ºå¯¹è±¡</span><br>    &#125;<br>    <span class="hljs-title class_">NullableIdx</span> obj = <span class="hljs-title class_">NullableIdx</span>();<br>    obj.<span class="hljs-property">idxText</span> = idxText;<br>    <span class="hljs-keyword">return</span> obj;<br>  &#125;<br>  <br>  <span class="hljs-comment">//è¿”å›å€¼å¯èƒ½ä¸ºç©º</span><br>  int? <span class="hljs-title function_">retIdx</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (idxText == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">idxText</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-title class_">NullableIdx</span>? obj = <span class="hljs-title class_">NullableIdx</span>.<span class="hljs-title function_">setParam</span>(<span class="hljs-attr">idxText</span>:<span class="hljs-literal">null</span>);<br>  <span class="hljs-title function_">print</span>(<span class="hljs-string">&#x27;$&#123;obj?.retIdx()&#125;&#x27;</span>); <span class="hljs-comment">//è°ƒç”¨å¯ç©ºå¯¹è±¡çš„æ–¹æ³•æ—¶åŠ ?</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­è¿˜å±•ç¤ºäº†å¦ä¸€ä¸ªç”¨æ³•ï¼Œå³è°ƒç”¨å¯ç©ºå¯¹è±¡çš„æ–¹æ³•<code>obj?.retIdx()</code>æ—¶ï¼Œä¹Ÿéœ€è¦å¯¹è±¡ååŠ <code>?</code>ï¼Œä¸Swiftä¸­çš„å¯é€‰é“¾ç±»ä¼¼ã€‚</p><h5 id="3-2"><a href="#3-2" class="headerlink" title="3.2.!"></a>3.2.!</h5><p>å¦‚æœä½ ç¡®å®šä¸€ä¸ªå˜é‡ã€å‚æ•°æˆ–è¿”å›å€¼ä¸ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨<code>!</code>å–å…¶å€¼ï¼Œæœ‰ç‚¹ç±»ä¼¼Swiftä¸­å¯é€‰å€¼çš„å¼ºåˆ¶æ‹†åŒ…ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-built_in">int?</span> a = <span class="hljs-number">1</span>;<br><br><span class="hljs-built_in">int?</span> retIdx(<span class="hljs-built_in">String?</span> idxText) &#123;<br>  <span class="hljs-keyword">if</span> (idxText == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>.parse(idxText);<br>&#125;<br><br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$&#123;a!&#125;</span>&#x27;</span>);            <span class="hljs-comment">//å¼ºåˆ¶æ‹†åŒ…</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$&#123;retIdx(<span class="hljs-string">&#x27;5&#x27;</span>)!&#125;</span>&#x27;</span>);  <span class="hljs-comment">//å¼ºåˆ¶æ‹†åŒ…</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$&#123;retIdx(<span class="hljs-string">&#x27;xx&#x27;</span>)!&#125;</span>&#x27;</span>); <span class="hljs-comment">//é—ªé€€</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¢«<code>!</code>æ ‡è®°ä¸ºçš„å€¼å¦‚æœä¸º<code>null</code>ï¼Œåˆ™ä¼šç›´æ¥é—ªé€€ã€‚</p><h5 id="3-3-late"><a href="#3-3-late" class="headerlink" title="3.3.late"></a>3.3.late</h5><p>åœ¨å£°æ˜å˜é‡æ—¶ï¼Œå¦‚æœä½ ç¡®å®šå®ƒä¸èƒ½ä¸ºç©ºï¼Œä½†æ˜¯åˆä¸æƒ³åœ¨å£°æ˜æ—¶åˆå§‹åŒ–å®ƒï¼Œä½ å¯ä»¥å°†å…¶æ ‡æ³¨ä¸º<code>late</code>ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ï¼šâ€œç¨ååœ¨ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œæˆ‘ä¿è¯ä¼šå…ˆå°†å…¶åˆå§‹åŒ–â€ã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExtData</span> </span>&#123;<br>  <span class="hljs-built_in">int?</span> noSymptom;<br>  <span class="hljs-keyword">late</span> <span class="hljs-built_in">int</span> allNum;<br><br>  <span class="hljs-comment">// æ„é€ å‡½æ•°</span><br>  ExtData(&#123;<span class="hljs-keyword">this</span>.noSymptom&#125;)&#123;<br>    <span class="hljs-comment">//1.æ„é€ å‡½æ•°å†…åˆå§‹åŒ–lateå˜é‡</span><br>    allNum = <span class="hljs-number">2</span>; <span class="hljs-comment">// è¿™é‡Œä¸åˆå§‹åŒ–è¢«æ ‡è®°ä¸ºlateçš„allNumæ—¶ï¼Œè¿è¡Œæ—¶è®¿é—®æ­¤å˜é‡ä¼šé—ªé€€</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">void</span> main()&#123;<br>  ExtData data = ExtData();<br>  <span class="hljs-comment">//2.è®¿é—®lateå˜é‡ä¹‹å‰åˆå§‹åŒ–</span><br>  data.allNum = <span class="hljs-number">2</span>;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$&#123;data.allNum&#125;</span>&#x27;</span>); <span class="hljs-comment">//è®¿é—®lateå˜é‡</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œå¦‚æœä½ ä¸éµå®ˆè‡ªå·±çš„ä¿è¯ï¼Œåœ¨è®¿é—®<code>late</code>å˜é‡ä¹‹å‰æ²¡æœ‰å°†å…¶åˆå§‹åŒ–ï¼Œä¼šç›´æ¥é—ªé€€ã€‚</p><h5 id="3-4-required"><a href="#3-4-required" class="headerlink" title="3.4.required"></a>3.4.required</h5><p>æ„é€ å‡½æ•°ä¸­ï¼Œå¦‚æœå‘½åå‚æ•°å‚æ•°ä¸èƒ½ä¸ºç©ºï¼Œåˆ™ä½ å¯é€šè¿‡ä¸¤ç§æ–¹å¼æ˜¾ç¤ºçš„å‘Šè¯‰ç¼–è¯‘å™¨ï¼š</p><ul><li>åœ¨å‘½åå‚æ•°å‰åŠ <code>required</code>å…³é”®å­—ï¼›</li><li>ç»™å‚æ•°æä¾›ä¸€ä¸ªé»˜è®¤å€¼ï¼›</li></ul><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExtData</span> </span>&#123;<br>  <span class="hljs-built_in">int?</span> noSymptom;<br>  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> incrNoSymptom; <br>  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> defaultInt; <br><br>  <span class="hljs-comment">// æ„é€ å‡½æ•°</span><br>  ExtData(<span class="hljs-keyword">this</span>.noSymptom, <span class="hljs-comment">//æœªå‘½åå‚æ•°</span><br>         &#123;<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.incrNoSymptom, <span class="hljs-comment">//å‘½åå‚æ•°</span><br>         <span class="hljs-keyword">this</span>.defaultInt = <span class="hljs-number">2</span>&#125;); <span class="hljs-comment">//å‘½åå‚æ•° ç»™é»˜è®¤å€¼</span><br>&#125;<br><br><span class="hljs-keyword">void</span> main()&#123;<br>  ExtData data = ExtData(<span class="hljs-number">0</span>,incrNoSymptom:<span class="hljs-number">1</span>);<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$&#123;data.incrNoSymptom&#125;</span>,<span class="hljs-subst">$&#123;data.defaultInt&#125;</span>&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼š<code>required</code>åªèƒ½åŠ åœ¨å‡½æ•°å‘½åå‚æ•°çš„ç±»å‹ä¹‹å‰ã€‚</p><h5 id="3-4"><a href="#3-4" class="headerlink" title="3.4.??"></a>3.4.??</h5><p><code>??</code>æ˜¯ç©ºæˆ–è¿ç®—ç¬¦ï¼Œä¸Swiftä¸­çš„ä¸€æ ·ï¼Œè¡¨ç¤ºå¦‚æœå˜é‡ä¸ºç©ºï¼Œåˆ™ç»™å…¶ä¸€ä¸ªé»˜è®¤å€¼ã€‚</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-built_in">int</span>? a = <span class="hljs-literal">null</span>;<br><span class="hljs-built_in">int</span> b = a ?? <span class="hljs-number">1</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span>()</span> &#123;<br>  print(<span class="hljs-string">&#x27;$b&#x27;</span>); <span class="hljs-comment">//1</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-è¿ç§»åˆ°ç©ºå®‰å…¨"><a href="#4-è¿ç§»åˆ°ç©ºå®‰å…¨" class="headerlink" title="4.è¿ç§»åˆ°ç©ºå®‰å…¨"></a>4.è¿ç§»åˆ°ç©ºå®‰å…¨</h4><p>Dart2.1.2ä¹‹å‰çš„ä»£ç è¿ç§»åˆ°2.1.2ä¹‹åï¼Œé»˜è®¤ä½¿ç”¨<code>null safety</code>ç‰¹æ€§ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥å¾ˆå¤šé”™è¯¯ï¼Œå¾ˆå¤šéƒ½æ˜¯æç¤ºä½ å˜é‡æœªåˆå§‹åŒ–ï¼Œæˆ–è€…æ„é€ å‡½æ•°ä¸­å‘½åå‚æ•°ä¸èƒ½ä¸ºç©ºã€‚æ‰€ä»¥ï¼Œä½ éœ€è¦å°†ä»£ç è¿›è¡Œè¿ç§»ã€‚è¿ç§»æœ€å¥½æ˜¯æŒ‰ç…§é¡ºåºè¿›è¡Œï¼š</p><ol><li>å°†ä¾èµ–åº“å…ˆè¿ç§»åˆ°ç©ºå®‰å…¨ç‰ˆæœ¬ï¼›</li><li>å°†è‡ªå·±çš„ä»£ç è¿ç§»åˆ°ç©ºå®‰å…¨ç‰ˆï¼›</li><li>å¯¹è‡ªå·±çš„ä»£ç è¿›è¡Œé™æ€åˆ†æï¼›</li><li>æµ‹è¯•è¿ç§»åçš„ä»£ç å·²ç»ç”Ÿæ•ˆï¼›</li><li>å¦‚æœæ˜¯ä½ è‡ªå·±çš„packageï¼Œå‘å¸ƒæœ€æ–°ä»£ç åˆ°pub.devä¸Šï¼›</li></ol><h5 id="4-1-è¿ç§»ä¾èµ–åº“"><a href="#4-1-è¿ç§»ä¾èµ–åº“" class="headerlink" title="4.1.è¿ç§»ä¾èµ–åº“"></a>4.1.è¿ç§»ä¾èµ–åº“</h5><p>1.é¦–å…ˆç¡®è®¤æœ¬æœºDartç‰ˆæœ¬ï¼Œè‡³å°‘è¦æ›´æ–°åˆ°2.1.2ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">% dart <span class="hljs-comment">--version</span><br>Dart SDK <span class="hljs-built_in">version</span>: <span class="hljs-number">2.17</span><span class="hljs-number">.6</span><br></code></pre></td></tr></table></figure><p>2.CDåˆ°å·¥ç¨‹ç›®å½•ä¸‹ï¼ŒæŸ¥çœ‹ä¾èµ–åº“ç›®å‰æ˜¯å¦æ”¯æŒç©ºå®‰å…¨ã€‚</p><p>è¾“å‡ºç»“æœä¸­æ ‡è®°ä¸ºç»¿è‰²çš„å³ä¸ºæ”¯æŒ<code>null safety</code>çš„ç‰ˆæœ¬ã€‚(åšå®¢é‡Œçœ‹ä¸å‡ºæ¥é¢œè‰²ï¼Œéœ€è¦åˆ°ç»ˆç«¯é‡Œçœ‹~)</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs routeros">% dart pub outdated <span class="hljs-attribute">--mode</span>=<span class="hljs-literal">null</span>-safety<br>Showing dependencies that are currently <span class="hljs-keyword">not</span> opted <span class="hljs-keyword">in</span> <span class="hljs-keyword">to</span> null-safety.<br>[âœ—] indicates versions without <span class="hljs-literal">null</span> safety support.<br>[âœ“] indicates versions opting <span class="hljs-keyword">in</span> <span class="hljs-keyword">to</span> <span class="hljs-literal">null</span> safety.<br><br>Package Name            Current          Upgradable  Resolvable    Latest        <br><br>direct dependencies:   <br>amap_location_fluttify  âœ—0.12.0          âœ—0.12.0     âœ“0.22.0-rc.0  âœ“0.22.0-rc.0  <br>charts_flutter          âœ—0.9.0           âœ—0.9.0      âœ“0.12.0       âœ“0.12.0       <br>cupertino_icons         âœ—0.1.3           âœ—0.1.3      âœ“1.0.5        âœ“1.0.5        <br>dio                     âœ—3.0.9           âœ—3.0.10     âœ“4.0.6        âœ“4.0.6        <br>english_words           âœ—3.1.5           âœ—3.1.5      âœ“4.0.0        âœ“4.0.0        <br>http                    âœ—0.11.3+17       âœ—0.11.3+17  âœ“0.13.5       âœ“0.13.5       <br>path_provider           âœ—1.6.9           âœ—1.6.28     âœ“2.0.11       âœ“2.0.11       <br>permission_handler      âœ—5.0.0+hotfix.6  âœ—5.1.0+2    âœ“10.0.0       âœ“10.0.0       <br>pull_to_refresh         âœ—1.5.8           âœ—1.6.5      âœ“2.0.0        âœ“2.0.0        <br>sqflite                 âœ—1.3.0+1         âœ—1.3.2+4    âœ“2.0.3+1      âœ“2.0.3+1      <br>webview_flutter         âœ—0.3.22+1        âœ—0.3.24     âœ“3.0.4        âœ“3.0.4        <br><br>6 upgradable dependencies are locked (<span class="hljs-keyword">in</span> pubspec.lock) <span class="hljs-keyword">to</span> older versions.<br><span class="hljs-keyword">To</span> update these dependencies, use `dart pub upgrade`.<br><br>11  dependencies are constrained <span class="hljs-keyword">to</span> versions that are older than a resolvable version.<br><span class="hljs-keyword">To</span> update these dependencies, <span class="hljs-built_in">edit</span> pubspec.yaml, <span class="hljs-keyword">or</span> <span class="hljs-built_in">run</span> `dart pub<span class="hljs-built_in"> upgrade </span>--null-safety`.<br></code></pre></td></tr></table></figure><p>3.æ›´æ–°å„ä¾èµ–åº“çš„ç‰ˆæœ¬å·ï¼Œä»¥ä¾¿æ”¯æŒ<code>null safety</code>ï¼š</p><p>å‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œé¡¹ç›®é‡Œ<code>pubspec.yaml</code>æ–‡ä»¶ä¸­å„ä¾èµ–åº“çš„ç‰ˆæœ¬å·ä¼šè¢«è‡ªåŠ¨ä¿®æ”¹åˆ°æ”¯æŒ<code>null safety</code>ç‰ˆã€‚</p><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl"><span class="hljs-comment">% dart pub upgrade --null-safety</span><br></code></pre></td></tr></table></figure><p>4.æ›´æ–°ä¾èµ–åº“çš„ä»£ç ï¼š</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">% dart pub <span class="hljs-keyword">get</span><br></code></pre></td></tr></table></figure><p>5.æ›´æ–°å®Œæˆåï¼Œæ£€æŸ¥ä¸€ä¸‹ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">% dart pub outdated <span class="hljs-comment">--mode=null-safety</span><br>Showing dependencies that are currently <span class="hljs-keyword">not</span> opted <span class="hljs-keyword">in</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">null</span>-safety.<br>[âœ—] indicates versions <span class="hljs-keyword">without</span> <span class="hljs-keyword">null</span> safety support.<br>[âœ“] indicates versions opting <span class="hljs-keyword">in</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">null</span> safety.<br><br><span class="hljs-keyword">All</span> your dependencies <span class="hljs-keyword">declare</span> support <span class="hljs-keyword">for</span> <span class="hljs-keyword">null</span>-safety.<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæ‰€æœ‰çš„ä¾èµ–åº“å°±å…¨éƒ¨æ›´æ–°åˆ°<code>null safety</code>ç‰ˆæœ¬äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¿ç§»è‡ªå·±çš„ä»£ç äº†~</p><h5 id="4-2-è‡ªåŠ¨è¿ç§»ä»£ç "><a href="#4-2-è‡ªåŠ¨è¿ç§»ä»£ç " class="headerlink" title="4.2.è‡ªåŠ¨è¿ç§»ä»£ç "></a>4.2.è‡ªåŠ¨è¿ç§»ä»£ç </h5><p>Dartæä¾›äº†ä¸¤ç§æ–¹å¼è¿ç§»ä½ è‡ªå·±çš„ä»£ç ï¼š</p><ul><li>ä½¿ç”¨è¿ç§»å·¥å…·ï¼›</li><li>æ‰‹åŠ¨è¿ç§»ï¼›</li></ul><p>1.æ¨èä½¿ç”¨è¿ç§»å·¥å…·ï¼Œå®ƒä¼šå¸®ä½ æ£€æµ‹éœ€è¦è¿ç§»çš„ä»£ç ï¼Œå¹¶æä¾›è¿ç§»å»ºè®®ï¼Œä½ å¯ä»¥é€šè¿‡æ·»åŠ <code>hint markers</code>æ§åˆ¶è¿ç§»å·¥å…·çš„è½¬æ¢ã€‚</p><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl"><span class="hljs-comment">% dart migrate</span><br></code></pre></td></tr></table></figure><p>2.ä¸€è½®æŸ¥è¯¢ä¹‹åï¼ŒDartä¼šç”Ÿæˆä¸€ä¸ª<code>http://127.0.0.1</code>å¼€å¤´çš„é“¾æ¥ï¼š</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">% dart migrate<br>Migrating /Users/davidli/Desktop/flutter_demo<br><br>See https://dart.dev/go/<span class="hljs-keyword">null</span>-safety-migration <span class="hljs-keyword">for</span> a migration guide.<br><br>Analyzing project...<br>[<span class="hljs-comment">--------------------------------------------------------------------------------------------------------------------/]No analysis issues found.</span><br><br>Generating migration suggestions...<br>[<span class="hljs-comment">---------------------------------------------------------------------------------------------------------------------]</span><br><br>Compiling instrumentation information...<br>[<span class="hljs-comment">---------------------------------------------------------------------------------------------------------------------]</span><br><br><span class="hljs-keyword">View</span> the migration suggestions by visiting:<br><br>  http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">57135</span>/Users/davidli/Desktop/flutter_demo?authToken=LV4lkFuY10w%<span class="hljs-number">3</span>D<br><br><span class="hljs-keyword">Use</span> this interactive web <span class="hljs-keyword">view</span> <span class="hljs-keyword">to</span> review, improve, <span class="hljs-keyword">or</span> apply the results.<br><span class="hljs-keyword">When</span> finished <span class="hljs-keyword">with</span> the preview, hit ctrl-c <span class="hljs-keyword">to</span> terminate this <span class="hljs-keyword">process</span>.<br><br><span class="hljs-keyword">If</span> you make edits outside <span class="hljs-keyword">of</span> the web <span class="hljs-keyword">view</span> (<span class="hljs-keyword">in</span> your IDE), <span class="hljs-keyword">use</span> the <span class="hljs-symbol">&#x27;Rerun</span> from<br>sources&#x27; action.<br></code></pre></td></tr></table></figure><p>3.ç”¨Chromeæ‰“å¼€è¿™ä¸ªé“¾æ¥ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_dart_tools.jpg" alt="è¿ç§»å·¥å…·-Chrome"></p><p>è“è‰²æ ‡æ³¨çš„åœ°æ–¹ï¼Œå°±æ˜¯è¿ç§»å·¥å…·æ¨èçš„å†™æ³•ã€‚ç‚¹å‡»å…¶ä¸­æŸä¸€ä¸ªï¼Œå³è¾¹<code>Edit Details</code>é¢æ¿ä¸­ä¼šæ˜¾ç¤ºè¿™ä¹ˆæ”¹çš„ç†ç”±ã€‚</p><p>4.ç‚¹å‡»å³ä¸Šè§’çš„<code>APPLY MIGRATION</code>å³å¯å°†ä»£ç è¿ç§»åˆ°ç©ºå®‰å…¨ç‰ˆæœ¬ã€‚åŒæ—¶ï¼Œ<code>pubspec.yaml</code>é…ç½®æ–‡ä»¶ä¸­Dartçš„ç‰ˆæœ¬å·ä¹Ÿä¼šç›¸åº”çš„è¢«è‡ªåŠ¨ä¿®æ”¹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">environment</span>:<br>  <span class="hljs-attribute">sdk</span>: &#x27;&gt;=<span class="hljs-number">2</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span> &lt;<span class="hljs-number">3</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>&#x27;<br></code></pre></td></tr></table></figure><p>5.åšä¸€æ¬¡é™æ€åˆ†æï¼Œæ£€æŸ¥ä»£ç æ˜¯å¦æœ‰é—®é¢˜ï¼š</p><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl"><span class="hljs-comment">% dart analyze</span><br></code></pre></td></tr></table></figure><p>6.æœ€åæµ‹è¯•ä¸€ä¸‹ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">% </span><span class="language-bash">dart <span class="hljs-built_in">test</span></span><br></code></pre></td></tr></table></figure><h5 id="4-3-æ‰‹åŠ¨è¿ç§»ä»£ç "><a href="#4-3-æ‰‹åŠ¨è¿ç§»ä»£ç " class="headerlink" title="4.3.æ‰‹åŠ¨è¿ç§»ä»£ç "></a>4.3.æ‰‹åŠ¨è¿ç§»ä»£ç </h5><p>æ‰‹åŠ¨è¿ç§»ä»£ç æœ€å¥½ä»æœªä¾èµ–å…¶ä»–åº“çš„ä»£ç å…ˆå…¥æ‰‹ï¼Œå†è¿ç§»å…¶ä»–ä»£ç ï¼Œå¤§è‡´é¡ºåºå¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_null_miragate.jpg" alt="ç©ºå®‰å…¨-ä¾èµ–è¿ç§»é¡ºåº"></p><p>å…·ä½“è¿ç§»æ­¥éª¤ï¼š</p><p>1.ä¿®æ”¹<code>pubspec.yaml</code>æ–‡ä»¶ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">environment</span>:<br>  <span class="hljs-attribute">sdk</span>: &#x27;&gt;=<span class="hljs-number">2</span>.<span class="hljs-number">12</span>.<span class="hljs-number">0</span> &lt;<span class="hljs-number">3</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>&#x27;<br></code></pre></td></tr></table></figure><p>2.æ›´æ–°ä¾èµ–åº“ï¼Œå‚è€ƒä¸Šé¢<code>4.1.è¿ç§»ä¾èµ–åº“</code>ç« èŠ‚ã€‚</p><p>3.æ‰“å¼€ä½ çš„å·¥ç¨‹ï¼Œä¼šå‡ºç°å¤§æ‰¹ç¼–è¯‘é”™è¯¯ï¼Œæ…¢æ…¢æŒ‰ç…§<code>null safety</code>çš„è§„åˆ™ï¼Œä¿®æ”¹ç›¸åº”çš„ä»£ç ï¼Œå¦‚åŠ <code>?</code>ã€<code>!</code>ã€<code>required</code>ç­‰ã€‚</p><p>4.æ‰§è¡Œé™æ€åˆ†æï¼š</p><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl"><span class="hljs-comment">% dart analyze</span><br></code></pre></td></tr></table></figure><p>5.æœ€åæµ‹è¯•ä¸€ä¸‹ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">% </span><span class="language-bash">dart <span class="hljs-built_in">test</span></span><br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<code>null safety</code>çš„ä»£ç è¿ç§»å°±å®Œæˆäº†ã€‚æ ¹æ®Dartå®˜ç½‘çš„è¯´æ³•ï¼Œæ•´ä¸ªå·¥ç¨‹å’Œä¾èµ–åº“å®Œå…¨ä½¿ç”¨<code>ç©ºå®‰å…¨</code>åï¼ŒåŒ…ä½“ä¼šå˜å°ï¼Œè¿è¡Œé€Ÿåº¦ä¹Ÿä¼šå¾—åˆ°æé«˜ã€‚æ¥ç»™ä½ çš„é¡¹ç›®åšä¸ªè¿ç§»å§~</p><hr>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Flutter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Dartè¯­è¨€å…¥é—¨</title>
    <link href="/2022/01/09/dart.html"/>
    <url>/2022/01/09/dart.html</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-ç®€ä»‹"><a href="#ä¸€-ç®€ä»‹" class="headerlink" title="ä¸€.ç®€ä»‹"></a>ä¸€.ç®€ä»‹</h3><blockquote><p>Dart is a client-optimized language for fast apps on any platform.</p></blockquote><p><code>Dart</code>æ˜¯è°·æ­Œå¼€å‘çš„è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ï¼Œå¯ç”¨äºç§»åŠ¨åº”ç”¨ã€ç½‘é¡µã€æœåŠ¡å™¨ç­‰é¢†åŸŸã€‚å®ƒæ˜¯ä¸€é—¨é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œä¹Ÿæ˜¯å¼ºç±»å‹çš„ã€ç±»å®šä¹‰çš„ã€å•ç»§æ‰¿çš„è¯­è¨€ï¼Œæ”¯æŒæ¥å£ã€æ··å…¥(Mixins)ã€æŠ½è±¡ç±»ã€æ³›å‹ã€å¯é€‰ç±»å‹ç­‰ã€‚å®ƒèåˆäº†è®¸å¤šç°ä»£ç¼–ç¨‹è¯­è¨€çš„ä¼˜ç§€ç‰¹æ€§ï¼Œä»ä¸­èƒ½çœ‹åˆ°JavaScriptã€Swiftç­‰çš„å½±å­ã€‚</p><h3 id="äºŒ-è¯­æ³•ã€ç‰¹æ€§"><a href="#äºŒ-è¯­æ³•ã€ç‰¹æ€§" class="headerlink" title="äºŒ.è¯­æ³•ã€ç‰¹æ€§"></a>äºŒ.è¯­æ³•ã€ç‰¹æ€§</h3><p>æœ¬ç¯‡ä¸»è¦ç”¨äºè®°å½•æ¥è§¦<code>Dart</code>ä»¥æ¥æˆ‘ä¸ªäººæ¯”è¾ƒæ„Ÿå…´è¶£çš„ä¸€äº›ç‰¹æ€§å’Œè¯­æ³•ï¼Œéƒ¨åˆ†å†…å®¹ä¼šä¸Swiftåšæ¯”è¾ƒï¼Œä»¥ä¾¿æ›´å¥½çš„ç†è§£å…¶è¯­æ³•ç‰¹æ€§ã€‚Dartæä¾›äº†ä¸€ä¸ªåŸºäºæµè§ˆå™¨çš„<a href="https://dartpad.cn/">DartPad</a>å·¥å…·ä»¥ä¾¿è°ƒè¯•ä»£ç ï¼Œæœ¬æ–‡æ‰€æœ‰ä»£ç å‡å¯åœ¨çº¿è°ƒè¯•ã€‚å¼€è®²~</p><h4 id="1-æ•°æ®ç±»å‹"><a href="#1-æ•°æ®ç±»å‹" class="headerlink" title="1.æ•°æ®ç±»å‹"></a>1.æ•°æ®ç±»å‹</h4><p>Dart è¯­è¨€æ”¯æŒä»¥ä¸‹å†…å»ºç±»å‹ï¼š</p><ul><li>num</li><li>String</li><li>Boolean</li><li>List</li><li>Map</li><li>Set</li><li>Runeï¼ˆè¡¨ç¤ºå­—ç¬¦ä¸²ä¸­çš„ UTF-32 ç¼–ç å­—ç¬¦ï¼‰</li><li>Symbolï¼ˆç¬¦å·ï¼Œå¦‚æ ¹å·âˆšï¿£ï¼‰</li></ul><p><code>num</code>è¡¨ç¤ºæ•°å€¼å‹ï¼ŒåŒ…æ‹¬æ•´å‹<code>int</code>å’Œæµ®ç‚¹å‹<code>double</code>ï¼Œæ²¡æœ‰<code>float</code>ã€‚å…¶ä¸­ int å¯è½¬ä¸º double ç±»å‹ï¼Œåä¹‹åˆ™ä¸è¡Œã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs abnf">void main() &#123;<br>  var a <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span><span class="hljs-comment">;</span><br>  a <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-comment">;</span><br>  <br>  num b <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-comment">; // ç›´æ¥ä½¿ç”¨num</span><br>  b <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span><span class="hljs-comment">;</span><br>  <br>  var c <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-comment">;</span><br>  c <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span><span class="hljs-comment">; //æŠ¥é”™ï¼šA value of type &#x27;double&#x27; can&#x27;t be assigned to a variable of type &#x27;int&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>num</code>ç±»å‹ä¸<code>String</code>ç±»å‹å¯ç›¸äº’è½¬æ¢ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-keyword">var</span> a = <span class="hljs-number">1.0</span>;<br>  a = <span class="hljs-built_in">double</span>.parse(<span class="hljs-string">&#x27;2.0&#x27;</span>); <span class="hljs-comment">//å­—ç¬¦è½¬æµ®ç‚¹</span><br>  <span class="hljs-built_in">print</span>(a);<br>  <span class="hljs-keyword">var</span> b = a.toString(); <span class="hljs-comment">//æµ®ç‚¹è½¬String</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;+++<span class="hljs-subst">$b</span>, type:<span class="hljs-subst">$&#123;b.runtimeType&#125;</span>&#x27;</span>); <span class="hljs-comment">//è¾“å‡ºâ€œ+++2, type:Stringâ€</span><br>  <br>  <span class="hljs-built_in">int</span> c;<br>  c = <span class="hljs-built_in">int</span>.parse(<span class="hljs-string">&quot;3&quot;</span>);<br>  <span class="hljs-keyword">var</span> d = c.toString();<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;+++c:<span class="hljs-subst">$c</span>,d:<span class="hljs-subst">$d</span>, type:<span class="hljs-subst">$&#123;d.runtimeType&#125;</span>&#x27;</span>); <span class="hljs-comment">//è¾“å‡º&quot;+++c:3,d:3, type:String&quot;</span><br><br>  <span class="hljs-built_in">num</span> e = <span class="hljs-number">4</span>;<br>  <span class="hljs-keyword">final</span> f = e.toString();  <span class="hljs-comment">//numè½¬å­—ç¬¦</span><br>  e = <span class="hljs-built_in">double</span>.parse(<span class="hljs-string">&#x27;5.0&#x27;</span>); <span class="hljs-comment">//å­—ç¬¦è½¬num</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;+++f:<span class="hljs-subst">$f</span>,e:<span class="hljs-subst">$e</span>&#x27;</span>); <span class="hljs-comment">//è¾“å‡º&quot;+++f:4,e:5&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Dart ä¸­çš„é›†åˆä¸ Swift ç›¸ä¼¼ï¼Œå…·å¤‡<code>è‡ªåŠ¨æ¨æ–­ç±»å‹</code>çš„èƒ½åŠ›ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>æ•°ç»„<br>var list = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>assert(list.length == <span class="hljs-number">3</span>);<br>assert(list[<span class="hljs-number">1</span>] == <span class="hljs-number">2</span>);<br><span class="hljs-regexp">//</span>è¿™é‡Œ Dart ä¼šæ¨æ–­ list çš„ç±»å‹ä¸º List&lt;int&gt; ã€‚ <br><span class="hljs-regexp">//</span>å¦‚æœå°†éæ•´æ•°å¯¹è±¡æ·»åŠ åˆ°æ­¤ List ä¸­ï¼Œ åˆ™ä¼šæŠ¥é”™ã€‚<br>list[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>assert(list[<span class="hljs-number">1</span>] == <span class="hljs-number">1</span>);<br><br><br><span class="hljs-regexp">//</span>å­—å…¸<br><span class="hljs-regexp">//</span>keyå¯ä»¥æ˜¯ä»»ä½•ç±»å‹-ä¸Swiftç±»ä¼¼<br>var gifts = &#123;<br>  <span class="hljs-regexp">//</span> Key:    Value<br>  <span class="hljs-string">&#x27;first&#x27;</span>: <span class="hljs-string">&#x27;partridge&#x27;</span>,<br>  <span class="hljs-string">&#x27;second&#x27;</span>: <span class="hljs-string">&#x27;turtledoves&#x27;</span>,<br>  <span class="hljs-string">&#x27;fifth&#x27;</span>: <span class="hljs-string">&#x27;golden rings&#x27;</span><br>&#125;; <span class="hljs-regexp">//gi</span>fts çš„ç±»å‹ä¼šè¢«æ¨æ–­ä¸º Map&lt;String, String&gt;<br><br>var nobleGases = &#123;<br>  <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;helium&#x27;</span>,<br>  <span class="hljs-number">10</span>: <span class="hljs-string">&#x27;neon&#x27;</span>,<br>  <span class="hljs-number">18</span>: <span class="hljs-string">&#x27;argon&#x27;</span>,<br>&#125;; <span class="hljs-regexp">//</span>nobleGases çš„ç±»å‹æ¨æ–­ä¸º Map&lt;int, String&gt;<br></code></pre></td></tr></table></figure><h4 id="2-ä¸‡ç‰©çš†å¯¹è±¡"><a href="#2-ä¸‡ç‰©çš†å¯¹è±¡" class="headerlink" title="2.ä¸‡ç‰©çš†å¯¹è±¡"></a>2.ä¸‡ç‰©çš†å¯¹è±¡</h4><p>Dartä¸­ä¸‡ç‰©çš†å¯¹è±¡ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿è‡ª<code>Object</code>ç±»ï¼Œæ— è®ºæ˜¯æ•°å­—ï¼Œå‡½æ•°è¿˜æ˜¯ null éƒ½æ˜¯å¯¹è±¡ã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">enum</span> Color &#123;<br>  red,<br>  green,<br>  blue<br>&#125;<br><br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">print</span>(a <span class="hljs-keyword">is</span> <span class="hljs-built_in">Object</span>); <span class="hljs-comment">//true</span><br>  <br>  a = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$&#123;a.runtimeType&#125;</span>, <span class="hljs-subst">$&#123;a <span class="hljs-keyword">is</span> Object&#125;</span>&#x27;</span>); <span class="hljs-comment">//Null, true</span><br>  <br>  <span class="hljs-keyword">var</span> x = Color.blue;<br>  <span class="hljs-built_in">print</span>(x <span class="hljs-keyword">is</span> <span class="hljs-built_in">Object</span>); <span class="hljs-comment">//true</span><br><br>  <span class="hljs-comment">//æœªåˆå§‹åŒ–æ—¶é»˜è®¤å€¼æ˜¯null</span><br>  <span class="hljs-built_in">int</span> aInt;<br>  <span class="hljs-built_in">print</span>(aInt); <span class="hljs-comment">//null</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-åŠ¨æ€ç±»å‹"><a href="#3-åŠ¨æ€ç±»å‹" class="headerlink" title="3.åŠ¨æ€ç±»å‹"></a>3.åŠ¨æ€ç±»å‹</h4><p>ä¸€èˆ¬å£°æ˜å˜é‡æ—¶éƒ½ä¼šæ˜ç¡®ç”³æ˜å˜é‡çš„ç±»å‹ï¼Œæˆ–è€…é€šè¿‡<code>ç±»å‹æ¨æ–­</code>æ¥è‡ªåŠ¨è¯†åˆ«å˜é‡çš„ç±»å‹ï¼š</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-keyword">int</span> a = <span class="hljs-number">1</span>; <span class="hljs-regexp">//</span>æŒ‡å®šä¸º<span class="hljs-keyword">int</span><br>var b = <span class="hljs-number">2</span>; <span class="hljs-regexp">//</span>æ¨æ–­ä¸º<span class="hljs-keyword">int</span><br></code></pre></td></tr></table></figure><p>ä½†å¦‚æœå¯¹è±¡ä¸é™å®šä¸ºå•ä¸ªç±»å‹ï¼Œæˆ–è€…æš‚æ—¶ä¸çŸ¥é“æ˜¯ä»€ä¹ˆç±»å‹ï¼Œåˆ™å¯ä»¥æŒ‡å®šä¸º<code>å¯¹è±¡ç±»å‹</code>æˆ–<code>åŠ¨æ€ç±»å‹</code>ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">enum</span> Color &#123;<br>  red,<br>  green,<br>  blue<br>&#125;<br><br><span class="hljs-keyword">void</span> main() &#123;<br>  <br>  <span class="hljs-comment">//æŒ‡å®šä¸ºObjectï¼Œç±»ä¼¼äºSwiftä¸­çš„Anyæˆ–è€…OCä¸­çš„id</span><br>  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">Object</span>&gt; arr;<br>  arr = [<span class="hljs-number">1</span>,<span class="hljs-string">&quot;x&quot;</span>,Color.red];<br>  <span class="hljs-keyword">var</span> x = arr[<span class="hljs-number">2</span>];<br>  <br>  <span class="hljs-keyword">if</span> (x <span class="hljs-keyword">is</span> <span class="hljs-built_in">int</span>)&#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$x</span> is int&#x27;</span>);<br>  &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x <span class="hljs-keyword">is</span> <span class="hljs-built_in">String</span>) &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$x</span> is String&#x27;</span>);<br>  &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x <span class="hljs-keyword">is</span> Color) &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$x</span> is enum&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// åŠ¨æ€ç±»å‹</span><br>  <span class="hljs-built_in">dynamic</span> name = <span class="hljs-string">&#x27;Bob&#x27;</span>;<br>  name = <span class="hljs-number">1</span>; <span class="hljs-comment">// å¯ä»¥æ›´æ”¹ç±»å‹</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;name is:<span class="hljs-subst">$name</span>&#x27;</span>); <span class="hljs-comment">//è¾“å‡ºâ€name is:1â€œ</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-ç¼–è¯‘æ—¶å¸¸é‡"><a href="#4-ç¼–è¯‘æ—¶å¸¸é‡" class="headerlink" title="4.ç¼–è¯‘æ—¶å¸¸é‡"></a>4.ç¼–è¯‘æ—¶å¸¸é‡</h4><p>Dartä¸­å£°æ˜å¸¸é‡æ—¶æœ‰ä¸¤ç§æ ‡è¯†ç¬¦<code>const</code>å’Œ<code>final</code>ã€‚</p><ul><li>constä¿®é¥°ç¼–è¯‘æ—¶å¸¸é‡ï¼›</li><li>finalå¯ä¿®é¥°ç¼–è¯‘æ—¶å¸¸é‡æˆ–è¿è¡Œæ—¶å¸¸é‡ï¼›</li></ul><p><code>ç¼–è¯‘æ—¶å¸¸é‡</code>æ˜¯æŒ‡å¸¸é‡çš„å€¼åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šï¼Œè€Œ<code>è¿è¡Œæ—¶å¸¸é‡</code>çš„å€¼åœ¨è¿è¡Œæ—¶æ‰ç¡®å®šï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs abnf">class A &#123;  <br>&#125;<br>void main() &#123;<br>  num a <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-comment">;</span><br>  final b <span class="hljs-operator">=</span> a.toString()<span class="hljs-comment">;</span><br>  const c <span class="hljs-operator">=</span> a.toString()<span class="hljs-comment">; //æŠ¥é”™ï¼šConst variables must be initialized with a constant value</span><br><br>  final c <span class="hljs-operator">=</span> A()<span class="hljs-comment">;</span><br>  const d <span class="hljs-operator">=</span> A()<span class="hljs-comment">; // æŠ¥é”™ï¼Œå› ä¸ºåˆ›å»ºAçš„å®ä¾‹æ—¶ä½¿ç”¨çš„æ„é€ å‡½æ•°åœ¨è¿è¡Œæ—¶æ‰æ‰§è¡Œã€‚</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é›†åˆçš„å¯å˜æ€§æ˜¯ç”±ã€å…¶æœ¬èº«çš„ä¿®é¥°ç¬¦ã€‘å’Œã€å…¶å­—é¢é‡çš„ä¿®é¥°ç¬¦ã€‘å…±åŒå†³å®šçš„ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> åŸºæœ¬ç±»å‹<br>final name = <span class="hljs-string">&#x27;Bob&#x27;</span>; <span class="hljs-regexp">//</span> Without a type annotation<br>final String nickname = <span class="hljs-string">&#x27;Bobby&#x27;</span>;<br>name = <span class="hljs-string">&#x27;Alice&#x27;</span>; <span class="hljs-regexp">//</span> Error: ä¸€ä¸ª final å˜é‡åªèƒ½è¢«è®¾ç½®ä¸€æ¬¡ã€‚<br><br><span class="hljs-regexp">//</span> é›†åˆ<br>var constantList = const [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br><span class="hljs-regexp">//</span> constantList[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>; <span class="hljs-regexp">//</span> å–æ¶ˆæ³¨é‡Šä¼šå¼•èµ·ç¼–è¯‘æ—¶å¼‚å¸¸ã€‚<br><br>const constantList2 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>constantList[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>; <span class="hljs-regexp">//</span> å–æ¶ˆæ³¨é‡Šä¼šå¼•èµ·ç¼–è¯‘æ—¶å¼‚å¸¸ã€‚<br><br>final constantList2 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>constantList2[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>; <span class="hljs-regexp">//</span> å–æ¶ˆæ³¨é‡Šä¸ä¼šå¼•èµ·é”™è¯¯ã€‚<br><br>var constantList3 = final [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-regexp">//</span>æŠ¥é”™<br></code></pre></td></tr></table></figure><p>å¯ä»¥è¿™ä¹ˆæ€»ç»“ï¼š</p><ul><li>finalä¸èƒ½ä¿®é¥°å­—é¢é‡ï¼›</li><li>constå¯å®šä¹‰ç¼–è¯‘æ—¶å¸¸é‡ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å®šä¹‰ä¸å¯å˜å­—é¢é‡ï¼›</li><li>finalå’Œconstå¸¸é‡éƒ½åªèƒ½èµ‹å€¼ä¸€æ¬¡ï¼›</li><li>finalé›†åˆå˜é‡ä¸èƒ½é‡æ–°èµ‹å€¼ï¼Œä½†é›†åˆå†…çš„å…ƒç´ å¯ä¿®æ”¹ï¼›</li><li>consté›†åˆæˆ–å­—é¢é‡ä¸èƒ½é‡æ–°èµ‹å€¼ï¼Œé›†åˆå†…å…ƒç´ ä¹Ÿä¸å¯ä¿®æ”¹ã€‚</li></ul><h4 id="5-å‡½æ•°-amp-å¯é€‰å‚æ•°"><a href="#5-å‡½æ•°-amp-å¯é€‰å‚æ•°" class="headerlink" title="5.å‡½æ•°&amp;å¯é€‰å‚æ•°"></a>5.å‡½æ•°&amp;å¯é€‰å‚æ•°</h4><ul><li>èƒ–ç®­å¤´è¯­æ³•</li></ul><p>å¦‚æœå‡½æ•°ä½“ä¸­åªæœ‰ä¸€ä¸ª<code>è¡¨è¾¾å¼</code>ï¼Œå¯ä»¥ä½¿ç”¨<code>=&gt; expr</code>ç®€å†™è¯­æ³•ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-comment">// ç¤ºä¾‹0ï¼šæ²¡è¿”å›å€¼çš„å‡½æ•°</span><br>add0(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b)&#123;<br>  a+b; <span class="hljs-comment">//è¡¨è¾¾å¼</span><br>&#125;<br><br><span class="hljs-comment">// ç¤ºä¾‹1ï¼šå¸¦è¿”å›å€¼çš„å‡½æ•°</span><br><span class="hljs-built_in">int</span> add1(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) &#123;<br>  <span class="hljs-keyword">return</span> a+b; <span class="hljs-comment">//è¿”å›å€¼</span><br>&#125;<br><br><span class="hljs-comment">// ç¤ºä¾‹2ï¼šadd1çš„=&gt;å†™æ³•</span><br><span class="hljs-built_in">int</span> add2(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) =&gt; a+b; <span class="hljs-comment">//=&gt;åä¸ºè¿”å›å€¼</span><br><br><span class="hljs-comment">// ç¤ºä¾‹3ï¼šadd1çš„=&gt;å†™æ³• æ³¨æ„å‡½æ•°å‰æ²¡å¸¦è¿”å›å€¼ç±»å‹&quot;int&quot;</span><br>add3(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) =&gt; a+b; <span class="hljs-comment">//=&gt;åä¸ºè¿”å›å€¼</span><br><br><span class="hljs-comment">// ç¤ºä¾‹4ï¼š&#123;&#125;å‡½æ•°ä½“å†…åªæœ‰ä¸€ä¸ªprintè¡¨è¾¾å¼</span><br>add4() =&gt; (()&#123;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++this is A block+++&quot;</span>);<br>&#125;);<br><br><span class="hljs-comment">// ç¤ºä¾‹4çš„èƒ–ç®­å¤´å†™æ³•ï¼Œ=&gt;åä¸ºprintè¡¨è¾¾å¼</span><br>add5() =&gt; (() =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++this is B block+++&quot;</span>));<br><br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-built_in">print</span>(add0(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)); <span class="hljs-comment">//null</span><br>  <span class="hljs-built_in">print</span>(add1(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)); <span class="hljs-comment">//1</span><br>  <span class="hljs-built_in">print</span>(add2(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)); <span class="hljs-comment">//1</span><br>  <span class="hljs-built_in">print</span>(add3(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)); <span class="hljs-comment">//1</span><br>  add4()();         <span class="hljs-comment">//++++this is A block+++</span><br>  add5()();         <span class="hljs-comment">//++++this is B block+++</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼š<code>add0</code>ä¸èƒ½æ”¹æˆèƒ–ç®­å¤´å†™æ³•ï¼Œå¦åˆ™<code>=&gt;</code>ä¼šæŠŠå…¶åçš„æ•°å€¼å˜æˆè¿”å›å€¼ï¼Œä»è€Œæ”¹å˜å‡½æ•°ç±»å‹ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼š<code>=&gt; expr</code> !&#x3D; <code>&#123;return expr;&#125;</code></p><p>åœ¨ç®­å¤´<code>=&gt;</code>å’Œåˆ†å·<code>;</code>ä¹‹é—´åªèƒ½ä½¿ç”¨ä¸€ä¸ªè¡¨è¾¾å¼ ï¼Œä¸èƒ½æ˜¯å¤šè¯­å¥ã€‚</p><ul><li>å‘½åå¯é€‰å‚æ•°</li></ul><p>å®šä¹‰å‡½æ•°æ—¶ï¼Œä½¿ç”¨èŠ±æ‹¬å· {param1, param2, â€¦} æ¥æŒ‡å®šå‘½åå‚æ•°ï¼›</p><ul><li>ä½ç½®å¯é€‰å‚æ•°</li></ul><p>å°†å‚æ•°æ”¾åˆ° [] ä¸­æ¥æ ‡è®°å‚æ•°æ˜¯å¯é€‰çš„ï¼›</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bird</span> </span>&#123;<br>  <span class="hljs-keyword">void</span> tweet(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b)&#123; <span class="hljs-comment">//æœªå‘½åå‚æ•°</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;tweet: JIO JIO JIO~&quot;</span>);<br>  &#125;<br>  <br>  <span class="hljs-built_in">int</span> tweet2(&#123;<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b, <span class="hljs-built_in">int</span> c&#125;)&#123; <span class="hljs-comment">//å‘½åå¯é€‰å‚æ•°ï¼Œè°ƒç”¨æ—¶ç±»ä¼¼äº swift çš„å¤–éƒ¨å‚æ•°</span><br>    <span class="hljs-keyword">if</span>(b <span class="hljs-keyword">is</span> <span class="hljs-built_in">Null</span>)&#123;<br>      b = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;tweet2: <span class="hljs-subst">$a</span> + <span class="hljs-subst">$b</span> + <span class="hljs-subst">$c</span> JIO JIO JIO~&quot;</span>);<br>    <span class="hljs-keyword">return</span> a+b;<br>  &#125;<br>  <br>  <span class="hljs-built_in">int</span> tweet3(<span class="hljs-built_in">int</span> a, [<span class="hljs-built_in">int</span> b, <span class="hljs-built_in">int</span> c])&#123; <span class="hljs-comment">//ä½ç½®å¯é€‰å‚æ•°</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;tweet3: b:<span class="hljs-subst">$b</span>,c:<span class="hljs-subst">$c</span>&#x27;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-keyword">var</span> b = Bird();<br>  b.tweet(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);      <span class="hljs-comment">// è¾“å‡ºï¼štweet: JIO JIO JIO~</span><br>  b.tweet2(a:<span class="hljs-number">1</span>, b:<span class="hljs-number">2</span>); <span class="hljs-comment">// è¾“å‡ºï¼štweet2: 1 + 2 + null JIO JIO JIO~</span><br>  b.tweet2(a:<span class="hljs-number">1</span>);      <span class="hljs-comment">// è¾“å‡ºï¼štweet2: 1 + 0 + null JIO JIO JIO~</span><br>  b.tweet3(<span class="hljs-number">1</span>);        <span class="hljs-comment">// è¾“å‡ºï¼štweet3: b:null,c:null</span><br>  b.tweet3(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);     <span class="hljs-comment">// è¾“å‡ºï¼štweet3: b:2,c:null</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªå‚æ•°åªèƒ½é€‰æ‹©ã€å‘½åå¯é€‰å‚æ•°ã€‘å’Œã€ä½ç½®å¯é€‰å‚æ•°ã€‘å…¶ä¸­ä¸€ç§æ–¹å¼ä¿®é¥°ã€‚</p><ul><li>é»˜è®¤å‚æ•°å€¼</li></ul><p>å’ŒSwiftä¸€æ ·ï¼Œå®šä¹‰æ–¹æ³•æ—¶ä½¿ç”¨ &#x3D; æ¥å®šä¹‰å¯é€‰å‚æ•°çš„é»˜è®¤å€¼ï¼Œé»˜è®¤å€¼åªèƒ½æ˜¯ç¼–è¯‘æ—¶å¸¸é‡ã€‚</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> a, [<span class="hljs-built_in">int</span> b = <span class="hljs-number">0</span>]</span>)</span> =&gt; a+b;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span>()</span> &#123;<br>  print(<span class="hljs-keyword">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// è¾“å‡º3</span><br>  print(<span class="hljs-keyword">add</span>(<span class="hljs-number">1</span>));    <span class="hljs-comment">// è¾“å‡º1</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="6-å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘"><a href="#6-å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘" class="headerlink" title="6.å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘"></a>6.å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘</h4><p>ä¸Swiftä¸€æ ·ï¼ŒDartä¸­å‡½æ•°ä¹Ÿæ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªå‡½æ•°å¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ã€‚ç¤ºä¾‹1ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">printElement</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> element</span>)</span> &#123;<br>  print(element);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span>()</span> &#123;<br>  <span class="hljs-keyword">var</span> list = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br>  <span class="hljs-comment">// å°† printElement å‡½æ•°åä½œä¸ºå‚æ•°ä¼ é€’</span><br>  list.forEach(printElement);<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·å¯ä»¥å°†ä¸€ä¸ªå‡½æ•°èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">String</span> <span class="hljs-title function_">printElement</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> element</span>) &#123;<br>  <span class="hljs-keyword">var</span> x = <span class="hljs-string">&#x27;$element&#x27;</span>.<span class="hljs-title function_">toUpperCase</span>();<br>  <span class="hljs-title function_">print</span>(x);<br>  <span class="hljs-keyword">return</span> x;<br>&#125;<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">var</span> loudify = printElement;<br>  <span class="hljs-title function_">print</span>(<span class="hljs-title function_">loudify</span>(<span class="hljs-string">&#x27;hello&#x27;</span>) == <span class="hljs-string">&#x27;HELLO&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼ŒDartä¸­å‡½æ•°ä½œä¸ºå‚æ•°æ—¶ï¼Œä¼šæœ‰ä¸ª<em><strong>å°å›°æ‰°</strong></em>ï¼Œç¤ºä¾‹2ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// å®šä¹‰æ–¹æ³•</span><br><span class="hljs-built_in">int</span> math<span class="hljs-constructor">Add(<span class="hljs-params">int</span> <span class="hljs-params">a</span>, <span class="hljs-params">int</span> <span class="hljs-params">b</span>)</span> &#123;      <span class="hljs-comment">//ç›¸åŠ </span><br>  return a + b;<br>&#125;<br><span class="hljs-built_in">int</span> math<span class="hljs-constructor">Multiple(<span class="hljs-params">int</span> <span class="hljs-params">a</span>, <span class="hljs-params">int</span> <span class="hljs-params">b</span>)</span> &#123; <span class="hljs-comment">//ç›¸ä¹˜</span><br>  return a<span class="hljs-operator"> * </span>b;<br>&#125;<br><span class="hljs-built_in">int</span> math<span class="hljs-constructor">Increase(<span class="hljs-params">int</span> <span class="hljs-params">a</span>)</span> &#123;        <span class="hljs-comment">//è‡ªå¢1</span><br>  return ++a;<br>&#125;<br><span class="hljs-comment">// æ–¹æ³•ä½œä¸ºå‚æ•°</span><br><span class="hljs-built_in">int</span> math1(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b, Function mathOperation) &#123; <span class="hljs-comment">// æ¥æ”¶2ä¸ªå‚æ•°</span><br>  return math<span class="hljs-constructor">Operation(<span class="hljs-params">a</span>, <span class="hljs-params">b</span>)</span>; <span class="hljs-comment">//è°ƒç”¨å…·ä½“åšäº‹çš„å‡½æ•°</span><br>&#125;<br><span class="hljs-built_in">int</span> math2(<span class="hljs-built_in">int</span> a, Function mathOperation) &#123;        <span class="hljs-comment">//æ¥æ”¶1ä¸ªå‚æ•°</span><br>  return math<span class="hljs-constructor">Operation(<span class="hljs-params">a</span>)</span>;<br>&#125;<br><span class="hljs-comment">//è°ƒç”¨</span><br>main<span class="hljs-literal">()</span> &#123;<br>  <span class="hljs-comment">// å‘å¤–å±‚å‡½æ•°ä¼ é€’å†…å±‚å‡½æ•°ä½œä¸ºå‚æ•°æ—¶ï¼Œç›´æ¥ä½¿ç”¨å†…å±‚å‡½æ•°å</span><br>  print(math1(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, mathAdd));<br>  print(math1(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, mathMultiple));<br>  print(math2(<span class="hljs-number">1</span>, mathIncrease));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹2ä¸­ï¼Œå½“æ–¹æ³•ä½œä¸ºå‚æ•°ï¼ˆmathOperationï¼‰æ—¶ï¼ŒDartåªæ˜¯å°†mathOperationæ ‡æ³¨ä¸º<code>Function</code>ç±»å‹ï¼š</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">math1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, Function mathOperation)</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">mathOperation</span><span class="hljs-params">(a, b)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†ä»<code>Function</code>å…³é”®å­—ä¸Šå¹¶çœ‹ä¸å‡ºmathOperationä»£è¡¨çš„å‡½æ•°æœ‰å‡ ä¸ªå‚æ•°ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆç±»å‹ï¼Œè¿”å›å€¼æ˜¯å•¥ï¼Œè¿™æœ‰æ—¶å¾ˆå®¹æ˜“è®©äººå›°æƒ‘ã€‚ç›¸è¾ƒè€Œè¨€ï¼ŒSwiftä¸­å°†å‡½æ•°ä½œä¸ºå‚æ•°æ—¶ï¼Œä¼šæ˜ç¡®æ ‡æ˜æ­¤å‡½æ•°çš„ç±»å‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">// å®šä¹‰ä½œä¸ºå‚æ•°çš„å‡½æ•°</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">addTwoInts</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">a</span>: <span class="hljs-type">Int</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">b</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> &#123;<br>    <span class="hljs-keyword">return</span> a <span class="hljs-operator">+</span> b<br>&#125;<br><span class="hljs-comment">// å®šä¹‰ä½œä¸ºå‚æ•°çš„å‡½æ•°</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">multiplyTwoInts</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">a</span>: <span class="hljs-type">Int</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">b</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> &#123;<br>    <span class="hljs-keyword">return</span> a <span class="hljs-operator">*</span> b<br>&#125;<br><span class="hljs-comment">// å®šä¹‰ä½¿ç”¨å‡½æ•°ä½œä¸ºå‚æ•°çš„å‡½æ•°ï¼ˆæ˜ç¡®çŸ¥é“ä½œä¸ºå‚æ•°çš„å‡½æ•°æ˜¯ä»€ä¹ˆç±»å‹çš„ï¼‰</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">printMathResult</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">mathFunction</span>: (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">a</span>: <span class="hljs-type">Int</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">b</span>: <span class="hljs-type">Int</span>) &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Result: <span class="hljs-subst">\(mathFunction(a, b))</span>&quot;</span>)<br>&#125;<br><span class="hljs-comment">// è°ƒç”¨å¹¶ä¼ é€’å‡½æ•°ä½œä¸ºå‚æ•°</span><br>printMathResult(addTwoInts, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>) <span class="hljs-comment">// Prints &quot;Result: 8&quot;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œ<code>(Int, Int) -&gt; Int</code>å³æ˜ç¡®æŒ‡æ˜äº†<code>mathFunction</code>å‚æ•°çš„å‡½æ•°ç­¾åï¼Œæ¸…æ¥šæ˜äº†ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDartä¹Ÿæä¾›äº†è‡ªå·±çš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨<code>Typedefs</code>ä¸ºå‡½æ•°èµ·ä¸€ä¸ªåˆ«åï¼Œ åˆ«åå¯ä»¥ç”¨æ¥å£°æ˜å­—æ®µåŠè¿”å›å€¼ç±»å‹ã€‚ å½“å‡½æ•°ç±»å‹åˆ†é…ç»™å˜é‡æ—¶ï¼Œtypedefä¼šä¿ç•™ç±»å‹ä¿¡æ¯ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">typedef aliasType = <span class="hljs-built_in">int</span> <span class="hljs-constructor">Function(<span class="hljs-params">int</span> <span class="hljs-params">a</span>, <span class="hljs-params">int</span> <span class="hljs-params">b</span>)</span>; <span class="hljs-comment">//ç»™å‡½æ•°å®šä¹‰åˆ«å</span><br><br><span class="hljs-comment">// å®šä¹‰æ–¹æ³•</span><br><span class="hljs-built_in">int</span> math<span class="hljs-constructor">Add(<span class="hljs-params">int</span> <span class="hljs-params">a</span>, <span class="hljs-params">int</span> <span class="hljs-params">b</span>)</span> &#123;      <span class="hljs-comment">//ç›¸åŠ </span><br>  return a + b;<br>&#125;<br><span class="hljs-built_in">int</span> math<span class="hljs-constructor">Multiple(<span class="hljs-params">int</span> <span class="hljs-params">a</span>, <span class="hljs-params">int</span> <span class="hljs-params">b</span>)</span> &#123; <span class="hljs-comment">//ç›¸ä¹˜</span><br>  return a<span class="hljs-operator"> * </span>b;<br>&#125;<br><span class="hljs-comment">// æ–¹æ³•ä½œä¸ºå‚æ•°</span><br><span class="hljs-built_in">int</span> math1(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b, aliasType mathOperation) &#123; <span class="hljs-comment">//ä½¿ç”¨å‡½æ•°åˆ«å</span><br>  return math<span class="hljs-constructor">Operation(<span class="hljs-params">a</span>, <span class="hljs-params">b</span>)</span>; <span class="hljs-comment">//è°ƒç”¨å…·ä½“åšäº‹çš„å‡½æ•°</span><br>&#125;<br><br><span class="hljs-comment">//è°ƒç”¨</span><br>main<span class="hljs-literal">()</span> &#123;<br>  print(math1(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, mathAdd));<br>  print(math1(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, mathMultiple));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-é—­åŒ…"><a href="#7-é—­åŒ…" class="headerlink" title="7.é—­åŒ…"></a>7.é—­åŒ…</h4><p>å¤§éƒ¨åˆ†æ–¹æ³•éƒ½å¸¦æœ‰åå­—ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›å»ºæ²¡åå­—çš„æ–¹æ³•ï¼Œç§°ä¹‹ä¸º<code>åŒ¿åå‡½æ•°</code>æˆ–è€…<code>é—­åŒ…</code>ã€‚</p><p>åŒ¿åå‡½æ•°å’Œå‘½åå‡½æ•°çœ‹èµ·æ¥ç±»ä¼¼â€” åœ¨æ‹¬å·ä¹‹é—´å¯ä»¥å®šä¹‰ä¸€äº›å‚æ•°æˆ–å¯é€‰å‚æ•°ï¼Œå‚æ•°ä½¿ç”¨é€—å·åˆ†å‰²ã€‚</p><p>åé¢å¤§æ‹¬å·ä¸­çš„ä»£ç ä¸ºå‡½æ•°ä½“ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua">(<span class="hljs-string">[[Type] param1[, â€¦]]</span>) &#123; <br>  codeBlock; <br>&#125;; <br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹1ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-keyword">var</span> loudify = (msg) =&gt; <span class="hljs-string">&#x27;<span class="hljs-subst">$&#123;msg.toUpperCase()&#125;</span>&#x27;</span>; <span class="hljs-comment">// åŒ¿åå‡½æ•°/é—­åŒ…ï¼Œèµ‹å€¼ç»™å˜é‡</span><br>  <span class="hljs-built_in">print</span>(loudify(<span class="hljs-string">&#x27;hello&#x27;</span>) == <span class="hljs-string">&#x27;HELLO&#x27;</span>); <span class="hljs-comment">//è°ƒç”¨é—­åŒ…ï¼Œè¾“å‡ºtrue</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹2ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">var</span> list = [<span class="hljs-string">&#x27;apples&#x27;</span>, <span class="hljs-string">&#x27;bananas&#x27;</span>, <span class="hljs-string">&#x27;oranges&#x27;</span>];<br>list.forEach((item) &#123;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$&#123;list.indexOf(item)&#125;</span>: <span class="hljs-subst">$item</span>&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><h4 id="8-é“¾å¼-x2F-çº§è”"><a href="#8-é“¾å¼-x2F-çº§è”" class="headerlink" title="8.é“¾å¼&#x2F;çº§è”"></a>8.é“¾å¼&#x2F;çº§è”</h4><p>çº§è”è¿ç®—ç¬¦ <code>..</code>å¯ä»¥åƒRACä¸€æ ·ï¼Œå®ç°å¯¹åŒä¸€ä¸ªå¯¹åƒçš„ä¸€ç³»åˆ—é“¾å¼æ“ä½œã€‚ é™¤äº†è°ƒç”¨å‡½æ•°ï¼Œè¿˜å¯ä»¥è®¿é—®åŒä¸€å¯¹è±¡ä¸Šçš„å­—æ®µå±æ€§ã€‚ </p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-comment">// ä¸€èˆ¬æƒ…å†µä¸‹çš„æ“ä½œ</span><br>var <span class="hljs-keyword">button</span> = querySelector(<span class="hljs-string">&#x27;#confirm&#x27;</span>);<br><span class="hljs-keyword">button</span>.<span class="hljs-keyword">text</span> = <span class="hljs-string">&#x27;Confirm&#x27;</span>;<br><span class="hljs-keyword">button</span>.classes.add(<span class="hljs-string">&#x27;important&#x27;</span>);<br><span class="hljs-keyword">button</span>.onClick.listen((e) =&gt; <span class="hljs-keyword">window</span>.alert(<span class="hljs-string">&#x27;Confirmed!&#x27;</span>));<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨çº§è”æ“ä½œç¬¦ï¼š</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arcade">querySelector(<span class="hljs-string">&#x27;#confirm&#x27;</span>) <span class="hljs-comment">// è·å–å¯¹è±¡ã€‚</span><br>  ..<span class="hljs-built_in">text</span> = <span class="hljs-string">&#x27;Confirm&#x27;</span> <span class="hljs-comment">// è°ƒç”¨æˆå‘˜å˜é‡ã€‚</span><br>  ..classes.add(<span class="hljs-string">&#x27;important&#x27;</span>)<br>  ..onClick.listen(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> window.alert(<span class="hljs-string">&#x27;Confirmed!&#x27;</span>));<br></code></pre></td></tr></table></figure><h4 id="9-switchçš„å€¼"><a href="#9-switchçš„å€¼" class="headerlink" title="9.switchçš„å€¼"></a>9.switchçš„å€¼</h4><p><code>switch</code>å¯æ¯”è¾ƒæ•´æ•°ã€å­—ç¬¦ä¸²ã€æšä¸¾ã€‚æ¯”è¾ƒçš„å¯¹è±¡å¿…é¡»éƒ½æ˜¯åŒä¸€ä¸ªç±»çš„å®ä¾‹ä¸”ç±»æ²¡æœ‰é‡å†™<code>==</code>ã€‚ </p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-comment">// å®šä¹‰æšä¸¾</span><br><span class="hljs-built_in">enum</span> Color&#123;<br>  red,<br>  green,<br>  blue<br>&#125;<br><span class="hljs-comment">// æ¯”è¾ƒ</span><br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-built_in">var</span> a = Color.red;<br>  <span class="hljs-keyword">switch</span> (a)&#123;<br>    <span class="hljs-keyword">case</span> Color.red:<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;red&quot;</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> Color.green:<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;green&quot;</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> Color.blue:<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;blue&#x27;</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-literal">default</span>:<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;unknown&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">// è¯•é”™</span><br>  <span class="hljs-built_in">var</span> x = <span class="hljs-number">0.1</span>;<br>  <span class="hljs-keyword">switch</span> (x)&#123; <span class="hljs-comment">//æŠ¥é”™ The switch case expression type &#x27;double&#x27; can&#x27;t override the == operator</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0.0</span>:<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;0.0&#x27;</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0.1</span>:<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;0.1&#x27;</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-literal">default</span>:<br>      <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;default&#x27;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="10-å¯é€‰é“¾"><a href="#10-å¯é€‰é“¾" class="headerlink" title="10.å¯é€‰é“¾"></a>10.å¯é€‰é“¾</h4><p>ä¸Swiftä¸€æ ·ï¼Œè°ƒç”¨æ–¹æ³•æ—¶ä½¿ç”¨<code>?.</code>æ¥ä»£æ›¿<code>.</code>ï¼Œ å¯ä»¥é¿å…å› ä¸ºå·¦è¾¹å¯¹è±¡å¯èƒ½ä¸º null å¯¼è‡´çš„å¼‚å¸¸ï¼š</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">var</span> p = <span class="hljs-built_in">Point</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br><span class="hljs-comment">// å¦‚æœ p ä¸º non-nullï¼Œè®¾ç½®å®ƒå˜é‡ y çš„å€¼ä¸º 4ã€‚</span><br>p?.y = <span class="hljs-number">4</span>;<br></code></pre></td></tr></table></figure><h4 id="11-æ„é€ å‡½æ•°"><a href="#11-æ„é€ å‡½æ•°" class="headerlink" title="11.æ„é€ å‡½æ•°"></a>11.æ„é€ å‡½æ•°</h4><ul><li>æ„é€ å‡½æ•°</li></ul><p>åˆ›å»ºä¸€ä¸ªä¸ç±»åŒåçš„å‡½æ•°æ¥å£°æ˜æ„é€ å‡½æ•°ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span> </span>&#123;<br>  <span class="hljs-built_in">num</span> x, y, z;<br>  <br>  Point(<span class="hljs-built_in">num</span> x, <span class="hljs-built_in">num</span> y) &#123; <span class="hljs-comment">//æ„é€ å‡½æ•°</span><br>    <span class="hljs-keyword">this</span>.x = x;<br>    <span class="hljs-keyword">this</span>.y = y; <br>    <span class="hljs-comment">//ä¸è¦æ±‚æ‰€æœ‰æˆå‘˜å˜é‡éƒ½å®Œæˆåˆå§‹åŒ–</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;x:<span class="hljs-subst">$x</span>,y:<span class="hljs-subst">$y</span>,z:<span class="hljs-subst">$z</span>&#x27;</span>); <span class="hljs-comment">//x:0,y:1,z:null</span><br>  &#125;<br>&#125;<br><span class="hljs-comment">// åˆ›å»ºå®ä¾‹</span><br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-keyword">var</span> p = Point(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨è¯­æ³•ç³–å¯¹ä¸Šé¢çš„æ„é€ å‡½æ•°è¿›è¡Œç®€åŒ–ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span> &#123;<br>  num x, y, z;<br>  Point(<span class="hljs-keyword">this</span>.x, <span class="hljs-keyword">this</span>.y); <span class="hljs-comment">// å°†ä¼ å…¥çš„å‚æ•°çš„å€¼èµ‹å€¼ç»™å¯¹åº”çš„å®ä¾‹å˜é‡</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span>()</span> &#123;<br>  <span class="hljs-keyword">var</span> p = Point(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>é»˜è®¤æ„é€ å‡½æ•°</li></ul><p>åœ¨ã€æ²¡æœ‰å£°æ˜æ„é€ å‡½æ•°çš„æƒ…å†µä¸‹ã€‘ï¼Œ Dart ä¼šæä¾›ä¸€ä¸ªé»˜è®¤çš„æ„é€ å‡½æ•°ã€‚</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span> &#123;<br>  num x, y, z;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span>()</span> &#123;<br>  <span class="hljs-keyword">var</span> p = Point(); <span class="hljs-comment">//é»˜è®¤æ„é€ å‡½æ•°</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ã€å­ç±»ä¸ä¼šè‡ªåŠ¨ç»§æ‰¿çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‘ã€‚å¦‚æœå­ç±»ä¸å£°æ˜æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆå®ƒå°±åªæœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span> </span>&#123; <span class="hljs-comment">// çˆ¶ç±»</span><br>  num x, y;<br>  <span class="hljs-type">Point</span>(<span class="hljs-keyword">this</span>.x, <span class="hljs-keyword">this</span>.y); <span class="hljs-comment">//è‡ªå®šä¹‰æ„é€ å‡½æ•°</span><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubPoint</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Point</span> </span>&#123; <span class="hljs-comment">// å­ç±»</span><br>  num z;<br>  <span class="hljs-comment">// æ²¡æœ‰æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥åªæœ‰é»˜è®¤æ„é€ å‡½æ•°SubPoint()</span><br>&#125;<br>void main() &#123;<br>  <span class="hljs-keyword">var</span> p  = <span class="hljs-type">SubPoint</span>(<span class="hljs-number">1</span>ï¼Œ<span class="hljs-number">2</span>); <span class="hljs-comment">// æŠ¥é”™1ï¼Œå› ä¸ºå­ç±»ä¸ä¼šè‡ªåŠ¨ç»§æ‰¿çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨æ— æ•ˆ</span><br>  <span class="hljs-keyword">var</span> p2 = <span class="hljs-type">SubPoint</span>();    <span class="hljs-comment">// æŠ¥é”™2ï¼Œå› ä¸ºå­ç±»åªæœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œè€Œå­ç±»çš„é»˜è®¤æ„é€ å‡½æ•°ä¼šè°ƒç”¨çˆ¶ç±»çš„æ— å‚æ„é€ å‡½æ•°</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­ä¼šå‡ºç°ä¸¤å¤„æŠ¥é”™ï¼š</p><p>æŠ¥é”™1æ˜¯å› ä¸ºå­ç±»ä¸ä¼šè‡ªåŠ¨ç»§æ‰¿çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼›</p><p>æŠ¥é”™2æ˜¯å› ä¸º<em><strong>å­ç±»çš„é»˜è®¤æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨è°ƒç”¨çˆ¶ç±»çš„æ— å‚æ„é€ å‡½æ•°</strong></em>ï¼Œè€Œæ­¤æ—¶çˆ¶ç±»ä¸­å› ä¸ºæä¾›äº†è‡ªå®šä¹‰æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥å°±æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°ï¼Œå› æ­¤è°ƒç”¨å¤±è´¥ï¼Œæ‰€ä»¥å­ç±»æƒ³è¦è°ƒç”¨é»˜è®¤æ„é€ å‚æ•°ã€‚çˆ¶ç±»å°±ä¸èƒ½è‡ªå®šä¹‰æ„é€ å‡½æ•°ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span> </span>&#123; <span class="hljs-comment">// çˆ¶ç±»</span><br>  num x, y;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubPoint</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Point</span> </span>&#123; <span class="hljs-comment">// å­ç±»</span><br>  num z;<br>&#125;<br>void main() &#123;<br>  <span class="hljs-keyword">var</span> p = <span class="hljs-type">SubPoint</span>();<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å‘½åæ„é€ å‡½æ•°</li></ul><p>ç»™æ„é€ å‡½æ•°å‘½åï¼Œä»¥ä¾¿æ›´æ¸…æ™°çš„è¡¨æ˜å‡½æ•°çš„æ„å›¾ï¼Œæ ¼å¼ä¸º<code>ã€ç±»å.å‡½æ•°å(å‚æ•°..)ã€‘</code>ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span> </span>&#123; <span class="hljs-comment">// çˆ¶ç±»</span><br>  <span class="hljs-built_in">num</span> x, y;<br>  Point.initWithXY(<span class="hljs-keyword">this</span>.x,<span class="hljs-keyword">this</span>.y)&#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;called super init,x:<span class="hljs-subst">$x</span>,y:<span class="hljs-subst">$y</span>&#x27;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubPoint</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Point</span> </span>&#123; <span class="hljs-comment">// å­ç±»</span><br>  <span class="hljs-built_in">num</span> z;<br>  SubPoint.initWithXYZ(<span class="hljs-built_in">num</span> x, y, <span class="hljs-keyword">this</span>.z): <span class="hljs-keyword">super</span>.initWithXY(x,y)&#123; <span class="hljs-comment">//æ³¨æ„è¿™é‡Œè°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°çš„è¯­æ³•</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;called sub init,x:<span class="hljs-subst">$x</span>,y:<span class="hljs-subst">$y</span>,z:<span class="hljs-subst">$z</span>&#x27;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-keyword">var</span> p = SubPoint.initWithXYZ(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œè°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°çš„è¯­æ³•ï¼šã€åœ¨å½“å‰æ„é€ å‡½æ•°å†’å· (:) ä¹‹åï¼Œå‡½æ•°ä½“ä¹‹å‰ï¼Œå£°æ˜è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°ã€‘ã€‚</p><h4 id="12-åˆå§‹åŒ–åˆ—è¡¨"><a href="#12-åˆå§‹åŒ–åˆ—è¡¨" class="headerlink" title="12.åˆå§‹åŒ–åˆ—è¡¨"></a>12.åˆå§‹åŒ–åˆ—è¡¨</h4><p>ä¸Swiftä¸ä¸€æ ·çš„æ˜¯ï¼ŒDartçš„æ„é€ å‡½æ•°ä¸­å¹¶ä¸å¼ºåˆ¶æ‰€æœ‰æˆå‘˜å˜é‡éƒ½å®Œæˆåˆå§‹åŒ–ï¼Œé‚£å®ƒä»¬ä»€ä¹ˆæ—¶å€™å»åˆå§‹åŒ–å‘¢ï¼ŸDartçš„è§£å†³æ–¹æ¡ˆæ˜¯<code>åˆå§‹åŒ–åˆ—è¡¨</code>ï¼Œå³åœ¨æ„é€ å‡½æ•°çš„æ–¹æ³•ä½“èŠ±æ‹¬å·<code>&#123;...&#125;</code>ä¹‹å‰åˆå§‹åŒ–å®ä¾‹å˜é‡ã€~~æ¯”è¾ƒå¥‡æ€ªçš„è¯­æ³•~~ã€‘ã€‚</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span> </span>&#123; <span class="hljs-comment">// çˆ¶ç±»</span><br>  <span class="hljs-built_in">num</span> x, y;<br>  Point.initWithXY(<span class="hljs-keyword">this</span>.x,<span class="hljs-keyword">this</span>.y)&#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;called super init,x:<span class="hljs-subst">$x</span>,y:<span class="hljs-subst">$y</span>&#x27;</span>);<br>  &#125;<br>  Point.initFromMap(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>,<span class="hljs-built_in">int</span>&gt;dic)<br>    : x = dic[<span class="hljs-string">&#x27;x&#x27;</span>],<br>      y = dic[<span class="hljs-string">&#x27;y&#x27;</span>]&#123; <span class="hljs-comment">//åˆå§‹åŒ–åˆ—è¡¨ï¼Œåˆå§‹åŒ–å½“å‰ç±»çš„å®ä¾‹å˜é‡</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;called super.initFromMap,x:<span class="hljs-subst">$x</span>,y:<span class="hljs-subst">$y</span>&#x27;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubPoint</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Point</span> </span>&#123; <span class="hljs-comment">// å­ç±»</span><br>  <span class="hljs-built_in">num</span> z;<br>  SubPoint.initList(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>,<span class="hljs-built_in">int</span>&gt;dic)<br>    : z = dic[<span class="hljs-string">&#x27;z&#x27;</span>],<br>      <span class="hljs-keyword">super</span>.initFromMap(dic)&#123; <span class="hljs-comment">//è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°è¦æ”¾åœ¨åˆå§‹åŒ–åˆ—è¡¨çš„æœ€å</span><br>        <span class="hljs-keyword">if</span> (x == <span class="hljs-number">1</span>)&#123;<br>          x = <span class="hljs-number">0</span>; <span class="hljs-comment">// å‡½æ•°ä½“å†…å¯ä»¥ç»§ç»­ä¿®æ”¹å˜é‡çš„å€¼</span><br>        &#125;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;called sub.initList,x:<span class="hljs-subst">$x</span>,y:<span class="hljs-subst">$y</span>&#x27;</span>);<br>  &#125;<br>  SubPoint.initWithXYZ(x,y,<span class="hljs-keyword">this</span>.z): <span class="hljs-keyword">super</span>.initWithXY(x,y)&#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;called sub init,x:<span class="hljs-subst">$x</span>,y:<span class="hljs-subst">$y</span>,z:<span class="hljs-subst">$z</span>&#x27;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-keyword">var</span> dic = &#123;<span class="hljs-string">&#x27;x&#x27;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;y&#x27;</span>:<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;z&#x27;</span>:<span class="hljs-number">3</span>&#125;;<br>  <span class="hljs-keyword">var</span> p = SubPoint.initList(dic);<br>&#125;<br></code></pre></td></tr></table></figure><p>å„å‚æ•°çš„åˆå§‹åŒ–ç”¨é€—å·åˆ†éš”ï¼Œä¸”è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°çš„è¯­å¥è¦æ”¾åœ¨åˆå§‹åŒ–åˆ—è¡¨çš„æœ€åã€‚</p><h4 id="13-Getter-x2F-Setter"><a href="#13-Getter-x2F-Setter" class="headerlink" title="13.Getter&#x2F;Setter"></a>13.Getter&#x2F;Setter</h4><p>å’ŒSwiftä¸€æ ·ï¼ŒDartä¸­å±æ€§çš„Getter&#x2F;Setterä¹Ÿæ˜¯ä¸º<code>è®¡ç®—å±æ€§</code>è€Œå­˜åœ¨çš„ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> &#123;<br>  num left, top, width, height;<br><br>  <span class="hljs-built_in">Rectangle</span>(<span class="hljs-keyword">this</span>.left, <span class="hljs-keyword">this</span>.top, <span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height);<br><br>  <span class="hljs-comment">// å®šä¹‰ä¸¤ä¸ªè®¡ç®—å±æ€§ï¼š right å’Œ bottomã€‚</span><br>  num get right =&gt; left + width;<br>  <span class="hljs-function">set <span class="hljs-title">right</span><span class="hljs-params">(num value)</span> </span>=&gt; left = value - width;<br>  num get bottom =&gt; top + height;<br>  <span class="hljs-function">set <span class="hljs-title">bottom</span><span class="hljs-params">(num value)</span> </span>=&gt; top = value - height;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  var rect = <span class="hljs-built_in">Rectangle</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">20</span>, <span class="hljs-number">15</span>);<br>  <span class="hljs-built_in">print</span>(rect.left);    <span class="hljs-comment">//è°ƒç”¨Getter è¾“å‡ºâ€œ3â€</span><br>  rect.right = <span class="hljs-number">12</span>;     <span class="hljs-comment">//è°ƒç”¨Setter</span><br>  <span class="hljs-built_in">print</span>(rect.right);   <span class="hljs-comment">//12</span><br>  <span class="hljs-built_in">print</span>(rect.left);    <span class="hljs-comment">//-8</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¿®æ”¹leftï¼Œä»è€Œå½±å“ left + width &#x3D; rightï¼Œæœ€ç»ˆå®Œæˆå¯¹rightå±æ€§çš„ä¿®æ”¹ã€‚</p><h4 id="14-æŠ½è±¡ç±»-amp-extends"><a href="#14-æŠ½è±¡ç±»-amp-extends" class="headerlink" title="14.æŠ½è±¡ç±»&amp;extends"></a>14.æŠ½è±¡ç±»&amp;extends</h4><p>ä½¿ç”¨<code>abstract</code>æ¥å®šä¹‰æŠ½è±¡ç±»ã€‚æŠ½è±¡ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œé€šå¸¸ç”¨æ¥å®šä¹‰æ¥å£ï¼Œä»¥åŠéƒ¨åˆ†å®ç°ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-comment">// æŠ½è±¡ç±»</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractClass</span> </span>&#123;<br>  <span class="hljs-comment">// å®šä¹‰å­—æ®µ...</span><br>  <span class="hljs-keyword">var</span> name;<br>  <span class="hljs-keyword">var</span> hasValue = <span class="hljs-number">1</span>;<br>  <br>  <span class="hljs-comment">// æŠ½è±¡æ–¹æ³•ã€‚</span><br>  abstractMethod();<br>  <br>  <span class="hljs-comment">// å¸¦å®ç°çš„æ–¹æ³•</span><br>  funcWithImplements()&#123;<br>    print(<span class="hljs-string">&quot;~~~~~~~&quot;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-comment">// å­ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcreteClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractClass</span> </span>&#123; <span class="hljs-comment">// å•ç»§æ‰¿</span><br>  <span class="hljs-keyword">var</span> name = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">var</span> hasValue = <span class="hljs-number">2</span>;<br>  <br>  <span class="hljs-meta">@override</span><br>  abstractMethod()&#123; <span class="hljs-comment">// æä¾›æ–¹æ³•å®ç°ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ–¹æ³•å°±ä¸æ˜¯æŠ½è±¡æ–¹æ³•äº†...</span><br>    print(&#x27;++call abstractMethod()&#x27;);<br>  &#125;<br>  <br>  <span class="hljs-meta">@override</span><br>  funcWithImplements()&#123; <span class="hljs-comment">// é‡å†™</span><br>    print(<span class="hljs-string">&quot;~~~call funcWithImplements()&quot;</span>);<br>  &#125;<br>&#125;<br>void main() &#123;<br>  <span class="hljs-keyword">var</span> a = <span class="hljs-type">ConcreteClass</span>();<br>  a.abstractMethod();       <span class="hljs-comment">//++call abstractMethod()</span><br>  a.funcWithImplements();   <span class="hljs-comment">//~~~call funcWithImplements()</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Dartä¹Ÿå’ŒSwiftä¸€æ ·ï¼Œåªå…è®¸å•ç»§æ‰¿~</p><h4 id="15-æ¥å£-amp-implements"><a href="#15-æ¥å£-amp-implements" class="headerlink" title="15.æ¥å£&amp;implements"></a>15.æ¥å£&amp;implements</h4><p>Dartä¸­ç§»é™¤äº†<code>interface</code>å…³é”®å­—ï¼Œå¯ä»¥é€šè¿‡æŠ½è±¡ç±»æˆ–<code>implements</code>æ™®é€šç±»æ¥å®ç°æ¥å£çš„åŠŸèƒ½ã€‚</p><blockquote><p>æ¯ä¸ªç±»éƒ½éšå¼çš„å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œæ¥å£åŒ…å«äº†è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹æˆå‘˜åŠå…¶å®ç°çš„æ¥å£ã€‚ å¦‚æœè¦åˆ›å»ºä¸€ä¸ª A ç±»ï¼ŒA è¦æ”¯æŒ B ç±»çš„ API ï¼Œä½†æ˜¯ä¸éœ€è¦ç»§æ‰¿ B çš„å®ç°ï¼Œ é‚£ä¹ˆå¯ä»¥é€šè¿‡ A å®ç° B çš„æ¥å£ã€‚</p></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æŠ½è±¡ç±»1</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractClass</span> &#123;<br>  <span class="hljs-comment">// å®šä¹‰å­—æ®µ...</span><br>  <span class="hljs-keyword">var</span> name;<br>  <span class="hljs-keyword">var</span> hasValue = <span class="hljs-number">1</span>;<br>  <br>  <span class="hljs-comment">// æŠ½è±¡æ–¹æ³•ã€‚</span><br>  <span class="hljs-title function_">abstractMethod</span>();<br><br>  <span class="hljs-comment">// å¸¦å®ç°çš„æ–¹æ³•</span><br>  <span class="hljs-title function_">funcWithImplements</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title function_">print</span>(<span class="hljs-string">&quot;~~~~~~~&quot;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-comment">// æŠ½è±¡ç±»2</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractClass2</span> &#123;<br>  <span class="hljs-title function_">abstractMethod2</span>();<br>&#125;<br><span class="hljs-comment">// å®ç°ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteClass</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AbstractClass</span>, <span class="hljs-title class_">AbstractClass2</span> &#123; <span class="hljs-comment">//å¯ä»¥å®ç°å¤šä¸ªæŠ½è±¡ç±»</span><br>  <span class="hljs-keyword">var</span> name = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">var</span> hasValue = <span class="hljs-number">2</span>;<br><br>  <span class="hljs-meta">@override</span><br>  <span class="hljs-title function_">abstractMethod</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title function_">print</span>(<span class="hljs-string">&#x27;++call abstractMethod()&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@override</span><br>  <span class="hljs-title function_">abstractMethod2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title function_">print</span>(<span class="hljs-string">&#x27;++call abstractMethod2()&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@override</span><br>  <span class="hljs-title function_">funcWithImplements</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title function_">print</span>(<span class="hljs-string">&quot;~~~call funcWithImplements()&quot;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">var</span> a = <span class="hljs-title class_">ConcreteClass</span>();<br>  a.<span class="hljs-title function_">abstractMethod</span>();       <span class="hljs-comment">//++call abstractMethod()</span><br>  a.<span class="hljs-title function_">abstractMethod2</span>();      <span class="hljs-comment">//++call abstractMethod2()</span><br>  a.<span class="hljs-title function_">funcWithImplements</span>();   <span class="hljs-comment">//~~~call funcWithImplements()</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="16-Mixin"><a href="#16-Mixin" class="headerlink" title="16.Mixin"></a>16.Mixin</h4><p><code>Mixin</code>å°±æ˜¯â€œæ··å…¥â€çš„æ„æ€ï¼Œç”¨äºç»™å½“å‰ç±»æ·»åŠ ã€æ–°çš„ã€‘ã€å¯é€‰ã€‘åŠŸèƒ½ã€‚</p><p>é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>ç»§æ‰¿</code>æˆ–è€…å®ç°<code>æ¥å£</code>æ¥ç»™ç°æœ‰ç±»æ‰©å±•æ–°çš„åŠŸèƒ½ã€‚ä½†è¿™äº›éƒ½æ˜¯å¸¦æœ‰ä¾µå…¥æ€§çš„ï¼Œä½ å¯èƒ½ä¼šè·å¾—è¿™äº›çˆ¶ç±»æˆ–æ¥å£ä¸­ä¸€äº›å¤šä½™çš„åŠŸèƒ½ï¼Œå¹¶ä¸”ä½ éœ€è¦è‡ªå·±æä¾›è¿™äº›åŠŸèƒ½çš„å®ç°ï¼›ä½¿ç”¨ Mixin åˆ™ä½ åªéœ€è¦å®šä¹‰å¯å¤ç”¨çš„ mixin ç±»ï¼Œåœ¨å…¶ä¸­å®šä¹‰APIå¹¶æä¾›å…·ä½“å®ç°ï¼Œç„¶åå°±å¯ä»¥å°†è¿™äº›mixinç±»çš„APIé€šè¿‡<code>with</code>å…³é”®å­—ç»„åˆåˆ°å½“å‰ç±»ä¸­ã€‚</p><blockquote><p>ç»§æ‰¿å¼ºè°ƒçš„æ˜¯<code>is-a</code>ï¼Œè€Œ Mixin å¼ºè°ƒçš„æ˜¯<code>I can</code>ã€‚</p></blockquote><p><code>Mixin</code>æ˜¯å¤ç”¨ç±»ä»£ç çš„ä¸€ç§é€”å¾„ï¼Œå¤ç”¨çš„ç±»å¯ä»¥åœ¨ä¸åŒå±‚çº§ï¼Œå¯ä»¥ä¸å­˜åœ¨ç»§æ‰¿å…³ç³»ã€‚</p><p>é€šè¿‡åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª<code>Object</code>ä¸”æ²¡æœ‰æ„é€ å‡½æ•°çš„ç±»ï¼Œæ¥å®ç°ä¸€ä¸ª<code>Mixin</code>ã€‚ å¦‚æœMixinä¸å¸Œæœ›ä½œä¸ºå¸¸è§„ç±»è¢«ä½¿ç”¨ï¼Œä½¿ç”¨å…³é”®å­—<code>mixin</code>æ›¿æ¢<code>class</code>ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Devices</span> </span>&#123;<br>  void run() &#123;<br>    print(&#x27;++++å¼€æœº&#x27;);<br>  &#125;<br>  void stop() &#123;<br>    print(&#x27;++++å…³æœº&#x27;);<br>  &#125;<br>&#125;<br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">iPhone</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Devices</span> </span>&#123;<br>  void run() &#123;<br>    <span class="hljs-keyword">super</span>.run();<br>    print(&#x27;++++iphone å¼€æœº&#x27;);<br>  &#125;<br>&#125;<br> <br><span class="hljs-comment">// å®šä¹‰ç»„ä»¶/èƒ½åŠ›</span><br>mixin iOS &#123; <br>  void call() &#123;<br>    print(&#x27;+++iOS running&#x27;);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// å®šä¹‰ç»„ä»¶/èƒ½åŠ› </span><br><span class="hljs-comment">// émixinå£°æ˜çš„ç±»ä¹Ÿå¯ä»¥é€šè¿‡withå…³é”®å­—æ··å…¥</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppStore</span> </span>&#123;<br>  void download() &#123;<br>    print(&#x27;++++downloading&#x27;);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ··å…¥ã€æ‹“å±•iPhoneçš„åŠŸèƒ½</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">iPhoneX</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">iPhone</span> <span class="hljs-keyword">with</span> <span class="hljs-title">iOS</span>, <span class="hljs-title">AppStore</span> </span>&#123;<br>  void run() &#123;<br>    <span class="hljs-keyword">super</span>.run();<br>    print(&#x27;iphoneX å¼€æœº&#x27;);<br>  &#125;<br>&#125;<br><br>void main() &#123;<br>  <span class="hljs-keyword">var</span> p = iPhoneX();<br>  p.run();<br>  p.call();     <span class="hljs-comment">//ä½¿ç”¨æ··å…¥çš„èƒ½åŠ›</span><br>  p.download(); <span class="hljs-comment">//ä½¿ç”¨æ··å…¥çš„èƒ½åŠ›</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Dartçš„è¿™ä¸ªåŠŸèƒ½è¿˜æ˜¯æŒºå¼ºå¤§çš„ï¼Œæ ¹æ®æˆ‘çš„æŒæ¡çš„çŸ¥è¯†ï¼ŒSwift ä¸­å°šæ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„å…³é”®å­—ã€‚ä¸è¿‡çœŸè¦è¯´çš„è¯ï¼Œæˆ–è®¸å¯ä»¥å€Ÿé“<code>protocol</code>+<code>extension</code>ï¼Œåœ¨ä¸å¢åŠ æŸä¸ªç±»æœ¬èº«çš„ä»£ç é‡çš„å‰æä¸‹ï¼Œç»™æ­¤ç±»æ‰©å±•é¢å¤–çš„èƒ½åŠ›ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">// å®šä¹‰ç»„ä»¶/èƒ½åŠ›</span><br><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">IOS</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">call</span>()<br>&#125;<br><span class="hljs-comment">// å®šä¹‰ç»„ä»¶/èƒ½åŠ›</span><br><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">AppStore</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">download</span>()<br>&#125;<br><span class="hljs-comment">// æ‰©å±•åè®® </span><br><span class="hljs-keyword">extension</span> <span class="hljs-title class_">IOS</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">call</span>()&#123; <span class="hljs-comment">//ç»™æ¥å£æ·»åŠ é»˜è®¤è¡Œä¸º</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++iOS running&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-comment">// æ‰©å±•åè®®</span><br><span class="hljs-keyword">extension</span> <span class="hljs-title class_">AppStore</span>&#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">download</span>()&#123; <span class="hljs-comment">//ç»™æ¥å£æ·»åŠ é»˜è®¤è¡Œä¸º</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++downloading&quot;</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// åœ¨ä¸é¢å¤–å¢åŠ iPhoneç±»æœ¬èº«ä»£ç çš„å‰æä¸‹ï¼Œæ‰©å±•å…¶èƒ½åŠ›</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">iPhone</span>: <span class="hljs-title class_">IOS</span>, <span class="hljs-title class_">AppStore</span>&#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">run</span>()&#123;<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++iphone å¼€æœº&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨é¢å¤–çš„èƒ½åŠ›</span><br><span class="hljs-keyword">let</span> iphone <span class="hljs-operator">=</span> iPhone()<br>iphone.run()<br>iphone.call()<br>iphone.download()<br></code></pre></td></tr></table></figure><h4 id="17-æ³›å‹"><a href="#17-æ³›å‹" class="headerlink" title="17.æ³›å‹"></a>17.æ³›å‹</h4><p>è¿™é‡Œçš„æ³›å‹ä¸ Swift ä¸­çš„ç±»ä¼¼ï¼Œéƒ½æ˜¯ä½¿ç”¨<code>&lt;T&gt;</code>æ ¼å¼æ¥è¡¨ç¤ºã€‚</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Store</span>&lt;T&gt; &#123;<br>  var <span class="hljs-built_in">map</span> = &#123;&#125;;<br>  T <span class="hljs-title function_">getByKey</span>(<span class="hljs-built_in">String</span> <span class="hljs-built_in">key</span>)&#123;<br>    T value = <span class="hljs-built_in">map</span>[<span class="hljs-built_in">key</span>];<br>    <span class="hljs-keyword">return</span> value;<br>  &#125;<br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setByKey</span>(<span class="hljs-built_in">String</span> <span class="hljs-built_in">key</span>, T value)&#123;<br>    <span class="hljs-built_in">map</span>[<span class="hljs-built_in">key</span>] = value;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>() &#123;<br>  var aStore = <span class="hljs-title function_">Store</span>();<br>  aStore.<span class="hljs-property">setByKey</span>(<span class="hljs-string">&#x27;first&#x27;</span>, <span class="hljs-number">1</span>);<br>  <span class="hljs-built_in">print</span>(aStore.<span class="hljs-property">getByKey</span>(<span class="hljs-string">&#x27;first&#x27;</span>));<br>  aStore.<span class="hljs-property">setByKey</span>(<span class="hljs-string">&#x27;second&#x27;</span>, <span class="hljs-string">&#x27;ii&#x27;</span>);<br>  <span class="hljs-built_in">print</span>(aStore.<span class="hljs-property">getByKey</span>(<span class="hljs-string">&#x27;second&#x27;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="18-is-amp-as"><a href="#18-is-amp-as" class="headerlink" title="18.is&amp;as"></a>18.is&amp;as</h4><p><code>is</code>ç”¨äºè¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œå³ç±»æ˜¯å¦åœ¨æŸä¸ªç±»çš„ç»§æ‰¿æ ‘ä¸Šã€‚æˆ–è€…æ£€æŸ¥å¯¹è±¡æ˜¯å¦å®ç°äº†æŸä¸ªæ¥å£ï¼š</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  String name;<br>&#125;<br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Speak</span> &#123;<br>  speak();<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Person</span> <span class="hljs-keyword">implements</span> Speak&#123;<br>  <span class="hljs-built_in">int</span> identifier;<br>  speak()&#123;<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;Hello~&#x27;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-built_in">var</span> p = Person();<br>  <span class="hljs-built_in">var</span> s = Student();<br>  Person  x = Student(); <span class="hljs-comment">//çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡</span><br>  <span class="hljs-comment">//Student y = Person();  //æŠ¥é”™ï¼Œä¸å…è®¸å­ç±»æŒ‡é’ˆæŒ‡å‘çˆ¶ç±»å®ä¾‹</span><br>  <br>  <span class="hljs-keyword">print</span>(p <span class="hljs-keyword">is</span> Person);  <span class="hljs-comment">//trueï¼Œç›´å±ç±»</span><br>  <span class="hljs-keyword">print</span>(s <span class="hljs-keyword">is</span> Student); <span class="hljs-comment">//trueï¼Œç›´å±ç±»</span><br>  <span class="hljs-keyword">print</span>(s <span class="hljs-keyword">is</span> Person);  <span class="hljs-comment">//trueï¼Œçˆ¶ç±»</span><br>  <span class="hljs-keyword">print</span>(x <span class="hljs-keyword">is</span> Student); <span class="hljs-comment">//trueï¼Œxå®é™…å°±æ˜¯Student</span><br>  <span class="hljs-keyword">print</span>(x <span class="hljs-keyword">is</span> Person);  <span class="hljs-comment">//trueï¼Œxæ˜¯Studentï¼Œä¹Ÿæ˜¯Personçš„å­ç±»</span><br>  <span class="hljs-keyword">print</span>(p <span class="hljs-keyword">is</span> Speak);   <span class="hljs-comment">//falseï¼Œçˆ¶ç±»æ²¡å®ç°Speakæ¥å£</span><br>  <span class="hljs-keyword">print</span>(s <span class="hljs-keyword">is</span> Speak);   <span class="hljs-comment">//trueï¼Œå­ç±»å®ç°äº†Speakæ¥å£</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>as</code>ç”¨äºç±»å‹è½¬æ¢ï¼š</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  String name;<br>&#125;<br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Speak</span> &#123;<br>  speak();<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Person</span> <span class="hljs-keyword">implements</span> Speak&#123;<br>  <span class="hljs-built_in">int</span> identifier;<br>  speak()&#123;<br>    <span class="hljs-keyword">print</span>(<span class="hljs-string">&#x27;Hello~&#x27;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">void</span> main() &#123;<br>  <span class="hljs-built_in">var</span> p = Person();<br>  <span class="hljs-built_in">var</span> s = Student();<br>  Person  x = Student(); <span class="hljs-comment">//çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡</span><br>  <br>  <span class="hljs-built_in">var</span> y = x <span class="hljs-keyword">as</span> Student;<br>  y.identifier = <span class="hljs-number">101</span>;<br>  <br>  <span class="hljs-keyword">print</span>(p <span class="hljs-keyword">as</span> Person);    <span class="hljs-comment">//Instance of &#x27;Person&#x27;</span><br>  <span class="hljs-keyword">print</span>(p <span class="hljs-keyword">as</span> Student);   <span class="hljs-comment">//æŠ¥é”™ï¼Œè¿è¡Œæ—¶å¼‚å¸¸</span><br>  <span class="hljs-keyword">print</span>(s <span class="hljs-keyword">as</span> Person);    <span class="hljs-comment">//Instance of &#x27;Student&#x27;</span><br>  <span class="hljs-keyword">print</span>(s <span class="hljs-keyword">as</span> Student);   <span class="hljs-comment">//Instance of &#x27;Student&#x27;</span><br>  <span class="hljs-keyword">print</span>(x <span class="hljs-keyword">as</span> Person);    <span class="hljs-comment">//Instance of &#x27;Student&#x27;</span><br>  <span class="hljs-keyword">print</span>(x <span class="hljs-keyword">as</span> Student);   <span class="hljs-comment">//Instance of &#x27;Student&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="19-åº“"><a href="#19-åº“" class="headerlink" title="19.åº“"></a>19.åº“</h4><ul><li>åº“ä¸ä»…æä¾›äº† API ï¼Œè€Œä¸”å¯¹ä»£ç èµ·åˆ°äº†å°è£…çš„ä½œç”¨ã€‚ </li><li>import å’Œ library æŒ‡ä»¤å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ¨¡å—åŒ–çš„ï¼Œå¯å…±äº«çš„ä»£ç åº“ã€‚ </li><li>Dartä¸­æ²¡æœ‰<code>public</code>ã€<code>protected</code>å’Œ<code>private</code>è¿™äº›è®¿é—®ä¿®é¥°ç¬¦ï¼Œçº¦å®šä»¥ä¸‹åˆ’çº¿<code>_</code>å®šä¹‰ç§æœ‰ç±»å‹ï¼Œè¡¨ç¤ºä»…åœ¨å½“å‰åº“ä¸­å¯è§ã€‚</li><li>æ¯ä¸ª Dart åº”ç”¨ç¨‹åºéƒ½æ˜¯ä¸€ä¸ªåº“ ï¼Œè™½ç„¶æ²¡æœ‰ä½¿ç”¨ library æŒ‡ä»¤ã€‚</li></ul><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-comment">// å¯¼å…¥æ ¸å¿ƒåº“</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;dart:math&#x27;</span>;<br><br><span class="hljs-comment">// ä»å¤–éƒ¨åŒ…å¯¼å…¥åº“</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:test/test.dart&#x27;</span>;<br><br><span class="hljs-comment">// å¯¼å…¥æ–‡ä»¶</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;path/to/my_other_file.dart&#x27;</span>;<br></code></pre></td></tr></table></figure><p>å¦‚æœåªä½¿ç”¨åº“çš„ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œåˆ™å¯ä»¥é€‰æ‹©éœ€è¦å¯¼å…¥çš„å†…å®¹ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// <span class="hljs-keyword">Import</span> <span class="hljs-keyword">only</span> foo.<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:lib1/lib1.dart&#x27;</span> <span class="hljs-keyword">show</span> foo;<br><br>// <span class="hljs-keyword">Import</span> <span class="hljs-keyword">all</span> names <span class="hljs-keyword">EXCEPT</span> foo.<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:lib2/lib2.dart&#x27;</span> hide foo;<br></code></pre></td></tr></table></figure><p>å¦‚æœå¯¼å…¥ä¸¤ä¸ªå­˜åœ¨å†²çªæ ‡è¯†ç¬¦çš„åº“ï¼Œ åˆ™å¯ä»¥ä¸ºè¿™ä¸¤ä¸ªåº“ï¼Œæˆ–è€…å…¶ä¸­ä¸€ä¸ªæŒ‡å®šå‰ç¼€ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœ library1 å’Œ library2 éƒ½æœ‰ä¸€ä¸ª Element ç±»ï¼Œ é‚£ä¹ˆå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å¤„ç†ï¼š</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:lib1/lib1.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:lib2/lib2.dart&#x27;</span> <span class="hljs-keyword">as</span> lib2;<br><br><span class="hljs-comment">// ä½¿ç”¨ lib1 ä¸­çš„ Elementã€‚</span><br><span class="hljs-built_in">Element</span> element1 = <span class="hljs-built_in">Element</span>();<br><br><span class="hljs-comment">// ä½¿ç”¨ lib2 ä¸­çš„ Elementã€‚</span><br>lib2.<span class="hljs-built_in">Element</span> element2 = lib2.<span class="hljs-built_in">Element</span>();<br></code></pre></td></tr></table></figure><h4 id="20-å¼‚æ­¥"><a href="#20-å¼‚æ­¥" class="headerlink" title="20.å¼‚æ­¥"></a>20.å¼‚æ­¥</h4><p>Dart é»˜è®¤æ˜¯å•çº¿ç¨‹çš„ï¼Œè€—æ—¶æ“ä½œå¾ˆå®¹æ˜“é€ æˆçº¿ç¨‹é˜»å¡ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">loadData()&#123;<br>  String dataURL <span class="hljs-operator">=</span> <span class="hljs-string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span><span class="hljs-comment">;</span><br>  http.Response response <span class="hljs-operator">=</span> http.get(dataURL)<span class="hljs-comment">;</span><br>  setState(() &#123;<br>    widgets <span class="hljs-operator">=</span> json.decode(response.body)<span class="hljs-comment">;</span><br>  &#125;)<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç½‘ç»œè¯·æ±‚å¯èƒ½ä¼šå¾ˆæ…¢ï¼Œè¿™æ—¶ä¸»çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°è¯·æ±‚å®Œæˆå¹¶æ›´æ–°çŠ¶æ€ã€‚</p><p>å¥½åœ¨ Dart æä¾›äº†å¼‚æ­¥å·¥å…·<code>async</code>ã€<code>await</code>ã€<code>Future</code>ï¼Œæ¥å®ç°å¼‚æ­¥æ“ä½œã€‚å‡½æ•°ä½“è¢«<code>async</code>æ ‡è®°çš„å‡½æ•°ï¼Œå³æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ã€‚å°†<code>async</code>å…³é”®å­—æ·»åŠ åˆ°å‡½æ•°ä½¿å…¶è¿”å›<code>Future</code>ï¼Œä»¥ä¾¿æ£€æŸ¥ç»“æœã€‚ </p><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„åŒæ­¥å‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ª String ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">String</span> lookUpVersion() =&gt; &#x27;<span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>&#x27;;<br></code></pre></td></tr></table></figure><p>å‡å¦‚å°†æ¥çš„å®ç°å°†éå¸¸è€—æ—¶ï¼Œå°†å…¶æ›´æ”¹ä¸ºå¼‚æ­¥å‡½æ•°ï¼Œè¿”å›å€¼æ˜¯<code>Future</code>ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function">Future&lt;String&gt; <span class="hljs-title">lookUpVersion</span>() <span class="hljs-keyword">async</span></span> =&gt; <span class="hljs-string">&#x27;1.0.0&#x27;</span>;<br></code></pre></td></tr></table></figure><ul><li><code>await</code>ä¸<code>async</code>å€Ÿé‰´è‡ªES7ï¼Œä¸€èˆ¬æˆå¯¹å‡ºç°ï¼›</li><li>å‡ºç°awaitæ“ä½œçš„ã€æ–¹æ³•ã€‘å¿…é¡»å£°æ˜ä¸ºasyncï¼›</li><li>awaitä¿®é¥°è€—æ—¶æ“ä½œï¼Œæ­¤è€—æ—¶æ“ä½œä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼›</li><li>asyncä¿®é¥°çš„æ–¹æ³•ä¼šç«‹åˆ»è¿”å›ï¼Œä¸é˜»å¡å½“å‰çº¿ç¨‹ï¼›</li></ul><p>ç¤ºä¾‹1ï¼šè°ƒç”¨æ—¶ä¸å¸¦<code>await</code></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dart">Future refreshDate() <span class="hljs-keyword">async</span>&#123;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++3333: +<span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>);<br>  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds:<span class="hljs-number">5</span>));<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++44444: <span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br><br><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span>&#123;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++111: <span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>);<br>  refreshDate(); <span class="hljs-comment">// ä¸æ ‡è®°ä¸ºawait ä¼šç›´æ¥æ‰§è¡Œä¸‹ä¸€è¡Œ</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++222: <span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs subunit">+++<span class="hljs-string">+111</span>: 2020<span class="hljs-string">-05</span><span class="hljs-string">-08</span> 23:53:59.366<br>+++<span class="hljs-string">+3333</span>: <span class="hljs-string">+2020</span><span class="hljs-string">-05</span><span class="hljs-string">-08</span> 23:53:59.366<br>+++<span class="hljs-string">+222</span>: 2020<span class="hljs-string">-05</span><span class="hljs-string">-08</span> 23:53:59.366<br>+++<span class="hljs-string">+44444</span>: 2020<span class="hljs-string">-05</span><span class="hljs-string">-08</span> 23:54:04.367<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹2ï¼šè°ƒç”¨æ—¶å¸¦<code>await</code></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dart">Future refreshDate() <span class="hljs-keyword">async</span>&#123;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++3333: +<span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>);<br>  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds:<span class="hljs-number">5</span>));<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++44444: <span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br><br><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span>&#123;<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++111: <span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>);<br>  <span class="hljs-keyword">await</span> refreshDate(); <span class="hljs-comment">// æ ‡è®°ä¸ºawait åˆ™å…ˆæ‰§è¡Œå®ŒrefreshDateæ“ä½œæ‰ä¼šæ‰§è¡Œä¸‹ä¸€è¡Œ</span><br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++222: <span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs subunit">+++<span class="hljs-string">+111</span>: 2020<span class="hljs-string">-05</span><span class="hljs-string">-08</span> 23:51:24.701<br>+++<span class="hljs-string">+3333</span>: <span class="hljs-string">+2020</span><span class="hljs-string">-05</span><span class="hljs-string">-08</span> 23:51:24.701<br>+++<span class="hljs-string">+44444</span>: 2020<span class="hljs-string">-05</span><span class="hljs-string">-08</span> 23:51:29.702<br>+++<span class="hljs-string">+222</span>: 2020<span class="hljs-string">-05</span><span class="hljs-string">-08</span> 23:51:29.702<br></code></pre></td></tr></table></figure><p>Dart è¿˜æä¾›äº†<code>Isolate</code>æ¥è®©ä»£ç è¿è¡Œåœ¨å…¶ä»–çº¿ç¨‹ä¸­ï¼Œä»è€Œå®ç°å¹¶å‘ç¼–ç¨‹ï¼Œåç»­æœ‰æ—¶é—´ç»§ç»­ç ”ç©¶~</p><h3 id="ä¸‰-åè®°"><a href="#ä¸‰-åè®°" class="headerlink" title="ä¸‰.åè®°"></a>ä¸‰.åè®°</h3><p><code>Dart</code>åŒ…å«äº†è¯¸å¤šç°ä»£ç¼–ç¨‹è¯­è¨€çš„ç‰¹æ€§ï¼Œç‰¹ç‚¹é²œæ˜ï¼š</p><ul><li><p>é«˜æ•ˆï¼šè¯­æ³•æ¸…æ™°ç®€æ´ã€å·¥å…·ç®€å•è€Œå¼ºå¤§ã€è¾“å…¥æ£€æµ‹å¯å°½æ—©è¯†åˆ«ç»†å¾®é”™è¯¯ã€åº“æ–‡ä»¶ä¸°å¯Œï¼›</p></li><li><p>å¿«é€Ÿï¼šæä¾›<code>AOT</code>æå‰ç¼–è¯‘ä¼˜åŒ–ï¼Œåœ¨ç§»åŠ¨è®¾å¤‡å’Œwebä¸Šå®ç°é«˜æ€§èƒ½å’Œå¿«é€Ÿå¯åŠ¨ï¼›æ”¯æŒ<code>çƒ­åŠ è½½</code>ï¼›</p></li><li><p>å¯ç§»æ¤ï¼šå¯ç¼–è¯‘æˆ<code>ARM</code>å’Œ<code>x86</code>ä»£ç ï¼Œæ”¯æŒç§»åŠ¨ã€æ¡Œé¢åŠç»ˆç«¯ç¨‹åºï¼›webä¸Šä¼šè½¬æ¢ä¸º<code>JavaScript</code>ï¼›</p></li><li><p>æ˜“å­¦ï¼šé¢å‘å¯¹è±¡ï¼Œè¯­æ³•é£æ ¼ä¸<code>Swift</code>ç›¸ä¼¼ï¼Œä¸Šæ‰‹ç›¸å¯¹å®¹æ˜“äº›ã€‚</p></li><li><p>å“åº”å¼ï¼šæ”¯æŒå“åº”å¼ç¼–ç¨‹ã€‚å¯é€šè¿‡ Future å’Œ Stream çš„ç‰¹æ€§å’ŒAPIå®ç°å¼‚æ­¥ç¼–ç¨‹ã€‚</p></li></ul><p>å­¦ä¹ <code>Flutter</code>ä¹‹å‰æœ‰å¿…è¦ç ”ç©¶ä¸€ä¸‹<code>Dart</code>ï¼Œå¯¹æ¯”å­¦ä¹ ä»è€ŒåŠ æ·±å¯¹å„è¯­è¨€çš„ç†è§£~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://www.dartcn.com/">Â©Dartä¸­æ–‡ç½‘</a></p><p>#<a href="https://dartpad.cn/">Â©DartPad-åœ¨çº¿ç¼–è¯‘è°ƒè¯•å·¥å…·</a></p><p>#<a href="https://flutterchina.club/">Â©Flutterä¸­æ–‡ç½‘</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Flutter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RAC-æ•°æ®çš„è¿‡æ»¤ä¸è½¬æ¢</title>
    <link href="/2021/06/06/RAC-sig-filter.html"/>
    <url>/2021/06/06/RAC-sig-filter.html</url>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä¿¡å·åœ¨è®¢é˜…åå°±å¯ä»¥æ¥æ”¶å›è°ƒçš„æ•°æ®äº†ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹æ”¶åˆ°çš„æ•°æ®è¿›è¡Œè¿‡æ»¤æˆ–è€…è½¬æ¢åæ‰èƒ½ç»§ç»­ä½¿ç”¨ã€‚<br><br/></p><p>ä¾‹å¦‚å‘é€æŒ‰é’®çš„<code>userInteractionEnabled</code>çŠ¶æ€éœ€è¦ä¾è¯·æ±‚çš„<code>isFnished</code>çŠ¶æ€è€Œå®šï¼šè¯·æ±‚å‘é€åæœªå®Œæˆåˆ™æŒ‰é’®ä¸å¯ç‚¹å‡»ï¼Œè¯·æ±‚æˆåŠŸè¿”å›åæŒ‰é’®å¯ç‚¹å‡»ã€‚è¿™ç§åœºæ™¯ä¸‹æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªä¿¡å·ç›‘å¬è¯·æ±‚çš„<code>isFnished</code>å±æ€§ï¼Œå¹¶å¯¹ä¿¡å·è¿”å›çš„ç»“æœè¿›è¡Œå–åå³å¯ã€‚<br><br/></p><p>å†æ¯”å¦‚ä¿®æ”¹æ˜µç§°æ—¶ä¸€èˆ¬ä¸èƒ½å‰åè¾“å…¥ä¸€æ ·çš„æ˜µç§°ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿¡å·ç›‘å¬æ–‡æœ¬æ¡†çš„å†…å®¹ï¼Œé‡åˆ°å‰åä¸€è‡´çš„æ–‡æœ¬æ—¶è‡ªåŠ¨è¿‡æ»¤æ‰å³å¯ã€‚<br><br/></p><p>ä¸ºäº†åº”å¯¹è¿™äº›å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼ŒRACåŒæ ·ä¹Ÿæä¾›äº†å¯¹åº”çš„æ¥å£ã€‚æœ¬æ–‡å°†å¯¹è¿™äº›æ¥å£è¿›è¡Œè°ƒç”¨å±•ç¤ºå’Œå®ç°åˆ†æï¼š</p><h3 id="1-bind"><a href="#1-bind" class="headerlink" title="1.bind"></a>1.bind</h3><p>ä¿¡å·çš„ç»‘å®šï¼Œå…ˆè®²è¿™ä¸ªæ–¹æ³•æ˜¯å› ä¸ºå…¶ä»–æ¥å£çš„åº•å±‚éƒ½æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„ï¼Œç†æ¸…å®ƒçš„å®ç°æœ‰åŠ©äºæ›´å¥½çš„ç†è§£æ¥ä¸‹æ¥çš„å…¶ä»–æ¥å£ã€‚<br><br/></p><p>è¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨<code>RACStream.h</code>ä¸­ï¼Œè¢«å¤šä¸ªå­ç±»é‡å†™ï¼Œè¿™é‡Œå°±çœ‹çœ‹<code>RACSignal.h</code>ä¸­çš„æ¥å£å®šä¹‰ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">//1 bindæ–¹æ³•çš„å®šä¹‰</span><br><span class="hljs-comment">/// Lazily binds a block to the values in the receiver.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This should only be used if you need to terminate the bind early, or close</span><br><span class="hljs-comment">/// over some state. -flattenMap: is more appropriate for all other cases.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// block - A block returning a RACSignalBindBlock. This block will be invoked</span><br><span class="hljs-comment">///         each time the bound signal is re-evaluated. This block must not be</span><br><span class="hljs-comment">///         nil or return nil.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a new signal which represents the combined result of all lazy</span><br><span class="hljs-comment">/// applications of `block`.</span><br>- (RACSignal *)bind:(<span class="hljs-built_in">RACSignalBindBlock</span> (^)(<span class="hljs-type">void</span>))block RAC_WARN_UNUSED_RESULT;<br><br><span class="hljs-comment">//2.blockçš„è¿”å›å€¼BindBlockçš„å®šä¹‰</span><br><span class="hljs-comment">/// A block which accepts a value from a RACSignal and returns a new signal.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Setting `stop` to `YES` will cause the bind to terminate after the returned</span><br><span class="hljs-comment">/// value. Returning `nil` will result in immediate termination.</span><br><span class="hljs-keyword">typedef</span> RACSignal * _Nullable (^RACSignalBindBlock)(ValueType _Nullable value, BOOL *stop);<br></code></pre></td></tr></table></figure><ul><li>æ–¹æ³•çš„å‚æ•°ï¼šä¸€ä¸ªâ€œRACSignalBindBlock (^)(void)â€ç±»å‹çš„<code>block</code>ï¼›</li><li>æ–¹æ³•çš„è¿”å›å€¼ï¼šä¸€ä¸ªæ–°çš„ä¿¡å·å¯¹è±¡ã€‚</li></ul><p><strong>ä½œç”¨</strong>ï¼šå°†<code>block</code>ç»‘å®šåˆ°æ–¹æ³•æ¥æ”¶è€…çš„å€¼ä¸­ï¼Œå³æŠŠ<code>block</code>å‚æ•°ä¿å­˜åœ¨è¿”å›çš„ä¿¡å·ä¸­ã€‚<br><br/></p><p>æ‰€ä»¥ï¼Œ<code>bind</code>çš„ä¸»è¦ç›®çš„å°±æ˜¯å°†ä»»åŠ¡ä»¥ block çš„å½¢å¼ä¿å­˜åˆ°è¿”å›çš„ä¿¡å·ä¸­ï¼Œä»¥æœŸåœ¨å°†æ¥è¿›è¡Œå¤„ç†ã€‚</p><br/><p>#<strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-operator">-</span> (<span class="hljs-variable">void</span>)<span class="hljs-title function_">callBind</span> &#123;<br>    <span class="hljs-comment">//bindçš„ä½œç”¨ï¼šå°†blockç»‘å®šåˆ°ä¿¡å·2ä¸­ï¼Œè®¢é˜…ä¿¡å·1å¹¶åˆ›å»ºæ–°çš„ä¿¡å·2ï¼Œæ”¶åˆ°ä¿¡å·1çš„æ•°æ®åï¼Œä¿®æ”¹æ•°æ®å¹¶é€šè¿‡æ–°åˆ›å»ºçš„ä¿¡å·2å‘é€æ–°æ•°æ®)</span><br>    <span class="hljs-comment">// 1.ä¿¡å·1</span><br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">signal1</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        <span class="hljs-comment">// 5.ä¿¡å·1å‘é€æ•°æ®1</span><br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;1&quot;</span>];<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nil</span>;<br>    &#125;];<br>    <span class="hljs-comment">// 2.ä¿¡å·2</span><br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">bindSignal2</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">signal1</span> <span class="hljs-variable">bind</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACSignalBindBlock</span>&#123;<br>        <span class="hljs-comment">// 4.bindå›è°ƒ</span><br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++This is BindBlock callback&quot;</span>);<br>        <span class="hljs-title class_">RACSignalBindBlock</span> <span class="hljs-variable">aBindBlock</span> <span class="hljs-operator">=</span> <span class="hljs-operator">^</span><span class="hljs-title class_">RACSignal</span><span class="hljs-title function_">*</span>(<span class="hljs-params">id</span> <span class="hljs-params">value</span>, <span class="hljs-params">BOOL</span> *<span class="hljs-params">stop</span>)&#123;<br>            <span class="hljs-comment">// 6.bindBlockå†…ä¿®æ”¹æ•°æ®</span><br>            <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++ori value:%@&quot;</span>,<span class="hljs-variable">value</span>);<br>            <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> @<span class="hljs-string">&quot;2&quot;</span>;<br>            <span class="hljs-keyword">return</span> [<span class="hljs-title class_">RACReturnSignal</span> <span class="hljs-keyword">return</span>:<span class="hljs-variable">value</span>];<span class="hljs-comment">// ä¿¡å·3</span><br>        &#125;;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">aBindBlock</span>;<br>    &#125;];<br>    <span class="hljs-comment">// 3.è®¢é˜…ä¿¡å·2</span><br>    [<span class="hljs-variable">bindSignal2</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-comment">// 7.æ¥æ”¶æ•°æ®</span><br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;++++bindSignal return Value:%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">This is BindBlock callback</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ori value:1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">bindSignal return Value:2</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­<code>ä¿¡å·1</code>è°ƒç”¨äº†ç»‘å®šæ–¹æ³•ï¼Œå°†ä¸€ä¸ªä¿®æ”¹æ•°æ®çš„ block ç»‘å®šåˆ°è¿”å›å€¼<code>ä¿¡å·2</code>ä¸­ã€‚<br><br/></p><p>è®¢é˜…<code>ä¿¡å·2</code>ä¹‹å<code>ä¿¡å·1</code>å‘é€äº†æ•°æ®<code>1</code>ï¼Œä½†æœ€ç»ˆ<code>ä¿¡å·2</code>è®¢é˜…è€…æ¥æ”¶åˆ°çš„æ˜¯ä¿®æ”¹åçš„æ•°æ®<code>2</code>ã€‚<br><br/></p><p>ä¸‹é¢å°±æ¥çœ‹çœ‹è°ƒç”¨<code>bind</code>æ–¹æ³•åéƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼š<br><br/></p><p>#<strong>å®ç°</strong>ï¼š</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-operator">-</span> (<span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span>)<span class="hljs-variable">bind</span>:(<span class="hljs-title class_">RACSignalBindBlock</span> (<span class="hljs-operator">^</span>)(<span class="hljs-variable">void</span>))<span class="hljs-title function_">block</span> &#123;<br><span class="hljs-title class_">NSCParameterAssert</span>(<span class="hljs-variable">block</span> <span class="hljs-operator">!=</span> <span class="hljs-variable">NULL</span>);<span class="hljs-comment">//ä¸ºç©ºæ ¡éªŒ</span><br><br><span class="hljs-keyword">return</span> [[<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<span class="hljs-comment">//åˆ›å»ºä¿¡å·2 ^didSubscribe2</span><br><br><span class="hljs-comment">// 1.è°ƒç”¨bindçš„blockå‚æ•°ï¼Œè¿”å›BindBlock</span><br><span class="hljs-title class_">RACSignalBindBlock</span> <span class="hljs-variable">bindingBlock</span> <span class="hljs-operator">=</span> <span class="hljs-title function_">block</span>();<br><br><span class="hljs-variable">__block</span> <span class="hljs-variable">volatile</span> int32_t <span class="hljs-variable">signalCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;   <span class="hljs-comment">// indicates self</span><br><br><span class="hljs-title class_">RACCompoundDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">compoundDisposable</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACCompoundDisposable</span> <span class="hljs-variable">compoundDisposable</span>];<br><br><span class="hljs-comment">// åˆ›å»ºå®Œæˆblock</span><br><span class="hljs-title function_">void</span> (<span class="hljs-operator">^</span><span class="hljs-variable">completeSignal</span>)(<span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span>) <span class="hljs-operator">=</span> <span class="hljs-title function_">^</span>(<span class="hljs-params">RACDisposable</span> *<span class="hljs-params">finishedDisposable</span>) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-title class_">OSAtomicDecrement</span>32Barrier(<span class="hljs-operator">&amp;</span><span class="hljs-variable">signalCount</span>) <span class="hljs-operator">==</span> <span class="hljs-number">0</span>) &#123;<br>[<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>[<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">dispose</span>];<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>[<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">removeDisposable</span>:<span class="hljs-variable">finishedDisposable</span>];<br>&#125;<br>&#125;;<br><br><span class="hljs-comment">// åˆ›å»ºä¿¡å·å¤„ç†block</span><br><span class="hljs-title function_">void</span> (<span class="hljs-operator">^</span><span class="hljs-variable">addSignal</span>)(<span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span>) <span class="hljs-operator">=</span> <span class="hljs-title function_">^</span>(<span class="hljs-params">RACSignal</span> *<span class="hljs-params">signal</span>) &#123;<br><span class="hljs-title class_">OSAtomicIncrement</span>32Barrier(<span class="hljs-operator">&amp;</span><span class="hljs-variable">signalCount</span>);<br><br><span class="hljs-title class_">RACSerialDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">selfDisposable</span> <span class="hljs-operator">=</span> [[<span class="hljs-title class_">RACSerialDisposable</span> <span class="hljs-variable">alloc</span>] init];<br>[<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">addDisposable</span>:<span class="hljs-variable">selfDisposable</span>];<br><br><span class="hljs-comment">// 5.è®¢é˜…ä¼ è¿›æ¥çš„ä¿¡å·</span><br><span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">disposable</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">signal</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<span class="hljs-comment">// ^sendNext3</span><br><span class="hljs-comment">// 6.å‘ä¿¡å·2å‘é€æ•°æ®</span><br>[<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:<span class="hljs-variable">x</span>];<br>&#125; <span class="hljs-variable">error</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">NSError</span> *<span class="hljs-params">error</span>) &#123;<br>[<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">dispose</span>];<br>[<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendError</span>:<span class="hljs-variable">error</span>];<br>&#125; <span class="hljs-variable">completed</span>:<span class="hljs-operator">^</span>&#123;<br>@<span class="hljs-title function_">autoreleasepool</span> &#123;<br><span class="hljs-title function_">completeSignal</span>(<span class="hljs-variable">selfDisposable</span>);<br>&#125;<br>&#125;];<br><br><span class="hljs-variable">selfDisposable</span>.<span class="hljs-property">disposable</span> <span class="hljs-operator">=</span> <span class="hljs-variable">disposable</span>;<br>&#125;;<br><br>@<span class="hljs-title function_">autoreleasepool</span> &#123;<br><span class="hljs-title class_">RACSerialDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">selfDisposable</span> <span class="hljs-operator">=</span> [[<span class="hljs-title class_">RACSerialDisposable</span> <span class="hljs-variable">alloc</span>] init];<br>[<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">addDisposable</span>:<span class="hljs-variable">selfDisposable</span>];<br><br><span class="hljs-comment">// 2.è®¢é˜…ä¿¡å·1</span><br><span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">bindingDisposable</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">self</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<span class="hljs-comment">// ^sendNext1</span><br><span class="hljs-comment">// Manually check disposal to handle synchronous errors.</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">compoundDisposable</span>.<span class="hljs-property">disposed</span>) <span class="hljs-keyword">return</span>;<br><br><span class="hljs-variable">BOOL</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-variable">NO</span>;<br><span class="hljs-comment">// 3.è°ƒç”¨ aBindBlockï¼Œè¿”å›ä¸€ä¸ªä¿¡å·3</span><br><span class="hljs-variable">id</span> <span class="hljs-variable">signal</span> <span class="hljs-operator">=</span> <span class="hljs-title function_">bindingBlock</span>(<span class="hljs-variable">x</span>, <span class="hljs-operator">&amp;</span><span class="hljs-variable">stop</span>);<br><br>@<span class="hljs-title function_">autoreleasepool</span> &#123;<br><span class="hljs-comment">// 4.ä¿¡å·3ä½œä¸ºå‚æ•° è°ƒç”¨addSignal()</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">signal</span> <span class="hljs-operator">!=</span> <span class="hljs-variable">nil</span>) <span class="hljs-title function_">addSignal</span>(<span class="hljs-variable">signal</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">signal</span> <span class="hljs-operator">==</span> <span class="hljs-variable">nil</span> <span class="hljs-operator">||</span> <span class="hljs-variable">stop</span>) &#123;<br>[<span class="hljs-variable">selfDisposable</span> <span class="hljs-variable">dispose</span>];<br><span class="hljs-title function_">completeSignal</span>(<span class="hljs-variable">selfDisposable</span>);<br>&#125;<br>&#125;<br>&#125; <span class="hljs-variable">error</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">NSError</span> *<span class="hljs-params">error</span>) &#123;<br>[<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">dispose</span>];<br>[<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendError</span>:<span class="hljs-variable">error</span>];<br>&#125; <span class="hljs-variable">completed</span>:<span class="hljs-operator">^</span>&#123;<br>@<span class="hljs-title function_">autoreleasepool</span> &#123;<br><span class="hljs-title function_">completeSignal</span>(<span class="hljs-variable">selfDisposable</span>);<br>&#125;<br>&#125;];<br><br><span class="hljs-variable">selfDisposable</span>.<span class="hljs-property">disposable</span> <span class="hljs-operator">=</span> <span class="hljs-variable">bindingDisposable</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">compoundDisposable</span>;<br>&#125;] <span class="hljs-variable">setNameWithFormat</span>:@<span class="hljs-string">&quot;[%@] -bind:&quot;</span>, <span class="hljs-variable">self</span>.<span class="hljs-property">name</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>1.è°ƒç”¨<code>bind</code>æ–¹æ³•åæ–¹æ³•ä½“å†…åªåšäº†blockä¸ºç©ºçš„æ ¡éªŒï¼Œä¹‹åè¿”å›äº†ä¸€ä¸ªä¿¡å·ï¼Œå³æˆ‘ä»¬ç¤ºä¾‹ä¸­çš„<code>ä¿¡å·2</code>ã€‚æ‰€ä»¥å…³é”®ç‚¹åœ¨è¿™ä¸ª<code>ä¿¡å·2</code>çš„å®ç°ä¸­ã€‚ç¤ºä¾‹çš„æœ€åæˆ‘ä»¬è®¢é˜…äº†<code>ä¿¡å·2</code>ï¼Œæ‰€ä»¥å°±ä¼šè§¦å‘å…¶<code>^didSubscribe</code>å›è°ƒï¼Œä¹Ÿå°±æ˜¯<code>bind</code>æ–¹æ³•ä¸­è¿”å›å€¼çš„é‚£ä¸ªå¤§çš„ blockï¼Œåœ¨ä¸Šé¢çš„ä»£ç æ³¨é‡Šä¸­æˆ‘å°†å®ƒå‘½åä¸º<code>^didSubscribe2</code>ï¼›<br><br/></p><p>2.<code>^didSubscribe2</code>ä¸­å…ˆè°ƒç”¨<code>bind</code>æ–¹æ³•çš„<code>block</code>å‚æ•°ã€‚è¿™ä¸ª<code>block</code>å°±æ˜¯æˆ‘ä»¬åœ¨ç¤ºä¾‹ä¸­å®šä¹‰å¥½çš„ï¼Œå…¶å®ä»€ä¹ˆéƒ½æ²¡åšï¼Œåªæ˜¯è¿”å›äº†ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„<code>aBindBlock</code>ï¼›<br><br/></p><p>3.<code>^didSubscribe2</code>ç´§æ¥ç€å®šä¹‰äº†ä¸¤ä¸ªblockï¼Œç„¶åè®¢é˜…äº†<code>ä¿¡å·1</code>ï¼Œè§¦å‘<code>^didSubscribe1</code>ï¼Œå³ç¤ºä¾‹1ä¸­<code>ä¿¡å·1</code>çš„ blockï¼›<br><br/></p><p>4.<code>^didSubscribe1</code>ä¸­å‘è®¢é˜…è€…å‘é€äº†æ•°æ®<code>1</code>ï¼›è§¦å‘<code>bind</code>æ–¹æ³•å†…çš„<code>^sendNext1</code>ï¼›<br><br/></p><p>5.<code>^sendNext1</code>å†…è°ƒç”¨<code>aBindBlock</code>ï¼Œå‚æ•°ä¸ºæ•°æ®<code>1</code>ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ä¿¡å·ï¼Œå°†å…¶å‘½åä¸º<code>ä¿¡å·3</code>ï¼›<code>aBindBlock</code>æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª blockï¼Œå†…éƒ¨å®šä¹‰äº†å¤„ç†æ•°æ®çš„é€»è¾‘ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªç‰¹æ®Šç±»å‹(RACReturnSignal)çš„<code>ä¿¡å·3</code>ï¼Œè¿™ç§ä¿¡å·çš„ç‰¹ç‚¹æ˜¯è¢«è®¢é˜…ä¹‹åä¼šç«‹åˆ»å°†è‡ªå·±æ¥æ”¶çš„å‚æ•°ä½œä¸ºæ•°æ®å‘é€å‡ºå»ï¼Œè€Œè¿™ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬ä¿®æ”¹ä¹‹åçš„æ•°æ®<code>2</code>ï¼›<br><br/></p><p>6.<code>^sendNext1</code>å†…æ¥ç€å°†<code>ä¿¡å·3</code>ä½œä¸ºå‚æ•°è°ƒç”¨äº†<code>^addSignal</code>ï¼›<code>^addSignal</code>å†…è®¢é˜…äº†<code>ä¿¡å·3</code>ï¼Œä¸Šé¢è¯´è¿‡<code>ä¿¡å·3</code>çš„ç‰¹ç‚¹ï¼Œæ‰€ä»¥è¢«è®¢é˜…åç«‹åˆ»è§¦å‘äº†<code>^sendNext3</code>ï¼›<br><br/></p><p>7.<code>^sendNext3</code>å†…å‘<code>ä¿¡å·2</code>çš„è®¢é˜…è€…å‘é€æ•°æ®<code>2</code>ï¼›<br><br/></p><p>8.ç¤ºä¾‹ä¸­<code>ä¿¡å·2</code>çš„è®¢é˜…è€…æ¥æ”¶åˆ°å›æ¥çš„æ•°æ®<code>2</code>ã€‚<br><br/></p><p>æ—¶åºå›¾æ•´ç†å¦‚ä¸‹ï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_signal_bind2.jpg" alt="ä¿¡å·ç»‘å®šæ—¶åºå›¾"></p><br/><p><strong>å°ç»“</strong>ï¼šä¿¡å·çš„ç»‘å®šç»™äº†æˆ‘ä»¬ä¸€ä¸ªåœ¨å…¶<code>BindBlock</code>ä¸­ä¿®æ”¹æºä¿¡å·è¿”å›å€¼çš„æœºä¼šï¼Œä½†è¿™ä¹ˆç›´æ¥ä½¿ç”¨<code>bind</code>æ˜¾å¾—æœ‰ç‚¹éº»çƒ¦ï¼Œé€šå¸¸åœ¨ä½¿ç”¨RACæ—¶æˆ‘ä»¬éƒ½ä¼šé€‰æ‹©ä¸‹é¢è¿™äº›åŸºäº<code>bind</code>çš„æ›´ä¾¿æ·çš„è¯­æ³•ã€‚</p><h3 id="2-take"><a href="#2-take" class="headerlink" title="2.take"></a>2.take</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">/// Returns a signal of the first `count` values in the receiver. If `count` is</span><br><span class="hljs-comment">/// greater than or equal to the number of values in the signal, a signal</span><br><span class="hljs-comment">/// equivalent to the receiver is returned.</span><br><span class="hljs-operator">-</span> (<span class="hljs-type">RACSignal</span>&lt;<span class="hljs-type">ValueType</span>&gt; <span class="hljs-operator">*</span>)take:(<span class="hljs-type">NSUInteger</span>)count <span class="hljs-type">RAC_WARN_UNUSED_RESULT</span>;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šè¿”å›ä¸€ä¸ªæ–°çš„ä¿¡å·ï¼Œè®¢é˜…ååªæ¥æ”¶æŒ‡å®šçš„<code>å‰Næ¬¡</code>æºä¿¡å·çš„æ•°æ®ã€‚</p><br/><p>#<strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs prolog">- (void)take &#123;<br>    <span class="hljs-symbol">RACSignal</span> *signal1 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;1.1&quot;</span>]; // ç¬¬<span class="hljs-number">1</span>æ¬¡å‘é€æ•°æ®<br>        <br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;1.2&quot;</span>];// ç¬¬<span class="hljs-number">2</span>æ¬¡å‘é€æ•°æ®<br>            //[subscriber sendCompleted];<br>        &#125;];<br>        <br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">5</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;1.3&quot;</span>];// ç¬¬<span class="hljs-number">3</span>æ¬¡å‘é€æ•°æ®<br>            [subscriber sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <br>    [[signal1 take:<span class="hljs-number">2</span>] subscribeNext:^(id x) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++received Value:%@&quot;</span>,x);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">call signal1 block</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:1</span><span class="hljs-string">.</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:1</span><span class="hljs-string">.</span><span class="hljs-comment">2</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶ç¤ºä¾‹ä¸­ä¸‰æ¬¡<code>sendNext:</code>ï¼Œä½†æœ€ç»ˆæ–°ä¿¡å·çš„è®¢é˜…å›è°ƒä¸­åªæ”¶åˆ°äº†å‰ä¸¤æ¬¡çš„æ•°æ®~<br><br/></p><p>#<strong>å®ç°</strong>ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs fortran">- (__kindof RACStream *)take:(NSUInteger)<span class="hljs-built_in">count</span> &#123;<br><span class="hljs-keyword">Class</span> <span class="hljs-keyword">class</span> = self.<span class="hljs-keyword">class</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">count</span> == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span>.empty;<br><br><span class="hljs-keyword">return</span> [[self <span class="hljs-keyword">bind</span>:^&#123;<br>__block NSUInteger taken = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">return</span> ^ id (id <span class="hljs-keyword">value</span>, BOOL *<span class="hljs-keyword">stop</span>) &#123;<br><span class="hljs-keyword">if</span> (taken &lt; <span class="hljs-built_in">count</span>) &#123;<br>++taken;<br><span class="hljs-keyword">if</span> (taken == <span class="hljs-built_in">count</span>) *<span class="hljs-keyword">stop</span> = YES;<br><span class="hljs-keyword">return</span> [<span class="hljs-keyword">class</span> <span class="hljs-keyword">return</span>:<span class="hljs-keyword">value</span>];<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> nil;<br>&#125;<br>&#125;;<br>&#125;] setNameWithFormat:@<span class="hljs-string">&quot;[%@] -take: %lu&quot;</span>, self.<span class="hljs-keyword">name</span>, (unsigned long)<span class="hljs-built_in">count</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>1.<code>take:</code>æ–¹æ³•çš„å†…éƒ¨æ˜¯é€šè¿‡<code>bind</code>æ¥å®ç°çš„ï¼Œæ‰€ä»¥å…¶æ ¸å¿ƒé€»è¾‘ä¹Ÿæ˜¯åœ¨<code>BindBlock</code>ä¸­ï¼›<br><br/></p><p>2.<code>take:</code>æ–¹æ³•çš„å†…éƒ¨æŒæœ‰ä¸€ä¸ªå±€éƒ¨å˜é‡<code>taken</code>ç”¨äºè®¡ç®—<code>BindBlock</code>è¢«è°ƒç”¨äº†å‡ æ¬¡;<br><br/></p><p>3.ä¸Šé¢<code>bind</code>æ–¹æ³•çš„åˆ†æä¸­æåˆ°è¿‡<code>BindBlock</code>çš„è§¦å‘æœºåˆ¶ï¼Œæ‰€ä»¥<code>ä¿¡å·1</code>æ¯å‘é€ä¸€æ¬¡æ•°æ®ï¼Œ<code>taken</code>å°±è‡ªåŠ¨åŠ 1;<br><br/></p><p>4.å½“<code>taken</code>è¶…è¿‡æŒ‡å®šçš„æ¬¡æ•°æ—¶<code>BindBlock</code>è¿”å›ä¸€ä¸ªç©ºä¿¡å·ï¼Œä¸å†ç»§ç»­æ¥æ”¶æ–°æ•°æ®ã€‚<br><br/></p><p><strong>ps</strong>ï¼šå¦‚æœæºä¿¡å·åœ¨ç¬¬Næ¬¡ä¹‹å‰è¢«<code>sendCompleted</code>ï¼Œé‚£ä¹ˆåç»­ä¹Ÿä¸ä¼šå†äº§ç”Ÿæ–°æ•°æ®ã€‚</p><h3 id="3-skip"><a href="#3-skip" class="headerlink" title="3.skip"></a>3.skip</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">/// Skips the first `skipCount` values in the receiver.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns the receiver after skipping the first `skipCount` values. If</span><br><span class="hljs-comment">/// `skipCount` is greater than the number of values in the signal, an empty</span><br><span class="hljs-comment">/// signal is returned.</span><br><span class="hljs-operator">-</span> (<span class="hljs-type">RACSignal</span>&lt;<span class="hljs-type">ValueType</span>&gt; <span class="hljs-operator">*</span>)skip:(<span class="hljs-type">NSUInteger</span>)skipCount <span class="hljs-type">RAC_WARN_UNUSED_RESULT</span>;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šè·³è¿‡<code>å‰Næ¬¡</code>çš„æ•°æ®å›è°ƒã€‚<br><br/></p><p>å®ƒè·Ÿ<code>take</code>æœ‰ç‚¹åç€æ¥çš„æ„æ€~æ‰€ä»¥å¯ä»¥æƒ³è§ï¼Œå®ƒçš„å®ç°é€»è¾‘åˆšå¥½ä¸<code>take</code>ç›¸åã€‚</p><br/><p>#<strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">- (void)skip &#123;<br>    RACSignal *signal1 = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; <span class="hljs-keyword">subscriber) </span>&#123;<br>        NSLog(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [<span class="hljs-keyword">subscriber </span>sendNext:@<span class="hljs-string">&quot;1.1&quot;</span>]<span class="hljs-comment">; // ç¬¬1æ¬¡å‘é€æ•°æ®</span><br>        <br>        [[RACScheduler mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> <span class="hljs-keyword">schedule:^&#123;</span><br><span class="hljs-keyword"></span>            [<span class="hljs-keyword">subscriber </span>sendNext:@<span class="hljs-string">&quot;1.2&quot;</span>]<span class="hljs-comment">; // ç¬¬2æ¬¡å‘é€æ•°æ®</span><br>        &#125;];<br>        <br>        [[RACScheduler mainThreadScheduler] afterDelay:<span class="hljs-number">5</span> <span class="hljs-keyword">schedule:^&#123;</span><br><span class="hljs-keyword"></span>            [<span class="hljs-keyword">subscriber </span>sendNext:@<span class="hljs-string">&quot;1.3&quot;</span>]<span class="hljs-comment">; // ç¬¬3æ¬¡å‘é€æ•°æ®</span><br>            [<span class="hljs-keyword">subscriber </span>sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <br>    [[signal1 skip:<span class="hljs-number">2</span>] <span class="hljs-keyword">subscribeNext:^(id </span>x) &#123;<br>        NSLog(@<span class="hljs-string">&quot;+++received Value:%@&quot;</span>,x);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">call signal1 block</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:1</span><span class="hljs-string">.</span><span class="hljs-comment">3</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—æ˜¾ç¤ºï¼Œè‡ªåŠ¨è·³è¿‡å‰2æ¬¡æ•°æ®ï¼Œåªæ¥æ”¶åˆ°äº†æœ€åä¸€æ¬¡æ•°æ®<code>1.3</code>ã€‚<br><br/></p><p>#<strong>å®ç°</strong>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (__kindof RACStream *)skip:(<span class="hljs-built_in">NSUInteger</span>)skipCount &#123;<br>Class <span class="hljs-keyword">class</span> = <span class="hljs-keyword">self</span>.class;<br><br><span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> bind:^&#123;<br>__block <span class="hljs-built_in">NSUInteger</span> skipped = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">return</span> ^(<span class="hljs-type">id</span> value, <span class="hljs-type">BOOL</span> *stop) &#123;<br><span class="hljs-keyword">if</span> (skipped &gt;= skipCount) <span class="hljs-keyword">return</span> [<span class="hljs-keyword">class</span> <span class="hljs-keyword">return</span>:value];<br><br>skipped++;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span>.empty;<br>&#125;;<br>&#125;] setNameWithFormat:<span class="hljs-string">@&quot;[%@] -skip: %lu&quot;</span>, <span class="hljs-keyword">self</span>.name, (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)skipCount];<br>&#125;<br></code></pre></td></tr></table></figure><p><code>skip</code>çš„å®ç°ä¸<code>take</code>ç›¸ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡<code>BindBlock</code>ä¸­çš„æ•°å€¼å‹å±€éƒ¨å˜é‡æ¥æ§åˆ¶æ¥æ”¶ä¿¡å·çš„æ¬¡æ•°ï¼Œåªä¸è¿‡äºŒè€…é€»è¾‘ç›¸åã€‚</p><h3 id="4-distinctUntilChanged"><a href="#4-distinctUntilChanged" class="headerlink" title="4.distinctUntilChanged"></a>4.distinctUntilChanged</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">/// <span class="hljs-keyword">Returns</span> a signal <span class="hljs-keyword">of</span> <span class="hljs-keyword">values</span> <span class="hljs-keyword">for</span> which -isEqual: <span class="hljs-keyword">returns</span> <span class="hljs-keyword">NO</span> <span class="hljs-keyword">when</span> compared <span class="hljs-keyword">to</span> the<br>/// previous <span class="hljs-keyword">value</span>.<br>- (RACSignal&lt;ValueType&gt; *)distinctUntilChanged RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šè¿‡æ»¤æºä¿¡å·çš„æ•°æ®ï¼Œç›¸åŒçš„æ•°æ®å‡ºç°æ—¶è®¢é˜…è€…ä¸ä¼šæ”¶åˆ°å›è°ƒï¼Œç›´åˆ°ä¸åŒçš„æ•°æ®å‡ºç°ã€‚</p><br/><p>#<strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">- (void)<span class="hljs-keyword">distinct </span>&#123;<br>    RACSignal *signal1 = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; <span class="hljs-keyword">subscriber) </span>&#123;<br>        NSLog(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [<span class="hljs-keyword">subscriber </span>sendNext:@<span class="hljs-string">&quot;1&quot;</span>];<br>        [<span class="hljs-keyword">subscriber </span>sendNext:@<span class="hljs-string">&quot;1&quot;</span>];<br>        [<span class="hljs-keyword">subscriber </span>sendNext:@<span class="hljs-string">&quot;3&quot;</span>];<br>        [<span class="hljs-keyword">subscriber </span>sendCompleted];<br>        return nil;<br>    &#125;];<br>    [[signal1 <span class="hljs-keyword">distinctUntilChanged] </span><span class="hljs-keyword">subscribeNext:^(id </span>x) &#123;<br>        NSLog(@<span class="hljs-string">&quot;+++received Value:%@&quot;</span>,x);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">call signal1 block</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:3</span><br></code></pre></td></tr></table></figure><p>å‰ä¸¤æ¬¡çš„æ•°æ®ç›¸åŒï¼Œæ‰€ä»¥åªæ¥æ”¶äº†ç¬¬1æ¬¡çš„æ•°æ®ï¼Œç¬¬2æ¬¡æ•°æ®è‡ªåŠ¨è¿‡æ»¤æ‰äº†~<br><br/></p><p>#<strong>å®ç°</strong>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (__kindof RACStream *)distinctUntilChanged &#123;<br>Class <span class="hljs-keyword">class</span> = <span class="hljs-keyword">self</span>.class;<br><br><span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> bind:^&#123;<br>__block <span class="hljs-type">id</span> lastValue = <span class="hljs-literal">nil</span>;<br>__block <span class="hljs-type">BOOL</span> initial = <span class="hljs-literal">YES</span>;<br><br><span class="hljs-keyword">return</span> ^(<span class="hljs-type">id</span> x, <span class="hljs-type">BOOL</span> *stop) &#123;<br><span class="hljs-keyword">if</span> (!initial &amp;&amp; (lastValue == x || [x isEqual:lastValue])) <span class="hljs-keyword">return</span> [<span class="hljs-keyword">class</span> empty];<br><br>initial = <span class="hljs-literal">NO</span>;<br>lastValue = x;<br><span class="hljs-keyword">return</span> [<span class="hljs-keyword">class</span> <span class="hljs-keyword">return</span>:x];<br>&#125;;<br>&#125;] setNameWithFormat:<span class="hljs-string">@&quot;[%@] -distinctUntilChanged&quot;</span>, <span class="hljs-keyword">self</span>.name];<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>BindBlock</code>ä¸­å°†å½“å‰æ•°æ®ä¸ä¸Šæ¬¡è¿”å›çš„æ•°æ®å¯¹æ¯”ï¼Œæ•°æ®çš„åœ°å€ç›¸åŒæˆ–è€…<code>isEqual</code>è¿”å›<code>YES</code>æ—¶ï¼Œåˆ™è¿”å›ç©ºä¿¡å·ï¼›å¦åˆ™æ­£å¸¸æ¥æ”¶ã€‚<br><br/></p><p><strong>ps</strong>ï¼šå½“ä½¿ç”¨è‡ªå®šä¹‰çš„å¯¹è±¡ç±»å‹æ—¶ä½ å¯èƒ½éœ€è¦é‡å†™å…¶<code>isEqual</code>æ–¹æ³•ã€‚</p><h3 id="5-flattenMap"><a href="#5-flattenMap" class="headerlink" title="5.flattenMap"></a>5.flattenMap</h3><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">/// Maps `block` across the values in the receiver and flattens the result.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Note that operators applied _after_ -flattenMap: behave differently from</span><br><span class="hljs-comment">/// operators _within_ -flattenMap:. See the Examples section below.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This corresponds to the `SelectMany` method in Rx.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// block - A block which accepts the values in the receiver and returns a new</span><br><span class="hljs-comment">///         instance of the receiver&#x27;s class. Returning `nil` from this block is</span><br><span class="hljs-comment">///         equivalent to returning an empty signal.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Examples</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">///   [signal flattenMap:^(id x) &#123;</span><br><span class="hljs-comment">///       // Logs each time a returned signal completes.</span><br><span class="hljs-comment">///       return [[RACSignal return:x] logCompleted];</span><br><span class="hljs-comment">///   &#125;];</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">///   [[signal</span><br><span class="hljs-comment">///       flattenMap:^(id x) &#123;</span><br><span class="hljs-comment">///           return [RACSignal return:x];</span><br><span class="hljs-comment">///       &#125;]</span><br><span class="hljs-comment">///       // Logs only once, when all of the signals complete.</span><br><span class="hljs-comment">///       logCompleted];</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a new signal which represents the combined signals resulting from</span><br><span class="hljs-comment">/// mapping `block`.</span><br>- (RACSignal *)flattenMap:(<span class="hljs-variable">__kindof</span> RACSignal * <span class="hljs-variable">_Nullable</span> (^)(ValueType <span class="hljs-variable">_Nullable</span> value))block RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šå°†æºä¿¡å·çš„æ•°æ®æ˜ å°„æˆæ–°çš„<code>ä¿¡å·</code>ï¼Œå³æ ¹æ®æºä¿¡å·çš„æ•°æ®ç”Ÿæˆæ–°çš„<code>ä¿¡å·</code>ã€‚<br><br/></p><p>#<strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)RACBinder&#123;<br>    @weakify(<span class="hljs-keyword">self</span>);<br>    <br>    <span class="hljs-comment">//è®¾ç½®è¿”å›æŒ‰é’®</span><br>    <span class="hljs-built_in">UIButton</span> *btn1 = [<span class="hljs-built_in">UIButton</span> buttonWithType:<span class="hljs-built_in">UIButtonTypeCustom</span>];<br>    [btn1 setTitleColor:[<span class="hljs-built_in">UIColor</span> whiteColor] forState:<span class="hljs-built_in">UIControlStateNormal</span>];<br>    [btn1 setTitle:<span class="hljs-string">@&quot;è¿”å›&quot;</span> forState:<span class="hljs-built_in">UIControlStateNormal</span>];<br>    [btn1 sizeToFit];<br>    <span class="hljs-keyword">self</span>.navigationItem.leftBarButtonItem = [[<span class="hljs-built_in">UIBarButtonItem</span> alloc] initWithCustomView:btn1];<br>    <br>    <span class="hljs-comment">//æ·»åŠ ç‚¹å‡»äº‹ä»¶é€»è¾‘</span><br>    [[[btn1 rac_signalForControlEvents:<span class="hljs-built_in">UIControlEventTouchUpInside</span>] <span class="hljs-comment">// btnSignal</span><br>      flattenMap:^RACSignal *(<span class="hljs-built_in">UIControl</span> *value) &#123; <span class="hljs-comment">// flattenMapBlock</span><br>          <br>          RACSignal *signal2 = [RACSignal createSignal:^RACDisposable *(<span class="hljs-type">id</span>&lt;RACSubscriber&gt; subscriber) &#123;<br>              @strongify(<span class="hljs-keyword">self</span>);<span class="hljs-comment">//ä¸€å®šè¦å¼ºå¼•ç”¨ä¸€ä¸‹ï¼Œå¦åˆ™VCä¸ä¼šé”€æ¯</span><br>              [<span class="hljs-keyword">self</span>.navigationController popViewControllerAnimated:<span class="hljs-literal">YES</span>];<br>              [subscriber sendNext:<span class="hljs-string">@&quot;++Poped~&quot;</span>];<br>              [subscriber sendCompleted];<br>              <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>          &#125;];<br>        <span class="hljs-keyword">return</span> signal2;<br>    &#125;] <br>    subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++Mess:%@&quot;</span>,x);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ”¶åˆ°æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶åï¼Œè®¢é˜…æ–°çš„<code>ä¿¡å·2</code>ä»¥å¤„ç†å¯¼èˆªå™¨çš„<code>pop</code>æ“ä½œï¼Œä¹‹åå‘å‡ºä¸€æ¡å·²å®Œæˆçš„æ¶ˆæ¯ã€‚<br><br/></p><p>#<strong>å®ç°</strong>ï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ruby">- (__kindof RACStream *)<span class="hljs-symbol">flattenMap:</span>(__kindof RACStream * (^)(id value))block &#123;<br>Class <span class="hljs-keyword">class</span> = <span class="hljs-variable language_">self</span>.<span class="hljs-keyword">class</span>;<br><br><span class="hljs-keyword">return</span> [[<span class="hljs-variable language_">self</span> <span class="hljs-symbol">bind:</span>^&#123;<br><span class="hljs-keyword">return</span> ^(id value, <span class="hljs-variable constant_">BOOL</span> *stop) &#123;<br>id stream = block(value) <span class="hljs-string">?:</span> [<span class="hljs-keyword">class</span> empty];<br>NSCAssert([stream <span class="hljs-symbol">isKindOfClass:</span>RACStream.<span class="hljs-keyword">class</span>], @<span class="hljs-string">&quot;Value returned from -flattenMap: is not a stream: %@&quot;</span>, stream);<br><br><span class="hljs-keyword">return</span> stream;<br>&#125;;<br>&#125;] <span class="hljs-symbol">setNameWithFormat:</span>@<span class="hljs-string">&quot;[%@] -flattenMap:&quot;</span>, <span class="hljs-variable language_">self</span>.name];<br>&#125;<br></code></pre></td></tr></table></figure><p>1.<code>flattenMap</code>ä¹Ÿæ˜¯ç”±<code>bind</code>å®ç°çš„ï¼Œ<code>btnSignal</code>è°ƒç”¨äº†<code>flattenMap</code>ä¹Ÿå°±æ˜¯è°ƒç”¨äº†<code>bind</code>ï¼Œä¹‹åå°±äº¤ç»™<code>bind</code>æ¥å¤„ç†ï¼›<br><br/></p><p>2.<code>bind</code>å…ˆåœ¨<code>BindBlock</code>ä¸­è°ƒç”¨äº†<code>block(value)</code>ï¼Œè¿™é‡Œçš„<code>block</code>å°±æ˜¯<code>flattenMapBlock</code>ï¼›<code>value</code>å°±æ˜¯æºä¿¡å·å‘é€çš„æ•°æ®ï¼Œå³<code>btn1</code>ï¼›è¿”å›å€¼æ˜¯æˆ‘ä»¬å®šä¹‰å¥½çš„å¤„ç† pop ä¸šåŠ¡çš„<code>ä¿¡å·2</code><br><br/></p><p>3.æ ¹æ®ä¹‹å‰ä»‹ç»çš„<code>bind</code>æ—¶åºå›¾å¯çŸ¥ï¼Œ<code>ä¿¡å·2</code>è¢«<code>BindBlock</code>è¿”å›ä¹‹åå³è¢«è®¢é˜…ï¼Œç»§è€Œå¼€å§‹æ‰§è¡Œå…¶<code>^didSubscribe</code>ä¸­çš„ pop ä»»åŠ¡ï¼›<br><br/></p><p>4.popä¹‹å<code>^didSubscribe</code>å‘é€å·²å®Œæˆçš„æ¶ˆæ¯ï¼Œè®¢é˜…è€…æ”¶åˆ°æ•°æ®å›è°ƒï¼Œæ•´ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚<br><br/></p><p><strong>å°ç»“</strong>ï¼š<code>flattenMap</code>çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ¥æ”¶æºä¿¡å·çš„æ•°æ®ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¤„ç†ä¸šåŠ¡çš„æ–°<code>ä¿¡å·</code>ã€‚</p><h3 id="6-map"><a href="#6-map" class="headerlink" title="6.map"></a>6.map</h3><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">/// Maps `block` across the values in the receiver.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This corresponds to the `Select` method in Rx.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a new signal with the mapped values.</span><br>- (RACSignal *)map:(id <span class="hljs-variable">_Nullable</span> (^)(ValueType <span class="hljs-variable">_Nullable</span> value))block RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šå°†æºä¿¡å·çš„æ•°æ®æ˜ å°„æˆæ–°çš„<code>æ•°æ®</code>ï¼Œå³æ ¹æ®æºä¿¡å·çš„æ•°æ®ç”Ÿæˆæ–°çš„<code>æ•°æ®</code>ã€‚<br><br/></p><p><strong>#ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)map &#123;<br><br>    <span class="hljs-comment">//è®¾ç½®åˆ·æ–°æŒ‰é’®</span><br>    <span class="hljs-built_in">UIButton</span> *btn2 = [<span class="hljs-built_in">UIButton</span> buttonWithType:<span class="hljs-built_in">UIButtonTypeCustom</span>];<br>    [btn2 setTitleColor:[<span class="hljs-built_in">UIColor</span> whiteColor] forState:<span class="hljs-built_in">UIControlStateNormal</span>];<br>    [btn2 setTitle:<span class="hljs-string">@&quot;åˆ·æ–°&quot;</span> forState:<span class="hljs-built_in">UIControlStateNormal</span>];<br>    [btn2 sizeToFit];<br>    <br>    <span class="hljs-keyword">self</span>.navigationItem.rightBarButtonItem = [[<span class="hljs-built_in">UIBarButtonItem</span> alloc] initWithCustomView:btn2];<br>    <br>    <span class="hljs-comment">//åˆ›å»ºä¿¡å· ç›‘å¬åˆ·æ–°çŠ¶æ€</span><br>    RACSignal *mEnableSignal = [RACObserve(<span class="hljs-keyword">self</span>.mViewModel, isRefresh)<br>                                map:^<span class="hljs-type">id</span> (<span class="hljs-type">id</span> value) &#123; <span class="hljs-comment">// mapBlock</span><br>                                    <span class="hljs-keyword">return</span> @(![value boolValue]); <span class="hljs-comment">// å¯¹åˆ·æ–°çŠ¶æ€å–å</span><br>    &#125;];<br>    <br>    btn2.rac_command = [[RACCommand alloc] initWithEnabled:mEnableSignal<br>                                               signalBlock:^RACSignal *(<span class="hljs-type">id</span> input) &#123;<br>                                                   @strongify(<span class="hljs-keyword">self</span>);<br>                                                   <span class="hljs-comment">//business</span><br>                                                   [<span class="hljs-keyword">self</span>.mRrefreshControl endRefreshing];<br>                                                   RACSignal *signalFetch = [RACSignal createSignal:^RACDisposable *(<span class="hljs-type">id</span>&lt;RACSubscriber&gt; subscriber) &#123;<br>                                                       <span class="hljs-comment">//å£°æ˜è¯·æ±‚å‚æ•°</span><br>                                                       RACTuple *paramsTuple = [RACTuple tupleWithObjects:@(<span class="hljs-number">1</span>),@(<span class="hljs-number">20</span>), <span class="hljs-literal">nil</span>];<span class="hljs-comment">//å…ƒç»„ç¬¬ä¸€ä¸ªå¯¹è±¡è¡¨ç¤ºé¡µç ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºæ¯é¡µæ•°é‡</span><br>                                                       <span class="hljs-comment">//å‘èµ·è¯·æ±‚</span><br>                                                       [<span class="hljs-keyword">self</span>.mRrefreshControl beginRefreshing];<br>                                                       [<span class="hljs-keyword">self</span>.mViewModel.fetchCommand execute:paramsTuple];<br>                                                       [subscriber sendCompleted];<br>                                                       <br>                                                       <span class="hljs-keyword">return</span> [RACDisposable disposableWithBlock:^&#123;<br>                                                       &#125;];<br>                                                   &#125;];<br>                                                   <span class="hljs-keyword">return</span> signalFetch;<br>                                               &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>1.ç¤ºä¾‹ä¸­åˆ›å»º<code>RACCommand</code>æ—¶éœ€è¦ä¸€ä¸ªæ§åˆ¶å…¶æ˜¯å¦æ‰§è¡Œçš„ä¿¡å·<code>EnableSignal</code>ï¼›<br><br/></p><p>2.é€šè¿‡<code>RACObserve()</code>å®ç›‘å¬äº†<code>VM</code>ä¸­è¡¨ç¤ºæ˜¯å¦åœ¨åˆ·æ–°çš„å±æ€§<code>isRefresh</code>ï¼Œæ­¤ç›‘å¬æ“ä½œä¼šè¿”å›ä¸€ä¸ªä¿¡å·ï¼Œå–å<code>ä¿¡å·1</code>å§ï¼›<br><br/></p><p>3.å½“VMä¸­<code>isRefresh</code>çš„å€¼å˜åŒ–åï¼Œ<code>ä¿¡å·1</code>ä¼šæ”¶åˆ°å›è°ƒå¹¶åœ¨<code>map</code>å†…å¯¹å…¶å€¼å–åï¼Œå³åˆ·æ–°æ—¶å›æŠ›<code>NO</code>ï¼Œä¸åˆ·æ–°æ—¶å›æŠ›<code>YES</code>ã€‚<br><br/></p><p>#<strong>å®ç°</strong>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (__kindof RACStream *)map:(<span class="hljs-type">id</span> (^)(<span class="hljs-type">id</span> value))block &#123;<br><span class="hljs-built_in">NSCParameterAssert</span>(block != <span class="hljs-literal">nil</span>);<br><br>Class <span class="hljs-keyword">class</span> = <span class="hljs-keyword">self</span>.class;<br><br><span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> flattenMap:^(<span class="hljs-type">id</span> value) &#123; <span class="hljs-comment">// flattenMapBlock</span><br><span class="hljs-comment">//block(value)è¿”å›ä¿®æ”¹ä¹‹åçš„æ–°å€¼ï¼Œç„¶åä½œä¸ºå‚æ•°ä¼ å…¥è¿”å›çš„RACReturnSignalä¸­</span><br><span class="hljs-keyword">return</span> [<span class="hljs-keyword">class</span> <span class="hljs-keyword">return</span>:block(value)]; <br>&#125;] setNameWithFormat:<span class="hljs-string">@&quot;[%@] -map:&quot;</span>, <span class="hljs-keyword">self</span>.name];<br>&#125;<br></code></pre></td></tr></table></figure><p>1.é¦–å…ˆï¼Œæºä¿¡å·è°ƒç”¨<code>map</code>åï¼Œå…¶åº•å±‚è°ƒç”¨äº†<code>flattenMap</code>å¹¶è¿”å›ä¸€ä¸ªæ–°çš„ä¿¡å·ï¼Œå³<code>mEnableSignal</code>ï¼›<br><br/></p><p>2.<code>flattenMap</code>çš„<code>flattenMapBlock</code>è¿”å›å€¼ä¸ºä¸€ä¸ª<code>RACReturnSignal</code>ç±»å‹çš„ä¿¡å·ï¼›<br><br/></p><p>3.æ­¤ä¿¡å·çš„å‚æ•°é€šè¿‡<code>block(value)</code>è·å–ï¼Œå³æˆ‘ä»¬åœ¨ç¤ºä¾‹çš„<code>map</code>æ–¹æ³•ä¸­å®šä¹‰çš„å–åçš„é‚£ä¸ª<code>mapBlock</code>ï¼Œè¿”å›ä¿®æ”¹åçš„æ•°æ®ã€‚<br><br/></p><p>4.<code>bind</code>æ–¹æ³•çš„<code>BindBlock</code>è·å–åˆ°<code>RACReturnSignal</code>ä¿¡å·åéšå³è®¢é˜…å®ƒï¼›<br><br/></p><p>5.<code>RACReturnSignal</code>è¢«è®¢é˜…åç«‹åˆ»å‘<code>mEnableSignal</code>çš„è®¢é˜…è€…å‘é€äº†ä¿®æ”¹åçš„æ•°æ®ã€‚<br><br/></p><p><strong>å°ç»“</strong>ï¼š<code>map</code>çš„ä¸»è¦ä½œç”¨å°±æ˜¯å¯¹æºä¿¡å·å‘é€çš„æ•°æ®è¿›è¡Œè½¬æ¢ï¼Œä»è€Œè¿”å›ä¸€ä¸ªæ–°çš„<code>æ•°æ®</code>ã€‚</p><hr><p>åŒºåˆ† map ä¸ flattenMapï¼š</p><ul><li>map çš„ block ä¸­è¿”å›çš„æ˜¯ä¿®æ”¹åçš„æ–°æ•°æ®ï¼›</li><li>flattenMap çš„ block ä¸­è¿”å›çš„æ˜¯å¤„ç†åç»­ä¸šåŠ¡çš„æ–°ä¿¡å·ï¼›</li><li>map çš„åº•å±‚è°ƒç”¨äº† flattenMapã€‚</li></ul><p>ç†è§£äº†è¿™äº›åŒºåˆ«ï¼Œå°±èƒ½æ›´å¥½çš„åŒºåˆ†äºŒè€…çš„ä½¿ç”¨åœºæ™¯äº†~</p><h3 id="7-filter"><a href="#7-filter" class="headerlink" title="7.filter"></a>7.filter</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/// Filters out values in the receiver that don&#x27;t pass the given test.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This corresponds to the `Where` method in Rx.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a new signal with only those values that passed.</span><br>- (RACSignal&lt;ValueType&gt; *)<span class="hljs-attribute">filter</span>:(BOOL (^)(ValueType _Nullable value))block RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šè¿‡æ»¤ä¿¡å·çš„æ•°æ®ï¼Œåªæœ‰æ¡ä»¶ä¸º<code>YES</code>æ—¶è®¢é˜…è€…æ‰ä¼šæ”¶åˆ°æ•°æ®ã€‚</p><br/><p>#<strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-operator">-</span> (<span class="hljs-variable">void</span>)<span class="hljs-title function_">filter</span> &#123;<br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">signal1</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@(<span class="hljs-number">1</span>)];<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@(<span class="hljs-number">2</span>)];<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@(<span class="hljs-number">3</span>)];<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nil</span>;<br>    &#125;];<br>    [[<span class="hljs-variable">signal1</span> <span class="hljs-variable">filter</span>:<span class="hljs-operator">^</span><span class="hljs-title function_">BOOL</span>(<span class="hljs-params">NSNumber</span> *<span class="hljs-params">value</span>) &#123; <span class="hljs-comment">// filterBlock</span><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">value</span> intValue] <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// æ¡ä»¶è¡¨è¾¾å¼</span><br>    &#125;] <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++received Value:%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">call signal1 block</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:3</span><br></code></pre></td></tr></table></figure><p>è‡ªåŠ¨è¿‡æ»¤äº†å°äº1çš„æ•°æ®ã€‚<br><br/></p><p>#<strong>å®ç°</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">- (__kindof RACStream *)<span class="hljs-built_in">filter</span>:(BOOL (^)(<span class="hljs-built_in">id</span> value))block &#123;<br>NSCParameterAssert(block != nil);<br><br>Class <span class="hljs-keyword">class</span> = self.<span class="hljs-keyword">class</span>;<br><br><span class="hljs-keyword">return</span> [[self flattenMap:^ <span class="hljs-built_in">id</span> (<span class="hljs-built_in">id</span> value) &#123;<br><span class="hljs-keyword">if</span> (block(value)) &#123;<br><span class="hljs-keyword">return</span> [<span class="hljs-keyword">class</span> <span class="hljs-title class_">return</span>:value];<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span>.empty;<br>&#125;<br>&#125;] setNameWithFormat:@<span class="hljs-string">&quot;[%@] -filter:&quot;</span>, self.name];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ”¶åˆ°æºä¿¡å·å‘é€çš„æ•°æ®æ—¶ï¼Œ<code>BindBlock</code>ä¸­è°ƒç”¨<code>block(value)</code>ï¼Œå³<code>filterBlock</code>ä¸­çš„é€»è¾‘ï¼Œå»åˆ¤æ–­æ•°æ®æ˜¯å¦æ»¡è¶³æŒ‡å®šçš„æ¡ä»¶ã€‚<br><br/></p><p><code>filterBlock</code>çš„è¿”å›å€¼ä¸º<code>BOOl</code>å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨å…¶<code>return</code>åå®šä¹‰ä¸€ä¸ªè¿”å›<code>BOOL</code>ç±»å‹çš„è¡¨è¾¾å¼å³å¯~</p><h3 id="8-ignore"><a href="#8-ignore" class="headerlink" title="8.ignore"></a>8.ignore</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-comment">/// Filters out values in the receiver that equal (via -isEqual:) the provided</span><br><span class="hljs-comment">/// value.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// value - The value can be `nil`, in which case it ignores `nil` values.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a new signal containing only the values which did not compare equal</span><br><span class="hljs-comment">/// to `value`.</span><br>- (RACSignal&lt;ValueType&gt; *)ignore:(<span class="hljs-literal">null</span>able ValueType)value RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šè¿‡æ»¤æ‰æºä¿¡å·å‘é€çš„ç‰¹å®šæ•°æ®ã€‚</p><br/><p>#<strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(void)</span>ignore &#123;<br>    RACSignal *signal1 = [RACSignal createSignal:^RACDisposable *<span class="hljs-params">(id&lt;RACSubscriber&gt; subscriber)</span> &#123;<br>        NSLog<span class="hljs-params">(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>)</span>;<br>        [subscriber sendNext:@<span class="hljs-params">(<span class="hljs-number">1</span>)</span>];<br>        [subscriber sendNext:@<span class="hljs-params">(<span class="hljs-number">2</span>)</span>];<br>        [subscriber sendNext:@<span class="hljs-params">(<span class="hljs-number">3</span>)</span>];<br>        [subscriber sendCompleted];<br>        return nil;<br>    &#125;];<br>    [[signal1 ignore:@<span class="hljs-params">(<span class="hljs-number">2</span>)</span>] subscribeNext:^<span class="hljs-params">(id x)</span> &#123;<br>        NSLog<span class="hljs-params">(@<span class="hljs-string">&quot;+++received Value:%@&quot;</span>,x)</span>;<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">call signal1 block</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">received Value:3</span><br></code></pre></td></tr></table></figure><p>åªæ¥æ”¶ä¸ä¸º2çš„æ•°æ®ã€‚<br><br/></p><p>#<strong>å®ç°</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">- (__kindof RACStream *)ignore:(<span class="hljs-built_in">id</span>)value &#123;<br><span class="hljs-keyword">return</span> [[self <span class="hljs-built_in">filter</span>:^ BOOL (<span class="hljs-built_in">id</span> innerValue) &#123;<br><span class="hljs-keyword">return</span> innerValue != value &amp;&amp; ![innerValue isEqual:value];<br>&#125;] setNameWithFormat:@<span class="hljs-string">&quot;[%@] -ignore: %@&quot;</span>, self.name, RACDescription(value)];<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å†…éƒ¨æ˜¯é€šè¿‡<code>filter</code>å®ç°çš„ï¼Œåœ¨<code>filter</code>çš„æ¡ä»¶è¡¨è¾¾å¼ä¸­å°†ä¿¡å·è¿”å›çš„æ•°æ®ä¸æˆ‘ä»¬æŒ‡å®šçš„å€¼è¿›è¡Œäº†å¯¹æ¯”ï¼Œç›¸åŒæ—¶è‡ªåŠ¨è¿‡æ»¤æ‰~</p><h3 id="9-reduce"><a href="#9-reduce" class="headerlink" title="9.reduce"></a>9.reduce</h3><p><strong>ä½œç”¨</strong>ï¼šèšåˆï¼ŒæŠŠå¤šä¸ªä¿¡å·è¿”å›çš„æ•°æ®èšåˆåˆ°ä¸€å¤„ï¼Œä»¥ä¾¿å¯¹è¿™äº›å€¼è¿›è¡Œç›¸å…³å¤„ç†ã€‚<br><br/></p><p>æ­¤æ–¹æ³•å«èšåˆï¼Œæ‰€ä»¥å¯ä»¥æƒ³è±¡å…ˆè¦æœ‰æ•°æ®éœ€è¦å®ƒå»æ•´åˆï¼Œè¿™äº›æ•°æ®æ˜¯ç‹¬ç«‹çš„ä¿¡å·ä»¬å‘å‡ºçš„ã€‚<br><br/></p><p>ä¿¡å·ä¸­å¹¶æ²¡æœ‰å•ç‹¬çš„<code>reduce</code>æ–¹æ³•ï¼Œå®ƒé€šå¸¸æ˜¯ä¸å…¶ä»–ç»„åˆä¿¡å·çš„æ–¹æ³•ç»“åˆä½¿ç”¨çš„ã€‚ä»¥<code>combineLatest</code>ä¸ºä¾‹ï¼š</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">/// Combines signals using +combineLatest:, then reduces the resulting tuples</span><br><span class="hljs-comment">/// into a single value using -reduceEach:.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// signals     - The signals to combine. If this collection is empty, the</span><br><span class="hljs-comment">///               returned signal will immediately complete upon subscription.</span><br><span class="hljs-comment">/// reduceBlock - The block which reduces the latest values from all the</span><br><span class="hljs-comment">///               signals into one value. It must take as many arguments as the</span><br><span class="hljs-comment">///               number of signals given. Each argument will be an object</span><br><span class="hljs-comment">///               argument. The return value must be an object. This argument</span><br><span class="hljs-comment">///               must not be nil.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Example:</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">///   [RACSignal combineLatest:@[ stringSignal, intSignal ] reduce:^(NSString *string, NSNumber *number) &#123;</span><br><span class="hljs-comment">///       return [NSString stringWithFormat:@&quot;%@: %@&quot;, string, number];</span><br><span class="hljs-comment">///   &#125;];</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a signal which sends the results from each invocation of</span><br><span class="hljs-comment">/// `reduceBlock`.</span><br>+ (RACSignal&lt;ValueType&gt; *)combineLatest:(id&lt;NSFastEnumeration&gt;)signals <span class="hljs-built_in">reduce</span>:(RACGenericReduceBlock)reduceBlock RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p><code>combineLatest</code>å°†ä¸¤ä¸ªä¿¡å·ç»„åˆæˆäº†ä¸€ä¸ªæ–°çš„ä¿¡å·ï¼Œæ–°ä¿¡å·è¿”å›çš„æ•°æ®æ˜¯ä¸€ä¸ªå…ƒç»„ã€‚<br><br/></p><p><code>reduce</code>æ˜¯å¯¹å…ƒç»„ä¸­çš„æ•°æ®è¿›è¡Œäº†èšåˆï¼Œè¿”å›å€¼ä¸ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²æ•°æ®å¯¹è±¡ã€‚<br><br/></p><p><code>reduce</code>ä¸­èšåˆçš„æ•°æ®çš„æ•°é‡å’Œç±»å‹ä¸æºä¿¡å·çš„æ•°é‡å’Œæ•°æ®ç±»å‹ä¿æŒä¸€è‡´ã€‚<br><br/></p><p><strong>ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-operator">-</span> (<span class="hljs-variable">void</span>)<span class="hljs-title function_">reduce</span> &#123;<br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">signal1</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;1&quot;</span>];<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nil</span>;<br>    &#125;];<br>    <br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">signal2</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++call signal2 block&quot;</span>);<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;2.1&quot;</span>];<br>        [[<span class="hljs-title class_">RACScheduler</span> <span class="hljs-variable">mainThreadScheduler</span>] <span class="hljs-variable">afterDelay</span>:<span class="hljs-number">2</span> <span class="hljs-variable">schedule</span>:<span class="hljs-operator">^</span>&#123;<br>            [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;2.2&quot;</span>];<br>            [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>        &#125;];<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nil</span>;<br>    &#125;];<br>    <br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">signal3</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">combineLatest</span>:@[<span class="hljs-variable">signal1</span>,<span class="hljs-variable">signal2</span>]<br>                                           <span class="hljs-variable">reduce</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">NSString</span> *<span class="hljs-params">str1</span>, <span class="hljs-params">NSString</span> *<span class="hljs-params">str2</span>)&#123; <span class="hljs-comment">// reduceBlock</span><br>                                               <span class="hljs-keyword">return</span> [@[<span class="hljs-variable">str1</span>,<span class="hljs-variable">str2</span>] <span class="hljs-variable">componentsJoinedByString</span>:@<span class="hljs-string">&quot;+&quot;</span>];<br>                                           &#125;];<br>    <br>    [<span class="hljs-variable">signal3</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++++received data:%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fortran">+++<span class="hljs-keyword">call</span> signal1 <span class="hljs-keyword">block</span><br>+++<span class="hljs-keyword">call</span> signal2 <span class="hljs-keyword">block</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">1</span>+<span class="hljs-number">2.1</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">1</span>+<span class="hljs-number">2.2</span><br></code></pre></td></tr></table></figure><p>1.<code>combineLatest</code>å°†<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>è¿›è¡Œäº†æ•´åˆï¼Œå½“äºŒè€…éƒ½å‘é€æ•°æ®åï¼Œè¿™ä¿©æ•°æ®è¢«æ•´åˆè¿›ä¸€ä¸ªå…ƒç»„ä¸­ï¼›<br><br/></p><p>2.<code>reduce</code>å°†å…ƒç»„ä¸­çš„æ•°æ®èšåˆåˆ°äº†å®ƒçš„<code>reduceBlock</code>ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬ä¾¿æœ‰æœºä¼šå¯¹è¿™äº›æ•°æ®åšè¿›ä¸€æ­¥çš„è¿‡æ»¤å’Œè½¬æ¢ã€‚<br><br/></p><p>3.å¤„ç†å®Œçš„æ–°æ•°æ®ä¼šå›è°ƒç»™<code>ä¿¡å·3</code>çš„è®¢é˜…è€…ã€‚<br><br/></p><p><strong>å°ç»“</strong>ï¼šä¿¡å·è™½æ— ç‹¬ç«‹çš„<code>reduce</code>æ–¹æ³•ï¼Œä½†å®ƒä¸ä¿¡å·çš„ç»„åˆç»“åˆæ—¶ï¼Œä¾¿ç»™äº†æˆ‘ä»¬ä¿®æ”¹æ•°æ®çš„æœºä¼šï¼Œè¿™å°±æ˜¯æˆ‘æŠŠå®ƒåˆ—å…¥æœ¬ç« èŠ‚çš„åŸå› ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¯¹ä½¿ç”¨è€…æ¥è¯´ï¼ŒRACçš„è¿™äº›æ–¹æ³•å¯è¯´æ˜¯å¾ˆç®€å•äº†ï¼Œè€Œè¿™å…¨ä»°ä»—<code>bind</code>æ–¹æ³•ï¼Œæ‰€ä»¥ç†è§£<code>bind</code>å¾ˆå…³é”®ã€‚<br><br/></p><p>æœ€åº•å±‚çš„<code>bidn</code>æ–¹æ³•å®šä¹‰åœ¨<code>RACStream</code>ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºç±»ï¼Œå…¶å†…éƒ¨å¯¹<code>bind</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (__kindof RACStream *)bind:(RACStreamBindBlock (^)(<span class="hljs-type">void</span>))block &#123;<br><span class="hljs-built_in">NSString</span> *reason = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;%@ must be overridden by subclasses&quot;</span>, <span class="hljs-built_in">NSStringFromSelector</span>(_cmd)];<br><span class="hljs-keyword">@throw</span> [<span class="hljs-built_in">NSException</span> exceptionWithName:<span class="hljs-built_in">NSInternalInconsistencyException</span> reason:reason userInfo:<span class="hljs-literal">nil</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™åªæ˜¯ä¸€ä¸ªæŠ½è±¡çš„å®ç°ï¼Œå…·ä½“çš„å®ç°æ–¹å¼äº¤ç»™äº†å®ƒçš„å„ä¸ªå­ç±»ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_rac_cluster.png" alt="RACç±»ç°‡"></p><p>è¿™å¾ˆå¥½çš„ä½“ç°äº†<code>ç±»ç°‡</code>çš„æ€æƒ³ï¼Œå€¼å¾—å­¦ä¹ å€Ÿé‰´~<br><br/></p><p>å¦å¤–<code>map</code>ã€<code>filter</code>ã€<code>reduce</code>è¿™å‡ ä¸ªæ–¹æ³•åœ¨ Swift ä¸­éƒ½æœ‰åŒåæ–¹æ³•ï¼Œä¼¼ä¹RACä¹Ÿå€Ÿé‰´äº†<code>Swift</code>æˆ–è€…<code>RX</code>çš„ä¸€äº›ç†å¿µã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/ReactiveCocoa/ReactiveObjC">Â©RAC-Github</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RAC-ä¿¡å·çš„ç»„åˆ</title>
    <link href="/2021/06/01/RAC-sig-order.html"/>
    <url>/2021/06/01/RAC-sig-order.html</url>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>é¡¹ç›®ä¸­å¾€å¾€æœ‰å¤šä¸ª<code>ä¿¡å·</code>åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œè€Œè¿™äº›ä¿¡å·ä¹‹é—´é€šå¸¸è¦æŒ‰ç…§ä¸€å®šçš„æ–¹å¼æˆ–é¡ºåºè¿›è¡Œ<code>ç»„åˆ</code>ã€‚æ¯”å¦‚ï¼š</p><ul><li>å…ˆè¦ç”¨æˆ·ç™»å½•æˆåŠŸæ‰èƒ½åŠ è½½é€šè®¯å½•ï¼›</li><li>è¯·æ±‚å¤´åƒå’Œç”¨æˆ·ä¿¡æ¯éƒ½å®Œæˆåæ‰åˆ·æ–°è¯¦æƒ…é¡µã€‚</li></ul><p>RAC é’ˆå¯¹è¯¸å¦‚è¿™äº›åœºæ™¯ï¼Œè®¾è®¡äº†ä¸€å¥—å®ç”¨çš„APIä¾›æˆ‘ä»¬ç»„åˆä¿¡å·ï¼š</p><h3 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h3><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">/// Subscribes <span class="hljs-keyword">to</span> `<span class="hljs-keyword">signal</span>` <span class="hljs-keyword">when</span> the source <span class="hljs-keyword">signal</span> completes.<br>- (RACSignal *)concat:(RACSignal *)<span class="hljs-keyword">signal</span> RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨:</strong> æ‹¼æ¥ä¿¡å·æµï¼Œå°†<code>ä¿¡å·1</code>ä¸<code>ä¿¡å·2</code>æ‹¼æ¥æˆæ–°çš„ä¿¡å·ï¼Œ<code>ä¿¡å·1</code>çŠ¶æ€ä¸ºå®Œæˆçš„æ—¶å€™æ‰å¼€å§‹æ‰§è¡Œ<code>ä¿¡å·2</code>ä¸­çš„ä»»åŠ¡ã€‚æ— è®º<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>è°å…ˆå‘é€æ•°æ®ï¼Œæ–°ä¿¡å·çš„è®¢é˜…è€…æœ€ç»ˆéƒ½åªä¼šæŒ‰<code>ä¿¡å·1</code>å…ˆ<code>ä¿¡å·2</code>åçš„é¡ºåºæ”¶åˆ°å›è°ƒã€‚<br><br/></p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs prolog">- (void)concat &#123;<br>// concat: concatå·¦è¾¹çš„åœ¨å‰ï¼Œå³è¾¹çš„åœ¨åï¼ŒäºŒè€…å‘é€æ•°æ®åæŒ‰ç…§å‰åé¡ºåºåˆ†åˆ«è§¦å‘ä¸€æ¬¡æ–°ä¿¡å·è®¢é˜…è€…å›è°ƒ<br>    <span class="hljs-symbol">RACSignal</span> *signal1 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;1.1&quot;</span>];<br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;1.2&quot;</span>];<br>            [subscriber sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <span class="hljs-symbol">RACSignal</span> *signal2 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal2 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;2.1&quot;</span>];<br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;2.2&quot;</span>];<br>            [subscriber sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <span class="hljs-symbol">RACSignal</span> *signal3 = [signal1 concat:signal2];<br>    [signal3 subscribeNext:^(id x) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++++received data:%@&quot;</span>,x);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs fortran">+++<span class="hljs-keyword">call</span> signal1 <span class="hljs-keyword">block</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">1.1</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">1.2</span><br>+++<span class="hljs-keyword">call</span> signal2 <span class="hljs-keyword">block</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">2.1</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">2.2</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜:<br><br/></p><p>1.<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>å‘é€å‡ æ¬¡æ•°æ®ï¼Œ<code>ä¿¡å·3</code>è®¢é˜…è€…å°±æ”¶åˆ°å‡ æ¬¡æ•°æ®ï¼›<br><br/></p><p>2.<code>ä¿¡å·3</code>è®¢é˜…è€…æ”¶åˆ°æ•°æ®çš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼ŒæŒ‰ç…§æ‹¼æ¥æ—¶çš„é¡ºåºæ¥ï¼š<code>ä¿¡å·1</code>å…ˆï¼Œ<code>ä¿¡å·2</code>åï¼›<br><br/></p><p>3.<code>concat</code>ä¸<code>NSOperation</code>çš„ä¾èµ–å…³ç³»æœ‰ç‚¹ç±»ä¼¼ï¼Œ<code>ä¿¡å·2</code>ä¾èµ–äº<code>ä¿¡å·1</code>ï¼Œæ‰€ä»¥<code>ä¿¡å·2</code>è¦çŸ¥é“<code>ä¿¡å·1</code>çš„çŠ¶æ€ï¼›<br><br/></p><p>4.<code>ä¿¡å·1</code>åœ¨å‘é€å®Œæ•°æ®ä¹‹åè®°å¾—<code>sendCompleted</code>ï¼Œå¦åˆ™<code>ä¿¡å·2</code>çš„<code>^didSubscribe</code>ä¸ä¼šè§¦å‘ï¼Œä¹Ÿå°±ä¸ä¼šæ‰§è¡Œä»»åŠ¡ï¼›<br><br/></p><p>#å®ç°åŸç†ï¼š</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-operator">-</span> (<span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span>)<span class="hljs-variable">concat</span>:(<span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span>)<span class="hljs-title function_">signal</span> &#123;<br><span class="hljs-comment">// 1.æ‹¼æ¥æ—¶è¿”å›æ–°çš„ä¿¡å·3</span><br>    <span class="hljs-keyword">return</span> [[<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br><span class="hljs-title class_">RACCompoundDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">compoundDisposable</span> <span class="hljs-operator">=</span> [[<span class="hljs-title class_">RACCompoundDisposable</span> <span class="hljs-variable">alloc</span>] init];<br><span class="hljs-comment">// 2.è®¢é˜…ä¿¡å·3æ—¶ç«‹åˆ»è®¢é˜…ä¿¡å·1</span><br>        <span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">sourceDisposable</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">self</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br><span class="hljs-comment">// 3.ä¿¡å·1 sendNext åå‘ä¿¡å·3 çš„è®¢é˜…è€…å‘é€æ•°æ®</span><br>            [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:<span class="hljs-variable">x</span>];<br>&#125; <span class="hljs-variable">error</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">NSError</span> *<span class="hljs-params">error</span>) &#123;<br>[<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendError</span>:<span class="hljs-variable">error</span>];<br>&#125; <span class="hljs-variable">completed</span>:<span class="hljs-operator">^</span>&#123;<br><span class="hljs-comment">// 4.ä¿¡å·1 sendConpleted åè°ƒç”¨ä¿¡å·2çš„ didSubscribe()</span><br>            <span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">concattedDisposable</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">signal</span> <span class="hljs-variable">subscribe</span>:<span class="hljs-variable">subscriber</span>];<br>[<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">addDisposable</span>:<span class="hljs-variable">concattedDisposable</span>];<br>&#125;];<br><br>[<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">addDisposable</span>:<span class="hljs-variable">sourceDisposable</span>];<br><span class="hljs-keyword">return</span> <span class="hljs-variable">compoundDisposable</span>;<br>&#125;] <span class="hljs-variable">setNameWithFormat</span>:@<span class="hljs-string">&quot;[%@] -concat: %@&quot;</span>, <span class="hljs-variable">self</span>.<span class="hljs-property">name</span>, <span class="hljs-variable">signal</span>];<br>&#125;<br><br><span class="hljs-operator">-</span> (<span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span>)<span class="hljs-variable">subscribe</span>:(<span class="hljs-variable">id</span><span class="hljs-operator">&lt;</span><span class="hljs-title class_">RACSubscriber</span><span class="hljs-operator">&gt;</span>)<span class="hljs-title function_">subscriber</span> &#123;<br><span class="hljs-title class_">NSCParameterAssert</span>(<span class="hljs-variable">subscriber</span> <span class="hljs-operator">!=</span> <span class="hljs-variable">nil</span>);<br>    <span class="hljs-operator">...</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">self</span>.<span class="hljs-property">didSubscribe</span> <span class="hljs-operator">!=</span> <span class="hljs-variable">NULL</span>) &#123;<br><span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">schedulingDisposable</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACScheduler</span>.<span class="hljs-property">subscriptionScheduler</span> <span class="hljs-variable">schedule</span>:<span class="hljs-operator">^</span>&#123;<br>    <span class="hljs-comment">// è°ƒç”¨ä¿¡å·2çš„ didSubscribe()</span><br><span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span>innerDisposable <span class="hljs-operator">=</span> <span class="hljs-variable">self</span>.<span class="hljs-property">didSubscribe</span>(<span class="hljs-variable">subscriber</span>);<br>[<span class="hljs-variable">disposable</span> <span class="hljs-variable">addDisposable</span>:innerDisposable];<br>&#125;];<br>[<span class="hljs-variable">disposable</span> <span class="hljs-variable">addDisposable</span>:<span class="hljs-variable">schedulingDisposable</span>];<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">disposable</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ä¸­æœ‰æ³¨é‡Šï¼Œå…·ä½“æ•´ç†å¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_RAC_concat.png" alt="RAC_CONCAT"></p><h3 id="then"><a href="#then" class="headerlink" title="then"></a>then</h3><figure class="highlight stan"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stan"><span class="hljs-comment">/// Ignores all `next`s from the receiver, waits for the receiver to complete,</span><br><span class="hljs-comment">/// then subscribes to a new signal.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// block - A block which will create or obtain a new signal to subscribe to,</span><br><span class="hljs-comment">///         executed only after the receiver completes. This block must not be</span><br><span class="hljs-comment">///         nil, and it must not return a nil signal.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a signal which will pass through the events of the signal created in</span><br><span class="hljs-comment">/// `block`. If the receiver errors out, the returned signal will error as well.</span><br>- (RACSignal *)then:(RACSignal * (^)(<span class="hljs-type">void</span>))<span class="hljs-built_in">block</span> RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨:</strong> å…ˆæ‰§è¡Œ<code>ä¿¡å·1</code>ä½†è¿‡æ»¤æ‰<code>ä¿¡å·1</code>çš„æ•°æ®ï¼Œå†æ‰§è¡Œ<code>ä¿¡å·2</code>çš„ä»»åŠ¡å¹¶è·å–å…¶å‘é€çš„æ•°æ®ã€‚<br><br/></p><p>#ç¤ºä¾‹2:</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-operator">-</span> (<span class="hljs-variable">void</span>)<span class="hljs-title function_">then</span> &#123;<br>    <span class="hljs-comment">// thenï¼šä¿¡å·1å…ˆæ‰§è¡Œï¼Œä¿¡å·2åæ‰§è¡Œ,æœ€ååªè·å–ä¿¡å·2çš„æ•°æ®</span><br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">signal1</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        <span class="hljs-comment">// 1</span><br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;1.1&quot;</span>];<br>        [[<span class="hljs-title class_">RACScheduler</span> <span class="hljs-variable">mainThreadScheduler</span>] <span class="hljs-variable">afterDelay</span>:<span class="hljs-number">2</span> <span class="hljs-variable">schedule</span>:<span class="hljs-operator">^</span>&#123;<br>            [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;1.2&quot;</span>];<br>            [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>        &#125;];<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nil</span>;<br>    &#125;];<br>    <br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">signal2</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span> (<span class="hljs-variable">id</span><span class="hljs-operator">&lt;</span><span class="hljs-title class_">RACSubscriber</span><span class="hljs-operator">&gt;</span> <span class="hljs-variable">subscriber</span>) &#123;<br>        <span class="hljs-comment">// 3</span><br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++call signal2 block&quot;</span>);<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;2.1&quot;</span>];<br>        [[<span class="hljs-title class_">RACScheduler</span> <span class="hljs-variable">mainThreadScheduler</span>] <span class="hljs-variable">afterDelay</span>:<span class="hljs-number">2</span> <span class="hljs-variable">schedule</span>:<span class="hljs-operator">^</span>&#123;<br>            [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;2.2&quot;</span>];<br>            [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>        &#125;];<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nil</span>;<br>    &#125;];<br>    <br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">signal3</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">signal1</span> <span class="hljs-variable">then</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span> &#123;<br>        <span class="hljs-comment">// 2</span><br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;++++call signal3 then&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">signal2</span>;<br>    &#125;];<br>    <br>    [<span class="hljs-variable">signal3</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-comment">// 4</span><br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;++++received data:%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran">+++<span class="hljs-keyword">call</span> signal1 <span class="hljs-keyword">block</span><br>++++<span class="hljs-keyword">call</span> signal3 <span class="hljs-keyword">then</span><br>+++<span class="hljs-keyword">call</span> signal2 <span class="hljs-keyword">block</span><br>++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">2.1</span><br>++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">2.2</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜ï¼š<br><br/></p><p>1.<code>ä¿¡å·1</code>å‘é€çš„æ•°æ®è‡ªåŠ¨è¢«è¿‡æ»¤æ‰ï¼Œ<code>ä¿¡å·3</code>è®¢é˜…è€…ä¸ä¼šæ”¶åˆ°æ•°æ®<code>ä¿¡å·1</code>çš„æ•°æ®å›è°ƒï¼›<br><br/></p><p>2.<code>ä¿¡å·2</code>å‘é€å‡ æ¬¡æ•°æ®ï¼Œ<code>ä¿¡å·3</code>çš„è®¢é˜…è€…å°±æ”¶åˆ°å‡ æ¬¡æ•°æ®ï¼›<br><br/></p><p>3.<code>ä¿¡å·2</code>æ€»æ˜¯åœ¨<code>ä¿¡å·1</code>å®Œæˆä¹‹åï¼Œæ‰ä¼šå¼€å§‹æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡ï¼›<br><br/></p><p>#å®ç°åŸç†ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua">- (RACSignal *)<span class="hljs-keyword">then</span>:(RACSignal * (^)(void))block &#123;<br>NSCParameterAssert(block != <span class="hljs-literal">nil</span>);<br><br><span class="hljs-keyword">return</span> <span class="hljs-string">[[[self</span><br><span class="hljs-string">ignoreValues]</span><br><span class="hljs-string">concat:[RACSignal defer:block]]</span><br>setNameWithFormat:@<span class="hljs-string">&quot;[%@] -then:&quot;</span>, <span class="hljs-built_in">self</span>.name];<br>&#125;<br></code></pre></td></tr></table></figure><p>1.å…ˆé€šè¿‡<code>ignoreValues</code>å¯¹<code>ä¿¡å·1</code>è¿›è¡Œäº†è¿‡æ»¤ï¼Œå¿½ç•¥æ‰äº†å®ƒçš„<code>sendNext:</code>äº‹ä»¶ï¼Œåªå…³æ³¨å…¶<code>error</code>å’Œ<code>completed</code>äº‹ä»¶ï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ruby">/<span class="hljs-regexp">//</span> Ignores all <span class="hljs-string">`next`</span>s from the receiver.<br>/<span class="hljs-regexp">//</span><br>/<span class="hljs-regexp">//</span> Returns a signal which only passes through <span class="hljs-string">`error`</span> <span class="hljs-keyword">or</span> <span class="hljs-string">`completed`</span> events from<br>/<span class="hljs-regexp">//</span> the receiver.<br>- (RACSignal *)ignoreValues <span class="hljs-variable constant_">RAC_WARN_UNUSED_RESULT</span>;<br><br>- (RACSignal *)ignoreValues &#123;<br><span class="hljs-keyword">return</span> [[<span class="hljs-variable language_">self</span> <span class="hljs-symbol">filter:</span>^(id _) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-variable constant_">NO</span>;<br>&#125;] <span class="hljs-symbol">setNameWithFormat:</span>@<span class="hljs-string">&quot;[%@] -ignoreValues&quot;</span>, <span class="hljs-variable language_">self</span>.name];<br>&#125;<br></code></pre></td></tr></table></figure><p>2.å†é€šè¿‡<code>[RACSignal defer:block]]</code>ï¼Œå°†<code>ä¿¡å·2</code>å°è£…åˆ°ä¸€ä¸ªæ–°ä¿¡å·ä¸­ï¼š</p><figure class="highlight stan"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stan"><span class="hljs-comment">/// Defers creation of a signal until the signal&#x27;s actually subscribed to.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This can be used to effectively turn a hot signal into a cold signal.</span><br>+ (RACSignal&lt;ValueType&gt; *)defer:(RACSignal&lt;ValueType&gt; * (^)(<span class="hljs-type">void</span>))<span class="hljs-built_in">block</span> RAC_WARN_UNUSED_RESULT;<br><br>+ (RACSignal *)defer:(RACSignal&lt;id&gt; * (^)(<span class="hljs-type">void</span>))<span class="hljs-built_in">block</span> &#123;<br>NSCParameterAssert(<span class="hljs-built_in">block</span> != NULL);<br><br><span class="hljs-keyword">return</span> [[RACSignal createSignal:^(id&lt;RACSubscriber&gt; subscriber) &#123;<br><span class="hljs-keyword">return</span> [<span class="hljs-built_in">block</span>() subscribe:subscriber];<br>&#125;] setNameWithFormat:@<span class="hljs-string">&quot;+defer:&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>3.æœ€åç”¨<code>concat</code>æ–¹æ³•å°†ä¸¤ä¸ªæ–°ä¿¡å·è¿›è¡Œæ‹¼æ¥ï¼Œå…ˆæ‰§è¡Œ<code>ä¿¡å·1</code>çš„ä»»åŠ¡ï¼Œå†å¼€å§‹<code>ä¿¡å·2</code>çš„ä»»åŠ¡ã€‚</p><br/><p>æ‰€ä»¥ï¼Œä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œ<code>then</code>æœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯<code>concat</code>~</p><h3 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">/// Sends the latest `next` from any of the signals.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a signal that passes through values from each of the given signals,</span><br><span class="hljs-comment">/// and sends `completed` when all of them complete. If any signal sends an error,</span><br><span class="hljs-comment">/// the returned signal sends `error` immediately.</span><br><span class="hljs-operator">+</span> (<span class="hljs-type">RACSignal</span>&lt;<span class="hljs-type">ValueType</span>&gt; <span class="hljs-operator">*</span>)merge:(id<span class="hljs-operator">&lt;</span><span class="hljs-type">NSFastEnumeration</span><span class="hljs-operator">&gt;</span>)signals <span class="hljs-type">RAC_WARN_UNUSED_RESULT</span>;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨:</strong> å°†nä¸ªä¿¡å·æ•´åˆä¸ºæ–°<code>ä¿¡å·x</code>ï¼Œä¿¡å·ä¹‹é—´ä¸å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œä»»ä½•ä¸€ä¸ªä¿¡å·å‘é€æ•°æ®ï¼Œä¿¡å·xçš„è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°å›è°ƒï¼Œä¸”éµå¾ªFIFOåŸåˆ™ï¼Œè°å…ˆå‘é€æ•°æ®åˆ™è®¢é˜…è€…å°±å…ˆæ”¶åˆ°è°çš„æ•°æ®ã€‚<br><br/></p><p>#ç¤ºä¾‹3:</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs prolog">- (void)merge &#123;<br>    // merge è°å…ˆsendNextå°±å…ˆæ”¶åˆ°è°çš„æ•°æ®<br>    <span class="hljs-symbol">RACSignal</span> *signal1 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;1.1&quot;</span>];<br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;1.2&quot;</span>];<br>            [subscriber sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <br>    <span class="hljs-symbol">RACSignal</span> *signal2 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal2 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;2.1&quot;</span>];<br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;2.2&quot;</span>];<br>            [subscriber sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <br>    <span class="hljs-symbol">RACSignal</span> *signal3 = [<span class="hljs-symbol">RACSignal</span> merge:@[signal1,signal2]];<br>    <br>    [signal3 subscribeNext:^(id x) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++++received data:%@&quot;</span>,x);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—:</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs fortran">+++<span class="hljs-keyword">call</span> signal1 <span class="hljs-keyword">block</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">1.1</span><br>+++<span class="hljs-keyword">call</span> signal2 <span class="hljs-keyword">block</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">2.1</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">1.2</span><br>+++++received <span class="hljs-keyword">data</span>:<span class="hljs-number">2.2</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜ï¼š<br><br/></p><p>1.<code>merge</code>å°†<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>æ•´åˆåˆ°<code>ä¿¡å·3</code>ä¸­ï¼Œ1ã€2ä¹‹é—´ä¸ä¼šç›¸äº’å½±å“ï¼›<br><br/></p><p>2.<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>å‘é€æ–°æ•°æ®æ—¶ï¼Œ<code>ä¿¡å·3</code>éƒ½èƒ½æ”¶åˆ°æ–°æ•°æ®ï¼›<br><br/></p><p>#å®ç°åŸç†<br><br/></p><p>ä»æœ€åº•å±‚çš„å®ç°ä¸Šæ¥è®²ï¼Œmergeä½¿ç”¨äº†RACçš„<code>-bind:</code>æ–¹æ³•ï¼Œæ¥ä¸‹æ¥ä¸€æ­¥æ­¥æ¥çœ‹ï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs inform7">RACSignal *signal3 = <span class="hljs-comment">[RACSignal merge:@<span class="hljs-comment">[signal1,signal2]</span>]</span>;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬è°ƒç”¨äº†<code>merge</code>ï¼Œå°†<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>åˆå¹¶ï¼Œæ¥çœ‹çœ‹æ–¹æ³•å†…éƒ¨å…·ä½“åšäº†å•¥ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">+</span> (<span class="hljs-type">RACSignal</span> <span class="hljs-operator">*</span>)merge:(id<span class="hljs-operator">&lt;</span><span class="hljs-type">NSFastEnumeration</span><span class="hljs-operator">&gt;</span>)signals &#123;<br>    <span class="hljs-type">NSMutableArray</span> <span class="hljs-operator">*</span>copiedSignals <span class="hljs-operator">=</span> [[<span class="hljs-type">NSMutableArray</span> alloc] <span class="hljs-keyword">init</span>];<br>    <span class="hljs-comment">// 1.å°†ä¿¡å·1å’Œä¿¡å·2ä¿å­˜åˆ°ä¸€ä¸ªæ•°ç»„ä¸­</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">RACSignal</span> <span class="hljs-operator">*</span>signal <span class="hljs-keyword">in</span> signals) &#123;<br>        [copiedSignals addObject:signal];<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> [[[<span class="hljs-type">RACSignal</span> <span class="hljs-comment">// 2.åˆ›å»ºä¿¡å·4</span><br>        createSignal:<span class="hljs-operator">^</span> <span class="hljs-type">RACDisposable</span> <span class="hljs-operator">*</span> (id<span class="hljs-operator">&lt;</span><span class="hljs-type">RACSubscriber</span><span class="hljs-operator">&gt;</span> subscriber) &#123; <span class="hljs-comment">//å°†æ­¤blockå‘½åä¸º^didSubscribe4</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">RACSignal</span> <span class="hljs-operator">*</span>signal <span class="hljs-keyword">in</span> copiedSignals) &#123;<br>                <span class="hljs-comment">// å‘é€ä¿¡å·1å’Œä¿¡å·2ï¼ˆæ³¨æ„è¿™ä¸æˆ‘ä»¬è‡ªå·±ä½¿ç”¨æ—¶å‘é€çš„å­—ç¬¦ä¸²ä¹‹ç±»çš„ä¸åŒï¼Œå®ƒå‘é€çš„æ˜¯ä¿¡å·ç±»å‹ï¼‰</span><br>                [subscriber sendNext:signal];<br>            &#125;<br><br>            [subscriber sendCompleted];<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;]<br>        flatten]<span class="hljs-comment">// 3.ä¿¡å·4è°ƒç”¨äº† flatten æ–¹æ³•</span><br>        setNameWithFormat:@<span class="hljs-string">&quot;+merge: %@&quot;</span>, copiedSignals];<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>ä¿¡å·4</code>çœ‹ä¸Šå»æ˜¯ä¸€ä¸ªæŒºç®€å•çš„ä¿¡å·ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯å‘è®¢é˜…è€…å‘é€<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>ã€‚<code>ä¿¡å·4</code>è°ƒç”¨äº†<code>flatten</code>ï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ruby">- (__kindof RACStream *)flatten &#123;<br>    <span class="hljs-regexp">//</span>æˆ‘å°†æ­¤æ–¹æ³•çš„å‚æ•°å‘½åä¸º mapBlock æ–¹ä¾¿åç»­è§£é‡Šæ­¤å¤„ä»£ç <br>    <span class="hljs-keyword">return</span> [[<span class="hljs-variable language_">self</span> <span class="hljs-symbol">flattenMap:</span>^(id value) &#123;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;] <span class="hljs-symbol">setNameWithFormat:</span>@<span class="hljs-string">&quot;[%@] -flatten&quot;</span>, <span class="hljs-variable language_">self</span>.name];<br>&#125;<br><br>- (__kindof RACStream *)<span class="hljs-symbol">flattenMap:</span>(__kindof RACStream * (^)(id value))block &#123;<br>    Class <span class="hljs-keyword">class</span> = <span class="hljs-variable language_">self</span>.<span class="hljs-keyword">class</span>;<br><br>    <span class="hljs-keyword">return</span> [[<span class="hljs-variable language_">self</span> <span class="hljs-symbol">bind:</span>^&#123;<br>    <span class="hljs-regexp">//bind</span>çš„å‚æ•°ä¸ºä¸€ä¸ªblock æ­¤blockç±»å‹ä¸ºï¼šRACSignalBindBlock (^)(void)ï¼Œå³æ— å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªRACSignalBindBlockç±»å‹çš„bindingBlock<br>        <span class="hljs-keyword">return</span> ^(id value, <span class="hljs-variable constant_">BOOL</span> *stop) &#123;<br>            id stream = block(value) <span class="hljs-string">?:</span> [<span class="hljs-keyword">class</span> empty];<br>            NSCAssert([stream <span class="hljs-symbol">isKindOfClass:</span>RACStream.<span class="hljs-keyword">class</span>], @<span class="hljs-string">&quot;Value returned from -flattenMap: is not a stream: %@&quot;</span>, stream);<br><br>            <span class="hljs-keyword">return</span> stream;<br>        &#125;;<br>    &#125;] <span class="hljs-symbol">setNameWithFormat:</span>@<span class="hljs-string">&quot;[%@] -flattenMap:&quot;</span>, <span class="hljs-variable language_">self</span>.name];<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>flatten</code>æ–¹æ³•å†…éƒ¨æœ€ç»ˆæ˜¯è°ƒç”¨äº†<code>bind</code>æ–¹æ³•ï¼Œå³<code>ä¿¡å·4</code>è°ƒç”¨äº†<code>bind</code>æ–¹æ³•ã€‚</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-operator">-</span> (<span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span>)<span class="hljs-variable">bind</span>:(<span class="hljs-title class_">RACSignalBindBlock</span> (<span class="hljs-operator">^</span>)(<span class="hljs-variable">void</span>))<span class="hljs-title function_">block</span> &#123;<br>    <span class="hljs-title class_">NSCParameterAssert</span>(<span class="hljs-variable">block</span> <span class="hljs-operator">!=</span> <span class="hljs-variable">NULL</span>);<br><br>    <span class="hljs-keyword">return</span> [[<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<span class="hljs-comment">//å°†æ­¤blockå‘½åä¸º^didSubscribe3</span><br>        <span class="hljs-comment">// 1.åˆ›å»ºå¹¶è¿”å›æ–°ä¿¡å·ï¼ˆå³ç¤ºä¾‹ä¸­çš„ä¿¡å·3ï¼‰</span><br>        <span class="hljs-title class_">RACSignalBindBlock</span> <span class="hljs-variable">bindingBlock</span> <span class="hljs-operator">=</span> <span class="hljs-title function_">block</span>();<br>        <span class="hljs-comment">// 2.è·å–bindæ–¹æ³•çš„å‚æ•° block çš„è¿”å›å€¼â€œbindingBlockâ€</span><br><br>        <span class="hljs-variable">__block</span> <span class="hljs-variable">volatile</span> int32_t <span class="hljs-variable">signalCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;   <span class="hljs-comment">// indicates self</span><br><br>        <span class="hljs-title class_">RACCompoundDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">compoundDisposable</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACCompoundDisposable</span> <span class="hljs-variable">compoundDisposable</span>];<br><br>        <span class="hljs-comment">// å®šä¹‰completeSignal blockï¼Œå¤„ç†ä¿¡å·å®Œæˆäº‹ä»¶</span><br>        <span class="hljs-title function_">void</span> (<span class="hljs-operator">^</span><span class="hljs-variable">completeSignal</span>)(<span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span>) <span class="hljs-operator">=</span> <span class="hljs-title function_">^</span>(<span class="hljs-params">RACDisposable</span> *<span class="hljs-params">finishedDisposable</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">OSAtomicDecrement</span>32Barrier(<span class="hljs-operator">&amp;</span><span class="hljs-variable">signalCount</span>) <span class="hljs-operator">==</span> <span class="hljs-number">0</span>) &#123;<br>                [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>                [<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">dispose</span>];<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                [<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">removeDisposable</span>:<span class="hljs-variable">finishedDisposable</span>];<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// å®šä¹‰addSignal blockï¼Œå¤„ç†ä¼ è¿›æ¥çš„ä¿¡å·å‚æ•°</span><br>        <span class="hljs-title function_">void</span> (<span class="hljs-operator">^</span><span class="hljs-variable">addSignal</span>)(<span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span>) <span class="hljs-operator">=</span> <span class="hljs-title function_">^</span>(<span class="hljs-params">RACSignal</span> *<span class="hljs-params">signal</span>) &#123;<br>            <span class="hljs-title class_">OSAtomicIncrement</span>32Barrier(<span class="hljs-operator">&amp;</span><span class="hljs-variable">signalCount</span>);<br><br>            <span class="hljs-title class_">RACSerialDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">selfDisposable</span> <span class="hljs-operator">=</span> [[<span class="hljs-title class_">RACSerialDisposable</span> <span class="hljs-variable">alloc</span>] init];<br>            [<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">addDisposable</span>:<span class="hljs-variable">selfDisposable</span>];<br><br>            <span class="hljs-comment">// 8.è®¢é˜…ä¼ è¿›æ¥çš„ä¿¡å·ï¼ˆä¿¡å·1å’Œä¿¡å·2ï¼‰</span><br>            <span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">disposable</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">signal</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123; <span class="hljs-comment">//å°†æ­¤blockå‘½åä¸º^sendNext1/^sendNext2</span><br>                <span class="hljs-comment">// 9.ä¿¡å·1å’Œä¿¡å·2å‘é€æ•°æ®æ—¶ï¼Œå‘ä¿¡å·3çš„è®¢é˜…è€…subscriberå‘é€æ•°æ®</span><br>                [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:<span class="hljs-variable">x</span>];<br>            &#125; <span class="hljs-variable">error</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">NSError</span> *<span class="hljs-params">error</span>) &#123;<br>                [<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">dispose</span>];<br>                [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendError</span>:<span class="hljs-variable">error</span>];<br>            &#125; <span class="hljs-variable">completed</span>:<span class="hljs-operator">^</span>&#123;<br>                @<span class="hljs-title function_">autoreleasepool</span> &#123;<br>                    <span class="hljs-title function_">completeSignal</span>(<span class="hljs-variable">selfDisposable</span>);<br>                &#125;<br>            &#125;];<br><br>            <span class="hljs-variable">selfDisposable</span>.<span class="hljs-property">disposable</span> <span class="hljs-operator">=</span> <span class="hljs-variable">disposable</span>;<br>        &#125;;<br><br>        @<span class="hljs-title function_">autoreleasepool</span> &#123;<br>            <span class="hljs-title class_">RACSerialDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">selfDisposable</span> <span class="hljs-operator">=</span> [[<span class="hljs-title class_">RACSerialDisposable</span> <span class="hljs-variable">alloc</span>] init];<br>            [<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">addDisposable</span>:<span class="hljs-variable">selfDisposable</span>];<br><br>            <span class="hljs-comment">// 3.è®¢é˜…ä¿¡å·4 è¿™é‡Œçš„ self æ˜¯ä¿¡å·4</span><br>            <span class="hljs-title class_">RACDisposable</span> <span class="hljs-operator">*</span><span class="hljs-variable">bindingDisposable</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">self</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<span class="hljs-comment">// å°†æ­¤blockå‘½åä¸º^sendNext4</span><br><br>                <span class="hljs-comment">// 4.ä¿¡å·4 ^didSubscribe4 ä¸­[sendNext(ä¿¡å·1/ä¿¡å·2))]è§¦å‘æ­¤å¤„å›è°ƒ</span><br>                <span class="hljs-comment">// Manually check disposal to handle synchronous errors.</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">compoundDisposable</span>.<span class="hljs-property">disposed</span>) <span class="hljs-keyword">return</span>;<br><br>                <br>                <span class="hljs-variable">BOOL</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-variable">NO</span>;<br>                <span class="hljs-comment">// 5.è°ƒç”¨bindingBlockï¼Œå‚æ•°xä¸ºä¿¡å·4å‘é€çš„æ•°æ®ï¼ˆä¿¡å·1å’Œä¿¡å·2ï¼‰</span><br>                <span class="hljs-variable">id</span> <span class="hljs-variable">signal</span> <span class="hljs-operator">=</span> <span class="hljs-title function_">bindingBlock</span>(<span class="hljs-variable">x</span>, <span class="hljs-operator">&amp;</span><span class="hljs-variable">stop</span>);<br><br>                <span class="hljs-comment">// 6.bindingBlockä¸­è°ƒç”¨äº† mapBlock(value)ï¼Œæœ€ç»ˆè¿”å›äº†valueï¼Œå³ä¿¡å·1å’Œä¿¡å·2</span><br><br>                @<span class="hljs-title function_">autoreleasepool</span> &#123;<br>                    <span class="hljs-comment">// 7.æ‰§è¡ŒaddSignal()</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">signal</span> <span class="hljs-operator">!=</span> <span class="hljs-variable">nil</span>) <span class="hljs-title function_">addSignal</span>(<span class="hljs-variable">signal</span>);<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">signal</span> <span class="hljs-operator">==</span> <span class="hljs-variable">nil</span> <span class="hljs-operator">||</span> <span class="hljs-variable">stop</span>) &#123;<br>                        [<span class="hljs-variable">selfDisposable</span> <span class="hljs-variable">dispose</span>];<br>                        <span class="hljs-title function_">completeSignal</span>(<span class="hljs-variable">selfDisposable</span>);<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-variable">error</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">NSError</span> *<span class="hljs-params">error</span>) &#123;<br>                [<span class="hljs-variable">compoundDisposable</span> <span class="hljs-variable">dispose</span>];<br>                [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendError</span>:<span class="hljs-variable">error</span>];<br>            &#125; <span class="hljs-variable">completed</span>:<span class="hljs-operator">^</span>&#123;<br>                @<span class="hljs-title function_">autoreleasepool</span> &#123;<br>                    <span class="hljs-title function_">completeSignal</span>(<span class="hljs-variable">selfDisposable</span>);<br>                &#125;<br>            &#125;];<br><br>            <span class="hljs-variable">selfDisposable</span>.<span class="hljs-property">disposable</span> <span class="hljs-operator">=</span> <span class="hljs-variable">bindingDisposable</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">compoundDisposable</span>;<br>    &#125;] <span class="hljs-variable">setNameWithFormat</span>:@<span class="hljs-string">&quot;[%@] -bind:&quot;</span>, <span class="hljs-variable">self</span>.<span class="hljs-property">name</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>bindæ–¹æ³•é‡Œçš„ä»£ç é€»è¾‘ï¼Œç»“åˆæˆ‘åœ¨ä¸Šé¢çš„æ ‡æ³¨æ¥çœ‹ï¼š<br><br/></p><p>1.<code>ä¿¡å·4</code>è°ƒç”¨<code>bind</code>æ–¹æ³•åï¼Œ<code>bind</code>å†…éƒ¨å…ˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ä¿¡å·å¹¶æ²¿ç€è°ƒç”¨è·¯å¾„å±‚å±‚å¾€ä¸Šè¿”å›ç»™è°ƒç”¨è€…ï¼Œæœ€ç»ˆè¿™ä¸ªæ–°ä¿¡å·çš„æ¥æ”¶è€…æ­£æ˜¯æˆ‘ä»¬åœ¨æœ€å¼€å§‹æ‰§è¡Œâ€[RACSignal merge:@[signal1,signal2]]â€æ—¶çš„<code>signal3</code>ï¼Œå³<code>ä¿¡å·3</code>ã€‚åœ¨ç¤ºä¾‹3ä¸­è®¢é˜…<code>ä¿¡å·3</code>ä¹‹åï¼Œè§¦å‘å…¶<code>^didSubscribe3</code>ï¼Œä¹Ÿå°±æ˜¯<code>bind</code>æ–¹æ³•å†…æ–°å»ºä¿¡å·åé¢çš„é‚£ä¸ªå¤§ blockã€‚<br><br/></p><p>2.<code>^didSubscribe3</code>å…ˆè°ƒç”¨äº†<code>bind</code>çš„ blockå‚æ•°ï¼Œè¿”å›äº†ä¸€ä¸ª<code>bindingBlock</code>å¤‡ç”¨ï¼›<br><br/></p><p>3.ç´§æ¥ç€è®¢é˜…äº†<code>ä¿¡å·4</code>ï¼Œä»è€Œè§¦å‘<code>^didSubscribe4</code>ï¼›<br><br/></p><p>4.<code>^didSubscribe4</code>é€šè¿‡ forå¾ªç¯å°†<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>ä½œä¸ºæ•°æ®å‘é€ç»™è®¢é˜…è€…<code>^sendNext4</code>ï¼›<br><br/></p><p>5.<code>^sendNext4</code>ä¸­è°ƒç”¨<code>bindingBlock</code>ï¼Œå…¶å‚æ•°ä¸º<code>ä¿¡å·4</code>ä¼ æ¥çš„<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>ï¼›<br><br/></p><p>6.<code>bindingBlock</code>å†…è°ƒç”¨äº†<code>block(value)</code>ï¼Œå³å›è°ƒäº†<code>flattenMap</code>æ–¹æ³•çš„ mapBlockï¼Œæœ€ç»ˆè¿”å›äº†<code>value</code>ï¼ˆä¿¡å·1å’Œä¿¡å·2ï¼‰ï¼›<br><br/></p><p>7.<code>^sendNext4</code>ç»§ç»­è°ƒç”¨<code>addSignal(ä¿¡å·1/ä¿¡å·2)</code>ï¼›<br><br/></p><p>8.<code>addSignal()</code>å†…éƒ¨å®ç°æ˜¯è®¢é˜…ä¼ è¿›æ¥çš„ä¿¡å·ï¼Œå³è®¢é˜…äº†<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>ï¼›<br><br/></p><p>9.åˆ°è¿™ä¸€æ­¥<code>bind</code>å·²ç»ä¸‡äº‹ä¿±å¤‡ï¼Œåªç­‰æ¥æ”¶æ•°æ®äº†ã€‚å½“<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>äº§ç”Ÿæ–°æ•°æ®æ—¶ï¼Œ<code>^sendNext1/^sendNext2</code>ä¼šè‡ªåŠ¨è§¦å‘ï¼›<br><br/></p><p>10.<code>^sendNext1/^sendNext2</code>å†…é€šè¿‡<code>^didSubscribe3</code>å°†æ•°æ®å›è°ƒç»™è®¢é˜…è€…ï¼Œå› ä¸º<code>^didSubscribe3</code>æœ¬èº«ä»£è¡¨çš„æ˜¯ä¿¡å·3çš„è®¢é˜…ï¼Œæ‰€ä»¥<code>ä¿¡å·1</code>å’Œ<code>ä¿¡å·2</code>çš„æ•°æ®æœ€ç»ˆä¼ é€’ç»™äº†<code>ä¿¡å·3</code>çš„è®¢é˜…è€…ï¼Œå³æˆ‘ä»¬åœ¨ç¤ºä¾‹3ä¸­å®šä¹‰å¥½çš„ block ä¸­ï¼›<br><br/></p><p><strong>å°ç»“ï¼š</strong> ä»¥ä¸Šå°±æ˜¯<code>merge</code>æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œç®€å•æ¥è¯´å°±æ˜¯<code>merge</code>æ“ä½œå¾—åˆ°çš„æ–°ä¿¡å·ï¼Œé€šè¿‡<code>bind</code>æ–¹æ³•åœ¨å†…éƒ¨è®¢é˜…äº†è¢«<code>merge</code>çš„å­ä¿¡å·ï¼›å­ä¿¡å·äº§ç”Ÿä¸€ä»½æ•°æ®æ—¶æ–°ä¿¡å·å°±ä¼šæ”¶åˆ°ä¸€ä»½æ–°æ•°æ®ã€‚æ‰€ä»¥æƒ³è¦æ›´å¥½çš„ç†è§£<code>merge</code>æ–¹æ³•ï¼Œå°±è¦å…ˆç†è§£<code>bind</code>æ–¹æ³•ã€‚<br><br/></p><p>é™„èµ æˆ‘ç”¨æ€ç»´å¯¼å›¾æ•´ç†çš„<code>merge</code>å®ç°ï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_signal_merge.png" alt="ä¿¡å·ç»‘å®š"></p><h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">/// Zips the values in the given signals to create RACTuples.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// The first value of each signals will be combined, then the second value, and</span><br><span class="hljs-comment">/// so forth, until at least one of the signals is exhausted.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// signals - The signals to combine. If this collection is empty, the returned</span><br><span class="hljs-comment">///           signal will be empty.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a new signal containing RACTuples of the zipped values from the</span><br><span class="hljs-comment">/// signals.</span><br><span class="hljs-operator">+</span> (<span class="hljs-type">RACSignal</span>&lt;<span class="hljs-type">RACTuple</span> *&gt; <span class="hljs-operator">*</span>)zip:(id<span class="hljs-operator">&lt;</span><span class="hljs-type">NSFastEnumeration</span><span class="hljs-operator">&gt;</span>)signals <span class="hljs-type">RAC_WARN_UNUSED_RESULT</span>;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨:</strong> å°†nä¸ªä¿¡å·æ‰“åŒ…è¿›ä¸€ä¸ªæ–°ä¿¡å·ä¸­ï¼Œå½“æ‰€æœ‰å­ä¿¡å·éƒ½<code>sendNext</code>ä¹‹åï¼Œæ–°ä¿¡å·å°†æ¥æ”¶åˆ°çš„æ•°æ®ç»„åˆåœ¨ä¸€ä¸ª<code>å…ƒç»„</code>ä¸­ï¼Œå€¼åœ¨å…ƒç»„ä¸­çš„æ’åºæŒ‰ç…§ä¿¡å·ç»„åˆæ—¶çš„é¡ºåºæ¥ã€‚<br><br/></p><p>#ç¤ºä¾‹4:</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs prolog">- (void)zip &#123;<br>    // zip: åˆå¹¶nä¸ªä¿¡å·çš„å€¼åˆ°ä¸€ä¸ªå…ƒç»„ä¸­ï¼Œå“ªä¸ªä¿¡å·åœ¨å‰å“ªä¸ªä¿¡å·çš„å€¼å°±åœ¨å…ƒç»„ä¸­é å‰<br>    <span class="hljs-symbol">RACSignal</span> *signal1 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;1&quot;</span>];<br>        [subscriber sendCompleted];<br>        return nil;<br>    &#125;];<br>    <br>    <span class="hljs-symbol">RACSignal</span> *signal2 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal2 block&quot;</span>);<br>        <br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">1</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;2.1&quot;</span>];<br>        &#125;];<br>        <br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;2.2&quot;</span>];<br>            [subscriber sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <br>    <span class="hljs-symbol">RACSignal</span> *signal3 = [<span class="hljs-symbol">RACSignal</span> zip:@[signal1,signal2]];<br>    <br>    [signal3 subscribeNext:^(id x) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++++received data:%@&quot;</span>,x);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight wasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs wasm">+++<span class="hljs-keyword">call</span> signal1 <span class="hljs-keyword">block</span><br>+++<span class="hljs-keyword">call</span> signal2 <span class="hljs-keyword">block</span><br>+++++received <span class="hljs-keyword">data</span>:&lt;RACTuple: <span class="hljs-number">0x7ff33e4bbab0</span>&gt; <span class="hljs-punctuation">(</span><br>    <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;2.1&quot;</span><br><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜ï¼š<br><br/></p><p>1.<code>ä¿¡å·3</code>çš„è®¢é˜…è€…è¦åœ¨ç»„åˆä¸­çš„ä¿¡å·éƒ½<code>sendNext:</code>ä¹‹åæ‰ä¼šæ”¶åˆ°å›è°ƒçš„å…ƒç»„ï¼›<br><br/></p><p>2.<code>ä¿¡å·3</code>å…ƒç»„ä¸­æ•°æ®çš„é¡ºåºä¸ç»„åˆæ—¶ä¿¡å·çš„é¡ºåºæ’åˆ—ä¸€è‡´ï¼›<br><br/></p><p>3.<code>ä¿¡å·3</code>çš„è®¢é˜…è€…å¯è§†ä¸ºä¸€æ¬¡æ€§çš„ï¼Œæ”¶åˆ°ä¸€æ¬¡æ•°æ®ä¹‹åï¼Œä¸è®ºæºä¿¡å·å†å‘é€å‡ æ¬¡æ•°æ®ï¼Œå®ƒéƒ½ä¸å†æ¥å—æ–°æ•°æ®ã€‚</p><p><code>zip</code>å¯ç”¨æ¥æ•´åˆç½‘ç»œè¯·æ±‚ï¼Œå¦‚å½“éœ€è¦åŒæ—¶å‘é€Nä¸ªè¯·æ±‚ï¼Œåªæœ‰å½“è¿™Nä¸ªè¯·æ±‚éƒ½æˆåŠŸåï¼Œå†å°†è¿™Nä¸ªçš„ç»“æœæ•´åˆèµ·æ¥ç»§ç»­å¾€ä¸‹å¤„ç†ã€‚è¿™ç§åœºæ™¯å°±å¯ä»¥é€šè¿‡<code>zip</code>æ¥å®ç°ã€‚</p><h3 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">/// Combines the latest values from the given signals into RACTuples, once all</span><br><span class="hljs-comment">/// the signals have sent at least one `next`.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Any additional `next`s will result in a new RACTuple with the latest values</span><br><span class="hljs-comment">/// from all signals.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// signals - The signals to combine. If this collection is empty, the returned</span><br><span class="hljs-comment">///           signal will immediately complete upon subscription.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Returns a signal which sends RACTuples of the combined values, forwards any</span><br><span class="hljs-comment">/// `error` events, and completes when all input signals complete.</span><br><span class="hljs-operator">+</span> (<span class="hljs-type">RACSignal</span>&lt;<span class="hljs-type">RACTuple</span> *&gt; <span class="hljs-operator">*</span>)combineLatest:(id<span class="hljs-operator">&lt;</span><span class="hljs-type">NSFastEnumeration</span><span class="hljs-operator">&gt;</span>)signals <span class="hljs-type">RAC_WARN_UNUSED_RESULT</span>;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨:</strong> å°†å¤šä¸ªä¿¡å·çš„<code>æœ€æ–°å€¼</code>ç»„åˆåˆ°æ–°ä¿¡å·çš„ä¸€ä¸ª<code>å…ƒç»„</code>ä¸­ï¼Œç›´åˆ°æ‰€æœ‰çš„ä¿¡å·éƒ½<code>sendNext</code>ä¹‹åï¼Œæ–°ä¿¡å·çš„è®¢é˜…è€…æ‰èƒ½æ”¶åˆ°æ­¤å…ƒç»„ã€‚<br><br/></p><p>#ç¤ºä¾‹5:</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs prolog">- (void)combineLatest &#123;<br>    <span class="hljs-symbol">RACSignal</span> *signal1 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal1 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;1&quot;</span>];<br>        [subscriber sendCompleted];<br>        return nil;<br>    &#125;];<br>    <br>    <span class="hljs-symbol">RACSignal</span> *signal2 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal2 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;2.1&quot;</span>];<br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;2.2&quot;</span>];<br>            [subscriber sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <br>    <span class="hljs-symbol">RACSignal</span> *signal3 = [<span class="hljs-symbol">RACSignal</span> createSignal:^<span class="hljs-symbol">RACDisposable</span> *(id&lt;<span class="hljs-symbol">RACSubscriber</span>&gt; subscriber) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++call signal3 block&quot;</span>);<br>        [subscriber sendNext:@<span class="hljs-string">&quot;3.1&quot;</span>];<br>        [[<span class="hljs-symbol">RACScheduler</span> mainThreadScheduler] afterDelay:<span class="hljs-number">2</span> schedule:^&#123;<br>            [subscriber sendNext:@<span class="hljs-string">&quot;3.2&quot;</span>];<br>            [subscriber sendCompleted];<br>        &#125;];<br>        return nil;<br>    &#125;];<br>    <br>    <span class="hljs-symbol">RACSignal</span> *signal4 = [<span class="hljs-symbol">RACSignal</span> combineLatest:@[signal1,signal2,signal3]];<br>    <br>    [signal4 subscribeNext:^(id x) &#123;<br>        <span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;+++++received data:%@&quot;</span>,x);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—:</p><figure class="highlight wasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs wasm"><span class="hljs-number">2019</span><span class="hljs-number">-06</span><span class="hljs-number">-01</span> <span class="hljs-number">02</span>:<span class="hljs-number">30</span>:<span class="hljs-number">08.894</span> +++<span class="hljs-keyword">call</span> signal1 <span class="hljs-keyword">block</span><br><span class="hljs-number">2019</span><span class="hljs-number">-06</span><span class="hljs-number">-01</span> <span class="hljs-number">02</span>:<span class="hljs-number">30</span>:<span class="hljs-number">08.895</span> +++<span class="hljs-keyword">call</span> signal2 <span class="hljs-keyword">block</span><br><span class="hljs-number">2019</span><span class="hljs-number">-06</span><span class="hljs-number">-01</span> <span class="hljs-number">02</span>:<span class="hljs-number">30</span>:<span class="hljs-number">08.895</span> +++<span class="hljs-keyword">call</span> signal3 <span class="hljs-keyword">block</span><br><span class="hljs-number">2019</span><span class="hljs-number">-06</span><span class="hljs-number">-01</span> <span class="hljs-number">02</span>:<span class="hljs-number">30</span>:<span class="hljs-number">08.896</span> +++++received <span class="hljs-keyword">data</span>:&lt;RACTuple: <span class="hljs-number">0x7ff33e49e300</span>&gt; <span class="hljs-punctuation">(</span><br>    <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;2.1&quot;</span>,<br>    <span class="hljs-string">&quot;3.1&quot;</span><br><span class="hljs-punctuation">)</span><br><span class="hljs-number">2019</span><span class="hljs-number">-06</span><span class="hljs-number">-01</span> <span class="hljs-number">02</span>:<span class="hljs-number">30</span>:<span class="hljs-number">10.895</span> +++++received <span class="hljs-keyword">data</span>:&lt;RACTuple: <span class="hljs-number">0x7ff33e4db8d0</span>&gt; <span class="hljs-punctuation">(</span><br>    <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;2.2&quot;</span>,<br>    <span class="hljs-string">&quot;3.1&quot;</span><br><span class="hljs-punctuation">)</span><br><span class="hljs-number">2019</span><span class="hljs-number">-06</span><span class="hljs-number">-01</span> <span class="hljs-number">02</span>:<span class="hljs-number">30</span>:<span class="hljs-number">11.094</span> +++++received <span class="hljs-keyword">data</span>:&lt;RACTuple: <span class="hljs-number">0x7ff33e6e79f0</span>&gt; <span class="hljs-punctuation">(</span><br>    <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;2.2&quot;</span>,<br>    <span class="hljs-string">&quot;3.2&quot;</span><br><span class="hljs-punctuation">)</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼š<br><br/></p><p>1.<code>ä¿¡å·4</code>è®¢é˜…è€…çš„å…ƒç»„ä¸­æ•°æ®çš„é¡ºåºï¼Œæ˜¯æŒ‰ç…§ç»„åˆæ—¶çš„é¡ºåºæ¥çš„ï¼›<br><br/></p><p>2.<code>ä¿¡å·4</code>çš„è®¢é˜…è€…ç¬¬ä¸€æ¬¡è§¦å‘æ˜¯åœ¨æ‰€æœ‰ä¿¡å·éƒ½å‘é€äº†ä¸€é<code>sendNext:</code>ä¹‹åï¼›<br><br/></p><p>3.ä¹‹åå¦‚æœå†æœ‰æŸä¸ªä¿¡å·<code>sendNext:</code>ï¼Œ<code>ä¿¡å·4</code>éƒ½ä¼šå†æ¬¡è§¦å‘å¹¶è¿”å›æœ€æ–°å€¼ç»„æˆçš„å…ƒç»„ï¼Œè¿™æ˜¯å®ƒä¸<code>zip</code>çš„æœ€å¤§ä¸åŒï¼›</p><h3 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h3><p>ä»¥ä¸Šå°±æ˜¯RACä¸­å‡ ç§å¸¸ç”¨ç»„åˆä¿¡å·çš„æ–¹æ³•ï¼Œä½¿ç”¨æ—¶å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚ä»»æ„ç»„åˆæ“ä½œï¼Œå¾ˆå¼ºå¤§ã€æ–¹ä¾¿ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/ReactiveCocoa/ReactiveObjC/blob/master/Documentation/BasicOperators.md">Â©RAC-Github</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RAC-å¼‚æ­¥è¡Œä¸º</title>
    <link href="/2021/05/25/RAC-async.html"/>
    <url>/2021/05/25/RAC-async.html</url>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>OCä¸­çš„å¼‚æ­¥è¡Œä¸ºï¼š</p><ul><li>block</li><li>delegate</li><li>KVO</li><li>é€šçŸ¥</li><li>target-actionæœºåˆ¶</li></ul><p>å¼‚æ­¥è¡Œä¸ºçš„å…±åŒç‚¹ï¼š</p><ul><li>ä½•æ—¶è§¦å‘å¹¶ä¸ç¡®å®šï¼Œè§‚å¯Ÿè€…éœ€è¦ç­‰å¾…å…¶è§¦å‘æ—¶çš„å›è°ƒï¼›</li><li>å¼‚æ­¥è¡Œä¸ºçš„åˆ›å»ºå’Œè§¦å‘å¹¶ä¸åœ¨åŒä¸€å—åŒºåŸŸï¼Œå¾€å¾€æ˜¯åˆ†å¼€çš„ã€‚</li></ul><p>å¼‚æ­¥è¡Œä¸ºçš„ç¼ºç‚¹ï¼š</p><ul><li>å¼‚æ­¥è¡Œä¸ºçš„åˆ›å»ºå’Œå›è°ƒç›¸å¯¹åˆ†æ•£ï¼Œè¿™ä¸ç¬¦åˆä»£ç è§„èŒƒä¸­â€é«˜å†…èšâ€çš„è¦æ±‚ï¼›</li><li>ä½¿ç”¨ä¸å½“æ—¶ï¼Œè¿™äº›è¡Œä¸ºå¾€å¾€ä¼šé€ æˆå¾ªç¯å¼•ç”¨ç­‰é—®é¢˜ã€‚</li></ul><p><a href="https://github.com/ReactiveCocoa/ReactiveObjC">RACæ–‡æ¡£</a> æ‘˜è¦ï¼š</p><blockquote><p>One of the major advantages of RAC is that it provides a single, unified approach to dealing with asynchronous behaviors, including delegate methods, callback blocks, target-action mechanisms, notifications, and KVO.</p></blockquote><p>RAC å€Ÿé‰´äº†<a href="https://github.com/ReactiveX">RX</a>çš„æ€æƒ³ï¼Œå®ƒå¤„ç†è¿™äº›é—®é¢˜çš„æ ¸å¿ƒåœ¨äº<code>ä¿¡å·</code>ï¼š</p><p>é’ˆå¯¹å†…èšé—®é¢˜ï¼ŒRACå°†å¼‚æ­¥è¡Œä¸ºçš„å®ç°å°è£…åœ¨ä¿¡å·çš„<code>didSubscribe</code>block ä¸­ï¼Œä»è€Œèƒ½å¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¥å£ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨åˆ›å»ºå®Œä¿¡å·åè®¢é˜…ä¿¡å·ï¼Œå³å¯åœ¨å¼‚æ­¥è¡Œä¸ºè§¦å‘æ—¶æ”¶åˆ°å›è°ƒï¼Œè¿™æ ·åˆ›å»ºã€ç›‘å¬ã€ä¸šåŠ¡é€»è¾‘èšåˆåˆ°äº†ä¸€èµ·ï¼›</p><p>é’ˆå¯¹ç¬¬äºŒç‚¹ï¼Œä¿¡å·çš„ block å†…å‘è®¢é˜…è€…å‘é€äº†<code>sendNext:</code>äº‹ä»¶åï¼Œä¼šè‡ªåŠ¨æ¸…ç†èµ„æºå’Œå¼•ç”¨ï¼Œä»è€Œè§£å†³äº†å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p><p>ä¸‹é¢å°†åˆ†åˆ«ä»‹ç»å®ƒä»¬çš„ä½¿ç”¨å’Œå®ç°åŸç†ã€‚</p><h3 id="block"><a href="#block" class="headerlink" title="block"></a>block</h3><p>block åˆ›å»ºå®Œæˆååœ¨éšåçš„æŸä¸ªæ—¶é—´ç‚¹è¢«è°ƒç”¨ï¼Œä»è€Œå®ç°å…¶å†…éƒ¨å®šä¹‰å¥½çš„ä¸šåŠ¡ã€‚RACä¸­ block çš„ä½¿ç”¨å¦‚ä¸‹ï¼š</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-type">id</span>&lt;RACSubscriber&gt; subscriber;<br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    <br>    <span class="hljs-comment">//1.ä¿¡å·çš„ä½¿ç”¨</span><br>    RACSignal *s1 = [RACSignal createSignal:^RACDisposable *(<span class="hljs-type">id</span>&lt;RACSubscriber&gt; subscriber) &#123;<br>        _subscriber = subscriber;<br>        <span class="hljs-keyword">return</span> [RACDisposable disposableWithBlock:^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++s1 Disposed~&quot;</span>);<br>        &#125;];<br>    &#125;];<br>    <br>    <span class="hljs-comment">//è®¢é˜…æ¶ˆæ¯ï¼Œåˆ›å»ºblock</span><br>    [s1 subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++è®¢é˜…è§¦å‘:%@&quot;</span>,x);<br>    &#125;];<br>    <span class="hljs-comment">//è°ƒç”¨block</span><br>    [_subscriber sendNext:<span class="hljs-string">@&quot;Hello world~&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œ[s1 subscribeNext:]è®¢é˜…ä¿¡å·æ—¶ï¼Œæˆ‘ä»¬ä¼ å…¥äº†ä¸€ä¸ª nextBlockï¼Œå®ƒä¼šè¢«ä¿å­˜èµ·æ¥ä»¥åœ¨åç»­è¢«è°ƒç”¨ã€‚subscribeNext:çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//RACSignal.m</span><br>- (RACDisposable *)subscribeNext:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">id</span> x))nextBlock &#123;<br><span class="hljs-built_in">NSCParameterAssert</span>(nextBlock != <span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">//1.åˆ›å»ºè®¢é˜…è€…</span><br>RACSubscriber *o = [RACSubscriber subscriberWithNext:nextBlock error:<span class="hljs-literal">NULL</span> completed:<span class="hljs-literal">NULL</span>];<br><span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> subscribe:o];<br>&#125;<br><br><span class="hljs-comment">//RACSubscriber.m</span><br>+ (<span class="hljs-keyword">instancetype</span>)subscriberWithNext:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">id</span> x))next error:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSError</span> *error))error completed:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">void</span>))completed &#123;<br>RACSubscriber *subscriber = [[<span class="hljs-keyword">self</span> alloc] init];<br><br><span class="hljs-comment">//2.ä¿å­˜ block</span><br>subscriber-&gt;_next = [next <span class="hljs-keyword">copy</span>]; <br>subscriber-&gt;_error = [error <span class="hljs-keyword">copy</span>];<br>subscriber-&gt;_completed = [completed <span class="hljs-keyword">copy</span>];<br><br><span class="hljs-keyword">return</span> subscriber;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿¡å·å†…éƒ¨è‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ª<code>è®¢é˜…è€…</code>å¯¹è±¡ï¼Œå¹¶å°†æˆ‘ä»¬ä¼ å…¥çš„ nextBlock ä¿å­˜äº†èµ·æ¥ã€‚</p><p>éšååœ¨ç¤ºä¾‹ä¸­æˆ‘ä»¬è°ƒç”¨äº†[_subscriber sendNext:]ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)sendNext:(<span class="hljs-type">id</span>)value &#123;<br><span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br><span class="hljs-type">void</span> (^nextBlock)(<span class="hljs-type">id</span>) = [<span class="hljs-keyword">self</span>.next <span class="hljs-keyword">copy</span>];<br><span class="hljs-keyword">if</span> (nextBlock == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">return</span>;<br>nextBlock(value);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å³è°ƒç”¨ sendNext: ç›¸å½“äºè°ƒç”¨äº†ä¹‹å‰ä¿å­˜åœ¨è®¢é˜…è€…å†…éƒ¨çš„<code>nextBlock</code>å¹¶å‘å…¶è¾“å…¥äº†ä¸€ä¸ªæ–°å€¼ã€‚</p><h3 id="KVO"><a href="#KVO" class="headerlink" title="KVO"></a>KVO</h3><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *text;<br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    [[<span class="hljs-keyword">self</span> rac_valuesAndChangesForKeyPath:<span class="hljs-string">@&quot;text&quot;</span><br>                                  options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span><br>                                 observer:<span class="hljs-keyword">self</span>]<br>     subscribeNext:^(RACTwoTuple&lt;<span class="hljs-type">id</span>,<span class="hljs-built_in">NSDictionary</span> *&gt; *x) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++self.text update:%@&quot;</span>,x.first);<br>    &#125;];<br>    <br>    <span class="hljs-keyword">self</span>.text = <span class="hljs-string">@&quot;Text1&quot;</span>;<br>    _text = <span class="hljs-string">@&quot;Text2&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">++self.text <span class="hljs-keyword">update</span>:Text1<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼šä¸€å®šè¦ä½¿ç”¨<code>self.xxx</code>æ¥èµ‹å€¼ï¼Œä½¿ç”¨ä¸‹åˆ’çº¿çš„æ–¹å¼æ˜¯ç»™å±æ€§çš„æˆå‘˜å˜é‡èµ‹å€¼ï¼Œå¹¶ä¸ä¼šè§¦å‘KVOå›è°ƒ~~</p><ul><li><strong>RACçš„KVOå®ç°åŸç†ï¼š</strong></li></ul><p>RAC ç‰ˆçš„ KVO ä¸ OC ç‰ˆçš„åœ¨è°ƒç”¨æ–¹æ³•å’Œå‚æ•°ä¸Šå·®åˆ«å¹¶ä¸å¤§ï¼Œrac_valuesAndChangesForKeyPath:options:observer:æ–¹æ³•æ˜¯RACåœ¨ NSObject åˆ†ç±»ä¸­å®šä¹‰çš„ä¸€ä¸ªæ–¹æ³•ã€‚å®ƒçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªä¿¡å·ï¼Œä¾›æˆ‘ä»¬è®¢é˜…å¹¶è‡ªå®šä¹‰å›è°ƒblockã€‚å…¶å†…éƒ¨æœ€ç»ˆæ˜¯é€šè¿‡<code>RACKVOTrampoline</code>æ¥ç®¡ç†å’Œå®ç°KVOçš„ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//RACKVOTrampoline.m</span><br>- (<span class="hljs-keyword">instancetype</span>)initWithTarget:(__<span class="hljs-keyword">weak</span> <span class="hljs-built_in">NSObject</span> *)target <br>observer:(__<span class="hljs-keyword">weak</span> <span class="hljs-built_in">NSObject</span> *)observer <br>keyPath:(<span class="hljs-built_in">NSString</span> *)keyPath <br>options:(<span class="hljs-built_in">NSKeyValueObservingOptions</span>)options <br>block:(RACKVOBlock)block &#123;<br><br><span class="hljs-built_in">NSCParameterAssert</span>(keyPath != <span class="hljs-literal">nil</span>);<br><span class="hljs-built_in">NSCParameterAssert</span>(block != <span class="hljs-literal">nil</span>);<br><br><span class="hljs-built_in">NSObject</span> *strongTarget = target;<br><span class="hljs-keyword">if</span> (strongTarget == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br><br><span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init];<br><br>_keyPath = [keyPath <span class="hljs-keyword">copy</span>];<br><br>_block = [block <span class="hljs-keyword">copy</span>];<br>_weakTarget = target;<br>_unsafeTarget = strongTarget;<br>_observer = observer;<br><br>[RACKVOProxy.sharedProxy addObserver:<span class="hljs-keyword">self</span> forContext:(__bridge <span class="hljs-type">void</span> *)<span class="hljs-keyword">self</span>];<br>[strongTarget addObserver:RACKVOProxy.sharedProxy forKeyPath:<span class="hljs-keyword">self</span>.keyPath options:options context:(__bridge <span class="hljs-type">void</span> *)<span class="hljs-keyword">self</span>];<br><br>[strongTarget.rac_deallocDisposable addDisposable:<span class="hljs-keyword">self</span>];<br>[<span class="hljs-keyword">self</span>.observer.rac_deallocDisposable addDisposable:<span class="hljs-keyword">self</span>];<br><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)observeValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath ofObject:(<span class="hljs-type">id</span>)object change:(<span class="hljs-built_in">NSDictionary</span> *)change context:(<span class="hljs-type">void</span> *)context &#123;<br><span class="hljs-keyword">if</span> (context != (__bridge <span class="hljs-type">void</span> *)<span class="hljs-keyword">self</span>) &#123;<br>[<span class="hljs-variable language_">super</span> observeValueForKeyPath:keyPath ofObject:object change:change context:context];<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>RACKVOBlock block;<br><span class="hljs-type">id</span> observer;<br><span class="hljs-type">id</span> target;<br><br><span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>block = <span class="hljs-keyword">self</span>.block;<br>observer = <span class="hljs-keyword">self</span>.observer;<br>target = <span class="hljs-keyword">self</span>.weakTarget;<br>&#125;<br><br><span class="hljs-keyword">if</span> (block == <span class="hljs-literal">nil</span> || target == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">return</span>;<br><br>block(target, observer, change);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>RACKVOTrampoline</code>å°†æˆ‘ä»¬ä¼ å…¥çš„<code>observer</code>å’Œ<code>target</code>åŠå›è°ƒ<code>block</code>ä¿å­˜äº†èµ·æ¥ã€‚å±æ€§å˜åŒ–åKVOä»£ç†ä¸­å›è°ƒäº† block å¹¶ä¼ å›å˜åŒ–çš„ä¿¡æ¯ã€‚</p><h3 id="KVC"><a href="#KVC" class="headerlink" title="KVC"></a>KVC</h3><p>KVCæœ¬èº«ä¸ç®—å¼‚æ­¥è¡Œä¸ºï¼Œå› ä¸ºOCä¸­é€šè¿‡[self valueForKey:@â€textâ€]ï¼Œä½ èƒ½ç«‹åˆ»å¾—åˆ°<code>text</code>å±æ€§çš„å€¼ã€‚ä½†æ˜¯ RAC è¿˜æ˜¯å¯¹å…¶è¿›è¡Œäº†å°è£…å’Œæ‰©å±•ï¼Œä½¿å¾— KVC æ—¢èƒ½ç«‹åˆ»è·å–å±æ€§çš„å€¼ï¼Œåˆèƒ½å’Œ KVO ä¸€æ ·æŒç»­æ”¶åˆ°å±æ€§å˜åŒ–çš„å›è°ƒã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *text;<br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    [[<span class="hljs-keyword">self</span> rac_valuesForKeyPath:<span class="hljs-string">@&quot;text&quot;</span> observer:<span class="hljs-keyword">self</span>] subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++self.text By KVC:%@&quot;</span>,x);<br>    &#125;];<br>    <br>    <span class="hljs-keyword">self</span>.text = <span class="hljs-string">@&quot;Text1&quot;</span>;<br>    _text = <span class="hljs-string">@&quot;Text2&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lasso">++++<span class="hljs-built_in">self</span>.text <span class="hljs-keyword">By</span> KVC:(<span class="hljs-built_in">null</span>)<br>++++<span class="hljs-built_in">self</span>.text <span class="hljs-keyword">By</span> KVC:Text1<br></code></pre></td></tr></table></figure><p>ä»æ—¥å¿—æ¥çœ‹ï¼Œè°ƒç”¨ rac_valuesForKeyPath: å¹¶è®¢é˜…å…¶è¿”å›çš„ä¿¡å·åï¼Œç«‹åˆ»æ”¶åˆ°äº†ä¸€æ¬¡å›è°ƒï¼Œè¿”å›å±æ€§å½“å‰çš„å€¼<code>null</code>ï¼›</p><p>è°ƒç”¨ self.text &#x3D; @â€Text1â€; ç»™å±æ€§èµ‹å€¼åï¼Œè®¢é˜…è€…çš„å›è°ƒå†æ¬¡è§¦å‘å¹¶ä¼ å›å½“å‰çš„æ–°å€¼ã€‚</p><p>å†è°ƒç”¨ _text &#x3D; @â€Text2â€; ç»™å±æ€§çš„æˆå‘˜å˜é‡èµ‹å€¼æ—¶ï¼Œå¹¶æœªè§¦å‘è®¢é˜…è€…çš„å›è°ƒï¼Œè¿™ä¸ RAC çš„ KVO ä¸€æ ·ã€‚</p><p>ç»“åˆè¿™äº›æƒ…å†µæ¥çœ‹ï¼ŒRAC çš„ KVC ä¼¼ä¹ä¸å…¶ KVO æœ‰å¯†åˆ‡å…³ç³»ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹å…¶æ–¹æ³•çš„å®ç°ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (RACSignal *)rac_valuesForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath observer:(__<span class="hljs-keyword">weak</span> <span class="hljs-built_in">NSObject</span> *)observer &#123;<br><span class="hljs-keyword">return</span> [[[<span class="hljs-keyword">self</span><br>rac_valuesAndChangesForKeyPath:keyPath options:<span class="hljs-built_in">NSKeyValueObservingOptionInitial</span> observer:observer]<br>map:^(RACTuple *value) &#123;<br><span class="hljs-comment">// -map: because it doesn&#x27;t require the block trampoline that -reduceEach: uses</span><br><span class="hljs-keyword">return</span> value[<span class="hljs-number">0</span>];<br>&#125;]<br>setNameWithFormat:<span class="hljs-string">@&quot;RACObserve(%@, %@)&quot;</span>, RACDescription(<span class="hljs-keyword">self</span>), keyPath];<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒRAC çš„ KVC å†…éƒ¨åªæ˜¯è°ƒç”¨äº†å…¶ KVO æ–¹æ³•å¹¶è¿”å›å…ƒç»„çš„ç¬¬ä¸€ä¸ªå€¼ã€‚è¿™å°±ä¸éš¾ç†è§£ä¸Šé¢çš„çŒœæµ‹äº†~</p><h3 id="é€šçŸ¥"><a href="#é€šçŸ¥" class="headerlink" title="é€šçŸ¥"></a>é€šçŸ¥</h3><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">[[[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] rac_addObserverForName:<span class="hljs-built_in">UIKeyboardWillShowNotification</span><br>                                                       object:<span class="hljs-literal">nil</span>]<br>subscribeNext:^(<span class="hljs-built_in">NSNotification</span> *x) &#123;<br>     <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++é€šçŸ¥:%@&quot;</span>,x);<br>&#125;];<br></code></pre></td></tr></table></figure><p>ç›‘å¬é”®ç›˜é€šçŸ¥å¹¶è®¢é˜…å…¶è¿”å›çš„ä¿¡å·ï¼Œå¾…é”®ç›˜å¼¹å‡ºæˆ–æ”¶å›æ—¶å³å¯è§¦å‘è®¢é˜…è€…çš„å›è°ƒã€‚å…¶å®å†…éƒ¨å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@implementation NSNotificationCenter (<span class="hljs-params">RACSupport</span>)</span><br><br>- (RACSignal *)rac_addObserverForName:(NSString *)notificationName <span class="hljs-built_in">object</span>:(<span class="hljs-built_in">id</span>)<span class="hljs-built_in">object</span> &#123;<br><span class="hljs-meta">@unsafeify(<span class="hljs-params"><span class="hljs-built_in">object</span></span>);</span><br><span class="hljs-keyword">return</span> [[RACSignal createSignal:^(<span class="hljs-built_in">id</span>&lt;RACSubscriber&gt; subscriber) &#123;<br><span class="hljs-meta">@strongify(<span class="hljs-params"><span class="hljs-built_in">object</span></span>);</span><br><span class="hljs-built_in">id</span> observer = [self addObserverForName:notificationName <span class="hljs-built_in">object</span>:<span class="hljs-built_in">object</span> queue:nil usingBlock:^(NSNotification *note) &#123;<br>[subscriber sendNext:note];<br>&#125;];<br><br><span class="hljs-keyword">return</span> [RACDisposable disposableWithBlock:^&#123;<br>[self removeObserver:observer];<br>&#125;];<br>&#125;] setNameWithFormat:@<span class="hljs-string">&quot;-rac_addObserverForName: %@ object: &lt;%@: %p&gt;&quot;</span>, notificationName, [<span class="hljs-built_in">object</span> <span class="hljs-keyword">class</span>], <span class="hljs-built_in">object</span>];<br>&#125;<br><span class="hljs-meta">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨RACå¯¹ NSNotificationCenter çš„æ‰©å±•ä¸­ï¼Œç›‘å¬é€šçŸ¥åå®é™…ä¸Šåªæ˜¯è°ƒç”¨äº†OCåŸç”Ÿçš„é€šçŸ¥ç›‘å¬æ–¹æ³•ï¼Œåœ¨åŸç”Ÿå›è°ƒä¸­å‘è®¢é˜…è€…å‘é€æ¶ˆæ¯~</p><h3 id="target-action"><a href="#target-action" class="headerlink" title="target-action"></a>target-action</h3><p>#ç¤ºä¾‹:</p><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scheme">[[<span class="hljs-name">_mBtn1</span> rac_signalForControlEvents:UIControlEventTouchUpInside] subscribeNext:^(<span class="hljs-name">UIControl</span> *x) &#123;<br>    NSLog(<span class="hljs-name">@</span><span class="hljs-string">&quot;++clicked Btn1~&quot;</span>)<span class="hljs-comment">;</span><br>&#125;]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å…¶å†…éƒ¨å®ç°ä¸ºï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-meta">@implementation</span> <span class="hljs-type">UIControl</span> (<span class="hljs-type">RACSignalSupport</span>)<br><br><span class="hljs-operator">-</span> (<span class="hljs-type">RACSignal</span> <span class="hljs-operator">*</span>)rac_signalForControlEvents:(<span class="hljs-type">UIControlEvents</span>)controlEvents &#123;<br><span class="hljs-meta">@weakify</span>(<span class="hljs-keyword">self</span>);<br><br><span class="hljs-keyword">return</span> [[<span class="hljs-type">RACSignal</span><br>createSignal:<span class="hljs-operator">^</span>(id<span class="hljs-operator">&lt;</span><span class="hljs-type">RACSubscriber</span><span class="hljs-operator">&gt;</span> subscriber) &#123;<br><span class="hljs-meta">@strongify</span>(<span class="hljs-keyword">self</span>);<br><span class="hljs-comment">//OCåŸç”Ÿæ–¹æ³•</span><br>[<span class="hljs-keyword">self</span> addTarget:subscriber action:<span class="hljs-meta">@selector</span>(sendNext:) forControlEvents:controlEvents];<br><br><span class="hljs-type">RACDisposable</span> <span class="hljs-operator">*</span>disposable <span class="hljs-operator">=</span> [<span class="hljs-type">RACDisposable</span> disposableWithBlock:<span class="hljs-operator">^</span>&#123;<br>[subscriber sendCompleted];<br>&#125;];<br>[<span class="hljs-keyword">self</span>.rac_deallocDisposable addDisposable:disposable];<br><br><span class="hljs-keyword">return</span> [<span class="hljs-type">RACDisposable</span> disposableWithBlock:<span class="hljs-operator">^</span>&#123;<br><span class="hljs-meta">@strongify</span>(<span class="hljs-keyword">self</span>);<br>[<span class="hljs-keyword">self</span>.rac_deallocDisposable removeDisposable:disposable];<br>[<span class="hljs-keyword">self</span> removeTarget:subscriber action:<span class="hljs-meta">@selector</span>(sendNext:) forControlEvents:controlEvents];<br>&#125;];<br>&#125;]<br>setNameWithFormat:@<span class="hljs-string">&quot;%@ -rac_signalForControlEvents: %lx&quot;</span>, <span class="hljs-type">RACDescription</span>(<span class="hljs-keyword">self</span>), (unsigned long)controlEvents];<br>&#125;<br><span class="hljs-meta">@end</span><br></code></pre></td></tr></table></figure><p>RACåœ¨<code>UIControl</code>çš„åˆ†ç±»ä¸­è¿”å›ä¸€ä¸ªä¿¡å·ï¼Œä¿¡å·ä¸­é€šè¿‡OCåŸç”Ÿçš„â€addTarget:action:forControlEvents:â€æ·»åŠ äº†<code>subscriber</code>ä¸º<code>target</code>ï¼Œè€Œå…¶å“åº”æ–¹æ³•ä¸º<code>sendNext:</code>ã€‚æ‰€ä»¥ï¼Œå½“æŒ‰é’®è¢«ç‚¹å‡»åä¼šè§¦å‘<code>subscriber</code>çš„<code>sendNext:</code>æ–¹æ³•ï¼Œéšå³å›è°ƒè®¢é˜…è€…çš„ blockã€‚</p><h3 id="delegate"><a href="#delegate" class="headerlink" title="delegate"></a>delegate</h3><p>RACä¸­çš„<code>delegate</code>å¯ä»¥é€šè¿‡<code>RACSubject</code>æ¥å®ç°ã€‚å®˜æ–¹æ–‡æ¡£ä¸­å…³äºæ­¤ç±»çš„æè¿°å¦‚ä¸‹ï¼š</p><blockquote><p>A subject, represented by the RACSubject class, is a signal that can be manually controlled.<br>Subjects can be thought of as the â€œmutableâ€ variant of a signal, much like NSMutableArray is for NSArray. They are extremely useful for bridging non-RAC code into the world of signals.<br>For example, instead of handling application logic in block callbacks, the blocks can simply send events to a shared subject instead. The subject can then be returned as a RACSignal, hiding the implementation detail of the callbacks.</p></blockquote><p><code>RACSubject</code>ç»§æ‰¿è‡ª<code>RACSignal</code>ï¼Œæ˜¯ä¸€ç§å¯ä»¥ç”±æˆ‘ä»¬æ§åˆ¶çš„ä¿¡å·ã€‚</p><p>ç›¸æ¯”äºåœ¨æŸä¸ª block å›è°ƒä¸­è‡ªå·±å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ŒRAC å¯ä»¥è®© block å‘æŸä¸ªå…±äº«çš„ subject å‘é€äº‹ä»¶å¹¶è®©å…¶å¤„ç†è¯¥ä¸šåŠ¡é€»è¾‘ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//HelloRACController.m</span><br>- (<span class="hljs-keyword">IBAction</span>)onAction2:(<span class="hljs-type">id</span>)sender &#123;<br>    <span class="hljs-comment">//pushåˆ°æ–°ç•Œé¢</span><br>    ViewControllerII *controller = [[<span class="hljs-built_in">UIStoryboard</span> storyboardWithName:<span class="hljs-string">@&quot;Main&quot;</span> bundle:<span class="hljs-literal">nil</span>]<br>                                    instantiateViewControllerWithIdentifier:<span class="hljs-string">@&quot;ViewControllerII&quot;</span>];<br>    <span class="hljs-comment">//è®¾ç½®ä»£ç†ä¿¡å·</span><br>    controller.delegate = [RACSubject subject];<br>    <br>    <span class="hljs-comment">//è®¢é˜…ä»£ç†</span><br>    [controller.delegate subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>,x);<br>    &#125;];<br>    [<span class="hljs-keyword">self</span>.navigationController pushViewController:controller animated:<span class="hljs-literal">YES</span>];<br>&#125;<br><br><span class="hljs-comment">//ViewControllerII.h</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewControllerII</span> : <span class="hljs-title">UIViewController</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) RACSubject *delegate;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewControllerII</span></span><br><br>- (<span class="hljs-keyword">IBAction</span>)onDismiss:(<span class="hljs-type">id</span>)sender<br>&#123;<br>    <span class="hljs-comment">//RACå›è°ƒ</span><br>    [<span class="hljs-keyword">self</span>.delegate sendNext:<span class="hljs-string">@&quot;++ViewControllerII Closed~&quot;</span>];<br>    [<span class="hljs-keyword">self</span>.navigationController popViewControllerAnimated:<span class="hljs-literal">YES</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p><code>RACSubject</code>æ˜¯ä¿¡å·çš„å­ç±»ï¼Œæˆ‘ä»¬åœ¨ A ä¸­è®¢é˜… B ä¸­çš„ä¿¡å·ï¼Œå¹¶åœ¨ B ä¸­å‘ A ä¸­è®¢é˜…è€…å‘é€æ¶ˆæ¯ï¼Œä»¥æ­¤å®ç°ä»£ç†çš„åŠŸèƒ½ã€‚</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>ç»¼ä¸Šï¼ŒRACåœ¨å¯¹å¼‚æ­¥è¡Œä¸ºè¿›è¡Œå°è£…æ—¶æ‰€åšçš„å·¥ä½œä¸»è¦ä¸ºï¼š</p><ul><li>å°†è¿™äº›è¡Œä¸ºå°è£…åˆ°ä¿¡å·çš„ block ä¸­ï¼ˆæœ‰äº›åªæ˜¯è°ƒç”¨åŸç”Ÿæ¥å£ï¼‰ï¼›</li><li>æˆ‘ä»¬åªé¡»è®¢é˜…æ­¤ä¿¡å·å°±èƒ½ä»¥ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼å®ç°ä¸šåŠ¡ä»£ç çš„å†…èšï¼›</li><li>ä¿¡å·å‘è®¢é˜…è€…å‘é€å®Œäº‹ä»¶ä¹‹åéšå³æ¸…ç†èµ„æºå’Œå¼•ç”¨ï¼›</li></ul><p>RACå°†è¿™äº›å¼‚æ­¥è¡Œä¸ºçš„åˆ›å»ºã€ç›‘å¬ã€ä¸šåŠ¡å›è°ƒé›†ä¸­åœ¨ä¸€ç‰‡ä»£ç åŒºåŸŸæˆ–äº¤ç”±RACå†…éƒ¨å®ç°ï¼Œè¿™ç¬¦åˆé«˜å†…èšçš„è®¾è®¡æ€æƒ³ï¼Œå€¼å¾—å­¦ä¹ å’Œå€Ÿé‰´~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/ReactiveCocoa/ReactiveObjC/blob/master/Documentation/FrameworkOverview.md">Â©RAC-Github</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RAC-ä¿¡å·ä¸è®¢é˜…è€…</title>
    <link href="/2021/05/25/RAC-signal.html"/>
    <url>/2021/05/25/RAC-signal.html</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-ä¿¡å·"><a href="#ä¸€-ä¿¡å·" class="headerlink" title="ä¸€.ä¿¡å·"></a>ä¸€.ä¿¡å·</h3><h4 id="1-ä¿¡å·æ˜¯å•¥"><a href="#1-ä¿¡å·æ˜¯å•¥" class="headerlink" title="1.ä¿¡å·æ˜¯å•¥"></a>1.ä¿¡å·æ˜¯å•¥</h4><p><a href="https://github.com/ReactiveCocoa/ReactiveObjC/blob/master/Documentation/FrameworkOverview.md">RACæ–‡æ¡£</a> ä¸­å…³äº<code>RACSignal</code>çš„æè¿°:</p><blockquote><p>A signal, represented by the RACSignal class, is a push-driven stream.<br>Signals generally represent data that will be delivered in the future. As work is performed or data is received, values are sent on the signal, which pushes them out to any subscribers. Users must subscribe to a signal in order to access its values.</p></blockquote><ul><li>ä¿¡å·æ˜¯ä¸€ç§ â€œæ¨é€â€ ç±»å‹çš„æµã€‚</li><li>ä¿¡å·ä»£è¡¨ç€å°†æ¥è¦ä¼ è¾“çš„æ•°æ®ï¼Œå€¼é€šè¿‡ä¿¡å·ä¼ é€’ç»™è®¢é˜…è€…ï¼›</li><li>ç”¨æˆ·é¡»è®¢é˜…ä¿¡å·æ‰èƒ½æ¥æ”¶åˆ°è¿™äº›å€¼ã€‚</li></ul><h4 id="2-å†·çƒ­ä¿¡å·"><a href="#2-å†·çƒ­ä¿¡å·" class="headerlink" title="2.å†·çƒ­ä¿¡å·"></a>2.å†·çƒ­ä¿¡å·</h4><p>ä¿¡å·åˆ†ä¸º<code>å†·ä¿¡å·</code>å’Œ<code>çƒ­ä¿¡å·</code>ä¸¤ç§ï¼š</p><ul><li>å†·ä¿¡å·æ˜¯è¢«åŠ¨çš„ï¼Œè¢«è®¢é˜…ä¹‹åæ‰èƒ½å‘é€æ¶ˆæ¯ï¼›</li><li>çƒ­ä¿¡å·æ˜¯ä¸»åŠ¨çš„ï¼Œå³ä½¿æœªè¢«è®¢é˜…ä¹Ÿèƒ½ä¸æ–­æ¨é€æ–°æ¶ˆæ¯ï¼›</li><li>å†·ä¿¡å·åªèƒ½1-1ï¼Œå¯¹åº”ä¸€ä¸ªè®¢é˜…è€…ï¼Œå½“æœ‰æ–°è®¢é˜…è€…æ—¶æ¶ˆæ¯ä¼šé‡æ–°å‘é€ä¸€éï¼›</li><li>çƒ­ä¿¡å·å¯ä»¥1-Nï¼Œå¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€…ï¼Œä¿¡å·å¯ä¸å¤šä¸ªè®¢é˜…è€…å…±äº«ä¿¡æ¯ï¼›</li></ul><h5 id="2-1-å†·ä¿¡å·"><a href="#2-1-å†·ä¿¡å·" class="headerlink" title="#2.1.å†·ä¿¡å·"></a>#2.1.å†·ä¿¡å·</h5><ul><li>RACDynamicSignal</li><li>RACEmptySignal</li><li>RACErrorSignal</li><li>RACReturnSignal</li><li>RACChannelTerminal</li></ul><h5 id="2-2-çƒ­ä¿¡å·"><a href="#2-2-çƒ­ä¿¡å·" class="headerlink" title="#2.2.çƒ­ä¿¡å·"></a>#2.2.çƒ­ä¿¡å·</h5><ul><li>RACSubject</li><li>RACBehaviorSubject</li><li>RACGroupedSignal</li><li>RACReplaySubject</li></ul><h3 id="äºŒ-è®¢é˜…è€…"><a href="#äºŒ-è®¢é˜…è€…" class="headerlink" title="äºŒ.è®¢é˜…è€…"></a>äºŒ.è®¢é˜…è€…</h3><p>å…³äº<code>RACSubscriber</code>çš„æè¿°:</p><blockquote><p>A subscriber is anything that is waiting or capable of waiting for events from a signal. Within RAC, a subscriber is represented as any object that conforms to the RACSubscriber protocol.</p></blockquote><blockquote><p>Subscriptions retain their signals, and are automatically disposed of when the signal completes or errors. Subscriptions can also be disposed of manually.</p></blockquote><ul><li>è®¢é˜…è€…è¡¨ç¤ºæ­£åœ¨ç­‰å¾…ä¿¡å·å‘é€äº‹ä»¶çš„å¯¹è±¡ã€‚</li><li>å½“ä¿¡å·æœ‰æ–°æ•°æ®æ—¶ï¼Œé€šè¿‡è¿™ä¸ªè®¢é˜…è€…å‘é€æ–°å€¼ã€‚</li><li>è®¢é˜…è€…åœ¨ä¿¡å·å‘é€å®Œæˆæˆ–è€…é”™è¯¯äº‹ä»¶æ—¶ä¼šè‡ªåŠ¨é”€æ¯ã€‚</li></ul><hr><p>è¿™äº›å…³äº<code>ä¿¡å·</code>ä¸<code>è®¢é˜…è€…</code>çš„æè¿°å¾ˆå®¹æ˜“è®©äººè”æƒ³åˆ°<code>APNs</code>ï¼Œä¸¤è€…æœºåˆ¶å¾ˆç›¸ä¼¼ï¼š</p><ul><li>iOSè®¾å¤‡æå‰æ³¨å†Œæ¨é€æœåŠ¡ï¼ˆè®¢é˜…ï¼‰ï¼›</li><li>è‹¹æœçš„æ¨é€æœåŠ¡å™¨æ¨é€æ¶ˆæ¯ï¼ˆäº‹ä»¶ï¼‰ï¼›</li><li>iOSè®¾å¤‡æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶å¤„ç†è‡ªå·±çš„ä¸šåŠ¡ï¼ˆå“åº”ï¼‰ã€‚</li></ul><p>è¿™é‡Œï¼ŒiOSè®¾å¤‡å°±æ˜¯è®¢é˜…è€…ï¼Œè‹¹æœçš„ APNs æœåŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è€Œè¢«è§†ä¸ºä¿¡å·æµã€‚äºŒè€…æ˜¯ N å¯¹ 1 çš„å…³ç³»ã€‚</p><h3 id="ä¸‰-å†·ä¿¡å·è§£è¯»"><a href="#ä¸‰-å†·ä¿¡å·è§£è¯»" class="headerlink" title="ä¸‰.å†·ä¿¡å·è§£è¯»"></a>ä¸‰.å†·ä¿¡å·è§£è¯»</h3><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs wren">@<span class="hljs-title function_">property</span> (<span class="hljs-variable">nonatomic</span>, <span class="hljs-variable">strong</span>) <span class="hljs-variable">id</span><span class="hljs-operator">&lt;</span><span class="hljs-title class_">RACSubscriber</span><span class="hljs-operator">&gt;</span> <span class="hljs-variable">subscriber</span>;<br><br><span class="hljs-operator">-</span> (<span class="hljs-variable">void</span>)<span class="hljs-title function_">coldSignal</span> &#123;<br>    <span class="hljs-comment">//1.åˆ›å»ºä¿¡å·</span><br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        <span class="hljs-comment">//^didSubscribeä¸­æ‰§è¡Œä»»åŠ¡</span><br>        <br>        <span class="hljs-variable">_subscriber</span> <span class="hljs-operator">=</span> <span class="hljs-variable">subscriber</span>;<br>        <span class="hljs-comment">//[subscriber sendError:];</span><br>        <span class="hljs-comment">//[subscriber sendCompleted];</span><br>        <br>        <span class="hljs-keyword">return</span> [<span class="hljs-title class_">RACDisposable</span> <span class="hljs-variable">disposableWithBlock</span>:<span class="hljs-operator">^</span>&#123;<br>            <span class="hljs-comment">//æ¸…ç†èµ„æº</span><br>        &#125;];<br>    &#125;];<br>    <span class="hljs-comment">//2.è®¢é˜…ä¿¡å·</span><br>    [<span class="hljs-variable">s1</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-comment">//4.æ¥æ”¶æ•°æ®</span><br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++received value1:%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br>    <span class="hljs-comment">//3.è®¢é˜…ä¿¡å·</span><br>    [<span class="hljs-variable">s1</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-comment">//5.æ¥æ”¶æ•°æ®</span><br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++received value2:%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br>    [<span class="hljs-variable">_subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;x&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">received value2:x</span><br></code></pre></td></tr></table></figure><h4 id="1-åˆ›å»ºä¿¡å·"><a href="#1-åˆ›å»ºä¿¡å·" class="headerlink" title="1.åˆ›å»ºä¿¡å·"></a>1.åˆ›å»ºä¿¡å·</h4><p>#1.1.ç±»æ–¹æ³•:</p><br/><p>è°ƒç”¨<code>RACSignal</code>çš„ç±»æ–¹æ³•åˆ›å»ºä¸€ä¸ªä¿¡å·ï¼š</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        <span class="hljs-comment">//^didSubscribeä¸­æ‰§è¡Œä»»åŠ¡</span><br>        <span class="hljs-keyword">return</span> [<span class="hljs-title class_">RACDisposable</span> <span class="hljs-variable">disposableWithBlock</span>:<span class="hljs-operator">^</span>&#123;<br>            <span class="hljs-comment">//æ¸…ç†èµ„æº</span><br>        &#125;];<br>    &#125;];<br></code></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/// Creates a new signal. This is the preferred way to create a new signal</span><br><span class="hljs-comment">/// operation or behavior.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// Events can be sent to new subscribers immediately in the `didSubscribe`</span><br><span class="hljs-comment">/// block, but the subscriber will not be able to dispose of the signal until</span><br><span class="hljs-comment">/// a RACDisposable is returned from `didSubscribe`. In the case of infinite</span><br><span class="hljs-comment">/// signals, this won&#x27;t _ever_ happen if events are sent immediately.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// To ensure that the signal is disposable, events can be scheduled on the</span><br><span class="hljs-comment">/// +[RACScheduler currentScheduler] (so that they&#x27;re deferred, not sent</span><br><span class="hljs-comment">/// immediately), or they can be sent in the background. The RACDisposable</span><br><span class="hljs-comment">/// returned by the `didSubscribe` block should cancel any such scheduling or</span><br><span class="hljs-comment">/// asynchronous work.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// didSubscribe - Called when the signal is subscribed to. The new subscriber is</span><br><span class="hljs-comment">///                passed in. You can then manually control the &lt;RACSubscriber&gt; by</span><br><span class="hljs-comment">///                sending it -sendNext:, -sendError:, and -sendCompleted,</span><br><span class="hljs-comment">///                as defined by the operation you&#x27;re implementing. This block</span><br><span class="hljs-comment">///                should return a RACDisposable which cancels any ongoing work</span><br><span class="hljs-comment">///                triggered by the subscription, and cleans up any resources or</span><br><span class="hljs-comment">///                disposables created as part of it. When the disposable is</span><br><span class="hljs-comment">///                disposed of, the signal must not send any more events to the</span><br><span class="hljs-comment">///                `subscriber`. If no cleanup is necessary, return nil.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// **<span class="hljs-doctag">Note:</span>** The `didSubscribe` block is called every time a new subscriber</span><br><span class="hljs-comment">/// subscribes. Any side effects within the block will thus execute once for each</span><br><span class="hljs-comment">/// subscription, not necessarily on one thread, and possibly even</span><br><span class="hljs-comment">/// simultaneously!</span><br>+ (RACSignal&lt;ValueType&gt; *)createSignal:(RACDisposable * _Nullable (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe RAC_WARN_UNUSED_RESULT;<br></code></pre></td></tr></table></figure><p>æ–¹æ³•çš„å‚æ•°ä¸º<code>didSubscribe</code>ï¼Œè¿”å›å€¼ä¸ºæ–°çš„ä¿¡å·ã€‚<br><br/></p><p>#1.2.didSubscribe:<br><br/></p><p><code>didSubscribe</code>æ˜¯åˆ›å»ºä¿¡å·æ—¶ç”±æˆ‘ä»¬å®šä¹‰çš„ç”¨äºå¤„ç†ä¸šåŠ¡çš„blockï¼Œä¿¡å·ä¹Ÿæ˜¯åœ¨è¿™é‡Œå‘é€æ•°æ®ã€é”™è¯¯å’Œå®Œæˆäº‹ä»¶ï¼›<br><br/></p><p><code>didSubscribe</code>çš„å‚æ•°ä¸ºå®ç°äº†<code>RACSubscriber</code>åè®®çš„<code>è®¢é˜…è€…</code>ï¼Œåœ¨ä¿¡å·è¢«è®¢é˜…åå¯ç”¨äºå‘è®¢é˜…è€…å‘é€æ•°æ®ï¼›<br><br/></p><p><code>didSubscribe</code>çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªç”¨äºæ¸…ç†èµ„æºçš„<code>RACDisposable</code>å¯¹è±¡ï¼Œå½“æ²¡æœ‰èµ„æºéœ€è¦æ¸…ç†æ—¶å¯è¿”å› nilï¼›<br><br/></p><p><code>didSubscribe</code>åœ¨åˆ›å»ºä¿¡å·æ—¶è¢«ä½œä¸ºå‚æ•°ä¼ å…¥å¹¶ä¿å­˜åœ¨<code>RACSignal</code>å®ä¾‹å¯¹è±¡å†…(å±æ€§)ï¼š</p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs qml"><span class="hljs-comment">// The block to invoke for each subscriber.</span><br>@<span class="hljs-keyword">property</span><span class="hljs-string"> (nonatomic</span>, copy, readonly) RACDisposable * (^didSubscribe)(id&lt;RACSubscriber&gt; subscriber);<br><br>+ (RACSignal *)<span class="hljs-attribute">createSignal</span>:(RACDisposable * (^)(id&lt;RACSubscriber&gt; subscriber))<span class="hljs-title">didSubscribe</span> &#123;<br><br>    RACDynamicSignal *<span class="hljs-keyword">signal</span><span class="hljs-string"> </span>= [[self alloc] init];<br>    <span class="hljs-comment">// ä¿å­˜blockä¸ºå±æ€§</span><br>    <span class="hljs-keyword">signal</span><span class="hljs-string">-&gt;_didSubscribe </span>= [didSubscribe copy];<br><br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">signal</span><span class="hljs-string"> setNameWithFormat</span>:@<span class="hljs-string">&quot;+createSignal:&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>#1.3.å†·ä¿¡å·<br><br/></p><p>æ‰§è¡Œå®Œä¸Šé¢çš„ç±»æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ª<code>ä¿¡å·</code>ã€‚ä½†æ–°åˆ›å»ºçš„ä¿¡å·é»˜è®¤æ˜¯<code>å†·</code>ä¿¡å·ï¼Œè¿˜ä¸èƒ½ç«‹åˆ»ç”¨å®ƒå‘é€æ•°æ®ï¼Œå› ä¸ºï¼š<br><br/></p><p>å‘é€æ•°æ®éœ€è¦ç”¨åˆ°<code>sendNext</code>æ–¹æ³•ï¼›<br><br/></p><p><code>sendNext</code>æ–¹æ³•çš„è°ƒç”¨è€…ä¸º<code>subscriber</code>ï¼Œå³è®¢é˜…è€…ï¼›<br><br/></p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜ç¼ºå°‘ä¸€ä¸ªè®¢é˜…è€…ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„<strong>å†·ä¿¡å·éœ€è¦è¢«è®¢é˜…ä¹‹åæ‰èƒ½å‘é€æ•°æ®</strong>ã€‚</p><h4 id="2-è®¢é˜…ä¿¡å·"><a href="#2-è®¢é˜…ä¿¡å·" class="headerlink" title="2.è®¢é˜…ä¿¡å·"></a>2.è®¢é˜…ä¿¡å·</h4><p>è®¢é˜…ä¿¡å·çš„è¯­å¥ä¸ºï¼š</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-comment">//2.è®¢é˜…ä¿¡å·</span><br>[<span class="hljs-variable">s1</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>    <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;+++received value:%@&quot;</span>,<span class="hljs-variable">x</span>);<br>&#125;];<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>subscribeNext:</code>æ–¹æ³•çš„å®ç°ä¸ºï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (RACDisposable *)subscribeNext:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">id</span> x))nextBlock &#123;<br><span class="hljs-built_in">NSCParameterAssert</span>(nextBlock != <span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">// 1.åˆ›å»ºè®¢é˜…è€…</span><br>RACSubscriber *o = [RACSubscriber subscriberWithNext:nextBlock error:<span class="hljs-literal">NULL</span> completed:<span class="hljs-literal">NULL</span>];<br><span class="hljs-comment">// 2.è°ƒç”¨ ^didSubscribe</span><br><span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> subscribe:o];<br>&#125;<br></code></pre></td></tr></table></figure><p>#2.1.ä¿å­˜äº‹ä»¶çš„block<br><br/></p><p>é¦–å…ˆï¼Œ<code>subscribeNext:</code>å†…ä¼šåˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ï¼Œä¸”å†·ä¿¡å·æ¯æ¬¡è¢«è®¢é˜…éƒ½ä¼šåˆ›å»ºæ–°çš„è®¢é˜…è€…ï¼Œ<strong>å¤šæ¬¡è®¢é˜…åªä¼šä¿ç•™æœ€åä¸€æ¬¡è®¢é˜…å…³ç³»</strong>ï¼Œå³ä¿¡å·è¢«å¤šæ¬¡è®¢é˜…åï¼Œ<code>sendNext:</code>é€šè¿‡è®¢é˜…è€…å‘é€æ•°æ®æ—¶ï¼Œåªæœ‰æœ€åä¸€ä¸ªè®¢é˜…è€…ä¼šæ”¶åˆ°æ•°æ®å›è°ƒï¼›<br><br/></p><p>å…¶æ¬¡ï¼Œæ–¹æ³•å°†ä¼ è¿›æ¥çš„<code>next</code>ã€<code>error</code>ã€<code>completed</code> ä¸‰ä¸ª block ä¿å­˜åˆ°æ­¤è®¢é˜…è€…å¯¹è±¡ä¸­ï¼ˆå±æ€§ï¼‰ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RACSubscriber</span> ()</span><br><br><span class="hljs-comment">// These callbacks should only be accessed while synchronized on self.</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^next)(<span class="hljs-type">id</span> value);<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^error)(<span class="hljs-built_in">NSError</span> *error);<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^completed)(<span class="hljs-type">void</span>);<br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>, <span class="hljs-keyword">readonly</span>) RACCompoundDisposable *disposable;<br><br><span class="hljs-keyword">@end</span><br><br>+ (<span class="hljs-keyword">instancetype</span>)subscriberWithNext:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">id</span> x))next<br>                             error:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSError</span> *error))error<br>                         completed:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">void</span>))completed <br>&#123;<br>RACSubscriber *subscriber = [[<span class="hljs-keyword">self</span> alloc] init];<br><br>subscriber-&gt;_next = [next <span class="hljs-keyword">copy</span>];<br>subscriber-&gt;_error = [error <span class="hljs-keyword">copy</span>];<br>subscriber-&gt;_completed = [completed <span class="hljs-keyword">copy</span>];<br><br><span class="hljs-keyword">return</span> subscriber;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸‰ä¸ª block åˆ†åˆ«ä»£è¡¨äº†ä¿¡å·çš„ä¸‰ç§äº‹ä»¶ï¼š</p><ul><li>next è¡¨ç¤ºå°†è¦å‘é€æ•°æ®ï¼›</li><li>error è¡¨ç¤ºå‡ºç°é”™è¯¯ï¼›</li><li>completed è¡¨ç¤ºä¿¡å·å·²å®Œæˆã€‚</li></ul><p>è°ƒç”¨å®Œ<code>subscribeNext:</code>æ–¹æ³•åï¼Œå°±æˆåŠŸåˆ›å»ºäº†è®¢é˜…è€…å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„<code>didSubscribe</code> block æ‰€ç¼ºå°‘çš„é‚£ä¸ªå‚æ•°ã€‚<br><br/></p><p>è‡³æ­¤ï¼Œä¿¡å·å…·å¤‡äº†å‘é€æ•°æ®çš„å®Œæ•´å‰ææ¡ä»¶!<br><br/></p><p>#2.2.è°ƒç”¨didSubscribe block<br><br/></p><p>è®¢é˜…è€…åˆ›å»ºå®Œæˆåï¼Œæ–¹æ³•å†…éƒ¨ä¼šç»§ç»­è°ƒç”¨ self.didSubscribe(subscriber)ï¼Œä¼ å…¥åˆšæ‰çš„è®¢é˜…è€…ä½œä¸ºå‚æ•°ã€‚</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs lasso">- (RACDisposable *)subscribe:(id&lt;RACSubscriber&gt;)subscriber &#123;<br><span class="hljs-params">...</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.didSubscribe != <span class="hljs-built_in">NULL</span>) &#123;<br>            RACDisposable *schedulingDisposable = <span class="hljs-meta">[</span>RACScheduler.subscriptionScheduler schedule:^&#123;<br>                <span class="hljs-comment">//è°ƒç”¨ä¹‹å‰åˆ›å»ºå’Œä¿å­˜èµ·æ¥çš„*didSubscribe* blockï¼Œä¼ å…¥è®¢é˜…è€…å‚æ•°</span><br>                RACDisposable *innerDisposable = <span class="hljs-built_in">self</span>.didSubscribe(subscriber);<br>                <span class="hljs-meta">[</span>disposable addDisposable:innerDisposable<span class="hljs-meta">]</span>;<br>            &#125;];<br><span class="hljs-meta">[</span>disposable addDisposable:schedulingDisposable<span class="hljs-meta">]</span>;<br>&#125;<br>return disposable;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ self.didSubscribe å±æ€§æŒ‡å‘çš„æ­£æ˜¯ä¹‹å‰åœ¨åˆ›å»ºä¿¡å·æ—¶æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>didSubscribe</code>ï¼Œæ‰€ä»¥ self.didSubscribe(subscriber) å°±æ˜¯è°ƒç”¨æˆ‘ä»¬è‡ªå·±çš„<code>didSubscribe</code> blockã€‚å³<strong>è®¢é˜…ä¿¡å·åï¼Œä¿¡å·çš„<code>didSubscribe</code>ä¼šè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡</strong>ã€‚</p><h4 id="3-å‘é€æ¶ˆæ¯"><a href="#3-å‘é€æ¶ˆæ¯" class="headerlink" title="3.å‘é€æ¶ˆæ¯"></a>3.å‘é€æ¶ˆæ¯</h4><p>è®¢é˜…å®Œæˆåè‡ªåŠ¨åˆ›å»ºäº†è®¢é˜…è€…ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å‘è®¢é˜…è€…å‘é€<code>äº‹ä»¶</code>å’Œ<code>æ•°æ®</code>äº†ã€‚ä¸Šé¢è¯´è¿‡ä¿¡å·å†…æœ‰ä¸‰ç§æ¶ˆæ¯ï¼š</p><ul><li>next</li><li>error</li><li>completed</li></ul><p>ä¸‰ç§æ¶ˆæ¯å¯¹åº”çš„æ¥å£åˆ†åˆ«ä¸ºï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/// Sends the next value to subscribers.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// value - The value to send. This can be `nil`.</span><br>- (<span class="hljs-type">void</span>)sendNext:(<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)value;<br><br><span class="hljs-comment">/// Sends the error to subscribers.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// error - The error to send. This can be `nil`.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This terminates the subscription, and invalidates the subscriber (such that</span><br><span class="hljs-comment">/// it cannot subscribe to anything else in the future).</span><br>- (<span class="hljs-type">void</span>)sendError:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSError</span> *)error;<br><br><span class="hljs-comment">/// Sends completed to subscribers.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This terminates the subscription, and invalidates the subscriber (such that</span><br><span class="hljs-comment">/// it cannot subscribe to anything else in the future).</span><br>- (<span class="hljs-type">void</span>)sendCompleted;<br></code></pre></td></tr></table></figure><p>å…¶å®ç°ä¸ºï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)sendNext:(<span class="hljs-type">id</span>)value &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-type">void</span> (^nextBlock)(<span class="hljs-type">id</span>) = [<span class="hljs-keyword">self</span>.next <span class="hljs-keyword">copy</span>];<br>        <span class="hljs-keyword">if</span> (nextBlock == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">return</span>;<br><br>        nextBlock(value);<br>    &#125;<br>&#125;<br>- (<span class="hljs-type">void</span>)sendError:(<span class="hljs-built_in">NSError</span> *)e &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-type">void</span> (^errorBlock)(<span class="hljs-built_in">NSError</span> *) = [<span class="hljs-keyword">self</span>.error <span class="hljs-keyword">copy</span>];<br>        [<span class="hljs-keyword">self</span>.disposable dispose];<br><br>        <span class="hljs-keyword">if</span> (errorBlock == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">return</span>;<br>        errorBlock(e);<br>    &#125;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)sendCompleted &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-type">void</span> (^completedBlock)(<span class="hljs-type">void</span>) = [<span class="hljs-keyword">self</span>.completed <span class="hljs-keyword">copy</span>];<br>        [<span class="hljs-keyword">self</span>.disposable dispose];<br><br>        <span class="hljs-keyword">if</span> (completedBlock == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">return</span>;<br>        completedBlock();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘è®¢é˜…è€…å‘é€<code>next</code>ã€<code>error</code>ã€<code>completed</code>äº‹ä»¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨ä¹‹å‰ä¿å­˜åœ¨è®¢é˜…è€…å¯¹è±¡ä¸­çš„ä¸‰ç§ block å±æ€§ã€‚<br><br/></p><p><strong>æ³¨æ„</strong>ï¼šä¿¡å·å‘è®¢é˜…è€…å‘é€äº†<code>error</code>æˆ–è€…<code>completed</code>åï¼Œè®¢é˜…å…³ç³»éšå³ç»“æŸï¼Œè®¢é˜…è€…åç»­ä¸ä¼šå†æ”¶åˆ°ä»»ä½•äº‹ä»¶å’Œæ•°æ®ã€‚<br><br/></p><p>#å†·ä¿¡å·ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">HelloRACController</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-type">id</span>&lt;RACSubscriber&gt; subscriber;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">HelloRACController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    <span class="hljs-comment">//1.ä¿¡å·çš„ä½¿ç”¨</span><br>    <span class="hljs-comment">//1.1.åˆ›å»ºä¿¡å·ï¼Œæ­¤æ—¶ä¿¡å·ä¸ºå†·ä¿¡å·ï¼Œè¢«è®¢é˜…ä¹‹åæ‰èƒ½å‘é€æ¶ˆæ¯</span><br>    RACSignal *s1 = [RACSignal createSignal:^RACDisposable *(<span class="hljs-type">id</span>&lt;RACSubscriber&gt; subscriber) &#123;<br>        <br>        <span class="hljs-comment">//å½“æœ‰è®¢é˜…è€…è®¢é˜…ä¿¡å·ï¼Œå°±ä¼šè°ƒç”¨æ­¤block</span><br>        _subscriber = subscriber;<br>        <br>        <span class="hljs-comment">//1.3.å‘é€ä¿¡å·</span><br>        [subscriber sendNext:<span class="hljs-string">@&quot;Hello from s1~&quot;</span>];<br>        <br>        <span class="hljs-comment">//å›æŠ›é”™è¯¯</span><br>        [subscriber sendError:[<span class="hljs-built_in">NSError</span> errorWithDomain:<span class="hljs-string">@&quot;NetError&quot;</span> code:<span class="hljs-number">1022</span> userInfo:@&#123;<span class="hljs-string">@&quot;code&quot;</span>:@(<span class="hljs-number">1022</span>)&#125;]];<br>        <br>        <span class="hljs-comment">//å¦‚æœä¸å†å‘é€æ•°æ®ï¼Œå‘é€ä¿¡å·å®Œæˆ</span><br>        [subscriber sendCompleted];<br>        <br>        <span class="hljs-comment">//è¿”å›ä¸€ä¸ªä¿¡å·ï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨[RACDisposable disposable]å–æ¶ˆè®¢é˜…ã€‚</span><br>        <span class="hljs-keyword">return</span> [RACDisposable disposableWithBlock:^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++s1 Disposed~&quot;</span>);<br>        &#125;];<br>    &#125;];<br>    <br>    <span class="hljs-comment">//1.2.è®¢é˜…ä¿¡å·(è¢«è®¢é˜…åï¼Œå¦‚æœå‘è®¢é˜…è€…å‘é€äº†ä¿¡å·ï¼Œåˆ™æ­¤æ—¶subscribeNextçš„blockè¢«è°ƒç”¨)</span><br>    [s1 subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;~~ç¬¬1ä¸ªè®¢é˜…æ¶ˆæ¯ï¼š%@&quot;</span>,x);<br>    &#125;];<br>    <br>    [s1 subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;~~ç¬¬2ä¸ªè®¢é˜…æ¶ˆæ¯ï¼š%@&quot;</span>,x);<br>    &#125; error:^(<span class="hljs-built_in">NSError</span> * error) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++error:%@&quot;</span>,error.description);<br>    &#125; completed:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++s1 completed&quot;</span>);<br>    &#125;];<br>    <br>    [_subscriber sendNext:<span class="hljs-string">@&quot;Hello2 from s1~&quot;</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">~~ç¬¬1ä¸ªè®¢é˜…æ¶ˆæ¯ï¼šHello <span class="hljs-keyword">from</span> s1~<br>++s1 Disposed~<br>~~ç¬¬2ä¸ªè®¢é˜…æ¶ˆæ¯ï¼šHello <span class="hljs-keyword">from</span> s1~<br>+++error:<span class="hljs-built_in">Error</span> <span class="hljs-attribute">Domain</span>=NetError <span class="hljs-attribute">Code</span>=1022 <span class="hljs-string">&quot;(null)&quot;</span> UserInfo=&#123;<span class="hljs-attribute">code</span>=1022&#125;<br>++s1 Disposed~<br></code></pre></td></tr></table></figure><p>ç»“åˆæ—¥å¿—æ¥åˆ†æï¼Œæœ‰å‡ ç‚¹å¯ä»¥å¾—åˆ°å°è¯ï¼š<br><br/></p><p>1.è°ƒç”¨å®Œ [s1 subscribeNext:] è®¢é˜…ä¿¡å·ä¹‹åï¼Œ<code>s1</code>çš„ block ä¼šç«‹åˆ»æ‰§è¡Œã€‚<br><br/></p><p>2.è®¢é˜…è€…è°ƒç”¨ [subscriber sendNext:] åè®¢é˜…è€…çš„<code>subscribeNext</code> block ä¼šç«‹åˆ»æ‰§è¡Œã€‚åŒç†è°ƒç”¨ [subscriber sendError:] æˆ–è€… [subscriber sendCompleted] åï¼Œå¯¹åº”çš„<code>error</code>å’Œ<code>completed</code>å›è°ƒä¹Ÿä¼šç«‹åˆ»æ‰§è¡Œã€‚<br><br/></p><p>3.block å†…è°ƒç”¨ [subscriber sendError:] æˆ–è€… [subscriber sendCompleted] ä¹‹åï¼Œä¿¡å·<code>s1</code>ä¼šç«‹åˆ»è°ƒç”¨å…¶<code>RACDisposable</code>çš„ block æ¸…ç†èµ„æºã€‚<br><br/></p><p>4.ä¸€æ—¦ä¿¡å·è°ƒç”¨<code>RACDisposable</code>ä¹‹åï¼Œå®ƒåç»­å°†ä¸èƒ½å†æ¥æ”¶ä»»ä½•äº‹ä»¶ã€‚æ¯”å¦‚ç¤ºä¾‹ä¸­ç¬¬äºŒä¸ªè®¢é˜…è€…è°ƒç”¨äº† <code>sendError</code> ä¹‹åï¼Œs1 è‡ªåŠ¨è°ƒç”¨äº†<code>RACDisposable</code>ï¼Œåç»­è°ƒç”¨ <code>setCompleted</code> æ—¶<code>completed</code>å›è°ƒä¸å†æ‰§è¡Œï¼Œå¹¶ä¸”åé¢çš„ [_subscriber sendNext:] ä¹Ÿä¸ä¼šæœ‰ä»»ä½•å“åº”æˆ–æ—¥å¿—è¾“å‡ºã€‚</p><h3 id="å››-çƒ­ä¿¡å·è§£è¯»"><a href="#å››-çƒ­ä¿¡å·è§£è¯»" class="headerlink" title="å››.çƒ­ä¿¡å·è§£è¯»"></a>å››.çƒ­ä¿¡å·è§£è¯»</h3><p>çƒ­ä¿¡å·æœ¬èº«ä¸éœ€è¦è®¢é˜…ä¹Ÿèƒ½å‘é€æ¶ˆæ¯ï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒä»¬ä¸€èˆ¬éƒ½ç›´æ¥æˆ–é—´æ¥åœ°å®ç°äº†<code>&lt;RACSubscriber&gt;</code>åè®®ï¼Œæ­¤åè®®å®šä¹‰äº†ä»¥ä¸‹æ–¹æ³•ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@protocol</span> RACSubscriber &lt;NSObject&gt;<br><span class="hljs-variable">@required</span><br><br><span class="hljs-comment">/// Sends the next value to subscribers.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// value - The value to send. This can be `nil`.</span><br>- (void)<span class="hljs-attribute">sendNext</span>:(nullable id)value;<br><br><span class="hljs-comment">/// Sends the error to subscribers.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// error - The error to send. This can be `nil`.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This terminates the subscription, and invalidates the subscriber (such that</span><br><span class="hljs-comment">/// it cannot subscribe to anything else in the future).</span><br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">sendError</span>:(nullable NSError *)<span class="hljs-selector-tag">error</span>;<br><br><span class="hljs-comment">/// Sends completed to subscribers.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// This terminates the subscription, and invalidates the subscriber (such that</span><br><span class="hljs-comment">/// it cannot subscribe to anything else in the future).</span><br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">sendCompleted</span>;<br><br><span class="hljs-comment">/// Sends the subscriber a disposable that represents one of its subscriptions.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// A subscriber may receive multiple disposables if it gets subscribed to</span><br><span class="hljs-comment">/// multiple signals; however, any error or completed events must terminate _all_</span><br><span class="hljs-comment">/// subscriptions.</span><br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">didSubscribeWithDisposable</span>:(RACCompoundDisposable *)<span class="hljs-selector-tag">disposable</span>;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šå‡ ä¸ªæ–¹æ³•ä¸»è¦ç”¨æ¥å‘è®¢é˜…è€…å‘é€æ•°æ®æˆ–æ›´æ–°çŠ¶æ€ã€‚<br><br/></p><p>çƒ­ä¿¡å·æ­£æ˜¯å®ç°äº†æ­¤åè®®ï¼Œæ‰èƒ½åœ¨æ²¡æœ‰è®¢é˜…è€…çš„æƒ…å†µä¸‹ä¹Ÿèƒ½ä¸»åŠ¨å‘é€æ•°æ®ã€‚ä»¥<code>RACSubject</code>ä¸ºä¾‹ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-comment">/// A subject can be thought of as a signal that you can manually control by</span><br><span class="hljs-comment">/// sending next, completed, and error.</span><br><span class="hljs-comment">///</span><br><span class="hljs-comment">/// They&#x27;re most helpful in bridging the non-RAC world to RAC, since they let you</span><br><span class="hljs-comment">/// manually control the sending of events.</span><br>@<span class="hljs-keyword">interface</span> <span class="hljs-symbol">RACSubject</span>&lt;<span class="hljs-symbol">ValueType</span>&gt; : <span class="hljs-symbol">RACSignal</span>&lt;<span class="hljs-symbol">ValueType</span>&gt; &lt;<span class="hljs-symbol">RACSubscriber</span>&gt;<br></code></pre></td></tr></table></figure><p>ç»§æ‰¿è‡ª<code>RACSignal</code>ï¼Œè¯´æ˜å®ƒæ˜¯ä¸€ç§ä¿¡å·ï¼›å®ç°äº†<code>&lt;RACSubscriber&gt;</code>åè®®ï¼Œè¯´æ˜å®ƒèƒ½åœ¨ä¸è¢«è®¢é˜…çš„æƒ…å†µä¸‹ä¸»åŠ¨å‘é€æ•°æ®ã€‚<br><br/></p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs perl">- (void)hotSignal &#123;<br>    RACSubject *<span class="hljs-function"><span class="hljs-keyword">sub</span> = [<span class="hljs-title">RACSubject</span> <span class="hljs-title">subject</span>]</span>;<br>    [<span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">sendNext</span>:@&quot;1&quot;]</span>;<br>    <br>    [<span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">subscribeNext</span>:^(<span class="hljs-title">id</span> <span class="hljs-title">x</span>) </span>&#123;<br>        NSLog(@&quot;+++sub1:%@<span class="hljs-string">&quot;,x);</span><br><span class="hljs-string">    &#125;];</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    [sub sendNext:@&quot;2&quot;</span>];<br>    <br>    [<span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">subscribeNext</span>:^(<span class="hljs-title">id</span> <span class="hljs-title">x</span>) </span>&#123;<br>        NSLog(@&quot;+++sub2:%@<span class="hljs-string">&quot;,x);</span><br><span class="hljs-string">    &#125;];</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    [sub sendNext:@&quot;3&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">sub1:2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">sub1:3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">sub2:3</span><br></code></pre></td></tr></table></figure><p>1.ä»<code>[sub sendNext:@&quot;1&quot;]</code>å¯ä»¥çœ‹åˆ°ï¼Œ<code>sub</code>å¯¹è±¡ä¸éœ€è¦è¢«è®¢é˜…ä¹Ÿèƒ½å‘é€æ¶ˆæ¯ï¼Œåªæ˜¯æ­¤æ—¶æ²¡è®¢é˜…è€…æ¥æ”¶æ¶ˆæ¯è€Œå·²ï¼›<br><br/></p><p>2.å½“è®¢é˜…äº†ä¸¤æ¬¡ä¹‹åï¼Œå‘é€æ•°æ®3æ—¶æ”¶åˆ°ä¸¤æ¬¡å›è°ƒï¼Œä¹Ÿè¯´æ˜äº†çƒ­ä¿¡å·æ˜¯1~Nçš„å…³ç³»ï¼Œä¿¡å·ä¸Nä¸ªè®¢é˜…è€…å…±äº«ä¿¡æ¯ã€‚<br><br/></p><p>ä¸‹é¢å°†ä»‹ç»<code>RACSubject</code>çš„å®ç°ï¼š</p><h4 id="1-åˆ›å»ºä¿¡å·-1"><a href="#1-åˆ›å»ºä¿¡å·-1" class="headerlink" title="1.åˆ›å»ºä¿¡å·"></a>1.åˆ›å»ºä¿¡å·</h4><p>åˆ›å»ºæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">RACSubject *<span class="hljs-function"><span class="hljs-keyword">sub</span> = [<span class="hljs-title">RACSubject</span> <span class="hljs-title">subject</span>]</span>;<br></code></pre></td></tr></table></figure><p>å…¶å®ç°ä¸ºï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">+</span> (instancetype)subject &#123;<br>    <span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> alloc] <span class="hljs-keyword">init</span>];<br>&#125;<br><br><span class="hljs-operator">-</span> (instancetype)<span class="hljs-keyword">init</span> &#123;<br>    <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> [<span class="hljs-keyword">super</span> <span class="hljs-keyword">init</span>];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> <span class="hljs-operator">==</span> <span class="hljs-literal">nil</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br><br>    _disposable <span class="hljs-operator">=</span> [<span class="hljs-type">RACCompoundDisposable</span> compoundDisposable];<br>    _subscribers <span class="hljs-operator">=</span> [[<span class="hljs-type">NSMutableArray</span> alloc] initWithCapacity:<span class="hljs-number">1</span>];<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™ä¸ª<code>_subscribers</code>æ•°ç»„ï¼Œåé¢ä¼šæœ‰é‡è¦ä½œç”¨ã€‚</p><h4 id="2-è®¢é˜…ä¿¡å·-1"><a href="#2-è®¢é˜…ä¿¡å·-1" class="headerlink" title="2.è®¢é˜…ä¿¡å·"></a>2.è®¢é˜…ä¿¡å·</h4><figure class="highlight hy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs hy">[sub subscribeNext:^(<span class="hljs-name"><span class="hljs-built_in">id</span></span> x) &#123;<br>    NSLog(@<span class="hljs-string">&quot;+++sub1:%@&quot;</span>,x)<span class="hljs-comment">;</span><br>&#125;]<span class="hljs-comment">;</span><br>[sub subscribeNext:^(<span class="hljs-name"><span class="hljs-built_in">id</span></span> x) &#123;<br>    NSLog(@<span class="hljs-string">&quot;+++sub2:%@&quot;</span>,x)<span class="hljs-comment">;</span><br>&#125;]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><code>subscribeNext:</code>çš„å®ç°ä¸ºï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (RACDisposable *)subscribeNext:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">id</span> x))nextBlock &#123;<br>    <span class="hljs-built_in">NSCParameterAssert</span>(nextBlock != <span class="hljs-literal">NULL</span>);<br>    <br>    RACSubscriber *o = [RACSubscriber subscriberWithNext:nextBlock error:<span class="hljs-literal">NULL</span> completed:<span class="hljs-literal">NULL</span>];<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> subscribe:o];<br>&#125;<br></code></pre></td></tr></table></figure><p>å’Œå†·ä¿¡å·ä¸€æ ·ï¼Œè¿™é‡Œä¼šå…ˆåˆ›å»ºä¸€ä¸ªè®¢é˜…è€…å¯¹è±¡ï¼Œéšåè°ƒç”¨<code>subscribe:</code>æ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (RACDisposable *)subscribe:(<span class="hljs-type">id</span>&lt;RACSubscriber&gt;)subscriber &#123;<br>    <span class="hljs-built_in">NSCParameterAssert</span>(subscriber != <span class="hljs-literal">nil</span>);<br><br>    RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];<br>    subscriber = [[RACPassthroughSubscriber alloc] initWithSubscriber:subscriber signal:<span class="hljs-keyword">self</span> disposable:disposable];<br><br>    <span class="hljs-built_in">NSMutableArray</span> *subscribers = <span class="hljs-keyword">self</span>.subscribers;<br>    <span class="hljs-keyword">@synchronized</span> (subscribers) &#123;<br>        <span class="hljs-comment">// å°†è®¢é˜…è€…æ·»åŠ è¿›æ•°ç»„</span><br>        [subscribers addObject:subscriber];<br>    &#125;<br>    <span class="hljs-comment">// ç•¥ã€‚ã€‚</span><br>    <span class="hljs-keyword">return</span> disposable;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ–¹æ³•å°†ä¼ è¿›æ¥çš„è®¢é˜…è€…æ·»åŠ è¿›ä¹‹å‰æåˆ°çš„<code>subscribers</code>æ•°ç»„ä¸­ï¼Œç­‰å¾…éšåçš„è°ƒç”¨ã€‚</p><h4 id="3-å‘é€æ¶ˆæ¯-1"><a href="#3-å‘é€æ¶ˆæ¯-1" class="headerlink" title="3.å‘é€æ¶ˆæ¯"></a>3.å‘é€æ¶ˆæ¯</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">[<span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">sendNext</span>:@&quot;1&quot;]</span>;<br></code></pre></td></tr></table></figure><p><code>sendNext:</code>çš„å®ç°ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">- (void)sendNext:(id)value &#123;<br>    [self enumerateSubscribersUsingBlock:^(id&lt;RACSubscriber&gt; <span class="hljs-keyword">subscriber) </span>&#123;<br>        [<span class="hljs-keyword">subscriber </span>sendNext:value];<br>    &#125;];<br>&#125;<br><br>- (void)enumerateSubscribersUsingBlock:(void (^)(id&lt;RACSubscriber&gt; <span class="hljs-keyword">subscriber))block </span>&#123;<br>    NSArray *<span class="hljs-keyword">subscribers;</span><br><span class="hljs-keyword"></span>    @<span class="hljs-keyword">synchronized </span>(self.<span class="hljs-keyword">subscribers) </span>&#123;<br>        <span class="hljs-keyword">subscribers </span>= [self.<span class="hljs-keyword">subscribers </span>copy];<br>    &#125;<br><br>    for (id&lt;RACSubscriber&gt; <span class="hljs-keyword">subscriber </span>in <span class="hljs-keyword">subscribers) </span>&#123;<br>        <span class="hljs-keyword">block(subscriber);</span><br><span class="hljs-keyword"></span>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>sub</code>å¯¹è±¡ä»<code>subscribers</code>æ•°ç»„ä¸­å–å‡ºæ‰€æœ‰çš„è®¢é˜…è€…ï¼Œä¾æ¬¡å‘å…¶å‘é€æ•°æ®~</p><h4 id="4-ç”¨ä½œä»£ç†"><a href="#4-ç”¨ä½œä»£ç†" class="headerlink" title="4.ç”¨ä½œä»£ç†"></a>4.ç”¨ä½œä»£ç†</h4><p><code>RACSubject</code>çš„å®ç°å¹¶ä¸éš¾ç†è§£ï¼Œå®ƒä¸è®¢é˜…è€…ä¹‹é—´æ˜¯<code>1~N</code>çš„å…³ç³»å¹¶å¯ä¸»åŠ¨å‘é€æ¶ˆæ¯ï¼Œå¸¸ç”¨æ¥ä»£æ›¿OCä¸­çš„<code>delegate</code>ã€‚</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@interface</span> <span class="hljs-attribute">ViewControllerII </span>: UIViewController<br><br><span class="hljs-variable">@property</span> (nonatomic, strong) RACSubject *delegate;<br><br><span class="hljs-variable">@end</span><br><br><span class="hljs-variable">@implementation</span> ViewControllerII<br><br>- (void)viewDidLoad &#123;<br>    <span class="hljs-selector-attr">[super viewDidLoad]</span>;<br>&#125;<br><br>- (IBAction)<span class="hljs-attribute">onDismiss</span>:(id)sender<br>&#123;<br>    <span class="hljs-comment">//RACå›è°ƒ</span><br>    <span class="hljs-selector-tag">if</span> (self.delegate) &#123;<br>        <span class="hljs-selector-attr">[self.delegate sendNext:@<span class="hljs-string">&quot;++ViewControllerII Closed~&quot;</span>]</span>;<br>    &#125;<br>    <span class="hljs-comment">//å…³é—­</span><br>    [self.navigationController <span class="hljs-attribute">popViewControllerAnimated</span>:YES];<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æŸä¸ªé¡µé¢è®¾ç½®ä»£ç†ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-keyword">IBAction</span>)onAction2:(<span class="hljs-type">id</span>)sender &#123;<br>    ViewControllerII *controller = [[<span class="hljs-built_in">UIStoryboard</span> storyboardWithName:<span class="hljs-string">@&quot;Main&quot;</span> bundle:<span class="hljs-literal">nil</span>]<br>                                    instantiateViewControllerWithIdentifier:<span class="hljs-string">@&quot;ViewControllerII&quot;</span>];<br>    <span class="hljs-comment">//è®¾ç½®ä»£ç†ä¿¡å·</span><br>    controller.delegate = [RACSubject subject];<br>    <br>    <span class="hljs-comment">//è®¢é˜…ä»£ç†</span><br>    [controller.delegate subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>,x);<br>    &#125;];<br>    [<span class="hljs-keyword">self</span>.navigationController pushViewController:controller animated:<span class="hljs-literal">YES</span>];<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="äº”-ç»„æ’­"><a href="#äº”-ç»„æ’­" class="headerlink" title="äº”.ç»„æ’­"></a>äº”.ç»„æ’­</h3><blockquote><p>Signals are cold by default, meaning that they start doing work each time a new subscription is added. This behavior is usually desirable, because it means that data will be freshly recalculated for each subscriber, but it can be problematic if the signal has side effects or the work is expensive (for example, sending a network request).</p></blockquote><p>ä¿¡å·æœ‰å¤šä¸ªè®¢é˜…è€…æ—¶ï¼Œæ¯è¢«è®¢é˜…ä¸€æ¬¡å…¶<code>block</code>éƒ½è‡ªåŠ¨è§¦å‘ä¸€æ¬¡ï¼Œè¿™ç§æƒ…å†µæœ‰æ—¶ä¼šæœ‰<code>å‰¯ä½œç”¨</code>ã€‚æ¯”å¦‚<code>block</code>å†…å°è£…äº†è€—æ—¶æ“ä½œï¼Œæ¯æ¬¡è®¢é˜…éƒ½å•ç‹¬è§¦å‘ä¸€éæ˜¾ç„¶æµªè´¹æ€§èƒ½ã€‚ç†æƒ³çš„æƒ…å†µæ˜¯å¤šä¸ªè®¢é˜…è€…éƒ½è®¢é˜…å®Œæˆåï¼Œ<code>block</code>åªè§¦å‘ä¸€æ¬¡è€Œæ‰€æœ‰è®¢é˜…è€…éƒ½æ”¶åˆ°å›è°ƒã€‚è¿™ç§åœºæ™¯RACè€ƒè™‘åˆ°äº†ï¼Œæ­¤æ—¶<code>RACMulticastConnection</code>å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p><blockquote><p>A multicast connection encapsulates the idea of sharing one subscription to a signal to many subscribers. This is most often needed if the subscription to the underlying signal involves side-effects or shouldnâ€™t be called more than once.</p></blockquote><p>ç»„æ’­ï¼Œç”¨äºåœ¨å¤šä¸ªè®¢é˜…è€…ä¹‹é—´å…±äº«å¯¹æŸä¸ªä¿¡å·çš„è®¢é˜…ï¼Œåœ¨å‘é€è€…å’Œæ¯ä¸€è®¢é˜…è€…ä¹‹é—´å®ç°<code>1~N</code>çš„è¿æ¥ã€‚</p><h4 id="1-ç¤ºä¾‹"><a href="#1-ç¤ºä¾‹" class="headerlink" title="1.ç¤ºä¾‹"></a>1.ç¤ºä¾‹</h4><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-operator">-</span> (<span class="hljs-variable">void</span>)<span class="hljs-title function_">viewDidLoad</span> &#123;<br>    [<span class="hljs-variable language_">super</span> <span class="hljs-variable">viewDidLoad</span>];<br>    <br>    <span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;Hello from s2~&quot;</span>];<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>        <span class="hljs-keyword">return</span> [<span class="hljs-title class_">RACDisposable</span> <span class="hljs-variable">disposableWithBlock</span>:<span class="hljs-operator">^</span>&#123;<br>            <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;++s2 Disposed~&quot;</span>);<br>        &#125;];<br>    &#125;];<br>    <br>    <span class="hljs-comment">//è¿æ¥ç±»(å•æ¬¡è®¢é˜…ä¹‹åä¸ä¼šç«‹åˆ»æ”¶åˆ°å›è°ƒï¼Œæ‰€æœ‰è®¢é˜…å®Œæˆåè°ƒç”¨ connect æ—¶æ‰ä¼šå…ˆåè§¦å‘)</span><br>    <span class="hljs-title class_">RACMulticastConnection</span> <span class="hljs-operator">*</span><span class="hljs-variable">cnn</span> <span class="hljs-operator">=</span> [<span class="hljs-variable">s2</span> <span class="hljs-variable">publish</span>];<br>    <br>    <span class="hljs-comment">//è®¢é˜…è¿æ¥ç±»ä¿¡å·</span><br>    [<span class="hljs-variable">cnn</span>.<span class="hljs-property">signal</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;~~ç¬¬1ä¸ªè®¢é˜…æ¶ˆæ¯ï¼š%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br><br>    [<span class="hljs-variable">cnn</span>.<span class="hljs-property">signal</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;~~ç¬¬2ä¸ªè®¢é˜…æ¶ˆæ¯ï¼š%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br><br>    [<span class="hljs-variable">cnn</span>.<span class="hljs-property">signal</span> <span class="hljs-variable">subscribeNext</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">id</span> <span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;~~ç¬¬3ä¸ªè®¢é˜…æ¶ˆæ¯ï¼š%@&quot;</span>,<span class="hljs-variable">x</span>);<br>    &#125;];<br><br>    [<span class="hljs-variable">cnn</span> <span class="hljs-variable">connect</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs armasm">~~ç¬¬<span class="hljs-number">1</span>ä¸ªè®¢é˜…æ¶ˆæ¯ï¼šHello from <span class="hljs-built_in">s2</span>~<br>~~ç¬¬<span class="hljs-number">2</span>ä¸ªè®¢é˜…æ¶ˆæ¯ï¼šHello from <span class="hljs-built_in">s2</span>~<br>~~ç¬¬<span class="hljs-number">3</span>ä¸ªè®¢é˜…æ¶ˆæ¯ï¼šHello from <span class="hljs-built_in">s2</span>~<br>++<span class="hljs-built_in">s2</span> Disposed~<br></code></pre></td></tr></table></figure><p>å¦‚æœåœ¨è®¢é˜…è€…çš„å›è°ƒä¸­æ‰“æ–­ç‚¹ä½ å°±ä¼šå‘ç°ï¼Œè°ƒç”¨<code>[cnn connect]</code>åä¸‰ä¸ª block éƒ½è§¦å‘äº†ä¸”ä¾æ¬¡è§¦å‘ã€‚</p><h4 id="2-å®ç°"><a href="#2-å®ç°" class="headerlink" title="2.å®ç°"></a>2.å®ç°</h4><ul><li>åˆ›å»ºå¤šæ’­å®ä¾‹</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">RACMulticastConnection *cnn <span class="hljs-operator">=</span> [s2 publish]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>æ¥çœ‹çœ‹<code>publish</code>éƒ½åšäº†ä»€ä¹ˆï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">- (RACMulticastConnection *)publish &#123;<br>    RACSubject *subject = [[RACSubject subject] setNameWithFormat:@&quot;[%@] -publish&quot;, self.name];<br>    RACMulticastConnection *<span class="hljs-keyword">connection</span> = [self multicast:subject];<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">connection</span>;<br>&#125;<br><br>- (RACMulticastConnection *)multicast:(RACSubject *)subject &#123;<br>    [subject setNameWithFormat:@&quot;[%@] -multicast: %@&quot;, self.name, subject.name];<br>    RACMulticastConnection *<span class="hljs-keyword">connection</span> = [[RACMulticastConnection alloc] initWithSourceSignal:self subject:subject];<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">connection</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>publish</code>å†…åˆ›å»ºäº†ä¸€ä¸ª<code>RACSubject</code>å¯¹è±¡ï¼Œéšåå°†å…¶ä½œä¸ºå‚æ•°ä¼ å…¥<code>RACMulticastConnection</code>çš„æ„é€ å‡½æ•°ä¸­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RACMulticastConnection</span> () </span>&#123;<br>    RACSubject *_signal;<br>    int32_t <span class="hljs-keyword">volatile</span> _hasConnected;<br>&#125;<br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">strong</span>) RACSignal *sourceSignal;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">strong</span>) RACSerialDisposable *serialDisposable;<br><span class="hljs-keyword">@end</span><br><br>- (<span class="hljs-keyword">instancetype</span>)initWithSourceSignal:(RACSignal *)source subject:(RACSubject *)subject &#123;<br>    <span class="hljs-built_in">NSCParameterAssert</span>(source != <span class="hljs-literal">nil</span>);<br>    <span class="hljs-built_in">NSCParameterAssert</span>(subject != <span class="hljs-literal">nil</span>);<br><br>    <span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init];<br><br>    _sourceSignal = source;<br>    _serialDisposable = [[RACSerialDisposable alloc] init];<br>    _signal = subject;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°å°†æºä¿¡å·<code>s2</code>ä¿å­˜ä¸º<code>sourceSignal</code>ï¼Œå°†åˆšæ‰åˆ›å»ºçš„<code>subject</code>ä¿å­˜ä¸º<code>signal</code>ï¼Œä¹‹åè¿”å›ä¸€ä¸ªå¤šæ’­å®ä¾‹ã€‚</p><ul><li>è®¢é˜…ä¿¡å·</li></ul><figure class="highlight hy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs hy">[cnn.signal subscribeNext:^(<span class="hljs-name"><span class="hljs-built_in">id</span></span> x) &#123;<br>    NSLog(@<span class="hljs-string">&quot;~~ç¬¬1ä¸ªè®¢é˜…æ¶ˆæ¯ï¼š%@&quot;</span>,x)<span class="hljs-comment">;</span><br>&#125;]<span class="hljs-comment">;</span><br>    <br>[cnn.signal subscribeNext:^(<span class="hljs-name"><span class="hljs-built_in">id</span></span> x) &#123;<br>    NSLog(@<span class="hljs-string">&quot;~~ç¬¬2ä¸ªè®¢é˜…æ¶ˆæ¯ï¼š%@&quot;</span>,x)<span class="hljs-comment">;</span><br>&#125;]<span class="hljs-comment">;</span><br>    <br>[cnn.signal subscribeNext:^(<span class="hljs-name"><span class="hljs-built_in">id</span></span> x) &#123;<br>    NSLog(@<span class="hljs-string">&quot;~~ç¬¬3ä¸ªè®¢é˜…æ¶ˆæ¯ï¼š%@&quot;</span>,x)<span class="hljs-comment">;</span><br>&#125;]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œè®¢é˜…çš„ä¸å†æ˜¯<code>s2</code>ï¼Œè€Œæ˜¯åˆšæ‰çš„<code>RACSubject</code>ç±»å‹å±æ€§<code>signal</code>ï¼Œæ­¤è®¢é˜…çš„å†…éƒ¨å®ç°ä¸ºï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// RACSignal.m</span><br>- (RACDisposable *)subscribeNext:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">id</span> x))nextBlock &#123;<br>    <span class="hljs-built_in">NSCParameterAssert</span>(nextBlock != <span class="hljs-literal">NULL</span>);<br>    <br>    RACSubscriber *o = [RACSubscriber subscriberWithNext:nextBlock error:<span class="hljs-literal">NULL</span> completed:<span class="hljs-literal">NULL</span>];<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> subscribe:o];<br>&#125;<br><br><span class="hljs-comment">// RACSubject.m</span><br>- (RACDisposable *)subscribe:(<span class="hljs-type">id</span>&lt;RACSubscriber&gt;)subscriber &#123;<br>    <span class="hljs-built_in">NSCParameterAssert</span>(subscriber != <span class="hljs-literal">nil</span>);<br><br>    RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];<br>    subscriber = [[RACPassthroughSubscriber alloc] initWithSubscriber:subscriber signal:<span class="hljs-keyword">self</span> disposable:disposable];<br><br>    <span class="hljs-built_in">NSMutableArray</span> *subscribers = <span class="hljs-keyword">self</span>.subscribers;<br>    <span class="hljs-keyword">@synchronized</span> (subscribers) &#123;<br>        <span class="hljs-comment">// å°†è®¢é˜…è€…ä¿å­˜åˆ°æ•°ç»„ä¸­</span><br>        [subscribers addObject:subscriber];<br>    &#125;<br>    <span class="hljs-comment">// ç•¥ã€‚ã€‚ã€‚</span><br><br>    <span class="hljs-keyword">return</span> disposable;<br>&#125;<br></code></pre></td></tr></table></figure><p>å³è®¢é˜…<code>signal</code>æ—¶ï¼Œå…ˆåˆ›å»ºæ–°çš„è®¢é˜…è€…ï¼Œéšåå°†è®¢é˜…è€…æ·»åŠ åˆ°å¤šæ’­å®ä¾‹çš„æ•°ç»„<code>subscribers</code>ä¸­ã€‚æ­¤æ—¶è¿˜æ²¡æœ‰è°ƒç”¨<code>s2</code>çš„<code>didSubscribe</code>!</p><ul><li>è¿æ¥ connect</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[cnn connect]</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><code>connect</code>çš„å†…éƒ¨å®ç°ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (RACDisposable *)connect &#123;<br>    <span class="hljs-type">BOOL</span> shouldConnect = OSAtomicCompareAndSwap32Barrier(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;_hasConnected);<br><br>    <span class="hljs-keyword">if</span> (shouldConnect) &#123;<br>        <span class="hljs-comment">// è¿™é‡Œçš„</span><br>        <span class="hljs-keyword">self</span>.serialDisposable.disposable = [<span class="hljs-keyword">self</span>.sourceSignal subscribe:_signal];<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.serialDisposable;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>self.sourceSignal</code>çš„<code>subscribe</code>ï¼Œå‚æ•°ä¸ºä¹‹å‰ RACSubject ç±»å‹çš„å±æ€§<code>_signal</code>ï¼ˆä¿¡å·è®¢é˜…äº†ä¿¡å·ï¼‰ï¼š</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs lisp">- (<span class="hljs-name">RACDisposable</span> *)subscribe:(id&lt;RACSubscriber&gt;)subscriber &#123;<br>    NSCParameterAssert(subscriber != nil);<br><br>    RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable]<span class="hljs-comment">;</span><br>    // å¯¹subscriberåšäº†å˜æ¢<br>    subscriber = [[RACPassthroughSubscriber alloc] initWithSubscriber<span class="hljs-symbol">:subscriber</span> signal<span class="hljs-symbol">:self</span> disposable<span class="hljs-symbol">:disposable</span>]<span class="hljs-comment">;</span><br><br>    if (<span class="hljs-name">self</span>.didSubscribe != NULL) &#123;<br>        RACDisposable *schedulingDisposable = [RACScheduler.subscriptionScheduler schedule:^&#123;<br>            // å›è°ƒs2çš„^didSubscribe<br>            RACDisposable *innerDisposable = self.didSubscribe(<span class="hljs-name">subscriber</span>)<span class="hljs-comment">;</span><br>            [disposable addDisposable<span class="hljs-symbol">:innerDisposable</span>]<span class="hljs-comment">;</span><br>        &#125;]<span class="hljs-comment">;</span><br><br>        [disposable addDisposable<span class="hljs-symbol">:schedulingDisposable</span>]<span class="hljs-comment">;</span><br>    &#125;<br>    <br>    return disposable<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>subscribe:</code>å†…å¯¹<code>_signal</code>åšäº†å˜æ¢ï¼Œè°ƒäº†<code>self.didSubscribe(subscriber)</code>å›è°ƒäº†<code>s2</code>çš„<code>didSubscribe</code>ï¼š</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs wren"><span class="hljs-title class_">RACSignal</span> <span class="hljs-operator">*</span><span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> [<span class="hljs-title class_">RACSignal</span> <span class="hljs-variable">createSignal</span>:<span class="hljs-operator">^</span><span class="hljs-title class_">RACDisposable</span> <span class="hljs-title function_">*</span>(<span class="hljs-params">id</span>&lt;<span class="hljs-params">RACSubscriber</span>&gt; <span class="hljs-params">subscriber</span>) &#123;<br>        <span class="hljs-comment">// æ­¤ subscriber ä¸º RACSubject ç±»å‹</span><br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendNext</span>:@<span class="hljs-string">&quot;Hello from s2~&quot;</span>];<br>        [<span class="hljs-variable">subscriber</span> <span class="hljs-variable">sendCompleted</span>];<br>        <br>        <span class="hljs-keyword">return</span> [<span class="hljs-title class_">RACDisposable</span> <span class="hljs-variable">disposableWithBlock</span>:<span class="hljs-operator">^</span>&#123;<br>            <span class="hljs-title class_">NSLog</span>(@<span class="hljs-string">&quot;++s2 Disposed~&quot;</span>);<br>        &#125;];<br>    &#125;];<br></code></pre></td></tr></table></figure><p><code>didSubscribe</code>å†…éšå³é€šè¿‡<code>sendNext:</code>å‘è®¢é˜…è€…ï¼ˆå³<code>_signal</code>ï¼‰å‘é€æ•°æ®:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">- (void)sendNext:(id)value &#123;<br>    [self enumerateSubscribersUsingBlock:^(id&lt;RACSubscriber&gt; <span class="hljs-keyword">subscriber) </span>&#123;<br>        [<span class="hljs-keyword">subscriber </span>sendNext:value];<br>    &#125;];<br>&#125;<br><br>- (void)enumerateSubscribersUsingBlock:(void (^)(id&lt;RACSubscriber&gt; <span class="hljs-keyword">subscriber))block </span>&#123;<br>    NSArray *<span class="hljs-keyword">subscribers;</span><br><span class="hljs-keyword"></span>    @<span class="hljs-keyword">synchronized </span>(self.<span class="hljs-keyword">subscribers) </span>&#123;<br>        <span class="hljs-keyword">subscribers </span>= [self.<span class="hljs-keyword">subscribers </span>copy];<br>    &#125;<br><br>    for (id&lt;RACSubscriber&gt; <span class="hljs-keyword">subscriber </span>in <span class="hljs-keyword">subscribers) </span>&#123;<br>        <span class="hljs-keyword">block(subscriber);</span><br><span class="hljs-keyword"></span>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>_signal</code> çš„<code>sendNext:</code>æ–¹æ³•éå†ä¹‹å‰ä¿å­˜åœ¨<code>subscribers</code>æ•°ç»„ä¸­çš„è®¢é˜…è€…ï¼Œå‘å…¶ä¸€ä¸€å‘é€æ•°æ®ï¼Œä¸‰ä¸ªè®¢é˜…è€…ä¾æ¬¡æ”¶åˆ°å›è°ƒ~<br><br/></p><p><strong>å°ç»“</strong>ï¼šå¤šæ’­ä¸»è¦æ˜¯åœ¨å†…éƒ¨äº§ç”Ÿ<code>RACSubject</code>ç±»å‹çš„çƒ­ä¿¡å·<code>_signal</code>ï¼Œè¿›è€Œå°†å¤šä¸ªè®¢é˜…è€…ä¿å­˜åœ¨å…¶æ•°ç»„ä¸­å¹¶æœ€ç»ˆä¸€ä¸€å‘å…¶å‘é€æ•°æ®ã€‚</p><h3 id="å…­-ç»“æŸè¯­"><a href="#å…­-ç»“æŸè¯­" class="headerlink" title="å…­.ç»“æŸè¯­"></a>å…­.ç»“æŸè¯­</h3><p>ä»¥ä¸Šå°±æ˜¯å…³äºRACä¸­<code>ä¿¡å·</code>å’Œ<code>è®¢é˜…è€…</code>çš„åˆ†æå’Œç®€å•ä½¿ç”¨ã€‚å®è·µä¸­å¯ä»¥ç»“åˆRACå…¶ä»–åŠŸèƒ½ä¸€èµ·ä½¿ç”¨ï¼Œåç»­æ–‡ç« ä¸­ä¼šç»§ç»­ç ”ç©¶~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/ReactiveCocoa/ReactiveObjC/blob/master/Documentation/FrameworkOverview.md">Â©RAC-Github</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç»„ä»¶åŒ–-é¢å‘åè®®æ–¹æ¡ˆ</title>
    <link href="/2020/12/21/modules-protocol.html"/>
    <url>/2020/12/21/modules-protocol.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1.å‰è¨€"></a>1.å‰è¨€</h3><p><code>URL</code>å’Œ<code>åå°„</code>æ–¹æ¡ˆå„æœ‰è‡ªå·±çš„å±€é™æ€§ï¼š</p><ul><li><code>URLè·¯ç”±</code>æ–¹æ¡ˆæ”¯æŒçš„å‚æ•°ç±»å‹ä¸å¤Ÿçµæ´»ï¼›</li><li><code>åå°„æ–¹æ¡ˆ</code>çš„ä¸­é—´é€šä¿¡å±‚ä½¿ç”¨æ˜æ–‡ç±»åå’Œæ¥å£åï¼Œç¡¬ç¼–ç æå®¹æ˜“å‡ºé”™ï¼›</li><li>ä¸¤ç§æ–¹æ¡ˆä¸­ç»„ä»¶ä¹‹é—´ä¼ å€¼æ—¶éœ€è¦å¼•ç”¨å¯¹æ–¹çš„å®ä½“æ–‡ä»¶ï¼Œè¿™æ ·å°±ä¾ç„¶å­˜åœ¨è€¦åˆé—®é¢˜ï¼›</li></ul><p>æœ¬ç¯‡å°†è¦æ¢è®¨çš„<code>åè®®+æœåŠ¡æ³¨å†Œ+URL+åå°„</code>æ–¹æ¡ˆï¼Œå…¶ä¸­çš„åè®®å°±å¾ˆå¥½çš„è§£å†³äº†è¿™äº›é—®é¢˜~</p><h3 id="2-æ€è·¯"><a href="#2-æ€è·¯" class="headerlink" title="2.æ€è·¯"></a>2.æ€è·¯</h3><h4 id="2-1-æœ¬åœ°è°ƒç”¨"><a href="#2-1-æœ¬åœ°è°ƒç”¨" class="headerlink" title="2.1.æœ¬åœ°è°ƒç”¨"></a>2.1.æœ¬åœ°è°ƒç”¨</h4><p>ç»„ä»¶å°†è‡ªå·±å¯¹å¤–æä¾›çš„æœåŠ¡ä»¥<code>åè®®</code>çš„å½¢å¼è¿›è¡Œå£°æ˜ï¼Œå¯¹å…¶ä»–æ‰€æœ‰ç»„ä»¶å¯è§ï¼›<br><br/></p><p>ç»„ä»¶å†…æä¾›ä¸€ä¸ª<code>å¯¹å¤–æœåŠ¡ç±»</code>ï¼Œéµå®ˆæ­¤åè®®å¹¶å®ç°åè®®æ–¹æ³•ï¼Œå¤„ç†ç»„ä»¶å¯¹å¤–æœåŠ¡çš„å…·ä½“å†…å®¹ï¼›<br><br/></p><p>ç‹¬ç«‹å‡ºä¸€ä¸ªå•ä¾‹çš„<code>ä¸­é—´å±‚</code>ï¼Œä»¥åè®®çš„ç±»åä¸ºé”®ï¼Œä»¥åè®®çš„å®ç°ç±»ä¸ºå€¼ï¼Œå°†æ­¤é”®å€¼å¯¹æ³¨å†Œåˆ°<code>ä¸­é—´å±‚</code>ï¼›<br><br/></p><p>Aç»„ä»¶è°ƒç”¨Bç»„ä»¶çš„æœåŠ¡æ—¶ï¼ŒAæ–¹ä»ä¸­é—´å±‚ä»¥Bç»„ä»¶å¯¹å¤–æš´éœ²çš„æœåŠ¡åè®®ä¸ºkeyï¼Œå°†å®ç°äº†æ­¤åè®®çš„BæœåŠ¡ç±»å–å‡ºï¼Œå®ä¾‹åŒ–åè°ƒç”¨å¯¹åº”çš„åè®®æ–¹æ³•ï¼Œè¿è¡Œæ—¶è‡ªåŠ¨æŸ¥æ‰¾å¹¶è°ƒç”¨BæœåŠ¡ç±»ä¸­çš„å…·ä½“å®ç°ï¼Œå³å¯å®ŒæˆæœåŠ¡çš„è°ƒç”¨ã€‚</p><h4 id="2-2-è¿œç¨‹è°ƒç”¨"><a href="#2-2-è¿œç¨‹è°ƒç”¨" class="headerlink" title="2.2.è¿œç¨‹è°ƒç”¨"></a>2.2.è¿œç¨‹è°ƒç”¨</h4><p>æŒ‰ç…§çº¦å®šçš„æ ¼å¼ä¼ å…¥URLï¼Œæœ¬åº”ç”¨çš„å›è°ƒå‡½æ•°ä¸­ï¼Œè§£æå‡ºURLä¸­çš„åè®®åã€åè®®æ–¹æ³•å’Œå‚æ•°çš„å­—ç¬¦ä¸²ï¼›<br><br/></p><p>é€šè¿‡å‰ç¯‡ä¸­è®²åˆ°çš„åå°„åŸç†ï¼Œä»ä¸Šä¸€æ­¥çš„è§£æç»“æœä¸­å¾—åˆ°çœŸæ­£çš„åè®®ç±»åå’Œåè®®æ–¹æ³•SELï¼›<br><br/></p><p>æ ¹æ®åè®®ç±»åä»æœåŠ¡æ³¨å†Œä¸­å¿ƒæŸ¥è¯¢å…¶å®ç°ç±»ï¼Œå¹¶åˆ›å»ºå…¶å®ä¾‹ï¼›<br><br/></p><p>é€šè¿‡å®ä¾‹è°ƒç”¨åè®®æ–¹æ³•ï¼Œç”±è¿è¡Œæ—¶è°ƒç”¨å…·ä½“çš„å®ç°ï¼Œä»è€Œå®Œæˆæœ¬æ¬¡æœåŠ¡è°ƒç”¨ï¼›</p><h3 id="3-ç¤ºä¾‹"><a href="#3-ç¤ºä¾‹" class="headerlink" title="3.ç¤ºä¾‹"></a>3.ç¤ºä¾‹</h3><p>éœ€æ±‚ï¼šä»<code>ä¸»é¡µ</code>ç»„ä»¶è·³è½¬åˆ°<code>è¯¦æƒ…</code>ç»„ä»¶ï¼›è¿”å›æ—¶æ›´æ–°ä¸»é¡µç»„ä»¶çš„æ ‡é¢˜ã€‚</p><h5 id="3-1-ç›®æ ‡ç»„ä»¶"><a href="#3-1-ç›®æ ‡ç»„ä»¶" class="headerlink" title="3.1.ç›®æ ‡ç»„ä»¶"></a>3.1.ç›®æ ‡ç»„ä»¶</h5><p>è¯¦æƒ…ç»„ä»¶è§†å›¾æ§åˆ¶å™¨ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// å¤´æ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailModuleProtocol.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DetailViewController</span> : <span class="hljs-title">UIViewController</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">UIImage</span> *image;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^detailCallback) (<span class="hljs-type">id</span>&lt;DetailModelProtocol&gt;); <span class="hljs-comment">//å›è°ƒä¸­å›ä¼ è¯¦æƒ…å®ä½“</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">// å®ç°æ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailModel.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DetailViewController</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UIImageView</span> *mIconImv;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DetailViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    <br>    <span class="hljs-keyword">self</span>.mIconImv.image = <span class="hljs-keyword">self</span>.image;<br>    <br>    <span class="hljs-built_in">UIButton</span> *btn = [<span class="hljs-built_in">UIButton</span> buttonWithType:<span class="hljs-built_in">UIButtonTypeCustom</span>];<br>    [btn setTitle:<span class="hljs-string">@&quot;è¿”å›&quot;</span> forState:<span class="hljs-built_in">UIControlStateNormal</span>];<br>    [btn addTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(onBackWithBlock) forControlEvents:<span class="hljs-built_in">UIControlEventTouchUpInside</span>];<br>    <span class="hljs-keyword">self</span>.navigationItem.leftBarButtonItem = [[<span class="hljs-built_in">UIBarButtonItem</span> alloc] initWithCustomView:btn];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onBackWithBlock&#123;<br>    <span class="hljs-comment">// blockä¸­å›ä¼ è¯¦æƒ…å®ä½“</span><br>    DetailModel *model = [[DetailModel alloc] init];<br>    model.name = <span class="hljs-string">@&quot;David&quot;</span>;<br>    model.version = <span class="hljs-string">@&quot;1.0&quot;</span>;<br>    <span class="hljs-keyword">self</span>.detailCallback(model); <span class="hljs-comment">//å›è°ƒä¿¡æ¯</span><br>    <br>    [<span class="hljs-keyword">self</span>.navigationController popViewControllerAnimated:<span class="hljs-literal">YES</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¯¦æƒ…å®ä½“æ–‡ä»¶ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailModuleProtocol.h&quot;</span></span><br><br><span class="hljs-comment">// å®ç°DetailModelProtocolåè®®</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DetailModel</span> : <span class="hljs-title">NSObject</span>&lt;<span class="hljs-title">DetailModelProtocol</span>&gt;</span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *version;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h5 id="3-2-æœåŠ¡åè®®"><a href="#3-2-æœåŠ¡åè®®" class="headerlink" title="3.2.æœåŠ¡åè®®"></a>3.2.æœåŠ¡åè®®</h5><p>è¯¦æƒ…ç»„ä»¶å¯¹å¤–æä¾›æœåŠ¡çš„åè®®ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// DetailModuleProtocol.h</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DetailModuleProtocol_h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DetailModuleProtocol_h</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - Model Protocols</span><br><br><span class="hljs-comment">/// å¯¹åº”çš„æ˜¯è¯¦æƒ…ç»„ä»¶ä¸­çš„DetailModelå®ä½“ï¼Œåªä¸è¿‡æ˜¯å°†å®ä½“çš„å­—æ®µä»¥åè®®æ–¹æ³•çš„å½¢å¼è¿›è¡Œå£°æ˜</span><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">DetailModelProtocol</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span><br>- (<span class="hljs-built_in">NSString</span>*)name;<br>- (<span class="hljs-built_in">NSString</span>*)version;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *è¯¦æƒ…ç»„ä»¶å¯¹å¤–æä¾›çš„æ‰€æœ‰æœåŠ¡ï¼Œéƒ½åœ¨è¿™é‡Œä»¥åè®®æ–¹æ³•çš„å½¢å¼å¯¹å¤–æ›å…‰ï¼›</span><br><span class="hljs-comment"> *æ­¤åè®®å¯¹æ‰€æœ‰å…¶ä»–ç»„ä»¶å¯è§ï¼Œæ‰€ä»¥å…¶ä»–ç»„ä»¶å¯¼å…¥æ­¤å¤´æ–‡ä»¶å³å¯çŸ¥é“è¯¦æƒ…ç»„ä»¶æœ‰å“ªäº›æœåŠ¡å¯ç”¨ï¼›</span><br><span class="hljs-comment"> *é¢å‘åè®®ç¼–ç¨‹ï¼›</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">DetailModuleProtocol</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span><br><br><span class="hljs-keyword">@required</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> è¿›å…¥è¯¦æƒ…é¡µ</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> @param pic å›¾ç‰‡</span><br><span class="hljs-comment"> @param callback ä»è¯¦æƒ…é¡µè¿”å›æ—¶çš„å›è°ƒ</span><br><span class="hljs-comment"> @return è¿”å›è¯¦æƒ…é¡µï¼Œä»¥ä¾¿ä¸»é¡µè°ƒç”¨pushè¿›å…¥æ­¤é¡µé¢</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">UIViewController</span>*)detailControllerWithPic:(<span class="hljs-built_in">UIImage</span>*)pic callback:(<span class="hljs-type">void</span>(^)(<span class="hljs-type">id</span>&lt;DetailModelProtocol&gt;))callback;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* DetailModuleProtocol_h */</span></span><br></code></pre></td></tr></table></figure><p>å…¶ä»–ç»„ä»¶è°ƒç”¨è¯¦æƒ…ç»„ä»¶çš„æœåŠ¡æ—¶ï¼Œåªéœ€æŸ¥çœ‹æ­¤åè®®å¹¶è°ƒç”¨å…¶åè®®æ–¹æ³•å³å¯ã€‚ä¸ºäº†ä¾¿äºæŸ¥è¯¢ï¼Œå¯å°†æ­¤åè®®å¯¼å…¥åˆ°å…¬å…±çš„åè®®å¤´æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// CommonProtocol.h</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CommonProtocol_h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CommonProtocol_h</span><br><br><span class="hljs-comment">// å¯¼å…¥æ¯ä¸ªç»„ä»¶ä¸­å£°æ˜å¯¹å¤–æœåŠ¡æ¥å£çš„åè®®å¤´æ–‡ä»¶</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailModuleProtocol.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CommonProtocol_h */</span></span><br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œåˆ«çš„ç»„ä»¶è°ƒç”¨è¯¦æƒ…ç»„ä»¶çš„æœåŠ¡æ—¶ï¼Œåªéœ€è¦å¯¼å…¥æ­¤å…¬å…±åè®®å¤´æ–‡ä»¶å³å¯ã€‚</p><h5 id="3-3-æœåŠ¡ç±»"><a href="#3-3-æœåŠ¡ç±»" class="headerlink" title="3.3.æœåŠ¡ç±»"></a>3.3.æœåŠ¡ç±»</h5><p>è¯¦æƒ…ç»„ä»¶ä¸­å®ç°äº†æœåŠ¡åè®®çš„ç±»ï¼Œå…¶ä¸­æä¾›äº†åè®®æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå³ç»„ä»¶å¯¹å¤–æœåŠ¡çš„å…·ä½“å†…å®¹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailProtocolImplementor.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailViewController.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ModuleProtocolMediator.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailModuleProtocol.h&quot;</span></span><br><br><span class="hljs-comment">// å°è£…äº†è¯¦æƒ…ç»„ä»¶å¯¹å¤–æä¾›æœåŠ¡çš„å…·ä½“å®ç°</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DetailProtocolImplementor</span> ()&lt;<span class="hljs-title">DetailModuleProtocol</span>&gt;</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DetailProtocolImplementor</span></span><br><br><span class="hljs-comment">// å®ç°åè®® æä¾›å…·ä½“æœåŠ¡</span><br>- (<span class="hljs-built_in">UIViewController</span> *)detailControllerWithPic:(<span class="hljs-built_in">UIImage</span> *)pic<br>                                     callback:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">id</span>&lt;DetailModelProtocol&gt;))callback<br>&#123;<br>    <span class="hljs-comment">// å…·ä½“å®ç°</span><br>    DetailViewController *vc = [[<span class="hljs-built_in">UIStoryboard</span> storyboardWithName:<span class="hljs-string">@&quot;Main&quot;</span> bundle:<span class="hljs-literal">nil</span>]<br>                                  instantiateViewControllerWithIdentifier:<span class="hljs-string">@&quot;DetailViewController&quot;</span>];<br>    vc.image = pic;<br>    vc.detailCallback = callback;<br>    <br>    <span class="hljs-keyword">return</span> vc;<br>&#125;<br><br>+ (<span class="hljs-type">void</span>)load&#123;<br>    <span class="hljs-comment">// æ³¨å†Œåè®® å°†åè®®ä¸å®ç°äº†æ­¤åè®®çš„ä¸šåŠ¡ç±»è¿›è¡Œç»‘å®š</span><br>    [ModuleProtocolMediator registerModuleProtocolImplementor:[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]<br>                                                   forProtocol:<span class="hljs-class"><span class="hljs-keyword">@protocol</span>(<span class="hljs-title">DetailModuleProtocol</span>)];</span><br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œçš„<code>+load</code>æ–¹æ³•ï¼Œå®ƒè°ƒç”¨äº†ä¸­é—´å±‚æ³¨å†Œåè®®ï¼Œæ³¨å†Œæ“ä½œçš„å…·ä½“å®ç°ä¸”å¾€ä¸‹çœ‹~</p><h5 id="3-4-æ³¨å†Œåè®®"><a href="#3-4-æ³¨å†Œåè®®" class="headerlink" title="3.4.æ³¨å†Œåè®®"></a>3.4.æ³¨å†Œåè®®</h5><p>è¿™æ˜¯æœ¬æ–¹æ¡ˆçš„æ ¸å¿ƒç±»ï¼Œå±äºä¸­é—´å±‚ï¼Œè´Ÿè´£æœ¬åœ°æœåŠ¡æ³¨å†Œã€æŸ¥è¯¢ã€è¿œç¨‹è°ƒç”¨ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// å¤´æ–‡ä»¶</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ModuleProtocolMediator</span> : <span class="hljs-title">NSObject</span></span><br><br><span class="hljs-comment">// å•ä¾‹ç±»</span><br>+ (<span class="hljs-keyword">instancetype</span>)shareInstance;<br><br><span class="hljs-comment">// å°†å®ç°äº†åè®®çš„æœåŠ¡ç±»æ³¨å†Œåˆ°å…¨å±€å­—å…¸ä¸­</span><br>+ (<span class="hljs-type">void</span>)registerModuleProtocolImplementor:(Class)implementor<br>                      forProtocol:(Protocol*)protocol;<br><br><span class="hljs-comment">// æ ¹æ®åè®®æŸ¥è¯¢å®ç°äº†æ­¤åè®®çš„æœåŠ¡ç±»ï¼Œå¹¶è¿”å›å®ƒçš„ä¸€ä¸ªå®ä¾‹</span><br>+ (<span class="hljs-type">id</span>)protocolImplementorWithProtocol:(Protocol*)protocol;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> è¿œç¨‹è°ƒç”¨æ¥å£</span><br><span class="hljs-comment"> @param url æŒ‰ç…§çº¦å®šå¥½çš„æ ¼å¼ä¼ å€¼</span><br><span class="hljs-comment"> @param completion å›è°ƒ</span><br><span class="hljs-comment"> @return è¿”å›å€¼ æ˜¯å¦å“åº”æ­¤URL</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-type">BOOL</span>)performActionWithUrl:(<span class="hljs-built_in">NSURL</span> *)url<br>                completion:(<span class="hljs-type">void</span>(^)(<span class="hljs-type">id</span> info))completion;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">// å®ç°æ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ModuleProtocolMediator.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><br><span class="hljs-keyword">struct</span> CallResult &#123;<br>    <span class="hljs-type">BOOL</span> raiseError; <span class="hljs-comment">// æ˜¯å¦äº§ç”Ÿå¼‚å¸¸é”™è¯¯ï¼ˆå¦‚targetæˆ–SELä¸ºnilï¼‰</span><br>    <span class="hljs-type">id</span> result;       <span class="hljs-comment">// perform æˆ– invocation çš„è¿”å›å€¼</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ModuleProtocolMediator</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSMutableDictionary</span> *mProtocolsDic; <span class="hljs-comment">// ä¿å­˜åè®®ä¸å®ç°ç±»çš„å…¨å±€å®¹å™¨</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ModuleProtocolMediator</span></span><br><br>+ (<span class="hljs-keyword">instancetype</span>)shareInstance&#123;<br>    <br>    <span class="hljs-keyword">static</span> ModuleProtocolMediator *mProtocolManager;<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> token;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;token, ^&#123;<br>        mProtocolManager = [[ModuleProtocolMediator alloc] init];<br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> mProtocolManager;<br>&#125;<br><br>- (<span class="hljs-keyword">instancetype</span>)init&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) &#123;<br>        _mProtocolsDic = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br><span class="hljs-comment">// æ³¨å†Œ å°†åè®®ä¸å®ç°ç±»è¿›è¡Œç»‘å®š ä»¥ä¾¿åç»­æŸ¥æ‰¾æ­¤ç±»</span><br>+ (<span class="hljs-type">void</span>)registerModuleProtocolImplementor:(Class)implementor<br>                      forProtocol:(Protocol*)protocol&#123;<br>    <br>    <span class="hljs-built_in">NSString</span> *key = <span class="hljs-built_in">NSStringFromProtocol</span>(protocol);<br>    [ModuleProtocolMediator shareInstance].mProtocolsDic[key] = implementor;<br>&#125;<br><br><span class="hljs-comment">// æŸ¥æ‰¾å®ç°äº†æ­¤åè®®çš„ç±» ç”Ÿæˆå…¶å®ä¾‹</span><br>+ (<span class="hljs-type">id</span>)protocolImplementorWithProtocol:(Protocol*)protocol&#123;<br>    <br>    <span class="hljs-built_in">NSString</span> *key = <span class="hljs-built_in">NSStringFromProtocol</span>(protocol);<br>    Class className = [ModuleProtocolMediator shareInstance].mProtocolsDic[key];<br>    <span class="hljs-type">id</span> obj = [[className alloc] init];<br>    <br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br><br><span class="hljs-comment">/* urlç¤ºä¾‹ï¼š@&quot;DaModuleProtocolScheme://DetailModuleProtocol:detailControllerWithPic:callback:&quot;</span><br><span class="hljs-comment"> * scheme://[protocolName]:[protocolMethod]?key1=value1&amp;key2=value2</span><br><span class="hljs-comment"> * [scheme]  [host]         [path]           [query]</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-type">BOOL</span>)performActionWithUrl:(<span class="hljs-built_in">NSURL</span> *)url<br>                completion:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">id</span> info))completion<br>&#123;<br>    <span class="hljs-built_in">NSMutableArray</span> *params = [[<span class="hljs-built_in">NSMutableArray</span> alloc] init];<br>    <span class="hljs-built_in">NSString</span> *urlString = [url query];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> *param <span class="hljs-keyword">in</span> [urlString componentsSeparatedByString:<span class="hljs-string">@&quot;&amp;&quot;</span>]) &#123;<br>        <span class="hljs-built_in">NSArray</span> *elts = [param componentsSeparatedByString:<span class="hljs-string">@&quot;=&quot;</span>];<br>        <span class="hljs-keyword">if</span>([elts count] &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">continue</span>;<br>        [params addObject:[elts lastObject]];<br>    &#125;<br>    <span class="hljs-comment">// åå°„åè®®å¯¹è±¡</span><br>    Protocol *protocol = <span class="hljs-built_in">NSProtocolFromString</span>(url.host);<br>    <span class="hljs-comment">// è°ƒç”¨æœ¬ç±»æŸ¥è¯¢åè®®çš„å®ç°ç±»</span><br>    <span class="hljs-built_in">NSObject</span> *target = [<span class="hljs-keyword">self</span> protocolImplementorWithProtocol:protocol];<br>    <span class="hljs-comment">// å–å‡ºæƒ³è°ƒç”¨çš„åè®®æ–¹æ³•(URL Decode)</span><br>    <span class="hljs-built_in">NSString</span> *protocolMethod = [[url.path stringByRemovingPercentEncoding]<br>                                stringByReplacingOccurrencesOfString:<span class="hljs-string">@&quot;/&quot;</span> withString:<span class="hljs-string">@&quot;&quot;</span>];<br>    <span class="hljs-comment">// åå°„SELï¼Œå³åè®®ä¸­å®šä¹‰çš„æ–¹æ³•</span><br>    SEL selector = <span class="hljs-built_in">NSSelectorFromString</span>(protocolMethod);<br>    <br>    <span class="hljs-comment">// è°ƒç”¨ perform æ–¹æ³•æˆ–è€… NSInvocation å®ç°é€šä¿¡</span><br>    <span class="hljs-keyword">struct</span> CallResult retStruct = [<span class="hljs-keyword">self</span> safePerformAction:selector target:target params:params];<br><br>    <span class="hljs-keyword">if</span> (retStruct.raiseError) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-type">id</span> value = retStruct.result;<br>        <span class="hljs-keyword">if</span> (completion) &#123;<br>            completion(value);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>    &#125;<br>&#125;<br><br><br>+ (<span class="hljs-keyword">struct</span> CallResult)safePerformAction:(SEL)action<br>                 target:(<span class="hljs-built_in">NSObject</span> *)target<br>                 params:(<span class="hljs-built_in">NSArray</span> *)params<br>&#123;<br>    <span class="hljs-built_in">NSMethodSignature</span>* methodSig = [target methodSignatureForSelector:action];<br>    <span class="hljs-keyword">if</span>(methodSig == <span class="hljs-literal">nil</span>) &#123;<br>        <span class="hljs-keyword">struct</span> CallResult retStruct = &#123;<span class="hljs-literal">YES</span>,<span class="hljs-literal">nil</span>&#125;;<br>        <span class="hljs-keyword">return</span> retStruct;<br>    &#125;<br>    <span class="hljs-keyword">const</span> <span class="hljs-type">char</span>* retType = [methodSig methodReturnType];<br>    <br>    <span class="hljs-keyword">if</span> (strcmp(retType, <span class="hljs-keyword">@encode</span>(<span class="hljs-type">void</span>)) == <span class="hljs-number">0</span> ||<br>        strcmp(retType, <span class="hljs-keyword">@encode</span>(<span class="hljs-type">BOOL</span>)) == <span class="hljs-number">0</span> ||<br>        strcmp(retType, <span class="hljs-keyword">@encode</span>(<span class="hljs-built_in">CGFloat</span>)) == <span class="hljs-number">0</span> ||<br>        strcmp(retType, <span class="hljs-keyword">@encode</span>(<span class="hljs-built_in">NSInteger</span>)) == <span class="hljs-number">0</span> ||<br>        strcmp(retType, <span class="hljs-keyword">@encode</span>(<span class="hljs-built_in">NSUInteger</span>)) == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">NSInvocation</span> *invocation = [<span class="hljs-built_in">NSInvocation</span> invocationWithMethodSignature:methodSig];<br>        [invocation setSelector:action];<br>        [invocation setTarget:target];<br>        <br>        <span class="hljs-built_in">NSInteger</span> count = params.count;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            <span class="hljs-built_in">NSObject</span> *value = params[i];<br>            [invocation setArgument:&amp;value atIndex:i + <span class="hljs-number">2</span>]; <span class="hljs-comment">// å‚æ•°ä»ç¬¬äºŒä½å¼€å§‹ç®—èµ·</span><br>        &#125;<br>        [invocation invoke];<br>        <br>        <span class="hljs-comment">// æ— è¿”å›å€¼æ—¶ï¼Œç»“æ„ä½“ä¸­resultå­—æ®µä¸ºnil</span><br>        <span class="hljs-keyword">if</span> (strcmp(retType, <span class="hljs-keyword">@encode</span>(<span class="hljs-type">void</span>)) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">struct</span> CallResult retStruct = &#123;<span class="hljs-literal">NO</span>,<span class="hljs-literal">nil</span>&#125;;<br>            <span class="hljs-keyword">return</span> retStruct;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// è¿”å›å€¼ä¸ºæ•°å€¼ç±»å‹æ—¶ï¼ŒåŒ…è£…æˆå¯¹è±¡</span><br>            <span class="hljs-built_in">NSInteger</span> result = <span class="hljs-number">0</span>;<br>            [invocation getReturnValue:&amp;result];<br>            <span class="hljs-keyword">struct</span> CallResult retStruct = &#123;<span class="hljs-literal">NO</span>,@(result)&#125;;<br>            <span class="hljs-keyword">return</span> retStruct;<br>        &#125;<br>    &#125;<br>    <br>    <br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> clang diagnostic push</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> clang diagnostic ignored <span class="hljs-string">&quot;-Warc-performSelector-leaks&quot;</span></span><br>    <span class="hljs-comment">// è¿”å›å€¼ä¸ºå¯¹è±¡ç±»å‹ï¼Œç›´æ¥è°ƒç”¨å³å¯</span><br>    <span class="hljs-type">id</span> result = [target performSelector:action withObject:params];<br>    <span class="hljs-keyword">struct</span> CallResult retStruct = &#123;<span class="hljs-literal">NO</span>,result&#125;;<br>    <span class="hljs-keyword">return</span> retStruct;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> clang diagnostic pop</span><br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ­¤å·¥å…·ç±»ä¹Ÿæä¾›äº†<code>æœ¬åœ°è°ƒç”¨</code>ä¸<code>è¿œç¨‹è°ƒç”¨</code>ä¸¤ç§è°ƒç”¨ç»„ä»¶çš„æ–¹å¼ã€‚</p><ul><li>æœ¬åœ°è°ƒç”¨</li></ul><p>æœ¬åœ°è°ƒç”¨ç»„ä»¶æ—¶ï¼Œæœ¬ç±»ä½œä¸ºä¸­é—´å±‚é€šè¿‡ä¸‹é¢çš„æ¥å£å°†åè®®ä¸å®ç°äº†æ­¤åè®®çš„æœåŠ¡ç±»è¿›è¡Œç»‘å®šï¼Œå¹¶ä¿å­˜åˆ°å†…éƒ¨çš„å­—å…¸ä¸­ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">+ (<span class="hljs-keyword">void</span>)registerModuleProtocolImplementor:(<span class="hljs-keyword">Class</span>)implementor<br>                      forProtocol:(Protocol*)protocol;<br></code></pre></td></tr></table></figure><p>åœ¨Aç»„ä»¶è°ƒç”¨Bç»„ä»¶çš„æœåŠ¡æ—¶ï¼Œåªéœ€è¦é€šè¿‡ä¸‹é¢çš„æ¥å£ï¼Œæ ¹æ®Bç»„ä»¶æä¾›çš„åè®®å–å‡ºåè®®å®ç°ç±»ï¼Œå®ä¾‹åŒ–ä¹‹åè°ƒç”¨å¯¹åº”çš„åè®®æ–¹æ³•å³å¯ã€‚</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">+ (<span class="hljs-built_in">id</span>)protocolImplementorWithProtocol:(Protocol*)protocol;<br></code></pre></td></tr></table></figure><ul><li>è¿œç¨‹è°ƒç”¨</li></ul><p>æ­¤å¤„çš„è¿œç¨‹è°ƒç”¨ä¸åå°„æ–¹æ¡ˆä¸­è¿œç¨‹è°ƒç”¨çš„æ–¹å¼ç›¸åŒï¼ŒAåº”ç”¨æŒ‰ç…§çº¦å®šçš„æ ¼å¼ç»„åˆä¸€ä¸ªURLå¹¶ä¼ é€’ç»™Båº”ç”¨ï¼ŒéšåBåº”ç”¨çš„<code>application:openURL:options:</code>å›è°ƒä¸­è°ƒç”¨ä»¥ä¸‹æ–¹æ³•å¯¹URLè¿›è¡Œè§£æï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-type">BOOL</span>)performActionWithUrl:(<span class="hljs-built_in">NSURL</span> *)url<br>                completion:(<span class="hljs-type">void</span>(^)(<span class="hljs-type">id</span> info))completion;<br></code></pre></td></tr></table></figure><p>åœ¨æ­¤æ–¹æ³•çš„å®ç°ä¸­è§£æå‡ºåè®®åå’Œåè®®æ–¹æ³•SELï¼›ä»¥è§£æå‡ºæ¥çš„åè®®åä½œä¸ºkeyï¼Œä»æœ¬å·¥å…·ç±»ä¸­å–å‡ºå®ç°äº†æ­¤åè®®çš„ç»„ä»¶æœåŠ¡ç±»ï¼›éšååˆ›å»ºå…¶å®ä¾‹å¹¶é€šè¿‡ perform æˆ– NSInvocation è°ƒç”¨åå°„å‡ºæ¥çš„åè®®æ–¹æ³•ï¼Œå®Œæˆæœ¬æ¬¡è¿œç¨‹è°ƒç”¨ã€‚å¯å‚è€ƒæˆ‘åœ¨ä¸Šé¢ä»£ç ä¸­çš„æ³¨é‡Šã€‚</p><h5 id="3-5-è°ƒç”¨æœåŠ¡"><a href="#3-5-è°ƒç”¨æœåŠ¡" class="headerlink" title="3.5.è°ƒç”¨æœåŠ¡"></a>3.5.è°ƒç”¨æœåŠ¡</h5><ul><li>æœ¬åœ°è°ƒç”¨</li></ul><p>ä¸»é¡µç»„ä»¶ä¸­è°ƒç”¨è¯¦æƒ…ç»„ä»¶ï¼Œè·³è½¬åˆ°è¿”å›çš„è¯¦æƒ…ç»„ä»¶å®ä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;HomeViewController.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ModuleProtocolMediator.h&quot;</span> <span class="hljs-comment">// å¯¼å…¥ä¸­é—´å±‚</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;CommonProtocol.h&quot;</span>  <span class="hljs-comment">// å¯¼å…¥å…¬å…±åè®®å¤´æ–‡ä»¶</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">HomeViewController</span></span><br><br>- (<span class="hljs-keyword">IBAction</span>)onShowDetail:(<span class="hljs-type">id</span>)sender &#123;<br>    <br>    <span class="hljs-built_in">UIButton</span> *btn = sender;<br>    <br>    <span class="hljs-comment">/* è°ƒç”¨è¯¦æƒ…ç»„ä»¶ å› ä¸ºå¯¼å…¥äº† ModuleProtocolMediator å’Œ DetailModuleProtocolï¼Œ</span><br><span class="hljs-comment">     *æ‰€ä»¥å½“å‰ç±»ä¸­ç›´åˆ°è¯¦æƒ…ç»„ä»¶æä¾›äº†å“ªäº›æœåŠ¡æ¥å£ï¼Œè°ƒç”¨è¿™äº›æ¥å£å³å¯~</span><br><span class="hljs-comment">     *å½“å‰ç±»åªè·ŸModuleProtocolMediatoräº¤äº’ï¼Œä¸ä¸DetailViewControllerè€¦åˆ~</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">id</span>&lt;DetailModuleProtocol&gt; implementor = [ModuleProtocolMediator protocolImplementorWithProtocol:<br>                                            <span class="hljs-class"><span class="hljs-keyword">@protocol</span>(<span class="hljs-title">DetailModuleProtocol</span>)];</span><br>    <br>    <span class="hljs-comment">// è°ƒç”¨æ¥å£ ä¼ é€’å‚æ•° è·å–è¿”å›å€¼</span><br>    <span class="hljs-built_in">UIViewController</span> *vc = [implementor detailControllerWithPic:btn.currentBackgroundImage<br>                                                       callback:^(<span class="hljs-type">id</span>&lt;DetailModelProtocol&gt; model) &#123;<br>        <span class="hljs-keyword">self</span>.title = model.name; <span class="hljs-comment">// ä»è¯¦æƒ…ä¸­è¿”å›æ—¶æ›´æ–°æ ‡é¢˜(æ³¨æ„ï¼Œè¿™é‡Œå¹¶æœªå¯¼å…¥è¯¦æƒ…å®ä½“ï¼Œè€Œæ˜¯å®ä½“çš„åè®®ç±»)</span><br>    &#125;];<br>    [<span class="hljs-keyword">self</span>.navigationController pushViewController:vc animated:<span class="hljs-literal">YES</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ä¸»é¡µç»„ä»¶è°ƒç”¨äº†è¯¦æƒ…ç»„ä»¶ä½†å¹¶æœªå¼•ç”¨è¯¦æƒ…ç»„ä»¶çš„å¤´æ–‡ä»¶ï¼›è¯¦æƒ…ç»„ä»¶çš„å›è°ƒä¸­è¿”å›äº†è¯¦æƒ…å®ä½“ï¼Œä½†ä¹Ÿåªæ˜¯ç”¨äº†åè®®çš„å½¢å¼ï¼Œå¹¶æœªçœŸçš„å¯¼å…¥<code>DetailModel.h</code>å®ä½“ã€‚æ‰€ä»¥ä»æ•´ä½“ä¸Šæ¥è¯´ï¼Œ<code>Home</code>ç»„ä»¶åªå¯¼å…¥äº†ä¸­é—´å±‚å’Œå…¬å…±åè®®å¤´æ–‡ä»¶ã€‚</p><ul><li>è¿œç¨‹è°ƒç”¨</li></ul><p>Aåº”ç”¨ä¸­æŒ‰ç…§çº¦å®šçš„æ ¼å¼ç»„è£…URLå¹¶è·³è½¬ï¼šï¼ˆæ³¨æ„SELéƒ¨åˆ†è¦è¿›è¡Œç¼–ç ï¼‰</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSCharacterSet</span> *allowedCharacters = [[<span class="hljs-built_in">NSCharacterSet</span> characterSetWithCharactersInString:<span class="hljs-string">@&quot;:&quot;</span>] invertedSet];<br><span class="hljs-built_in">NSString</span> *scheme = <span class="hljs-string">@&quot;DaModuleProtocolScheme&quot;</span>;<br><span class="hljs-built_in">NSString</span> *protocol = <span class="hljs-string">@&quot;DetailModuleProtocol&quot;</span>;<br><span class="hljs-built_in">NSString</span> *SELStr = [<span class="hljs-string">@&quot;detailControllerWithPic:callback:&quot;</span> <br>   stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacters];<br><br><span class="hljs-built_in">NSString</span> *params = [<span class="hljs-string">@&quot;k1=1&amp;k2=2&quot;</span> stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacters];<br><span class="hljs-built_in">NSString</span> *urlStr = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;%@://%@:/%@?%@&quot;</span>,scheme,protocol,SELStr,params];<br><span class="hljs-comment">// URLç¤ºä¾‹ï¼š@&quot;DaModuleProtocolScheme://DetailModuleProtocol:/detailControllerWithPic:callback:?k1=1&amp;k2=2&quot;;</span><br>    <br><span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:urlStr];<br>[[<span class="hljs-built_in">UIApplication</span> sharedApplication] openURL:url];<br></code></pre></td></tr></table></figure><p>å½“å‰åº”ç”¨çš„<code>AppDelegate</code>å›è°ƒä¸­è°ƒç”¨æ³¨å†Œä¸­å¿ƒæä¾›çš„è¿œç¨‹è°ƒç”¨æ¥å£:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)app<br>            openURL:(<span class="hljs-built_in">NSURL</span> *)url<br>            options:(<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">UIApplicationOpenURLOptionsKey</span>,<span class="hljs-type">id</span>&gt; *)options<br>&#123;<br>    <span class="hljs-keyword">return</span> [ModuleProtocolMediator performActionWithUrl:url completion:^(<span class="hljs-type">id</span> info) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++%@&quot;</span>,info);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p><code>performActionWithUrl</code>æ¥å£çš„å…·ä½“å®ç°å¯å¾€ä¸Šç¿»ä¸€ç¿»<code>3.4.æ³¨å†Œåè®®</code>ç« èŠ‚ä¸­çš„<code>ModuleProtocolMediator</code>ç±»ã€‚æ­¤æ–¹æ³•å€Ÿé‰´äº†å‰ä¸¤ç¯‡æ–‡ç« ä¸­åˆ†æè¿‡çš„<code>URL</code>å’Œ<code>åå°„</code>åŸç†ï¼Œåå°„å‡ºåè®®ç±»åå’Œæ–¹æ³•åï¼Œå†é€šè¿‡æ³¨å†Œä¸­å¿ƒæŸ¥æ‰¾å¹¶åˆ›å»ºå®ç°äº†æ­¤åè®®çš„ç±»çš„å®ä¾‹ï¼Œæœ€ååˆ©ç”¨è¿è¡Œæ—¶æ¥å£è°ƒç”¨åè®®æ–¹æ³•ï¼Œæˆ‘å·²åœ¨ä¸Šé¢çš„ä»£ç ä¸­å·²ç»åšäº†è¯¦ç»†æ³¨é‡Šã€‚</p><h5 id="3-6-æ–¹æ¡ˆæ€»ç»“"><a href="#3-6-æ–¹æ¡ˆæ€»ç»“" class="headerlink" title="3.6.æ–¹æ¡ˆæ€»ç»“"></a>3.6.æ–¹æ¡ˆæ€»ç»“</h5><p><img src="https://davidlii.nos-eastchina1.126.net/pic_module_protocols.jpg" alt="ç»„ä»¶åŒ–-é¢å‘åè®®"></p><p>ä¼˜ç‚¹ï¼š</p><ul><li>æœåŠ¡åè®®æ³¨å†Œæ–¹æ¡ˆä½“ç°äº†é¢å‘åè®®ï¼ˆæŠ½è±¡ï¼‰çš„ç¼–ç¨‹æ€æƒ³ï¼Œç»„ä»¶é—´é€šè¿‡åè®®è¿›è¡Œé€šä¿¡ï¼›</li><li>åè®®æ–¹æ³•ä¸­å¯ä»¥å®šä¹‰ä»»æ„ä¸ªæ•°å’Œä»»æ„ç±»å‹çš„å‚æ•°ï¼›</li><li>è°ƒç”¨åè®®æ–¹æ³•æ—¶æœ‰ä»£ç æç¤ºè¾…åŠ©ï¼Œä»è€Œé¿å…äº†æ˜æ–‡ç¡¬ç¼–ç çš„ä¸ä¾¿ï¼›</li><li>ç»„ä»¶é—´éœ€è¦å¼•ç”¨å¯¹æ–¹çš„å®ä½“æ—¶ï¼Œåªéœ€è¦æ›¿æ¢ä¸ºå®ä½“æ‰€ç»§æ‰¿çš„åè®®å³å¯ï¼›</li><li>å„ç»„ä»¶å•æ–¹å‘ä¾èµ–äºæœåŠ¡ä¸­å¿ƒï¼Œå®ç°äº†ä»¥<code>ModuleProtocolMediator</code>ä¸ºä¸­å¿ƒçš„è§£è€¦ï¼›</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>Aç»„ä»¶å‘Bç»„ä»¶ä¼ é€’Nä¸ªæ•°æ®ï¼Œå°±éœ€è¦åœ¨Bç»„ä»¶çš„æœåŠ¡åè®®æ–¹æ³•ä¸­å®šä¹‰Nä¸ªå‚æ•°ï¼Œè¿™ä¸å¦‚ä¼ ä¸€ä¸ªå®ä½“æ–¹ä¾¿ï¼Œä½†Aä¸€æ—¦å¼•å…¥Bçš„å®ä½“æ–‡ä»¶å°±äº§ç”Ÿäº†ä¾èµ–ï¼›</li><li>æ³¨å†ŒæœåŠ¡åè®®æ˜¯åœ¨ç»„ä»¶å¯¹å¤–æœåŠ¡ç±»çš„<code>+load</code>æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œè¿‡å¤šçš„åœ¨<code>+load</code>æ–¹æ³•ä¸­å¤„ç†æ³¨å†Œäº‹ä»¶ä¼šå½±å“åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ã€‚</li></ul><h3 id="4-ç›®å½•ç»“æ„"><a href="#4-ç›®å½•ç»“æ„" class="headerlink" title="4.ç›®å½•ç»“æ„"></a>4.ç›®å½•ç»“æ„</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs stylus">.<br>â”œâ”€â”€ DaModule+Protocol<br>â”‚Â Â  â”œâ”€â”€ AppDelegate<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”œâ”€â”€ AppDelegate<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”œâ”€â”€ Assets<span class="hljs-selector-class">.xcassets</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AppIcon<span class="hljs-selector-class">.appiconset</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ Contents<span class="hljs-selector-class">.json</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Contents<span class="hljs-selector-class">.json</span><br>â”‚Â Â  â”œâ”€â”€ Base<span class="hljs-selector-class">.lproj</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LaunchScreen<span class="hljs-selector-class">.storyboard</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Main<span class="hljs-selector-class">.storyboard</span><br>â”‚Â Â  â”œâ”€â”€ Detail<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Controllers<br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DetailViewController<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ DetailViewController<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Model<br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DetailModel<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ DetailModel<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Protocol+IMPer<br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DetailProtocolImplementor<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ DetailProtocolImplementor<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Protocols<br>â”‚Â Â  â”‚Â Â      â””â”€â”€ DetailModuleProtocol<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”œâ”€â”€ Home<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ HomeViewController<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ HomeViewController<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”œâ”€â”€ Icons<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ <span class="hljs-number">1</span>@<span class="hljs-number">2</span>x<span class="hljs-selector-class">.png</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ <span class="hljs-number">1</span>@<span class="hljs-number">3</span>x<span class="hljs-selector-class">.png</span><br>â”‚Â Â  â”œâ”€â”€ Info<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”œâ”€â”€ ProtocolMediator<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ CommonProtocol<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ModuleProtocolMediator<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ ModuleProtocolMediator<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â””â”€â”€ <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.m</span><br>â””â”€â”€ DaModule+Protocol.xcodeproj<br></code></pre></td></tr></table></figure><h3 id="5-ç»“å°¾"><a href="#5-ç»“å°¾" class="headerlink" title="5.ç»“å°¾"></a>5.ç»“å°¾</h3><p>åŸºäºé¢å‘åè®®ç¼–ç¨‹çš„<code>åè®®+æœåŠ¡æ³¨å†Œ+URL+åå°„</code>æ–¹æ¡ˆå¾ˆå¥½çš„å…‹æœäº†å•çº¯<code>URL</code>å’Œ<code>åå°„</code>æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒæœ¬åœ°å’Œè¿œç¨‹è°ƒç”¨ï¼›å½“ç„¶å®ƒä¹Ÿæœ‰å°ç¼ºç‚¹ï¼Œä½†æ˜¾ç„¶ä¼˜ç‚¹å¤§äºç¼ºç‚¹ï¼Œæ‰€ä»¥è¿˜æ˜¯å¾ˆå€¼å¾—æ¨èçš„ã€‚ç›®å‰æœ‰èµå¼€æºçš„<code>Bifrost</code>åº“é™¤äº†<code>URL</code>è·¯ç”±æ–¹æ¡ˆå¤–ï¼Œä¹Ÿæä¾›äº†åŸºäºåè®®çš„ç»„ä»¶åŒ–æ–¹æ¡ˆï¼Œåç»­æœ‰æ—¶é—´ä¼šå•å¼€ä¸€ç¯‡æ¢³ç†ä¸€ä¸‹è¿™ä¸ªåº“~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/davidli-/DaModule-Protocol">Â©æœåŠ¡åè®®æ³¨å†Œæ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/davidli-/DaModules-Hardcore">Â©åå°„æ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/davidli-/HelModules-URL">Â©URL+Blockæ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/youzan/Bifrost">Â©æœ‰èµBifrost</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¶æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç»„ä»¶åŒ–-åå°„æ–¹æ¡ˆ</title>
    <link href="/2020/11/12/modules-runtime.html"/>
    <url>/2020/11/12/modules-runtime.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1.å‰è¨€"></a>1.å‰è¨€</h3><p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­åˆ†æäº†ç»„ä»¶åŒ–çš„ç›®æ ‡å’Œå¥½å¤„ï¼ŒåŒæ—¶æ¢³ç†äº†åŸºäº<code>URL+Block</code>çš„è·¯ç”±ç»„ä»¶åŒ–è§£å†³æ–¹æ¡ˆçš„åŸç†ã€å®è·µå’Œä¼˜ç¼ºç‚¹ã€‚æœ¬æ–‡å°†ç»§ç»­ä»‹ç»ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆï¼šåŸºäºåå°„åŸç†çš„ç»„ä»¶åŒ–æ–¹æ¡ˆã€‚</p><h3 id="2-åœºæ™¯"><a href="#2-åœºæ™¯" class="headerlink" title="2.åœºæ™¯"></a>2.åœºæ™¯</h3><p>ä»<code>ä¸»é¡µ</code>è·³è½¬åˆ°<code>è¯¦æƒ…</code>ï¼Œä¼ å…¥è¯¦æƒ…é¡µæ‰€éœ€çš„å¤´åƒï¼›<br><br/></p><p>åœ¨è¯¦æƒ…ä¸­ç®€å•çš„ä¿®æ”¹ä¿¡æ¯ä¹‹åï¼Œè¿”å›ä¸»é¡µæ—¶æ›´æ–°ä¸»é¡µçš„æ ‡é¢˜ã€‚</p><h3 id="3-æ€è·¯"><a href="#3-æ€è·¯" class="headerlink" title="3.æ€è·¯"></a>3.æ€è·¯</h3><p>åŸºäºåå°„åŸç†çš„ç»„ä»¶åŒ–æ–¹æ¡ˆï¼Œå…¶é¦–è¦ç›®æ ‡è¿˜æ˜¯å®ç°å„ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼ŒåŒæ—¶å‡å°‘ç»„ä»¶é—´çš„è€¦åˆã€‚å…¶å®ç°åŸç†å¦‚ä¸‹ï¼š</p><h4 id="3-1-åå°„ç±»å"><a href="#3-1-åå°„ç±»å" class="headerlink" title="3.1.åå°„ç±»å"></a>3.1.åå°„ç±»å</h4><p>åˆ©ç”¨è¿è¡Œæ—¶æ¥å£å°†ç±»ååå°„æˆç±»ï¼Œå¦‚ç›®æ ‡ç»„ä»¶çš„ç±»åï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Class *targetObj <span class="hljs-operator">=</span> NSClassFromString(NSString *aClassName)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h4 id="3-2-åå°„æ–¹æ³•å"><a href="#3-2-åå°„æ–¹æ³•å" class="headerlink" title="3.2.åå°„æ–¹æ³•å"></a>3.2.åå°„æ–¹æ³•å</h4><p>å°†æ–¹æ³•ååå°„æˆSELï¼Œå¦‚ç›®æ ‡ç»„ä»¶æä¾›çš„æ¥å£ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">SEL sel <span class="hljs-operator">=</span> NSSelectorFromString(NSString *aSelectorName)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h4 id="3-3-è°ƒç”¨"><a href="#3-3-è°ƒç”¨" class="headerlink" title="3.3.è°ƒç”¨"></a>3.3.è°ƒç”¨</h4><p>é€šè¿‡ [targetObj performSelector:sel withObject:params] å®ç°ä¸ç›®æ ‡ç»„ä»¶çš„é€šä¿¡ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(id)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector withObject:<span class="hljs-params">(id)</span>object;<br></code></pre></td></tr></table></figure><h4 id="3-4-ä¼˜åŒ–"><a href="#3-4-ä¼˜åŒ–" class="headerlink" title="3.4.ä¼˜åŒ–"></a>3.4.ä¼˜åŒ–</h4><p>ç”±äº performSelector ä¼ é€’çš„å‚æ•°ä¸ªæ•°æœ‰é™ï¼Œä¸”è¿”å›å€¼åªèƒ½ä¸ºidç±»å‹ï¼Œæ‰€ä»¥å¯ä½¿ç”¨ NSInvocation ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-built_in">NSInvocation</span> *)invocationWithMethodSignature:(<span class="hljs-built_in">NSMethodSignature</span> *)sig; <span class="hljs-comment">// åˆ›å»ºå®ä¾‹</span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-type">id</span> target; <span class="hljs-comment">//è®¾ç½®ç›®æ ‡</span><br><span class="hljs-keyword">@property</span> SEL selector; <span class="hljs-comment">// è®¾ç½®ç›®æ ‡å‡½æ•°</span><br><br>- (<span class="hljs-type">void</span>)setArgument:(<span class="hljs-type">void</span> *)argumentLocation atIndex:(<span class="hljs-built_in">NSInteger</span>)idx; <span class="hljs-comment">//è®¾ç½®å‚æ•°</span><br>- (<span class="hljs-type">void</span>)invoke; <span class="hljs-comment">// å‘èµ·è°ƒç”¨</span><br>- (<span class="hljs-type">void</span>)getReturnValue:(<span class="hljs-type">void</span> *)retLoc; <span class="hljs-comment">// è·å–è¿”å›å€¼</span><br></code></pre></td></tr></table></figure><h3 id="4-CTMediator"><a href="#4-CTMediator" class="headerlink" title="4.CTMediator"></a>4.CTMediator</h3><p>åå°„æ–¹æ¡ˆåˆ©ç”¨äº†è¿è¡Œæ—¶çš„ä¸€äº›æ¥å£ï¼Œå¦‚æœä½ ç†Ÿæ‚‰çš„è¯å®Œå…¨å¯ä»¥è‡ªå·±å»å°è¯•è°ƒç”¨è¿™äº›æ¥å£ï¼Œå®ç°ç»„ä»¶é—´çš„é€šä¿¡ã€‚è¿™é‡Œæˆ‘æƒ³ä»‹ç»çš„æ˜¯ä¸€ä¸ªç”¨äºå®ç°ç»„ä»¶é—´é€šä¿¡çš„ä¸‰æ–¹åº“<a href="https://github.com/casatwy/CTMediator">CTMediator</a>ï¼Œå®ƒæ­£æ˜¯åŸºäºOCçš„åå°„æœºåˆ¶ï¼Œå¸®æˆ‘ä»¬å°è£…äº† Target-action å’Œ NSInvocation æ“ä½œã€‚å®ƒæä¾›äº†ä¸¤ç§è°ƒç”¨ç»„ä»¶çš„æ–¹å¼ï¼šæœ¬åœ°è°ƒç”¨å’Œè¿œç¨‹è°ƒç”¨ï¼ŒåŒæ—¶æä¾›äº†å…¶ä»–å‰¯äº§å“ã€‚è¿™ä¸ªåº“å¯¹å®è·µåŸºäºåå°„åŸç†çš„ç»„ä»¶åŒ–è§£è€¦æ–¹æ¡ˆæä¾›äº†å¾ˆå¥½çš„å¸®åŠ©ï¼Œè‡³å°‘ä½ å¯ä»¥æ‹¿æ¥åšä¸ªå‚è€ƒã€‚</p><h4 id="4-1-ä»£ç "><a href="#4-1-ä»£ç " class="headerlink" title="4.1.ä»£ç "></a>4.1.ä»£ç </h4><p>è¿™ä¸ªåº“å¾ˆç²¾ç‚¼ï¼Œåªæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// CTMediator.h</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">CTMediator</span> : <span class="hljs-title">NSObject</span></span><br><br>+ (<span class="hljs-keyword">instancetype</span>)sharedInstance;<br><br><span class="hljs-comment">// è¿œç¨‹Appè°ƒç”¨å…¥å£</span><br>- (<span class="hljs-type">id</span>)performActionWithUrl:(<span class="hljs-built_in">NSURL</span> *)url<br>                completion:(<span class="hljs-type">void</span>(^)(<span class="hljs-built_in">NSDictionary</span> *info))completion;<br><br><span class="hljs-comment">// æœ¬åœ°ç»„ä»¶è°ƒç”¨å…¥å£</span><br>- (<span class="hljs-type">id</span>)performTarget:(<span class="hljs-built_in">NSString</span> *)targetName<br>             action:(<span class="hljs-built_in">NSString</span> *)actionName<br>             params:(<span class="hljs-built_in">NSDictionary</span> *)params<br>  shouldCacheTarget:(<span class="hljs-type">BOOL</span>)shouldCacheTarget;<br><br>- (<span class="hljs-type">void</span>)releaseCachedTargetWithTargetName:(<span class="hljs-built_in">NSString</span> *)targetName;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// CTMediator.m</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CTMediator</span></span><br><br><span class="hljs-comment">/* è¿œç¨‹APPè°ƒç”¨å…¥å£</span><br><span class="hljs-comment"> scheme://[target]/[action]?[params]</span><br><span class="hljs-comment"> url sample:</span><br><span class="hljs-comment"> aaa://targetA/actionB?id=1234</span><br><span class="hljs-comment"> */</span><br><br>- (<span class="hljs-type">id</span>)performActionWithUrl:(<span class="hljs-built_in">NSURL</span> *)url<br>                completion:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSDictionary</span> *))completion<br>&#123;<br>    <span class="hljs-built_in">NSMutableDictionary</span> *params = [[<span class="hljs-built_in">NSMutableDictionary</span> alloc] init];<br>    <span class="hljs-built_in">NSString</span> *urlString = [url query];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> *param <span class="hljs-keyword">in</span> [urlString componentsSeparatedByString:<span class="hljs-string">@&quot;&amp;&quot;</span>]) &#123;<br>        <span class="hljs-built_in">NSArray</span> *elts = [param componentsSeparatedByString:<span class="hljs-string">@&quot;=&quot;</span>];<br>        <span class="hljs-keyword">if</span>([elts count] &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">continue</span>;<br>        [params setObject:[elts lastObject] forKey:[elts firstObject]];<br>    &#125;<br>    <br>    <span class="hljs-comment">/* è¿™é‡Œè¿™ä¹ˆå†™ä¸»è¦æ˜¯å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œé˜²æ­¢é»‘å®¢é€šè¿‡è¿œç¨‹æ–¹å¼è°ƒç”¨æœ¬åœ°æ¨¡å—ã€‚</span><br><span class="hljs-comment">    è¿™é‡Œçš„åšæ³•è¶³ä»¥åº”å¯¹ç»å¤§å¤šæ•°åœºæ™¯ï¼Œå¦‚æœè¦æ±‚æ›´åŠ ä¸¥è‹›ï¼Œä¹Ÿå¯ä»¥åšæ›´åŠ å¤æ‚çš„å®‰å…¨é€»è¾‘ã€‚*/</span><br>    <span class="hljs-built_in">NSString</span> *actionName = [url.path stringByReplacingOccurrencesOfString:<span class="hljs-string">@&quot;/&quot;</span> withString:<span class="hljs-string">@&quot;&quot;</span>];<br>    <span class="hljs-keyword">if</span> ([actionName hasPrefix:<span class="hljs-string">@&quot;native&quot;</span>]) &#123;<br>        <span class="hljs-keyword">return</span> @(<span class="hljs-literal">NO</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">/* è¿™ä¸ªdemoé’ˆå¯¹URLçš„è·¯ç”±å¤„ç†éå¸¸ç®€å•ï¼Œå°±åªæ˜¯å–å¯¹åº”çš„targetåå­—å’Œmethodåå­—ï¼Œ</span><br><span class="hljs-comment">    ä½†è¿™å·²ç»è¶³ä»¥åº”å¯¹ç»å¤§éƒ¨ä»½éœ€æ±‚ã€‚å¦‚æœéœ€è¦æ‹“å±•ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•è°ƒç”¨ä¹‹å‰åŠ å…¥å®Œæ•´çš„è·¯ç”±é€»è¾‘</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-type">id</span> result = [<span class="hljs-keyword">self</span> performTarget:url.host<br>                             action:actionName<br>                             params:params<br>                  shouldCacheTarget:<span class="hljs-literal">NO</span>];<br>    <span class="hljs-keyword">if</span> (completion) &#123;<br>        <span class="hljs-keyword">if</span> (result) &#123;<br>            completion(@&#123;<span class="hljs-string">@&quot;result&quot;</span>:result&#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            completion(<span class="hljs-literal">nil</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">// ME:æœ¬åœ°ç»„ä»¶è°ƒç”¨å…¥å£</span><br>- (<span class="hljs-type">id</span>)performTarget:(<span class="hljs-built_in">NSString</span> *)targetName<br>             action:(<span class="hljs-built_in">NSString</span> *)actionName<br>             params:(<span class="hljs-built_in">NSDictionary</span> *)params<br>  shouldCacheTarget:(<span class="hljs-type">BOOL</span>)shouldCacheTarget<br>&#123;<br>    <span class="hljs-built_in">NSString</span> *swiftModuleName = params[kCTMediatorParamsKeySwiftTargetModuleName];<br>    <br>    <span class="hljs-comment">// åå°„target</span><br>    <span class="hljs-built_in">NSString</span> *targetClassString = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-keyword">if</span> (swiftModuleName.length &gt; <span class="hljs-number">0</span>) &#123;<br>        targetClassString = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;%@.Target_%@&quot;</span>, swiftModuleName, targetName];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// NOTICE: å°±æ˜¯è¿™é‡Œç»™ç±»ååŠ äº†å‰ç¼€!!!</span><br>        targetClassString = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;Target_%@&quot;</span>, targetName];<br>    &#125;<br>    <span class="hljs-built_in">NSObject</span> *target = <span class="hljs-keyword">self</span>.cachedTarget[targetClassString];<br>    <span class="hljs-keyword">if</span> (target == <span class="hljs-literal">nil</span>) &#123;<br>        Class targetClass = <span class="hljs-built_in">NSClassFromString</span>(targetClassString);<br>        target = [[targetClass alloc] init];<br>    &#125;<br>    <br>    <span class="hljs-comment">// åå°„action</span><br>    <span class="hljs-built_in">NSString</span> *actionString = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;Action_%@:&quot;</span>, actionName];<br>    SEL action = <span class="hljs-built_in">NSSelectorFromString</span>(actionString);<br>    <br>    <span class="hljs-keyword">if</span> (target == <span class="hljs-literal">nil</span>) &#123;<br>        <span class="hljs-comment">/*è¿™é‡Œæ˜¯å¤„ç†æ— å“åº”è¯·æ±‚çš„åœ°æ–¹ä¹‹ä¸€ï¼Œè¿™ä¸ªdemoåšå¾—æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥å“åº”çš„targetï¼Œå°±ç›´æ¥returnäº†ã€‚</span><br><span class="hljs-comment">        å®é™…å¼€å‘è¿‡ç¨‹ä¸­æ˜¯å¯ä»¥äº‹å…ˆç»™ä¸€ä¸ªå›ºå®šçš„targetä¸“é—¨ç”¨äºåœ¨è¿™ä¸ªæ—¶å€™é¡¶ä¸Šï¼Œç„¶åå¤„ç†è¿™ç§è¯·æ±‚çš„</span><br><span class="hljs-comment">         */</span><br>        [<span class="hljs-keyword">self</span> NoTargetActionResponseWithTargetString:targetClassString<br>                                      selectorString:actionString<br>                                        originParams:params];<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (shouldCacheTarget) &#123;<br>        <span class="hljs-keyword">self</span>.cachedTarget[targetClassString] = target;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> ([target respondsToSelector:action]) &#123;<br>        <span class="hljs-comment">// NOTICE: è°ƒç”¨ NSInvocation è¿›è¡Œé€šä¿¡</span><br>        <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> safePerformAction:action target:target params:params];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// è¿™é‡Œæ˜¯å¤„ç†æ— å“åº”è¯·æ±‚çš„åœ°æ–¹ï¼Œå¦‚æœæ— å“åº”ï¼Œåˆ™å°è¯•è°ƒç”¨å¯¹åº”targetçš„notFoundæ–¹æ³•ç»Ÿä¸€å¤„ç†</span><br>        SEL action = <span class="hljs-built_in">NSSelectorFromString</span>(<span class="hljs-string">@&quot;notFound:&quot;</span>);<br>        <span class="hljs-keyword">if</span> ([target respondsToSelector:action]) &#123;<br>            <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> safePerformAction:action target:target params:params];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">/* è¿™é‡Œä¹Ÿæ˜¯å¤„ç†æ— å“åº”è¯·æ±‚çš„åœ°æ–¹ï¼Œåœ¨notFoundéƒ½æ²¡æœ‰çš„æ—¶å€™ï¼Œè¿™ä¸ªdemoæ˜¯ç›´æ¥returnäº†ã€‚</span><br><span class="hljs-comment">            å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç”¨å‰é¢æåˆ°çš„å›ºå®šçš„targeté¡¶ä¸Šçš„ã€‚</span><br><span class="hljs-comment">             */</span><br>            [<span class="hljs-keyword">self</span> NoTargetActionResponseWithTargetString:targetClassString<br>                                          selectorString:actionString<br>                                            originParams:params];<br>            [<span class="hljs-keyword">self</span>.cachedTarget removeObjectForKey:targetClassString];<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br>- (<span class="hljs-type">id</span>)safePerformAction:(SEL)action<br>                 target:(<span class="hljs-built_in">NSObject</span> *)target<br>                 params:(<span class="hljs-built_in">NSDictionary</span> *)params<br>&#123;<br>    <span class="hljs-built_in">NSMethodSignature</span>* methodSig = [target methodSignatureForSelector:action];<br>    <span class="hljs-keyword">const</span> <span class="hljs-type">char</span>* retType = [methodSig methodReturnType];<br>    <br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">// ME: å¯¹ç›®æ ‡ç»„ä»¶è¿”å›å€¼ä¸ºéå¯¹è±¡ç±»å‹çš„æƒ…å†µè¿›è¡Œç‰¹æ®Šå¤„ç†</span><br><br>    <span class="hljs-keyword">if</span> (strcmp(retType, <span class="hljs-keyword">@encode</span>(<span class="hljs-built_in">NSUInteger</span>)) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">NSInvocation</span> *invocation = [<span class="hljs-built_in">NSInvocation</span> invocationWithMethodSignature:methodSig];<br>        [invocation setArgument:&amp;params atIndex:<span class="hljs-number">2</span>];<br>        [invocation setSelector:action];<br>        [invocation setTarget:target];<br>        [invocation invoke];<br>        <span class="hljs-built_in">NSUInteger</span> result = <span class="hljs-number">0</span>;<br>        [invocation getReturnValue:&amp;result];<br>        <span class="hljs-keyword">return</span> @(result);<br>    &#125;<br><br>    <span class="hljs-comment">// ME: è¿”å›å€¼æ˜¯å¯¹è±¡ç±»å‹åˆ™ç›´æ¥èµ°æ­¤æ–¹æ³•</span><br>    <span class="hljs-keyword">return</span> [target performSelector:action withObject:params];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>psï¼šåº“çš„ä½œè€…æä¾›äº†è¯¦ç»†çš„æ³¨é‡Šï¼Œ<code>// ME:</code>æ ‡æ³¨çš„æ³¨é‡Šæ˜¯æˆ‘æ·»åŠ ï¼Œç”¨æ¥è¯´æ˜å…¶ä¸­çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><h4 id="4-2-æœ¬åœ°è°ƒç”¨"><a href="#4-2-æœ¬åœ°è°ƒç”¨" class="headerlink" title="4.2.æœ¬åœ°è°ƒç”¨"></a>4.2.æœ¬åœ°è°ƒç”¨</h4><p>CTMediatorä¸»è¦å®ç°äº†æœ¬åœ°è°ƒç”¨åŠŸèƒ½ï¼Œå³åº“ä¸­çš„â€œperformTarget:action:params:shouldCacheTarget:â€æ¥å£ã€‚<br><br/></p><p>æ‰€è°“æœ¬åœ°è°ƒç”¨ï¼Œå°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨å†…éƒ¨ç»„ä»¶ä¹‹é—´çš„æœåŠ¡è°ƒç”¨ï¼Œæ¯”å¦‚ä¸»é¡µç»„ä»¶è°ƒç”¨è¯¦æƒ…ç»„ä»¶çš„è·³è½¬æœåŠ¡ï¼Œç»„ä»¶é—´ä¸»è¦æ˜¯é€šè¿‡<code>performSelector</code>çš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œå¯¹äºè¿”å›å€¼ä¸ºéå¯¹è±¡ç±»å‹çš„æƒ…å†µåˆ™ä½¿ç”¨<code>NSInvocation</code>è¿›è¡Œé€šä¿¡ã€‚<br><br/></p><p><code>[target performSelector:action withObject:params]</code>éœ€è¦ä¸‰ä¸ªä¸»è¦å‚æ•°ï¼š</p><ul><li>å½“å‰å¯¹è±¡</li></ul><p>å³ç¤ºä¾‹ä¸­çš„<code>target</code>ï¼Œåœ¨ç»„ä»¶åŒ–å®è·µä¸­åˆ™å¯¹åº”ç€ç›®æ ‡ç»„ä»¶æœåŠ¡ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚å®ƒæ˜¯é€šè¿‡<code>NSClassFromString(@â€œtargetClassStringâ€)</code>æ¥å£å°†å­—ç¬¦ä¸²ç±»å‹çš„ç±»ååå°„æˆçœŸå®çš„ç±»ï¼Œå†è°ƒç”¨å®ä¾‹åŒ–æ–¹æ³•åˆ›å»ºå®ä¾‹ã€‚</p><ul><li>SEL</li></ul><p>å³ç¤ºä¾‹ä¸­çš„<code>action</code>ï¼Œå¯¹åº”çš„æ˜¯ç›®æ ‡ç»„ä»¶æœåŠ¡ç±»å¯¹å¤–æš´éœ²çš„æœåŠ¡æ¥å£ã€‚å®ƒæ˜¯é€šè¿‡<code>NSSelectorFromString(actionString)</code>æ¥å£å°†å­—ç¬¦ä¸²ç±»å‹çš„æ¥å£ååå°„æˆSELï¼Œä¾›è¿è¡Œæ—¶è°ƒç”¨ã€‚</p><ul><li>æ–¹æ³•å‚æ•°</li></ul><p>å³ç¤ºä¾‹ä¸­çš„<code>params</code>ï¼Œå¯¹åº”çš„æ˜¯ç›®æ ‡ç»„ä»¶æœåŠ¡ç±»æ¥å£ä¸­çš„å‚æ•°ã€‚ç”±äº<code>performSelector</code>èƒ½ä¼ é€’çš„å‚æ•°æœ‰é™ï¼Œæ‰€ä»¥æ­¤åº“è¦æ±‚å¤–éƒ¨è°ƒç”¨è€…å°†å¤šä¸ªå‚æ•°åŒ…è£…åœ¨ä¸€ä¸ªå­—å…¸å®¹å™¨ä¸­ï¼Œå†ç”±åº“å†…éƒ¨å°†æ­¤å‚æ•°ä¼ é€’ç»™SELã€‚</p><h4 id="4-3-è¿œç¨‹è°ƒç”¨"><a href="#4-3-è¿œç¨‹è°ƒç”¨" class="headerlink" title="4.3.è¿œç¨‹è°ƒç”¨"></a>4.3.è¿œç¨‹è°ƒç”¨</h4><p>CTMediatorè¿˜æä¾›äº†è¿œç¨‹è°ƒç”¨æ¥å£ï¼Œå³åº“ä¸­æä¾›çš„â€œ-performActionWithUrl:completion:â€æ¥å£ã€‚<br><br/></p><p>æ‰€è°“è¿œç¨‹è°ƒç”¨ï¼Œå°±æ˜¯åˆ«çš„åº”ç”¨å‘æˆ‘ä»¬çš„åº”ç”¨å‘èµ·çš„æœåŠ¡è°ƒç”¨ï¼Œå¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>Aåº”ç”¨é€šè¿‡<code>[[UIApplication sharedApplication] openURL:xxx]</code>ä¼ é€’ä¸€ä¸ªæŒ‡å®šæ ¼å¼çš„URLåˆ°Båº”ç”¨ï¼›</li><li>Båº”ç”¨åœ¨<code>-application:openURL:</code>å›è°ƒä¸­æ¥æ”¶URLï¼Œéšåè°ƒç”¨<code>performActionWithUrl</code>å¼€å§‹å¤„ç†æ­¤URLï¼›</li><li><code>performActionWithUrl</code>ä¸­å¯¹URLä¸­çš„å‚æ•°è¿›è¡Œè§£æä¹‹åï¼Œå†é€šè¿‡<code>performTarget</code>è°ƒç”¨æœ¬åœ°ç»„ä»¶æä¾›æœåŠ¡ã€‚</li></ul><p>è¿œç¨‹è°ƒç”¨æ—¶ä¼ é€’çš„URLä¸€å®šè¦æŒ‰ç…§çº¦å®šçš„æ ¼å¼æ‹¼æ¥ï¼Œå¼€å‘è€…åº”æŒ‰ç…§è‡ªå·±çš„è§„èŒƒè‡ªå®šä¹‰åº“æ–‡ä»¶ä¸­è¿œç¨‹è°ƒç”¨çš„ç›¸å…³é€»è¾‘ï¼›<br><br/></p><p>åŸºäºURLçš„è¿œç¨‹è°ƒç”¨æœ‰ä¸ªç¼ºç‚¹ï¼Œå³URLä¸­å‚æ•°çš„ç±»å‹å°†ä¼šå—åˆ°é™åˆ¶ï¼Œå¦‚ä¼ é€’å›¾ç‰‡ã€æ•°æ®ã€blockç­‰ç±»å‹æ—¶å°†å¾ˆä¸æ–¹ä¾¿ã€‚</p><h3 id="5-å®ä¾‹"><a href="#5-å®ä¾‹" class="headerlink" title="5.å®ä¾‹"></a>5.å®ä¾‹</h3><p>ç€æ‰‹å®ç°ç« èŠ‚å¼€å§‹æ—¶æå‡ºçš„åœºæ™¯éœ€æ±‚ï¼šä»<code>ä¸»é¡µ</code>ç»„ä»¶è·³è½¬åˆ°<code>è¯¦æƒ…</code>ç»„ä»¶ï¼›è¿”å›æ—¶æ›´æ–°ä¸»é¡µç»„ä»¶çš„æ ‡é¢˜ã€‚</p><h4 id="5-1-ç›®æ ‡ç»„ä»¶"><a href="#5-1-ç›®æ ‡ç»„ä»¶" class="headerlink" title="5.1.ç›®æ ‡ç»„ä»¶"></a>5.1.ç›®æ ‡ç»„ä»¶</h4><p><code>è¯¦æƒ…</code>ç»„ä»¶è§†å›¾æ§åˆ¶å™¨ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DetailViewController</span> : <span class="hljs-title">UIViewController</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSDictionary</span> *params;  <span class="hljs-comment">// æ¥æ”¶å¤–éƒ¨ç»„ä»¶ä¼ è¿›æ¥çš„å‚æ•°</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailViewController.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DetailViewController</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UIImageView</span> *mIconImv;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">UIImage</span> *image;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) DetailCallback callBack; <span class="hljs-comment">// å›è°ƒblock</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DetailViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    <br>    <span class="hljs-comment">// è·å–å‚æ•°</span><br>    <span class="hljs-keyword">self</span>.mIconImv.image = <span class="hljs-keyword">self</span>.params[k_Key_Image];<br>    <span class="hljs-keyword">self</span>.callBack = <span class="hljs-keyword">self</span>.params[k_Key_Block];<br>    <br>    <span class="hljs-built_in">UIButton</span> *btn = [<span class="hljs-built_in">UIButton</span> buttonWithType:<span class="hljs-built_in">UIButtonTypeCustom</span>];<br>    [btn setTitle:<span class="hljs-string">@&quot;è¿”å›&quot;</span> forState:<span class="hljs-built_in">UIControlStateNormal</span>];<br>    [btn addTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(onBackWithBlock) forControlEvents:<span class="hljs-built_in">UIControlEventTouchUpInside</span>];<br>    <span class="hljs-keyword">self</span>.navigationItem.leftBarButtonItem = [[<span class="hljs-built_in">UIBarButtonItem</span> alloc] initWithCustomView:btn];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onBackWithBlock&#123;<br>    <span class="hljs-keyword">self</span>.callBack(); <span class="hljs-comment">//å›ä¼ ä¿¡æ¯</span><br>    [<span class="hljs-keyword">self</span>.navigationController popViewControllerAnimated:<span class="hljs-literal">YES</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯è¯¦æƒ…æ‰€åœ¨çš„è§†å›¾æ§åˆ¶å™¨ï¼Œå…¶ä¸­å®šä¹‰äº†ç”¨äºæ¥æ”¶å¤–éƒ¨å›¾ç‰‡çš„å±æ€§<code>image</code>å’Œå¤„ç†å›è°ƒçš„<code>callBack</code>é—­åŒ…ã€‚è§†å›¾åŠ è½½æ—¶æ˜¾ç¤ºå¤–éƒ¨ä¼ è¿›æ¥çš„å›¾ç‰‡ï¼›é€€å‡ºè¯¦æƒ…é¡µæ—¶å›è°ƒ<code>callBack</code>é—­åŒ…ä»¥é€šçŸ¥ä¸Šå±‚è°ƒç”¨è€…å¤„ç†è‡ªå·±çš„ä¸šåŠ¡ã€‚</p><h4 id="5-2-æš´éœ²æ¥å£"><a href="#5-2-æš´éœ²æ¥å£" class="headerlink" title="5.2.æš´éœ²æ¥å£"></a>5.2.æš´éœ²æ¥å£</h4><p>è¯¦æƒ…ç»„ä»¶<code>å¯¹å¤–æä¾›æœåŠ¡çš„ç±»</code>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Target_DetailViewController</span> : <span class="hljs-title">NSObject</span></span><br>- (<span class="hljs-built_in">UIViewController</span>*)Action_showDetail:(<span class="hljs-built_in">NSDictionary</span>*)paramDic;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Target_DetailViewController.h&quot;</span></span><br><span class="hljs-comment">// å¯¼å…¥è¯¦æƒ…åŸç±»</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DetailViewController.h&quot;</span> <span class="hljs-comment">// æœåŠ¡ç±»å¯ä¾èµ–ç»„ä»¶åŸç±»</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Target_DetailViewController</span></span><br><br>- (<span class="hljs-built_in">UIViewController</span> *)Action_showDetail:(<span class="hljs-built_in">NSDictionary</span> *)paramDic&#123;<br><br>    <span class="hljs-comment">// å½“å‰ä¸ºä¸šåŠ¡å®ç°å±‚ å±äºç»„ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥å¼•ç”¨ç›®æ ‡VC</span><br>    DetailViewController *controller = [[<span class="hljs-built_in">UIStoryboard</span> storyboardWithName:<span class="hljs-string">@&quot;Main&quot;</span> bundle:<span class="hljs-literal">nil</span>]<br>                                          instantiateViewControllerWithIdentifier:<span class="hljs-string">@&quot;DaDetailViewController&quot;</span>];<br>    <span class="hljs-comment">// ç»™ç›®æ ‡ä¼ å€¼</span><br>    controller.params = paramDic;<br>    <br>    <span class="hljs-keyword">return</span> controller;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ä¸€äº›ç»†èŠ‚ï¼š</p><ul><li>è¯¦æƒ…ç»„ä»¶å¯¹å¤–æä¾›çš„æ‰€æœ‰æœåŠ¡ï¼Œéƒ½åœ¨è¿™é‡Œå®šä¹‰å’Œå®ç°ï¼›</li><li>åœ¨æ­¤æœåŠ¡ç±»çš„å¤´æ–‡ä»¶ä¸­å°†æœåŠ¡æ¥å£æš´éœ²ç»™å¤–ç•Œï¼›</li><li>æ­¤ç±»æ˜¯è¯¦æƒ…ç»„ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥å¯¼å…¥å’Œä¾èµ–è¯¦æƒ…åŸç±»ï¼›</li><li>æ³¨æ„ä¸Šé¢çš„å‘½åæ–¹å¼ï¼Œç±»åå‰ç¼€ä¸º<code>Target_</code>ï¼Œè€Œæ–¹æ³•åå‰ç¼€ä¸º<code>Action_</code>ï¼›</li></ul><p>å…³äºæœ€åä¸€æ¡ï¼Œè¿™æ˜¯å› ä¸ºæ¥ä¸‹æ¥ä½¿ç”¨åˆ°çš„é€šä¿¡ç±»ä¸‰æ–¹åº“<code>CTMediator</code>ä¸­åšäº†ç‰¹æ®Šå¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŒ‰ç…§é€šä¿¡å±‚çš„è¦æ±‚è¿›è¡Œå‘½åï¼Œå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‰ç…§è‡ªå·±çš„è§„èŒƒåœ¨åŸåº“ä¸­å°†<code>Target_</code>å’Œ<code>Action_</code>ä¿®æ”¹ä¸ºä½ è‡ªå·±å–œæ¬¢çš„å‰ç¼€ã€‚</p><h4 id="5-3-é€šä¿¡ç±»"><a href="#5-3-é€šä¿¡ç±»" class="headerlink" title="5.3.é€šä¿¡ç±»"></a>5.3.é€šä¿¡ç±»</h4><p><code>ä¸­é—´é€šä¿¡å±‚</code>ï¼Œè¿™æ˜¯ä¸‰æ–¹åº“<code>CTMediator</code>çš„ä¸€ä¸ªåˆ†ç±»ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CTMediator.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">CTMediator</span> (<span class="hljs-title">Detail</span>)</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> è¯¦æƒ…ä¸­é—´é€šä¿¡ç±»å¯¹å¤–æä¾›çš„æ¥å£</span><br><span class="hljs-comment"> @param paramDic å‚æ•°</span><br><span class="hljs-comment"> @return è¿”å›å€¼</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">UIViewController</span>*)<span class="hljs-built_in">CTDetail</span>:(<span class="hljs-built_in">NSDictionary</span>*)paramDic;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;CTMediator+Detail.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CTMediator</span> (<span class="hljs-title">Detail</span>)</span><br><br>- (<span class="hljs-built_in">UIViewController</span> *)<span class="hljs-built_in">CTDetail</span>:(<span class="hljs-built_in">NSDictionary</span> *)paramDic&#123;<br>    <br>    <span class="hljs-comment">/* è°ƒç”¨CTMediatoråº“çš„â€œperformTargetâ€æ–¹æ³•;</span><br><span class="hljs-comment">    ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œç»“åˆåå°„æœºåˆ¶ï¼Œä»è€Œé¿å…ç›´æ¥å¼•ç”¨ç›®æ ‡ç±»ï¼Œå‡å°‘ä¾èµ–</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> performTarget:<span class="hljs-string">@&quot;DetailViewController&quot;</span><br>                        action:<span class="hljs-string">@&quot;showDetail&quot;</span><br>                        params:paramDic<br>             shouldCacheTarget:<span class="hljs-literal">NO</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p><code>-CTDetail:</code>å³æ˜¯è¯¦æƒ…ä¸­é—´é€šä¿¡ç±»å¯¹å¤–æš´éœ²çš„ä¸€ä¸ªæ¥å£ï¼Œå…¶ä»–ç»„ä»¶æƒ³è°ƒç”¨è¯¦æƒ…ç»„ä»¶çš„æœåŠ¡æ—¶ä»è¿™é‡Œæ‰¾å³å¯~<br><br/></p><p>å•ç‹¬æä¾›è¿™ä¹ˆä¸€å±‚ï¼Œè€Œéåœ¨è°ƒç”¨è¯¦æƒ…ç»„ä»¶æœåŠ¡çš„åœ°æ–¹ç›´æ¥æ‰§è¡Œ<code>perform</code>æ–¹æ³•ï¼Œä¸»è¦æ˜¯å› ä¸ºè¿™é‡Œçš„ç±»åå’Œæ–¹æ³•åéƒ½æ˜¯æ˜æ–‡ï¼Œåœ¨æ²¡æœ‰ä»£ç è¡¥å…¨åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œè®©åˆ«çš„ç»„ä»¶çš„å¼€å‘è€…æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è‡ªå·±å†™ä¸€éææœ‰å¯èƒ½ä¼šå‡ºé”™ï¼Œä¹Ÿå¾ˆä¸æ–¹ä¾¿ã€‚è¿™ä¸€å±‚å¯¹è¿™äº›æ“ä½œè¿›è¡Œäº†å°è£…ï¼Œè¿™æ ·å¤–éƒ¨è°ƒç”¨è€…å°±ä¸ç”¨å†ä¸ºæ­¤æŒ å¤´ã€‚<br><br/></p><p>å¦å¤–éœ€è¦æ³¨æ„ï¼šè¿™é‡Œçš„æ˜æ–‡ç±»åå’Œæ–¹æ³•åå¹¶æ²¡å¸¦ä¸Šä¸€å°èŠ‚æåˆ°çš„å‰ç¼€ï¼Œè¿™äº›æ˜¯åœ¨ä¸‰æ–¹åº“<code>CTMediator</code>ä¸­è‡ªåŠ¨è¿½åŠ çš„ã€‚</p><h4 id="5-4-è°ƒç”¨æœåŠ¡"><a href="#5-4-è°ƒç”¨æœåŠ¡" class="headerlink" title="5.4.è°ƒç”¨æœåŠ¡"></a>5.4.è°ƒç”¨æœåŠ¡</h4><p>åœ¨ä¸»é¡µç»„ä»¶ä¸­<code>è°ƒç”¨</code>è¯¦æƒ…ç»„ä»¶çš„æœåŠ¡ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CTMediator+Detail.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">HomeViewController</span></span><br><br>- (<span class="hljs-keyword">IBAction</span>)onShowDetail:(<span class="hljs-type">id</span>)sender &#123;<br>    <span class="hljs-built_in">UIButton</span> *btn = sender;<br>    <br>    <span class="hljs-comment">// å£°æ˜å›è°ƒ ä»è¯¦æƒ…é¡µé¢è¿”å›å½“å‰é¡µé¢æ—¶æ›´æ–°æ ‡é¢˜</span><br>    DetailCallback block = ^()&#123;<br>        <span class="hljs-keyword">self</span>.title = <span class="hljs-string">@&quot;Info Checked&quot;</span>;<br>    &#125;;<br>    <br>    <span class="hljs-comment">// é€šè¿‡ä¸­é—´å±‚è°ƒç”¨åˆ«çš„ç»„ä»¶ï¼Œä¼ é€’å‚æ•°</span><br>    <span class="hljs-built_in">NSDictionary</span> *params = @&#123;k_Key_Image : btn.currentBackgroundImage, k_Key_Block : block&#125;;<br>    <span class="hljs-built_in">UIViewController</span> *controller = [[<span class="hljs-built_in">CTMediator</span> sharedInstance] <span class="hljs-built_in">CTDetail</span>:params];<br>    <span class="hljs-keyword">if</span> (controller) &#123;<br>        [<span class="hljs-keyword">self</span>.navigationController pushViewController:controller animated:<span class="hljs-literal">YES</span>];<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨æœ¬æ¬¡è°ƒç”¨ä¸­ï¼Œä¸»é¡µç»„ä»¶ä¸­å¹¶æœªç›´æ¥å¼•ç”¨è¯¦æƒ…ç»„ä»¶çš„å¤´æ–‡ä»¶ï¼Œåªæ˜¯å¼•ç”¨äº†è¯¦æƒ…ç»„ä»¶çš„ä¸­é—´é€šä¿¡å±‚<code>CTMediator+Detail.h</code>ã€‚ä¸»é¡µç»„ä»¶æœ€ç»ˆé€šè¿‡è¯¦æƒ…ä¸­é—´é€šä¿¡å±‚æä¾›çš„æ¥å£å®ç°äº†å¯¹è¯¦æƒ…ç»„ä»¶çš„é€šä¿¡æˆ–è€…è¯´æœåŠ¡çš„è°ƒç”¨ã€‚</p><h3 id="6-ç›®å½•ç»“æ„"><a href="#6-ç›®å½•ç»“æ„" class="headerlink" title="6.ç›®å½•ç»“æ„"></a>6.ç›®å½•ç»“æ„</h3><p>æ•´ä¸ªå·¥ç¨‹çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs stylus">.<br>â”œâ”€â”€ AppDelegate<span class="hljs-selector-class">.h</span><br>â”œâ”€â”€ AppDelegate<span class="hljs-selector-class">.m</span><br>â”œâ”€â”€ Assets<span class="hljs-selector-class">.xcassets</span><br>â”‚Â Â  â”œâ”€â”€ AppIcon<span class="hljs-selector-class">.appiconset</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Contents<span class="hljs-selector-class">.json</span><br>â”‚Â Â  â””â”€â”€ Contents<span class="hljs-selector-class">.json</span><br>â”œâ”€â”€ Base<span class="hljs-selector-class">.lproj</span><br>â”‚Â Â  â”œâ”€â”€ LaunchScreen<span class="hljs-selector-class">.storyboard</span><br>â”‚Â Â  â””â”€â”€ Main<span class="hljs-selector-class">.storyboard</span><br>â”œâ”€â”€ Defines<span class="hljs-selector-class">.h</span><br>â”œâ”€â”€ Detail<br>â”‚Â Â  â”œâ”€â”€ Controllers<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DetailViewController<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ DetailViewController<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”œâ”€â”€ Mediator<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ CTMediator+Detail<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ CTMediator+Detail<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â””â”€â”€ Module+API<br>â”‚Â Â      â”œâ”€â”€ Target_DetailViewController<span class="hljs-selector-class">.h</span><br>â”‚Â Â      â””â”€â”€ Target_DetailViewController<span class="hljs-selector-class">.m</span><br>â”œâ”€â”€ Home<br>â”‚Â Â  â”œâ”€â”€ HomeViewController<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â””â”€â”€ HomeViewController<span class="hljs-selector-class">.m</span><br>â”œâ”€â”€ Icons<br>â”‚Â Â  â”œâ”€â”€ <span class="hljs-number">1</span>@<span class="hljs-number">2</span>x<span class="hljs-selector-class">.png</span><br>â”‚Â Â  â””â”€â”€ <span class="hljs-number">1</span>@<span class="hljs-number">3</span>x<span class="hljs-selector-class">.png</span><br>â”œâ”€â”€ Info<span class="hljs-selector-class">.plist</span><br>â””â”€â”€ <span class="hljs-selector-tag">main</span>.m<br></code></pre></td></tr></table></figure><h3 id="7-æµç¨‹æ€»ç»“"><a href="#7-æµç¨‹æ€»ç»“" class="headerlink" title="7.æµç¨‹æ€»ç»“"></a>7.æµç¨‹æ€»ç»“</h3><ul><li>å®šä¹‰ç›®æ ‡ç»„ä»¶ï¼›</li><li>å®šä¹‰ç›®æ ‡ç»„ä»¶çš„å¯¹å¤–æœåŠ¡ç±»å’Œæ¥å£ï¼›</li><li>å®šä¹‰ç›®æ ‡ç»„ä»¶çš„ä¸­é—´é€šä¿¡å±‚ï¼›</li><li>å‘èµ·è€…ä¸ç›®æ ‡ç»„ä»¶çš„ä¸­é—´é€šä¿¡å±‚äº¤äº’ï¼Œè°ƒç”¨ç›®æ ‡ç»„ä»¶çš„æ¥å£ï¼›</li><li>ä¸­é—´é€šä¿¡å±‚è°ƒç”¨CTMediatorï¼Œé€šè¿‡è¿è¡Œæ—¶æ¥å£å®ç°é€šä¿¡ï¼›<br><img src="https://davidlii.nos-eastchina1.126.net/pic_module_runtime.jpg" alt="ç»„ä»¶åŒ–-åå°„æ–¹æ¡ˆ"></li></ul><h3 id="8-æ–¹æ¡ˆè¯„ä»·"><a href="#8-æ–¹æ¡ˆè¯„ä»·" class="headerlink" title="8.æ–¹æ¡ˆè¯„ä»·"></a>8.æ–¹æ¡ˆè¯„ä»·</h3><p>ä¼˜ç‚¹ï¼š</p><ul><li>å·§å¦™çš„åˆ©ç”¨äº†è¿è¡Œæ—¶æ¥å£ï¼Œé€šè¿‡åå°„æœºåˆ¶å®Œæˆç»„ä»¶é—´çš„é€šä¿¡å’Œè§£è€¦ï¼›</li><li>ç»„ä»¶ä¹‹é—´ä¸å†å¼•ç”¨å¯¹æ–¹å¤´æ–‡ä»¶ï¼Œè€Œæ˜¯é€šè¿‡ä¸­é—´é€šä¿¡å±‚è¿›è¡Œé€šä¿¡ï¼›</li><li>è°ƒç”¨æ–¹ç»„ä»¶åªå¯¼å…¥æˆ–è€…è¯´ä¾èµ–äº†åƒCTMediator+Detailåˆ†ç±»è¿™æ ·çš„ä¸­é—´é€šä¿¡å±‚ï¼Œä¸”è¿™ç§ä¾èµ–å…³ç³»åªæ˜¯å•å‘çš„ï¼›</li><li>ä»æ•´ä½“æ¥çœ‹ï¼Œå„å¤§ç»„ä»¶ä¹‹é—´æ²¡æœ‰è€¦åˆï¼Œéƒ½åªä»¥ä¸­é—´å±‚ä¸ºä¸­å¿ƒä¸å…¶ä»–ç»„ä»¶è¿›è¡Œé€šä¿¡ï¼Œè¿™ç§æ€æƒ³å€¼å¾—è‚¯å®šã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ä¸­é—´é€šä¿¡å±‚ä¸­éœ€è¦æ˜æ–‡ä¹¦å†™ç±»åå’Œæ–¹æ³•åï¼Œè¿™ç§ç¡¬ç¼–ç æ²¡æœ‰ä»£ç è¡¥å…¨çš„è¾…åŠ©ï¼Œæå¯èƒ½å‡ºé”™ä¸”ç¼–è¯‘æ—¶ä¸æ˜“å¯Ÿè§‰ï¼›</li><li>å½“è°ƒç”¨çš„æœåŠ¡æ¥å£ä¸­éœ€è¦ä¼ é€’å®ä½“ç±»ä½œä¸ºå‚æ•°æ—¶ï¼Œè¿˜éœ€å¯¼å…¥å¯¹æ–¹ç»„ä»¶ä¸­å®ä½“ç±»çš„å¤´æ–‡ä»¶ï¼Œè¿˜æ˜¯æœ‰ä¾èµ–ï¼›</li><li>å—åå°„æœºåˆ¶çš„é™åˆ¶ï¼Œæœ¬åœ°è°ƒç”¨æ—¶é€šä¿¡å±‚ä¸­æ¥æ”¶çš„å‚æ•°ä¸ªæ•°æœ‰é™ï¼Œæ‰€ä»¥åªèƒ½ä»¥å­—å…¸ç­‰å®¹å™¨çš„æ–¹å¼ä¼ å€¼ï¼Œä¸å¤Ÿçµæ´»æ–¹ä¾¿ï¼›</li><li>è¿œç¨‹è°ƒç”¨æ—¶ï¼ŒURLä¸­å‚æ•°çš„ç±»å‹ä¹Ÿä¼šå—åˆ°é™åˆ¶ï¼Œåªé€‚åˆç”¨æ¥è¿›è¡Œåº”ç”¨å†…éƒ¨é¡µé¢è·³è½¬æˆ–åˆ«çš„Appè°ƒèµ·æˆ‘ä»¬æœ¬åœ°çš„é¡µé¢ï¼›</li></ul><h3 id="9-ç»“å°¾"><a href="#9-ç»“å°¾" class="headerlink" title="9.ç»“å°¾"></a>9.ç»“å°¾</h3><p>æ•´ä½“æ¥çœ‹ï¼ŒåŸºäºåå°„åŸç†çš„ç»„ä»¶åŒ–è§£å†³æ–¹æ¡ˆè¿˜æ˜¯ä¸å¤Ÿå®Œç¾ï¼Œåç»­ä¼šç»§ç»­ä»‹ç»é¢å‘åè®®çš„æœåŠ¡æ³¨å†Œç»„ä»¶åŒ–æ–¹æ¡ˆï¼Œå¾…ç»­~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/davidli-/DaModules-Hardcore">Â©åå°„æ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/davidli-/HelModules-URL">Â©URL+Blockæ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/davidli-/DaModule-Protocol">Â©æœåŠ¡åè®®æ³¨å†Œæ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/youzan/Bifrost">Â©æœ‰èµBifrost</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¶æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç»„ä»¶åŒ–-URLè·¯ç”±æ–¹æ¡ˆ</title>
    <link href="/2020/09/03/modules-url.html"/>
    <url>/2020/09/03/modules-url.html</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€ç»„ä»¶åŒ–"><a href="#ä¸€ã€ç»„ä»¶åŒ–" class="headerlink" title="ä¸€ã€ç»„ä»¶åŒ–"></a>ä¸€ã€ç»„ä»¶åŒ–</h3><h4 id="1-ç›®çš„"><a href="#1-ç›®çš„" class="headerlink" title="1.ç›®çš„"></a>1.ç›®çš„</h4><p>ä¸ºäº†è§£è€¦ï¼šæŠŠå¤æ‚ç³»ç»Ÿæ‹†åˆ†æˆå¤šä¸ªç»„ä»¶ï¼Œåˆ†ç¦»ç»„ä»¶è¾¹ç•Œå’Œè´£ä»»ï¼Œä¾¿äºç‹¬ç«‹å‡çº§å’Œç»´æŠ¤ã€‚</p><h4 id="2-å¥½å¤„"><a href="#2-å¥½å¤„" class="headerlink" title="2.å¥½å¤„"></a>2.å¥½å¤„</h4><ul><li>æ˜ç¡®ç»„ä»¶èŒè´£</li></ul><p>æŒ‰åˆç†çš„ç²’åº¦å°†ç³»ç»Ÿæ‹†åˆ†æˆå¤šä¸ªç»„ä»¶ï¼Œç¡®ä¿ç»„ä»¶å„å¸å…¶èŒï¼Œä»¥ä¾¿äºå¤ç”¨ã€‚</p><ul><li>å‡å°‘ç»„ä»¶é—´çš„ä¾èµ–</li></ul><p><code>é€šä¿¡å±‚</code>å®ç°äº†ç»„ä»¶é—´çš„é€šä¿¡ï¼Œè€Œä¸ç”¨åœ¨ç»„ä»¶é—´è·³è½¬ã€è°ƒç”¨æœåŠ¡æ—¶å¼•ç”¨å…¶ä»–ç»„ä»¶çš„æ–‡ä»¶ã€‚</p><ul><li>æå‡å¼€å‘&#x2F;ç¼–è¯‘&#x2F;æµ‹è¯•æ•ˆç‡</li></ul><p>å¼€å‘äººå‘˜åªé¡»å…³æ³¨è‡ªå·±çš„ç»„ä»¶ï¼Œä¸å†éœ€è¦å¯¼å…¥æˆ–ç¼–è¯‘å…¶ä»–ç»„ä»¶ï¼Œä»è€Œæå‡å¼€å‘å’Œç¼–è¯‘é€Ÿåº¦ã€‚</p><h4 id="3-æ–¹æ¡ˆ"><a href="#3-æ–¹æ¡ˆ" class="headerlink" title="3.æ–¹æ¡ˆ"></a>3.æ–¹æ¡ˆ</h4><p>ç›®å‰ iOS ç»„ä»¶åŒ–çš„å®è·µä¸­ï¼Œæ¯”è¾ƒæµè¡Œçš„è§£å†³æ–¹æ¡ˆå¯å½’çº³ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š<br><br/></p><p>1.åŸºäº<code>URL</code>+<code>Block</code>çš„è·¯ç”±æ–¹æ¡ˆï¼›<br><br/></p><p>2.åŸºäº<code>åå°„</code>åŸç†çš„æ–¹æ¡ˆï¼›<br><br/></p><p>3.é¢å‘<code>åè®®</code>çš„æœåŠ¡æ³¨å†Œæ–¹æ¡ˆï¼›</p><blockquote><p>â€œæ²¡æœ‰æœ€ä¼˜çš„æ–¹æ¡ˆï¼Œåªæœ‰æ›´é€‚åˆè‡ªå·±çš„æ–¹æ¡ˆâ€ã€‚</p></blockquote><p>ä¸‰ç§æ–¹æ¡ˆå„æœ‰ä¼˜ç¼ºç‚¹ã€‚ä½ å¯åªé€‰å…¶ä¸€ï¼Œä¹Ÿå¯å°†å®ƒä»¬ç»„åˆèµ·æ¥ä½¿ç”¨ã€‚å‰ææ˜¯ä½ è¦ç†è§£æ‰€é€‰æ–¹æ¡ˆçš„ç‰¹ç‚¹ï¼ŒåŒæ—¶ç»“åˆé¡¹ç›®çš„å®é™…éœ€æ±‚è¿›è¡Œå–èˆã€‚<br><br/></p><p>æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ï¼Œå°†é™†ç»­å¯¹è¿™ä¸‰ç§æ–¹æ¡ˆè¿›è¡Œåˆ†æå’Œæ¢³ç†~</p><h3 id="äºŒã€URLè·¯ç”±æ–¹æ¡ˆ"><a href="#äºŒã€URLè·¯ç”±æ–¹æ¡ˆ" class="headerlink" title="äºŒã€URLè·¯ç”±æ–¹æ¡ˆ"></a>äºŒã€URLè·¯ç”±æ–¹æ¡ˆ</h3><h4 id="1-åœºæ™¯"><a href="#1-åœºæ™¯" class="headerlink" title="1.åœºæ™¯"></a>1.åœºæ™¯</h4><p>ä»<code>ä¸»é¡µ</code>è·³è½¬åˆ°<code>è¯¦æƒ…</code>ï¼Œä¼ å…¥è¯¦æƒ…é¡µæ‰€éœ€çš„å¤´åƒï¼›<br><br/></p><p>åœ¨è¯¦æƒ…ä¸­ç®€å•çš„ä¿®æ”¹ä¿¡æ¯ä¹‹åï¼Œè¿”å›ä¸»é¡µæ—¶æ›´æ–°ä¸»é¡µçš„æ ‡é¢˜ã€‚</p><h4 id="2-æ€è·¯"><a href="#2-æ€è·¯" class="headerlink" title="2.æ€è·¯"></a>2.æ€è·¯</h4><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç»„ä»¶é—´é¡µé¢è·³è½¬æœåŠ¡ï¼Œåœ¨ç»„ä»¶åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬æœ€å¸¸è§çš„å¤„ç†å¯èƒ½æ˜¯ï¼š</p><ul><li>åœ¨ä¸»é¡µä¸­å¼•ç”¨è¯¦æƒ…çš„<code>.h</code>å¤´æ–‡ä»¶ï¼›</li><li>åˆ›å»ºè¯¦æƒ…çš„<code>å®ä¾‹</code>ï¼›</li><li>é€šè¿‡è¯¦æƒ…æä¾›çš„æ¥å£ä¼ å…¥å›¾ç‰‡ï¼›</li><li>å°†ä¸»é¡µè®¾ç½®ä¸ºè¯¦æƒ…çš„ä»£ç†ï¼›</li><li><code>push</code>åˆ°è¯¦æƒ…é¡µã€‚</li></ul><p>è¿™ç§å¤„ç†çš„é—®é¢˜åœ¨äºï¼šä¸»é¡µä¸­ä¾èµ–äº†è¯¦æƒ…çš„å¤´æ–‡ä»¶ï¼Œä¸”ç›´æ¥æŒæœ‰äº†è¯¦æƒ…çš„å®ä¾‹ï¼›è¯¦æƒ…çš„delegateåè¿‡æ¥æŒæœ‰äº†ä¸»é¡µçš„å®ä¾‹ï¼Œè¿™æ ·ä¸¤ä¸ªæ¨¡å—é—´å°±äº§ç”Ÿäº†ä¾èµ–å’Œè€¦åˆã€‚è¿™è¿˜åªæ˜¯ä¸»é¡µåˆ°è¯¦æƒ…çš„ä¸€ç§æƒ…å†µï¼Œå¦‚æœæœ‰å…¶ä»–æ¨¡å—åŒæ ·éœ€è¦è·³è½¬è¯¦æƒ…ï¼Œåˆ™è¿™äº›æ¨¡å—åŒæ ·ä¹Ÿä¼šä¸è¯¦æƒ…ä¹‹é—´äº§ç”Ÿè€¦åˆã€‚<br><br/></p><p>ç»„ä»¶åŒ–çš„å®è·µä¸­ï¼ŒæŒ‰ç…§åˆç†çš„ç²’åº¦å°†ç³»ç»Ÿåˆ’åˆ†ä¸ºå¤šä¸ªç»„ä»¶ä¹‹åï¼Œä¸»è¦çš„æŒ‘æˆ˜å°±å˜æˆäº†å¦‚ä½•å®ç°å„ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼ŒåŒæ—¶å‡å°‘ç»„ä»¶é—´çš„è€¦åˆã€‚<br><br/></p><p>é’ˆå¯¹è¿™ä¸€é—®é¢˜ï¼ŒURL+Blockè·¯ç”±æ–¹æ¡ˆçš„å®ç°æ€è·¯å’ŒåŸç†å¦‚ä¸‹ï¼š</p><h5 id="2-1-æœåŠ¡Block"><a href="#2-1-æœåŠ¡Block" class="headerlink" title="2.1.æœåŠ¡Block"></a>2.1.æœåŠ¡Block</h5><p>å°†åˆ›å»ºè¯¦æƒ…å®ä¾‹çš„æœåŠ¡å°è£…æˆä¸€ä¸ªblockï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">// DetailViewController.m</span><br>RouteHandler handler = ^ id (NSDictionary *parameters)&#123;<br>    <span class="hljs-keyword">return</span> [[DetailViewController alloc] <span class="hljs-keyword">init</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><h5 id="2-2-æœåŠ¡URL"><a href="#2-2-æœåŠ¡URL" class="headerlink" title="2.2.æœåŠ¡URL"></a>2.2.æœåŠ¡URL</h5><p>å®šä¹‰URLï¼Œç”¨å®ƒè¡¨ç¤ºè¯¦æƒ…ç»„ä»¶ä¸­çš„æŸé¡¹æœåŠ¡ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// Defines.h</span><br><span class="hljs-comment">// ç®€å•çš„åˆ›å»ºè¯¦æƒ…å®ä¾‹</span><br><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> *<span class="hljs-keyword">const</span> kRouteDetaiCreateIns = <span class="hljs-string">@&quot;//detail/create&quot;</span>;<br><span class="hljs-comment">// åˆ›å»ºè¯¦æƒ…å®ä¾‹å¹¶è®¾ç½®å›¾ç‰‡</span><br><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> *<span class="hljs-keyword">const</span> kRouteDetaiPushWithIcon = <span class="hljs-string">@&quot;//detail/push&quot;</span>;<br></code></pre></td></tr></table></figure><h5 id="2-3-æ˜ å°„URLä¸Block"><a href="#2-3-æ˜ å°„URLä¸Block" class="headerlink" title="2.3.æ˜ å°„URLä¸Block"></a>2.3.æ˜ å°„URLä¸Block</h5><p>åœ¨å•ä¾‹ç±»<code>Router</code>ä¸­å°†è¡¨ç¤ºæŸé¡¹æœåŠ¡çš„URLä¸çœŸæ­£å°è£…äº†æœåŠ¡çš„Blockæ˜ å°„åˆ°å­—å…¸ä¸­ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Router bindURL:kRouteDetaiPushWithIcon toHandler:handler]</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// Router.m</span><br><span class="hljs-comment">// MARK: ç»‘å®šURL-Block</span><br>+(<span class="hljs-type">void</span>)bindURL:(<span class="hljs-built_in">NSString</span> *)urlStr toHandler:(RouteHandler)handler&#123;<br>    [<span class="hljs-keyword">self</span>.routes setValue:handler forKey:urlStr];<br>&#125;<br><br>+ (<span class="hljs-built_in">NSMutableDictionary</span>*)routes &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">static</span> <span class="hljs-built_in">NSMutableDictionary</span> *_routes = <span class="hljs-literal">nil</span>;<br>        <span class="hljs-keyword">if</span> (!_routes) &#123;<br>            _routes = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>        &#125;<br>        <span class="hljs-keyword">return</span> _routes;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-4-è°ƒç”¨æœåŠ¡"><a href="#2-4-è°ƒç”¨æœåŠ¡" class="headerlink" title="2.4.è°ƒç”¨æœåŠ¡"></a>2.4.è°ƒç”¨æœåŠ¡</h5><p>åœ¨ä¸»é¡µä¸­é€šè¿‡<code>Router</code>è°ƒç”¨è¯¦æƒ…çš„æœåŠ¡å¹¶è·å–è¿”å›å€¼ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">UIViewController</span> *vc = [Router handleURL:url complexParams:params completion:^(<span class="hljs-type">id</span> result) &#123;<br>    <span class="hljs-keyword">self</span>.title = <span class="hljs-string">@&quot;Updated&quot;</span>;<br>&#125;];<br>[<span class="hljs-keyword">self</span>.navigationController pushViewController:vc animated:<span class="hljs-literal">YES</span>];<br></code></pre></td></tr></table></figure><h5 id="2-5-æœåŠ¡è·¯ç”±æŸ¥è¯¢"><a href="#2-5-æœåŠ¡è·¯ç”±æŸ¥è¯¢" class="headerlink" title="2.5.æœåŠ¡è·¯ç”±æŸ¥è¯¢"></a>2.5.æœåŠ¡è·¯ç”±æŸ¥è¯¢</h5><p><code>+handleURL</code>æ¥å£å†…éƒ¨ä¼šæ ¹æ®ä¹‹å‰ä¿å­˜çš„URL-Blockæ˜ å°„å…³ç³»ï¼Œä»¥<code>url</code>ä¸ºkeyå»æŸ¥è¯¢å¯¹åº”çš„Blockå¹¶æ‰§è¡Œå®ƒï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-keyword">nullable</span> RouteHandler)handlerForURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr &#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span>.routes valueForKey:urlStr];<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-å®ä¾‹"><a href="#3-å®ä¾‹" class="headerlink" title="3.å®ä¾‹"></a>3.å®ä¾‹</h4><h5 id="3-1-æ˜ å°„URLä¸æœåŠ¡"><a href="#3-1-æ˜ å°„URLä¸æœåŠ¡" class="headerlink" title="3.1.æ˜ å°„URLä¸æœåŠ¡"></a>3.1.æ˜ å°„URLä¸æœåŠ¡</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// Defines.h</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> UrlsHeader_h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UrlsHeader_h</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><br><span class="hljs-comment">// è¯¦æƒ…é¡µå¯¹å¤–æš´éœ²çš„å›è°ƒ</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>(^DetailCallback)(<span class="hljs-type">void</span>);<br><br><span class="hljs-comment">// ç®€å•çš„åˆ›å»ºè¯¦æƒ…å®ä¾‹</span><br><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> *<span class="hljs-keyword">const</span> kRouteDetaiCreateIns = <span class="hljs-string">@&quot;//detail/create&quot;</span>;<br><span class="hljs-comment">// åˆ›å»ºè¯¦æƒ…å®ä¾‹å¹¶è®¾ç½®å›¾ç‰‡</span><br><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> *<span class="hljs-keyword">const</span> kRouteDetaiPushWithIcon = <span class="hljs-string">@&quot;//detail/push&quot;</span>;<br><span class="hljs-comment">// è·³è½¬ä¸»é¡µ</span><br><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> *<span class="hljs-keyword">const</span> kRouteHome = <span class="hljs-string">@&quot;//home&quot;</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* UrlsHeader_h */</span></span><br></code></pre></td></tr></table></figure><p><code>Defines.h</code>å¤´æ–‡ä»¶ç”¨äºå®šä¹‰URLï¼Œä¹ŸåŒ…æ‹¬å…¶ä»–å¿…è¦å‚æ•°ã€‚å®ƒæ˜¯ä¸€ä¸ªé€šç”¨æ–‡ä»¶ï¼Œä¸å±äºæŸä¸ªç»„ä»¶ï¼Œå¯åœ¨.pchæ–‡ä»¶ä¸­å¯¼å…¥æ­¤å¤´æ–‡ä»¶ã€‚<br><br/></p><p>åœ¨è¿™é‡Œä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªURLå­—ç¬¦ä¸²<code>@&quot;//detail/push</code>ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²â€detailâ€è¡¨ç¤ºè¯¦æƒ…ç»„ä»¶ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸²â€pushâ€œè¡¨ç¤ºè·³è½¬åŠŸèƒ½ã€‚åé¢æˆ‘ä»¬å°±ä½¿ç”¨æ­¤URLæ¥å®ç°ä»ä¸»é¡µåˆ°è¯¦æƒ…çš„è·³è½¬ã€‚</p><h5 id="3-2-å®šä¹‰Router"><a href="#3-2-å®šä¹‰Router" class="headerlink" title="3.2.å®šä¹‰Router"></a>3.2.å®šä¹‰Router</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// Router.h</span><br><span class="hljs-comment">// è¡¨ç¤ºæœåŠ¡çš„blockï¼Œæ¥å—å­—å…¸ç±»å‹çš„å‚æ•°é›†åˆ</span><br><span class="hljs-keyword">typedef</span> _Nullable <span class="hljs-type">id</span> (^RouteHandler)( <span class="hljs-built_in">NSDictionary</span> * _Nullable parameters);<br><span class="hljs-comment">// å›è°ƒblock</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> (^RouteCompletion)(_Nullable <span class="hljs-type">id</span> result);<br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Router</span> : <span class="hljs-title">NSObject</span></span><br><br><span class="hljs-comment">/// ç»‘å®šURLä¸Block</span><br><span class="hljs-comment">/// @param urlStr å¯¹å¤–æš´éœ²çš„ä»£è¡¨æŸç»„ä»¶æœåŠ¡çš„URL</span><br><span class="hljs-comment">/// @param handler æœåŠ¡æ¥å£ï¼Œä»¥blockå½¢å¼æš´éœ²ç»™å¤–éƒ¨è°ƒç”¨è€…</span><br>+ (<span class="hljs-type">void</span>)bindURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr <br>      toHandler:(<span class="hljs-keyword">nonnull</span> RouteHandler)handler;<br><br><span class="hljs-comment">/// è°ƒç”¨æœåŠ¡æ¥å£</span><br><span class="hljs-comment">/// @param urlStr ä»£è¡¨ç›®æ ‡ç»„ä»¶æœåŠ¡æ¥å£çš„URL</span><br><span class="hljs-comment">/// @param complexParams URLä¸­ä¸æ–¹ä¾¿ä¼ é€’çš„å‚æ•°</span><br><span class="hljs-comment">/// @param completion å›è°ƒ</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)handleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr<br>complexParams:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span>*)complexParams<br>              completion:(<span class="hljs-keyword">nullable</span> RouteCompletion)completion;<br><br><span class="hljs-comment">/// è¯¥URLæ˜¯å¦æœ‰ä¸ä¹‹å¯¹åº”çš„Block</span><br><span class="hljs-comment">/// @param urlStr URLå­—ç¬¦ä¸²</span><br>+ (<span class="hljs-type">BOOL</span>)canHandleUrl:(<span class="hljs-built_in">NSString</span>*)urlStr;<br><br><span class="hljs-keyword">@end</span><br><br>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br><br><span class="hljs-comment">// Router.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Router.h&quot;</span></span><br><br><span class="hljs-keyword">static</span> Router *mInstance = <span class="hljs-literal">nil</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Router</span></span><br><br>+ (<span class="hljs-keyword">instancetype</span>)sharedInstance&#123;<br>    <span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> alloc] init];<br>&#125;<br><br>+ (<span class="hljs-keyword">instancetype</span>)allocWithZone:(<span class="hljs-keyword">struct</span> _NSZone *)zone&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br>        mInstance = [<span class="hljs-variable language_">super</span> allocWithZone:zone];<br>    &#125;);<br>    <span class="hljs-keyword">return</span> mInstance;<br>&#125;<br><br><span class="hljs-comment">// MARK: Getter&amp;Setter</span><br><br>+ (<span class="hljs-built_in">NSMutableDictionary</span>*)routes &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">static</span> <span class="hljs-built_in">NSMutableDictionary</span> *_routes = <span class="hljs-literal">nil</span>;<br>        <span class="hljs-keyword">if</span> (!_routes) &#123;<br>            _routes = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>        &#125;<br>        <span class="hljs-keyword">return</span> _routes;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// MARK: ç»‘å®šURL-Block</span><br>+(<span class="hljs-type">void</span>)bindURL:(<span class="hljs-built_in">NSString</span> *)urlStr toHandler:(RouteHandler)handler&#123;<br>    [<span class="hljs-keyword">self</span>.routes setValue:handler forKey:urlStr];<br>&#125;<br><br><span class="hljs-comment">// MARK: æ ¹æ®URLè°ƒç”¨æœåŠ¡</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)handleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr<br>complexParams:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span>*)complexParams<br>   completion:(<span class="hljs-keyword">nullable</span> RouteCompletion)completion &#123;<br>    <br>    <span class="hljs-comment">// é‡æ–°è·å–å‚æ•°ä¹‹å‰çš„URL.hostå’ŒURL.pathï¼Œå¦‚â€œ//detail/pushâ€</span><br>    <span class="hljs-built_in">NSString</span> *URLKey = [<span class="hljs-keyword">self</span> getKeyFromURL:urlStr];<br>    <br>    <span class="hljs-comment">// æŸ¥æ‰¾urlå¯¹åº”çš„block</span><br>    RouteHandler handler = [<span class="hljs-keyword">self</span> handlerForURL:URLKey];<br>    <br>    <span class="hljs-comment">//æ‹¼æ¥å‚æ•°</span><br>    <span class="hljs-built_in">NSDictionary</span> *paramsInURL = [<span class="hljs-keyword">self</span>.class parametersInURL:urlStr];<br>    <span class="hljs-built_in">NSMutableDictionary</span> *params = [<span class="hljs-built_in">NSMutableDictionary</span> dictionaryWithDictionary:complexParams];<br>    [params addEntriesFromDictionary:paramsInURL];<br>    <br>    <span class="hljs-type">id</span> obj = handler(params);<br>    <br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br><br><span class="hljs-comment">// MARK: è·å–URLä¸­?å·ä¹‹åçš„å‚æ•°</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span>*)parametersInURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span>*)urlStr &#123;<br>    <span class="hljs-built_in">NSURL</span> *URL = [<span class="hljs-built_in">NSURL</span> URLWithString:urlStr];<br>    <span class="hljs-built_in">NSMutableDictionary</span> *params = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-built_in">NSString</span> *query = URL.query;<br>    <span class="hljs-keyword">if</span>(query.length &gt; <span class="hljs-number">0</span>) &#123;<br>        params = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>        <span class="hljs-built_in">NSArray</span> *list = [query componentsSeparatedByString:<span class="hljs-string">@&quot;&amp;&quot;</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> *param <span class="hljs-keyword">in</span> list) &#123;<br>            <span class="hljs-built_in">NSArray</span> *elts = [param componentsSeparatedByString:<span class="hljs-string">@&quot;=&quot;</span>];<br>            <span class="hljs-keyword">if</span>([elts count] &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-built_in">NSString</span> *decodedStr = [[elts lastObject] stringByRemovingPercentEncoding];<br>            [params setObject:decodedStr forKey:[elts firstObject]];<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> params;<br>&#125;<br><br><span class="hljs-comment">// MARK:æ ¹æ®URLè·å–å¯¹åº”çš„Block</span><br>+ (<span class="hljs-keyword">nullable</span> RouteHandler)handlerForURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr &#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span>.routes valueForKey:urlStr];<br>&#125;<br><br><span class="hljs-comment">// MARK:URLæ˜¯å¦æœ‰ä¸ä¹‹å¯¹åº”çš„Block</span><br>+ (<span class="hljs-type">BOOL</span>)canHandleUrl:(<span class="hljs-built_in">NSString</span>*)urlStr&#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> getKeyFromURL:urlStr].length != <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//  é‡æ–°è·å–å‚æ•°ä¹‹å‰çš„URL.hostå’ŒURL.pathï¼Œå¦‚â€œ//detail/pushâ€</span><br>+ (<span class="hljs-built_in">NSString</span>*)getKeyFromURL:(<span class="hljs-built_in">NSString</span>*)urlStr&#123;<br>    <span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:urlStr];<br>    <span class="hljs-built_in">NSString</span> *host = url.host;<br>    <span class="hljs-built_in">NSString</span> *path = url.path;<br>    <span class="hljs-built_in">NSString</span> *URLKey = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;//%@%@&quot;</span>,host,path];<br>    <br>    <span class="hljs-keyword">return</span> URLKey;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯URLè·¯ç”±æ–¹æ¡ˆä¸­çš„<code>æ ¸å¿ƒç±»</code>ã€‚å…¶ä¸»è¦ä½œç”¨æœ‰ï¼š</p><ul><li>æä¾›å…¨å±€é™æ€å­—å…¸ï¼Œä»¥ä¾¿ä¿å­˜URLä¸Blockçš„æ˜ å°„å…³ç³»ï¼›</li><li>æä¾›æ¥å£ä»¥ä¾¿è°ƒç”¨æ–¹é€šè¿‡çº¦å®šå¥½çš„URLè°ƒç”¨ç›®æ ‡ç»„ä»¶çš„æœåŠ¡ï¼›</li></ul><p>ä¸€äº›éœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼š<br><br/></p><p>1ã€<code>+bindURL</code>æ¥å£ä¸­çš„<code>urlStr</code>å‚æ•°æ˜¯ä»£è¡¨ç›®æ ‡ç»„ä»¶æœåŠ¡æ¥å£çš„çº¯URLï¼Œå¦‚<code>&quot;//detail/push&quot;</code>ï¼Œä¸å¸¦ä»»ä½•å…¶ä»–å‚æ•°ï¼Œåœ¨å…¨å±€å­—å…¸ä¸­ä¿å­˜æ˜ å°„å…³ç³»æ—¶ï¼Œkey&#x3D;URLï¼Œvalue&#x3D;blockã€‚<br><br/></p><p>2ã€<code>+handleURL</code>æ¥å£ä¸­çš„<code>urlStr</code>å‚æ•°åˆ™æ˜¯å®Œæ•´çš„URLï¼Œå¯åŒ…å«è°ƒç”¨æ–¹å‘ç›®æ ‡ç»„ä»¶ä¼ é€’çš„å‚æ•°ï¼Œå¦‚â€&#x2F;&#x2F;detail&#x2F;push?a&#x3D;1&amp;b&#x3D;1â€;<br><br/></p><p>3ã€åœ¨<code>+handleURL</code>æ–¹æ³•å†…éƒ¨æ ¹æ®URLæŸ¥è¯¢Blockæ—¶ï¼Œkeyä¸ºä»<code>urlStr</code>ä¸­æ‹†åˆ†å‡ºçš„<code>url.host+url.path</code>éƒ¨åˆ†ï¼Œå³<code>â€œ//detail/pushâ€</code>ï¼›<br><br/></p><p>4ã€æœ¬ç¤ºä¾‹ä¸­<code>Router.h</code>åªæä¾›äº†æœ€ç®€å•å’Œæœ€ä¸»è¦çš„ä¸¤ä¸ªæ¥å£ï¼Œå®é™…ä½¿ç”¨ä¸­å¯æ ¹æ®éœ€æ±‚è‡ªå·±æ‰©å±•å…¶ä»–åŠŸèƒ½ï¼Œè¿™é‡Œä¸åšè¿‡å¤šçš„å»¶ä¼¸ï¼Œå› ä¸ºåé¢ä¼šè®²åˆ°æœ‰èµå¼€æºçš„åº“<code>Bifrost</code>ï¼Œé‚£é‡Œè¿›è¡Œäº†å®Œå–„çš„å°è£…ã€‚</p><h5 id="3-3-æ³¨å†ŒæœåŠ¡"><a href="#3-3-æ³¨å†ŒæœåŠ¡" class="headerlink" title="3.3.æ³¨å†ŒæœåŠ¡"></a>3.3.æ³¨å†ŒæœåŠ¡</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// DetailViewController.h</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DetailViewController</span> : <span class="hljs-title">UIViewController</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">UIImage</span> *img;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) DetailCallback callBack; <span class="hljs-comment">// å›è°ƒblock</span><br><span class="hljs-keyword">@end</span><br><br>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br><span class="hljs-comment">// DetailViewController.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Router.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DetailViewController</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UIImageView</span> *mIconView;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DetailViewController</span></span><br><br>+ (<span class="hljs-type">void</span>)load&#123;<br>    <span class="hljs-comment">// ä»¥blockçš„å½¢å¼å°è£…å¯¹å¤–æœåŠ¡</span><br>    RouteHandler handler = ^ <span class="hljs-type">id</span> (<span class="hljs-built_in">NSDictionary</span> *parameters)&#123;<br>        <span class="hljs-built_in">UIImage</span> *img = parameters[<span class="hljs-string">@&quot;img&quot;</span>];<br>        DetailCallback callback = parameters[<span class="hljs-string">@&quot;block&quot;</span>];<br>        DetailViewController *vc = [[<span class="hljs-built_in">UIStoryboard</span> storyboardWithName:<span class="hljs-string">@&quot;Main&quot;</span> bundle:<span class="hljs-literal">nil</span>]<br>                                    instantiateViewControllerWithIdentifier:<span class="hljs-string">@&quot;DetailViewController&quot;</span>];<br>        vc.img = img;<br>        vc.callBack = callback;<br>        <span class="hljs-keyword">return</span> vc;<br>    &#125;;<br>    <span class="hljs-comment">// å°†URLä¸Blockçš„å…³ç³»æ³¨å†Œåˆ°è·¯ç”±è¡¨ä¸­</span><br>    [Router bindURL:kRouteDetaiPushWithIcon toHandler:handler];<br>    <br>    <span class="hljs-comment">// å¯æ³¨å†Œå¤šä¸ªBlockï¼Œä»¥ä¾¿å¯¹å¤–æä¾›æ›´å¤šæœåŠ¡</span><br>    RouteHandler handler2 = ^ (<span class="hljs-built_in">NSDictionary</span> *params)&#123;<br>        <span class="hljs-keyword">return</span> [[DetailViewController alloc] init];<br>    &#125;;<br>    [Router bindURL:kRouteDetaiCreateIns toHandler:handler2];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    _mIconView.image = _img;<br>&#125;<br><br>- (<span class="hljs-keyword">IBAction</span>)onDismissAction:(<span class="hljs-type">id</span>)sender &#123;<br>    <span class="hljs-keyword">self</span>.callBack(); <span class="hljs-comment">//å›è°ƒç»™æœåŠ¡è°ƒç”¨æ–¹</span><br>    [<span class="hljs-keyword">self</span>.navigationController popViewControllerAnimated:<span class="hljs-literal">YES</span>];<br>&#125;<br><br>-(<span class="hljs-type">void</span>)dealloc&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++DetailViewController dealloced~~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥æ˜¯åœ¨è¢«è°ƒç”¨çš„ç»„ä»¶ä¸­è¿›è¡Œçš„ï¼Œå³<code>DetailViewController</code>ã€‚æ³¨å†Œçš„æ“ä½œæ˜¯åœ¨<code>+load()</code>æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œè¿™æ ·å°±èƒ½ä¿è¯åœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µå°†è¡¨ç¤ºå½“å‰ç»„ä»¶æœåŠ¡æ¥å£çš„URLå’Œblockè‡ªåŠ¨æ³¨å†Œåˆ°<code>Router</code>ä¸­ï¼Œä»¥ä¾¿åé¢éšæ—¶è°ƒç”¨ã€‚</p><br/><p><code>+load()</code>æ–¹æ³•ä¸­å¯ä»¥æ³¨å†Œå¤šä¸ªå¯¹å¤–æä¾›æœåŠ¡çš„blockï¼Œå°±ç›¸å½“äºå¯¹å¤–æä¾›äº†å¤šä¸ªæ¥å£ï¼ŒåŒºåˆ†å¥½å¯¹åº”çš„URLå³å¯ã€‚</p><h5 id="3-4-æœ¬åœ°è°ƒç”¨æœåŠ¡"><a href="#3-4-æœ¬åœ°è°ƒç”¨æœåŠ¡" class="headerlink" title="3.4.æœ¬åœ°è°ƒç”¨æœåŠ¡"></a>3.4.æœ¬åœ°è°ƒç”¨æœåŠ¡</h5><p>æ‰€è°“æœ¬åœ°è°ƒç”¨ï¼Œå°±æ˜¯æˆ‘ä»¬çš„åº”ç”¨å†…éƒ¨ç»„ä»¶ä¹‹é—´çš„æœåŠ¡è°ƒç”¨ï¼Œæ¯”å¦‚ä¸»é¡µè°ƒç”¨è¯¦æƒ…çš„æ¥å£ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// HomeViewController.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Router.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">HomeViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>&#125;<br><br>- (<span class="hljs-keyword">IBAction</span>)onPushAction:(<span class="hljs-type">id</span>)sender &#123;<br>    <span class="hljs-comment">// å£°æ˜å›è°ƒ ä»å¤´åƒé¡µé¢è¿”å›å½“å‰é¡µé¢æ—¶æ›´æ–°æ ‡é¢˜</span><br>    DetailCallback block = ^()&#123;<br>        <span class="hljs-keyword">self</span>.title = <span class="hljs-string">@&quot;Info Checked&quot;</span>;<br>    &#125;;<br>    <span class="hljs-built_in">NSDictionary</span> *params = @&#123;<span class="hljs-string">@&quot;img&quot;</span>:[<span class="hljs-built_in">UIImage</span> imageNamed:<span class="hljs-string">@&quot;1&quot;</span>],<span class="hljs-string">@&quot;block&quot;</span>:block&#125;;<br>    <span class="hljs-built_in">NSString</span> *url = [kRouteDetaiPushWithIcon stringByAppendingString:<span class="hljs-string">@&quot;?num=1&amp;orderid=10001&quot;</span>];<br><br>    <span class="hljs-comment">// è°ƒç”¨æœåŠ¡</span><br>    <span class="hljs-built_in">UIViewController</span> *vc = [Router handleURL:url complexParams:params completion:^(<span class="hljs-type">id</span> result) &#123;<br>        <span class="hljs-keyword">self</span>.title = <span class="hljs-string">@&quot;Updated&quot;</span>;<br>    &#125;];<br>    [<span class="hljs-keyword">self</span>.navigationController pushViewController:vc animated:<span class="hljs-literal">YES</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ul><li>è°ƒç”¨æ–¹ä½¿ç”¨çº¦å®šå¥½çš„URLå­—ç¬¦ä¸²æŒ‡æ˜è¦è°ƒç”¨çš„æœåŠ¡æ¥å£ï¼›</li><li>å°†ç®€å•çš„å‚æ•°ä»¥<code>URL.query</code>çš„å½¢å¼æ‹¼æ¥åˆ°URLä¸­ï¼›</li><li>å¯¹äºå¤æ‚çš„å‚æ•°ï¼Œå¯åŒ…è£…åˆ°å­—å…¸<code>params</code>ä¸­ï¼›</li><li>å›è°ƒå‡½æ•°ä¸­å®šä¹‰å¥½è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½œä¸º<code>completion</code>å‚æ•°ï¼›</li><li>é€šè¿‡<code>Router</code>è°ƒç”¨æœåŠ¡ï¼Œä¼ å…¥ä¹‹å‰çš„å‚æ•°ï¼Œç­‰å¾…æ¥æ”¶å¹¶å¤„ç†è¿”å›å€¼å³å¯ã€‚</li></ul><h5 id="3-5-è¿œç¨‹æœåŠ¡è°ƒç”¨"><a href="#3-5-è¿œç¨‹æœåŠ¡è°ƒç”¨" class="headerlink" title="3.5.è¿œç¨‹æœåŠ¡è°ƒç”¨"></a>3.5.è¿œç¨‹æœåŠ¡è°ƒç”¨</h5><p>æ‰€è°“è¿œç¨‹è°ƒç”¨ï¼Œå°±æ˜¯åˆ«çš„åº”ç”¨å‘æˆ‘ä»¬çš„åº”ç”¨å‘èµ·çš„æœåŠ¡è°ƒç”¨ï¼Œå¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åˆ«çš„åº”ç”¨é€šè¿‡<code>[[UIApplication sharedApplication] openURL:url]</code>ä¼ é€’æŒ‡å®šæ ¼å¼çš„URLåˆ°æˆ‘ä»¬çš„åº”ç”¨ï¼›</li><li>æˆ‘ä»¬çš„åº”ç”¨åœ¨ä¸‹é¢çš„å›è°ƒä¸­æ¥æ”¶URLï¼Œç»è¿‡RouteræŸ¥è¯¢å’Œè°ƒç”¨ä¸URLç»‘å®šçš„æœåŠ¡Blockï¼š</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)app <br>            openURL:(<span class="hljs-built_in">NSURL</span> *)url <br>            options:(<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">UIApplicationOpenURLOptionsKey</span>,<span class="hljs-type">id</span>&gt; *)options<br>&#123;<br>    <span class="hljs-type">BOOL</span> canHandle = [Router canHandleUrl:url.absoluteString];<br>    <span class="hljs-keyword">if</span> (canHandle) &#123;<br>        [Router handleURL:url.absoluteString complexParams:<span class="hljs-literal">nil</span> completion:^(<span class="hljs-type">id</span> result) &#123;<br>        &#125;];<br>    &#125;<br>    <span class="hljs-keyword">return</span> canHandle;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿œç¨‹è°ƒç”¨æ—¶ä¼ é€’çš„URLä¸€å®šè¦æŒ‰ç…§çº¦å®šçš„æ ¼å¼æ‹¼æ¥ï¼›<br><br/></p><p>åŸºäºURLçš„è¿œç¨‹è°ƒç”¨æœ‰ä¸ªç¼ºç‚¹ï¼Œå³URLä¸­å‚æ•°çš„ç±»å‹å°†ä¼šå—åˆ°é™åˆ¶ï¼Œå›¾ç‰‡ã€æ•°æ®ã€blockç­‰ç±»å‹çš„å‚æ•°å°†æ— æ³•ç›´æ¥æ‹¼æ¥åˆ°URLåé¢ã€‚</p><h4 id="4-æµç¨‹æ€»ç»“"><a href="#4-æµç¨‹æ€»ç»“" class="headerlink" title="4.æµç¨‹æ€»ç»“"></a>4.æµç¨‹æ€»ç»“</h4><ul><li>å°†ç»„ä»¶å¯¹å¤–æä¾›çš„æœåŠ¡ä»¥Blockçš„å½¢å¼è¿›è¡Œå°è£…ï¼›</li><li>å®šä¹‰URLä»¥è¡¨ç¤ºç»„ä»¶å¯¹å¤–æä¾›çš„æŸä¸ªæ¥å£ï¼›</li><li>åº”ç”¨å¯åŠ¨é˜¶æ®µåœ¨å…¨å±€å­—å…¸ä¸­ä¿å­˜URLä¸Blockçš„æ˜ å°„å…³ç³»ï¼›</li><li>ç®€å•å‚æ•°æ‹¼æ¥åˆ°URLä¸­ï¼Œå¤æ‚å‚æ•°åŒ…è£…åˆ°complexParamså­—å…¸ä¸­ï¼›</li><li>æœåŠ¡è°ƒç”¨æ–¹ä¼ å…¥URLï¼Œç”±RouteræŸ¥è¯¢å¹¶è°ƒç”¨ä¸ä¹‹ç»‘å®šçš„Blockï¼›<br><img src="https://davidlii.nos-eastchina1.126.net/pic_module_URL_Block.jpg" alt="ç»„ä»¶åŒ–-URL-BLOCK"></li></ul><h4 id="5-ç›®å½•ç»“æ„"><a href="#5-ç›®å½•ç»“æ„" class="headerlink" title="5.ç›®å½•ç»“æ„"></a>5.ç›®å½•ç»“æ„</h4><p>æ•´ä¸ªå·¥ç¨‹çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs stylus">.<br>â”œâ”€â”€ HelModules+URL<br>â”‚Â Â  â”œâ”€â”€ AppDelegate<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”œâ”€â”€ AppDelegate<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”œâ”€â”€ Assets<span class="hljs-selector-class">.xcassets</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AppIcon<span class="hljs-selector-class">.appiconset</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Contents<span class="hljs-selector-class">.json</span><br>â”‚Â Â  â”œâ”€â”€ Base<span class="hljs-selector-class">.lproj</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LaunchScreen<span class="hljs-selector-class">.storyboard</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Main<span class="hljs-selector-class">.storyboard</span><br>â”‚Â Â  â”œâ”€â”€ Common<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Defines<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ PrefixHeader<span class="hljs-selector-class">.pch</span><br>â”‚Â Â  â”œâ”€â”€ Detail<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DetailViewController<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ DetailViewController<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”œâ”€â”€ Home<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ HomeViewController<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ HomeViewController<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”œâ”€â”€ Icons<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ <span class="hljs-number">1</span>@<span class="hljs-number">2</span>x<span class="hljs-selector-class">.png</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ <span class="hljs-number">1</span>@<span class="hljs-number">3</span>x<span class="hljs-selector-class">.png</span><br>â”‚Â Â  â”œâ”€â”€ Info<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”œâ”€â”€ Routers<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Router<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Router<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â””â”€â”€ <span class="hljs-selector-tag">main</span>.m<br></code></pre></td></tr></table></figure><h4 id="6-Bifrost"><a href="#6-Bifrost" class="headerlink" title="6.Bifrost"></a>6.Bifrost</h4><p>æ•´ä¸ªURLè§£è€¦æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯<code>Router</code>ç±»ï¼š</p><ul><li>æä¾›æ³¨å†Œæ¥å£ï¼Œå°†URLä¸Blockçš„æ˜ å°„å…³ç³»ä¿å­˜åˆ°å…¨å±€å­—å…¸ä¸­ï¼›</li><li>æ ¹æ®URLæŸ¥è¯¢å¹¶è°ƒç”¨å¯¹åº”Blockã€‚</li></ul><p>è¿™é‡Œç€é‡æ¨èä¸€ä¸‹æœ‰èµå¼€æºçš„ç»„ä»¶åŒ–åº“<a href="https://github.com/youzan/Bifrost">â€#Bifrostâ€œ</a>ï¼Œå®ƒæä¾›äº†å¯¹Routerå®Œå–„çš„å°è£…ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// Bifrost+Router.h</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Bifrost.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BFComplete(Params, Result) [Bifrost completeWithParameters:Params result:Result]</span><br><br><span class="hljs-comment">// default keys in the parameters of BifrostRouteHandler</span><br><span class="hljs-keyword">extern</span> <span class="hljs-built_in">NSString</span> * _Nonnull <span class="hljs-keyword">const</span> kBifrostRouteURL; <span class="hljs-comment">//the key for the raw url</span><br><span class="hljs-keyword">extern</span> <span class="hljs-built_in">NSString</span> * _Nonnull <span class="hljs-keyword">const</span> kBifrostRouteCompletion; <span class="hljs-comment">//the key for the completion block.</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> The handler for a binded url</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param parameters containers above 2 keys and parameters from the query string and complexParams</span><br><span class="hljs-comment"> @return the obj returned by the handler</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">typedef</span> _Nullable <span class="hljs-type">id</span> (^BifrostRouteHandler)( <span class="hljs-built_in">NSDictionary</span> * _Nullable parameters);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> The completion block to be invoked at the end of the router handler block</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param result completion result. defaultly it is the returned object of the BifrostRouteHandler.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> (^BifrostRouteCompletion)(_Nullable <span class="hljs-type">id</span> result);<br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Bifrost</span> (<span class="hljs-title">Router</span>)</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> The method to bind a URL to handler</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param urlStr The URL string. Only scheme, host and api path will be used here.</span><br><span class="hljs-comment"> Its query string will be ignore here.</span><br><span class="hljs-comment"> @param handler the handler block.</span><br><span class="hljs-comment"> The BifrostRouteCompletion should be invoked at the end of the block</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-type">void</span>)bindURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr toHandler:(<span class="hljs-keyword">nonnull</span> BifrostRouteHandler)handler;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> The method to unbind a URL</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param urlStr The URL string. Only scheme, host and api path will be used here.</span><br><span class="hljs-comment"> Its query string will be ignore here.</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-type">void</span>)unbindURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> Method to unbind all URLs</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-type">void</span>)unbindAllURLs;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> The method to check whether a url can be handled</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param urlStr The URL string. Only scheme, host and api path will be used here.</span><br><span class="hljs-comment"> Its query string will be ignore here.</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-type">BOOL</span>)canHandleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> Method to handle the URL</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param urlStr URL string</span><br><span class="hljs-comment"> @return the returned object of the url&#x27;s BifrostRouteHandler</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)handleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> Method to handle the url with completion block</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param urlStr URL string</span><br><span class="hljs-comment"> @param completion The completion block</span><br><span class="hljs-comment"> @return the returned object of the url&#x27;s BifrostRouteHandler</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)handleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr<br>              completion:(<span class="hljs-keyword">nullable</span> BifrostRouteCompletion)completion;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> The method to handle URL with complex parameters and completion block</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param urlStr URL string</span><br><span class="hljs-comment"> @param complexParams complex parameters that can&#x27;t be put in the url query strings</span><br><span class="hljs-comment"> @param completion The completion block</span><br><span class="hljs-comment"> @return the returned object of the url&#x27;s BifrostRouteHandler</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)handleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr<br>           complexParams:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span>*)complexParams<br>              completion:(<span class="hljs-keyword">nullable</span> BifrostRouteCompletion)completion;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> Invoke the completion block in the parameters of BifrostRouteHandler.</span><br><span class="hljs-comment"> Recommend to use macro BFComplete for convenient.</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param params parameters of BifrostRouteHandler</span><br><span class="hljs-comment"> @param result the result for the BifrostRouteCompletion</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-type">void</span>)completeWithParameters:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span>*)params result:(_Nullable <span class="hljs-type">id</span>)result;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ä»å¤´æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>Bifrost</code>çš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š</p><ul><li>ç»‘å®šURL-Blockï¼›</li><li>æ ¹æ®URLå¤„ç†ç®€å•å‚æ•°ã€å¤æ‚å‚æ•°ã€å¸¦å›è°ƒçš„æœåŠ¡è°ƒç”¨ï¼›</li><li>è§£é™¤å•ä¸ªæˆ–æ‰€æœ‰URLä¸Blockçš„æ˜ å°„ï¼›</li><li>æ£€æµ‹æŸä¸ªURLæ˜¯å¦ç»‘å®šäº†Blockï¼›</li></ul><p>å…·ä½“çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;Bifrost+Router.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BFLog(msg) NSLog(@<span class="hljs-string">&quot;[Bifrost] %@&quot;</span>, (msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BFKey(URL) [Bifrost keyForURL:URL]</span><br><br><span class="hljs-built_in">NSString</span> *<span class="hljs-keyword">const</span> kBifrostRouteURL = <span class="hljs-string">@&quot;kBifrostRouteURL&quot;</span>;<br><span class="hljs-built_in">NSString</span> *<span class="hljs-keyword">const</span> kBifrostRouteCompletion = <span class="hljs-string">@&quot;kBifrostRouteCompletion&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Bifrost</span> (<span class="hljs-title">Router</span>)</span><br><br><span class="hljs-comment">// ä»å¸¦å‚æ•°çš„URLä¸­å–å‡º.hostå’Œ.pathéƒ¨åˆ†ï¼Œä½œä¸ºç»‘å®šblockæ‰€ç”¨çš„é”®</span><br>+ (<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span>*)keyForURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span>*)urlStr &#123;<br>    <span class="hljs-built_in">NSURL</span> *URL = [<span class="hljs-built_in">NSURL</span> URLWithString:urlStr];<br>    <span class="hljs-built_in">NSString</span> *key = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;%@%@&quot;</span>, URL.host, URL.path];<br>    <span class="hljs-keyword">return</span> key;<br>&#125;<br><br><span class="hljs-comment">// å–å‡ºURL.queryéƒ¨åˆ†ï¼Œä»¥&amp;åˆ†å‰²å‚æ•°ï¼Œé‡æ–°ç»„æˆå­—å…¸</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span>*)parametersInURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span>*)urlStr &#123;<br>    <span class="hljs-built_in">NSURL</span> *URL = [<span class="hljs-built_in">NSURL</span> URLWithString:urlStr];<br>    <span class="hljs-built_in">NSMutableDictionary</span> *params = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-built_in">NSString</span> *query = URL.query;<br>    <span class="hljs-keyword">if</span>(query.length &gt; <span class="hljs-number">0</span>) &#123;<br>        params = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>        <span class="hljs-built_in">NSArray</span> *list = [query componentsSeparatedByString:<span class="hljs-string">@&quot;&amp;&quot;</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> *param <span class="hljs-keyword">in</span> list) &#123;<br>            <span class="hljs-built_in">NSArray</span> *elts = [param componentsSeparatedByString:<span class="hljs-string">@&quot;=&quot;</span>];<br>            <span class="hljs-keyword">if</span>([elts count] &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-built_in">NSString</span> *decodedStr = [[elts lastObject] stringByRemovingPercentEncoding];<br>            [params setObject:decodedStr forKey:[elts firstObject]];<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> params;<br>&#125;<br><br><span class="hljs-comment">// é™æ€å­—å…¸ï¼Œå…¨å±€ä¸€ä»½ï¼Œä¿å­˜URLä¸Blockçš„æ˜ å°„å…³ç³»</span><br>+ (<span class="hljs-built_in">NSMutableDictionary</span>*)routes &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">static</span> <span class="hljs-built_in">NSMutableDictionary</span> *_routes = <span class="hljs-literal">nil</span>;<br>        <span class="hljs-keyword">if</span> (!_routes) &#123;<br>            _routes = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>        &#125;<br>        <span class="hljs-keyword">return</span> _routes;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ä¿å­˜URLä¸Blockçš„æ˜ å°„å…³ç³»</span><br>+ (<span class="hljs-type">void</span>)bindURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr toHandler:(<span class="hljs-keyword">nonnull</span> BifrostRouteHandler)handler &#123;<br>    [<span class="hljs-keyword">self</span>.routes setObject:handler forKey:BFKey(urlStr)];<br>&#125;<br><br><span class="hljs-comment">// è§£é™¤URLä¸Blockçš„æ˜ å°„å…³ç³»</span><br>+ (<span class="hljs-type">void</span>)unbindURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr &#123;<br>    [<span class="hljs-keyword">self</span>.routes removeObjectForKey:BFKey(urlStr)];<br>&#125;<br><br><span class="hljs-comment">// æ¸…ç©ºæ‰€æœ‰çš„æ˜ å°„</span><br>+ (<span class="hljs-type">void</span>)unbindAllURLs &#123;<br>    [<span class="hljs-keyword">self</span>.routes removeAllObjects];<br>&#125;<br><br><span class="hljs-comment">// æ ¹æ®URLæŸ¥è¯¢å·²ç»‘å®šçš„Block</span><br>+ (<span class="hljs-keyword">nullable</span> BifrostRouteHandler)handlerForURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr &#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span>.routes objectForKey:BFKey(urlStr)];<br>&#125;<br><br><span class="hljs-comment">// æ£€æµ‹URLæ˜¯å¦ç»‘å®šäº†Block</span><br>+ (<span class="hljs-type">BOOL</span>)canHandleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr &#123;<br>    <span class="hljs-keyword">if</span> (urlStr.length == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span> handlerForURL:urlStr]) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// æŸ¥è¯¢å¹¶è°ƒç”¨URLç»‘å®šçš„blockï¼Œurlä¸­åŒ…å«äº†ç®€å•çš„å‚æ•°</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)handleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr &#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> handleURL:urlStr complexParams:<span class="hljs-literal">nil</span> completion:<span class="hljs-literal">nil</span>];<br>&#125;<br><br><span class="hljs-comment">// æŸ¥è¯¢å¹¶è°ƒç”¨URLç»‘å®šçš„blockï¼Œurlä¸­åŒ…å«äº†ç®€å•çš„å‚æ•°ï¼ŒåŒæ—¶é™„å¸¦å›è°ƒå‡½æ•°</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)handleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr<br>              completion:(<span class="hljs-keyword">nullable</span> BifrostRouteCompletion)completion &#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> handleURL:urlStr complexParams:<span class="hljs-literal">nil</span> completion:completion];<br>&#125;<br><br><span class="hljs-comment">// æŸ¥è¯¢å¹¶è°ƒç”¨URLç»‘å®šçš„blockï¼Œurlä¸­åŒ…å«äº†ç®€å•çš„å‚æ•°ï¼Œå¤æ‚å‚æ•°åŒ…å«åœ¨complexParamså­—å…¸ä¸­ï¼ŒåŒæ—¶é™„å¸¦å›è°ƒå‡½æ•°</span><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)handleURL:(<span class="hljs-keyword">nonnull</span> <span class="hljs-built_in">NSString</span> *)urlStr<br>           complexParams:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span>*)complexParams<br>              completion:(<span class="hljs-keyword">nullable</span> BifrostRouteCompletion)completion &#123;<br>    <span class="hljs-type">id</span> obj = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-keyword">@try</span> &#123;<br>        BifrostRouteHandler handler = [<span class="hljs-keyword">self</span> handlerForURL:urlStr];<br>        <span class="hljs-built_in">NSMutableDictionary</span> *params = [<span class="hljs-built_in">NSMutableDictionary</span> dictionaryWithDictionary:complexParams];<br>        [params addEntriesFromDictionary:[<span class="hljs-keyword">self</span>.class parametersInURL:urlStr]];<br>        [params setObject:urlStr forKey:kBifrostRouteURL];<br>        <span class="hljs-keyword">if</span> (completion) &#123;<br>            [params setObject:completion forKey:kBifrostRouteCompletion];<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!handler) &#123;<br>            <span class="hljs-built_in">NSString</span> *reason = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;Cannot find handler for route url %@&quot;</span>, urlStr];<br>            <span class="hljs-built_in">NSMutableDictionary</span> *userInfo = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>            [userInfo setValue:@(BFExceptionUrlHandlerNotFound) forKey:kBifrostExceptionCode];<br>            [userInfo setValue:urlStr forKey:kBifrostExceptionURLStr];<br>            [userInfo setValue:params forKey:kBifrostExceptionURLParams];<br>            <span class="hljs-built_in">NSException</span> *exception = [[<span class="hljs-built_in">NSException</span> alloc] initWithName:BifrostExceptionName<br>                                                                reason:reason<br>                                                              userInfo:userInfo];<br>            BifrostExceptionHandler handler = [<span class="hljs-keyword">self</span> getExceptionHandler];<br>            <span class="hljs-keyword">if</span> (handler) &#123;<br>                obj = handler(exception);<br>            &#125;<br>            BFLog(reason);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            obj = handler(params);<br>        &#125;<br>    &#125; <span class="hljs-keyword">@catch</span> (<span class="hljs-built_in">NSException</span> *exception) &#123;<br>        <span class="hljs-built_in">NSMutableDictionary</span> *userInfo = [<span class="hljs-built_in">NSMutableDictionary</span> dictionaryWithDictionary:exception.userInfo];<br>        [userInfo setValue:@(BFExceptionDefaultCode) forKey:kBifrostExceptionCode];<br>        [userInfo setValue:urlStr forKey:kBifrostExceptionURLStr];<br>        [userInfo setValue:complexParams forKey:kBifrostExceptionURLParams];<br>        <span class="hljs-built_in">NSException</span> *ex = [[<span class="hljs-built_in">NSException</span> alloc] initWithName:exception.name<br>                                                     reason:exception.reason<br>                                                   userInfo:userInfo];<br>        BifrostExceptionHandler handler = [<span class="hljs-keyword">self</span> getExceptionHandler];<br>        <span class="hljs-keyword">if</span> (handler) &#123;<br>            obj = handler(ex);<br>        &#125;<br>        BFLog(exception.reason);<br>    &#125; <span class="hljs-keyword">@finally</span> &#123;<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ä»å‚æ•°åˆ—è¡¨ä¸­æŸ¥è¯¢å¹¶è°ƒç”¨å›è°ƒå‡½æ•°</span><br>+ (<span class="hljs-type">void</span>)completeWithParameters:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span>*)params result:(_Nullable <span class="hljs-type">id</span>)result &#123;<br>    BifrostRouteCompletion completion = params[kBifrostRouteCompletion];<br>    <span class="hljs-keyword">if</span> (completion) &#123;<br>        completion(result);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>åº“çš„å®ç°å¹¶ä¸å¤æ‚ï¼Œå„æ¥å£çš„ä½œç”¨å·²ç»åœ¨ä¸Šé¢æ ‡æ˜ã€‚å®ƒæä¾›äº†å¼‚å¸¸æƒ…å†µçš„æŠ¥é”™ï¼ŒåŒæ—¶URLå’Œå‚æ•°çš„å¤„ç†ä¹Ÿå€¼å¾—å€Ÿé‰´ã€‚</p><h4 id="7-æ–¹æ¡ˆè¯„ä»·"><a href="#7-æ–¹æ¡ˆè¯„ä»·" class="headerlink" title="7.æ–¹æ¡ˆè¯„ä»·"></a>7.æ–¹æ¡ˆè¯„ä»·</h4><p>æ— è®ºæ˜¯æˆ‘ä»¬è‡ªå·±çš„<code>Router</code>è¿˜æ˜¯æœ‰èµçš„<code>Bifrost</code>ï¼Œå…¶å®ç°ç»„ä»¶åŒ–çš„æ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ï¼šéƒ½æ˜¯URLä¸Blockçš„ç»‘å®šå’Œè·¯ç”±ã€‚<br><br/></p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>å·§å¦™çš„åˆ©ç”¨äº†URLçš„é€šç”¨æ€§ï¼Œæ”¯æŒå¤šç«¯ç»Ÿä¸€è·³è½¬ï¼›</li><li>åœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µå³å®ŒURLä¸æˆæœåŠ¡blockçš„ç»‘å®šï¼›</li><li>ç»„ä»¶ä¹‹é—´é€šè¿‡Routerè¿›è¡Œé€šä¿¡ï¼Œä¸å†éœ€è¦å¼•ç”¨å¯¹æ–¹çš„å¤´æ–‡ä»¶ï¼›</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>è¿œç¨‹è°ƒç”¨æ—¶ï¼Œåªæ”¯æŒç®€å•å‚æ•°ï¼›</li><li>æœ¬åœ°è°ƒç”¨æ—¶ï¼Œä¼ é€’å¤æ‚å‚æ•°åªèƒ½åŒ…è£…åˆ°complexParamså­—å…¸ä¸­ï¼Œä¸å¤Ÿçµæ´»ï¼›</li><li>ç»„ä»¶é—´éœ€è¦ä¼ é€’å®ä½“æ•°æ®æ—¶ï¼Œè¿˜éœ€è¦å¯¼å…¥å¯¹æ–¹çš„å®ä½“å¤´æ–‡ä»¶ï¼Œè¿˜æ˜¯æœ‰ä¾èµ–ã€‚</li></ul><p>ç»¼åˆæ¥çœ‹ï¼Œåœ¨è¿›è¡Œç»„ä»¶åŒ–æ—¶ï¼ŒåŸºäºURL-Blockçš„è·¯ç”±æ–¹æ¡ˆåªé€‚åˆç”¨æ¥è¿›è¡Œç®€å•çš„æœ¬åœ°å’Œè¿œç¨‹ç•Œé¢è·³è½¬ï¼Œä½†å…¶Routerè·¯ç”±çš„æ€è·¯æ˜¯å€¼å¾—å€Ÿé‰´çš„ã€‚ä¸‹ä¸€ç¯‡å°†ç»§ç»­ä»‹ç»åŸºäºåå°„åŸç†çš„ç»„ä»¶åŒ–æ–¹æ¡ˆ~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/davidli-/HelModules-URL">Â©URL+Blockæ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/davidli-/DaModules-Hardcore">Â©åå°„æ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/davidli-/DaModule-Protocol">Â©æœåŠ¡åè®®æ³¨å†Œæ–¹æ¡ˆdemo</a></p><p>#<a href="https://github.com/youzan/Bifrost">Â©æœ‰èµBifrost</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¶æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¸¸ç”¨æ¶æ„æ¨¡å¼</title>
    <link href="/2020/09/01/patterns.html"/>
    <url>/2020/09/01/patterns.html</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸€-æ¶æ„æ¨¡å¼"><a href="#ä¸€-æ¶æ„æ¨¡å¼" class="headerlink" title="ä¸€.æ¶æ„æ¨¡å¼"></a>ä¸€.æ¶æ„æ¨¡å¼</h3><h4 id="1-å¼•è¨€"><a href="#1-å¼•è¨€" class="headerlink" title="1.å¼•è¨€"></a>1.å¼•è¨€</h4><blockquote><p>æ¶æ„æ¨¡å¼ï¼Œç”¨äºæè¿°è½¯ä»¶ç³»ç»Ÿé‡Œçš„åŸºæœ¬çš„ç»“æ„ç»„ç»‡æˆ–çº²è¦ã€‚æ¶æ„æ¨¡å¼æä¾›äº†ä¸€äº›å®šä¹‰å¥½çš„å­ç³»ç»Ÿï¼ŒæŒ‡å®šå®ƒä»¬çš„è´£ä»»ï¼Œå¹¶ç»™å‡ºæŠŠå®ƒä»¬ç»„ç»‡åœ¨ä¸€èµ·çš„æ³•åˆ™å’ŒæŒ‡å—ã€‚å¸¸è§çš„æ¶æ„æ¨¡å¼æœ‰ï¼šåˆ†å±‚æ¨¡å¼ã€å¾®æ ¸æ¨¡å¼ã€ç®¡é“ä¸è¿‡æ»¤å™¨ã€MVCæ¨¡å¼ã€RESTæ¨¡å¼ã€SOAæ¨¡å¼ã€‚</p></blockquote><h4 id="2-èµ·æº"><a href="#2-èµ·æº" class="headerlink" title="2.èµ·æº"></a>2.èµ·æº</h4><p>æ¶æ„æ¨¡å¼è¯ç”Ÿäºè½¯ä»¶å¼€å‘çš„æœ€å¤§éš¾é¢˜ï¼šéœ€æ±‚å˜æ›´ã€‚éœ€æ±‚å˜æ›´å¾€å¾€å¯¼è‡´è½¯ä»¶ä»£ç çš„ä¿®æ”¹ã€‚è€Œæœ‰äº›ä»£ç å°¤å…¶æ˜¯ä¸€äº›å¤§å‹ç³»ç»Ÿï¼Œå…¶ä»£ç ç†è§£èµ·æ¥ä¼šéå¸¸å›°éš¾ï¼Œåªæœ‰å½“æ—¶å‚ä¸å¼€å‘çš„äººå‘˜èƒ½çœ‹çš„æ˜ç™½ï¼Œå…¶ä»–äººå¾ˆéš¾æ¥æ‰‹ã€‚è¿™ç§ä»£ç ä¿®æ”¹æ—¶å¾€å¾€ä¼šç¢°åˆ°â€œè§¦ä¸€å‘è€ŒåŠ¨å…¨èº«â€çš„é—®é¢˜ï¼Œç”šè‡³æ”¹å‡ºBUGã€‚</p><p>è¿™ä¸€åˆ‡çš„æ ¹æºï¼Œå…¶å®åªæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„äº‹å®ï¼Œå°±æ˜¯ç³»ç»Ÿä¸­å¯¹äºâ€œä»£ç è€¦åˆâ€çš„ç»“æ„é—®é¢˜ã€‚ç³Ÿç³•çš„ä»£ç è€¦åˆè®©æ•´ä¸ªç³»ç»Ÿå˜å¾—éš¾ä»¥ç†è§£ã€éš¾ä»¥ä¿®æ”¹ã€éš¾ä»¥åˆ†å·¥ã€éš¾ä»¥é›†æˆã€‚é’ˆå¯¹ä»£ç è€¦åˆçš„é—®é¢˜ï¼Œè½¯ä»¶ç•Œè¿›è¡Œäº†å¤§é‡çš„ç†è®ºç ”ç©¶å’Œå®è·µï¼Œæœ€åå‘ç°ï¼šç³»ç»Ÿçš„æ¶æ„è®¾è®¡ï¼Œæ˜¯æ”¹å–„è€¦åˆçš„æœ€å¥½æ–¹å¼ã€‚</p><h4 id="3-ç‰¹ç‚¹"><a href="#3-ç‰¹ç‚¹" class="headerlink" title="3.ç‰¹ç‚¹"></a>3.ç‰¹ç‚¹</h4><p>ä¼˜ç§€æ¶æ„æ¨¡å¼çš„å…±åŒç‚¹:</p><ul><li>ä»»åŠ¡å‡è¡¡åˆ†æ‘Šç»™å…·æœ‰æ¸…æ™°è§’è‰²çš„å®ä½“ï¼›</li><li>é«˜å†…èšã€ä½è€¦åˆï¼›</li><li>é«˜é‡ç”¨æ€§ã€ä½ç»´æŠ¤æˆæœ¬ï¼›</li><li>å¯å•ç‹¬æµ‹è¯•ã€‚</li></ul><h4 id="4-åŒºåˆ†"><a href="#4-åŒºåˆ†" class="headerlink" title="4.åŒºåˆ†"></a>4.åŒºåˆ†</h4><p>åŒºåˆ†ä¸¤ä¸ªåè¯ï¼š<code>æ¶æ„æ¨¡å¼</code>ä¸<code>è®¾è®¡æ¨¡å¼</code>ï¼š</p><p><code>è®¾è®¡æ¨¡å¼</code>æ˜¯ä¸€å¥—è¢«åå¤ä½¿ç”¨çš„ã€å¤šæ•°äººçŸ¥æ™“çš„ã€ç»è¿‡åˆ†ç±»ç¼–ç›®çš„ã€ä»£ç è®¾è®¡ç»éªŒçš„æ€»ç»“ã€‚ä½¿ç”¨è®¾è®¡æ¨¡å¼æ˜¯ä¸ºäº†é‡ç”¨ä»£ç ã€è®©ä»£ç æ›´å®¹æ˜“è¢«ä»–äººç†è§£ã€ä¿è¯ä»£ç å¯é æ€§ã€‚è®¾è®¡æ¨¡å¼ä¸€å…±æœ‰23ç§ï¼Œå¸¸è§çš„æœ‰å·¥å‚æ¨¡å¼ã€å•ä¾‹æ¨¡å¼ã€ä»£ç†æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ç­‰ã€‚</p><p>ä¸€ä¸ªæ„æ¶å¾€å¾€ç”¨åˆ°å¤šä¸ªè®¾è®¡æ¨¡å¼ï¼Œå¦‚<code>mvc</code>æ¶æ„æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼å’Œç»„åˆæ¨¡å¼çš„æ¼”å˜ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_ori_mvc.jpg" alt="ä¼ ç»ŸMVC"></p><p>ä¸Šå›¾æ˜¯ä¼ ç»Ÿçš„<code>MVC</code>æ¶æ„ï¼Œé¡¹ç›®ä¸­çš„ä»£ç è¢«æ•´åˆä¸º<code>è§†å›¾</code>ã€<code>æ¨¡å‹</code>ã€<code>æ§åˆ¶å™¨</code>ä¸‰ä¸ªè§’è‰²ã€‚</p><ul><li>å½“ç”¨æˆ·æ“ä½œä¸€ä¸ªè§†å›¾æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªäº‹ä»¶å¹¶äº¤ç»™æ§åˆ¶å™¨ï¼›</li><li>æ§åˆ¶å™¨æ”¶åˆ°äº‹ä»¶åä¼šé‡‡ç”¨ä¸€ç§<code>ç­–ç•¥</code>ï¼šè¦æ±‚æ¨¡å‹æ›´æ–°æ•°æ®çš„çŠ¶æ€æˆ–è€…è¦æ±‚è§†å›¾æ›´æ–°æ ·å¼ï¼›</li><li>æ¨¡å‹ä¸­æ•°æ®å˜åŒ–ååˆ™ä¼š<code>é€šçŸ¥</code>è§†å›¾æ›´æ–°ç•Œé¢ã€‚</li></ul><h3 id="äºŒ-MVC"><a href="#äºŒ-MVC" class="headerlink" title="äºŒ.MVC"></a>äºŒ.MVC</h3><h4 id="1-Appleç‰ˆMVC"><a href="#1-Appleç‰ˆMVC" class="headerlink" title="1.Appleç‰ˆMVC"></a>1.Appleç‰ˆMVC</h4><p>ä¸Šå›¾æ˜¯ä¼ ç»Ÿçš„MVCæ¨¡å¼ï¼Œè™½ç„¶ä¹ŸåŒºåˆ†äº†ä¸‰ç§è§’è‰²ï¼Œä½†æ˜¯å®ƒä»¬äº’ç›¸ä¹‹é—´éƒ½æœ‰è€¦åˆï¼Œå°¤å…¶æ˜¯æ¨¡å‹å’Œè§†å›¾ä¹‹é—´ã€‚è€Œè§†å›¾å’Œæ¨¡å‹å¾€å¾€æ˜¯æœ€éœ€è¦å¤ç”¨çš„ï¼Œæ‰€ä»¥ï¼Œæœ€åˆç†çš„è®¾è®¡æ˜¯ä¿æŒäºŒè€…çš„ç‹¬ç«‹æ€§ã€‚å› æ­¤ Apple è®¾è®¡äº†è‡ªå·±çš„MVCç‰ˆæœ¬ï¼Œé€šè¿‡æ§åˆ¶å™¨æ¥å®ç°è§†å›¾ä¸æ¨¡å‹çš„è§£è€¦ã€‚</p><h4 id="2-è§’è‰²åˆ’åˆ†"><a href="#2-è§’è‰²åˆ’åˆ†" class="headerlink" title="2.è§’è‰²åˆ’åˆ†"></a>2.è§’è‰²åˆ’åˆ†</h4><p><img src="https://davidlii.nos-eastchina1.126.net/pic_apple_mvc.jpg" alt="cocoaMVC"></p><h5 id="æ¨¡å‹"><a href="#æ¨¡å‹" class="headerlink" title="æ¨¡å‹"></a>æ¨¡å‹</h5><p>æŒæœ‰æ•°æ®ã€å°è£…å¤„ç†æ•°æ®çš„ä¸šåŠ¡é€»è¾‘ï¼Œæä¾›æ•°æ®æ¥å£ç»™ Controllerã€‚ç†æƒ³ä¸­ï¼Œæ¨¡å‹å±‚ä¸åº”ä¸è§†å›¾å±‚æœ‰ä»»ä½•å…³è”ã€‚</p><h5 id="è§†å›¾"><a href="#è§†å›¾" class="headerlink" title="è§†å›¾"></a>è§†å›¾</h5><p>è§†å›¾è´Ÿè´£å±•ç¤ºä¿¡æ¯ï¼ŒåŒ…æ‹¬æ˜¾ç¤ºæ•°æ®å¹¶å…è®¸ç”¨æˆ·ç¼–è¾‘æ•°æ®ï¼Œä½†è§†å›¾ä¸å­˜å‚¨æ•°æ®ã€‚è§†å›¾åº”å¯å¤ç”¨ã€å¯é…ç½®å¹¶ä¿æŒç»Ÿä¸€æ€§ï¼Œä¾‹å¦‚ UIKit ä¸­å®šä¹‰çš„ UIButtonã€‚å› ä¸ºæ¨¡å‹ä¸èƒ½ç»‘å®šåˆ°è§†å›¾ä¸­ï¼Œæ‰€ä»¥è§†å›¾éœ€è¦ä¸€ç§æœºåˆ¶æ¥çŸ¥æ™“æ¨¡å‹ä¸­æ•°æ®çš„å˜åŒ–ã€‚</p><h5 id="æ§åˆ¶å™¨"><a href="#æ§åˆ¶å™¨" class="headerlink" title="æ§åˆ¶å™¨"></a>æ§åˆ¶å™¨</h5><p>æ§åˆ¶å™¨è´Ÿè´£è¿æ¥æ¨¡å‹ä¸è§†å›¾ï¼Œæ‰®æ¼”ç€ä¸­é—´äººçš„è§’è‰²ã€‚æ§åˆ¶å™¨ä¸ºè§†å›¾æä¾›éœ€è¦æ˜¾ç¤ºçš„æ•°æ®ï¼›å“åº”ç”¨æˆ·çš„æ“ä½œå¹¶è°ƒç”¨æ¨¡å‹ä¸­çš„ä¸šåŠ¡é€»è¾‘æ›´æ–°æ•°æ®ï¼›å°†æ•°æ®çš„å˜åŒ–é€šçŸ¥ç»™è§†å›¾ã€‚æ§åˆ¶å™¨ä¹Ÿç”¨æ¥ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®šä¹‰ç›¸å…³ä¸šåŠ¡ä»¥å®ç°ä¸€äº›è®¾ç½®å’ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚</p><p>ä»è§’è‰²åˆ’åˆ†å¯ä»¥çœ‹å‡ºï¼Œç†æƒ³çš„ Cocoa MVC æ¨¡å¼ä¸­ï¼Œæ¨¡å‹ã€æ§åˆ¶å™¨ä¸è§†å›¾ä¸‰å±‚åˆ†å·¥æ˜ç¡®ï¼Œæ¨¡å‹å’Œè§†å›¾ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ§åˆ¶å™¨æ‰®æ¼”äºŒè€…ä¸­é—´äººçš„è§’è‰²ã€‚</p><h4 id="3-ç°å®ä¸­çš„MVC"><a href="#3-ç°å®ä¸­çš„MVC" class="headerlink" title="3.ç°å®ä¸­çš„MVC"></a>3.ç°å®ä¸­çš„MVC</h4><p>ç†æƒ³ä¸­ï¼Œè§†å›¾ä¸æ§åˆ¶å™¨ç›¸äº’ç‹¬ç«‹ã€‚ä½†å®é™…iOSå¼€å‘è¿‡ç¨‹ä¸­ï¼Œå®ƒä»¬æ€»æ˜¯ç»“å¯¹å‡ºç°ï¼Œæ¯ä¸ª<code>ViewController</code>ä¸­éƒ½æœ‰ä¸€ä¸ª<code>View</code>ï¼Œè¿™å°±å¯¼è‡´è§†å›¾å±‚ç´§å¯†è€¦åˆåœ¨æ§åˆ¶å±‚é‡Œã€‚æ§åˆ¶å™¨è¦è´Ÿè´£ç»´æŠ¤è§†å›¾çš„ç”Ÿå‘½å‘¨æœŸï¼Œå“åº”ç”¨æˆ·åœ¨è§†å›¾å±‚çš„æ“ä½œï¼Œå®ç°è¯¸å¦‚<code>Tableview</code>ç­‰è§†å›¾çš„ä»£ç†ç­‰ã€‚ã€‚MVC äº‹å®ä¸Šå˜æˆäº† M-VCã€‚</p><p>ç†æƒ³ä¸­ï¼Œè§†å›¾ä¸æ¨¡å‹ç›¸äº’ç‹¬ç«‹ã€‚ä½†å®é™…ä¸­ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°è¿™æ€»æƒ…å½¢ï¼šåˆå§‹åŒ–<code>cell</code>æ—¶ï¼Œç»å¸¸ä¼šç›´æ¥ä¼ å…¥<code>Model</code>å¯¹è±¡ï¼Œå½¢æˆè§†å›¾ä¸æ¨¡å‹çš„è€¦åˆã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-built_in">UITableViewCell</span> *)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView<br>cellForRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath<br>&#123;<br>    CustomTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:<span class="hljs-string">@&quot;Goods&quot;</span>];<br>    cell.goods = <span class="hljs-keyword">self</span>.dataSource[indexPath.row];<br>    <span class="hljs-keyword">return</span> cell;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç†æƒ³ä¸­ï¼Œæ¨¡å‹åº”è¯¥æŒæœ‰æ•°æ®ã€å°è£…å¤„ç†æ•°æ®çš„ä¸šåŠ¡é€»è¾‘ï¼Œæä¾›æ•°æ®æ¥å£ï¼Œä½†æœ‰äº›å®è·µä¸­ï¼Œæ¨¡å‹è¢«ç®€å•çš„è®¾è®¡ä¸ºåªæœ‰ä¸€äº›å±æ€§çš„ç±»ï¼Œæ•°æ®ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘éƒ½è¢«æ”¾åœ¨äº†æ§åˆ¶å™¨ä¸­ã€‚å½“éœ€è¦ä¿®æ”¹æ•°æ®çš„ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œå¦‚æ›´æ¢ç½‘ç»œé€šè®¯åº“ã€æ›´æ–°jsonè§£ææ—¶çš„æŸä¸ªå­—æ®µï¼Œå°±éœ€è¦åœ¨æ§åˆ¶å™¨ä¸­è¿›è¡Œä¿®æ”¹ã€‚</p><p>ç†æƒ³ä¸­ï¼Œä¸Šé¢çš„<code>cell</code>ä¸å¼•ç”¨æ¨¡å‹å¯¹è±¡ï¼Œé‚£ä¹ˆ<code>cell</code>çš„è®¾ç½®å°±è¦æ”¾åˆ°æ§åˆ¶å™¨ä¸­ï¼Œè¿™ä¼šå¢åŠ æ§åˆ¶å™¨ä¸­çš„ä»£ç é‡ã€‚å¦å¤–ï¼Œç½‘ç»œè¯·æ±‚ã€å·¥å…·æ–¹æ³•ç­‰æ˜¾ç„¶ä¸é€‚åˆæ”¾åœ¨è§†å›¾å’Œæ¨¡å‹å±‚é‡Œï¼Œè€Œä¸€æ—¦æ”¾åœ¨æ§åˆ¶å™¨é‡Œï¼ŒåŒæ ·ä¹Ÿä¼šé€ æˆæ§åˆ¶å™¨çš„è‡ƒè‚¿ã€‚è¿™äº›å°±æ˜¯<code>Massive View Controller</code>çš„ç”±æ¥ï¼Œå½¢è±¡è¡¨ç¤ºå¦‚ä¸‹ï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_mass_controller.png" alt="mass"></p><p>å½“ä¸šåŠ¡é€»è¾‘å’Œå±•ç¤ºé€»è¾‘éƒ½åœ¨æ§åˆ¶å™¨ä¸­æ—¶ï¼Œå°±å¾ˆéš¾è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚æ‰€ä»¥ï¼Œæ§åˆ¶å™¨ä¸­åªåº”å­˜æ”¾ä¸€äº›ä¸èƒ½å¤ç”¨çš„ä»£ç ï¼Œå…¶ä»–ä»£ç å°½é‡åˆ†ç¦»å‡ºå»ã€‚</p><p>ä¸èƒ½å¤ç”¨çš„ä»£ç å¯èƒ½åŒ…æ‹¬ï¼š</p><ul><li>åˆå§‹åŒ–View å’Œ Modelçš„è¯­å¥ï¼›</li><li>æ ¹æ®View å±‚ç”¨æˆ·æ“ä½œè°ƒç”¨ Model å±‚å¤„ç†æ•°æ®çš„è¯­å¥ï¼›</li><li>ç”¨æ¥æ¥æ”¶ Model å±‚æ•°æ®çš„å›è°ƒã€ä»£ç†ï¼Œå’Œé€šçŸ¥ View å±‚æ›´æ–°è§†å›¾çš„é€»è¾‘ï¼›</li></ul><p>å¯åˆ†ç¦»çš„ä»£ç å’Œæ–¹å¼åŒ…æ‹¬ï¼š</p><ul><li>åœ¨è‡ªå®šä¹‰ç±»ä¸­æ­å»ºè§†å›¾ç»“æ„ï¼Œé€šè¿‡ä»£ç†å°†ç”¨æˆ·æ“ä½œå›è°ƒç»™æ§åˆ¶å™¨ï¼›</li><li>å°†è¯¸å¦‚TableViewçš„ä»£ç†æŠ½ç¦»åˆ°å•ç‹¬çš„ç±»ä¸­(å‚è€ƒAFNä¸­è¯·æ±‚å›è°ƒçš„å¤„ç†æ–¹å¼)ï¼›</li><li>å°†è½¬æ¢Modelå±‚å›è°ƒæ•°æ®çš„ä¸šåŠ¡æŠ½ç¦»åˆ°å•ç‹¬çš„ç±»ä¸­ï¼›</li></ul><h3 id="ä¸‰-MVP"><a href="#ä¸‰-MVP" class="headerlink" title="ä¸‰.MVP"></a>ä¸‰.MVP</h3><h4 id="1-è§’è‰²åˆ’åˆ†"><a href="#1-è§’è‰²åˆ’åˆ†" class="headerlink" title="1.è§’è‰²åˆ’åˆ†"></a>1.è§’è‰²åˆ’åˆ†</h4><p><img src="https://davidlii.nos-eastchina1.126.net/pic_arch_mvp.png" alt="iOSæ¶æ„æ¨¡å¼-MVP"></p><h5 id="æ¨¡å‹-1"><a href="#æ¨¡å‹-1" class="headerlink" title="æ¨¡å‹"></a>æ¨¡å‹</h5><p>ä¸ MVC ä¸­çš„æ¨¡å‹ç±»ä¼¼ã€‚</p><h5 id="è§†å›¾-1"><a href="#è§†å›¾-1" class="headerlink" title="è§†å›¾"></a>è§†å›¾</h5><p>ç”±è§†å›¾å’Œæ§åˆ¶å™¨ç»„æˆï¼Œä½œç”¨æœ‰ï¼šç•Œé¢å…ƒç´ å¸ƒå±€å’Œæ‰§è¡ŒåŠ¨ç”»ï¼›å°†ç”¨æˆ·æ“ä½œäº‹ä»¶äº¤ç»™<code>P</code>å±‚å¤„ç†å¹¶å±•ç¤ºå¤„ç†ç»“æœï¼›På±‚ä¸­çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å®Œæ¯•åé€šè¿‡ä»£ç†å‘ŠçŸ¥è§†å›¾åˆ·æ–°ç•Œé¢ï¼›æ§åˆ¶å™¨è´Ÿè´£ç”Ÿæˆè§†å›¾ï¼Œå®ç°è§†å›¾çš„ä»£ç†å’Œæ•°æ®æºä»¥åŠç•Œé¢çš„è·³è½¬ç­‰ã€‚</p><h5 id="På±‚"><a href="#På±‚" class="headerlink" title="På±‚"></a>På±‚</h5><p>æ‰®æ¼”ç€è§†å›¾ä¸æ¨¡å‹ä¸­é—´äººçš„è§’è‰²ï¼Œå®ç°è§†å›¾ä¸æ¨¡å‹çš„è§£è€¦ï¼šå®šä¹‰å“åº”è§†å›¾ä¸­äº‹ä»¶çš„æ¥å£ï¼Œå®ç°äº‹ä»¶å¯¹åº”çš„å¤„ç†é€»è¾‘ï¼›è°ƒç”¨æ¨¡å‹çš„æ¥å£ä»¥è·å–æ•°æ®ï¼ŒåŠ å·¥æ•°æ®å¹¶å°†å…¶å°è£…æˆè§†å›¾é€‚ç”¨çš„æ•°æ®å’ŒçŠ¶æ€ã€‚</p><p>MVP æ˜¯ç”± MVC æ¼”åŒ–è€Œæ¥çš„ï¼Œå®ƒå¯¹ MVC ä¸­çš„æ§åˆ¶å™¨è¿›è¡Œäº†ä¼˜åŒ–è€Œç”Ÿæˆ<code>Presenter</code>ã€‚<code>På±‚</code>å’Œ MVC ä¸­çš„æ§åˆ¶å™¨ä¸€æ ·ï¼Œè´Ÿè´£æ ¸å¿ƒé€»è¾‘ã€‚ä½†ä¸ä¸€æ ·çš„æ˜¯<code>På±‚</code>é€šè¿‡æ¥å£å’Œåè®®è¿›è¡Œæ•°æ®ä¼ é€’ï¼Œä»è€Œä½¿è§†å›¾å’Œæ¨¡å‹è§£è€¦ï¼Œæ›´åŠ ä¸“æ³¨äºè‡ªèº«ä¸šåŠ¡é€»è¾‘ã€‚åŒæ—¶ï¼Œå› ä¸ºä¸»è¦çš„é€»è¾‘åœ¨<code>På±‚</code>ï¼Œæ‰€ä»¥å¯ä»¥æ–¹ä¾¿çš„å¯¹å…¶è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚</p><h4 id="2-ç¤ºä¾‹"><a href="#2-ç¤ºä¾‹" class="headerlink" title="2.ç¤ºä¾‹:"></a>2.ç¤ºä¾‹:</h4><p>æ¥ä¸‹æ¥æ¼”ç¤ºçš„æ˜¯ä¸€ä¸ªç®€å•åœºæ™¯ï¼šè¯·æ±‚åŠ è½½ä¸€é¡µæ•°æ®ï¼›è¿›åº¦æŒ‡ç¤ºå™¨æ ¹æ®åŠ è½½çŠ¶æ€æ˜¾ç¤º&#x2F;éšè—ã€‚</p><h5 id="Vå±‚"><a href="#Vå±‚" class="headerlink" title="Vå±‚"></a>Vå±‚</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;ViewController.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Presenter.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;UserViewProtocol.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span><br>&lt;UserViewProtocol,<br><span class="hljs-built_in">UITableViewDataSource</span>&gt;<br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSArray</span> *friendlyUIData;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">strong</span>) Presenter *presenter;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UITableView</span> *tableview;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UIActivityIndicatorView</span> *indicator;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad<br>&#123;<br>[<span class="hljs-variable language_">super</span> viewDidLoad];<br><span class="hljs-keyword">self</span>.presenter = [Presenter new];   <span class="hljs-comment">//æŒæœ‰På±‚å¯¹è±¡</span><br>[<span class="hljs-keyword">self</span>.presenter confDelegate:<span class="hljs-keyword">self</span>]; <span class="hljs-comment">//è®¾ç½®ä»£ç†</span><br>[<span class="hljs-keyword">self</span>.presenter fetchData];         <span class="hljs-comment">//å‘På±‚å‘é€å‘½ä»¤</span><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -Tableview datasource</span><br>- (<span class="hljs-built_in">NSInteger</span>)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView <br>numberOfRowsInSection:(<span class="hljs-built_in">NSInteger</span>)section<br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.friendlyUIData.count;<br>&#125;<br><br>- (<span class="hljs-built_in">UITableViewCell</span> *)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView<br>         cellForRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath<br>&#123;<br><span class="hljs-built_in">UITableViewCell</span> *cell = [tableView <br>dequeueReusableCellWithIdentifier:<span class="hljs-string">@&quot;cell&quot;</span> forIndexPath:indexPath];<br>cell.textLabel.text = [<span class="hljs-keyword">self</span>.friendlyUIData[indexPath.row] <br>valueForKey:<span class="hljs-string">@&quot;name&quot;</span>];<br><br><span class="hljs-keyword">return</span> cell;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -UserView Protocol</span><br><br><span class="hljs-comment">//På±‚çš„ä»£ç†æ–¹æ³•</span><br>-(<span class="hljs-type">void</span>)userViewDataSource:(<span class="hljs-built_in">NSArray</span>*)data<br>&#123;<br><span class="hljs-keyword">self</span>.friendlyUIData = data;  <span class="hljs-comment">//é€šè¿‡ä»£ç†å›è°ƒï¼Œæ”¶åˆ°På±‚è¿”å›çš„æ•°æ®</span><br>[<span class="hljs-keyword">self</span>.tableview reloadData]; <span class="hljs-comment">//æ›´æ–°UI</span><br>&#125;<br><br>-(<span class="hljs-type">void</span>) showIndicator<br>&#123;<br><span class="hljs-keyword">self</span>.indicator.hidden = <span class="hljs-literal">NO</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>) hideIndicator<br>&#123;<br><span class="hljs-keyword">self</span>.indicator.hidden = <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>ViewController</code>ä¸å…¶ä¸­çš„<code>tableview</code>å…±åŒæ„æˆäº† MVP ä¸­çš„è§†å›¾å±‚ï¼Œè´Ÿè´£ç•Œé¢çš„æ˜¾ç¤ºå’Œæ›´æ–°ã€‚å®ƒå®ç°äº†<code>tableview</code>çš„åè®®åŠç”¨æˆ·äº¤äº’çš„åè®®<code>UserViewProtocol</code>ã€‚å®ƒä¼šç­‰å¾… <code>Presenter</code>çš„å‘½ä»¤æ¥è¢«åŠ¨çš„æ›´æ–°UIã€‚</p><h5 id="På±‚-1"><a href="#På±‚-1" class="headerlink" title="På±‚"></a>På±‚</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//Presenter.h</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;UserViewProtocol.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Presenter</span> : <span class="hljs-title">NSObject</span></span><br>-(<span class="hljs-type">void</span>)confDelegate:(<span class="hljs-type">id</span> &lt;UserViewProtocol&gt;)view;<br>-(<span class="hljs-type">void</span>)fetchData;<span class="hljs-comment">//æ¨¡æ‹Ÿè·å–ç½‘ç»œæ•°æ®</span><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>Presenterä¸­å®šä¹‰å¤–éƒ¨æ¥å£ï¼Œä¾›Viewå±‚è°ƒç”¨ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//Presenter.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Presenter.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;UserService.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Presenter</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">strong</span>) UserService *userService;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">weak</span>) <span class="hljs-type">id</span> &lt;UserViewProtocol&gt; mDelegate;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Presenter</span></span><br><br>- (<span class="hljs-type">void</span>)confDelegate:(<span class="hljs-type">id</span>&lt;UserViewProtocol&gt;)view<br>&#123;<br><span class="hljs-keyword">self</span>.mDelegate = view;<br><span class="hljs-keyword">self</span>.userService  = [UserService new];<br>&#125;<br><br>-(<span class="hljs-type">void</span>)fetchData&#123;<br>[<span class="hljs-keyword">self</span> getUserDatas];<br>&#125;<br><br>-(<span class="hljs-type">void</span>)getUserDatas&#123;<br>[<span class="hljs-keyword">self</span>.mDelegate showIndicator];<br>    <span class="hljs-comment">//è°ƒç”¨Må±‚ï¼Œæ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚</span><br>[_userService getUserInfosSuccess:^(<span class="hljs-built_in">NSDictionary</span> *dic)<br>    &#123;<br>        <span class="hljs-comment">//è·å–åˆ°æ•°æ® é€šçŸ¥Viewå±‚æ›´æ–°UI</span><br>[<span class="hljs-keyword">self</span>.mDelegate hideIndicator];<br>[<span class="hljs-keyword">self</span>.mDelegate userViewDataSource:[<span class="hljs-keyword">self</span> processOriginDataToUIFriendlyData:userArr]];<br>&#125; andFail:^(<span class="hljs-built_in">NSDictionary</span> *dic) &#123;<br>&#125;];<br>&#125;<br><br><span class="hljs-comment">//å¤„ç†æ•°æ®ï¼Œè¾“å‡ºæˆUIéœ€è¦çš„æ•°æ®</span><br>-(<span class="hljs-built_in">NSArray</span> *)processOriginDataToUIFriendlyData:(<span class="hljs-built_in">NSArray</span> *) originData<br>&#123;<br><span class="hljs-comment">//ç•¥..</span><br><span class="hljs-keyword">return</span> friendlyUIData;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„-confDelegateæ–¹æ³•ä¸­æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p><ul><li>å°†å®ç°äº†<code>UserViewProtocol</code>åè®®çš„å¯¹è±¡ç»‘å®šåˆ° Presenter ä¸Šã€‚</li><li>æŒæœ‰ä¸€ä¸ª<code>Må±‚</code>å¯¹è±¡(UserService)ä»¥å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//UserViewProtocol.h</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">UserViewProtocol</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span><br><br>-(<span class="hljs-type">void</span>) userViewDataSource:(<span class="hljs-built_in">NSArray</span>*)data;<br>-(<span class="hljs-type">void</span>) showIndicator;<br>-(<span class="hljs-type">void</span>) hideIndicator;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªåè®®æ˜¯På±‚çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­å®šä¹‰çš„æ–¹æ³•å°±æ˜¯<code>På±‚</code>å¯¹<code>è§†å›¾</code>å±‚å‘é€çš„å‘½ä»¤ã€‚<code>View</code>å±‚å®ç°äº†æ­¤åè®®ï¼Œåœ¨<code>Model</code>å±‚æ‹¿åˆ°æ•°æ®å¹¶é€šè¿‡blockè¿”å›ç»™<code>På±‚</code>åï¼Œ<code>På±‚</code>ä¼šé€šè¿‡ä»£ç†ï¼Œé€šçŸ¥<code>View</code>å±‚æ›´æ–°UIã€‚</p><h5 id="Må±‚"><a href="#Må±‚" class="headerlink" title="Må±‚"></a>Må±‚</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//UserService.h</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>(^SuccessHandler)(<span class="hljs-built_in">NSDictionary</span> *dic);<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>(^FailHandler)(<span class="hljs-built_in">NSDictionary</span> *dic);<br><br><span class="hljs-comment">//Modelå±‚ï¼Œç”¨æ¥å‘èµ·ç½‘ç»œè¯·æ±‚å¹¶è¿”å›æ•°æ®ç»™Presenterã€‚</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">UserService</span> : <span class="hljs-title">NSObject</span></span><br>-(<span class="hljs-type">void</span>)getUserInfosSuccess:(SuccessHandler )success andFail:(FailHandler) fail;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//UserService.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;UserService.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">UserService</span></span><br><br>-(<span class="hljs-type">void</span>)getUserInfosSuccess:(SuccessHandler )success <br>andFail:(FailHandler) fail<br>&#123;<br><span class="hljs-built_in">NSArray</span>  *result =@[@&#123;<span class="hljs-string">@&quot;name&quot;</span>:<span class="hljs-string">@&quot;Tom&quot;</span>,<span class="hljs-string">@&quot;age&quot;</span>:@<span class="hljs-number">25</span>&#125;];<br>dispatch_after(dispatch_time(<br>                                 DISPATCH_TIME_NOW, <br>                                 (int64_t)(<span class="hljs-number">2</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>)),<br>                   dispatch_get_main_queue(), ^&#123;<br>success(@&#123;<span class="hljs-string">@&quot;data&quot;</span>:result&#125;);<br>&#125;);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>UserServiceå±äº<code>Må±‚</code>ï¼Œç”¨æ¥è¯·æ±‚æ•°æ®ç»™<code>På±‚</code>ã€‚å½“<code>Må±‚</code>æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚è¿”å›æ•°æ®ï¼‰ï¼Œé€šè¿‡<code>block</code>å›è°ƒç»™<code>På±‚</code>ï¼Œ<code>På±‚</code>å†å°†å¤„ç†åçš„æ•°æ®é€šè¿‡<code>ä»£ç†</code>åé¦ˆç»™<code>Viewå±‚</code>å¹¶ç”±åè€…æ›´æ–°ç•Œé¢ã€‚</p><p>ä»¥ä¸Šç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ MVP ä¼šå¢åŠ ä»£ç é‡ï¼Œä½†æ˜¯æ€»ä½“ä¸ŠèŒè´£æ¸…æ™°ï¼Œå„å±‚é€šè¿‡å®šä¹‰çš„APIã€ä»£ç†æˆ–blockå›è°ƒè¿›è¡Œé€šä¿¡ï¼Œå‡å°‘äº†ä»£ç çš„å¤æ‚æ€§ã€‚</p><h3 id="ä¸‰-MVVM"><a href="#ä¸‰-MVVM" class="headerlink" title="ä¸‰.MVVM"></a>ä¸‰.MVVM</h3><h4 id="1-è§’è‰²åˆ’åˆ†-1"><a href="#1-è§’è‰²åˆ’åˆ†-1" class="headerlink" title="1.è§’è‰²åˆ’åˆ†"></a>1.è§’è‰²åˆ’åˆ†</h4><p><img src="https://davidlii.nos-eastchina1.126.net/pic_arch_mvvm.png" alt="image"></p><h5 id="æ¨¡å‹-2"><a href="#æ¨¡å‹-2" class="headerlink" title="æ¨¡å‹"></a>æ¨¡å‹</h5><p>ä¸ MVP ä¸­çš„æ¨¡å‹ç±»ä¼¼ã€‚</p><h5 id="è§†å›¾-2"><a href="#è§†å›¾-2" class="headerlink" title="è§†å›¾"></a>è§†å›¾</h5><p>View+Controllerç»„æˆï¼Œè´Ÿè´£æ˜¾ç¤ºUIã€‚ç»‘å®š<code>ViewModel</code>ä¸­çš„å±æ€§ï¼Œè§¦å‘<code>ViewModel</code>ä¸­çš„å‘½ä»¤ã€‚</p><h5 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h5><p>è´Ÿè´£ç”¨æˆ·è¾“å…¥å†…å®¹çš„éªŒè¯é€»è¾‘ï¼ˆå¦‚ç”¨æˆ·åã€å¯†ç çš„åˆæ³•æ€§ï¼‰ï¼›è§†å›¾æ˜¾ç¤ºé€»è¾‘ï¼›æš´éœ²å…¬å¼€çš„å±æ€§å’Œå‘½ä»¤ä¾›<code>Vå±‚</code>è¿›è¡Œç»‘å®šï¼›å‘èµ·ç½‘ç»œè¯·æ±‚ï¼Œä»<code>Modelå±‚</code>è·å–<code>Vå±‚</code>æ‰€éœ€çš„æ•°æ®ï¼Œè½¬æ¢æˆ<code>Vå±‚</code>å¯ä»¥å±•ç¤ºçš„æ•°æ®ï¼ˆå¦‚TableView çš„ DataSourceï¼‰ã€‚</p><h5 id="Binder"><a href="#Binder" class="headerlink" title="Binder"></a>Binder</h5><p>åœ¨ MVVM ä¸­ï¼Œå£°æ˜å¼çš„æ•°æ®å’Œå‘½ä»¤ç»‘å®šæ˜¯ä¸€ä¸ªéšå«çš„çº¦å®šï¼Œå®ƒå¯ä»¥è®©å¼€å‘è€…éå¸¸æ–¹ä¾¿åœ°å®ç°<code>è§†å›¾å±‚</code>å’Œ<code>ViewModel</code>çš„åŒæ­¥ï¼Œé¿å…ç¼–å†™å¤§é‡ç¹æ‚çš„èƒ¶æ°´ä»£ç ã€‚è‘—åçš„RACåº“æ­£æä¾›äº†è¿™ç§ç»‘å®šèƒ½åŠ›ã€‚</p><h4 id="2-è§’è‰²ç»†è§£"><a href="#2-è§’è‰²ç»†è§£" class="headerlink" title="2.è§’è‰²ç»†è§£"></a>2.è§’è‰²ç»†è§£</h4><h5 id="æ•°æ®ç»‘å®š"><a href="#æ•°æ®ç»‘å®š" class="headerlink" title="æ•°æ®ç»‘å®š"></a>æ•°æ®ç»‘å®š</h5><p>MVVMæ˜¯å¾®è½¯æå‡ºçš„ï¼Œæ˜¯åœ¨ MVP çš„åŸºç¡€ä¸Šå‘å±•èµ·æ¥çš„ã€‚å› æ­¤ï¼ŒMVVM å„å±‚çš„èŒè´£åŸºæœ¬ä¸Šä¸ MVP çš„ç±»ä¼¼ï¼Œå…¶ä¸­<code>VM</code>å¯¹åº”<code>På±‚</code>ã€‚MVVM ç›¸å¯¹äº MVP æ”¹è‰¯äº†ä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ <code>æ•°æ®ç»‘å®š</code>ã€‚</p><p>åœ¨ MVP ä¸­ï¼Œä»ç”¨æˆ·ç‚¹å‡»å¼€å§‹ï¼Œä¸€ä¸ªå®Œæ•´çš„å“åº”æµç¨‹æ˜¯ï¼š<code>è§†å›¾</code>è°ƒç”¨<code>På±‚</code>å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œ<code>På±‚</code>è°ƒç”¨<code>æ¨¡å‹</code>å¤„ç†æ•°æ®ï¼Œå¤„ç†å®Œæˆå <code>På±‚</code>å†é€šè¿‡ä»£ç†å›è°ƒ<code>è§†å›¾</code>ã€‚è¿™é‡Œè¦åå¤åŒæ­¥<code>På±‚</code>çš„çŠ¶æ€ï¼Œå½“äº‹ä»¶å¤šèµ·æ¥æ—¶è¿™æ ·å†™å°±æœ‰ç‚¹éº»çƒ¦ã€‚</p><p>è€Œåœ¨ MVVM ä¸­ï¼Œ <code>View</code>ä¸<code>VMå±‚</code>ä¹‹é—´å¤šäº†æ•°æ®ç»‘å®šçš„æ“ä½œï¼Œè¿™æ„å‘³ç€å½“<code>VMå±‚</code>çš„æ•°æ®å˜åŒ–æ—¶ï¼Œä½ åªéœ€è¦æ›´æ–°<code>VMå±‚</code>çš„æŸä¸ªå±æ€§ï¼Œé‚£ä¹ˆç»‘å®šäº†è¯¥å±æ€§çš„<code>Vå±‚</code>ä¼šç›¸åº”çš„æ›´æ–°UIï¼Œè‡ªåŠ¨å®ç°çŠ¶æ€çš„åŒæ­¥ã€‚</p><h5 id="ViewModel-1"><a href="#ViewModel-1" class="headerlink" title="ViewModel"></a>ViewModel</h5><p>MVVM æ¨¡å¼ä¸­ï¼Œ<code>ViewModel</code>å­˜åœ¨çš„ç›®çš„åœ¨äºæŠ½ç¦»<code>Controller</code>ä¸­çš„å±•ç¤ºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯ä»£æ›¿<code>Controller</code>æœ¬èº«ã€‚æ‰€ä»¥å®ƒä¸è´Ÿè´£è§†å›¾çš„æ“ä½œï¼Œä¹Ÿå°±ä¸éœ€è¦æŒæœ‰ä»»ä½•çš„è§†å›¾å¯¹è±¡ï¼Œæ›´ä¸èƒ½åŒ…å«è§†å›¾çš„<code>push/present</code>ç­‰è·³è½¬é€»è¾‘ã€‚è¿™é‡Œï¼ŒController è¦åšçš„ä»…æ˜¯å°†<code>è§†å›¾</code>å’Œ<code>ViewModel</code>è¿›è¡Œç»‘å®šï¼ŒåŒæ—¶ç®¡ç†å„ä¸ª<code>è§†å›¾</code>ã€‚æ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬çš„ MVVM ä¹Ÿå¯ä»¥çœ‹æˆ<code>M-VM-C-V</code>ã€‚</p><h4 id="3-ç¤ºä¾‹1-OC"><a href="#3-ç¤ºä¾‹1-OC" class="headerlink" title="3.ç¤ºä¾‹1:OC"></a>3.ç¤ºä¾‹1:OC</h4><p>åœºæ™¯ï¼šç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼Œè¯·æ±‚æ•°æ®ï¼›è¿›åº¦æŒ‡ç¤ºå™¨æ ¹æ®è¯·æ±‚çŠ¶æ€æ˜¾ç¤º&#x2F;éšè—ï¼›</p><h5 id="Viewå±‚ä¸ç»‘å®š"><a href="#Viewå±‚ä¸ç»‘å®š" class="headerlink" title="Viewå±‚ä¸ç»‘å®š"></a>Viewå±‚ä¸ç»‘å®š</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewControllerII</span> ()</span><br>&lt;<span class="hljs-built_in">UITableViewDataSource</span>,<br><span class="hljs-built_in">UITableViewDelegate</span>&gt;<br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UITableView</span> *mTableview;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UIActivityIndicatorView</span> *mIndicator;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) RACViewModel *mViewModel; <span class="hljs-comment">//VMå¯¹è±¡</span><br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewControllerII</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    [<span class="hljs-keyword">self</span> setUps];        <span class="hljs-comment">//è®¾ç½®UI</span><br>    [<span class="hljs-keyword">self</span> bindViewModel]; <span class="hljs-comment">//åˆ›å»ºVMå¹¶ç»‘å®šå…¶å±æ€§</span><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -BUsiness</span><br><br>- (<span class="hljs-type">void</span>)setUps&#123;<br>    <br>    _mIndicator.hidden = <span class="hljs-literal">YES</span>;<br>    <br>    <span class="hljs-built_in">UIButton</span> *btn = [<span class="hljs-built_in">UIButton</span> buttonWithType:<span class="hljs-built_in">UIButtonTypeCustom</span>];<br>    [btn setTitle:<span class="hljs-string">@&quot;reload&quot;</span> forState:<span class="hljs-built_in">UIControlStateNormal</span>];<br>    [btn setTitleColor:[<span class="hljs-built_in">UIColor</span> blackColor] forState:<span class="hljs-built_in">UIControlStateNormal</span>];<br>    [btn sizeToFit];<br><br>    <span class="hljs-comment">//ç›‘å¬åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶</span><br>    [[btn rac_signalForControlEvents:<span class="hljs-built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        @strongify(<span class="hljs-keyword">self</span>)<br>        <br>        <span class="hljs-keyword">self</span>.mIndicator.hidden = <span class="hljs-literal">NO</span>;<br>        [<span class="hljs-keyword">self</span>.mViewModel.fetchCommand execute:<span class="hljs-literal">nil</span>];<span class="hljs-comment">//æ‰§è¡ŒViewModelä¸­çš„RACCommand</span><br>    &#125;];<br>    <span class="hljs-keyword">self</span>.navigationItem.rightBarButtonItem = [[<span class="hljs-built_in">UIBarButtonItem</span> alloc] initWithCustomView:btn];<br>    <br>    <span class="hljs-keyword">self</span>.mTableview.tableFooterView = [[<span class="hljs-built_in">UIView</span> alloc] initWithFrame:<span class="hljs-built_in">CGRectZero</span>];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)bindViewModel&#123;<br>    <br>    <span class="hljs-comment">//ç›‘å¬VMçš„canReloadå­—æ®µ</span><br>    @weakify(<span class="hljs-keyword">self</span>)<br>    [RACObserve(<span class="hljs-keyword">self</span>.mViewModel, canReload) subscribeNext:^(<span class="hljs-type">id</span> x) &#123;<br>        @strongify(<span class="hljs-keyword">self</span>);<br>        [<span class="hljs-keyword">self</span>.mTableview canReload];<br>        <span class="hljs-keyword">self</span>.mIndicator.hidden = <span class="hljs-literal">YES</span>;<br>    &#125;];<br><br>    <span class="hljs-comment">//ç›‘å¬è¿›åº¦æŒ‡ç¤ºå™¨çš„hiddenå±æ€§ åŒæ­¥åŠ¨ç”»çŠ¶æ€</span><br>    [RACObserve(<span class="hljs-keyword">self</span>.mIndicator, hidden) subscribeNext:^(<span class="hljs-built_in">NSNumber</span> *hiddenNum) &#123;<br>        @strongify(<span class="hljs-keyword">self</span>);<br>        <span class="hljs-type">BOOL</span> hidden = hiddenNum.boolValue;<br>        <span class="hljs-keyword">if</span> (hidden) &#123;<br>            [<span class="hljs-keyword">self</span>.mIndicator stopAnimating];<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            [<span class="hljs-keyword">self</span>.mIndicator startAnimating];<br>        &#125;<br>    &#125;];<br>&#125;<br><br>- (RACViewModel *)mViewModel&#123;<br>    <span class="hljs-keyword">if</span> (!_mViewModel) &#123;<br>        _mViewModel = [[RACViewModel alloc] init];<br>    &#125;<br>    <span class="hljs-keyword">return</span> _mViewModel;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -Tableview Data&amp;Delegate</span><br>-(<span class="hljs-built_in">NSInteger</span>)numberOfSectionsInTableView:(<span class="hljs-built_in">UITableView</span> *)tableView&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br>-(<span class="hljs-built_in">NSInteger</span>)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="hljs-built_in">NSInteger</span>)section&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.mViewModel.cellNums; <span class="hljs-comment">//è®¡ç®—ä¸šåŠ¡äº¤ç»™ViewModelå¤„ç†</span><br>&#125;<br><br>-(<span class="hljs-built_in">UITableViewCell</span> *)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath&#123;<br>    <span class="hljs-built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:<span class="hljs-string">@&quot;cell&quot;</span>];<br>    <span class="hljs-built_in">UILabel</span> *label = [cell viewWithTag:<span class="hljs-number">1</span>];<br>    <span class="hljs-comment">//ç”±VMå¤„ç†æ•°æ®è½¬æ¢ä¸šåŠ¡</span><br>    label.text = [<span class="hljs-keyword">self</span>.mViewModel convertedTextAtIndexPath:indexPath];<br><br>    <span class="hljs-keyword">return</span> cell;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯<code>View</code>å±‚ï¼Œç”±ViewControllerä¸å…¶ä¸­çš„tableViewã€æŒ‰é’®ã€è¿›åº¦å°èŠèŠ±å…±åŒç»„æˆï¼›</p><p>è¿™é‡Œåˆ›å»ºå¹¶æŒæœ‰<code>VM</code>å±‚å¯¹è±¡<code>mViewModel</code>ï¼ŒåŒæ—¶ç»‘å®šäº†VMå±‚çš„å±æ€§(canReload)ï¼›</p><p>ç‚¹å‡»æŒ‰é’®å³ä¼šå‘<code>VM</code>å±‚çš„<code>fetchCommand</code>å‘é€æŒ‡ä»¤è¯·æ±‚æ•°æ®ï¼›</p><p><code>VM</code>å±‚æ‹¿åˆ°æ•°æ®åï¼Œ<code>View</code>å±‚ä¸å†éœ€è¦ä»£ç†æˆ–blockï¼Œè€Œæ˜¯ç›´æ¥åœ¨è®¢é˜…çš„<code>VM</code>å±‚ä¿¡å·å›è°ƒä¸­æ›´æ–°UIï¼›</p><p>æ›´æ–°UIæ‰€éœ€çš„æ•°æ®åŠå…¶è½¬æ¢ç­‰ä¸šåŠ¡é€»è¾‘å‡äº¤ç”±<code>VM</code>å±‚å¤„ç†ã€‚</p><h5 id="ViewModel-2"><a href="#ViewModel-2" class="headerlink" title="ViewModel"></a>ViewModel</h5><p>å¤´æ–‡ä»¶ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;RACCommand.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;RACSignal.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RACViewModel</span> : <span class="hljs-title">NSObject</span></span><br><br><span class="hljs-comment">//å±æ€§å¯¹å¤–åªè¯» ä¾›Viewå±‚ç»‘å®šç›‘å¬</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readonly</span>) <span class="hljs-built_in">NSUInteger</span> cellNums;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readonly</span>) <span class="hljs-type">BOOL</span> canReload;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">strong</span>) RACCommand *fetchCommand; <span class="hljs-comment">//å¯¹å¤–æä¾›çš„æŒ‡ä»¤</span><br><br>- (<span class="hljs-built_in">NSString</span>*)convertedTextAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span>*)indexPath;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>mæ–‡ä»¶ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;ReactiveCocoa.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;RACHttpRequestManager.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;RACEXTScope.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;RACModel.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RACViewModel</span>()</span><br><span class="hljs-comment">//å±æ€§å¯¹å†…å¯è¯»å¯å†™</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readwrite</span>) <span class="hljs-built_in">NSUInteger</span> cellNums;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readwrite</span>) <span class="hljs-type">BOOL</span> canReload;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readwrite</span>, <span class="hljs-keyword">strong</span>) RACCommand *fetchCommand;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSArray</span> *mItemsArr;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RACViewModel</span></span><br><br>- (<span class="hljs-keyword">instancetype</span>)init<br>&#123;<br>    <span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-comment">//åˆ›å»ºæŒ‡ä»¤</span><br>        <span class="hljs-keyword">self</span>.fetchCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="hljs-type">id</span> input) &#123;<br>            <span class="hljs-comment">//è¿”å›Må±‚è¯·æ±‚æ•°æ®çš„ä¿¡å·</span><br>            <span class="hljs-keyword">return</span> [[RACHttpRequestManager shareManager] fetchRequest];<br>        &#125;];<br><br>        <span class="hljs-comment">//è®¢é˜…Må±‚è¿”å›çš„ä¿¡å·</span><br>        @weakify(<span class="hljs-keyword">self</span>)<br>        [[<span class="hljs-keyword">self</span>.fetchCommand.executionSignals switchToLatest] subscribeNext:^(<span class="hljs-built_in">NSArray</span> *dataArr) &#123;<br>            @strongify(<span class="hljs-keyword">self</span>)<br>            <span class="hljs-keyword">if</span> (dataArr) &#123;<br>                <span class="hljs-keyword">self</span>.mItemsArr = dataArr;<br>            &#125;<br>        &#125;];<br><br>        <span class="hljs-comment">//ç›‘å¬æ•°æ®æºå˜åŒ–</span><br>        [RACObserve(<span class="hljs-keyword">self</span>, mItemsArr) subscribeNext:^(<span class="hljs-built_in">NSArray</span> *x) &#123;<br>            @strongify(<span class="hljs-keyword">self</span>)<br>            <span class="hljs-keyword">self</span>.cellNums = x.count;<br>            <span class="hljs-keyword">self</span>.canReload = <span class="hljs-literal">YES</span>;<span class="hljs-comment">//ä¿®æ”¹Vå±‚ç»‘å®šçš„å±æ€§ï¼Œè§¦å‘Vå±‚æ›´æ–°TableView</span><br>        &#125;];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br><span class="hljs-comment">//å¤„ç†Vå±‚çš„æ•°æ®è½¬æ¢ä¸šåŠ¡</span><br>- (<span class="hljs-built_in">NSString</span> *)convertedTextAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath<br>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">self</span>.mItemsArr.count) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">@&quot;0&quot;</span>;<br>    &#125;<br>    RACModel *model = <span class="hljs-keyword">self</span>.mItemsArr[indexPath.row];<br>    <span class="hljs-built_in">NSString</span> *str = model.title;<br>    <span class="hljs-keyword">return</span> [str <span class="hljs-keyword">copy</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯<code>ViewModel</code>å±‚ï¼Œå®šä¹‰äº†ä¸€äº›å±æ€§ä¾›<code>View</code>å±‚ç»‘å®šå’Œç›‘å¬ï¼›</p><p>åŒæ—¶å®šä¹‰äº†å¤„ç†<code>View</code>å±‚æ•°æ®è½¬æ¢çš„ä¸šåŠ¡é€»è¾‘ï¼›</p><p>å½“æ”¶åˆ°<code>View</code>å±‚äº¤äº’æŒ‡ä»¤åï¼Œæœ¬å±‚ä¼šè°ƒç”¨<code>Model</code>å±‚å»è¯·æ±‚æ•°æ®ï¼Œå¹¶åœ¨ä¿¡å·å›è°ƒä¸­å¤„ç†æ•°æ®;</p><p>é€šè¿‡ä¿®æ”¹å¯¹å¤–æš´éœ²çš„å±æ€§å­—æ®µ(self.canReload)ï¼Œé€šçŸ¥<code>View</code>å±‚æ›´æ–°UIï¼›</p><h5 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h5><p>Modelå®ä½“ç±»ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@interface</span> <span class="hljs-attribute">RACModel </span>: NSObject<br><span class="hljs-variable">@property</span> (nonatomic, copy) NSString *title;<br><span class="hljs-variable">@end</span><br><br><span class="hljs-variable">@implementation</span> RACModel<br><br><span class="hljs-variable">@end</span><br></code></pre></td></tr></table></figure><p>æ•°æ®è¯·æ±‚ç±».hï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;RACModel.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ReactiveCocoa.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;AFHTTPRequestOperationManager+RACSupport.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RACHttpRequestManager</span> : <span class="hljs-title">AFHTTPRequestOperationManager</span></span><br><br>+ (<span class="hljs-keyword">instancetype</span>)shareManager;<br>- (RACSignal*)fetchRequest;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ•°æ®è¯·æ±‚.mï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;RACHttpRequestManager.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;RACModel.h&quot;</span></span><br><br><span class="hljs-keyword">static</span> RACHttpRequestManager *mManager;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RACHttpRequestManager</span></span><br><br>+ (<span class="hljs-keyword">instancetype</span>)shareManager<br>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br>        mManager = [[<span class="hljs-keyword">self</span> alloc] init];<br>    &#125;);<br>    <span class="hljs-keyword">return</span> mManager;<br>&#125;<br><br>- (RACSignal*)fetchRequest<br>&#123;<br>    RACSignal *s = [RACSignal createSignal:^RACDisposable *(<span class="hljs-type">id</span>&lt;RACSubscriber&gt; subscriber) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++on RACSignal in fetch~&quot;</span>);<br>        <span class="hljs-comment">//æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚ 5ç§’åè¿”å›æ•°æ®</span><br>        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number">5</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++Http responsed!&quot;</span>);<br>            <span class="hljs-built_in">NSMutableArray</span> *mutArr = [<span class="hljs-built_in">NSMutableArray</span> arrayWithCapacity:<span class="hljs-number">15</span>];<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) &#123;<br>                RACModel *model = [[RACModel alloc] init];<br>                model.title = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;%d&quot;</span>,i];<br>                [mutArr addObject:model];<br>            &#125;<br>            [subscriber sendNext:mutArr];<br>        &#125;);<br>        <span class="hljs-keyword">return</span> [RACDisposable disposableWithBlock:^&#123;<br>        &#125;];<br>    &#125;];<br>    <br>    <span class="hljs-keyword">return</span> s;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ•°æ®è¯·æ±‚çš„å·¥å…·ç±»ï¼Œæ˜¯<code>Model</code>å±‚çš„ä¸€éƒ¨åˆ†ï¼Œå¯¹å¤–æä¾›äº†æ•°æ®è¯·æ±‚çš„ä¿¡å·<code>fetchRequest</code>ä»¥ä¾›è®¢é˜…ã€‚æ•°æ®è¿”å›åè¢«è§£ææˆ<code>RACModel</code>å®ä½“æ•°ç»„ï¼›<code>VM</code>é€šè¿‡å…¶å†…éƒ¨çš„è®¢é˜…å›è°ƒæ”¶åˆ°è¿™ä¸ªæ•°ç»„ï¼Œä¿®æ”¹<code>View</code>å±‚ç»‘å®šçš„å¯¹åº”å±æ€§ï¼Œé€šçŸ¥<code>View</code>å±‚æ›´æ–°UIã€‚</p><p>â†’ä»¥ä¸Šå®è·µä¸­ï¼Œ<code>View</code>å±‚æŒæœ‰<code>ViewModel</code>å¹¶ç»‘å®šå…¶æš´éœ²çš„å±æ€§ï¼›â†“</p><p>â†’<code>ViewModel</code>æŒæœ‰<code>Model</code>å±‚å®ä¾‹ï¼Œå¹¶è®¢é˜…äº†å…¶è¯·æ±‚æ•°æ®çš„ä¿¡å·ï¼›â†“</p><p>â†’å½“ç”¨æˆ·ç‚¹å‡»reloadæŒ‰é’®åï¼Œ<code>ViewModel</code>å±‚æ”¶åˆ°æŒ‡ä»¤å¹¶é€šè¿‡<code>Model</code>å±‚è¯·æ±‚æ•°æ®ï¼›â†“</p><p>â†’<code>Model</code>å±‚åœ¨è¯·æ±‚çš„æ•°æ®è¿”å›åé€šè¿‡ä¿¡å·å‘ŠçŸ¥<code>ViewModel</code>ï¼›â†“</p><p>â†’<code>ViewModel</code>å¤„ç†æ•°æ®å¹¶é€šè¿‡ä¿®æ”¹<code>View</code>å±‚ç»‘å®šçš„å±æ€§å‘ŠçŸ¥å…¶æ›´æ–°UIï¼›</p><p>å¯ä»¥çœ‹åˆ°ï¼Œå„å±‚çš„èŒè´£ä¹Ÿæ˜¯éå¸¸æ¸…æ™°ï¼Œé€šè¿‡ç»‘å®šå±æ€§å’Œè®¢é˜…ä¿¡å·ï¼Œå„å±‚å¤„ç†ç›¸å…³ä¸šåŠ¡çš„ä»£ç éƒ½å†…èšåœ¨è‡ªå·±çš„å±‚é‡Œï¼Œè¿™ä¹Ÿå¾ˆå¥½çš„ä½“ç°äº†â€œé«˜å†…èšï¼Œä½è€¦åˆâ€çš„æ¶æ„è®¾è®¡è¦æ±‚ã€‚</p><h4 id="4-ç¤ºä¾‹2-Swift"><a href="#4-ç¤ºä¾‹2-Swift" class="headerlink" title="4.ç¤ºä¾‹2:Swift"></a>4.ç¤ºä¾‹2:Swift</h4><p>åœºæ™¯ï¼šæœ¬åœ°æ ¡éªŒè¾“å…¥çš„ç™»å½•æ–‡æœ¬æ ¼å¼ï¼Œåˆè§„æ—¶å‘é€è¯·æ±‚ï¼›</p><p>è¦æ±‚ï¼š</p><ul><li>ç”¨æˆ·åä¸å¯†ç å‡é¡»å¤§äº6ä¸ªå­—ç¬¦ï¼›</li><li>ç”¨æˆ·åæˆ–å¯†ç å°äº6ä¸ªå­—ç¬¦æ—¶æ˜¾ç¤ºæç¤ºæ–‡æ¡ˆï¼›</li><li>ç”¨æˆ·åä¸å¯†ç å°äº6å­—ç¬¦æ—¶ç™»å½•æŒ‰é’®æ˜¾ç¤ºç°è‰²ä¸å¯ç‚¹å‡»ï¼Œå‡å¤§äº6å­—ç¬¦æ—¶å˜è“å¯ç‚¹å‡»ï¼›</li><li>ç‚¹å‡»ç™»å½•æŒ‰é’®ï¼Œå‘èµ·è¯·æ±‚å¹¶æ ¹æ®ç»“æœæ˜¾ç¤ºæç¤ºï¼›</li></ul><p><img src="https://davidlii.nos-eastchina1.126.net/pic_rx_mvvm_getin.jpg" alt="RxSwiftç™»å½•"></p><h5 id="Viewä¸ç»‘å®š"><a href="#Viewä¸ç»‘å®š" class="headerlink" title="Viewä¸ç»‘å®š"></a>Viewä¸ç»‘å®š</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">import</span> RxSwift<br><span class="hljs-keyword">import</span> RxCocoa<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DKRxGetInController</span>: <span class="hljs-title class_">UIViewController</span> &#123;<br>    <br>    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> <span class="hljs-type">DKNameTf</span>: <span class="hljs-type">UITextField</span>!<br>    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> <span class="hljs-type">DKPswTf</span>: <span class="hljs-type">UITextField</span>!<br>    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> <span class="hljs-type">DKNameTips</span>: <span class="hljs-type">UILabel</span>!<br>    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> <span class="hljs-type">DKPswTips</span>: <span class="hljs-type">UILabel</span>!<br>    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> <span class="hljs-type">DKGetInBtn</span>: <span class="hljs-type">UIButton</span>!<br>    <br>    <span class="hljs-keyword">let</span> disposeBag <span class="hljs-operator">=</span> <span class="hljs-type">DisposeBag</span>()<br>    <br>    <span class="hljs-comment">//ViewModel</span><br>    <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">var</span> aGetinVM:<span class="hljs-type">DKRxGetInViewModel</span> <span class="hljs-operator">=</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-type">DKRxGetInViewModel</span>(name: <span class="hljs-type">DKNameTf</span>.rx.text.orEmpty.asObservable(), psw: <span class="hljs-type">DKPswTf</span>.rx.text.orEmpty.asObservable())<br>    &#125;()<br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() &#123;<br>        <span class="hljs-keyword">super</span>.viewDidLoad()<br>        <br>        <span class="hljs-comment">//å°†æ˜µç§°çš„è¾“å…¥ç»“æœä¸æç¤ºæ–‡æœ¬çš„â€œéšè—â€å±æ€§è¿›è¡Œç»‘å®š</span><br>        aGetinVM.nameObs.bind(to: <span class="hljs-type">DKNameTips</span>.rx.isHidden).disposed(by: disposeBag)<br>        <span class="hljs-comment">//å°†æ˜µç§°çš„è¾“å…¥ç»“æœä¸å¯†ç è¾“å…¥æ¡†çš„â€œæ˜¯å¦å¯ç”¨â€å±æ€§è¿›è¡Œç»‘å®šï¼Œæ˜µç§°è¾“å…¥åˆè§„æ—¶æ‰èƒ½è¾“å…¥å¯†ç </span><br>        aGetinVM.nameObs.bind(to: <span class="hljs-type">DKPswTf</span>.rx.isEnabled).disposed(by: disposeBag)<br>        <br>        <span class="hljs-comment">//å°†å¯†ç çš„è¾“å…¥ç»“æœä¸æç¤ºæ–‡æœ¬çš„â€œéšè—â€å±æ€§è¿›è¡Œç»‘å®š</span><br>        aGetinVM.pswObs.bind(to: <span class="hljs-type">DKPswTips</span>.rx.isHidden).disposed(by: disposeBag)<br>        <br>        <span class="hljs-comment">//ç»„åˆæ˜µç§°ä¸å¯†ç ä¿¡å·ï¼Œæ˜µç§°ä¸å¯†ç åŒæ—¶æ»¡è¶³æ¡ä»¶æ—¶ï¼Œç™»å½•æŒ‰é’®æ–¹å¯ç”¨</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> aGetinVM.allObs.subscribe&#123; [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span><br>            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.<span class="hljs-type">DKGetInBtn</span>.backgroundColor <span class="hljs-operator">=</span> (<span class="hljs-variable">$0</span> <span class="hljs-operator">?</span> <span class="hljs-type">UIColor</span>.blue : <span class="hljs-type">UIColor</span>.lightGray)<br>        &#125;<br>        aGetinVM.allObs.bind(to: <span class="hljs-type">DKGetInBtn</span>.rx.isEnabled).disposed(by: disposeBag)<br>        <br>        <span class="hljs-comment">//ç»™ç™»å½•æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶</span><br>        <span class="hljs-type">DKGetInBtn</span>.rx.tap.subscribe&#123; [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span><br>            <span class="hljs-comment">//å‘èµ·ç™»å½•è¯·æ±‚</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.aGetinVM.fetchUserinfo(name: (<span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.<span class="hljs-type">DKNameTf</span>.text)<span class="hljs-operator">!</span>, psw: (<span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.<span class="hljs-type">DKPswTf</span>.text)<span class="hljs-operator">!</span>).subscribe &#123; (ob) <span class="hljs-keyword">in</span><br>                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.showAlert()<br>            &#125; onError: &#123; (error) <span class="hljs-keyword">in</span><br>                <span class="hljs-built_in">print</span>(error.localizedDescription)<br>            &#125;<br>        &#125;.disposed(by: disposeBag)<br>    &#125;<br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">touchesBegan</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">touches</span>: <span class="hljs-type">Set</span>&lt;<span class="hljs-type">UITouch</span>&gt;, <span class="hljs-params">with</span> <span class="hljs-params">event</span>: <span class="hljs-type">UIEvent</span>?) &#123;<br>        view.endEditing(<span class="hljs-literal">true</span>)<br>    &#125;<br>    <br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">showAlert</span>() &#123;<br>        <span class="hljs-keyword">let</span> alert <span class="hljs-operator">=</span> <span class="hljs-type">UIAlertController</span>.<span class="hljs-keyword">init</span>(title: <span class="hljs-string">&quot;æç¤º&quot;</span>, message: <span class="hljs-string">&quot;ç™»å½•æˆåŠŸï¼&quot;</span>, preferredStyle: .alert)<br>        <span class="hljs-keyword">let</span> action <span class="hljs-operator">=</span> <span class="hljs-type">UIAlertAction</span>.<span class="hljs-keyword">init</span>(title: <span class="hljs-string">&quot;Ok&quot;</span>, style: .default, handler: <span class="hljs-literal">nil</span>)<br>        alert.addAction(action)<br>        present(alert, animated: <span class="hljs-literal">true</span>, completion: <span class="hljs-literal">nil</span>)<br>    &#125;<br>    <br>    <span class="hljs-keyword">deinit</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-keyword">#file</span>, <span class="hljs-keyword">#function</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯<code>View</code>å±‚ï¼Œå®ƒæŒæœ‰ä¸€ä¸ª<code>VM</code>å®ä¾‹å¹¶å°†è¾“å…¥æ¡†çš„æ–‡æœ¬ä¸<code>VM</code>ä¸­çš„å±æ€§è¿›è¡ŒåŒå‘ç»‘å®šã€‚æç¤ºæ–‡æœ¬æ˜¯å¦æ˜¾ç¤ºã€è¾“å…¥æ¡†æ˜¯å¦å…è®¸è¾“å…¥ã€ç™»å½•æŒ‰é’®çš„çŠ¶æ€éƒ½æ˜¯æ ¹æ®è¾“å…¥å†…å®¹æ˜¯å¦åˆè§„æ¥å†³å®šçš„ã€‚è¿™äº›æ ¡éªŒçš„é€»è¾‘å‡åœ¨<code>VM</code>ä¸­å¤„ç†ï¼›ç‚¹å‡»ç™»å½•æŒ‰é’®æ—¶é€šè¿‡<code>VM</code>å‘èµ·è¯·æ±‚ï¼Œç»“æœè¿”å›åæ˜¾ç¤ºå¯¹åº”çš„æç¤ºã€‚</p><h5 id="ViewModel-3"><a href="#ViewModel-3" class="headerlink" title="ViewModel"></a>ViewModel</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">import</span> RxSwift<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DKRxGetInViewModel</span> &#123;<br>    <br>    <span class="hljs-comment">//å£°æ˜å¯è§‚å¯Ÿå±æ€§ ä¾›Viewå±‚ç»‘å®š</span><br>    <span class="hljs-keyword">let</span> nameObs: <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">Bool</span>&gt;<br>    <span class="hljs-keyword">let</span> pswObs: <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">Bool</span>&gt;<br>    <span class="hljs-keyword">let</span> allObs: <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">Bool</span>&gt;<br>    <br>    <span class="hljs-comment">//Modelå±‚</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> aModel <span class="hljs-operator">=</span> <span class="hljs-type">DKModel</span>()<br>    <br>    <span class="hljs-comment">//åˆå§‹åŒ–å¹¶å®šä¹‰ä¸šåŠ¡é€»è¾‘</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">String</span>&gt;, <span class="hljs-params">psw</span>: <span class="hljs-type">Observable</span>&lt;<span class="hljs-type">String</span>&gt;) &#123;<br>        <br>        <span class="hljs-comment">//åˆ›å»ºä¿¡å·1ï¼šâ€œæ˜µç§°â€è¾“å…¥æ¡†</span><br>        nameObs <span class="hljs-operator">=</span> name.map &#123; text <span class="hljs-keyword">in</span><br>            <span class="hljs-keyword">return</span> text.count <span class="hljs-operator">&gt;=</span> <span class="hljs-number">6</span>  <span class="hljs-comment">//æ˜µç§°é¡»&gt;6ä¸ªå­—ç¬¦</span><br>        &#125;.share(replay: <span class="hljs-number">1</span>)<br>        <br>        <span class="hljs-comment">//åˆ›å»ºä¿¡å·2ï¼šâ€œå¯†ç â€è¾“å…¥æ¡†</span><br>        pswObs <span class="hljs-operator">=</span> psw.map &#123; <span class="hljs-variable">$0</span>.count <span class="hljs-operator">&gt;=</span> <span class="hljs-number">6</span> &#125; <span class="hljs-comment">//å¯†ç é¡»&gt;6ä¸ªå­—ç¬¦</span><br>            .share(replay: <span class="hljs-number">1</span>)<br>        <br>        <span class="hljs-comment">//ç»„åˆæ˜µç§°ä¸å¯†ç ä¸¤ä¸ªä¿¡å·</span><br>        allObs <span class="hljs-operator">=</span> <span class="hljs-type">Observable</span>.combineLatest(nameObs, pswObs) &#123; <span class="hljs-variable">$0</span> <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-variable">$1</span> &#125; <span class="hljs-comment">//&amp;&amp;ï¼šéœ€è¦æ˜µç§°ä¸å¯†ç åŒæ—¶æ»¡è¶³æ¡ä»¶</span><br>            .share(replay: <span class="hljs-number">1</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">//å‘èµ·ç™»å½•è¯·æ±‚</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchUserinfo</span>(<span class="hljs-params">name</span>:<span class="hljs-type">String</span>, <span class="hljs-params">psw</span>: <span class="hljs-type">String</span>)-&gt;<span class="hljs-type">Observable</span>&lt;[<span class="hljs-type">String</span>: <span class="hljs-keyword">Any</span>]&gt; &#123;<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-type">Observable</span>.create &#123; [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] (ob) -&gt; <span class="hljs-type">Disposable</span> <span class="hljs-keyword">in</span><br>            <br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.aModel.fetchUserinfo(name: name, psw: psw).subscribe &#123; (dic) <span class="hljs-keyword">in</span><br>                ob.onNext(dic)<br>            &#125; onError: &#123; (error) <span class="hljs-keyword">in</span><br>                <span class="hljs-built_in">print</span>(error)<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-type">Disposables</span>.create()<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„<code>VM</code>ï¼Œé‡Œé¢å®šä¹‰äº†æ ¡éªŒç”¨æˆ·åä¸å¯†ç çš„é€»è¾‘ï¼›</p><p>å®ƒæŒæœ‰ä¸€ä¸ª<code>Model</code>å±‚å®ä¾‹ï¼Œåœ¨ç»™<code>View</code>å±‚çš„æ¥å£ä¸­é€šè¿‡<code>Model</code>å‘èµ·ç™»å½•è¯·æ±‚å¹¶å›è°ƒç»“æœã€‚</p><h5 id="Model-1"><a href="#Model-1" class="headerlink" title="Model"></a>Model</h5><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import RxSwift<br>import RxAlamofire<br><br><span class="hljs-keyword">class</span> DKModel &#123;<br>    <span class="hljs-keyword">let</span> disposeBag = <span class="hljs-constructor">DisposeBag()</span><br>    <br>    func fetch<span class="hljs-constructor">Userinfo(<span class="hljs-params">name</span>:String, <span class="hljs-params">psw</span>: String)</span>-&gt;Observable&lt;<span class="hljs-literal">[S<span class="hljs-identifier">tring</span>: A<span class="hljs-identifier">ny</span>]</span>&gt; &#123;<br>        <br>        return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Observable</span>.</span></span>create &#123; <span class="hljs-literal">[<span class="hljs-identifier">weak</span> <span class="hljs-identifier">self</span>]</span> (ob) -&gt; Disposable <span class="hljs-keyword">in</span><br>            <span class="hljs-comment">//æ¨¡æ‹ŸURL</span><br>            <span class="hljs-keyword">let</span> urlString = <span class="hljs-string">&quot;https://www.douban.com/j/app/radio/channels&quot;</span><br>            <span class="hljs-keyword">let</span> url = <span class="hljs-constructor">URL(<span class="hljs-params">string</span>:<span class="hljs-params">urlString</span>)</span>!<br>             <br>            <span class="hljs-comment">//åˆ›å»ºå¹¶å‘èµ·è¯·æ±‚</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RxAlamofire</span>.</span></span>request(.get, url)<br>                .response<span class="hljs-constructor">JSON()</span><br>                .subscribe(onNext: &#123;<br>                    response <span class="hljs-keyword">in</span><br>                    <span class="hljs-keyword">let</span> json = response.value <span class="hljs-keyword">as</span>! <span class="hljs-literal">[S<span class="hljs-identifier">tring</span>: A<span class="hljs-identifier">ny</span>]</span><br>                    ob.on<span class="hljs-constructor">Next(<span class="hljs-params">json</span>)</span> <span class="hljs-comment">//å›è°ƒæ•°æ®</span><br>                &#125;, onError: &#123; (error) <span class="hljs-keyword">in</span><br>                    ob.on<span class="hljs-constructor">Error(<span class="hljs-params">error</span>)</span><br>                &#125;).disposed(by: self!.disposeBag)<br>            <br>            return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Disposables</span>.</span></span>create<span class="hljs-literal">()</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯<code>Model</code>å±‚ï¼Œå…¶ä¸­å®šä¹‰äº†ç»™<code>VM</code>ä½¿ç”¨çš„ç™»å½•æ¥å£ï¼Œæ¥å£å†…å‘èµ·ç™»å½•è¯·æ±‚å¹¶å›è°ƒç™»å½•ç»“æœã€‚</p><p>åœ¨è¿™ä¸ªSwiftç‰ˆçš„ç¤ºä¾‹ä¸­ï¼Œå„å±‚ä¹Ÿæ¯”è¾ƒæ¸…æ™°ï¼Œæ¯å±‚å†…éƒ¨çš„ä»£ç é«˜åº¦å†…èšã€‚æ¯”è¾ƒç¤ºä¾‹1ï¼Œå®ƒæ›´å¥½çš„å®ç°äº†<code>View</code>ä¸<code>VM</code>çš„åŒå‘ç»‘å®šï¼Œå³è¾“å…¥å†…å®¹ä¸æ ¡éªŒç»“æœç»‘å®šï¼Œæ ¡éªŒç»“æœä¸æç¤ºæ–‡æœ¬å’Œç™»å½•æŒ‰é’®çš„çŠ¶æ€ç»‘å®šã€‚</p><h4 id="5-ä½¿ç”¨è§„èŒƒ"><a href="#5-ä½¿ç”¨è§„èŒƒ" class="headerlink" title="5.ä½¿ç”¨è§„èŒƒ"></a>5.ä½¿ç”¨è§„èŒƒ</h4><ul><li>MMVM ä¸­<code>Vå±‚</code>ç»‘å®šäº†<code>ViewModel</code>ï¼Œåè¿‡æ¥ä¸è¡Œï¼Œ<code>ViewModel</code>ä¸­ä¸èƒ½åŒ…å«<code>View</code>ï¼›</li><li>MMVM ä¸­<code>ViewModel</code>ç»‘å®šäº†<code>Model</code>å±‚ï¼Œåè¿‡æ¥ä¹Ÿä¸è¡Œï¼›</li><li>Controllerå°½é‡ä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘ï¼Œè®©<code>ViewModel</code>å»åšï¼›</li><li>Controlleræ˜¯ä¸­é—´äººï¼Œæ¥æ”¶<code>View</code>çš„äº‹ä»¶ã€è°ƒç”¨<code>ViewModel</code>çš„æ–¹æ³•ã€å“åº”<code>VM</code>çš„å˜åŒ–ï¼›</li><li>ViewModel é¿å…è¿‡äºè‡ƒè‚¿ï¼Œå¦åˆ™é‡è¹ˆ Controller çš„è¦†è¾™ï¼Œå˜å¾—éš¾ä»¥ç»´æŠ¤ï¼Œå¯æ‹†åˆ†æˆå­VMï¼›</li><li>MVVM é…åˆæŸç§ç»‘å®šæœºåˆ¶æ—¶æ•ˆæœæœ€å¥½ï¼ˆå¦‚RACï¼‰ã€‚</li></ul><h3 id="å››-åè®°"><a href="#å››-åè®°" class="headerlink" title="å››.åè®°"></a>å››.åè®°</h3><p>æ¶æ„ä¸€ç›´åœ¨æ¼”è¿›è¿‡ç¨‹ä¸­ï¼Œè€ƒè™‘åˆ°é¡¹ç›®å¤§å°ã€æ‰€ç”¨è¯­è¨€ã€å­¦ä¹ æˆæœ¬ç­‰å› ç´ ï¼Œæ²¡æœ‰æœ€å¥½çš„æ¶æ„ï¼Œåªæœ‰é€‚åˆè‡ªå·±çš„æ¶æ„ã€‚æˆ‘ä»¬è¦æ ¹æ®å®é™…éœ€æ±‚ï¼Œä¸æ–­å­¦ä¹ å’Œè°ƒæ•´ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/Model-View-Controller/Model-View-Controller.html">AppleDoc-MVC</a></p><p>#<a href="http://blog.sunnyxx.com/tags/Reactive-Cocoa-Tutorial/">Â©sunnyxx-RAC</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¶æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç•Œé¢è°ƒè¯•å·¥å…·ï¼šReveal</title>
    <link href="/2020/04/17/reveal.html"/>
    <url>/2020/04/17/reveal.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1.ç®€ä»‹"></a>1.ç®€ä»‹</h3><h4 id="1-1-åœºæ™¯"><a href="#1-1-åœºæ™¯" class="headerlink" title="1.1.åœºæ™¯"></a>1.1.åœºæ™¯</h4><ul><li>åœºæ™¯1</li></ul><p>æˆ‘ä»¬åœ¨æ¨¡æ‹Ÿå™¨æˆ–çœŸæœºä¸Šè°ƒè¯•è‡ªå®¶åº”ç”¨æ—¶ï¼Œä¸€èˆ¬çš„è¿‡ç¨‹å¯èƒ½æ˜¯ï¼š<br><br/></p><p>ä¿®æ”¹ç•Œé¢å…ƒç´  â†’ ç¼–è¯‘è¿è¡Œ â†’ æ•ˆæœä¸æ»¡æ„ç»§ç»­ä¿®æ”¹ â†’ ç¼–è¯‘è¿è¡Œ<br><br/></p><p>å½“æŸäº›æ•ˆæœéœ€è¦åå¤è°ƒè¯•æ—¶ï¼Œå¾ˆå¤šæ—¶é—´ä¼šæµªè´¹åœ¨ç¼–è¯‘è¿è¡Œé˜¶æ®µï¼Œå°¤å…¶æ˜¯å½“ä½ çš„åº”ç”¨æ¯”è¾ƒå¤æ‚æ—¶ã€‚<br><br/></p><p>è§£å†³è¿™ä¸ªç—›ç‚¹æœ‰å¤šç§æ–¹å¼ï¼Œå¦‚ä½¿ç”¨<code>RN</code>ã€<code>Flutter</code>ç­‰æ¡†æ¶ï¼Œå®ƒä»¬éƒ½æ”¯æŒå®æ—¶æ¸²æŸ“ï¼Œä¸è¿‡è¿™äº›éƒ½æ¶‰åŠåˆ°æˆæœ¬çš„å–èˆã€‚</p><ul><li>åœºæ™¯2</li></ul><p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦ç ”ç©¶æŸäº›ç¬¬ä¸‰æ–¹åº”ç”¨çš„ç•Œé¢å¸ƒå±€ï¼Œå¦‚åšç«å“åˆ†ææˆ–è€…å­¦ä¹ ä¼˜ç§€åº”ç”¨çš„è®¾è®¡ï¼Œå¯é—®é¢˜åœ¨äºæˆ‘ä»¬æœ‰æ‹¿ä¸åˆ°è¿™äº›åº”ç”¨çš„æºç ï¼ŒæŒ å¤´~<br><br/></p><p>è§£å†³è¿™ä¸ªç—›ç‚¹æ—¶ï¼Œæˆ‘æ‰€çŸ¥é“çš„æ˜¯å¯ä»¥é€šè¿‡<code>ç ¸å£³</code>+<code>åç¼–è¯‘</code>æ¥è·å–è¿™äº›åº”ç”¨çš„ä¼ªä»£ç ï¼Œä¿®æ”¹åé‡æ–°ç­¾åæ‰“åŒ…çœ‹æ•ˆæœã€‚ä½†ä¼ªä»£ç å¯è¯»æ€§å·®ï¼Œéæ‰€è§å³æ‰€å¾—ï¼Œä¹Ÿä¸èƒ½å®æ—¶è°ƒè¯•ã€‚</p><hr><p>è¦è§£å†³ä¸Šé¢ä¸¤ç§åœºæ™¯ä¸‹çš„ç•Œé¢è°ƒè¯•é—®é¢˜ï¼Œæ›´ä¾¿æ·çš„<code>Reveal</code>å°±æ´¾ä¸Šç”¨åœºäº†~</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_reveal.png" alt="reveal"></p><h4 id="1-2-æè¿°"><a href="#1-2-æè¿°" class="headerlink" title="1.2.æè¿°"></a>1.2.æè¿°</h4><p>ä¸‹é¢æ˜¯æ‘˜è‡ª<a href="https://revealapp.com/">å®˜ç½‘</a>çš„æè¿°ï¼š</p><blockquote><p>Reveal brings powerful runtime view debugging to iOS developers. With advanced visualisations, comprehensive inspectors and the ability to modify applications on the fly, youâ€™ll be debugging view layout and rendering problems in seconds.</p></blockquote><p><code>Reveal</code>æ˜¯ä¸€æ¬¾é¢å‘iOSå¼€å‘è€…çš„è§†å›¾è°ƒè¯•å·¥å…·ã€‚å®ƒå…·æœ‰å¯è§†åŒ–ã€ç»¼åˆæ£€è§†ã€å¯ä¿®æ”¹ã€å®æ—¶æ˜¾ç¤ºç»“æœçš„ç‰¹ç‚¹ã€‚</p><h4 id="1-3-ä½œç”¨"><a href="#1-3-ä½œç”¨" class="headerlink" title="1.3.ä½œç”¨"></a>1.3.ä½œç”¨</h4><ul><li>3Då±•ç¤ºåº”ç”¨ä¸­çš„è§†å›¾åŠå…¶å±‚çº§å…³ç³»ï¼›</li><li>æ”¯æŒæ£€è§†å›¾å±‚layerï¼›</li><li>æ”¯æŒæ£€è§†æ‰‹åŠ¿Gesture Recognizersã€ä¿®æ”¹å…¶è¡Œä¸ºï¼›</li><li>æ”¯æŒæ£€è§†è‡ªåŠ¨å¸ƒå±€Auto Layoutä¿¡æ¯ï¼›</li></ul><h4 id="1-4-å¯¹è±¡"><a href="#1-4-å¯¹è±¡" class="headerlink" title="1.4.å¯¹è±¡"></a>1.4.å¯¹è±¡</h4><ul><li>Xcodeç¼–è¯‘å‡ºçš„ã€åœ¨æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œçš„è‡ªå®¶æµ‹è¯•ç‰ˆåº”ç”¨ï¼›</li><li>çœŸæœºä¸Šè¿è¡Œçš„ç¬¬ä¸‰æ–¹æˆ–è‡ªå®¶çš„å•†åº—ç‰ˆåº”ç”¨ï¼›</li></ul><h3 id="2-å®‰è£…"><a href="#2-å®‰è£…" class="headerlink" title="2.å®‰è£…"></a>2.å®‰è£…</h3><p><code>Reveal</code>æ˜¯ä¸€æ¬¾æ”¶è´¹åº”ç”¨ï¼Œä¸ªäººç‰ˆå”®ä»·$59ï¼Œå•†ä¸šç‰ˆ$119ï¼Œä¼ä¸šç‰ˆå¦è®®ï¼Œæœ‰èƒ½åŠ›çš„è¯è¿˜æ˜¯æ”¯æŒä¸€ä¸‹æ­£ç‰ˆå§ã€‚ç½‘ä¸Šæœ‰ç ´è§£ç‰ˆä»…ä¾›å­¦ä¹ ä½¿ç”¨ï¼Œè¿™é‡Œå°±ä¸æ”¾ä¼ é€é—¨äº†ã€‚å¦å¤–ä½ éœ€è¦ä¸€å°è¶Šç‹±åçš„è®¾å¤‡ä»¥ä¾¿è°ƒè¯•ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æ¨¡æ‹Ÿå™¨ä¸Šè°ƒè¯•ï¼Œä¸è¿‡åªèƒ½è°ƒè¯•è‡ªå®¶åº”ç”¨ã€‚ä¸è®ºæ˜¯è°ƒè¯•ä¸‰æ–¹åº”ç”¨è¿˜æ˜¯è‡ªå®¶åº”ç”¨ï¼Œä½ éƒ½éœ€è¦é›†æˆrevealçš„åº“æ–‡ä»¶ï¼Œåªæ˜¯ä¸¤è€…çš„é›†æˆæ–¹å¼ç¨æœ‰ä¸åŒã€‚</p><h3 id="3-é›†æˆ"><a href="#3-é›†æˆ" class="headerlink" title="3.é›†æˆ"></a>3.é›†æˆ</h3><h4 id="3-1-è‡ªå®¶åº”ç”¨"><a href="#3-1-è‡ªå®¶åº”ç”¨" class="headerlink" title="3.1.è‡ªå®¶åº”ç”¨"></a>3.1.è‡ªå®¶åº”ç”¨</h4><p>è¦è°ƒè¯•è‡ªå®¶åº”ç”¨ï¼Œé™¤äº†åœ¨MACä¸Šå®‰è£…<code>Reveal</code>å¤–ï¼Œä½ è¿˜éœ€è¦åœ¨è‡ªå·±çš„å·¥ç¨‹ä¸­é›†æˆrevealåº“ï¼š</p><blockquote><p>We maintain a CocoaPods Podspec for integrating Reveal into your Xcode projects.</p></blockquote><ul><li>ä¿®æ”¹Podfileï¼š</li></ul><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade">target <span class="hljs-string">&#x27;YourMainAppTargetName&#x27;</span> <span class="hljs-keyword">do</span><br>    pod <span class="hljs-string">&#x27;Reveal-SDK&#x27;</span>, :<span class="hljs-function"><span class="hljs-params">configurations</span> =&gt;</span> [<span class="hljs-string">&#x27;Debug&#x27;</span>]<br>end<br></code></pre></td></tr></table></figure><ul><li>å¯¼å…¥RevealServer.framework</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pod <span class="hljs-keyword">install</span><br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘è¿è¡Œï¼Œæ¨¡æ‹Ÿå™¨ä¸­åº”ç”¨è·‘èµ·æ¥ä¹‹åï¼ŒRevealç•Œé¢ä¸­ä¼šè‡ªåŠ¨æ˜¾ç¤ºè¯¥åº”ç”¨ã€‚å…·ä½“çš„æ•ˆæœå¦‚ä¸‹ï¼š</li></ul><p><img src="https://davidlii.nos-eastchina1.126.net/pic_reveal_cocoapods_server.png" alt="reveal_cocoapods_server"></p><ul><li>æ„‰å¿«çš„è°ƒè¯•å§ï¼ˆç•Œé¢æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Ÿï¼‰</li></ul><p><img src="https://davidlii.nos-eastchina1.126.net/pic_reveal_debug_views.png" alt="reveal_debug_views"></p><blockquote><p>WARNING: Never ship a product which has been linked with the Reveal Server framework. The Podfile example below will only link the Reveal Server framework into builds of your app compiled using the â€œDebugâ€ configuration.</p></blockquote><p>æ³¨æ„ï¼ï¼æ¥è‡ªå®˜æ–¹çš„è­¦å‘Šï¼šä¸è¦å°†é›†æˆäº†Reveal Server frameworkçš„åº”ç”¨æäº¤åˆ°å•†åº—ï¼ï¼ï¼</p><h4 id="3-2-ç¬¬ä¸‰æ–¹åº”ç”¨"><a href="#3-2-ç¬¬ä¸‰æ–¹åº”ç”¨" class="headerlink" title="3.2.ç¬¬ä¸‰æ–¹åº”ç”¨"></a>3.2.ç¬¬ä¸‰æ–¹åº”ç”¨</h4><ul><li>MACä¸Šå¯åŠ¨Reveal â†’ Help â†’ Show Reveal Library in Finder â†’ iOS-Libraries:</li></ul><p><img src="https://davidlii.nos-eastchina1.126.net/pic_revealLib.png" alt="REVEAL"></p><ul><li>é€‰æ‹©RevealServer.frameworké™æ€åº“:</li></ul><p><img src="https://davidlii.nos-eastchina1.126.net/pic_revealserver_framework.png" alt="revealserver_framework"></p><ul><li>ç»ˆç«¯ä¸­é€šè¿‡<code>scp</code>å‘½ä»¤ï¼Œæ‹·è´åº“åˆ°è®¾å¤‡çš„&#x2F;Library&#x2F;Frameworks&#x2F;ç›®å½•ä¸‹ï¼š</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> è¿™ä¸ªIPåœ°å€æ˜¯æ‰‹æœºæ‰€åœ¨WiFiçš„IPåœ°å€<br>scp -r RevealServer.framework root@<span class="hljs-number">192.168</span>.xx.xxx:<span class="hljs-regexp">/Library/</span>Frameworks/ <br></code></pre></td></tr></table></figure><ul><li>é‡å¯SpringBoardï¼Œä»¥ä¾¿è®©å¯¼å…¥çš„ RevealServer åº“ç”Ÿæ•ˆï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//æ‰‹æœº/è®¾å¤‡æ‰€åœ¨WiFiçš„IPåœ°å€</span><br>$ ssh root@<span class="hljs-number">192.168</span><span class="hljs-number">.31</span>.xx<br><span class="hljs-comment">// è¾“å…¥rootç”¨æˆ·çš„å¯†ç ï¼Œé»˜è®¤å€¼alphineï¼Œä¿®æ”¹è¿‡çš„è¯è‡ªè¡Œè¾“å…¥</span><br>root@<span class="hljs-number">192.168</span><span class="hljs-number">.31</span>.xx<span class="hljs-number">&#x27;</span>s password:<br><span class="hljs-comment">//é‡å¯springboard</span><br>Hes-iPhone:~ root<span class="hljs-meta"># killall SpringBoard</span><br></code></pre></td></tr></table></figure><ul><li><p>è¶Šç‹±æ‰‹æœºä¸Šï¼Œåœ¨Cydiaå•†åº—ä¸­æœç´¢å¹¶å®‰è£…Reveal2Loaderï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_reveal_tweek_1.PNG" alt="reveal_tweek_1"></p></li><li><p>æ‰‹æœºè®¾ç½®ä¸­æ‰¾åˆ°revealï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_reveal_tweek_2.jpeg" alt="reveal_tweek_2"></p></li><li><p>è®¾ç½®éœ€è¦è°ƒè¯•çš„åº”ç”¨ï¼Œæ‰“å¼€å¯¹åº”çš„å¼€å…³å³å¯ï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_reveal_tweek_3.PNG" alt="reveal_tweek_3"></p></li><li><p>è®¾å¤‡ä¸Šå¯åŠ¨è¦è°ƒè¯•çš„åº”ç”¨ï¼ŒMACä¸Šçš„Revealèƒ½è‡ªåŠ¨æ£€æµ‹åˆ°æ­¤å¾…è°ƒè¯•çš„åº”ç”¨ï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_reveal_baidu.png" alt="reveal_baidu"></p></li><li><p>ç‚¹å‡»å¾…è°ƒè¯•çš„åº”ç”¨å³å¯è¿›å…¥è°ƒè¯•ç•Œé¢ï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_reveal_baidu_debug.png" alt="reveal_baidu_debug"></p></li><li><p>æ¥ä¸‹æ¥å°±å¯ä»¥æ„‰å¿«çš„è°ƒè¯•äº†~</p></li></ul><h3 id="4-æ³¨æ„äº‹é¡¹"><a href="#4-æ³¨æ„äº‹é¡¹" class="headerlink" title="4.æ³¨æ„äº‹é¡¹"></a>4.æ³¨æ„äº‹é¡¹</h3><p><code>Reveal</code>æ”¯æŒ USB å’Œ WiFi ä¸¤ç§è¿æ¥æ¨¡å¼ï¼Œå¦‚æœåœ¨è‡ªå·±çš„è®¾å¤‡ä¸Šè°ƒè¯•ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä½ éœ€è¦ç¡®ä¿æ‰‹æœºé€šè¿‡æ•°æ®çº¿è¿æ¥åˆ°MACä¸Šï¼Œæˆ–è€…è®©æ‰‹æœºä¸MACå¤„äºåŒä¸€WiFiç¯å¢ƒä¸­ã€‚<br><br/></p><p>ä¸è¦å°†é›†æˆäº†Reveal Server frameworkçš„åº”ç”¨æäº¤åˆ°å•†åº—ï¼ï¼</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://www.jianshu.com/p/f2970ef365fe">Â©revealçš„ä¸‰ç§é›†æˆæ–¹å¼</a></p><p>#<a href="https://www.jianshu.com/p/213ddc050ff2">Â©revealçš„é›†æˆ</a></p><p>#<a href="https://blog.csdn.net/yishengzhiai005/article/details/103456794?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-5&utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-5">Â©è¶Šç‹±è®¾å¤‡è°ƒè¯•ç¬¬ä¸‰æ–¹åº”ç”¨</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é€†å‘å·¥ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ­å»ºè‡ªå·±çš„podåº“</title>
    <link href="/2019/08/31/podspec.html"/>
    <url>/2019/08/31/podspec.html</url>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä½¿ç”¨ä¸‰æ–¹åº“æ—¶åŸºæœ¬çš„è¯­æ³•æ˜¯ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">pod</span> <span class="hljs-string">&#x27;pod-Name&#x27;</span><br></code></pre></td></tr></table></figure><p>ä¹‹åé€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯¼å…¥æ­¤åº“:</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pod <span class="hljs-keyword">install</span><br></code></pre></td></tr></table></figure><p>podä¼šä»å®˜æ–¹ç´¢å¼•åº“ä¸­æŸ¥æ‰¾å¹¶å¯¼å…¥æ­¤ä¸‰æ–¹åº“ã€‚æœ‰æ—¶æˆ‘ä»¬ä¸å¸Œæœ›è‡ªå·±çš„åº“å¯¹å¤–å…¬å¼€ï¼Œå¦‚åªåœ¨å…¬å¸èŒƒå›´å†…ä½¿ç”¨ï¼Œè¿™æ—¶å°±å¯ä»¥åœ¨ä»£ç æ‰˜ç®¡å¹³å°å‘å¸ƒä¸€ä¸ªç§æœ‰åº“ï¼Œå¯¼å…¥åº“æ—¶é€šè¿‡<code>:source =&gt;</code>æŒ‡å®šç§æœ‰åº“çš„è¿œç¨‹ç´¢å¼•åº“åœ°å€å³å¯ã€‚<br><br/></p><p>æœ¬ç¯‡æ–‡ç« å°†è®°å½•ä¸‹ä»ç§æœ‰åº“åˆ°å…¬å¼€åº“çš„å®Œæ•´å‘å¸ƒæµç¨‹~</p><h3 id="1ã€è¿œç¨‹ç´¢å¼•ä»“åº“"><a href="#1ã€è¿œç¨‹ç´¢å¼•ä»“åº“" class="headerlink" title="1ã€è¿œç¨‹ç´¢å¼•ä»“åº“"></a>1ã€è¿œç¨‹ç´¢å¼•ä»“åº“</h3><p><code>GitHub</code>-&gt;&gt;<code>New repository</code>ï¼Œåˆ›å»ºæ–°çš„ç´¢å¼•ä»“åº“~</p><h3 id="2ã€æœ¬åœ°ç´¢å¼•ä»“åº“"><a href="#2ã€æœ¬åœ°ç´¢å¼•ä»“åº“" class="headerlink" title="2ã€æœ¬åœ°ç´¢å¼•ä»“åº“"></a>2ã€æœ¬åœ°ç´¢å¼•ä»“åº“</h3><h4 id="2-1-æŸ¥çœ‹æœ¬åœ°ä»“åº“"><a href="#2-1-æŸ¥çœ‹æœ¬åœ°ä»“åº“" class="headerlink" title="2.1.æŸ¥çœ‹æœ¬åœ°ä»“åº“"></a>2.1.æŸ¥çœ‹æœ¬åœ°ä»“åº“</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">pod repo</span><br></code></pre></td></tr></table></figure><p><code>/Users/Macmafia/.cocoapods</code>çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">.<br>â””â”€â”€ repos<br>    â””â”€â”€ <span class="hljs-keyword">master</span><br>        <span class="hljs-title">â”œâ”€â”€ CocoaPods-version</span>.yml<br>        â”œâ”€â”€ README.md<br>        â””â”€â”€ Specs<br></code></pre></td></tr></table></figure><h4 id="2-2-æœ¬åœ°ç´¢å¼•ä»“åº“"><a href="#2-2-æœ¬åœ°ç´¢å¼•ä»“åº“" class="headerlink" title="2.2.æœ¬åœ°ç´¢å¼•ä»“åº“"></a>2.2.æœ¬åœ°ç´¢å¼•ä»“åº“</h4><p>åˆ›å»ºæœ¬åœ°ç´¢å¼•ä»“åº“ï¼Œå¹¶ä¸è¿œç¨‹ä»“åº“å…³è”ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">pod repo add davidlii https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/davidli-/</span>davidlii.git<br></code></pre></td></tr></table></figure><h4 id="2-3-ç¡®è®¤"><a href="#2-3-ç¡®è®¤" class="headerlink" title="2.3.ç¡®è®¤"></a>2.3.ç¡®è®¤</h4><p>ç¡®è®¤æœ¬åœ°ç´¢å¼•ä»“åº“æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">pod repo</span><br></code></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œ<code>/Users/Macmafia/.cocoapods</code>ç›®å½•ä¸­ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">.<br>â””â”€â”€ repos<br>    â”œâ”€â”€ davidlii<br>    â”‚Â Â  â””â”€â”€ README.md<br>    â””â”€â”€ <span class="hljs-keyword">master</span><br>        <span class="hljs-title">â”œâ”€â”€ CocoaPods-version</span>.yml<br>        â”œâ”€â”€ README.md<br>        â””â”€â”€ Specs<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>davidlii</code>ç›®å½•å³ä¸ºåˆšåˆ›å»ºçš„æœ¬åœ°ä»“åº“ã€‚</p><h3 id="3ã€è¿œç¨‹ä»£ç åº“"><a href="#3ã€è¿œç¨‹ä»£ç åº“" class="headerlink" title="3ã€è¿œç¨‹ä»£ç åº“"></a>3ã€è¿œç¨‹ä»£ç åº“</h3><p>ä¸Šé¢åˆ›å»ºçš„æ˜¯â€ç´¢å¼•â€ä»“åº“ï¼Œå­˜æ”¾çš„æ˜¯â€.podspecâ€ç´¢å¼•æ–‡ä»¶ã€‚è¿™ä¸€æ­¥å°†è¦åˆ›å»ºçš„æ˜¯â€ä»£ç â€ä»“åº“ï¼Œå­˜æ”¾çš„æ˜¯è‡ªåˆ¶åº“çš„ç›¸å…³ä»£ç ã€‚æ­¥éª¤åŒ#1ç« èŠ‚ï¼Œå¦å–æ–°åDaKit~</p><h3 id="4ã€æœ¬åœ°ä»£ç åº“"><a href="#4ã€æœ¬åœ°ä»£ç åº“" class="headerlink" title="4ã€æœ¬åœ°ä»£ç åº“"></a>4ã€æœ¬åœ°ä»£ç åº“</h3><p>åˆ›å»ºæœ¬åœ°ä»£ç åº“ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd ä»£ç åº“çš„ç›®å½• (æˆ‘çš„æ˜¯<span class="hljs-regexp">/Documents/</span>)<br>pod lib create DaKit<br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥ä¼šè®©ä½ åšä¸€äº›é€‰æ‹©ï¼Œæ ¹æ®è‡ªå·±çš„æƒ…å†µåœ¨ç»ˆç«¯ä¸­è¾“å…¥å³å¯ï¼Œæˆ‘çš„é€‰æ‹©æŒ‰é¡ºåºåˆ†åˆ«ä¸ºï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span><span class="hljs-selector-class">.iOS</span><br><span class="hljs-number">2</span><span class="hljs-selector-class">.ObjC</span><br><span class="hljs-number">3</span><span class="hljs-selector-class">.Yes</span><br><span class="hljs-number">4</span><span class="hljs-selector-class">.None</span><br><span class="hljs-number">5</span><span class="hljs-selector-class">.No</span><br><span class="hljs-number">6</span>.Da<br></code></pre></td></tr></table></figure><p>é€‰æ‹©å®Œæˆåï¼Œå¼€å§‹ç”Ÿæˆæœ¬åœ°ä»£ç åº“ï¼Œä¹‹åä¼šè‡ªåŠ¨æ‰“å¼€è‡ªåˆ¶åº“çš„ç¤ºä¾‹å·¥ç¨‹ï¼Œå…¶ç‰©ç†ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs stylus">/Users/Macmafia/Documents/DaKit/<br>.<br>â”œâ”€â”€ DaKit<br>â”‚Â Â  â”œâ”€â”€ Assets<br>â”‚Â Â  â””â”€â”€ Classes<br>â”œâ”€â”€ DaKit<span class="hljs-selector-class">.podspec</span><br>â”œâ”€â”€ Example<br>â”‚Â Â  â”œâ”€â”€ DaKit<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Base<span class="hljs-selector-class">.lproj</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LaunchScreen<span class="hljs-selector-class">.storyboard</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ Main<span class="hljs-selector-class">.storyboard</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DaAppDelegate<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DaAppDelegate<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DaKit-Info<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DaKit-Prefix<span class="hljs-selector-class">.pch</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DaViewController<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DaViewController<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Images<span class="hljs-selector-class">.xcassets</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ AppIcon<span class="hljs-selector-class">.appiconset</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ Contents<span class="hljs-selector-class">.json</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ en<span class="hljs-selector-class">.lproj</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ InfoPlist<span class="hljs-selector-class">.strings</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”œâ”€â”€ DaKit<span class="hljs-selector-class">.xcodeproj</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ project<span class="hljs-selector-class">.pbxproj</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ project<span class="hljs-selector-class">.xcworkspace</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ contents<span class="hljs-selector-class">.xcworkspacedata</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ xcshareddata<br>â”‚Â Â  â”‚Â Â      â””â”€â”€ xcschemes<br>â”‚Â Â  â”‚Â Â          â””â”€â”€ DaKit-Example<span class="hljs-selector-class">.xcscheme</span><br>â”‚Â Â  â”œâ”€â”€ DaKit<span class="hljs-selector-class">.xcworkspace</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ contents<span class="hljs-selector-class">.xcworkspacedata</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ xcshareddata<br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ IDEWorkspaceChecks<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ xcuserdata<br>â”‚Â Â  â”‚Â Â      â””â”€â”€ Macmafia<span class="hljs-selector-class">.xcuserdatad</span><br>â”‚Â Â  â”‚Â Â          â””â”€â”€ UserInterfaceState<span class="hljs-selector-class">.xcuserstate</span><br>â”‚Â Â  â”œâ”€â”€ Podfile<br>â”‚Â Â  â”œâ”€â”€ Podfile<span class="hljs-selector-class">.lock</span><br>â”‚Â Â  â”œâ”€â”€ Pods<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Headers<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Local\ Podspecs<br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ DaKit<span class="hljs-selector-class">.podspec</span><span class="hljs-selector-class">.json</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Manifest<span class="hljs-selector-class">.lock</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Pods<span class="hljs-selector-class">.xcodeproj</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ project<span class="hljs-selector-class">.pbxproj</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ xcuserdata<br>â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ Macmafia<span class="hljs-selector-class">.xcuserdatad</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ xcschemes<br>â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ DaKit<span class="hljs-selector-class">.xcscheme</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ Pods-DaKit_Example<span class="hljs-selector-class">.xcscheme</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ Pods-DaKit_Tests<span class="hljs-selector-class">.xcscheme</span><br>â”‚Â Â  â”‚Â Â  â”‚Â Â              â””â”€â”€ xcschememanagement<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Target\ Support\ Files<br>â”‚Â Â  â”‚Â Â      â”œâ”€â”€ DaKit<br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ DaKit-Info<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ DaKit-dummy<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ DaKit-prefix<span class="hljs-selector-class">.pch</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ DaKit-umbrella<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ DaKit<span class="hljs-selector-class">.modulemap</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ DaKit<span class="hljs-selector-class">.xcconfig</span><br>â”‚Â Â  â”‚Â Â      â”œâ”€â”€ Pods-DaKit_Example<br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Pods-DaKit_Example-Info<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Pods-DaKit_Example-acknowledgements<span class="hljs-selector-class">.markdown</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Pods-DaKit_Example-acknowledgements<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Pods-DaKit_Example-dummy<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Pods-DaKit_Example-frameworks<span class="hljs-selector-class">.sh</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Pods-DaKit_Example-umbrella<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Pods-DaKit_Example<span class="hljs-selector-class">.debug</span><span class="hljs-selector-class">.xcconfig</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Pods-DaKit_Example<span class="hljs-selector-class">.modulemap</span><br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ Pods-DaKit_Example<span class="hljs-selector-class">.release</span><span class="hljs-selector-class">.xcconfig</span><br>â”‚Â Â  â”‚Â Â      â””â”€â”€ Pods-DaKit_Tests<br>â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Pods-DaKit_Tests-Info<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Pods-DaKit_Tests-acknowledgements<span class="hljs-selector-class">.markdown</span><br>â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Pods-DaKit_Tests-acknowledgements<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Pods-DaKit_Tests-dummy<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Pods-DaKit_Tests-umbrella<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Pods-DaKit_Tests<span class="hljs-selector-class">.debug</span><span class="hljs-selector-class">.xcconfig</span><br>â”‚Â Â  â”‚Â Â          â”œâ”€â”€ Pods-DaKit_Tests<span class="hljs-selector-class">.modulemap</span><br>â”‚Â Â  â”‚Â Â          â””â”€â”€ Pods-DaKit_Tests<span class="hljs-selector-class">.release</span><span class="hljs-selector-class">.xcconfig</span><br>â”‚Â Â  â””â”€â”€ Tests<br>â”‚Â Â      â”œâ”€â”€ Tests-Info<span class="hljs-selector-class">.plist</span><br>â”‚Â Â      â”œâ”€â”€ Tests-Prefix<span class="hljs-selector-class">.pch</span><br>â”‚Â Â      â”œâ”€â”€ Tests<span class="hljs-selector-class">.m</span><br>â”‚Â Â      â””â”€â”€ en<span class="hljs-selector-class">.lproj</span><br>â”‚Â Â          â””â”€â”€ InfoPlist<span class="hljs-selector-class">.strings</span><br>â”œâ”€â”€ LICENSE<br>â”œâ”€â”€ README<span class="hljs-selector-class">.md</span><br>â””â”€â”€ _Pods<span class="hljs-selector-class">.xcodeproj</span> -&gt; Example/Pods/Pods.xcodeproj<br></code></pre></td></tr></table></figure><h3 id="5ã€æ·»åŠ åº“æ–‡ä»¶"><a href="#5ã€æ·»åŠ åº“æ–‡ä»¶" class="headerlink" title="5ã€æ·»åŠ åº“æ–‡ä»¶"></a>5ã€æ·»åŠ åº“æ–‡ä»¶</h3><p>å°†è‡ªå·±çš„åº“æ–‡ä»¶æ‹–å…¥<code>/DaKit/DaKit/Classes</code>ç›®å½•ä¸­ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">.<br>â”œâ”€â”€ DaKit<br>â”‚Â Â  â”œâ”€â”€ Assets<br>â”‚Â Â  â””â”€â”€ Classes<br>â”‚Â Â      â””â”€â”€ Runtime<br>â”‚Â Â          â”œâ”€â”€ <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DaClassInfo</span>.</span></span>h<br>â”‚Â Â          â”œâ”€â”€ <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DaClassInfo</span>.</span></span>m<br>â”‚Â Â          â”œâ”€â”€ <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DaKakashi</span>.</span></span>h<br>â”‚Â Â          â””â”€â”€ <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DaSerialize</span>.</span></span>h<br>â”œâ”€â”€ <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DaKit</span>.</span></span>podspec<br>â”œâ”€â”€ Example<br>â”‚Â Â  â”œâ”€â”€ DaKit<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>Runtime</code>å³ä¸ºæˆ‘è‡ªå·±çš„åº“æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œä¸‹é¢æ˜¯å››ä¸ªDaå¼€å¤´çš„åº“æ–‡ä»¶~</p><h3 id="6ã€å®‰è£…åº“æ–‡ä»¶"><a href="#6ã€å®‰è£…åº“æ–‡ä»¶" class="headerlink" title="6ã€å®‰è£…åº“æ–‡ä»¶"></a>6ã€å®‰è£…åº“æ–‡ä»¶</h3><p>cd åˆ°Exampleç›®å½•ä¸‹ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pod <span class="hljs-keyword">install</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥ä¼šå°†åˆšæ‰æ‹–å…¥åˆ° Classes ç›®å½•ä¸­çš„æ–‡ä»¶å¯¼å…¥åˆ°ç¤ºä¾‹å·¥ç¨‹ä¸­ï¼›<br><br/></p><p>å¯¼å…¥åçš„åº“æ–‡ä»¶å¯åœ¨ DaKit.xcworkspace çš„ Pods.xcodeproj ä¸­æŸ¥çœ‹ã€‚</p><h3 id="7ã€ä¿®æ”¹-podspecæ–‡ä»¶"><a href="#7ã€ä¿®æ”¹-podspecæ–‡ä»¶" class="headerlink" title="7ã€ä¿®æ”¹.podspecæ–‡ä»¶"></a>7ã€ä¿®æ”¹.podspecæ–‡ä»¶</h3><p>DaKitå·¥ç¨‹æ ¹ç›®å½•ä¸‹.podspecæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-title class_">Pod::Spec</span>.new <span class="hljs-keyword">do</span> |<span class="hljs-params">s</span>|<br>  s.name             = <span class="hljs-string">&#x27;DaKit&#x27;</span><br>  s.version          = <span class="hljs-string">&#x27;0.1.1&#x27;</span><br>  s.summary          = <span class="hljs-string">&#x27;davidlii\&#x27;s Kit for iOS developing~&#x27;</span><br><br><span class="hljs-comment"># This description is used to generate tags and improve search results.</span><br><span class="hljs-comment">#   * Think: What does it do? Why did you write it? What is the focus?</span><br><span class="hljs-comment">#   * Try to keep it short, snappy and to the point.</span><br><span class="hljs-comment">#   * Write the description between the DESC delimiters below.</span><br><span class="hljs-comment">#   * Finally, don&#x27;t worry about the indent, CocoaPods strips it!</span><br><br>  s.description      = <span class="hljs-string">&lt;&lt;-DESC</span><br><span class="hljs-string">                       Kit to simplify your developing process, I will continuously update this Kit.</span><br><span class="hljs-string">                       DESC</span><br><br>  s.homepage         = <span class="hljs-string">&#x27;https://github.com/davidli-/DaKit&#x27;</span><br>  s.screenshots      = <span class="hljs-string">&#x27;https://davidlii.nos-eastchina1.126.net/pic_DaKit.png&#x27;</span><br>  s.license          = &#123; <span class="hljs-symbol">:type</span> =&gt; <span class="hljs-string">&#x27;MIT&#x27;</span>, <span class="hljs-symbol">:file</span> =&gt; <span class="hljs-string">&#x27;LICENSE&#x27;</span> &#125;<br>  s.author           = &#123; <span class="hljs-string">&#x27;davidlii&#x27;</span> =&gt; <span class="hljs-string">&#x27;macmafia@sina.cn&#x27;</span> &#125;<br>  s.source           = &#123; <span class="hljs-symbol">:git</span> =&gt; <span class="hljs-string">&#x27;https://github.com/davidli-/DaKit.git&#x27;</span>, <span class="hljs-symbol">:tag</span> =&gt; s.version.to_s &#125;<br>  s.social_media_url = <span class="hljs-string">&#x27;https://davidlii.cn&#x27;</span><br><br>  s.ios.deployment_target = <span class="hljs-string">&#x27;8.0&#x27;</span><br><br>  s.source_files = <span class="hljs-string">&#x27;DaKit/Classes/**/*&#x27;</span><br>  <br>  <span class="hljs-comment"># s.resource_bundles = &#123;</span><br>  <span class="hljs-comment">#   &#x27;DaKit&#x27; =&gt; [&#x27;DaKit/Assets/*.png&#x27;]</span><br>  <span class="hljs-comment"># &#125;</span><br><br>  <span class="hljs-comment"># s.public_header_files = &#x27;Pod/Classes/**/*.h&#x27;</span><br>  <span class="hljs-comment"># s.frameworks = &#x27;UIKit&#x27;, &#x27;MapKit&#x27;</span><br>  <span class="hljs-comment"># s.dependency &#x27;AFNetworking&#x27;, &#x27;~&gt; 2.3&#x27;</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®éœ€è¦ï¼Œä¿®æ”¹å¯¹åº”çš„é€‰é¡¹ï¼Œä¿®æ”¹ä¹‹åé‡æ–°ç¼–è¯‘é¡¹ç›®ï¼Œæµ‹è¯•æ˜¯å¦èƒ½é€šè¿‡ç¼–è¯‘~</p><h3 id="8ã€è¿œç¨‹ä»£ç ä»“åº“"><a href="#8ã€è¿œç¨‹ä»£ç ä»“åº“" class="headerlink" title="8ã€è¿œç¨‹ä»£ç ä»“åº“"></a>8ã€è¿œç¨‹ä»£ç ä»“åº“</h3><p>å›åˆ°ä»£ç åº“æ ¹ç›®å½•ï¼Œæäº¤ä»£ç åˆ°è¿œç¨‹ä»£ç ä»“åº“ï¼Œå¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">git</span> <span class="hljs-keyword">add</span> .<br><span class="hljs-symbol">git</span> commit -m â€œxâ€<br><span class="hljs-symbol">git</span> remote <span class="hljs-keyword">add</span> origin https:<span class="hljs-comment">//github.com/davidli-/DaKit.git(è¿œç¨‹ä»£ç åº“çš„åœ°å€)</span><br><span class="hljs-symbol">git</span> <span class="hljs-keyword">push</span> origin master<br></code></pre></td></tr></table></figure><p>è®¾ç½®æ ‡ç­¾ï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">tag</span> <span class="hljs-title">ç‰ˆæœ¬å·</span><br><span class="hljs-title">git</span> push â€”-tags (æ³¨æ„ï¼šä¸€å®šè¦å…ˆå°†<span class="hljs-keyword">tag</span>æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œå¦åˆ™åé¢éªŒè¯ä»“åº“æ—¶æ— æ³•é€šè¿‡éªŒè¯)<br></code></pre></td></tr></table></figure><p>CocoaPods ä¾èµ–äºæ ‡ç­¾ï¼Œæ ‡ç­¾çš„ç‰ˆæœ¬å·é¡»ä¸.podspecæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·ä¿æŒä¸€è‡´~</p><h3 id="9ã€éªŒè¯podspecæ–‡ä»¶"><a href="#9ã€éªŒè¯podspecæ–‡ä»¶" class="headerlink" title="9ã€éªŒè¯podspecæ–‡ä»¶"></a>9ã€éªŒè¯podspecæ–‡ä»¶</h3><p>éªŒè¯å¯åˆ†ä¸ºä¸¤ç§ï¼šéªŒè¯æœ¬åœ°å’Œè¿œç¨‹ä»“åº“ï¼Œéƒ½ç¨å¾®è´¹äº›æ—¶é—´ã€‚</p><h4 id="9-1-åªéªŒè¯æœ¬åœ°ä»“åº“"><a href="#9-1-åªéªŒè¯æœ¬åœ°ä»“åº“" class="headerlink" title="9.1.åªéªŒè¯æœ¬åœ°ä»“åº“"></a>9.1.åªéªŒè¯æœ¬åœ°ä»“åº“</h4><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal">pod <span class="hljs-class"><span class="hljs-keyword">lib</span> <span class="hljs-title">lint</span> ä»“åº“å.<span class="hljs-title">podspec</span></span><br></code></pre></td></tr></table></figure><h4 id="9-2-éªŒè¯è¿œç¨‹ä»“åº“"><a href="#9-2-éªŒè¯è¿œç¨‹ä»“åº“" class="headerlink" title="9.2.éªŒè¯è¿œç¨‹ä»“åº“"></a>9.2.éªŒè¯è¿œç¨‹ä»“åº“</h4><p>æ—¢éªŒè¯æœ¬åœ°ä»“åº“åˆéªŒè¯è¿œç¨‹ä»“åº“ï¼š</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">pod spec lint ä»“åº“å<span class="hljs-string">.podspec</span> <span class="hljs-params">--verbose</span> <span class="hljs-params">--allow-warnings</span><br></code></pre></td></tr></table></figure><p>å¦‚æœéªŒè¯é€šè¿‡ï¼Œåˆ™ä¼šæ˜¾ç¤ºå¦‚ä¸‹æ ·å¼ï¼š</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">** <span class="hljs-keyword">BUILD</span> SUCCEEDED **<br>    <br>   Testing <span class="hljs-keyword">with</span> <span class="hljs-symbol">`xcodebuild`</span>. <br> -&gt; DaKit (<span class="hljs-number">0.1</span><span class="hljs-number">.1</span>)<br>    - NOTE  | xcodebuild:  note: <span class="hljs-keyword">Using</span> new <span class="hljs-keyword">build</span> <span class="hljs-keyword">system</span><br>    - NOTE  | [iOS] xcodebuild:  note: Planning <span class="hljs-keyword">build</span><br>    - NOTE  | [iOS] xcodebuild:  note: Constructing <span class="hljs-keyword">build</span> description<br><br>Analyzed <span class="hljs-number">1</span> podspec.<br><br>DaKit.podspec passed validation.<br></code></pre></td></tr></table></figure><h3 id="10ã€æ¨é€ç´¢å¼•æ–‡ä»¶"><a href="#10ã€æ¨é€ç´¢å¼•æ–‡ä»¶" class="headerlink" title="10ã€æ¨é€ç´¢å¼•æ–‡ä»¶"></a>10ã€æ¨é€ç´¢å¼•æ–‡ä»¶</h3><p>å°†æœ¬åœ°ç´¢å¼•æ–‡ä»¶æ¨é€åˆ°è¿œç¨‹ç´¢å¼•åº“ï¼š</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">pod repo <span class="hljs-built_in">push</span> æœ¬åœ°ç´¢å¼•åº“ ç´¢å¼•æ–‡ä»¶å --<span class="hljs-built_in">verbose</span> --allow-<span class="hljs-built_in">warnings</span><br></code></pre></td></tr></table></figure><p>æˆ‘çš„ä¸ºï¼špod repo push davidlii DaKit.podspec â€“verbose â€“allow-warnings</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">. . . æ—¥å¿—<br>Pushing the `davidlii&#x27; repo<br><br>  $ /usr/bin/git -C /Users/Macmafia/.cocoapods/repos/davidlii push origin <span class="hljs-keyword">master</span><br>  <span class="hljs-title">To</span> https://github.com/davidli-/davidlii.git<br>     <span class="hljs-number">6</span>f4b19f..ebd5059  <span class="hljs-keyword">master</span> <span class="hljs-title">-&gt; master</span><br></code></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™äº›å³è¡¨ç¤ºæ¨é€æˆåŠŸï¼Œæ­¤æ—¶æŸ¥çœ‹æœ¬åœ°ç´¢å¼•åº“ï¼Œå…¶ç›®å½•å˜æˆï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">/Users/Macmafia/.cocoapods<br>.<br>â””â”€â”€ repos<br>    â”œâ”€â”€ davidlii<br>    â”‚Â Â  â””â”€â”€ DaKit<br>    â”‚Â Â      â””â”€â”€ <span class="hljs-number">0.1</span>.<span class="hljs-number">1</span><br>    â””â”€â”€ <span class="hljs-keyword">master</span><br>        <span class="hljs-title">â””â”€â”€ Specs</span><br></code></pre></td></tr></table></figure><p>davidlii ç›®å½•ä¸‹å¤šå‡ºäº†<code>DaKit</code>ç›®å½•å’Œåˆšæäº¤çš„åº“æ–‡ä»¶æ ‡ç­¾<code>0.1.1</code>ï¼Œå³è¡¨ç¤ºç´¢å¼•åˆ›å»ºæˆåŠŸ~</p><h3 id="11ã€å¯¼å…¥åº“ç§æœ‰åº“"><a href="#11ã€å¯¼å…¥åº“ç§æœ‰åº“" class="headerlink" title="11ã€å¯¼å…¥åº“ç§æœ‰åº“"></a>11ã€å¯¼å…¥åº“ç§æœ‰åº“</h3><p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å‘å¸ƒçš„è¿˜åªæ˜¯ç§æœ‰åº“ï¼Œå°šæ— æ³•é€šè¿‡<code>pod search</code>å‘½ä»¤ä»å®˜æ–¹<code>master</code>ç´¢å¼•åº“ä¸­æŸ¥æ‰¾çš„åˆ°~<br><br/></p><p>æ­¤ç§æœ‰åº“å¯åœ¨è‡ªå·±çš„é¡¹ç›®æˆ–å…¬å¸èŒƒå›´å†…ä½¿ç”¨ï¼Œåªéœ€åœ¨æƒ³è¦ä½¿ç”¨æ­¤åº“çš„å·¥ç¨‹ä¸­ä¿®æ”¹Podfileæ–‡ä»¶ï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs clean">########<br><br>use_frameworks!<br><br># æŒ‡å®šè‡ªåˆ¶åº“DaKitçš„è¿œç¨‹ç´¢å¼•åº“åœ°å€<br># æ–¹å¼<span class="hljs-number">1</span>ï¼šsource <span class="hljs-string">&#x27;https://github.com/davidli-/davidlii.git&#x27;</span><br><br>target <span class="hljs-string">&#x27;ASDF&#x27;</span> do<br># æ–¹å¼<span class="hljs-number">2</span>ï¼š<br>    pod <span class="hljs-string">&#x27;DaKit&#x27;</span>, :source =&gt; <span class="hljs-string">&#x27;https://github.com/davidli-/davidlii.git&#x27;</span><br>end<br><br>########<br></code></pre></td></tr></table></figure><p>å³ä½¿ç”¨<code>:source =&gt;</code>æŒ‡å®šç§æœ‰åº“çš„è¿œç¨‹ç´¢å¼•åº“åœ°å€å³å¯~</p><h3 id="12ã€å‘å¸ƒå…¬å¼€åº“"><a href="#12ã€å‘å¸ƒå…¬å¼€åº“" class="headerlink" title="12ã€å‘å¸ƒå…¬å¼€åº“"></a>12ã€å‘å¸ƒå…¬å¼€åº“</h3><ul><li>æ³¨å†Œpod trunk</li></ul><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">pod trunk register é‚®ç®± â€˜åç§°â€™</span> <span class="hljs-literal">--</span><span class="hljs-comment">description=â€˜xxxâ€™</span> <span class="hljs-literal">--</span><span class="hljs-comment">verbose</span><br></code></pre></td></tr></table></figure><ul><li>éªŒè¯é‚®ç®±</li></ul><p>å‰å¾€æ³¨å†Œæ—¶çš„é‚®ç®±ç‚¹å‡»é“¾æ¥å³å¯å®ŒæˆéªŒè¯~</p><ul><li>ç¡®è®¤æ³¨å†Œä¿¡æ¯</li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">pod trunk <span class="hljs-keyword">me</span><br></code></pre></td></tr></table></figure><h3 id="13ã€æäº¤-podspecæ–‡ä»¶"><a href="#13ã€æäº¤-podspecæ–‡ä»¶" class="headerlink" title="13ã€æäº¤.podspecæ–‡ä»¶"></a>13ã€æäº¤.podspecæ–‡ä»¶</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">pod trunk push DaKit.podspec --allow-warnings<br><br><span class="hljs-comment">// æ—¥å¿—</span><br>Updating spec repo <span class="hljs-code">`master`</span><br>Validating podspec<br><span class="hljs-code"> -&gt; DaKit (0.1.1)</span><br><span class="hljs-code">    - NOTE  | xcodebuild:  note: Using new build system</span><br><span class="hljs-code">    - NOTE  | [iOS] xcodebuild:  note: Planning build</span><br><span class="hljs-code">    - NOTE  | [iOS] xcodebuild:  note: Constructing build description</span><br><br>Updating spec repo <span class="hljs-code">`master`</span><br><br><span class="hljs-code">--------------------------------------------------------------------------------</span><br><span class="hljs-code"> ğŸ‰  Congrats</span><br><span class="hljs-code"></span><br><span class="hljs-code"> ğŸš€  DaKit (0.1.1) successfully published</span><br><span class="hljs-code"> ğŸ“…  August 31st, 08:23</span><br><span class="hljs-code"> ğŸŒ  https://cocoapods.org/pods/DaKit</span><br><span class="hljs-code"> ğŸ‘  Tell your friends!</span><br><span class="hljs-code">--------------------------------------------------------------------------------</span><br></code></pre></td></tr></table></figure><h3 id="14ã€æœç´¢è‡ªå·±çš„åº“"><a href="#14ã€æœç´¢è‡ªå·±çš„åº“" class="headerlink" title="14ã€æœç´¢è‡ªå·±çš„åº“"></a>14ã€æœç´¢è‡ªå·±çš„åº“</h3><ul><li>æŸ¥è¯¢trunk</li></ul><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown">pod trunk me<br><span class="hljs-bullet">  -</span> Name:     davidlii<br><span class="hljs-bullet">  -</span> Email:    macmafia@sina.cn<br><span class="hljs-bullet">  -</span> Since:    August 31st, 04:20<br><span class="hljs-bullet">  -</span> Pods:<br><span class="hljs-bullet">    -</span> DaKit<br><span class="hljs-bullet">  -</span> Sessions:<br><span class="hljs-bullet">    -</span> August 31st, 04:20 - January 6th, 2020 09:14. IP: 183.156.110.234<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>Pods:</code>ç›®å½•ä¸‹é¡ºåˆ©å‡ºç°äº†è‡ªåˆ¶çš„åº“ DaKitã€‚</p><ul><li>æŸ¥è¯¢pod</li></ul><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">pod search DaKit</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæ˜¾ç¤ºä»¥ä¸‹ç»“æœï¼Œåˆ™æäº¤å…¬å¼€åº“æˆåŠŸï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">DaKit</span> (<span class="hljs-number">0.1</span>.<span class="hljs-number">1</span>)<br>   davidlii<span class="hljs-symbol">&#x27;s</span> Kit <span class="hljs-keyword">for</span> <span class="hljs-title class_">iOS</span> developing~<br>   pod <span class="hljs-symbol">&#x27;DaKit</span>&#x27;, &#x27;~&gt; <span class="hljs-number">0.1</span>.<span class="hljs-number">1</span>&#x27;<br>   - Homepage: https:<span class="hljs-comment">//github.com/davidli-/DaKit</span><br>   - Source:   https:<span class="hljs-comment">//github.com/davidli-/DaKit.git</span><br>   - Versions: <span class="hljs-number">0.1</span>.<span class="hljs-number">1</span> [davidlii repo]<br></code></pre></td></tr></table></figure><p>å¦‚æœæ— æ³•æŸ¥åˆ°ï¼Œåˆ™å…ˆæ›´æ–°ç´¢å¼•åº“ï¼Œå†é‡æ–°æŸ¥æ‰¾ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">pod repo <span class="hljs-keyword">update</span><br>pod <span class="hljs-keyword">search</span> DaKit<br></code></pre></td></tr></table></figure><h3 id="15ã€å¯¼å…¥å…¬å¼€åº“"><a href="#15ã€å¯¼å…¥å…¬å¼€åº“" class="headerlink" title="15ã€å¯¼å…¥å…¬å¼€åº“"></a>15ã€å¯¼å…¥å…¬å¼€åº“</h3><p>ä¿®æ”¹Podfileæ–‡ä»¶ï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs clean">#######<br><br>use_frameworks!<br><br>target <span class="hljs-string">&#x27;ASDF&#x27;</span> do<br># ä½¿ç”¨å…¬å¼€åº“<br>    pod <span class="hljs-string">&#x27;DaKit&#x27;</span><br>end<br>#######<br></code></pre></td></tr></table></figure><p>å¯¼å…¥åº“æ–‡ä»¶ï¼š</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pod <span class="hljs-keyword">install</span><br></code></pre></td></tr></table></figure><h3 id="16ã€ä½¿ç”¨å…¬å¼€åº“"><a href="#16ã€ä½¿ç”¨å…¬å¼€åº“" class="headerlink" title="16ã€ä½¿ç”¨å…¬å¼€åº“"></a>16ã€ä½¿ç”¨å…¬å¼€åº“</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">// å®ä½“ç±» ***********</span><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">Card </span>: NSObject<br><span class="hljs-variable">@property</span> (nonatomic) int cardNumber; <span class="hljs-comment">// ç¼–å·</span><br><span class="hljs-variable">@property</span> (nonatomic) float money;    <span class="hljs-comment">// ä½™é¢</span><br><span class="hljs-variable">@end</span><br><br>#import <span class="hljs-string">&quot;Card.h&quot;</span><br><br><span class="hljs-comment">// å¯¼å…¥å¤´æ–‡ä»¶</span><br>#import &lt;DaKit/DaSerialize.h&gt;<br>#import &lt;DaKit/DaKakashi.h&gt;<br></code></pre></td></tr></table></figure><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@implementation</span> Card<br><br><span class="hljs-comment">// ä½¿ç”¨å®</span><br><span class="hljs-built_in">DaSerialize</span>()<br><span class="hljs-built_in">DaKakashi</span>()<br><br><span class="hljs-variable">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// æµ‹è¯• ***********</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Card.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;DaKit/DaClassInfo.h&gt;</span></span><br><br>- (<span class="hljs-type">void</span>)example&#123;<br>    Card *card = [[Card alloc] init];<br>    card.cardNumber = <span class="hljs-number">100</span>;<br>    card.money = <span class="hljs-number">50000000</span>;<br><br>    <span class="hljs-comment">// åºåˆ—åŒ–</span><br>    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSKeyedArchiver</span> archivedDataWithRootObject:card];<br>    Card *card2 = [<span class="hljs-built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:data];<br>    <br>    <span class="hljs-comment">// å¤åˆ¶</span><br>    Card *card3 = [card2 <span class="hljs-keyword">copy</span>];<br><br>    <span class="hljs-comment">// è·å–ç±»çš„ä¿¡æ¯</span><br>    <span class="hljs-built_in">NSArray</span> *ivars = [DaClassInfo ivarListWithClass:[Card <span class="hljs-keyword">class</span>]];<br>    <span class="hljs-built_in">NSArray</span> *props = [DaClassInfo propertyListWithClass:[Card <span class="hljs-keyword">class</span>]];<br>    <span class="hljs-built_in">NSArray</span> *meths = [DaClassInfo methodListWithClass:[Card <span class="hljs-keyword">class</span>]];<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>è‡³æ­¤ï¼Œç§æœ‰åº“å’Œå…¬æœ‰åº“çš„åˆ›å»ºä¸ä½¿ç”¨å‡å·²å®Œæˆï¼Œè¿‡ç¨‹ä¸­è¿˜æœ‰ä¸€äº›rubyæºå’Œç½‘ç»œç­‰é—®é¢˜ï¼ŒæŠ˜è…¾äº†å¥½ä¸€ä¼šå„¿ï¼Œæ¯ä¸ªäººçš„æƒ…å†µå¯èƒ½éƒ½ä¸å°½ç›¸åŒï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€ç½—åˆ—äº†ã€‚åº“å·²æäº¤ï¼Œä»¥åå°±å¯ä»¥å¿«ä¹çš„æ›´æ–°å•¦~</p><br/><p>æ¬¢è¿ä½¿ç”¨ä¸æŒ‡æ­£~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/davidli-/DaKit">Â©DaKit</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¶æ„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆ†åŒ…é…ç½®</title>
    <link href="/2019/04/18/majia.html"/>
    <url>/2019/04/18/majia.html</url>
    
    <content type="html"><![CDATA[<h3 id="æ€ç»´å¯¼å›¾"><a href="#æ€ç»´å¯¼å›¾" class="headerlink" title="æ€ç»´å¯¼å›¾"></a>æ€ç»´å¯¼å›¾</h3><p><img src="https://davidlii.nos-eastchina1.126.net/pic_majia_catelog.png" alt="catelog"></p><h3 id="Xcode-é»˜è®¤é…ç½®"><a href="#Xcode-é»˜è®¤é…ç½®" class="headerlink" title="Xcode é»˜è®¤é…ç½®"></a>Xcode é»˜è®¤é…ç½®</h3><p>Xcode åœ¨ç”Ÿæˆé¡¹ç›®æ—¶å·²ç»å¸®æˆ‘ä»¬é…ç½®å¥½äº†ä¸¤ä¸ªç¯å¢ƒï¼Œå¹¶ä¸”å·²ç»åœ¨åŒä¸€ä¸ªschemeä¸‹åšå¥½äº†é…ç½®ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_schemeeditor.png" alt="scheme"></p><p>#<strong>Debug</strong></p><br/><p>æµ‹è¯•ç¯å¢ƒï¼Œä¸€èˆ¬ Buildã€Runã€Test å’Œ Analyzeï¼Œéƒ½åœ¨è¿™ä¸ªç¯å¢ƒä¸­è¿›è¡Œã€‚</p><br/><p>#<strong>Release</strong></p><br/><p>ç”Ÿäº§ç¯å¢ƒï¼ŒProfile å’Œ Archive æ‰“åŒ…ä¸Šä¼ å•†åº—æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªç¯å¢ƒã€‚</p><br/><p>æŸ¥çœ‹<code>Build Settings</code>ï¼Œä½ èƒ½çœ‹åˆ°æ¯ä¸ªè®¾ç½®ä¸‹éƒ½åˆ†ä¸¤ç§ç¯å¢ƒï¼Œå¯ä»¥åšä¸åŒçš„è®¾ç½®ã€‚<br><br/></p><p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦çš„ä¸æ­¢è¿™ä¸¤ç§ç¯å¢ƒï¼Œå¯èƒ½è¿˜éœ€è¦ä¼ä¸šç‰ˆï¼Œåˆæˆ–è€…éœ€è¦åˆ·æ’åå¼•æµï¼Œè¿™æ—¶å°±éœ€è¦æˆ‘ä»¬è‡ªå·±é…ç½®è¿™äº›åˆ†åŒ…äº†ã€‚åˆ†åŒ…é…ç½®çš„å¤§è‡´åŸç†æ˜¯ï¼šåŒä¸€ä¸ª <code>TARGET</code> ä¸­è®¾ç½®ä¸åŒçš„ <code>Configurations</code>ï¼Œä»è€ŒåŒºåˆ†å„ç§ç¯å¢ƒã€‚ä¸‹é¢å°†ä»‹ç»å…·ä½“çš„é…ç½®æ­¥éª¤~</p><h3 id="1-é…ç½®-PROJECT"><a href="#1-é…ç½®-PROJECT" class="headerlink" title="1.é…ç½® PROJECT"></a>1.é…ç½® PROJECT</h3><h4 id="1-1-info"><a href="#1-1-info" class="headerlink" title="1.1.info"></a>1.1.info</h4><p><code>PROJECT</code>-&gt;<code>info</code>-&gt;<code>Configurations</code>ï¼Œç‚¹ä¸‹æ–¹<code>+</code>ï¼Œå¤åˆ¶ä¸€ä»½<code>Debug</code>æˆ–è€…<code>Rlease</code>çš„é…ç½®ï¼Œé‡æ–°å‘½åï¼Œå¦‚<code>InHouse</code>ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_project_info_configurarations.png" alt="info-configurations"></p><h4 id="1-2-Build-Settings"><a href="#1-2-Build-Settings" class="headerlink" title="1.2.Build Settings"></a>1.2.Build Settings</h4><p><code>PROJECT</code>-&gt;<code>Build Settings</code>ï¼Œç‚¹é¡¶éƒ¨æœç´¢æ¡†å·¦è¾¹çš„<code>+</code>ï¼ŒAdd User-Defined Settingsï¼Œè®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„å®ï¼Œå¦‚<code>APP_NAME</code>ï¼Œåˆ†åˆ«è¾“å…¥åç§°ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_buldset-userdefine.png" alt="buildset-userdefine"></p><h3 id="2-é…ç½®-TARGETS"><a href="#2-é…ç½®-TARGETS" class="headerlink" title="2.é…ç½® TARGETS"></a>2.é…ç½® TARGETS</h3><p><code>TARGETS</code>ä¼šè‡ªåŠ¨ç»§æ‰¿<code>PROJECT</code>ä¸­çš„é…ç½®ï¼›åè¿‡æ¥ï¼Œå¯¹<code>TARGETS</code>æ‰€åšçš„ä¿®æ”¹å¹¶ä¸ä¼šä¸»åŠ¨æ˜ å°„åˆ°<code>PROJECT</code>ä¸­ï¼Œéœ€è¦æ‰‹åŠ¨å¤åˆ¶ã€‚ä¸å¤åˆ¶ä¹Ÿå¯ä»¥ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨ï¼Œå› ä¸º Xcode ä¼šä»¥<code>TARGETS</code>ä¸­çš„é…ç½®ä¸ºå‡†ã€‚</p><h4 id="2-1-Build-Settings"><a href="#2-1-Build-Settings" class="headerlink" title="2.1.Build Settings"></a>2.1.Build Settings</h4><p><code>TARGETS</code>-&gt;<code>Build Settings</code>ä¸­ç¿»åˆ°åº•ï¼Œ<code>User-Defined</code>é€‰é¡¹ä¸­è‡ªåŠ¨ç»§æ‰¿äº†<code>PROJECT</code>ä¸­<code>APP_NAME</code>çš„é…ç½®ã€‚åŒæ ·å¯ä»¥åœ¨è¿™é‡Œç‚¹é¡¶éƒ¨çš„<code>+</code>ï¼ŒAdd User-Defined Settingsï¼Œæ·»åŠ æ–°çš„é…ç½®é¡¹ï¼Œå¦‚<code>APP_BUNDLE_ID</code>ã€‚åœ¨<code>TARGETS</code>-&gt;<code>info</code>ä¸­ä¿®æ”¹ Bundle display name ä¸º<code>$&#123;APP_NAME&#125;</code>ã€‚è¿™æ ·å°±å¯ä»¥ç»™ä¸åŒåˆ†åŒ…èµ·ä¸åŒçš„åå­—ï¼Œæˆ–è€…ä¸åŒçš„ Bundle Identifierã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_display_name.png" alt="APP_NAME"></p><h4 id="2-3-é…ç½®-preprocessor-Macros"><a href="#2-3-é…ç½®-preprocessor-Macros" class="headerlink" title="2.3.é…ç½® preprocessor Macros"></a>2.3.é…ç½® preprocessor Macros</h4><p>è¿™æ˜¯é¢„å¤„ç†çš„å®ï¼Œåé¢ä»£ç ä¸­å¯ä½œä¸º<code>æ ‡è®°</code>åŒºåˆ†ä¸åŒç¯å¢ƒã€‚å¯è‡ªè¡Œè®¾ç½®:</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_macros.png" alt="Macros"></p><h4 id="2-4-ä»£ç ä¸­ä½¿ç”¨"><a href="#2-4-ä»£ç ä¸­ä½¿ç”¨" class="headerlink" title="2.4.ä»£ç ä¸­ä½¿ç”¨"></a>2.4.ä»£ç ä¸­ä½¿ç”¨</h4><p>ä»¥ UIabel ä¸Šçš„æ–‡å­—æ˜¾ç¤ºä¸ºä¾‹ï¼Œè¦æ±‚ä¸åŒç¯å¢ƒä¸­æ˜¾ç¤ºå¯¹åº”çš„ç¯å¢ƒåï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sqf">- <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> DEBUG</span><br>      <span class="hljs-comment">//Debug</span><br>      <span class="hljs-variable">_mLable</span>.<span class="hljs-built_in">text</span> = @<span class="hljs-string">&quot;DEBUG&quot;</span>;<br>  <span class="hljs-meta">#elif M_InHouse</span><br>      <span class="hljs-comment">//InHouse</span><br>      <span class="hljs-variable">_mLable</span>.<span class="hljs-built_in">text</span> = @<span class="hljs-string">&quot;InHouse&quot;</span>;<br>  <span class="hljs-meta">#elif M_Release</span><br>      <span class="hljs-comment">//Release</span><br>      <span class="hljs-variable">_mLable</span>.<span class="hljs-built_in">text</span> = @<span class="hljs-string">&quot;Release&quot;</span>;<br>  <span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>      <span class="hljs-comment">//Invalid</span><br>      <span class="hljs-variable">_mLable</span>.<span class="hljs-built_in">text</span> = @<span class="hljs-string">&quot;é»˜è®¤å€¼&quot;</span>;<br>  <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯é€šè¿‡ä½¿ç”¨<code>#ifdef</code>ã€<code>#elif</code>ã€<code>#else</code>æ¥åˆ¤æ–­æ˜¯å¦æœ‰æŸä¸ªå®å®šä¹‰ï¼Œè€Œè¿™äº›å®å®šä¹‰æ­£æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ preprocessor Macros ä¸­å®šä¹‰å¥½çš„ä¸€äº›æ ‡è®°ã€‚è¿è¡ŒæŸ¥çœ‹æ•ˆæœå³å¯~</p><h3 id="3-é…ç½®-Scheme"><a href="#3-é…ç½®-Scheme" class="headerlink" title="3.é…ç½® Scheme"></a>3.é…ç½® Scheme</h3><p><code>Scheme</code>-&gt;<code>Manage Schemes</code>-&gt;<code>é½¿è½®</code>ï¼Œå¤åˆ¶ä¸€ä»½å¹¶é‡æ–°å‘½åä¸º<code>Release</code>æˆ–è€…<code>InHouse</code>ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_manage_scheme.png" alt="Manage Schemes"></p><p><code>Edit Scheme</code>ï¼Œå°† Build&#x2F;Run&#x2F;Test&#x2F;Profile&#x2F;Analyze&#x2F;Archive çš„ Build Configuration è®¾ç½®æˆ<code>PROJECT</code>ä¸­çš„ Configurations ä¸­å¯¹åº”çš„åå­—ï¼Œå¦‚<code>Rlease</code>ã€<code>InHouse</code>ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_edit_scheme.png" alt="Edit Scheme"></p><p>è¿™ä¸€æ­¥é…ç½® scheme æ˜¯ä¸ºæ‰“åŒ…æ—¶æ›´å®¹æ˜“çš„åŒºåˆ†ç¯å¢ƒï¼Œä»¥é˜²å¤±è¯¯å¯¼è‡´æ‰“é”™åŒ…ã€‚åŒæ—¶ï¼Œå¦‚æœä½ ä½¿ç”¨äº†è„šæœ¬è¿›è¡Œæ‰“åŒ…æˆ–è€…ç»™ä¸åŒåˆ†åŒ…æ›¿æ¢å›¾ç‰‡ç´ ææ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ª scheme è¿›è¡ŒåŒºåˆ†ã€‚</p><h3 id="4-é…ç½®-Pod-å·¥ç¨‹"><a href="#4-é…ç½®-Pod-å·¥ç¨‹" class="headerlink" title="4.é…ç½® Pod å·¥ç¨‹"></a>4.é…ç½® Pod å·¥ç¨‹</h3><p>å¦‚æœå·¥ç¨‹é›†æˆäº†ä¸‰æ–¹åº“ï¼Œé‚£ä¹ˆ<code>Pods</code>å·¥ç¨‹ä¹Ÿéœ€è¦é’ˆå¯¹åˆ†åŒ…è¿›è¡Œé…ç½®ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_majia_pod.png" alt="pods"></p><p>è¿™é‡Œçš„<code>Configurations</code>ä¸åŸå·¥ç¨‹ä¸­ä¸€è‡´å³å¯ã€‚</p><h3 id="5-è„šæœ¬æ›¿æ¢ç´ æ"><a href="#5-è„šæœ¬æ›¿æ¢ç´ æ" class="headerlink" title="5.è„šæœ¬æ›¿æ¢ç´ æ"></a>5.è„šæœ¬æ›¿æ¢ç´ æ</h3><p>æˆ‘çš„å·¥ç¨‹ç›®å½•ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs stylus">.<br>â”œâ”€â”€ AutoBuild<br>â”‚Â Â  â”œâ”€â”€ ExportOptions<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”œâ”€â”€ Header<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”œâ”€â”€ replace_res<span class="hljs-selector-class">.sh</span><br>â”‚Â Â  â””â”€â”€ res<br>â”‚Â Â      â”œâ”€â”€ drawable<br>â”‚Â Â      â”œâ”€â”€ <span class="hljs-attribute">icon</span><br>â”‚Â Â      â””â”€â”€ launcher<br>â”œâ”€â”€ Majia<br>â”‚Â Â  â”œâ”€â”€ AppDelegate<span class="hljs-selector-class">.h</span><br>â”‚Â Â  â”œâ”€â”€ AppDelegate<span class="hljs-selector-class">.m</span><br>â”‚Â Â  â”œâ”€â”€ Assets<span class="hljs-selector-class">.xcassets</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ AppIcon<span class="hljs-selector-class">.appiconset</span><br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Contents<span class="hljs-selector-class">.json</span><br>â”‚Â Â  â”‚Â Â  â””â”€â”€ LaunchImage<span class="hljs-selector-class">.launchimage</span><br>â”‚Â Â  â”œâ”€â”€ Info<span class="hljs-selector-class">.plist</span><br>â”‚Â Â  â”œâ”€â”€ <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.m</span><br>â”‚Â Â  â””â”€â”€ res<br>â”œâ”€â”€ Majia<span class="hljs-selector-class">.xcodeproj</span><br>â”œâ”€â”€ Majia<span class="hljs-selector-class">.xcworkspace</span><br>â”œâ”€â”€ Podfile<br>â”œâ”€â”€ Podfile<span class="hljs-selector-class">.lock</span><br>â”œâ”€â”€ Pods<br>â””â”€â”€autobuild.sh<br></code></pre></td></tr></table></figure><p>æ ¹æ®ä¸åŒåˆ†åŒ…çš„éœ€è¦ï¼Œä½¿ç”¨è„šæœ¬æ›¿æ¢ç´ æ<code>replace_res.sh</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br><span class="hljs-comment">#works for  Xcode 7.0+ only</span><br><br><span class="hljs-comment">#è·å–å‘½ä»¤è¡Œä¸­æ¥æ”¶åˆ°çš„scheme</span><br>TARGET_SCHEMES=<span class="hljs-variable">$1</span><br><br><span class="hljs-keyword">if</span> [ ! -n <span class="hljs-string">&quot;<span class="hljs-variable">$TARGET_SCHEMES</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt; TARGET_SCHEMES is missing!!!&quot;</span><br>  <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Start replacing RES at <span class="hljs-subst">$(date)</span> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><br><br>AUTOBUILD_PATH=<span class="hljs-variable">$PWD</span><br>PROJECT_ROOT_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$AUTOBUILD_PATH</span>/..&quot;</span><br><br><span class="hljs-comment">#å¯¼å‡ºé…ç½®</span><br>EXPORT_ICON_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$AUTOBUILD_PATH</span>/res/icon&quot;</span><br>EXPORT_LAUNCHER_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$AUTOBUILD_PATH</span>/res/launcher&quot;</span><br>EXPORT_DRAWABLE_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$AUTOBUILD_PATH</span>/res/drawable&quot;</span><br><br><span class="hljs-comment">#icon Assets assets</span><br>ICON_ASSETS=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/Majia/Assets.xcassets/AppIcon.appiconset/&quot;</span><br>LAUNCHER_ASSETS=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/Majia/Assets.xcassets/LaunchImage.launchimage/&quot;</span><br>DRAWABLE_ASSETS=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/Majia/res/&quot;</span><br><br><span class="hljs-comment">#replace icons</span><br><span class="hljs-built_in">cp</span> -R -a <span class="hljs-string">&quot;<span class="hljs-variable">$EXPORT_ICON_PATH</span>/<span class="hljs-variable">$TARGET_SCHEMES</span>/.&quot;</span> <span class="hljs-variable">$ICON_ASSETS</span><br><span class="hljs-comment">#replace launchers</span><br><span class="hljs-built_in">cp</span> -R -a <span class="hljs-string">&quot;<span class="hljs-variable">$EXPORT_LAUNCHER_PATH</span>/<span class="hljs-variable">$TARGET_SCHEMES</span>/.&quot;</span> <span class="hljs-variable">$LAUNCHER_ASSETS</span><br><span class="hljs-comment">#replace drawables</span><br><span class="hljs-built_in">cp</span> -R -a <span class="hljs-string">&quot;<span class="hljs-variable">$EXPORT_DRAWABLE_PATH</span>/<span class="hljs-variable">$TARGET_SCHEMES</span>/.&quot;</span> <span class="hljs-variable">$DRAWABLE_ASSETS</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Finish replacing RES at <span class="hljs-subst">$(date)</span> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><br></code></pre></td></tr></table></figure><p>åœ¨ç»ˆç«¯é‡Œ cd åˆ°æ ¹ç›®å½•ä¸‹çš„<code>AutoBuild</code>ç›®å½•æ‰§è¡Œè¯¥è„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$</span><span class="language-bash">./replace_res.sh InHouse</span><br></code></pre></td></tr></table></figure><p>è„šæœ¬åçš„å‚æ•°æ˜¯ä½ æƒ³æ›¿æ¢ç´ æçš„åˆ†åŒ…<code>scheme</code>ã€‚</p><h4 id="6-è„šæœ¬æ‰“åŒ…"><a href="#6-è„šæœ¬æ‰“åŒ…" class="headerlink" title="6.è„šæœ¬æ‰“åŒ…"></a>6.è„šæœ¬æ‰“åŒ…</h4><p>cd åˆ°æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä¸‹é¢çš„æ‰“åŒ…è„šæœ¬<code>autobuild.sh</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br><span class="hljs-comment">#works for  Xcode 7.0+ only</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Start at <span class="hljs-subst">$(date)</span> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><br><br>PROJECT_ROOT_PATH=<span class="hljs-variable">$PWD</span><br>AUTOBUILD_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/AutoBuild&quot;</span><br><br>CURRENT_DATE=$(<span class="hljs-built_in">date</span> +%Y_%m%d_%H%M)<br>WORKSPACE_NAME=<span class="hljs-string">&quot;Majia.xcworkspace&quot;</span><br><br><span class="hljs-comment">#å¯¼å‡ºé…ç½®</span><br>HEADER_PLIST=<span class="hljs-string">&quot;<span class="hljs-variable">$AUTOBUILD_PATH</span>/Header.plist&quot;</span><br>EXPORT_PLIST=<span class="hljs-string">&quot;<span class="hljs-variable">$AUTOBUILD_PATH</span>/ExportOptions.plist&quot;</span><br><br><span class="hljs-comment">#Info key</span><br>KEY_SCHEME=<span class="hljs-string">&quot;KEY_SCHEME&quot;</span><br>KEY_APP_NAME=<span class="hljs-string">&quot;KEY_APP_NAME&quot;</span><br>KEY_TEAM_ID=<span class="hljs-string">&quot;KEY_TEAM_ID&quot;</span><br>KEY_DEV_ID=<span class="hljs-string">&quot;KEY_DEV_ID&quot;</span><br><br><span class="hljs-comment">#Flavors</span><br>InHouse=&#123;<span class="hljs-variable">$KEY_SCHEME</span>:<span class="hljs-string">&quot;InHouse&quot;</span>,<span class="hljs-variable">$KEY_APP_NAME</span>:<span class="hljs-string">&quot;InHouse&quot;</span>,<span class="hljs-variable">$KEY_TEAM_ID</span>:<span class="hljs-string">&quot;your_team_ID&quot;</span>,<span class="hljs-variable">$KEY_DEV_ID</span>:<span class="hljs-string">&quot;your_team&quot;</span>&#125;<br>Release=&#123;<span class="hljs-variable">$KEY_SCHEME</span>:<span class="hljs-string">&quot;Release&quot;</span>,<span class="hljs-variable">$KEY_APP_NAME</span>:<span class="hljs-string">&quot;Release&quot;</span>,<span class="hljs-variable">$KEY_TEAM_ID</span>:<span class="hljs-string">&quot;your_team_ID&quot;</span>,<span class="hljs-variable">$KEY_DEV_ID</span>:<span class="hljs-string">&quot;your_team&quot;</span>&#125;<br><br><span class="hljs-comment">#SELECT FLAVORS</span><br>FLAVORS=(<span class="hljs-variable">$Release</span>,<span class="hljs-variable">$InHouse</span>)<br><br><span class="hljs-comment">#Parse method</span><br><span class="hljs-function"><span class="hljs-title">parse_json</span></span>()&#123;<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$1</span> | sed <span class="hljs-string">&#x27;s/.*&#x27;</span><span class="hljs-variable">$2</span><span class="hljs-string">&#x27;:\([^,&#125;]*\).*/\1/&#x27;</span><br>&#125;<br><br><span class="hljs-comment">#build release apps directory</span><br>BUILD_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/Build&quot;</span><br>RELEASE_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$BUILD_DIR</span>/Products&quot;</span><br><br><span class="hljs-built_in">rm</span> -rdf <span class="hljs-variable">$BUILD_DIR</span><br><br><span class="hljs-comment">#final binarys&#x27; directory</span><br>OUT_BINARY_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/binarys_<span class="hljs-variable">$CURRENT_DATE</span>&quot;</span><br><br><span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$OUT_BINARY_DIR</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$OUT_BINARY_DIR</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">for</span> ((i = 0; i &lt; <span class="hljs-variable">$&#123;#FLAVORS[@]&#125;</span>; i++))<br><span class="hljs-keyword">do</span><br>  <br>  <span class="hljs-comment">#parse elements</span><br>  TARGET_SCHEMES=$(parse_json <span class="hljs-variable">$&#123;FLAVORS[$i]&#125;</span> <span class="hljs-variable">$KEY_SCHEME</span>)<br>  TARGET_APP_NAMES=$(parse_json <span class="hljs-variable">$&#123;FLAVORS[$i]&#125;</span> <span class="hljs-variable">$KEY_APP_NAME</span>)<br>  TARGET_TEAM_IDS=$(parse_json <span class="hljs-variable">$&#123;FLAVORS[$i]&#125;</span> <span class="hljs-variable">$KEY_TEAM_ID</span>)<br>  TARGET_DEV_IDS=$(parse_json <span class="hljs-variable">$&#123;FLAVORS[$i]&#125;</span> <span class="hljs-variable">$KEY_DEV_ID</span>)<br><br>  <span class="hljs-comment">#reset export options plist</span><br>  <span class="hljs-built_in">rm</span> <span class="hljs-variable">$EXPORT_PLIST</span><br>  <br>  <span class="hljs-built_in">cat</span> <span class="hljs-variable">$HEADER_PLIST</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;plist version=\&quot;1.0\&quot;&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;dict&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;key&gt;teamID&lt;/key&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;string&gt;<span class="hljs-variable">$TARGET_TEAM_IDS</span>&lt;/string&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;key&gt;method&lt;/key&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; target scheme <span class="hljs-variable">$TARGET_SCHEMES</span>&quot;</span><br>  <br>  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$TARGET_SCHEMES</span> = <span class="hljs-string">&quot;InHouse&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;string&gt;enterprise&lt;/string&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; enterprise Done&quot;</span><br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;string&gt;app-store&lt;/string&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; app-store Done&quot;</span><br>  <span class="hljs-keyword">fi</span><br>  <br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;key&gt;uploadSymbols&lt;/key&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;true/&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;/dict&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;/plist&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br>  <br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Reset export options Done&quot;</span><br><br>  <span class="hljs-built_in">cd</span> <span class="hljs-variable">$AUTOBUILD_PATH</span><br>  ./replace_res.sh <span class="hljs-variable">$TARGET_SCHEMES</span><br><br>  <span class="hljs-comment"># return root</span><br>  <span class="hljs-built_in">cd</span> <span class="hljs-variable">$PROJECT_ROOT_PATH</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Reset res Done&quot;</span><br>  <br>  <span class="hljs-comment">#export files</span><br>  ARCHIVE_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$OUT_BINARY_DIR</span>/<span class="hljs-variable">$TARGET_APP_NAMES</span>.xcarchive&quot;</span><br>  DSYMS_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$TARGET_APP_NAMES</span>.dSYMs.zip&quot;</span><br>  <br>  <span class="hljs-comment">#clean prject</span><br>  xcodebuild -workspace <span class="hljs-variable">$WORKSPACE_NAME</span> -scheme <span class="hljs-variable">$TARGET_SCHEMES</span> -configuration <span class="hljs-variable">$TARGET_APP_NAMES</span> clean<br>  <br>  <span class="hljs-comment">#build &amp; archive</span><br>  xcodebuild archive -workspace <span class="hljs-variable">$WORKSPACE_NAME</span> -scheme <span class="hljs-variable">$TARGET_SCHEMES</span> -configuration <span class="hljs-variable">$TARGET_APP_NAMES</span> -archivePath <span class="hljs-variable">$ARCHIVE_FILE</span><br>  <br>  <span class="hljs-built_in">cd</span> <span class="hljs-variable">$ARCHIVE_FILE</span><br>  zip -r <span class="hljs-variable">$DSYMS_FILE</span> <span class="hljs-string">&quot;dSYMs&quot;</span><br>  <span class="hljs-built_in">mv</span> <span class="hljs-variable">$DSYMS_FILE</span> <span class="hljs-variable">$OUT_BINARY_DIR</span><br>  <br>  <span class="hljs-comment"># return root</span><br>  <span class="hljs-built_in">cd</span> <span class="hljs-variable">$PROJECT_ROOT_PATH</span><br>  <br>  <span class="hljs-comment">#export</span><br>  xcodebuild -exportArchive -archivePath <span class="hljs-variable">$ARCHIVE_FILE</span> -exportPath <span class="hljs-variable">$OUT_BINARY_DIR</span> -exportOptionsPlist <span class="hljs-variable">$EXPORT_PLIST</span><br>  <br>  <span class="hljs-comment">#rename ipa file failed since creating ipa file is asynchronized</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;apple id paired&quot;</span> &gt;&gt; <span class="hljs-string">&quot;<span class="hljs-variable">$OUT_BINARY_DIR</span>/$TARGET_APP_NAMES_<span class="hljs-variable">$TARGET_DEV_IDS</span>&quot;</span><br>  <br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; <span class="hljs-variable">$TARGET_SCHEMES</span> single loop Done&quot;</span><br>  <br><span class="hljs-keyword">done</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Finish at <span class="hljs-subst">$(date)</span> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®éœ€è¦ä¿®æ”¹è„šæœ¬ä¸­çš„ teamID å’Œå¼€å‘è€…è¯ä¹¦ä¿¡æ¯ï¼Œä¿®æ”¹å°†è¦æ‰“åŒ…çš„ schemeï¼Œcd åˆ°å·¥ç¨‹æ ¹ç›®å½•æ‰§è¡Œè„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$</span><span class="language-bash">./autobuild.sh</span><br></code></pre></td></tr></table></figure><p>æ­¤è„šæœ¬åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ul><li>ç”Ÿæˆæ‰“åŒ…æ‰€éœ€çš„ ExportOptions.plistï¼›</li><li>è‡ªåŠ¨æ‰§è¡Œ <code>replace_res.sh</code> è„šæœ¬æ›¿æ¢ç´ æï¼Œä½ æ— é¡»æ‰‹åŠ¨æ‰§è¡Œäº†ï¼›</li><li>æ ¹æ®æŒ‡å®šçš„ <code>scheme</code> æ‰§è¡Œ archiveï¼›</li><li>å¯¼å‡º<code>dSYM</code>æ–‡ä»¶ï¼›</li><li>å¯¼å‡º ipaã€‚</li></ul><h3 id="7-å°ç¼ºç‚¹"><a href="#7-å°ç¼ºç‚¹" class="headerlink" title="7.å°ç¼ºç‚¹"></a>7.å°ç¼ºç‚¹</h3><p>æ ¹æ®æˆ‘è‡ªå·±çš„ä½¿ç”¨æƒ…å†µæ¥çœ‹ï¼Œé…ç½®è¿‡å¤šåˆ†åŒ…æ—¶ï¼Œåœ¨ Xcode ä¸­æ‰“å¼€<code>Build Settings</code>ä¼šéå¸¸å¡ã€‚è¿™å¯èƒ½æ˜¯å› ä¸º Xcode ä¸­çš„å„ç§é…ç½®ä»æœ¬è´¨ä¸Šæ¥è¯´éƒ½æ˜¯ä¿å­˜åœ¨ plist ä¸­ï¼ŒåŠ è½½æ­¤é…ç½®æ–‡ä»¶æ—¶ï¼Œè¦è¯»å–Nä¸ªåˆ†åŒ…çš„èŠ‚ç‚¹ï¼Œæ˜¯éœ€è¦èŠ±è´¹ä¸€å®šæ—¶é—´ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/davidli-/Majia.git">Â©é¡¹ç›®ä»£ç </a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•ˆç‡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åº”ç”¨çš„å®‰å…¨</title>
    <link href="/2019/04/02/safeapp.html"/>
    <url>/2019/04/02/safeapp.html</url>
    
    <content type="html"><![CDATA[<p>è¿™æ®µæ—¶é—´ iOS12 è¶Šç‹±å·¥å…·å‘å¸ƒäº†ï¼Œå±é¢ å±é¢ çš„å»ç ”ç©¶äº†ä¸€é”®ç ¸å£³ï¼Œæ˜¨å¤©å¿½ç„¶æƒ³èµ·æ¥ä¹‹å‰å…¬å¸çš„äº§å“è¢«äººç ´è§£ï¼Œæ‹¿åˆ°äº†å…³é”®ä¿¡æ¯è¿›è€Œè–…ç¾Šæ¯›çš„äº‹ã€‚é‚£æ—¶çš„è§£å†³æ–¹æ¡ˆæ˜¯æ£€æµ‹å¼‚å¸¸è¯·æ±‚å’Œç‹¬ç«‹å‡ºä¸€ä¸ªåŠ å¯†<code>framework</code>ã€‚ç°åœ¨æƒ³æƒ³ï¼Œè¿™äº›æªæ–½éƒ½å¤ªç®€å•æˆ–è€…ä¸å¤Ÿé«˜æ•ˆï¼Œè¿˜éœ€è¦æ›´è¿›ä¸€æ­¥ç ”ç©¶åº”ç”¨çš„å®‰å…¨é—®é¢˜ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_safe_app.png" alt="çº²ç›®"></p><h3 id="1-è¢«ç ´è§£çš„å±å®³"><a href="#1-è¢«ç ´è§£çš„å±å®³" class="headerlink" title="1.è¢«ç ´è§£çš„å±å®³"></a>1.è¢«ç ´è§£çš„å±å®³</h3><ul><li>è¢«äººé€†å‘åˆ†æé€šä¿¡åè®®ã€APIã€æ ¸å¿ƒç®—æ³•ç­‰ï¼›</li><li>ç¯¡æ”¹IPAã€æ¤å…¥å¹¿å‘Šå’Œæœ¨é©¬ï¼›</li><li>é‡æ‰“åŒ…å¹¶å‘å¸ƒç›—ç‰ˆåº”ç”¨ï¼›</li><li>ç ´è§£å†…è´­ï¼›</li></ul><h3 id="2-é˜²èŒƒ"><a href="#2-é˜²èŒƒ" class="headerlink" title="2.é˜²èŒƒ"></a>2.é˜²èŒƒ</h3><p>åœ¨è¿™æ–¹é¢æˆ‘æ˜¯çœŸæ²¡æœ‰ç»éªŒï¼Œäºæ˜¯æŠ±ç€å­¦ä¹ çš„æ€åº¦å»æŸ¥çœ‹äº†ç›¸å…³çš„è®ºå›å’Œèµ„æ–™ï¼Œå­¦å­¦åˆ«äººçš„ç»éªŒï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„è®°å½•~</p><h4 id="2-1-æ£€æµ‹æ˜¯å¦è¶Šç‹±ï¼ˆå¿µèŒœï¼‰"><a href="#2-1-æ£€æµ‹æ˜¯å¦è¶Šç‹±ï¼ˆå¿µèŒœï¼‰" class="headerlink" title="2.1.æ£€æµ‹æ˜¯å¦è¶Šç‹±ï¼ˆå¿µèŒœï¼‰"></a>2.1.æ£€æµ‹æ˜¯å¦è¶Šç‹±ï¼ˆå¿µèŒœï¼‰</h4><p>è¿™æ˜¯æœ€å¸¸è§çš„è¢«åŠ¨é˜²å¾¡æ–¹æ³•ï¼Œæ¯”å¦‚å½“åº”ç”¨å¯åŠ¨æ—¶ï¼Œå…ˆæ£€æµ‹è®¾å¤‡æ˜¯å¦å·²ç»è¶Šç‹±ï¼Œå¦‚æœå·²è¶Šç‹±åˆ™ç¦æ­¢åº”ç”¨å¯åŠ¨ï¼›åœ¨ç”¨æˆ·å‘èµ·å†…è´­æ”¯ä»˜æ—¶ï¼Œå¦‚æœå‘ç°è®¾å¤‡å·²è¶Šç‹±ï¼Œåˆ™ç›´æ¥æ‹’ç»å†…è´­è¯·æ±‚å¹¶ç»™å‡ºç›¸åº”çš„æç¤ºã€‚æ ¹æ®æˆ‘çš„æµ‹è¯•ï¼Œ<code>éƒ¨è½å†²çª</code>æ¸¸æˆå°±æ˜¯é€šè¿‡é—ªé€€ç›´æ¥ç¦æ­¢è¶Šç‹±è®¾å¤‡å¯åŠ¨è‡ªå·±ï¼Œè€Œè…¾è®¯æ——ä¸‹çš„äº§å“åŸºæœ¬ä¸Šéƒ½ä¼šåœ¨è¶Šç‹±è®¾å¤‡å‘èµ·æ”¯ä»˜æ—¶ç»™å‡ºæç¤ºï¼Œ<code>åˆ«è¸©éŸ³ä¹å—å„¿</code>ä¹Ÿæ˜¯å¦‚æ­¤ã€‚<br><br/></p><p>ä»¥ä¸‹æ‘˜è‡ª<a href="https://blog.csdn.net/yiyaaixuexi/article/details/20286929">å¿µèŒœ</a>çš„åšå®¢ï¼š</p><ul><li>æ£€æµ‹è¶Šç‹±æ–‡ä»¶æˆ–ç›®å½•</li></ul><p>è¶Šç‹±åçš„è®¾å¤‡ä¸­ä¼šæœ‰ç›¸å…³çš„æ–‡ä»¶ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/Applications/</span>Cydia.app<br><span class="hljs-regexp">/Library/</span>MobileSubstrate/MobileSubstrate.dylib<br><span class="hljs-regexp">/bin/</span>bash<br><span class="hljs-regexp">/usr/</span>sbin/sshd<br><span class="hljs-regexp">/etc/</span>apt<br></code></pre></td></tr></table></figure><p>æ£€æµ‹æ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+(<span class="hljs-type">BOOL</span>)isJailbroken&#123;<br><span class="hljs-keyword">if</span> ([[<span class="hljs-built_in">NSFileManager</span> defaultManager] fileExistsAtPath:<span class="hljs-string">@&quot;/Applications/Cydia.app&quot;</span>])&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ£€æµ‹ Cydia çš„ URL scheme</li></ul><p>è¶Šç‹±åçš„è®¾å¤‡ä¸€èˆ¬éƒ½ä¼šå®‰è£… Cydiaï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡æ£€æµ‹å…¶ URL Scheme æ¥åæ¨è®¾å¤‡æ˜¯å¦è¶Šç‹±ã€‚è¿™ä¸ªæ–¹æ³•åœ¨ iOS9 ä¹‹åä¼šå› ä¸ºæƒé™é—®é¢˜è€Œå‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥ä½ éœ€è¦é…ç½®å¥½<code>LSApplicationQueriesSchemes</code>ç™½åå•ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span>(<span class="hljs-string">[[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@&quot;cydia://package/com.example.package&quot;]]</span>)&#123;<br>     NSLog(@<span class="hljs-string">&quot;Device is jailbroken&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>è¯»å–åº”ç”¨åˆ—è¡¨ï¼Œçœ‹æœ‰æ— æƒé™:</li></ul><p>åœ¨æœªè¶Šç‹±çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·æ˜¯æ²¡æœ‰æƒé™æŸ¥çœ‹è®¾å¤‡ä¸Šçš„æŸäº›ç›®å½•çš„ï¼Œä¹Ÿå°±æ— æ³•çŸ¥æ™“æœ‰å“ªäº›å·²å®‰è£…çš„åº”ç”¨ï¼Œé™¤éä½ åƒæŸäº›ä¸‰æ–¹å¸‚åœºä¸€æ ·ç”¨è‹¹æœçš„ç§æœ‰APIï¼Œä½†è¿™ä¼šå¯¼è‡´ä¸Šæ¶è¢«æ‹’ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹æ€§æ¥æ£€æµ‹è®¾å¤‡æ˜¯å¦è¶Šç‹±ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">if</span> ([[<span class="hljs-built_in">NSFileManager</span> defaultManager] fileExistsAtPath:<span class="hljs-string">@&quot;/User/Applications/&quot;</span>])&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Device is jailbroken&quot;</span>);<br>    <span class="hljs-built_in">NSArray</span> *applist = [[<span class="hljs-built_in">NSFileManager</span> defaultManager] contentsOfDirectoryAtPath:<span class="hljs-string">@&quot;/User/Applications/&quot;</span><br>                                            error:<span class="hljs-literal">nil</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;applist = %@&quot;</span>,applist);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç”¨ stat ç³»åˆ—å‡½æ•°æ£€æµ‹ Cydia ç­‰å·¥å…·ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#import <span class="hljs-string">&lt;sys/stat.h&gt;</span>  </span><br>     <br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">checkCydia</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>  </span><br><span class="hljs-function">  </span>&#123;  <br>      <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> stat_info;  <br>      <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">stat</span>(<span class="hljs-string">&quot;/Applications/Cydia.app&quot;</span>, &amp;stat_info)) &#123;  <br>          <span class="hljs-built_in">NSLog</span>(@<span class="hljs-string">&quot;Device is jailbroken&quot;</span>);  <br>      &#125;  <br>  &#125;<br></code></pre></td></tr></table></figure><ul><li>æ£€æµ‹ DYLD_INSERT_LIBRARIES ç¯å¢ƒå˜é‡</li></ul><p><code>DYLD_INSERT_LIBRARIES</code>æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œ<code>dyld</code>åŠ¨æ€é“¾æ¥å™¨åœ¨åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶æ—¶ä¼šæ£€æµ‹è¿™ä¸ªå˜é‡ï¼Œå¦‚æœæœ‰é…ç½®è¿‡åˆ™ä¼šåŠ è½½å…¶æŒ‡å‘çš„åŠ¨æ€åº“ï¼Œä»è€Œå®ç°åŠ¨æ€æ³¨å…¥å¹¶å°†ç¨‹åºçš„å†…å­˜dumpå‡ºæ¥ï¼Œè¿™æ­£æ˜¯è¶Šç‹±è®¾å¤‡ä¸­è°ƒè¯•æ—¶å¸¸ç”¨çš„æ–¹æ³•ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ£€æµ‹æ­¤ç¯å¢ƒå˜é‡æ¥ç¡®å®šè®¾å¤‡æ˜¯å¦è¶Šç‹±ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void print<span class="hljs-constructor">Env(<span class="hljs-params">void</span>)</span><br>&#123;<br>  <span class="hljs-built_in">char</span> *env = getenv(<span class="hljs-string">&quot;DYLD_INSERT_LIBRARIES&quot;</span>);<br>  <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;%s&quot;</span>, <span class="hljs-params">env</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœªè¶Šç‹±è®¾å¤‡è¿”å›ç»“æœæ˜¯nullï¼Œå·²è¶Šç‹±è®¾å¤‡è¿”å›è‡ªå·±çš„é…ç½®ã€‚</p><h4 id="2-2-ä»£ç -amp-é€»è¾‘æ··æ·†"><a href="#2-2-ä»£ç -amp-é€»è¾‘æ··æ·†" class="headerlink" title="2.2.ä»£ç  &amp; é€»è¾‘æ··æ·†"></a>2.2.ä»£ç  &amp; é€»è¾‘æ··æ·†</h4><ul><li>å…³é”®å­—ï¼šç±»åã€å±æ€§ã€æ–¹æ³•åç­‰ï¼›</li><li>å¸¸é‡ï¼šURLã€å­—ç¬¦ä¸²ï¼›</li><li>å°†åŸé€»è¾‘æ‹†åˆ†æˆå„ç§æ€ªç™–è¯­æ³•ï¼›</li></ul><p>ä»£ç æ··æ·†å’Œé€»è¾‘æ··æ·†ï¼Œå…¶æœ¬è´¨ä¸Šåªæ˜¯åœ¨åº”ç”¨ç¼–è¯‘æ—¶å°†æŒ‡å®šçš„å­—ç¬¦ä¸²æˆ–é€»è¾‘è¿›è¡Œæ··æ·†æ›¿æ¢ï¼Œä»è€Œå¢åŠ åº”ç”¨ç ´è§£åé˜…è¯»æºç çš„éš¾åº¦ã€‚å…·ä½“çš„æ··æ·†æ–¹æ³•ï¼Œæˆ‘ä¹‹å‰çš„æ–‡ç« ä¸­ä¹Ÿå·²ç»ä»‹ç»è¿‡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°~</p><h4 id="2-3-RESTRICTååŠ¨æ€åº“æ³¨å…¥"><a href="#2-3-RESTRICTååŠ¨æ€åº“æ³¨å…¥" class="headerlink" title="2.3.__RESTRICTååŠ¨æ€åº“æ³¨å…¥"></a>2.3.__RESTRICTååŠ¨æ€åº“æ³¨å…¥</h4><blockquote><p>restrictï¼ŒCè¯­è¨€ä¸­çš„ä¸€ç§ç±»å‹é™å®šç¬¦ï¼ˆType Qualifiersï¼‰ï¼Œç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œå¯¹è±¡å·²ç»è¢«æŒ‡é’ˆæ‰€å¼•ç”¨ï¼Œä¸èƒ½é€šè¿‡é™¤è¯¥æŒ‡é’ˆå¤–æ‰€æœ‰å…¶ä»–ç›´æ¥æˆ–é—´æ¥çš„æ–¹å¼ä¿®æ”¹è¯¥å¯¹è±¡çš„å†…å®¹ã€‚</p></blockquote><p>restrictæ˜¯c99æ ‡å‡†å¼•å…¥çš„ï¼Œå®ƒåªå¯ä»¥ç”¨äºé™å®šå’Œçº¦æŸæŒ‡é’ˆï¼Œå¹¶è¡¨æ˜æŒ‡é’ˆæ˜¯è®¿é—®ä¸€ä¸ªæ•°æ®å¯¹è±¡çš„å”¯ä¸€ä¸”åˆå§‹çš„æ–¹å¼ã€‚å³å®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œæ‰€æœ‰ä¿®æ”¹è¯¥æŒ‡é’ˆæ‰€æŒ‡å‘å†…å­˜ä¸­å†…å®¹çš„æ“ä½œéƒ½å¿…é¡»é€šè¿‡è¯¥æŒ‡é’ˆæ¥ä¿®æ”¹ï¼Œè€Œä¸èƒ½é€šè¿‡å…¶å®ƒé€”å¾„(å…¶å®ƒå˜é‡æˆ–æŒ‡é’ˆ)æ¥ä¿®æ”¹ï¼›è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œèƒ½å¸®åŠ©ç¼–è¯‘å™¨è¿›è¡Œæ›´å¥½çš„ä¼˜åŒ–ä»£ç ï¼Œç”Ÿæˆæ›´æœ‰æ•ˆç‡çš„æ±‡ç¼–ä»£ç ã€‚å¦‚ int *restrict ptr, ptr æŒ‡å‘çš„å†…å­˜å•å…ƒåªèƒ½è¢« ptr è®¿é—®åˆ°ï¼Œä»»ä½•åŒæ ·æŒ‡å‘è¿™ä¸ªå†…å­˜å•å…ƒçš„å…¶ä»–æŒ‡é’ˆéƒ½æ˜¯æœªå®šä¹‰çš„ï¼Œç›´ç™½ç‚¹å°±æ˜¯æ— æ•ˆæŒ‡é’ˆã€‚</p><br/><p>ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> ar[<span class="hljs-number">10</span>];<br><span class="hljs-type">int</span> * restrict restar=(<span class="hljs-type">int</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>*<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>));<br><span class="hljs-type">int</span> *par=ar;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¯´æ˜restaræ˜¯è®¿é—®ç”±malloc()åˆ†é…çš„å†…å­˜çš„å”¯ä¸€ä¸”åˆå§‹çš„æ–¹å¼ã€‚parå°±ä¸æ˜¯äº†ã€‚<br><br/></p><p>é€šè¿‡åœ¨ Xcode é‡Œçš„ Other Linker Flags è®¾ç½®å‚æ•°ï¼Œå¯ä»¥é˜²æ­¢åº”ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶è¢«æ³¨å…¥ dylibï¼ˆä»…é™äºiOS 10 ä»¥ä¸‹ç³»ç»Ÿï¼‰ã€‚dylib æ— æ³•æ³¨å…¥ï¼Œä¹Ÿå°±æ„å‘³ç€æ²¡åŠæ³•ç”¨<code>cycript</code>åŠ¨æ€è°ƒè¯•è¿›ç¨‹</p><ul><li>Other Linker Flags å‚æ•°ï¼š</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">-Wl,-sectcreate,__RESTRICT,__restrict,<span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br></code></pre></td></tr></table></figure><p>å‚è€ƒåšæ–‡ï¼š</p><ul><li><a href="https://baike.baidu.com/item/restrict/7384270?fr=aladdin">ç™¾ç§‘-restrict</a></li><li><a href="https://www.cnblogs.com/ciml/p/7551193.html">åæ³¨å…¥</a></li><li><a href="http://bbs.iosre.com/t/tweak-app-app-tweak/438">iosreè®ºå›snakeninny</a></li><li><a href="https://pewpewthespells.com/blog/blocking_code_injection_on_ios_and_os_x.html">pewpewthespells-blocking_code_injection</a></li></ul><h4 id="2-4-åptraceè°ƒè¯•"><a href="#2-4-åptraceè°ƒè¯•" class="headerlink" title="2.4.åptraceè°ƒè¯•"></a>2.4.åptraceè°ƒè¯•</h4><p><code>ptrace</code>æ˜¯ç³»ç»Ÿå‡½æ•°ï¼Œæ­¤å‡½æ•°æä¾›ä¸€ä¸ªè¿›ç¨‹å»ç›‘å¬å’Œæ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥æ£€æµ‹è¢«æ§åˆ¶è¿›ç¨‹çš„å†…å­˜å’Œå¯„å­˜å™¨é‡Œé¢çš„æ•°æ®ã€‚<code>ptrace</code>å¯ä»¥ç”¨æ¥å®ç°æ–­ç‚¹è°ƒè¯•å’Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªã€‚<br><br/></p><p>å‚è€ƒåšæ–‡ï¼š<a href="https://www.jianshu.com/p/ebdfb0a25c85">https://www.jianshu.com/p/ebdfb0a25c85</a></p><h4 id="2-5-ç¬¬ä¸‰æ–¹åŠ å›º"><a href="#2-5-ç¬¬ä¸‰æ–¹åŠ å›º" class="headerlink" title="2.5.ç¬¬ä¸‰æ–¹åŠ å›º"></a>2.5.ç¬¬ä¸‰æ–¹åŠ å›º</h4><p>ç¼ºç‚¹ï¼š</p><ul><li>å®‰è£…åŒ…å˜å¤§ï¼›</li><li>è¿è¡Œé€Ÿåº¦å˜æ…¢ï¼›</li></ul><p>ç¬¬ä¸‰æ–¹åŠ å›ºæä¾›å•†ï¼š</p><ul><li>ç½‘æ˜“æ˜“ç›¾</li><li>ç™¾åº¦åŠ å›º</li><li>è…¾è®¯ä¹å›º</li><li>é€šä»˜ç›¾</li></ul><p>æ ¹æ®åº”ç”¨å¯¹å®‰å…¨ç­‰çº§çš„è¦æ±‚è¡¡é‡æˆæœ¬~~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://blog.csdn.net/yiyaaixuexi/article/details/20286929">Â©å¿µèŒœ</a></p><p>#<a href="https://www.cnblogs.com/ciml/p/7551193.html">Â©åæ³¨å…¥</a></p><p>#<a href="http://bbs.iosre.com/t/tweak-app-app-tweak/438">Â©iosreè®ºå›snakeninny</a>  </p><p>#<a href="https://pewpewthespells.com/blog/blocking_code_injection_on_ios_and_os_x.html">Â©pewpewthespells-blocking_code_injection</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é€†å‘å·¥ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fridaä¸€é”®ç ¸å£³</title>
    <link href="/2019/03/31/frida.html"/>
    <url>/2019/03/31/frida.html</url>
    
    <content type="html"><![CDATA[<p>å‰ä¸¤å¤©é‡æ–°ç»™æˆ‘çš„ iOS12 è®¾å¤‡è¶Šç‹±ï¼Œç„¶åç ¸å£³å’Œåç¼–è¯‘ä¸€ä¸ªåº”ç”¨ï¼Œç»“æœåˆæ˜¯<code>ps</code>å‘½ä»¤å‡ºé”™ã€åˆæ˜¯<code>cycript</code>å‘½ä»¤å‡ºé”™ï¼Œåˆ°å¤„æŸ¥èµ„æ–™ï¼ŒæŠ˜è…¾äº†å¥½ä¹…ã€‚åæ¥å‘ç°ç«Ÿç„¶æœ‰<code>ä¸€é”®ç ¸å£³</code>çš„å·¥å…·<code>frida</code>ï¼Œè¿™é‡Œå«æ³ªè®°å½•ä¸‹æ¥æ•´ä¸ªç ¸å£³çš„æµç¨‹~</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_frida.png" alt="çº²ç›®"></p><p>fridaå®˜ç½‘ï¼š<a href="https://www.frida.re/docs/home/">https://www.frida.re/docs/home/</a></p><h3 id="1-iOSè®¾å¤‡é…ç½®"><a href="#1-iOSè®¾å¤‡é…ç½®" class="headerlink" title="1.iOSè®¾å¤‡é…ç½®"></a>1.iOSè®¾å¤‡é…ç½®</h3><h4 id="1-1-è¶Šç‹±"><a href="#1-1-è¶Šç‹±" class="headerlink" title="1.1.è¶Šç‹±"></a>1.1.è¶Šç‹±</h4><p>æˆ‘çš„è®¾å¤‡æ˜¯ iOS12.1ï¼Œæ‰€ä»¥ä½¿ç”¨ç›®å‰æœ€æ–°çš„è¶Šç‹±å·¥å…·<code>uncc0ver</code>ï¼Œç‰ˆæœ¬å·<code>v3.0.3~b48</code>ï¼Œå¯ä»¥åˆ° <a href="https://app.ignition.fun/">è¿™é‡Œ</a> ä¸‹è½½ã€‚ä¸‹è½½å®Œæˆåå¯åŠ¨<code>unc0ver</code>ï¼Œç‚¹å‡»<code>jailbreak</code>å³å¯è‡ªåŠ¨å®Œæˆè¶Šç‹±å¹¶å®‰è£… Cydia å•†åº—ã€‚</p><h4 id="1-2-fridaæ’ä»¶"><a href="#1-2-fridaæ’ä»¶" class="headerlink" title="1.2.fridaæ’ä»¶"></a>1.2.fridaæ’ä»¶</h4><p>åœ¨ Cydia ä¸­æ·»åŠ â€<a href="https://build.frida.re&quot;/">https://build.frida.re&quot;</a> æºå¹¶å®‰è£…<code>frida</code>æ’ä»¶ã€‚</p><h3 id="2-Macé…ç½®"><a href="#2-Macé…ç½®" class="headerlink" title="2.Macé…ç½®"></a>2.Macé…ç½®</h3><h4 id="2-1-usbmuxd"><a href="#2-1-usbmuxd" class="headerlink" title="2.1.usbmuxd"></a>2.1.usbmuxd</h4><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è°ƒè¯•è¶Šç‹±è®¾å¤‡æ—¶ä¼šç”¨åˆ°<code>ssh</code>è¿œç¨‹ç™»å½•è®¾å¤‡ï¼Œå®ƒä¾èµ–äº TCP è¿æ¥ã€‚è€Œ<code>usbmuxd</code>åˆ™ç”¨<code>usb</code>(æ•°æ®çº¿)è¿æ¥ä»£æ›¿äº†<code>ssh</code>è¿æ¥ï¼Œå°† iOS è®¾å¤‡ç«¯å£æ˜ å°„åˆ° Mac æœ¬åœ°ç«¯å£ï¼Œä½¿å¾—åœ¨æ²¡æœ‰ç½‘ç»œçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¿æ¥è®¾å¤‡ã€‚</p><ul><li>å®‰è£… usbmuxdï¼›</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">$ <span class="hljs-keyword">brew </span><span class="hljs-keyword">install </span>usbmuxd<br></code></pre></td></tr></table></figure><ul><li><p>è®¾å¤‡é€šè¿‡æ•°æ®çº¿è¿æ¥åˆ° Mac ä¸Šï¼›</p></li><li><p>ç«¯å£æ˜ å°„ï¼›</p></li></ul><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>iproxy <span class="hljs-number">2222</span> <span class="hljs-number">22</span><br></code></pre></td></tr></table></figure><p>å°†è®¾å¤‡ä¸Š<code>22</code>ç«¯å£å·æ˜ å°„åˆ°ç”µè„‘ä¸Š<code>2222</code>ç«¯å£ã€‚</p><h4 id="2-2-pip"><a href="#2-2-pip" class="headerlink" title="2.2.pip"></a>2.2.pip</h4><p><code>pip</code>æ˜¯ Python åŒ…ç®¡ç†å·¥å…·,è¯¥å·¥å…·æä¾›äº†å¯¹ Python åŒ…çš„æŸ¥æ‰¾ã€ä¸‹è½½ã€å®‰è£…ã€å¸è½½çš„åŠŸèƒ½ã€‚</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>sudo easy_install pip<br></code></pre></td></tr></table></figure><h4 id="2-3-frida"><a href="#2-3-frida" class="headerlink" title="2.3.frida"></a>2.3.frida</h4><p>å®‰è£…å’Œå‡çº§<code>frida</code>ï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">$ pip install --<span class="hljs-keyword">user</span> <span class="hljs-title">frida</span><br></code></pre></td></tr></table></figure><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">$ sudo easy_install <span class="hljs-comment">--upgrade frida</span><br></code></pre></td></tr></table></figure><h4 id="2-4-frida-tools"><a href="#2-4-frida-tools" class="headerlink" title="2.4.frida-tools"></a>2.4.frida-tools</h4><p>è¿™æ˜¯<code>frida</code>çš„å‘½ä»¤è¡Œç•Œé¢(CLI)ï¼Œåé¢æˆ‘ä»¬æ­£æ˜¯ä½¿ç”¨å®ƒè‡ªå¸¦çš„ä¸€äº›å‘½ä»¤æ¥æŸ¥çœ‹æˆ–è€…è°ƒè¯•åº”ç”¨ã€‚</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">$ pip <span class="hljs-keyword">install</span> frida-tools<br></code></pre></td></tr></table></figure><h4 id="2-5-frida-ios-dump"><a href="#2-5-frida-ios-dump" class="headerlink" title="2.5.frida-ios-dump"></a>2.5.frida-ios-dump</h4><p>åœ¨æ¡Œé¢æ–°å»ºæ–‡ä»¶å¤¹<code>Frida</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> Frida</span><br></code></pre></td></tr></table></figure><p>å°†<code>frida-ios-dump</code>å…‹éš†åˆ°åˆšæ‰çš„æ–‡ä»¶å¤¹ä¸­ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ git clone https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/AloneMonkey/</span>frida-ios-dump Frida/<br></code></pre></td></tr></table></figure><p>å®‰è£…ä¾èµ–ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> Frida<br><span class="hljs-variable">$</span> sudo pip install <span class="hljs-literal">-r</span> requirements.txt<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹<code>dump.py</code>é…ç½®ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">User</span> = <span class="hljs-string">&#x27;root&#x27;</span><br><span class="hljs-attr">Password</span> = â€˜alpineâ€™<br><span class="hljs-attr">Host</span> = <span class="hljs-string">&#x27;localhost&#x27;</span><br><span class="hljs-attr">Port</span> = <span class="hljs-number">2222</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>Password</code>è¦ä¸è¶Šç‹±å<code>root</code>èº«ä»½çš„å¯†ç ä¸€è‡´ï¼Œé»˜è®¤ä¸º<code>alpine</code>ã€‚ä¸€èˆ¬è¶Šç‹±åè€ƒè™‘åˆ° ssh çš„å®‰å…¨é—®é¢˜ï¼Œä¸€èˆ¬éƒ½è¦ä¿®æ”¹<code>root</code>å’Œ<code>mobile</code>èº«ä»½çš„å¯†ç ï¼Œæ‰€ä»¥è¿™é‡Œè¦æ ¹æ®ä½ è‡ªå·±çš„è®¾ç½®è€Œä¿®æ”¹ã€‚</p><h3 id="3-ç ¸å£³"><a href="#3-ç ¸å£³" class="headerlink" title="3.ç ¸å£³"></a>3.ç ¸å£³</h3><h4 id="3-1-æŸ¥çœ‹è¿›ç¨‹"><a href="#3-1-æŸ¥çœ‹è¿›ç¨‹" class="headerlink" title="3.1.æŸ¥çœ‹è¿›ç¨‹"></a>3.1.æŸ¥çœ‹è¿›ç¨‹</h4><p>æ¥ä¸‹æ¥å°±å¯ä»¥è¿›å…¥å®æˆ˜é˜¶æ®µäº†ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>frida</code>æŒ‡ä»¤æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„æˆ–è€…å…¨éƒ¨å·²å®‰è£…çš„è¿›ç¨‹çš„ä¿¡æ¯ã€‚</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-comment"># Connect Frida to an iPad over USB and list running processes</span><br><span class="hljs-variable">$ </span>frida-ps -U<br><br><span class="hljs-comment"># List running applications</span><br><span class="hljs-variable">$ </span>frida-ps -Ua<br><br><span class="hljs-comment"># List installed applications</span><br><span class="hljs-variable">$ </span>frida-ps -Uai<br><br><span class="hljs-comment"># Connect Frida to the specific device</span><br><span class="hljs-variable">$ </span>frida-ps -D <span class="hljs-number">0</span>216027d1d6d3a03<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘æŸ¥çœ‹å½“å‰è®¾å¤‡ä¸­å·²ç»æ‰“å¼€çš„åº”ç”¨ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus">$ frida-ps -Ua<br> PID  Name    Identifier<br>----  ------  -------------------------<br><span class="hljs-number">1509</span>  Filza   com<span class="hljs-selector-class">.tigisoftware</span><span class="hljs-selector-class">.Filza</span><br><span class="hljs-number">1250</span>  å¾®ä¿¡      com<span class="hljs-selector-class">.tencent</span><span class="hljs-selector-class">.xin</span><br><span class="hljs-number">1251</span>  æ”¯ä»˜å®     com<span class="hljs-selector-class">.alipay</span><span class="hljs-selector-class">.iphoneclient</span><br><span class="hljs-number">1441</span>  æ–—é±¼      tv<span class="hljs-selector-class">.douyu</span><span class="hljs-selector-class">.live</span><br><span class="hljs-number">1525</span>  ç…§ç‰‡      com<span class="hljs-selector-class">.apple</span><span class="hljs-selector-class">.mobileslideshow</span><br><span class="hljs-number">1246</span>  ç™¾åº¦æ‰‹æœºå«å£«  com<span class="hljs-selector-class">.baidu</span><span class="hljs-selector-class">.security</span><br><span class="hljs-number">1501</span>  ç½‘æ˜“æ–°é—»    com<span class="hljs-selector-class">.netease</span><span class="hljs-selector-class">.news</span><br><span class="hljs-number">1249</span>  é‚®ä»¶      com<span class="hljs-selector-class">.apple</span><span class="hljs-selector-class">.mobilemail</span> <br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€åˆ—æ˜¯è¿›ç¨‹<code>ID</code>ï¼Œç¬¬äºŒåˆ—æ˜¯è¿›ç¨‹<code>åç§°</code>ï¼Œç¬¬ä¸‰åˆ—æ˜¯è¿›ç¨‹<code>bundle id</code>ã€‚</p><h4 id="3-2-å¼€å§‹ç ¸å£³"><a href="#3-2-å¼€å§‹ç ¸å£³" class="headerlink" title="3.2.å¼€å§‹ç ¸å£³"></a>3.2.å¼€å§‹ç ¸å£³</h4><p>é‡ç‚¹ lei äº†~ç ¸å£³æ—¶æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯åˆšæ‰å…‹éš†è€Œæ¥çš„<code>frida-ios-dump</code>ä¸­çš„<code>./dump.py</code>è¿™ä¸ª Python è„šæœ¬æ–‡ä»¶ã€‚ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> Frida</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">./dump.py å¾®ä¿¡</span><br></code></pre></td></tr></table></figure><p>ç ¸å£³æ—¶ä½¿ç”¨<code>åç§°</code>å’Œ<code>bundle id</code>éƒ½å¯ä»¥ã€‚æ³¨æ„ï¼Œæ‰§è¡Œ<code>$ ./dump.py xxx</code>æ—¶ï¼Œè¢«ç ¸å£³çš„åº”ç”¨ä¸€å®šè¦æ˜¯åœ¨<code>è¿è¡Œ</code>çŠ¶æ€ï¼Œä¸èƒ½åœ¨åå°ï¼Œä¹Ÿä¸èƒ½é”å±ã€‚å¦‚æœæ­¤åº”ç”¨æ²¡æœ‰åœ¨è¿è¡ŒçŠ¶æ€ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œæ­¤å‘½ä»¤åï¼Œè¯¥åº”ç”¨ä¼šè‡ªåŠ¨è¿è¡Œèµ·æ¥ï¼Œè¿™æ—¶å†è¿è¡Œä¸€æ¬¡ä¸Šé¢çš„å‘½ä»¤å³å¯ã€‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Start</span> the target app å¾®ä¿¡<br><span class="hljs-attribute">Dumping</span> å¾®ä¿¡ to /var/folders/<span class="hljs-number">18</span>/prkfmw9150xbt4s2b47hhff40000gn/T<br><span class="hljs-attribute">start</span> dump /var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/WeChat<br><span class="hljs-attribute">WeChat</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">80</span>.<span class="hljs-number">3</span>M/<span class="hljs-number">80</span>.<span class="hljs-number">3</span>M<span class="hljs-meta"> [00:05&lt;00:00, 16.1MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/zstd.framework/zstd<br><span class="hljs-attribute">zstd</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">682</span>k/<span class="hljs-number">682</span>k<span class="hljs-meta"> [00:00&lt;00:00, 3.99MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/TXLiteAVSDK_Smart_No_VOD.framework/TXLiteAVSDK_Smart_No_VOD<br><span class="hljs-attribute">TXLiteAVSDK_Smart_No_VOD</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">5</span>.<span class="hljs-number">21</span>M/<span class="hljs-number">5</span>.<span class="hljs-number">21</span>M<span class="hljs-meta"> [00:00&lt;00:00, 11.3MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/matrixreport.framework/matrixreport<br><span class="hljs-attribute">matrixreport</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">460</span>k/<span class="hljs-number">460</span>k<span class="hljs-meta"> [00:00&lt;00:00, 3.90MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/YTFaceProSDK.framework/YTFaceProSDK<br><span class="hljs-attribute">YTFaceProSDK</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">13</span>.<span class="hljs-number">1</span>M/<span class="hljs-number">13</span>.<span class="hljs-number">1</span>M<span class="hljs-meta"> [00:01&lt;00:00, 13.7MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/GPUImage.framework/GPUImage<br><span class="hljs-attribute">GPUImage</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">1</span>.<span class="hljs-number">21</span>M/<span class="hljs-number">1</span>.<span class="hljs-number">21</span>M<span class="hljs-meta"> [00:00&lt;00:00, 7.08MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/WCDB.framework/WCDB<br><span class="hljs-attribute">WCDB</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">4</span>.<span class="hljs-number">25</span>M/<span class="hljs-number">4</span>.<span class="hljs-number">25</span>M<span class="hljs-meta"> [00:00&lt;00:00, 11.5MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/MMCommon.framework/MMCommon<br><span class="hljs-attribute">MMCommon</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">1</span>.<span class="hljs-number">18</span>M/<span class="hljs-number">1</span>.<span class="hljs-number">18</span>M<span class="hljs-meta"> [00:00&lt;00:00, 5.37MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/MultiMedia.framework/MultiMedia<br><span class="hljs-attribute">MultiMedia</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">7</span>.<span class="hljs-number">66</span>M/<span class="hljs-number">7</span>.<span class="hljs-number">66</span>M<span class="hljs-meta"> [00:00&lt;00:00, 12.3MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/QBar.framework/QBar<br><span class="hljs-attribute">QBar</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">2</span>.<span class="hljs-number">62</span>M/<span class="hljs-number">2</span>.<span class="hljs-number">62</span>M<span class="hljs-meta"> [00:00&lt;00:00, 10.0MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/QMapKit.framework/QMapKit<br><span class="hljs-attribute">QMapKit</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">3</span>.<span class="hljs-number">79</span>M/<span class="hljs-number">3</span>.<span class="hljs-number">79</span>M<span class="hljs-meta"> [00:00&lt;00:00, 10.3MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/ConfSDK.framework/ConfSDK<br><span class="hljs-attribute">ConfSDK</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">4</span>.<span class="hljs-number">01</span>M/<span class="hljs-number">4</span>.<span class="hljs-number">01</span>M<span class="hljs-meta"> [00:00&lt;00:00, 10.8MB/s]</span><br><span class="hljs-attribute">start</span> dump /private/var/containers/Bundle/Application/F441A6E7-<span class="hljs-number">863</span>E-<span class="hljs-number">4</span>A1C-AAEB-ECD4F9555208/WeChat.app/Frameworks/mars.framework/mars<br><span class="hljs-attribute">mars</span>.fid: <span class="hljs-number">100</span>%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| <span class="hljs-number">8</span>.<span class="hljs-number">79</span>M/<span class="hljs-number">8</span>.<span class="hljs-number">79</span>M<span class="hljs-meta"> [00:00&lt;00:00, 13.4MB/s]</span><br><span class="hljs-attribute">Expression_46</span>@<span class="hljs-number">2</span>x.png: <span class="hljs-number">211</span>MB<span class="hljs-meta"> [00:31, 6.96MB/s]</span><br><span class="hljs-attribute">0</span>.<span class="hljs-number">00</span>B<span class="hljs-meta"> [00:00, ?B/s]Generating &quot;å¾®ä¿¡.ipa&quot;</span><br></code></pre></td></tr></table></figure><p>è„šæœ¬ä¼šè‡ªåŠ¨åœ¨å½“å‰ç›®å½•ä¸­ç”Ÿæˆ dump ä¹‹åçš„<code>å¾®ä¿¡.ipa</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç ¸å£³åçš„æ–‡ä»¶äº†~~</p><h3 id="4-Hopperåç¼–è¯‘"><a href="#4-Hopperåç¼–è¯‘" class="headerlink" title="4.Hopperåç¼–è¯‘"></a>4.Hopperåç¼–è¯‘</h3><p>æ‹¿åˆ°ç ¸å£³åçš„<code>ipa</code>ä¹‹åï¼Œä½¿ç”¨è§£å‹ç¼©è½¯ä»¶å°†å…¶è§£å‹åä¼šå¾—åˆ°ä¸€ä¸ª<code>Payload</code>æ–‡ä»¶å¤¹ï¼Œé‡Œé¢å°±æ˜¯ ipa å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ‰“å¼€<code>Hopper disassembler</code>ï¼Œå°†äºŒè¿›åˆ¶æ–‡ä»¶æ‹–åˆ°å…¶çª—å£ä¸­ï¼Œè‡ªåŠ¨å¼€å§‹åç¼–è¯‘è¿‡ç¨‹~</p><h3 id="5-CrackerXI"><a href="#5-CrackerXI" class="headerlink" title="5.CrackerXI"></a>5.CrackerXI</h3><p><strong>æ›´æ–°ï¼š</strong>å¶ç„¶å‘ç°äº†ä¸€ä¸ªå«<code>CrackerXI</code>çš„æ’ä»¶ã€‚å…¶ä¸»è¦ä½œç”¨æœ‰ï¼š</p><ul><li>åº”ç”¨ç ¸å£³ï¼›</li><li>å»æ‰å„ç§è½¯ä»¶çš„è¯ä¹¦ï¼›</li></ul><p>çœ‹åˆ°<code>ç ¸å£³</code>å­—çœ¼ï¼Œæ˜¯ä¸æ˜¯çœ¼å‰ä¸€äº®ï¼Œæ²¡é”™å®ƒä¹Ÿå¯ä»¥ç”¨æ¥ä¸€é”®ç ¸å£³ï¼Œè€Œä¸”ä»æ“ä½œä¸Šæ¥è®²æ¯”<code>frida</code>æ›´åŠ ä¾¿æ·ã€‚</p><ul><li>åœ¨ cydiakk ä¸­æ–‡æºä¸­æœç´¢å¹¶å®‰è£…è¿™ä¸ªæ’ä»¶ï¼›</li><li>å›åˆ°æ¡Œé¢æ‰“å¼€è¿™ä¸ªåº”ç”¨ï¼Œè¿›å…¥è®¾ç½®ä¸­æ‰“å¼€ crackerXI Hook å¼€å…³ï¼›</li><li>å›åˆ° Applist ç•Œé¢ç‚¹å‡»ç›®æ ‡åº”ç”¨ï¼Œè‡ªåŠ¨å¯åŠ¨å¹¶è·³è½¬åˆ°ç›®æ ‡åº”ç”¨ï¼›</li><li>ç›®æ ‡åº”ç”¨å¯åŠ¨åä¼šå¼¹å‡ºæ˜¯å¦ç ¸å£³çš„é€‰é¡¹æ¡†ï¼Œé€‰æ‹© YES å³å¯è·³å›å·¥å…·å¼€å§‹ç ¸å£³ï¼›</li><li>æœ€ç»ˆç ¸å£³åçš„ ipa æ–‡ä»¶è¢«ä¿å­˜åœ¨&#x2F;var&#x2F;mobile&#x2F;Documents&#x2F;CrackerXIç›®å½•ä¸­ï¼›</li><li>ä½¿ç”¨ Mac ä¸Šçš„ iToolsç­‰åŠ©æ‰‹å°†æ–‡ä»¶å¯¼å‡ºï¼Œè§£å‹åå³å¯å¼€å§‹åç¼–è¯‘ã€‚</li></ul><p>æ ¹æ®æˆ‘çš„æµ‹è¯•ï¼Œè¢«ç ¸å£³çš„åº”ç”¨ä¸€å®šè¦åœ¨éå¯åŠ¨çŠ¶æ€ï¼Œå°±æ˜¯è¯´ä¸€å®šè¦ç”±<code>CrackerXI</code>æ¥å¯åŠ¨ç›®æ ‡åº”ç”¨ï¼Œæ‰€ä»¥æˆ‘çŒœå®ƒçš„åŸç†åº”è¯¥ä¹Ÿæ˜¯åœ¨åº”ç”¨äºŒè¿›åˆ¶æ–‡ä»¶å¯åŠ¨åŠ è½½é˜¶æ®µï¼Œæ³¨å…¥è‡ªå·±çš„åŠ¨æ€åº“å¹¶å¼€å§‹ç ¸å£³ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_crackerXI.PNG" alt="crackerXI"></p><p>æ‡’äººæ”¹å˜ä¸–ç•Œ~~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://www.frida.re/docs/installation/">Â©fridaå®˜ç½‘</a></p><p>#<a href="http://www.alonemonkey.com/2018/01/30/frida-ios-dump/">Â©AloneMonkey - ä¸€æ¡å‘½ä»¤å®Œæˆç ¸å£³</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é€†å‘å·¥ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS12è¶Šç‹±å¡«å‘</title>
    <link href="/2019/03/28/jailbreak-ios12.html"/>
    <url>/2019/03/28/jailbreak-ios12.html</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘çœ‹åˆ°æœ‰æ–°ç‰ˆçš„iOS12è¶Šç‹±å·¥å…·å‘å¸ƒï¼Œä¸€æ—¶æ‰‹ç—’ï¼Œäºæ˜¯å°†æ‰‹é‡Œçš„è®¾å¤‡è¿›è¡Œäº†è¶Šç‹±ã€‚è¿™ä¸­é—´åˆå‡ºäº†å„ç§é—®é¢˜ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹æ¥ï¼Œé¡ºä¾¿ç»™åé¢è¸©å‘çš„åŒå­¦åšä¸ªå‚è€ƒ~</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_jailbreak_ios12.png" alt="çº²ç›®"></p><h3 id="1-è¶Šç‹±å·¥å…·"><a href="#1-è¶Šç‹±å·¥å…·" class="headerlink" title="1.è¶Šç‹±å·¥å…·"></a>1.è¶Šç‹±å·¥å…·</h3><p><code>unc0ver</code>jailbreak for iOS 11.0-12.1.2ï¼Œç‰ˆæœ¬å·ä¸º v3.0.0~b48ï¼Œæ‰‹æœº Safari ä¸­æ‰“å¼€ <a href="https://app.ignition.fun/">è¿™é‡Œ</a>ï¼Œåœ¨ç¬¬äºŒä¸ª Tab çš„<code>jailbreaks</code>é€‰é¡¹ä¸­æ‰¾åˆ°<code>unc0ver-new beta</code>ï¼Œä¸‹è½½å®Œæˆåè¿›å…¥<code>unc0ver</code>ï¼Œç‚¹ jailberak å³å¯è‡ªåŠ¨è¶Šç‹±ã€‚<br><br/></p><p>è¶Šç‹±å®Œæˆåä¼šè‡ªåŠ¨å®‰è£… Cydia~</p><h3 id="2-Cydiaè”ç½‘å¤±è´¥"><a href="#2-Cydiaè”ç½‘å¤±è´¥" class="headerlink" title="2.Cydiaè”ç½‘å¤±è´¥"></a>2.Cydiaè”ç½‘å¤±è´¥</h3><h4 id="2-1-ä¹ç½‘"><a href="#2-1-ä¹ç½‘" class="headerlink" title="2.1.ä¹ç½‘"></a>2.1.ä¹ç½‘</h4><p>ä¸‹è½½çˆ±æ€æ‰‹æœºåŠ©æ‰‹ï¼Œæœç´¢å¹¶å®‰è£…<code>ä¹ç½‘</code>ï¼Œå¯åŠ¨åæ‰“å¼€å¼€å…³ï¼Œå†è¿›å…¥ Cydia å³å¯ã€‚</p><h4 id="2-2-æ’ä»¶"><a href="#2-2-æ’ä»¶" class="headerlink" title="2.2.æ’ä»¶"></a>2.2.æ’ä»¶</h4><p>ä½ ä¹Ÿå¯ä»¥åœ¨ Cydia ä¸­æ·»åŠ <code>è´´å§æº</code> <a href="http://apt.cydiaba.cn/">http://apt.cydiaba.cn</a> ï¼Œæœç´¢å¹¶å®‰è£…<code>è”ç½‘ä¿®æ­£</code>æ’ä»¶å³å¯ã€‚</p><h3 id="3-æœä¸åˆ°OpenSSH"><a href="#3-æœä¸åˆ°OpenSSH" class="headerlink" title="3.æœä¸åˆ°OpenSSH"></a>3.æœä¸åˆ°OpenSSH</h3><h4 id="æ·»åŠ æ–°çš„æº"><a href="#æ·»åŠ æ–°çš„æº" class="headerlink" title="æ·»åŠ æ–°çš„æº"></a>æ·»åŠ æ–°çš„æº</h4><ul><li><p>èš‚èšæºï¼š<a href="http://apt.cydia.love/">http://apt.cydia.love</a></p></li><li><p>Cydiaè´´å§æºï¼š<a href="http://apt.cydiaba.cn/">http://apt.cydiaba.cn</a></p></li><li><p>saurikæºï¼š<a href="http://apt.saurik.com/cydia">http://apt.saurik.com/cydia</a></p></li><li><p>é›·é”‹æºï¼š<a href="http://apt.abcydia.com/">http://apt.abcydia.com</a></p></li></ul><h3 id="4-ä¿®æ”¹å¯†ç "><a href="#4-ä¿®æ”¹å¯†ç " class="headerlink" title="4.ä¿®æ”¹å¯†ç "></a>4.ä¿®æ”¹å¯†ç </h3><p>iOSè®¾å¤‡ä¸Šæœ‰<code>root</code>å’Œ<code>mobile</code>ä¸¤ä¸ªç”¨æˆ·ï¼Œåœ¨å®‰è£…å®Œ SSH åè®°å¾—ä¿®æ”¹é»˜è®¤çš„ç™»å½•å¯†ç â€œalpineâ€ï¼Œé˜²æ­¢ç—…æ¯’é€šè¿‡ ssh ä»¥ root ç”¨æˆ·èº«ä»½ç™»å½•è®¾å¤‡ã€‚</p><br/><p>sshç™»å½•è®¾å¤‡</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">$ ssh <span class="hljs-symbol">root@</span><span class="hljs-number">192.168</span><span class="hljs-number">.31</span>.xx <span class="hljs-comment">//è®¾å¤‡æ‰€åœ¨WiFiçš„IPåœ°å€</span><br></code></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ root å¯†ç ï¼š</li></ul><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haxe">~ root<span class="hljs-meta"># passwd</span><br>changing password <span class="hljs-keyword">for</span> root.<br>New password:<span class="hljs-type"></span><br>Retype <span class="hljs-keyword">new</span> <span class="hljs-type">password</span>:<br>~ root<span class="hljs-meta"># </span><br></code></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ mobile å¯†ç ï¼š</li></ul><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haxe">~ root<span class="hljs-meta"># passwd mobile</span><br>changing password <span class="hljs-keyword">for</span> mobile.<br>New password:<span class="hljs-type"></span><br>Retype <span class="hljs-keyword">new</span> <span class="hljs-type">password</span>:<br>~ root<span class="hljs-meta"># </span><br></code></pre></td></tr></table></figure><p>ä½ ä¹Ÿå¯ä»¥åœ¨ Cydia ä¸­ä¸‹è½½<code>Mterminal</code>å‘½ä»¤è¡Œå·¥å…·ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ“ä½œä¿®æ”¹å¯†ç ã€‚</p><h3 id="5-é‡å¯åè¶Šç‹±çŠ¶æ€æ¢å¤"><a href="#5-é‡å¯åè¶Šç‹±çŠ¶æ€æ¢å¤" class="headerlink" title="5.é‡å¯åè¶Šç‹±çŠ¶æ€æ¢å¤"></a>5.é‡å¯åè¶Šç‹±çŠ¶æ€æ¢å¤</h3><p>æ‰“å¼€<code>unc0ver-settings-Restore RootFS</code>é€‰é¡¹æ¸…é™¤è¶Šç‹±ä¿¡æ¯ï¼Œé‡æ–°è¶Šç‹±ã€‚</p><h3 id="6-é‡æ–°è¶Šç‹±åsshç™»å½•å¤±è´¥"><a href="#6-é‡æ–°è¶Šç‹±åsshç™»å½•å¤±è´¥" class="headerlink" title="6.é‡æ–°è¶Šç‹±åsshç™»å½•å¤±è´¥"></a>6.é‡æ–°è¶Šç‹±åsshç™»å½•å¤±è´¥</h3><p>å¤±è´¥ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@</span><br><span class="hljs-comment">@</span>    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     <span class="hljs-comment">@</span><br><span class="hljs-comment">@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><span class="hljs-comment">@@</span><br>IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!<br>Someone could be eavesdropping on you right <span class="hljs-built_in">now</span> (man-in-the-middle attack)!<br>It is also possible that a host <span class="hljs-built_in">key</span> has just been changed.<br>The fingerprint <span class="hljs-keyword">for</span> the RSA key sent by the remote host is<br>SHA256:eiVsYjmcqRFD46WOMhcQPxRJSgPDbndRDq2/+3Zxaw4.<br>Please contact your system administrator.<br>Add correct host key in /Users/Macmafia/.ssh/known_hosts to get rid of this message.<br>Offending RSA key in /Users/Macmafia/.ssh/known_hosts:8<br>RSA host key <span class="hljs-keyword">for</span> 192.168.31.xx has changed and you have requested strict checking.<br>Host key verification failed.<br></code></pre></td></tr></table></figure><p>Macä¸­è¿›å…¥~&#x2F;.sshç›®å½•ï¼Œæ‰“å¼€<code>known_hosts</code>æ–‡ä»¶å¹¶å°† wifi çš„ ip åœ°å€åŠå…¶å¯¹åº”çš„å…¬é’¥å­—ç¬¦ä¸²åˆ é™¤ï¼Œé‡æ–° ssh ç™»å½•å³å¯ã€‚</p><h3 id="7-cycriptå®‰è£…å¤±è´¥"><a href="#7-cycriptå®‰è£…å¤±è´¥" class="headerlink" title="7.cycriptå®‰è£…å¤±è´¥"></a>7.cycriptå®‰è£…å¤±è´¥</h3><ul><li>cycriptæ’ä»¶</li></ul><p>Cydia ä¸­é»˜è®¤å·²å®‰è£…<code>cycript</code>ï¼Œæ·»åŠ å¤§ä½¬æºï¼šapt.saurik.com&#x2F;cydiaï¼Œæ›´æ–°<code>cycript</code>æ’ä»¶ã€‚</p><ul><li>aptå®‰è£…</li></ul><p>sshç™»å½•åï¼Œ$ apt-get install cycrypt</p><ul><li>å®˜ç½‘</li></ul><p>1ã€åˆ°å®˜ç½‘ä¸‹è½½<code>cycript_0.9.501_iphoneos-arm.deb</code>å’Œ<code>libffi_1:3.0.10-5_iphoneos-arm.deb</code>åŒ…ï¼›<br><br/></p><p>2ã€sftpå‘½ä»¤ä¼ é€æ–‡ä»¶åˆ°è®¾å¤‡ä¸­ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">$ sftp root@wifi ipåœ°å€<br>sftp&gt; <span class="hljs-keyword">put</span> cycript_0.<span class="hljs-number">9.501</span>_iphoneos-arm.<span class="hljs-keyword">deb</span><br>sftp&gt; <span class="hljs-keyword">put</span> libffi_1:<span class="hljs-number">3.0</span>.<span class="hljs-number">10</span>-<span class="hljs-number">5</span>_iphoneos-arm.<span class="hljs-keyword">deb</span><br></code></pre></td></tr></table></figure><p>3ã€dpkgå®‰è£…</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>ssh root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.1</span>.<span class="hljs-number">101</span><br>~ root<span class="hljs-comment"># dpkg -i cycript_0.9.501_iphoneos-arm.deb</span><br></code></pre></td></tr></table></figure><h3 id="8-â€œps-eâ€å‘½ä»¤æŠ¥é”™"><a href="#8-â€œps-eâ€å‘½ä»¤æŠ¥é”™" class="headerlink" title="8.â€œps-eâ€å‘½ä»¤æŠ¥é”™"></a>8.â€œps-eâ€å‘½ä»¤æŠ¥é”™</h3><p>æŠ¥é”™ä¿¡æ¯ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">-<span class="hljs-keyword">sh</span>: /usr/bin/<span class="hljs-keyword">ps</span>: Bad CPU <span class="hljs-built_in">type</span> in <span class="hljs-built_in">executable</span><br></code></pre></td></tr></table></figure><p>æ–¹æ¡ˆï¼šCydia ä¸­å°†<code>adv-cmds</code>æ’ä»¶é™çº§åˆ°â€119-6â€ï¼›</p><h3 id="9-â€œcycript-pâ€å‘½ä»¤å‡ºé”™"><a href="#9-â€œcycript-pâ€å‘½ä»¤å‡ºé”™" class="headerlink" title="9.â€œcycript -pâ€å‘½ä»¤å‡ºé”™"></a>9.â€œcycript -pâ€å‘½ä»¤å‡ºé”™</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">iPhone:~ root# cycript -p NewsBoard<br><span class="hljs-literal">[<span class="hljs-number">3345</span>]</span> <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DarwinInjector</span>.</span></span>cpp<span class="hljs-literal">[<span class="hljs-number">246</span>]</span>: <span class="hljs-constructor">_krncall(<span class="hljs-params">mach_vm_read_overwrite</span>)</span> =<span class="hljs-number">10000003</span><br>*** <span class="hljs-constructor">_assert(<span class="hljs-params">status</span> <span class="hljs-operator">==</span> 0)</span>:../<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Inject</span>.</span></span>cpp(<span class="hljs-number">143</span>):InjectLibrary<br></code></pre></td></tr></table></figure><p>è¿™ä¼šå¯¼è‡´æ¥ä¸‹æ¥æ— æ³•æŸ¥è¯¢åˆ°è¿›ç¨‹çš„<code>Document</code>ç›®å½•ï¼Œè¿›è€Œæ— æ³•å¯¼å…¥ç ¸å£³åŠ¨æ€åº“ã€‚<a href="http://bbs.iosre.com/">è®ºå›</a>é‡Œçš„æ–¹æ¡ˆéƒ½è¯•è¿‡äº†ï¼Œæš‚æ—¶è§£å†³ä¸äº†ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ¢ä¸ªä¸é‚£ä¹ˆé…·çš„æ–¹å¼ï¼Œåœ¨ Cydia å®‰è£…çš„<code>Filza</code>æ’ä»¶ï¼Œæ‰¾åˆ°â€œ&#x2F;var&#x2F;mobile&#x2F;Containers&#x2F;Data&#x2F;Application&#x2F;â€ç›®å½•ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºåº”ç”¨çš„åå­—ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_filza.PNG" alt="filza"></p><p>é€‰æ‹©ç›®æ ‡è¿›ç¨‹ï¼Œç‚¹å‡»è¿›å…¥å¯¹åº”çš„<code>Documents</code>ç›®å½•å³å¯~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://www.cnblogs.com/mengfanrong/p/5096590.html">Â©sshè¿œç¨‹ç™»å½•æŠ¥é”™</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é€†å‘å·¥ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»£ç æ··æ·†ã€shell è„šæœ¬è‡ªåŠ¨æ›¿æ¢</title>
    <link href="/2019/03/25/code_confusion.html"/>
    <url>/2019/03/25/code_confusion.html</url>
    
    <content type="html"><![CDATA[<h3 id="1ã€é€†å‘-amp-ç ´è§£ï¼š"><a href="#1ã€é€†å‘-amp-ç ´è§£ï¼š" class="headerlink" title="1ã€é€†å‘&amp;ç ´è§£ï¼š"></a>1ã€é€†å‘&amp;ç ´è§£ï¼š</h3><ul><li>é€šè¿‡ dumpdecrypted ç»™ APP ç ¸å£³ï¼›</li><li>é€šè¿‡ class-dump æŸ¥çœ‹ .hæ–‡ä»¶é‡Œçš„å‡½æ•°ï¼›</li><li>é€šè¿‡ Hopperã€IDA Pro ç­‰å·¥å…·åç¼–è¯‘ååˆ†æä¸šåŠ¡ä»£ç ï¼›</li><li>é€šè¿‡ Reveal åœ¨è¿è¡Œæ—¶è°ƒè¯•å’Œä¿®æ”¹ iOSåº”ç”¨çš„ UIï¼›</li></ul><h3 id="2ã€æ··æ·†ä»£ç "><a href="#2ã€æ··æ·†ä»£ç " class="headerlink" title="2ã€æ··æ·†ä»£ç "></a>2ã€æ··æ·†ä»£ç </h3><p>ç±»åã€æ–¹æ³•åã€å˜é‡åç­‰ä¼šæš´éœ²APPçš„å¾ˆå¤šå…³é”®ä¿¡æ¯ï¼Œæ”»å‡»è€…é€šè¿‡ class-dump å¾—åˆ°å¤´æ–‡ä»¶åï¼Œå¯ä»¥æ ¹æ®æå–åˆ°çš„è¿™äº›å­—ç¬¦ä¸²ï¼Œå¿«é€Ÿæ‰¾åˆ°ç›¸å…³é€»è¾‘çš„å¤„ç†å‡½æ•°ï¼Œä»è€Œè¿›è¡Œåˆ†æç ´è§£ã€‚æ‰€ä»¥ï¼Œä»£ç æ··æ·†å¾ˆæœ‰å¿…è¦æ€§ã€‚æ··æ·†çš„ä¸»æ—¨æ€æƒ³æ˜¯ï¼š</p><ul><li>åœ¨å¼€å‘é˜¶æ®µä¿ç•™æ¸…æ™°å¯è¯»çš„ä»£ç ï¼›</li><li>åœ¨ç¼–è¯‘æ‰“åŒ…åçš„ä»£ç ä¸­ï¼ŒæŠŠä¸€äº›æ•æ„Ÿå­—ç¬¦ä¸²å˜ä¸ºä¸ºæ— æ„ä¹‰çš„ç¬¦å·ï¼›</li><li>å¢åŠ æ”»å‡»è€…é˜…è¯»ä»£ç çš„éš¾åº¦ä»¥åŠæ ¹æ®å­—ç¬¦ä¸²é™æ€æœç´¢çš„éš¾åº¦ï¼›</li></ul><p>å½“ç„¶ï¼Œæ‰‹åŠ¨æ›¿æ¢å·¥ç¨‹ä¸­æ‰€æœ‰çš„ç±»åã€æ–¹æ³•åã€å˜é‡åï¼Œè¿™è‚¯å®šä¼šæ˜¯å¾ˆå¤§çš„ä¸€ä¸ªå·¥ä½œé‡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æ™ºèƒ½ä¸€ç‚¹ï¼Œä½¿ç”¨è„šæœ¬æ¥å¸®æˆ‘ä»¬åšã€‚é€šè¿‡è„šæœ¬ï¼Œæ‰«æå·¥ç¨‹ç›®å½•ä¸‹æ‰€æœ‰.h &amp; .m æ–‡ä»¶ï¼Œå¹¶å¯¹å…¶ä¸­çš„æ•æ„Ÿå†…å®¹åšæ›¿æ¢ã€‚å¦å¤–ï¼Œå¯ä»¥é…åˆ #define åˆ«åçš„æ–¹å¼ï¼Œå¢åŠ ç ´è¯‘éš¾åº¦ã€‚</p><h3 id="3ã€æ··æ·†çš„å®ç°ï¼š"><a href="#3ã€æ··æ·†çš„å®ç°ï¼š" class="headerlink" title="3ã€æ··æ·†çš„å®ç°ï¼š"></a>3ã€æ··æ·†çš„å®ç°ï¼š</h3><h4 id="3-1-åœ¨å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸¤ä¸ªæ–‡ä»¶ï¼š"><a href="#3-1-åœ¨å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸¤ä¸ªæ–‡ä»¶ï¼š" class="headerlink" title="3.1.åœ¨å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸¤ä¸ªæ–‡ä»¶ï¼š"></a>3.1.åœ¨å·¥ç¨‹çš„æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸¤ä¸ªæ–‡ä»¶ï¼š</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">cd Desktop/CodeMix  <span class="hljs-comment">//å·¥ç¨‹æ ¹ç›®å½•</span><br>touch <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Confusion</span>.</span></span>sh  <span class="hljs-comment">//è„šæœ¬</span><br>touch <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ToBeConfused</span>.</span></span><span class="hljs-built_in">list</span> <span class="hljs-comment">//å­˜æ”¾æ‰€æœ‰éœ€è¦æ›¿æ¢çš„æ•æ„Ÿå­—</span><br></code></pre></td></tr></table></figure><p><strong>Confusion.sh</strong>ï¼Œä¸€ä¸ª shell è„šæœ¬æ–‡ä»¶ï¼Œç”¨æ¥è‡ªåŠ¨å¯»æ‰¾å·¥ç¨‹ç›®å½•ä¸‹.hä¸.mæ–‡ä»¶ä¸­çš„æ‰€æœ‰æ•æ„Ÿå­—ï¼Œå°†å®ƒä»¬æ›¿æ¢ä¸ºæ— æ„ä¹‰çš„å­—ç¬¦å¹¶å®šä¹‰æˆå®ã€‚</p><p><strong>ToBeConfused.list</strong>ï¼Œ ç”¨æ¥ä¿å­˜æ‰€æœ‰éœ€è¦æ›¿æ¢çš„æ•æ„Ÿå­—ï¼Œå…¶åç¼€æ ¼å¼æ— æ‰€è°“ï¼Œæ¯”å¦‚.textä¹Ÿå¯ä»¥ã€‚shell è„šæœ¬ä¼šä»æ­¤æ–‡ä»¶ä¸­é€è¡Œå–å­—ç¬¦å¹¶æŠŠå®ƒæ›¿æ¢ä¸ºæ— æ„ä¹‰çš„å­—ç¬¦ã€‚</p><h4 id="3-2-MapOfConfusion-h"><a href="#3-2-MapOfConfusion-h" class="headerlink" title="3.2.MapOfConfusion.h"></a>3.2.MapOfConfusion.h</h4><p>åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»º MapOfConfusion.h æ–‡ä»¶ã€‚æ­¤æ–‡ä»¶ä¸ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚ä½œç”¨æ˜¯åœ¨æ··æ·†ä»£ç æ—¶ï¼ŒæŠŠè‡ªåŠ¨ç”Ÿæˆçš„å­—ç¬¦ä¸²å®šä¹‰æˆå®ï¼Œå­˜æ”¾åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚</p><h4 id="3-3-è®¾ç½®è„šæœ¬"><a href="#3-3-è®¾ç½®è„šæœ¬" class="headerlink" title="3.3.è®¾ç½®è„šæœ¬"></a>3.3.è®¾ç½®è„šæœ¬</h4><p>ç¼–è¾‘ Confusion.sh æ–‡ä»¶ï¼Œè¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/usr/bin/env bash</span><br><br>TABLENAME=symbols<br><br>SYMBOL_DB_FILE=<span class="hljs-string">&quot;symbols&quot;</span><br><br><span class="hljs-comment">#ToBeConfused.list è·¯å¾„</span><br>STRING_SYMBOL_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_DIR</span>/ToBeConfused.list&quot;</span><br><br><span class="hljs-comment">#é¡¹ç›®æ–‡ä»¶è·¯å¾„</span><br>CONFUSE_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$SRCROOT</span>&quot;</span><br><br><span class="hljs-comment">#MapOfConfusion.h è·¯å¾„</span><br>HEAD_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_DIR</span>/MapOfConfusion.h&quot;</span><br><br><span class="hljs-built_in">export</span> LC_CTYPE=C<br><br><span class="hljs-comment">#å–ä»¥.mæˆ–.hç»“å°¾çš„æ–‡ä»¶ä»¥+å·æˆ–-å·å¼€å¤´çš„è¡Œ</span><br><span class="hljs-comment">#|å»æ‰æ‰€æœ‰+å·æˆ–ï¼å·|ç”¨ç©ºæ ¼ä»£æ›¿ç¬¦å·|nä¸ªç©ºæ ¼è·Ÿç€&lt;å· æ›¿æ¢æˆ &lt;å·</span><br><span class="hljs-comment">#|å¼€å¤´ä¸èƒ½æ˜¯IBAction|ç”¨ç©ºæ ¼splitå­—ä¸²å–ç¬¬äºŒéƒ¨åˆ†|æ’åº|å»é‡å¤|åˆ é™¤ç©ºè¡Œ</span><br><span class="hljs-comment">#|åˆ æ‰ä»¥initå¼€å¤´çš„è¡Œ&gt;å†™è¿›ToBeConfused.list</span><br><br>grep -h -r -I  <span class="hljs-string">&quot;^[-+]&quot;</span> <span class="hljs-variable">$CONFUSE_FILE</span>  --include <span class="hljs-string">&#x27;*.[mh]&#x27;</span> |sed <span class="hljs-string">&quot;s/[+-]//g&quot;</span>|sed <span class="hljs-string">&quot;s/[();,: *^/&#123;]/ /g&quot;</span>|sed <span class="hljs-string">&quot;s/[ ]*&lt;/&lt;/&quot;</span>| sed <span class="hljs-string">&quot;/^[ ]*IBAction/d&quot;</span>|awk <span class="hljs-string">&#x27;&#123;split($0,b,&quot; &quot;); print b[2]; &#125;&#x27;</span>| <span class="hljs-built_in">sort</span>|<span class="hljs-built_in">uniq</span> |sed <span class="hljs-string">&quot;/^$/d&quot;</span>|sed -n <span class="hljs-string">&quot;/^xMix_/p&quot;</span> &gt;<span class="hljs-variable">$STRING_SYMBOL_FILE</span><br><br><br><span class="hljs-comment">#ç»´æŠ¤æ•°æ®åº“æ–¹ä¾¿æ—¥åä½œæ’é‡,ä»¥ä¸‹ä»£ç æ¥è‡ªå¿µèŒœçš„åšå®¢</span><br><span class="hljs-function"><span class="hljs-title">createTable</span></span>()<br>&#123;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;create table <span class="hljs-variable">$TABLENAME</span>(src text, des text);&quot;</span> | sqlite3 <span class="hljs-variable">$SYMBOL_DB_FILE</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">insertValue</span></span>()<br>&#123;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;insert into <span class="hljs-variable">$TABLENAME</span> values(&#x27;<span class="hljs-variable">$1</span>&#x27; ,&#x27;<span class="hljs-variable">$2</span>&#x27;);&quot;</span> | sqlite3 <span class="hljs-variable">$SYMBOL_DB_FILE</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">query</span></span>()<br>&#123;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;select * from <span class="hljs-variable">$TABLENAME</span> where src=&#x27;<span class="hljs-variable">$1</span>&#x27;;&quot;</span> | sqlite3 <span class="hljs-variable">$SYMBOL_DB_FILE</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">ramdomString</span></span>()<br>&#123;<br>openssl rand -<span class="hljs-built_in">base64</span> 64 | <span class="hljs-built_in">tr</span> -<span class="hljs-built_in">cd</span> <span class="hljs-string">&#x27;a-zA-Z&#x27;</span> |<span class="hljs-built_in">head</span> -c 16<br><br>&#125;<br><br><span class="hljs-built_in">rm</span> -f <span class="hljs-variable">$SYMBOL_DB_FILE</span><br><span class="hljs-built_in">rm</span> -f <span class="hljs-variable">$HEAD_FILE</span><br>createTable<br><br><span class="hljs-built_in">touch</span> <span class="hljs-variable">$HEAD_FILE</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;#ifndef MapOfConfusion_h</span><br><span class="hljs-string">#define MapOfConfusion_h&#x27;</span> &gt;&gt; <span class="hljs-variable">$HEAD_FILE</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;//confuse string at `date`&quot;</span> &gt;&gt; <span class="hljs-variable">$HEAD_FILE</span><br><span class="hljs-built_in">cat</span> <span class="hljs-string">&quot;<span class="hljs-variable">$STRING_SYMBOL_FILE</span>&quot;</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> -ra line; <span class="hljs-keyword">do</span><br><span class="hljs-keyword">if</span> [[ ! -z <span class="hljs-string">&quot;<span class="hljs-variable">$line</span>&quot;</span> ]]; <span class="hljs-keyword">then</span><br>ramdom=`ramdomString`<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$line</span> <span class="hljs-variable">$ramdom</span><br>insertValue <span class="hljs-variable">$line</span> <span class="hljs-variable">$ramdom</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#define <span class="hljs-variable">$line</span> <span class="hljs-variable">$ramdom</span>&quot;</span> &gt;&gt; <span class="hljs-variable">$HEAD_FILE</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">done</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#endif&quot;</span> &gt;&gt; <span class="hljs-variable">$HEAD_FILE</span><br><br>sqlite3 <span class="hljs-variable">$SYMBOL_DB_FILE</span> .dump<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„è„šæœ¬ä¼šä»å·¥ç¨‹æ ¹ç›®å½•ï¼ˆ$SRCROOTï¼‰ä¸‹çš„æ‰€æœ‰.må’Œ.hæ–‡ä»¶ä¸­ï¼Œè‡ªåŠ¨æ‰¾å‡ºä»¥â€œxMix_â€å¼€å¤´çš„å¾…æ··æ·†å‡½æ•°åï¼Œå†™å…¥ ToBeConfused.list æ–‡ä»¶ä¸­ã€‚ç„¶åå†ä» ToBeConfused.list ä¸­é€è¡Œæå–å‡½æ•°åè¿›è¡Œå®å®šä¹‰ï¼Œå®å®šä¹‰ä½¿ç”¨éšæœºå­—ç¬¦ä¸²ã€‚ç„¶åå†™åˆ° MapOfConfusion.h æ–‡ä»¶ä¸­ã€‚</p><p>ç¼–è¾‘å®Œæˆåä¿å­˜ï¼Œç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼ŒæŠŠ Confusion.sh è®¾ç½®æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> +x Confusion.sh<br></code></pre></td></tr></table></figure><h4 id="3-4-æ·»åŠ -Run-Script"><a href="#3-4-æ·»åŠ -Run-Script" class="headerlink" title="3.4.æ·»åŠ  Run Script"></a>3.4.æ·»åŠ  Run Script</h4><p>å·¥ç¨‹ Targets-ã€‹build phases-ã€‹New Run script Phaseï¼Œè®¾ç½®.shæ–‡ä»¶è·¯å¾„ï¼š</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-keyword">$PROJECT</span>_DIR/Confusion.sh</span><br></code></pre></td></tr></table></figure><h4 id="3-5-æ·»åŠ -PCH-æ–‡ä»¶"><a href="#3-5-æ·»åŠ -PCH-æ–‡ä»¶" class="headerlink" title="3.5.æ·»åŠ  PCH æ–‡ä»¶"></a>3.5.æ·»åŠ  PCH æ–‡ä»¶</h4><p>å·¥ç¨‹æ ¹ç›®å½•ä¸‹ï¼Œæ–°å»º PrefixHeader.pch æ–‡ä»¶ï¼Œå¹¶å¯¼å…¥ MapOfConfusion.hï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> PrefixHeader_pch</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PrefixHeader_pch</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;MapOfConfusion.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* PrefixHeader_pch */</span></span><br></code></pre></td></tr></table></figure><p>å·¥ç¨‹ Targets-ã€‹build Settings ä¸­æœç´¢Prefix Headerï¼Œè®¾ç½®å¥½ pch è·¯å¾„ï¼š</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-keyword">$PROJECT</span>_DIR/PrefixHeader.pch</span><br></code></pre></td></tr></table></figure><h4 id="3-6-æ·»åŠ ä»¥xMix-å¼€å¤´çš„æµ‹è¯•ä»£ç ï¼š"><a href="#3-6-æ·»åŠ ä»¥xMix-å¼€å¤´çš„æµ‹è¯•ä»£ç ï¼š" class="headerlink" title="3.6.æ·»åŠ ä»¥xMix_å¼€å¤´çš„æµ‹è¯•ä»£ç ï¼š"></a>3.6.æ·»åŠ ä»¥xMix_å¼€å¤´çš„æµ‹è¯•ä»£ç ï¼š</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> : <span class="hljs-title">UIViewController</span></span><br><br>- (<span class="hljs-type">void</span>)xMix_Function1;<br>- (<span class="hljs-type">void</span>)xMix_Function2WithName:(<span class="hljs-built_in">NSString</span> *)param1 xMix_Gender:(<span class="hljs-type">int</span>)param2;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h4 id="3-7-build-amp-class-dump"><a href="#3-7-build-amp-class-dump" class="headerlink" title="3.7.build &amp; class-dump"></a>3.7.build &amp; class-dump</h4><p>build ä¹‹åï¼Œæ‰“å¼€ MapOfConfusion.h æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä»¥xMix_å¼€å¤´çš„æ–¹æ³•åéƒ½å·²è¢«å®å®šä¹‰ä¸ºä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MapOfConfusion_h</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MapOfConfusion</span><br><span class="hljs-comment">//confuse string at Fri Dec 29 21:15:24 CST 2017</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> xMix_Function1 vKfXvdhupKXlBptl</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> xMix_Function2WithName xRDhGWmotGCNvgqp</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br></code></pre></td></tr></table></figure><p>æ‰“åŒ…ä¹‹åï¼Œå¾—åˆ° ipa æ–‡ä»¶ï¼Œä½¿ç”¨ class-dump å·¥å…·åç¼–è¯‘å‡º ViewController.h æ–‡ä»¶å³å¯æŸ¥çœ‹æ··æ·†ä¹‹åçš„ä»£ç ã€‚ï¼ˆç•¥ï¼‰</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="http://blog.csdn.net/yiyaaixuexi/article/details/29201699">Â©å¿µèŒœ</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é€†å‘å·¥ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shellè„šæœ¬æ‰“åŒ…ä¸ä¸Šä¼ </title>
    <link href="/2019/03/23/shell-ipa.html"/>
    <url>/2019/03/23/shell-ipa.html</url>
    
    <content type="html"><![CDATA[<h3 id="æ‰“åŒ…æµç¨‹ï¼š"><a href="#æ‰“åŒ…æµç¨‹ï¼š" class="headerlink" title="æ‰“åŒ…æµç¨‹ï¼š"></a>æ‰“åŒ…æµç¨‹ï¼š</h3><ol><li>ç¼–è¯‘.xcarchiveåŒ…ï¼›</li><li>ç”Ÿæˆ.ipaæ–‡ä»¶ï¼›</li><li>ä¸Šä¼ åˆ°è‹¹æœå•†åº—æˆ–ç¬¬ä¸‰æ–¹å¹³å°ã€‚</li></ol><h3 id="è‡ªåŠ¨åŒ–ï¼š"><a href="#è‡ªåŠ¨åŒ–ï¼š" class="headerlink" title="è‡ªåŠ¨åŒ–ï¼š"></a>è‡ªåŠ¨åŒ–ï¼š</h3><p>è¿™é‡Œæ‰€è¯´çš„è‡ªåŠ¨åŒ–ï¼Œä¸»è¦æ˜¯é€šè¿‡shellè„šæœ¬ï¼Œåˆ©ç”¨ Command Line Tools æä¾›çš„ <code>xcodebuild</code> å‘½ä»¤æ¥ç¼–è¯‘å’Œå¯¼å‡º ipaï¼Œå†é€šè¿‡ Application Loader æä¾›çš„ <code>altool</code> å‘½ä»¤è¡Œå·¥å…·ï¼Œæˆ–è€…å…¶ä»–ä¸‰æ–¹å¹³å°æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ä¸Šä¼  ipa å’Œ dSYM æ–‡ä»¶ã€‚</p><h4 id="æ¸…ç†æ„å»ºç›®å½•"><a href="#æ¸…ç†æ„å»ºç›®å½•" class="headerlink" title="æ¸…ç†æ„å»ºç›®å½•"></a>æ¸…ç†æ„å»ºç›®å½•</h4><p>ç¼–è¯‘å‰å…ˆcleanï¼Œç›¸å½“äºåœ¨ Xcode è¿›è¡Œ Product -&gt; cleanã€‚</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">xcodebuild</span> \<br>clean -configuration <span class="hljs-variable">$&#123;development_mode&#125;</span><br></code></pre></td></tr></table></figure><p><code>-configuration</code> ç”¨æ¥è¡¨ç¤ºæ‰“åŒ…çš„æ–¹å¼ï¼Œç›¸å½“äºæ‰“åŒ…å‰é…ç½® Edit scheme -&gt; info -&gt; Build configurationï¼Œå‘Šè¯‰ç¼–è¯‘å™¨æ‰“å‡ºæ¥çš„åŒ…æ˜¯ä½•ç§åŒ…ï¼Œæ¯”å¦‚ Releaseã€InHouseç­‰ã€‚</p><h4 id="ç¼–è¯‘xcarchiveåŒ…"><a href="#ç¼–è¯‘xcarchiveåŒ…" class="headerlink" title="ç¼–è¯‘xcarchiveåŒ…"></a>ç¼–è¯‘xcarchiveåŒ…</h4><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nsis">xcodebuild <span class="hljs-params">archive</span> \<br>-workspace <span class="hljs-variable">$&#123;project_path&#125;</span>/<span class="hljs-variable">$&#123;project_name&#125;</span>.xcworkspace \<br>-scheme <span class="hljs-variable">$&#123;scheme_name&#125;</span> \<br>-configuration <span class="hljs-variable">$&#123;development_mode&#125;</span> \<br>-<span class="hljs-params">archive</span>Path <span class="hljs-variable">$&#123;build_path&#125;</span>/<span class="hljs-variable">$&#123;project_name&#125;</span>.xc<span class="hljs-params">archive</span><br></code></pre></td></tr></table></figure><p><code>-workspace</code>è¡¨ç¤ºå·¥ä½œç©ºé—´ï¼Œä¸€ä¸ªé¡¹ç›®ä¸­æœ‰å¤šä¸ª<code>project</code>æ—¶ï¼Œæ¯”å¦‚é€šè¿‡ pod é›†æˆäº†ä¸‰æ–¹åº“åéƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œç©ºé—´ã€‚å¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥ä¸åŠ è¿™ä¸ªå‚æ•°ã€‚<code>-archivePath</code>ï¼Œç”¨æ¥é…ç½®ç”Ÿæˆçš„.xcarchiveçš„è·¯å¾„ã€‚</p><h4 id="å¯¼å‡ºipaæ–‡ä»¶"><a href="#å¯¼å‡ºipaæ–‡ä»¶" class="headerlink" title="å¯¼å‡ºipaæ–‡ä»¶"></a>å¯¼å‡ºipaæ–‡ä»¶</h4><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nsis">xcodebuild -export<span class="hljs-params">Archive</span> -<span class="hljs-params">archive</span>Path <span class="hljs-variable">$&#123;build_path&#125;</span>/<span class="hljs-variable">$&#123;project_name&#125;</span>.xc<span class="hljs-params">archive</span> \<br>-configuration <span class="hljs-variable">$&#123;development_mode&#125;</span> \<br>-exportPath <span class="hljs-variable">$&#123;exportIpaPath&#125;</span> \<br>-exportOptionsPlist <span class="hljs-variable">$&#123;exportOptionsPlistPath&#125;</span><br></code></pre></td></tr></table></figure><p><code>-exportPath</code>è¡¨ç¤º ipa æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ï¼›<br><br/></p><p><code>-exportOptionsPlist</code>è¡¨ç¤º ExportOptions.plist é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚æ­¤ plist æ˜¯æ‰“åŒ…æ—¶å¿…é¡»çš„æ–‡ä»¶ï¼Œåœ¨æ‰‹åŠ¨æ‰“åŒ…å¹¶ export å‡º ipa åŒ…æ—¶ï¼Œå¯ä»¥åœ¨ ipa åŒ…çš„åŒçº§ç›®å½•ä¸‹æ‰¾åˆ°ï¼Œå¯ä»¥æ‹¿è¿‡æ¥ç”¨ï¼Œæˆ–è€…é€šè¿‡ Xcode æ‰‹åŠ¨åˆ›å»ºä¸€ä»½ã€‚å¦‚æœæœ‰å¤šä¸ªæ¸ é“åŒ…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è„šæœ¬ç”Ÿæˆå¯¹åº”çš„ plistã€‚</p><p>#ç¤ºä¾‹ï¼šExportOptions.plist</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">plist</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="hljs-string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">plist</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>teamID<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>ç•¥ç•¥ç•¥<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>method<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>enterprise<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>uploadSymbols<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plist</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼šXcode9 ä¹‹åï¼ŒExportOptions.plist éœ€è¦æŒ‡å®šçš„ä¿¡æ¯æœ‰å˜ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="https://blog.csdn.net/andanlan/article/details/78113330?locationNum=9&fps=1">è¿™é‡Œ</a>~<br><br/></p><p><strong>#å®Œæ•´ç¤ºä¾‹</strong><br><br/></p><p>ä¸‹é¢æ˜¯å®Œæ•´çš„ shell è„šæœ¬ï¼Œå®ç°äº†ç¼–è¯‘.xcarchiveã€å¯¼å‡º ipa ä¸ dSYMï¼Œå‘½åä¸º<code>autobuild.sh</code>ï¼Œæ”¾åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br><span class="hljs-comment">#works for  Xcode 7.0+ only</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Start at <span class="hljs-subst">$(date)</span> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><br><br>PROJECT_ROOT_PATH=<span class="hljs-variable">$PWD</span><br>AUTOBUILD_PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/AutoBuild&quot;</span><br><br>CURRENT_DATE=$(<span class="hljs-built_in">date</span> +%Y_%m%d_%H%M)<br>WORKSPACE_NAME=<span class="hljs-string">&quot;Demo.xcworkspace&quot;</span><br><br><span class="hljs-comment">#å¯¼å‡ºé…ç½®</span><br>HEADER_PLIST=<span class="hljs-string">&quot;<span class="hljs-variable">$AUTOBUILD_PATH</span>/Header.plist&quot;</span><br>EXPORT_PLIST=<span class="hljs-string">&quot;<span class="hljs-variable">$AUTOBUILD_PATH</span>/ExportOptions.plist&quot;</span><br><br><span class="hljs-comment">#Info key</span><br>KEY_SCHEME=<span class="hljs-string">&quot;KEY_SCHEME&quot;</span><br>KEY_APP_NAME=<span class="hljs-string">&quot;KEY_APP_NAME&quot;</span><br>KEY_TEAM_ID=<span class="hljs-string">&quot;KEY_TEAM_ID&quot;</span><br>KEY_DEV_ID=<span class="hljs-string">&quot;KEY_DEV_ID&quot;</span><br><br><span class="hljs-comment">#Flavors</span><br>DemoInHouse=&#123;<span class="hljs-variable">$KEY_SCHEME</span>:<span class="hljs-string">&quot;DemoInHouse&quot;</span>,<span class="hljs-variable">$KEY_APP_NAME</span>:<span class="hljs-string">&quot;InHouse&quot;</span>,<span class="hljs-variable">$KEY_TEAM_ID</span>:<span class="hljs-string">&quot;xxxxxxxxxx&quot;</span>,<span class="hljs-variable">$KEY_DEV_ID</span>:<span class="hljs-string">&quot;xxx&quot;</span>&#125;<br>DemoRelease=&#123;<span class="hljs-variable">$KEY_SCHEME</span>:<span class="hljs-string">&quot;DemoRelease&quot;</span>,<span class="hljs-variable">$KEY_APP_NAME</span>:<span class="hljs-string">&quot;Release&quot;</span>,<span class="hljs-variable">$KEY_TEAM_ID</span>:<span class="hljs-string">&quot;xxxxxxxxxx&quot;</span>,<span class="hljs-variable">$KEY_DEV_ID</span>:<span class="hljs-string">&quot;xxx&quot;</span>&#125;<br><br>FLAVORS=(<span class="hljs-variable">$DemoInHouse</span>)<br><br><span class="hljs-comment">#Parse method</span><br><span class="hljs-function"><span class="hljs-title">parse_json</span></span>()&#123;<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$1</span> | sed <span class="hljs-string">&#x27;s/.*&#x27;</span><span class="hljs-variable">$2</span><span class="hljs-string">&#x27;:\([^,&#125;]*\).*/\1/&#x27;</span><br>&#125;<br><br><span class="hljs-comment">#build release apps directory</span><br>BUILD_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/Build&quot;</span><br>RELEASE_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$BUILD_DIR</span>/Products&quot;</span><br><br><span class="hljs-built_in">rm</span> -rdf <span class="hljs-variable">$BUILD_DIR</span><br><br><span class="hljs-comment">#final binarys&#x27; directory</span><br>OUT_BINARY_DIR=<span class="hljs-string">&quot;<span class="hljs-variable">$PROJECT_ROOT_PATH</span>/binarys_<span class="hljs-variable">$CURRENT_DATE</span>&quot;</span><br><br><span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$OUT_BINARY_DIR</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$OUT_BINARY_DIR</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">for</span> ((i = 0; i &lt; <span class="hljs-variable">$&#123;#FLAVORS[@]&#125;</span>; i++))<br><span class="hljs-keyword">do</span><br><span class="hljs-comment">#parse elements</span><br>TARGET_SCHEMES=$(parse_json <span class="hljs-variable">$&#123;FLAVORS[$i]&#125;</span> <span class="hljs-variable">$KEY_SCHEME</span>)<br>TARGET_APP_NAMES=$(parse_json <span class="hljs-variable">$&#123;FLAVORS[$i]&#125;</span> <span class="hljs-variable">$KEY_APP_NAME</span>)<br>TARGET_TEAM_IDS=$(parse_json <span class="hljs-variable">$&#123;FLAVORS[$i]&#125;</span> <span class="hljs-variable">$KEY_TEAM_ID</span>)<br>TARGET_DEV_IDS=$(parse_json <span class="hljs-variable">$&#123;FLAVORS[$i]&#125;</span> <span class="hljs-variable">$KEY_DEV_ID</span>)<br><br><span class="hljs-comment">#reset export options plist</span><br><span class="hljs-built_in">rm</span> <span class="hljs-variable">$EXPORT_PLIST</span><br><br><span class="hljs-built_in">cat</span> <span class="hljs-variable">$HEADER_PLIST</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;plist version=\&quot;1.0\&quot;&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;dict&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;key&gt;teamID&lt;/key&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;string&gt;<span class="hljs-variable">$TARGET_TEAM_IDS</span>&lt;/string&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;key&gt;method&lt;/key&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; target scheme <span class="hljs-variable">$TARGET_SCHEMES</span>&quot;</span><br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$TARGET_SCHEMES</span> = <span class="hljs-string">&quot;DemoInHouse&quot;</span> ]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;string&gt;enterprise&lt;/string&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; enterprise Done&quot;</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;string&gt;app-store&lt;/string&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; app-store Done&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;key&gt;uploadSymbols&lt;/key&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;true/&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;/dict&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;/plist&gt;&quot;</span> &gt;&gt; <span class="hljs-variable">$EXPORT_PLIST</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Reset export options Done&quot;</span><br><br><span class="hljs-comment">#æ›¿æ¢ç´ æ</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$AUTOBUILD_PATH</span><br>./replace_res.sh <span class="hljs-variable">$TARGET_SCHEMES</span><br><br><span class="hljs-comment"># return root</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$PROJECT_ROOT_PATH</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Reset res Done&quot;</span><br><br><span class="hljs-comment">#export files</span><br>ARCHIVE_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$OUT_BINARY_DIR</span>/<span class="hljs-variable">$TARGET_APP_NAMES</span>.xcarchive&quot;</span><br>DSYMS_FILE=<span class="hljs-string">&quot;<span class="hljs-variable">$TARGET_APP_NAMES</span>.dSYMs.zip&quot;</span><br><br><span class="hljs-comment">#clean prject</span><br>xcodebuild -workspace <span class="hljs-variable">$WORKSPACE_NAME</span> -scheme <span class="hljs-variable">$TARGET_SCHEMES</span> -configuration <span class="hljs-variable">$TARGET_APP_NAMES</span> clean<br><br><span class="hljs-comment">#build &amp; archive</span><br>xcodebuild archive -workspace <span class="hljs-variable">$WORKSPACE_NAME</span> -scheme <span class="hljs-variable">$TARGET_SCHEMES</span> -configuration <span class="hljs-variable">$TARGET_APP_NAMES</span> -archivePath <span class="hljs-variable">$ARCHIVE_FILE</span><br><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$ARCHIVE_FILE</span><br>zip -r <span class="hljs-variable">$DSYMS_FILE</span> <span class="hljs-string">&quot;dSYMs&quot;</span><br><span class="hljs-built_in">mv</span> <span class="hljs-variable">$DSYMS_FILE</span> <span class="hljs-variable">$OUT_BINARY_DIR</span><br><br><span class="hljs-comment"># return root</span><br><span class="hljs-built_in">cd</span> <span class="hljs-variable">$PROJECT_ROOT_PATH</span><br><br><span class="hljs-comment">#export</span><br>xcodebuild -exportArchive -archivePath <span class="hljs-variable">$ARCHIVE_FILE</span> -exportPath <span class="hljs-variable">$OUT_BINARY_DIR</span> -exportOptionsPlist <span class="hljs-variable">$EXPORT_PLIST</span><br><br><span class="hljs-comment">#rename ipa file failed since creating ipa file is asynchronized</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;apple id paired&quot;</span> &gt;&gt; <span class="hljs-string">&quot;<span class="hljs-variable">$OUT_BINARY_DIR</span>/$TARGET_APP_NAMES_<span class="hljs-variable">$TARGET_DEV_IDS</span>&quot;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; <span class="hljs-variable">$TARGET_SCHEMES</span> single loop Done&quot;</span><br><br><span class="hljs-keyword">done</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Finish at <span class="hljs-subst">$(date)</span> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶å…ˆæ ¹æ®éœ€è¦æ‰“åŒ…çš„ç‰ˆæœ¬ï¼Œä¿®æ”¹<code>FLAVORS=($DemoInHouse)</code>ä¸­çš„å†…å®¹ã€‚å¦‚æœåªæ‰“ä¸€ä¸ªåŒ…ï¼Œæ›´æ¢$åçš„å‘½åå³å¯ï¼›å¦‚æœéœ€è¦æ‰“å¤šä¸ªåŒ…ï¼Œåˆ™åœ¨è¾“å…¥å¤šä¸ªåŒ…åï¼Œä»¥é€—å·éš”å¼€ï¼Œå¦‚:<code>FLAVORS=($DemoInHouse,$DemoRelease)</code>ã€‚æœ€åï¼Œåœ¨ç»ˆç«¯ä¸­<code>./autobuild.sh</code>ï¼Œç›´æ¥æ‰§è¡Œè„šæœ¬å³å¯ã€‚</p><h4 id="éªŒè¯å¹¶ä¸Šä¼ åˆ°å•†åº—"><a href="#éªŒè¯å¹¶ä¸Šä¼ åˆ°å•†åº—" class="headerlink" title="éªŒè¯å¹¶ä¸Šä¼ åˆ°å•†åº—"></a>éªŒè¯å¹¶ä¸Šä¼ åˆ°å•†åº—</h4><p>Xcode é›†æˆäº† Application Loaderï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥æ‰‹åŠ¨ä¸Šä¼  App çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™é‡Œç»§ç»­ä½¿ç”¨è„šæœ¬çš„æ–¹å¼ï¼Œé€šè¿‡ Application Loader çš„å‘½ä»¤è¡Œå·¥å…· altool æ¥éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°å•†åº—ã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">//altoolå·¥å…·è·¯å¾„</span><br>altoolPath=<span class="hljs-string">&quot;/Applications/Xcode.app/Contents/Applications/Application Loader.app/Contents/Frameworks/ITunesSoftwareService.framework/Versions/A/Support/altool&quot;</span><br><span class="hljs-comment">//éªŒè¯</span><br><span class="hljs-string">&quot;$altoolPath&quot;</span> <span class="hljs-attr">--validate-app</span> -f $&#123;exportIpaPath&#125;/$&#123;scheme_name&#125;<span class="hljs-selector-class">.ipa</span> -u appleID -<span class="hljs-selector-tag">p</span> password -t ios <span class="hljs-attr">--output-format</span> xml<br><span class="hljs-comment">//ä¸Šä¼ </span><br><span class="hljs-string">&quot;$altoolPath&quot;</span> <span class="hljs-attr">--upload-app</span> -f $&#123;exportIpaPath&#125;/$&#123;scheme_name&#125;<span class="hljs-selector-class">.ipa</span> -u appleID -<span class="hljs-selector-tag">p</span> password -t ios <span class="hljs-attr">--output-format</span> xml<br></code></pre></td></tr></table></figure><table><thead><tr><th>å‚æ•°</th><th>è¯¦ç»†è¯´æ˜</th></tr></thead><tbody><tr><td>â€“validate-app</td><td>æ‚¨è¦éªŒè¯æŒ‡å®šçš„ Appã€‚</td></tr><tr><td>â€“upload-app</td><td>æ‚¨è¦ä¸Šä¼ æŒ‡å®šçš„ Appã€‚</td></tr><tr><td>-f file</td><td>æ­£åœ¨éªŒè¯æˆ–ä¸Šä¼ çš„ App çš„è·¯å¾„å’Œæ–‡ä»¶åã€‚</td></tr><tr><td>-u username</td><td>æ‚¨çš„ç”¨æˆ·åã€‚</td></tr><tr><td>-p password</td><td>æ‚¨çš„ç”¨æˆ·å¯†ç ã€‚</td></tr><tr><td>â€“output-format [xml or normal]</td><td>æ‚¨æƒ³è®© Application Loader ä»¥ç»“æ„åŒ–çš„ XML æ ¼å¼è¿˜æ˜¯éç»“æ„åŒ–çš„æ–‡æœ¬æ ¼å¼è¿”å›è¾“å‡ºä¿¡æ¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒApplication Loader ä»¥æ–‡æœ¬æ ¼å¼è¿”å›è¾“å‡ºä¿¡æ¯ã€‚</td></tr></tbody></table><h4 id="ä¸Šä¼ åˆ°Fir"><a href="#ä¸Šä¼ åˆ°Fir" class="headerlink" title="ä¸Šä¼ åˆ°Fir"></a>ä¸Šä¼ åˆ°Fir</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">firApiToken</span>=<span class="hljs-string">&quot;xxxxxxxxxxx&quot;</span><br>fir publish <span class="hljs-variable">$exportIpaPath</span>/<span class="hljs-variable">$scheme_name</span>.ipa -T <span class="hljs-string">&quot;<span class="hljs-variable">$firApiToken</span>&quot;</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼šä½¿ç”¨è„šæœ¬ä¸Šä¼ åˆ°Firå¹³å°å‰ï¼Œéœ€è¦å…ˆå®‰è£… fir-cliï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">gem install fir-<span class="hljs-keyword">cli</span><br></code></pre></td></tr></table></figure><h4 id="ä¸Šä¼ åˆ°è’²å…¬è‹±"><a href="#ä¸Šä¼ åˆ°è’²å…¬è‹±" class="headerlink" title="ä¸Šä¼ åˆ°è’²å…¬è‹±"></a>ä¸Šä¼ åˆ°è’²å…¬è‹±</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">curl</span> <span class="hljs-operator">-F</span> <span class="hljs-string">&quot;file=@<span class="hljs-variable">$exportIpaPath</span>/<span class="hljs-variable">$scheme_name</span>.ipa&quot;</span> <span class="hljs-operator">-F</span> <span class="hljs-string">&quot;uKey=xxx&quot;</span> <span class="hljs-operator">-F</span> <span class="hljs-string">&quot;_api_key=xxx https://qiniu-storage.pgyer.com/apiv1/app/upload</span><br></code></pre></td></tr></table></figure><p>è¯·æ ¹æ®å¼€å‘è€…è‡ªå·±çš„è´¦å·ï¼Œå°†å…¶ä¸­çš„ uKey å’Œ _api_key çš„å€¼æ›¿æ¢ä¸ºç›¸åº”çš„å€¼ã€‚å®Œæ•´çš„ä½¿ç”¨è§„åˆ™è¯·çœ‹ <a href="https://www.pgyer.com/doc/api">è¿™é‡Œ</a>~</p><h4 id="ä¸Šä¼ ç¬¦å·è¡¨"><a href="#ä¸Šä¼ ç¬¦å·è¡¨" class="headerlink" title="ä¸Šä¼ ç¬¦å·è¡¨"></a>ä¸Šä¼ ç¬¦å·è¡¨</h4><p>å¦‚æœåº”ç”¨æ¥å…¥äº†å´©æºƒåˆ†æå·¥å…·ï¼Œä¼šè¦æ±‚å°†dSYMæ–‡ä»¶ä¸Šä¼ åˆ°å¯¹åº”å¹³å°çš„åå°ä¸­ï¼Œæ¯”å¦‚æ¥å…¥buglyæ—¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹è„šæœ¬ä¸Šä¼ ç¬¦å·è¡¨æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar buglySymboliOS.jar -d -i <span class="hljs-variable">$dSYM</span> -u -<span class="hljs-built_in">id</span> <span class="hljs-string">&quot;xx&quot;</span> -key <span class="hljs-string">&quot;xx&quot;</span> -package <span class="hljs-string">&quot;com.xx.xx&quot;</span> -version <span class="hljs-string">&quot;<span class="hljs-variable">$version</span>&quot;</span> -o <span class="hljs-string">&quot;xx.zip&quot;</span><br></code></pre></td></tr></table></figure><p>bugly ä¸Šä¼  dSYM æ–‡ä»¶éœ€è¦äº‹å…ˆä¸‹è½½ä¸€ä¸ªå·¥å…·åŒ…ï¼Œå…·ä½“çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒ <a href="https://bugly.qq.com/docs/user-guide/symbol-configuration-ios/?v=20180709165613#_4">è¿™é‡Œ</a>~</p><h3 id="å…¶ä»–å·¥å…·"><a href="#å…¶ä»–å·¥å…·" class="headerlink" title="å…¶ä»–å·¥å…·"></a>å…¶ä»–å·¥å…·</h3><p>å½“ç„¶ï¼Œè¿˜æœ‰ä¸€äº›æ›´ä¸“ä¸šåŒ–çš„è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œå‘å¸ƒå·¥å…·ï¼Œå¦‚ï¼š</p><ul><li>Jenkins</li><li>FastLane</li></ul><p>è¿™äº›å·¥å…·æå¤§åœ°ç®€åŒ–äº†æˆ‘ä»¬æ‰‹åŠ¨å‘å¸ƒæ—¶çš„ä¸€äº›æ¯ç‡¥ã€é‡å¤çš„å·¥ä½œï¼Œæ¯”å¦‚æˆªå›¾ã€ä»£ç ç­¾åä»¥åŠå‘å¸ƒã€‚è¿™é‡Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼Œå¯ä»¥è‡ªè¡Œåˆ°å…¶å®˜ç½‘æŸ¥è¯¢~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://www.jianshu.com/p/05dc9f925467">Â©JiaJung-è‡ªåŠ¨æ‰“åŒ…å‘å¸ƒåˆ°Firå’ŒAppStore</a></p><p>#<a href="https://www.jianshu.com/p/bd4c22952e01">Â©zackzheng-è¯¦è§£Shellè„šæœ¬å®ç°iOSè‡ªåŠ¨åŒ–ç¼–è¯‘æ‰“åŒ…æäº¤</a></p><p>#<a href="https://github.com/webfrogs/xcode_shell">Â©Github.webfrogs-xcode_shell</a></p><p>#<a href="https://blog.csdn.net/cdut100/article/details/76381605">Â©FastLane-è‡ªåŠ¨åŒ–æ‰“åŒ…å‘å¸ƒ</a></p><p>#<a href="https://help.apple.com/itc/apploader/#/apdATD1E53-D1E1A1303-D1E53A1126">Â©Application Loader-altoolå·¥å…·</a></p><p>#<a href="https://blog.csdn.net/andanlan/article/details/78113330?locationNum=9&fps=1">Â©æ ‘å¶æœ‰ç –æ”»-Xcode9 xcodebuild export plist é…ç½®</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•ˆç‡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS åº”ç”¨é€†å‘å·¥ç¨‹</title>
    <link href="/2019/03/22/iosreverse.html"/>
    <url>/2019/03/22/iosreverse.html</url>
    
    <content type="html"><![CDATA[<p>ä¸€èˆ¬æ¥è¯´ï¼Œè½¯ä»¶é€†å‘å·¥ç¨‹å¯ä»¥çœ‹ä½œ<code>ç³»ç»Ÿåˆ†æ</code>å’Œ<code>ä»£ç åˆ†æ</code>ä¸¤ä¸ªé˜¶æ®µçš„æœ‰æœºç»“åˆã€‚åœ¨<code>ç³»ç»Ÿåˆ†æ</code>é˜¶æ®µï¼Œæˆ‘ä»¬ä»æ•´ä½“ä¸Šè§‚å¯Ÿç›®æ ‡ç¨‹åºçš„è¡Œä¸ºç‰¹å¾ï¼Œæ–‡ä»¶çš„ç»„ç»‡æ¶æ„ï¼Œä»è€Œæ‰¾åˆ°æˆ‘ä»¬æ„Ÿå…´è¶£çš„åœ°æ–¹ã€‚<code>ä»£ç åˆ†æ</code>é˜¶æ®µï¼Œåˆ©ç”¨å„ç§å·¥å…·å¯¹ç¨‹åºæœ¬èº«çš„äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œåˆ†æï¼Œä»è€Œäº†è§£ç›®æ ‡è½¯ä»¶çš„å®ç°ï¼Œè¿›è€Œå€Ÿé‰´å…¶è®¾è®¡æ€è·¯ã€å†…éƒ¨ç®—æ³•ã€åæ€æ•™è®­ç­‰ã€‚</p><h3 id="1-è®¾å¤‡è¶Šç‹±"><a href="#1-è®¾å¤‡è¶Šç‹±" class="headerlink" title="1.è®¾å¤‡è¶Šç‹±"></a>1.è®¾å¤‡è¶Šç‹±</h3><p>é€šè¿‡<code>çˆ±æ€</code>ã€<code>PPåŠ©æ‰‹</code>ã€<code>åŒæ­¥åŠ©æ‰‹</code>ã€<code>unc0ver</code>ç­‰å·¥å…·ï¼Œå¯¹å·²ç»å¤‡ä»½è¿‡çš„è®¾å¤‡è¿›è¡Œè¶Šç‹±ï¼›</p><h3 id="2-å®‰è£…æ’ä»¶"><a href="#2-å®‰è£…æ’ä»¶" class="headerlink" title="2.å®‰è£…æ’ä»¶"></a>2.å®‰è£…æ’ä»¶</h3><h4 id="2-1-OpenSSH"><a href="#2-1-OpenSSH" class="headerlink" title="2.1.OpenSSH"></a>2.1.OpenSSH</h4><p>OpenSSH ä¼šåœ¨ iOS è®¾å¤‡ä¸Šå®‰è£… SSH æœåŠ¡ï¼Œä»è€Œç»™å¤–ç•Œæä¾›äº†ä¸€ä¸ªé€šè¿‡ SSH æ¥å…¥ iOS è®¾å¤‡çš„é€”å¾„ã€‚å¸¸ç”¨çš„æœ‰ä¸¤ä¸ªå‘½ä»¤ï¼š<br><br/></p><p><code>ssh</code>ï¼Œç”¨äºè¿œç¨‹ç™»å½•ï¼š</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>ssh root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.31</span>.<span class="hljs-number">242</span><br></code></pre></td></tr></table></figure><p><code>scp</code>ï¼Œç”¨äºè¿œç¨‹æ‹·è´æ–‡ä»¶ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>æœ¬åœ°æ‹·è´åˆ°æ‰‹æœº<br>$ scp <span class="hljs-regexp">/path/</span>localFile root@<span class="hljs-number">192.168</span>.<span class="hljs-number">31.242</span>:<span class="hljs-regexp">/path/</span>remoteFile <br><span class="hljs-regexp">//</span>æ‰‹æœºæ‹·è´åˆ°æœ¬åœ°<br>$ scp root@<span class="hljs-number">192.168</span>.<span class="hljs-number">31.242</span>:<span class="hljs-regexp">/path/</span>remoteFile <span class="hljs-regexp">/path/</span>localFile <br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ Cydia åœ¨çº¿æºç›´æ¥æœç´¢ OpenSSH å³å¯æ‰¾åˆ°å¹¶å®‰è£…ã€‚<br><br/></p><p>æ³¨æ„ï¼šiOSè®¾å¤‡ä¸Šæœ‰ <code>root</code>å’Œ<code>mobile</code>ä¸¤ä¸ªç”¨æˆ·ï¼Œåœ¨å®‰è£…å®Œ SSH åè®°å¾—ä¿®æ”¹é»˜è®¤ç™»å½•å¯†ç â€œalpineâ€ï¼Œé˜²æ­¢ç—…æ¯’é€šè¿‡ ssh ä»¥ root ç”¨æˆ·èº«ä»½ç™»å½•è®¾å¤‡ã€‚å®‰è£…SSHå’Œä¿®æ”¹å¯†ç çš„æ–¹æ³•ï¼Œä¸€èˆ¬åœ¨Cydiaçš„é¦–é¡µéƒ½æœ‰è¯´æ˜ï¼Œå¯æŒ‰ç…§è¯´æ˜ä¸€æ­¥æ­¥æ“ä½œå³å¯ã€‚</p><h4 id="2-2-Cycript"><a href="#2-2-Cycript" class="headerlink" title="2.2.Cycript"></a>2.2.Cycript</h4><p>Cycript æ˜¯é€†å‘å·¥ç¨‹ä¸­ç”¨æ¥è¿›è¡ŒåŠ¨æ€åˆ†æçš„åˆ©å™¨ï¼Œèƒ½å¤Ÿè®©å¼€å‘äººå‘˜åœ¨å‘½ä»¤è¡Œä¸‹å’Œåº”ç”¨äº¤äº’ï¼Œåœ¨æ‰§è¡Œæ—¶æŸ¥çœ‹å’Œæ”¹åŠ¨åº”ç”¨ï¼Œå¦‚å¸®åŠ©æˆ‘ä»¬åœ¨è¿è¡Œæ—¶æŸ¥çœ‹åº”ç”¨è§†å›¾å±‚çº§ã€å‡½æ•°ç­‰ä¿¡æ¯ã€‚</p><ul><li>å®‰è£…æ–¹æ³•1ï¼š</li></ul><p>ä» Cydia è‡ªå¸¦æº<code>Cydia/Telesphoreo</code>ä¸‹è½½å®‰è£…ã€‚</p><ul><li>å®‰è£…æ–¹æ³•2ï¼š</li></ul><p>åœ¨ <a href="http://www.cycript.org/debs/?C=M;O=D">å®˜ç½‘</a> ä¸­æ‰¾åˆ°<code>cycript_0.9.501_iphoneos-arm.deb</code>å’Œ<code>libffi_1:3.0.10-5_iphoneos-arm.deb</code>è¿™ä¸¤ä¸ªå®‰è£…åŒ…ï¼Œä¸‹è½½åˆ° MacOS ä¸Šã€‚ç”¨ sftp ä¸Šä¼ ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶åˆ°è®¾å¤‡ä¸Šï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">$ sftp root@<span class="hljs-number">192.168</span>.<span class="hljs-number">31.242</span><br>sftp&gt; <span class="hljs-keyword">put</span> cycript_0.<span class="hljs-number">9.501</span>_iphoneos-arm.<span class="hljs-keyword">deb</span><br>sftp&gt; <span class="hljs-keyword">put</span> libffi_1:<span class="hljs-number">3.0</span>.<span class="hljs-number">10</span>-<span class="hljs-number">5</span>_iphoneos-arm.<span class="hljs-keyword">deb</span><br></code></pre></td></tr></table></figure><p>ä¸Šä¼ è¿›åº¦100%åï¼Œç”¨ dpkg -iæ¥å®‰è£…debåŒ…ï¼š</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>ssh root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.31</span>.<span class="hljs-number">242</span><br>~ root<span class="hljs-comment"># dpkg -i cycript_0.9.501_iphoneos-arm.deb</span><br></code></pre></td></tr></table></figure><ul><li>å®‰è£…æ–¹æ³•3ï¼š</li></ul><p>sshç™»å½•åï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">apt-<span class="hljs-built_in">get</span> install cycrypt<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œ cycriptï¼Œå¦‚æœå‡ºç°cy#ç¬¦å·ï¼Œåˆ™å®‰è£…å®Œæ¯•:</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">~ root<span class="hljs-comment"># cycript</span><br>cy<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><h3 id="3-dumpdecrypted-dylib"><a href="#3-dumpdecrypted-dylib" class="headerlink" title="3.dumpdecrypted.dylib"></a>3.dumpdecrypted.dylib</h3><p>ä» Github ä¸Šä¸‹è½½ dumpdecrypted æºç ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ git clone https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/stefanesser/</span>dumpdecrypted.git dumpdecrypted<br>Cloning into <span class="hljs-string">&#x27;dumpdecrypted&#x27;</span>...<br>remote: Counting objects: <span class="hljs-number">31</span>, done.<br>remote: Total <span class="hljs-number">31</span> (delta <span class="hljs-number">0</span>), reused <span class="hljs-number">0</span> (delta <span class="hljs-number">0</span>), pack-reused <span class="hljs-number">31</span><br>Unpacking objects: <span class="hljs-number">100</span>% (<span class="hljs-number">31</span>/<span class="hljs-number">31</span>), done.<br></code></pre></td></tr></table></figure><p>è¿›å…¥<code>dumpdecrypted</code>ç›®å½•æŸ¥çœ‹æœ‰å“ªäº›æ–‡ä»¶ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> dumpdecrypted/<br><span class="hljs-variable">$</span> <span class="hljs-built_in">ls</span><br>Makefile    README      dumpdecrypted.c<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ dumpdecrypted.dylib</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">$ make<br>`xcrun <span class="hljs-attr">--sdk</span> iphoneos <span class="hljs-attr">--find</span> gcc` -Os  -Wimplicit -isysroot `xcrun <span class="hljs-attr">--sdk</span> iphoneos <span class="hljs-attr">--show-sdk-path</span>` -F`xcrun <span class="hljs-attr">--sdk</span> iphoneos <span class="hljs-attr">--show-sdk-path</span>`/System/Library/Frameworks -F`xcrun <span class="hljs-attr">--sdk</span> iphoneos <span class="hljs-attr">--show-sdk-path</span>`/System/Library/PrivateFrameworks -arch armv7 -arch armv7s -arch arm64 -c -o dumpdecrypted<span class="hljs-selector-class">.o</span> dumpdecrypted<span class="hljs-selector-class">.c</span> <br><span class="hljs-number">2018</span>-<span class="hljs-number">07</span>-<span class="hljs-number">27</span> <span class="hljs-number">22</span>:<span class="hljs-number">09</span>:<span class="hljs-number">19.065</span> xcodebuild<span class="hljs-selector-attr">[1941:437762]</span> <span class="hljs-selector-attr">[MT]</span> PluginLoading: Required plug-<span class="hljs-keyword">in</span> compatibility UUID <span class="hljs-number">426</span>A087B-D3AA-<span class="hljs-number">431</span>A-AFDF-F135EC00DE1C <span class="hljs-keyword">for</span> plug-<span class="hljs-keyword">in</span> at path <span class="hljs-string">&#x27;~/Library/Application Support/Developer/Shared/Xcode/Plug-ins/VVDocumenter-Xcode.xcplugin&#x27;</span> not present <span class="hljs-keyword">in</span> DVTPlugInCompatibilityUUIDs<br>`xcrun <span class="hljs-attr">--sdk</span> iphoneos <span class="hljs-attr">--find</span> gcc` -Os  -Wimplicit -isysroot `xcrun <span class="hljs-attr">--sdk</span> iphoneos <span class="hljs-attr">--show-sdk-path</span>` -F`xcrun <span class="hljs-attr">--sdk</span> iphoneos <span class="hljs-attr">--show-sdk-path</span>`/System/Library/Frameworks -F`xcrun <span class="hljs-attr">--sdk</span> iphoneos <span class="hljs-attr">--show-sdk-path</span>`/System/Library/PrivateFrameworks -arch armv7 -arch armv7s -arch arm64 -dynamiclib -o dumpdecrypted<span class="hljs-selector-class">.dylib</span> dumpdecrypted<span class="hljs-selector-class">.o</span><br>ld: warning: directory not found <span class="hljs-keyword">for</span> option <span class="hljs-string">&#x27;-F/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS11.4.sdk/System/Library/PrivateFrameworks&#x27;</span><br>ld: warning: directory not found <span class="hljs-keyword">for</span> option <span class="hljs-string">&#x27;-F/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS11.4.sdk/System/Library/PrivateFrameworks&#x27;</span><br>ld: warning: directory not found <span class="hljs-keyword">for</span> option <span class="hljs-string">&#x27;-F/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS11.4.sdk/System/Library/PrivateFrameworks&#x27;</span><br></code></pre></td></tr></table></figure><p><code>make</code>å‘½ä»¤æ‰§è¡Œå®Œä¹‹åä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª<code>dumpdecrypted.dylib</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯åé¢ç”¨æ¥ç ¸å£³ç”¨çš„æ¦”å¤´ã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">ls</span><br>Makefiledumpdecrypted.cdumpdecrypted.o<br>READMEdumpdecrypted.dylib<br></code></pre></td></tr></table></figure><h3 id="4-å®šä½è¿›ç¨‹"><a href="#4-å®šä½è¿›ç¨‹" class="headerlink" title="4.å®šä½è¿›ç¨‹"></a>4.å®šä½è¿›ç¨‹</h3><p>å…³é—­è®¾å¤‡ä¸­æ‰€æœ‰çš„åº”ç”¨ï¼Œæ‰“å¼€<code>å¤®è§†å½±éŸ³</code>(Cbox)ã€‚<br><br/></p><p>é€šè¿‡sshï¼Œä»¥ root èº«ä»½ç™»å½•è®¾å¤‡ï¼š</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>ssh root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.31</span>.<span class="hljs-number">242</span><br></code></pre></td></tr></table></figure><p>ç”¨<code>adv-cmds</code>å‘½ä»¤è¡Œæ’ä»¶è‡ªå¸¦çš„<code>ps</code>å‘½ä»¤ï¼Œå®šä½<code>å¤®è§†å½±éŸ³</code>è¿›ç¨‹ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gradle">~ root# ps -e | <span class="hljs-keyword">grep</span> <span class="hljs-regexp">/var/</span><br> <span class="hljs-number">5193</span> ??         <span class="hljs-number">0</span>:<span class="hljs-number">01.90</span> <span class="hljs-regexp">/var/</span>containers<span class="hljs-regexp">/Bundle/</span>Application<span class="hljs-regexp">/BE3F444E-5002-40A6-AFF3-71DB398DAB18/M</span>obileMail.app/MobileMail<br> <span class="hljs-number">5195</span> ??         <span class="hljs-number">6</span>:<span class="hljs-number">05.27</span> <span class="hljs-regexp">/var/</span>containers<span class="hljs-regexp">/Bundle/</span>Application<span class="hljs-regexp">/B3248F78-A0C2-4965-8E2F-B3CEE38E71C0/</span>DYZB.app/DYZB<br> <span class="hljs-number">5218</span> ??        <span class="hljs-number">12</span>:<span class="hljs-number">15.94</span> <span class="hljs-regexp">/var/</span>containers<span class="hljs-regexp">/Bundle/</span>Application<span class="hljs-regexp">/9437BC53-681D-4F41-889C-5DE6DAAD33CD/</span>Cbox.app/Cbox<br> <span class="hljs-number">5317</span> ??         <span class="hljs-number">0</span>:<span class="hljs-number">40.58</span> <span class="hljs-regexp">/var/</span>containers<span class="hljs-regexp">/Bundle/</span>Application<span class="hljs-regexp">/6EE6BF3A-94DB-4356-811C-5CD35CEAD4CC/</span>XMFilmTelevision.app/XMFilmTelevision<br> <span class="hljs-number">5860</span> ??         <span class="hljs-number">0</span>:<span class="hljs-number">00.58</span> <span class="hljs-regexp">/private/</span>var<span class="hljs-regexp">/containers/</span>Bundle<span class="hljs-regexp">/Application/</span>C73F08EB-<span class="hljs-number">2</span>C9B-<span class="hljs-number">4169</span>-<span class="hljs-number">9</span>C2C-<span class="hljs-number">8</span>E933417465B<span class="hljs-regexp">/BlockerTest.app/</span>PlugIns<span class="hljs-regexp">/Blocker.appex/</span>Blocker<br> <span class="hljs-number">5861</span> ??         <span class="hljs-number">0</span>:<span class="hljs-number">25.78</span> <span class="hljs-regexp">/private/</span>var<span class="hljs-regexp">/containers/</span>Bundle<span class="hljs-regexp">/Application/</span>EA8607BE-AD62-<span class="hljs-number">4179</span>-B060-E939B00FD212<span class="hljs-regexp">/Shadowrocket.app/</span>PlugIns<span class="hljs-regexp">/Today.appex/</span>Today<br> <span class="hljs-number">5862</span> ??         <span class="hljs-number">0</span>:<span class="hljs-number">00.84</span> <span class="hljs-regexp">/private/</span>var<span class="hljs-regexp">/containers/</span>Bundle<span class="hljs-regexp">/Application/</span>B6364A33-<span class="hljs-number">5</span>BEF-<span class="hljs-number">4059</span>-<span class="hljs-number">8491</span>-EF8DB484176C<span class="hljs-regexp">/Shortcuts.app/</span>PlugIns<span class="hljs-regexp">/ShortcutsWidget.appex/</span>ShortcutsWidget<br> <span class="hljs-number">5863</span> ??         <span class="hljs-number">0</span>:<span class="hljs-number">01.37</span> <span class="hljs-regexp">/private/</span>var<span class="hljs-regexp">/containers/</span>Bundle<span class="hljs-regexp">/Application/</span>B2D9F8D2-<span class="hljs-number">3853</span>-<span class="hljs-number">4</span>BE6-<span class="hljs-number">8500</span>-<span class="hljs-number">8</span>D4FE4140A4E<span class="hljs-regexp">/Weather.app/</span>PlugIns<span class="hljs-regexp">/WeatherAppTodayWidget.appex/</span>WeatherAppTodayWidget<br> <span class="hljs-number">6034</span> ??         <span class="hljs-number">0</span>:<span class="hljs-number">00.16</span> <span class="hljs-regexp">/private/</span>var<span class="hljs-regexp">/containers/</span>Bundle<span class="hljs-regexp">/Application/</span>C73F08EB-<span class="hljs-number">2</span>C9B-<span class="hljs-number">4169</span>-<span class="hljs-number">9</span>C2C-<span class="hljs-number">8</span>E933417465B<span class="hljs-regexp">/BlockerTest.app/</span>PlugIns<span class="hljs-regexp">/Tunnel.appex/</span>Tunnel<br> <span class="hljs-number">6247</span> ttys000    <span class="hljs-number">0</span>:<span class="hljs-number">00.02</span> <span class="hljs-keyword">grep</span> <span class="hljs-regexp">/var/</span><br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œçš„æ•°å­—æ˜¯è¿›ç¨‹å¯¹åº”çš„PIDï¼Œæœ€åä¸€è¡Œå°±æ˜¯è¿›ç¨‹æ‰€åœ¨çš„ç›®å½•ã€‚ä½¿ç”¨<code>ps -e</code>å‘½ä»¤æ—¶ç»ˆç«¯é‡Œä¼šåˆ—å‡ºä¸€å †ç³»ç»Ÿè¿›ç¨‹å’Œåº”ç”¨ï¼Œå®ƒä»¬å¾€å¾€ä»¥<code>/usr/</code>å’Œ<code>/System/</code>å¼€å¤´ï¼Œè€Œæˆ‘ä»¬ä¸‹è½½çš„åº”ç”¨ä¸€èˆ¬ä»¥<code>/var/</code>å¼€å¤´ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶<code>ps -e | grep /var/</code>ï¼Œè¿™æ ·ç»“æœå°±ç®€åŒ–è®¸å¤šã€‚<br><br/></p><p>å› ä¸ºè®¾å¤‡ä¸Šåªæ‰“å¼€äº†ä¸€ä¸ªåº”ç”¨ï¼Œæ‰€ä»¥å«æœ‰<code>/var/containers/Bundle/Application/</code>å­—æ ·çš„ç»“æœå°±æ˜¯storeAppå¯æ‰§è¡Œæ–‡ä»¶çš„å…¨è·¯å¾„ï¼Œè¿™é‡Œæˆ‘éœ€è¦è®°å½•ä¸‹æ¥çš„æ˜¯<code>å¤®è§†å½±éŸ³</code>è¿™ä¸ªè¿›ç¨‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/var/</span>containers<span class="hljs-regexp">/Bundle/</span>Application<span class="hljs-regexp">/9437BC53-681D-4F41-889C-5DE6DAAD33CD/</span>Cbox.app/Cbox<br></code></pre></td></tr></table></figure><h3 id="5-Documents-ç›®å½•"><a href="#5-Documents-ç›®å½•" class="headerlink" title="5.Documents ç›®å½•"></a>5.Documents ç›®å½•</h3><p>é€šè¿‡<code>cycript -p</code>å‘½ä»¤ç›‘å¬ <code>Cbox</code>è¿›ç¨‹ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">~ root<span class="hljs-comment"># cycript -p Cbox</span><br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡<code>Cbox</code>çš„<code>PID</code>æ¥ç›‘å¬ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">~ root<span class="hljs-comment"># cycript -p 5218</span><br></code></pre></td></tr></table></figure><p>æ¥ç€åœ¨<code>cy#</code>åé¢è¾“å…¥ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">cy# [[<span class="hljs-built_in">NSFileManager</span> defaultManager] URLsForDirectory:<span class="hljs-built_in">NSDocumentDirectory</span> inDomains:<span class="hljs-built_in">NSUserDomainMask</span>]<br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥æ˜¯ç”¨ Cycript æ‰¾å‡º<code>Cbox</code>çš„<code>Documents</code>ç›®å½•ï¼Œè¾“å‡ºç»“æœï¼š</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs subunit">#&quot;/var/mobile/Containers/Data/Application/D02582B3<span class="hljs-string">-66</span>D3<span class="hljs-string">-4</span>EF1-A6C2<span class="hljs-string">-6129</span>D4E1B9CA/Documents/&quot;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ<code>/var/mobile/Containers/Data/Application/D02582B3-66D3-4EF1-A6C2-6129D4E1B9CA/Documents/</code>å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç›®å½•ï¼Œ<code>Ctrl + D</code>é€€å‡º Cycript æ¨¡å¼ã€‚</p><h3 id="6-æ‹·è´åŠ¨æ€åº“"><a href="#6-æ‹·è´åŠ¨æ€åº“" class="headerlink" title="6.æ‹·è´åŠ¨æ€åº“"></a>6.æ‹·è´åŠ¨æ€åº“</h3><p>å°†æ­¥éª¤#3 ä¸­ç¼–è¯‘çš„<code>dumpdecrypted.dylib</code>æ‹·è´åˆ°åˆšæ‰çš„<code>Documents</code>ç›®å½•ä¸‹ï¼š</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>scp /<span class="hljs-title class_">Users</span>/davidli/<span class="hljs-title class_">Documents</span>/dumpdecrypted/dumpdecrypted.dylib root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.31</span>.<span class="hljs-number">242</span><span class="hljs-symbol">:/var/mobile/Containers/Data/Application/D02582B3-</span><span class="hljs-number">66</span>D3<span class="hljs-number">-4</span>EF1-<span class="hljs-title class_">A6C2</span><span class="hljs-number">-6129</span>D4E1B9CA/<span class="hljs-title class_">Documents</span>/<br></code></pre></td></tr></table></figure><p>å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<code>iTools</code>æˆ–è€…<code>iFunBox</code>ç­‰å·¥å…·æ¥å®Œæˆã€‚</p><h3 id="7-ç ¸å£³"><a href="#7-ç ¸å£³" class="headerlink" title="7.ç ¸å£³"></a>7.ç ¸å£³</h3><p>ä»åº”ç”¨å•†åº—ä¸‹è½½çš„åº”ç”¨æ˜¯è¢«è‹¹æœç‰¹æ®ŠåŠ å¯†è¿‡çš„ï¼Œå¯æ‰§è¡Œæ–‡ä»¶è¢«å¥—ä¸Šäº†ä¸€å±‚ä¿æŠ¤å£³ï¼Œæƒ³ dump å‡ºå®ƒçš„å¤´æ–‡ä»¶ç­‰ï¼Œéœ€è¦å…ˆè§£å¯†åº”ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±è¢«ç§°ä¸º<code>ç ¸å£³</code>ã€‚<br><br/></p><p><code>dumpdecrypted</code>å°±æ˜¯ä¸€æ¬¾æœ‰åçš„ç ¸å£³è½¯ä»¶ï¼Œå…¶å·¥ä½œåŸç†æ˜¯ï¼šå°†åº”ç”¨è¿è¡Œèµ·æ¥ï¼ˆiOSç³»ç»Ÿä¼šå…ˆè§£å¯†åº”ç”¨å¯æ‰§è¡Œæ–‡ä»¶å†å¯åŠ¨ï¼‰ï¼Œç„¶åéå† <code>Load Command</code> ä¸­æ‰€æœ‰ <code>LC_ENCRYPTION_INFO</code> æˆ– <code>LC_ENCRYPTION_INFO_64</code>æŒ‡ä»¤çš„ä¿¡æ¯ï¼Œå°†å¯¹åº”è§£å¯†åçš„æ•°æ®ä»å†…å­˜ä¸­ dump å‡ºæ¥ï¼Œå¤å†™åˆ° mach-o æ–‡ä»¶ä¸­ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„å¯æ‰§è¡Œç¨‹åºã€‚</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">~ root# cd <span class="hljs-regexp">/var/m</span>obile<span class="hljs-regexp">/Containers/</span>Data<span class="hljs-regexp">/Application/</span>D02582B3-<span class="hljs-number">66</span>D3-<span class="hljs-number">4</span>EF1-A6C2-<span class="hljs-number">6129</span>D4E1B9CA<span class="hljs-regexp">/Documents/</span><br>root# DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib <span class="hljs-regexp">/var/</span>containers<span class="hljs-regexp">/Bundle/</span>Application<span class="hljs-regexp">/9437BC53-681D-4F41-889C-5DE6DAAD33CD/</span>Cbox.app/Cbox<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>DYLD_INSERT_LIBRARIES</code>æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬çš„<code>dumpdecrypted.dylib</code>å°±æ˜¯è¦é€šè¿‡è¿™ä¸ªç¯å¢ƒå˜é‡æ³¨å…¥åˆ°åº”ç”¨ä¸­ã€‚<br><br/></p><p>ä¸Šè¿°å‘½ä»¤æ‰§è¡Œå®Œæ¯•åä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ<code>Cbox.decrypted</code>ï¼Œå³ç ¸å£³ä¹‹å App çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">root<span class="hljs-comment"># ls</span><br>Cbox.decrypted     dumpdecrypted.dylib <span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><h3 id="8-æ‹·è´-decrypted"><a href="#8-æ‹·è´-decrypted" class="headerlink" title="8.æ‹·è´.decrypted"></a>8.æ‹·è´.decrypted</h3><p>å°† Cbox.decrypted æ‹·è´åˆ°è‡ªå·±çš„ç”µè„‘ä¸Šï¼š</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>scp root<span class="hljs-variable">@192</span>.<span class="hljs-number">168.31</span>.<span class="hljs-number">242</span><span class="hljs-symbol">:/var/mobile/Containers/Data/Application/D02582B3-</span><span class="hljs-number">66</span>D3<span class="hljs-number">-4</span>EF1-<span class="hljs-title class_">A6C2</span><span class="hljs-number">-6129</span>D4E1B9CA/<span class="hljs-title class_">Documents</span>/<span class="hljs-title class_">Cbox</span>.decrypted /<span class="hljs-title class_">Users</span>/davidli/<span class="hljs-title class_">Documents</span>/decrypted<br></code></pre></td></tr></table></figure><h3 id="9-åæ±‡ç¼–"><a href="#9-åæ±‡ç¼–" class="headerlink" title="9.åæ±‡ç¼–"></a>9.åæ±‡ç¼–</h3><p>æ¥ä¸‹æ¥å°±å¯ä»¥å¯¹æ­¤ç ¸å£³åçš„æ–‡ä»¶è¿›è¡Œé™æ€åˆ†æäº†ï¼Œå¦‚ç”¨<code>class-dump</code>å¯¼å‡º App çš„å¤´æ–‡ä»¶ã€ç”¨ <code>Hopper Disassembler</code>æŸ¥çœ‹ä¼ªä»£ç ã€‚</p><h4 id="9-1-class-dump"><a href="#9-1-class-dump" class="headerlink" title="9.1.class-dump"></a>9.1.class-dump</h4><p>class-dump æ˜¯ç”¨æ¥ dump ç›®æ ‡å¯¹è±¡çš„ ç±»ã€åˆ†ç±»ã€åè®®ä¿¡æ¯çš„å·¥å…·ï¼Œè¿™ä¸€ç‚¹ä¸<code>otool</code>ç±»ä¼¼ã€‚å®ƒåˆ©ç”¨ OC è¯­è¨€çš„ runtime ç‰¹æ€§ï¼Œå°†å­˜å‚¨åœ¨ Mach-O æ–‡ä»¶ä¸­çš„å¤´æ–‡ä»¶ä¿¡æ¯æå–å‡ºæ¥ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„.hæ–‡ä»¶ã€‚åœ¨<a href="http://stevenygard.com/projects/class-dump/"> ä¼ é€é—¨ </a>ä¸‹è½½æœ€æ–°å®‰è£…åŒ…ï¼Œç„¶åæŠŠ<code>class-dump</code>æ–‡ä»¶æ”¾åˆ°<code>/usr/local/bin</code>ç›®å½•ä¸‹ï¼Œ åœ¨ç»ˆç«¯è¾“å…¥<code>class-dump</code>ï¼Œæ˜¾ç¤º<code>class-dump</code>çš„ç‰ˆæœ¬åï¼Œå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨ class-dump å‘½ä»¤äº†ã€‚</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs stata">$ <span class="hljs-keyword">class</span>-dump<br><span class="hljs-keyword">class</span>-dump 3.5 (64 bit)<br>Usage: <span class="hljs-keyword">class</span>-dump [options] &lt;mach-o-<span class="hljs-keyword">file</span>&gt;<br><br>  where options are:<br>        -a             show instance variable offsets<br>        -A             show implementation addresses<br>        --<span class="hljs-keyword">arch</span> &lt;<span class="hljs-keyword">arch</span>&gt;  choose a specific architecture from a universal binary (ppc, ppc64, i386, x86_64, armv6, armv7, armv7s, arm64)<br>        -C &lt;regex&gt;     only <span class="hljs-keyword">display</span> classes matching regular expression<br>        -f &lt;str&gt;       find string <span class="hljs-keyword">in</span> method name<br>        -<span class="hljs-keyword">H</span>             <span class="hljs-keyword">generate</span> header files <span class="hljs-keyword">in</span> current directory, or directory specified with -o<br>        -I             <span class="hljs-keyword">sort</span> classes, categories, and protocols <span class="hljs-keyword">by</span> inheritance (overrides -s)<br>        -o &lt;<span class="hljs-keyword">dir</span>&gt;       output directory used <span class="hljs-keyword">for</span> -<span class="hljs-keyword">H</span><br>        -r             recursively <span class="hljs-keyword">expand</span> frameworks and fixed VM shared libraries<br>        -s             <span class="hljs-keyword">sort</span> classes and categories <span class="hljs-keyword">by</span> name<br>        -S             <span class="hljs-keyword">sort</span> methods <span class="hljs-keyword">by</span> name<br>        -t             suppress header <span class="hljs-keyword">in</span> output, <span class="hljs-keyword">for</span> testing<br>        --<span class="hljs-keyword">list</span>-arches  <span class="hljs-keyword">list</span> the arches <span class="hljs-keyword">in</span> the <span class="hljs-keyword">file</span>, then <span class="hljs-keyword">exit</span><br>        --sdk-ios      specify iOS SDK <span class="hljs-keyword">version</span> (will look <span class="hljs-keyword">in</span> /Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS&lt;<span class="hljs-keyword">version</span>&gt;.sdk<br>        --sdk-<span class="hljs-keyword">mac</span>      specify <span class="hljs-keyword">Mac</span> OS X <span class="hljs-keyword">version</span> (will look <span class="hljs-keyword">in</span> /Developer/SDKs/MacOSX&lt;<span class="hljs-keyword">version</span>&gt;.sdk<br>        --sdk-root     specify the full SDK root path (or <span class="hljs-keyword">use</span> --sdk-ios/--sdk-<span class="hljs-keyword">mac</span> <span class="hljs-keyword">for</span> a shortcut)<br><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ class-dump å¯¼å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„.h</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">class</span>-<span class="hljs-keyword">dump</span> [--arch armv7] -H -s <span class="hljs-regexp">/ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ -o /</span>å¯¼å‡ºç›®å½•<br></code></pre></td></tr></table></figure><p>å¯¼å‡ºçš„æ–‡ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">$ ls<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAAlertItem</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AACloseNotifyReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AACloseNotifyRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AACloseReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AACloseRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AALaunchByMoneyReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AALaunchByMoneyRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AALaunchByPersonReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AALaunchByPersonRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AALaunchItem</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAListRecord</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAOperationReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAOperationRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAPayReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAPayRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAPaySuccReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAPaySuccRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAPayUrgeReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAPayUrgeRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAPayer</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAQueryDetailReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAQueryDetailRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAQueryListReq</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AAQueryListRes</span>.</span></span>h<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AARealNameItem</span>.</span></span>h<br>ABNewPersonViewControllerDelegate-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Protocol</span>.</span></span>h<br>ABPeoplePickerNavigationControllerDelegate-<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Protocol</span>.</span></span>h<br>...<br></code></pre></td></tr></table></figure><h4 id="9-2-Hopper"><a href="#9-2-Hopper" class="headerlink" title="9.2.Hopper"></a>9.2.Hopper</h4><p>class-dump åªèƒ½æŸ¥çœ‹ç›®æ ‡ APP çš„å¤´æ–‡ä»¶ï¼Œæ— æ³•æŸ¥çœ‹.m æ–‡ä»¶å’Œå…·ä½“çš„ä»£ç ï¼Œæ‰€ä»¥å°±éœ€è¦ä½¿ç”¨åˆ°åæ±‡ç¼–å™¨ã€‚è¿™é‡Œä»‹ç»çš„æ˜¯<code>Hopper Disassembler</code>ï¼Œå®ƒæ˜¯ä¸€æ¬¾äºŒè¿›åˆ¶åæ±‡ç¼–å™¨ï¼Œèƒ½åç¼–è¯‘å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„æ‰€æœ‰å‡½æ•°å’Œå®ç°ï¼ŒåŒ…æ‹¬ä¼ªä»£ç ä»¥åŠæ§åˆ¶æµå›¾(Control Flow Graph)ï¼Œæ”¯æŒ ARM æŒ‡ä»¤é›†å¹¶é’ˆå¯¹ OC åšäº†ä¼˜åŒ–ã€‚å®˜ç½‘ <a href="https://www.hopperapp.com/">ä¼ é€é—¨</a>ï¼Œä¸‹è½½è¯•ç”¨ç‰ˆå°±å¤Ÿç”¨äº†ã€‚<br><br/></p><p>å°†ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶æ‹–åˆ° <code>Hopper Disassembler</code> é¢æ¿ä¸­ï¼šï¼ˆå¦‚æœæ˜¯ç¬¬ä¸‰æ–¹å¸‚åœºä¸‹è½½çš„è¶Šç‹±åº”ç”¨ï¼Œé¡»å°†<code>.ipa</code>æ–‡ä»¶åç¼€æ”¹ä¸º<code>.zip</code>ï¼Œè§£å‹ååœ¨<code>/Payload</code>ç›®å½•ä¸‹æ‰¾åˆ°<code>.app</code>æ–‡ä»¶ï¼Œå³é”® <code>æ˜¾ç¤ºåŒ…å«å†…å®¹</code> å³å¯çœ‹åˆ°ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_disassembler1.png" alt="disassembler1"></p><p>é€‰æ‹©éœ€è¦åç¼–è¯‘çš„æ¶æ„ä¹‹åç‚¹<code>OK</code>ï¼Œæ¥ä¸‹æ¥ Hopper å°±ä¼šè‡ªåŠ¨åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶çš„å„ä¸ª<code>segment</code>ã€‚åŠ è½½å®Œæˆåå³å¯çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_disassembler3.png" alt="disassembler3"></p><p>å·¦è¾¹æ˜¯ç¬¦å· Label ç­‰åŒºåŸŸï¼Œä¸­é—´æ˜¯ ARM çš„æ±‡ç¼–ä»£ç ï¼Œå³è¾¹æ˜¯ç›¸å…³ä¿¡æ¯æ ã€‚<br><br/></p><p>åœ¨ Label åŒºæœç´¢æ ä¸­è¾“å…¥æƒ³è¦çš„å‡½æ•°åï¼ŒåŒå‡»æœç´¢ç»“æœåˆ—è¡¨ä¸­å¯¹åº”çš„è¡Œå³å¯è‡ªåŠ¨è·³è½¬åˆ°è¯¥æ–¹æ³•çš„å†…å­˜åœ°å€å¤„ã€‚ä¸è¿‡è¿™é‡Œæ˜¾ç¤ºçš„éƒ½æ˜¯ ARM æ±‡ç¼–æŒ‡ä»¤ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬äº†å¾ˆå¤š<code>r0~r8</code>ç­‰å¯„å­˜å™¨ï¼Œé˜…è¯»æ€§ä¸é«˜ã€‚æ‰€ä»¥å¯ä»¥ä½¿ç”¨ä¸Šé¢æåˆ°çš„ä¼ªä»£ç åŠŸèƒ½ï¼Œå¿«æ·é”® <code>Option + Enter</code> æˆ–è€…ç‚¹å‡»å³ä¸Šè§’é¢æ¿ä¸­çš„ <code>if(b)f(x)</code>æŒ‰é’®å³å¯è‡ªåŠ¨å¼¹å‡ºä¼ªä»£ç è§†å›¾ï¼Œè¿™äº›å°±æ˜¯å…·ä½“çš„ä»£ç é€»è¾‘ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_disassembler5.png" alt="disassembler3"></p><p><strong>ps:</strong> Hopper é™¤äº†å¯ä»¥æŸ¥çœ‹æ±‡ç¼–ä»£ç ä»¥å¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥å¯¹ Mach-O æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œç„¶åé‡æ–°ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ›¿æ¢åŸäºŒè¿›åˆ¶æ–‡ä»¶åé‡æ–°æ‰“åŒ…å³å¯å®ç°æŸäº›ç‰¹æ®Šç›®çš„ï¼Œå¦‚å»å¹¿å‘Šã€å¾®ä¿¡è‡ªåŠ¨æŠ¢çº¢åŒ…ã€VIPåŠ é€Ÿç­‰ã€‚è¿™äº›å†…å®¹åŠARMæ±‡ç¼–æŒ‡ä»¤å¾…åé¢ç»§ç»­ç ”ç©¶ã€‚ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#Â©æ²™æ¢“ç¤¾Â·å´èˆªã€iOSåº”ç”¨é€†å‘å·¥ç¨‹ã€‘</p><p>#<a href="http://bbs.iosre.com/">Â©iosreè®ºå›</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é€†å‘å·¥ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mach-O</title>
    <link href="/2019/03/16/mach_o.html"/>
    <url>/2019/03/16/mach_o.html</url>
    
    <content type="html"><![CDATA[<p>Xcode æ„å»ºä¸€ä¸ªç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠæºæ–‡ä»¶ (.m å’Œ .h) æ–‡ä»¶è½¬æ¢ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆMach-O executableï¼‰ã€‚è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­åŒ…å«çš„å­—èŠ‚ç å°†ä¼šè¢« CPU (iOS è®¾å¤‡ä¸­çš„ ARM å¤„ç†å™¨æˆ– Mac ä¸Šçš„ Intel å¤„ç†å™¨) æ‰§è¡Œã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ Xcodeï¼Œè€Œæ˜¯é€šè¿‡è‹¹æœæä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆcommand line toolsï¼‰æ¥æ„å»ºä¸€ä¸ªç¨‹åºã€‚</p><h2 id="1-ä¸ä½¿ç”¨-Xcode-çš„-Hello-World"><a href="#1-ä¸ä½¿ç”¨-Xcode-çš„-Hello-World" class="headerlink" title="#1 ä¸ä½¿ç”¨ Xcode çš„ Hello World"></a>#1 ä¸ä½¿ç”¨ Xcode çš„ Hello World</h2><p>é€šè¿‡ç»ˆç«¯ (Terminal)ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«ä¸€ä¸ª C æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> command-line</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> !$</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">touch</span> helloworld.c</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ¥ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">open -e helloworld.c<br></code></pre></td></tr></table></figure><p>è¾“å…¥å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello World!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿å­˜å¹¶è¿”å›åˆ°ç»ˆç«¯ï¼Œç„¶åè¿è¡Œå¦‚ä¸‹å‘½ä»¤ç¼–è¯‘ helloworld.c æ–‡ä»¶ï¼š</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>xcrun clang helloworld.c<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šäº§ç”Ÿä¸€ä¸ªåä¸º a.out çš„æ–‡ä»¶ï¼Œä½¿ç”¨fileå‘½ä»¤æŸ¥çœ‹å…¶ä¿¡æ¯:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">$ file <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.out</span> <br><span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.out</span>: Mach-O <span class="hljs-number">64</span>-bit executable x86_64<br></code></pre></td></tr></table></figure><p>è¿™ä¸ª a.out æ–‡ä»¶å°±æ˜¯ä½¿ç”¨ clang ç¼–è¯‘å™¨å°† helloworld.c ç¼–è¯‘åäº§ç”Ÿçš„ä¸€ä¸ª Mach-O æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåå­—ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šé»˜è®¤çš„å°†å…¶æŒ‡å®šä¸º a.outã€‚</p><p>ç„¶åæˆ‘ä»¬æ‰§è¡Œæ­¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç»ˆç«¯ä¸­çš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>./a.<span class="hljs-keyword">out</span> <br>Hello World!<br></code></pre></td></tr></table></figure><hr><h2 id="2-Mach-Oï¼ˆå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼‰"><a href="#2-Mach-Oï¼ˆå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼‰" class="headerlink" title="#2 Mach-Oï¼ˆå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼‰"></a>#2 Mach-Oï¼ˆå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼‰</h2><p>Mach-O æ˜¯ Mach object æ–‡ä»¶æ ¼å¼çš„ç¼©å†™ï¼Œç±»ä¼¼äº windows ç¯å¢ƒä¸‹çš„ PE æ ¼å¼ã€Linux ç¯å¢ƒä¸‹çš„ ELF æ ¼å¼ã€‚æˆ‘ä»¬å¹³æ—¶è§åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€dSYMç¬¦å·æ–‡ä»¶ã€DylibåŠ¨æ€åº“ã€Framework ç­‰ä½¿ç”¨çš„éƒ½æ˜¯è¿™ç§æ ¼å¼ã€‚</p><blockquote><p>Mach-Oæä¾›æ›´å¤šçš„å¯æ‰©å±•æ€§å’Œæ›´å¿«çš„ç¬¦å·è¡¨ä¿¡æ¯å­˜å–ã€‚</p></blockquote><blockquote><p>Mach-Oåº”ç”¨åœ¨åŸºäºMachæ ¸å¿ƒçš„ç³»ç»Ÿä¸Šï¼Œç›®å‰NeXTSTEPã€Darwinã€Mac OS Xï¼ˆiPhoneï¼‰éƒ½æ˜¯ä½¿ç”¨è¿™ç§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ã€‚</p></blockquote><p>Mach-O æ–‡ä»¶çš„ç»“æ„ç”± Headerã€Load commandsã€Dataï¼ˆåŒ…å«Segementçš„å…·ä½“æ•°æ®ï¼‰ç»„æˆã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_mach_o.jpg" alt="image"></p><p>ä¸Šé¢æˆ‘ä»¬ç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶ a.out ä½¿ç”¨çš„ä¹Ÿæ˜¯è¿™ç§æ ¼å¼ã€‚</p><p>#ç¤ºä¾‹1ï¼šä½¿ç”¨ otool å‘½ä»¤æŸ¥çœ‹ a.out æ–‡ä»¶çš„å†…éƒ¨ç»“æ„</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><code class="hljs dns">$ otool -l a.out <br>a.out:<br>Mach header<br>      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags<br> <span class="hljs-number">0</span>xfeedfacf <span class="hljs-number">16777223</span>          <span class="hljs-number">3</span>  <span class="hljs-number">0</span>x80           <span class="hljs-number">2</span>    <span class="hljs-number">15</span>       <span class="hljs-number">1200</span> <span class="hljs-number">0x00200085</span><br>Load command <span class="hljs-number">0</span><br>      cmd LC_SEGMENT_64<br>  cmdsize <span class="hljs-number">72</span><br>  segname __PAGEZERO<br>   vmaddr <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br>   vmsize <span class="hljs-number">0</span>x0000<span class="hljs-number">000100000000</span><br>  fileoff <span class="hljs-number">0</span><br> filesize <span class="hljs-number">0</span><br>  maxprot <span class="hljs-number">0x00000000</span><br> initprot <span class="hljs-number">0x00000000</span><br>   nsects <span class="hljs-number">0</span><br>    flags <span class="hljs-number">0</span>x0<br>Load command <span class="hljs-number">1</span><br>      cmd LC_SEGMENT_64<br>  cmdsize <span class="hljs-number">472</span><br>  segname __TEXT<br>   vmaddr <span class="hljs-number">0</span>x0000<span class="hljs-number">000100000000</span><br>   vmsize <span class="hljs-number">0</span>x00000<span class="hljs-number">00000001000</span><br>  fileoff <span class="hljs-number">0</span><br> filesize <span class="hljs-number">4096</span><br>  maxprot <span class="hljs-number">0x00000007</span><br> initprot <span class="hljs-number">0x00000005</span><br>   nsects <span class="hljs-number">5</span><br>    flags <span class="hljs-number">0</span>x0<br>Section<br>  sectname __text<br>   segname __TEXT<br>      addr <span class="hljs-number">0</span>x0000<span class="hljs-number">000100000f50</span><br>      size <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000034</span><br>    offset <span class="hljs-number">3920</span><br>     align <span class="hljs-number">2</span>^<span class="hljs-number">4</span> (<span class="hljs-number">16</span>)<br>    reloff <span class="hljs-number">0</span><br>    nreloc <span class="hljs-number">0</span><br>     flags <span class="hljs-number">0x80000400</span><br> reserved1 <span class="hljs-number">0</span><br> reserved2 <span class="hljs-number">0</span><br>Section<br>  sectname __stubs<br>   segname __TEXT<br>      addr <span class="hljs-number">0</span>x0000<span class="hljs-number">000100000f84</span><br>      size <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000006</span><br>    offset <span class="hljs-number">3972</span><br>     align <span class="hljs-number">2</span>^<span class="hljs-number">1</span> (<span class="hljs-number">2</span>)<br>    reloff <span class="hljs-number">0</span><br>    nreloc <span class="hljs-number">0</span><br>     flags <span class="hljs-number">0x80000408</span><br> reserved1 <span class="hljs-number">0</span> (index into indirect symbol table)<br> reserved2 <span class="hljs-number">6</span> (size of stubs)<br>Section<br>  sectname __stub_helper<br>   segname __TEXT<br>      addr <span class="hljs-number">0</span>x0000000100000f8c<br>      size <span class="hljs-number">0</span>x000000000000001a<br>    offset <span class="hljs-number">3980</span><br>     align <span class="hljs-number">2</span>^<span class="hljs-number">2</span> (<span class="hljs-number">4</span>)<br>    reloff <span class="hljs-number">0</span><br>    nreloc <span class="hljs-number">0</span><br>     flags <span class="hljs-number">0x80000400</span><br> reserved1 <span class="hljs-number">0</span><br> reserved2 <span class="hljs-number">0</span><br>Section<br>  sectname __cstring<br>   segname __TEXT<br>      addr <span class="hljs-number">0</span>x0000000100000fa6<br>      size <span class="hljs-number">0</span>x000000000000000e<br>    offset <span class="hljs-number">4006</span><br>     align <span class="hljs-number">2</span>^<span class="hljs-number">0</span> (<span class="hljs-number">1</span>)<br>    reloff <span class="hljs-number">0</span><br>    nreloc <span class="hljs-number">0</span><br>     flags <span class="hljs-number">0x00000002</span><br> reserved1 <span class="hljs-number">0</span><br> reserved2 <span class="hljs-number">0</span><br>Section<br>  sectname __unwind_info<br>   segname __TEXT<br>      addr <span class="hljs-number">0</span>x0000000100000fb4<br>      size <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000048</span><br>    offset <span class="hljs-number">4020</span><br>     align <span class="hljs-number">2</span>^<span class="hljs-number">2</span> (<span class="hljs-number">4</span>)<br>    reloff <span class="hljs-number">0</span><br>    nreloc <span class="hljs-number">0</span><br>     flags <span class="hljs-number">0x00000000</span><br> reserved1 <span class="hljs-number">0</span><br> reserved2 <span class="hljs-number">0</span><br>Load command <span class="hljs-number">2</span><br>      cmd LC_SEGMENT_64<br>  cmdsize <span class="hljs-number">232</span><br>  segname __DATA<br>   vmaddr <span class="hljs-number">0</span>x0000<span class="hljs-number">000100001000</span><br>   vmsize <span class="hljs-number">0</span>x00000<span class="hljs-number">00000001000</span><br>  fileoff <span class="hljs-number">4096</span><br> filesize <span class="hljs-number">4096</span><br>  maxprot <span class="hljs-number">0x00000007</span><br> initprot <span class="hljs-number">0x00000003</span><br>   nsects <span class="hljs-number">2</span><br>    flags <span class="hljs-number">0</span>x0<br>Section<br>  sectname __nl_symbol_ptr<br>   segname __DATA<br>      addr <span class="hljs-number">0</span>x0000<span class="hljs-number">000100001000</span><br>      size <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000010</span><br>    offset <span class="hljs-number">4096</span><br>     align <span class="hljs-number">2</span>^<span class="hljs-number">3</span> (<span class="hljs-number">8</span>)<br>    reloff <span class="hljs-number">0</span><br>    nreloc <span class="hljs-number">0</span><br>     flags <span class="hljs-number">0x00000006</span><br> reserved1 <span class="hljs-number">1</span> (index into indirect symbol table)<br> reserved2 <span class="hljs-number">0</span><br>Section<br>  sectname __la_symbol_ptr<br>   segname __DATA<br>      addr <span class="hljs-number">0</span>x0000<span class="hljs-number">000100001010</span><br>      size <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000008</span><br>    offset <span class="hljs-number">4112</span><br>     align <span class="hljs-number">2</span>^<span class="hljs-number">3</span> (<span class="hljs-number">8</span>)<br>    reloff <span class="hljs-number">0</span><br>    nreloc <span class="hljs-number">0</span><br>     flags <span class="hljs-number">0x00000007</span><br> reserved1 <span class="hljs-number">3</span> (index into indirect symbol table)<br> reserved2 <span class="hljs-number">0</span><br>Load command <span class="hljs-number">3</span><br>      cmd LC_SEGMENT_64<br>  cmdsize <span class="hljs-number">72</span><br>  segname __LINKEDIT<br>   vmaddr <span class="hljs-number">0</span>x0000<span class="hljs-number">000100002000</span><br>   vmsize <span class="hljs-number">0</span>x00000<span class="hljs-number">00000001000</span><br>  fileoff <span class="hljs-number">8192</span><br> filesize <span class="hljs-number">240</span><br>  maxprot <span class="hljs-number">0x00000007</span><br> initprot <span class="hljs-number">0x00000001</span><br>   nsects <span class="hljs-number">0</span><br>    flags <span class="hljs-number">0</span>x0<br>Load command <span class="hljs-number">4</span><br>            cmd LC_DYLD_INFO_ONLY<br>        cmdsize <span class="hljs-number">48</span><br>     rebase_off <span class="hljs-number">8192</span><br>    rebase_size <span class="hljs-number">8</span><br>       bind_off <span class="hljs-number">8200</span><br>      bind_size <span class="hljs-number">24</span><br>  weak_bind_off <span class="hljs-number">0</span><br> weak_bind_size <span class="hljs-number">0</span><br>  lazy_bind_off <span class="hljs-number">8224</span><br> lazy_bind_size <span class="hljs-number">16</span><br>     export_off <span class="hljs-number">8240</span><br>    export_size <span class="hljs-number">48</span><br>Load command <span class="hljs-number">5</span><br>     cmd LC_SYMTAB<br> cmdsize <span class="hljs-number">24</span><br>  symoff <span class="hljs-number">8296</span><br>   nsyms <span class="hljs-number">4</span><br>  stroff <span class="hljs-number">8376</span><br> strsize <span class="hljs-number">56</span><br>Load command <span class="hljs-number">6</span><br>            cmd LC_DYSYMTAB<br>        cmdsize <span class="hljs-number">80</span><br>      ilocalsym <span class="hljs-number">0</span><br>      nlocalsym <span class="hljs-number">0</span><br>     iextdefsym <span class="hljs-number">0</span><br>     nextdefsym <span class="hljs-number">2</span><br>      iundefsym <span class="hljs-number">2</span><br>      nundefsym <span class="hljs-number">2</span><br>         tocoff <span class="hljs-number">0</span><br>           ntoc <span class="hljs-number">0</span><br>      modtaboff <span class="hljs-number">0</span><br>        nmodtab <span class="hljs-number">0</span><br>   extrefsymoff <span class="hljs-number">0</span><br>    nextrefsyms <span class="hljs-number">0</span><br> indirectsymoff <span class="hljs-number">8360</span><br>  nindirectsyms <span class="hljs-number">4</span><br>      extreloff <span class="hljs-number">0</span><br>        nextrel <span class="hljs-number">0</span><br>      locreloff <span class="hljs-number">0</span><br>        nlocrel <span class="hljs-number">0</span><br>Load command <span class="hljs-number">7</span><br>          cmd LC_LOAD_DYLINKER<br>      cmdsize <span class="hljs-number">32</span><br>         name /usr/lib/dyld (offset <span class="hljs-number">12</span>)<br>Load command <span class="hljs-number">8</span><br>     cmd LC_UUID<br> cmdsize <span class="hljs-number">24</span><br>    uuid <span class="hljs-number">6122E2B2</span>-<span class="hljs-number">9651-3991</span>-B2BA-<span class="hljs-number">15</span>B45ADC0C6B<br>Load command <span class="hljs-number">9</span><br>      cmd LC_VERSION_MIN_MACOSX<br>  cmdsize <span class="hljs-number">16</span><br>  version <span class="hljs-number">10</span>.<span class="hljs-number">13</span><br>      sdk <span class="hljs-number">10</span>.<span class="hljs-number">13</span><br>Load command <span class="hljs-number">10</span><br>      cmd LC_SOURCE_VERSION<br>  cmdsize <span class="hljs-number">16</span><br>  version <span class="hljs-number">0</span>.<span class="hljs-number">0</span><br>Load command <span class="hljs-number">11</span><br>       cmd LC_MAIN<br>   cmdsize <span class="hljs-number">24</span><br>  entryoff <span class="hljs-number">3920</span><br> stacksize <span class="hljs-number">0</span><br>Load command <span class="hljs-number">12</span><br>          cmd LC_LOAD_DYLIB<br>      cmdsize <span class="hljs-number">56</span><br>         name /usr/lib/libSystem.B.dylib (offset <span class="hljs-number">24</span>)<br>   time stamp <span class="hljs-number">2</span> Thu Jan  <span class="hljs-number">1 08:00:02</span> <span class="hljs-number">1970</span><br>      current version <span class="hljs-number">1252.50.4</span><br>compatibility version <span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span><br>Load command <span class="hljs-number">13</span><br>      cmd LC_FUNCTION_STARTS<br>  cmdsize <span class="hljs-number">16</span><br>  dataoff <span class="hljs-number">8288</span><br> datasize <span class="hljs-number">8</span><br>Load command <span class="hljs-number">14</span><br>      cmd LC_DATA_IN_CODE<br>  cmdsize <span class="hljs-number">16</span><br>  dataoff <span class="hljs-number">8296</span><br> datasize <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="2-1-Header"><a href="#2-1-Header" class="headerlink" title="##2.1.Header"></a>##2.1.Header</h3><p>å¤´éƒ¨ä¸»è¦ç”¨æ¥è§„å®šè¿™ä¸ªæ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Œä»¥åŠæ–‡ä»¶æ˜¯å¦‚ä½•è¢«åŠ è½½çš„ï¼ˆé€šè¿‡ otool -h å¯ä»¥æ‰“å°å‡ºå¤´ä¿¡æ¯ï¼‰ã€‚</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tap">$ otool -h a.out <br>Mach header<br>      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags<br> 0xfeedfacf<span class="hljs-number"> 16777223 </span>        <span class="hljs-number"> 3 </span> 0x80          <span class="hljs-number"> 2 </span>  <span class="hljs-number"> 15 </span>     <span class="hljs-number"> 1200 </span>0x00200085<br></code></pre></td></tr></table></figure><ul><li>32 ä½æ¶æ„ä¸‹ Header çš„æ•°æ®ç»“æ„ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">mach_header</span> &#123;<br>    <span class="hljs-type">uint32_t</span>    magic;      <span class="hljs-comment">/* mach magic number identifier */</span><br>    <span class="hljs-type">cpu_type_t</span>  cputype;    <span class="hljs-comment">/* cpu specifier */</span><br>    <span class="hljs-type">cpu_subtype_t</span>   cpusubtype; <span class="hljs-comment">/* machine specifier */</span><br>    <span class="hljs-type">uint32_t</span>    filetype;   <span class="hljs-comment">/* type of file */</span><br>    <span class="hljs-type">uint32_t</span>    ncmds;      <span class="hljs-comment">/* number of load commands */</span><br>    <span class="hljs-type">uint32_t</span>    sizeofcmds; <span class="hljs-comment">/* the size of all the load commands */</span><br>    <span class="hljs-type">uint32_t</span>    flags;      <span class="hljs-comment">/* flags */</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>64 ä½æ¶æ„ä¸‹ Header çš„æ•°æ®ç»“æ„ï¼š</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">mach_header</span> &#123;<br>    <span class="hljs-type">uint32_t</span>    magic;      <span class="hljs-comment">/* mach magic number identifier */</span><br>    <span class="hljs-type">cpu_type_t</span>  cputype;    <span class="hljs-comment">/* cpu specifier */</span><br>    <span class="hljs-type">cpu_subtype_t</span>   cpusubtype; <span class="hljs-comment">/* machine specifier */</span><br>    <span class="hljs-type">uint32_t</span>    filetype;   <span class="hljs-comment">/* type of file */</span><br>    <span class="hljs-type">uint32_t</span>    ncmds;      <span class="hljs-comment">/* number of load commands */</span><br>    <span class="hljs-type">uint32_t</span>    sizeofcmds; <span class="hljs-comment">/* the size of all the load commands */</span><br>    <span class="hljs-type">uint32_t</span>    flags;      <span class="hljs-comment">/* flags */</span><br>    <span class="hljs-type">uint32_t</span>    reserved;   <span class="hljs-comment">/* reserved */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>64 ä½æ¶æ„åªæ¯” 32 ä½æ¶æ„å¤šäº†ä¸€ä¸ª reserved å­—æ®µã€‚</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs matlab">å‚æ•°ï¼š<span class="hljs-built_in">magic</span><br></code></pre></td></tr></table></figure><p>è¡¨ç¤ºå½“å‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ç±»å‹ï¼Œä¸åŒç±»å‹çš„äºŒè¿›åˆ¶æ–‡ä»¶æœ‰è‡ªå·±ç‹¬ç‰¹çš„â€é­”æ•°å€¼â€ã€‚åŠ è½½å™¨é€šè¿‡è¿™ä¸ªé­”æ•°å€¼æ¥åˆ¤æ–­è¿™æ˜¯ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Œä¾‹å¦‚32ä½ Mach-O æ–‡ä»¶çš„é­”æœ¯å€¼æ˜¯ 0xfeedfaceã€64ä½ Mach-O æ–‡ä»¶çš„é­”æœ¯å€¼æ˜¯ 0xfeedfacfã€èƒ–äºŒè¿›åˆ¶æ–‡ä»¶çš„é­”æ•°å€¼æ˜¯ 0xcafebabeã€‚æ‰€ä»¥è¿™ä¸ªå­—æ®µä¹Ÿå¯ä»¥ç”¨äºå¿«é€Ÿç¡®è®¤è¯¥æ–‡ä»¶ç”¨äº64ä½è¿˜æ˜¯32ä½ã€‚</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm">å‚æ•°ï¼šcpu<span class="hljs-keyword">type</span><br></code></pre></td></tr></table></figure><p>cupçš„ç±»å‹ï¼ˆå¦‚ iOSè®¾å¤‡çš„ARMã€Macä¸Šçš„Intelï¼‰ã€‚</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm">å‚æ•°ï¼šcpusub<span class="hljs-keyword">type</span><br></code></pre></td></tr></table></figure><p>cupçš„å­ç±»å‹ï¼ˆå¦‚armv7ã€arm64ç­‰ï¼‰ã€‚</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm">å‚æ•°ï¼šfile<span class="hljs-keyword">type</span><br></code></pre></td></tr></table></figure><p>æ–‡ä»¶ç±»å‹ï¼ˆå¦‚å¯æ‰§è¡Œæ–‡ä»¶ã€åº“æ–‡ä»¶ã€dSYMæ–‡ä»¶ç­‰ï¼‰ï¼Œå…·ä½“æšä¸¾å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp">* Constants <span class="hljs-keyword">for</span> the filetype field of the mach_header<br> */<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_OBJECT   0x1     <span class="hljs-comment">/* relocatable object file */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_EXECUTE  0x2     <span class="hljs-comment">/* demand paged executable file */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_FVMLIB   0x3     <span class="hljs-comment">/* fixed VM shared library file */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_CORE     0x4     <span class="hljs-comment">/* core file */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_PRELOAD  0x5     <span class="hljs-comment">/* preloaded executable file */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_DYLIB    0x6     <span class="hljs-comment">/* dynamically bound shared library */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_DYLINKER 0x7     <span class="hljs-comment">/* dynamic link editor */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_BUNDLE   0x8     <span class="hljs-comment">/* dynamically bound bundle file */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_DYLIB_STUB   0x9     <span class="hljs-comment">/* shared library stub for static */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_DSYM     0xa     <span class="hljs-comment">/* companion file with only debug */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_KEXT_BUNDLE  0xb     <span class="hljs-comment">/* x86_64 kexts */</span></span><br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šncmds<br></code></pre></td></tr></table></figure><p>æŒ‡çš„æ˜¯åŠ è½½å‘½ä»¤(Load Commands)çš„æ•°é‡ï¼Œå¦‚ä¸Šé¢#ç¤ºä¾‹1ä¸­ a.out æ–‡ä»¶çš„ ncmds æ˜¯ 15 ä¸ªï¼Œç¼–å·ä¸º 0-14ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šsizeofcmds<br></code></pre></td></tr></table></figure><p>è¡¨ç¤º N ä¸ª Load Commands çš„æ€»å­—èŠ‚å¤§å°ï¼Œ Load Commands åŒºåŸŸæ˜¯ç´§æ¥ç€ Header åŒºåŸŸçš„ã€‚</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">å‚æ•°ï¼š<span class="hljs-keyword">flags</span><br></code></pre></td></tr></table></figure><p>æ ‡å¿—ä½ï¼Œå…·ä½“æšä¸¾å€¼å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_NOUNDEFS  0x1 <span class="hljs-comment">//ç›®å‰æ²¡æœ‰æœªå®šä¹‰çš„ç¬¦å·ï¼Œä¸å­˜åœ¨é“¾æ¥ä¾èµ–</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_DYLDLINK  0x4 <span class="hljs-comment">//è¯¥æ–‡ä»¶æ˜¯dyldçš„è¾“å…¥æ–‡ä»¶ï¼Œæ— æ³•è¢«å†æ¬¡é™æ€é“¾æ¥</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_PIE 0x200000  <span class="hljs-comment">//åŠ è½½ç¨‹åºåœ¨éšæœºåœ°å€ç©ºé—´ï¼ˆASLRï¼‰ï¼Œåªåœ¨ MH_EXECUTEä¸­ä½¿ç”¨</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MH_TWOLEVEL 0x80 <span class="hljs-comment">// ä¸¤çº§åç§°ç©ºé—´</span></span><br>...<br></code></pre></td></tr></table></figure><h3 id="2-2-Load-commands"><a href="#2-2-Load-commands" class="headerlink" title="##2.2. Load commands"></a>##2.2. Load commands</h3><p>Load commands è·Ÿåœ¨ Header éƒ¨åˆ†çš„åé¢ï¼Œè¿™äº›åŠ è½½æŒ‡ä»¤è´Ÿè´£åœ¨ Mach-O æ–‡ä»¶åŠ è½½è§£ææ—¶å‘Šè¯‰åŠ è½½å™¨å¦‚ä½•å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼šæœ‰äº›å‘½ä»¤æ˜¯ç”±å†…æ ¸å¤„ç†çš„ï¼Œæœ‰äº›æ˜¯ç”±åŠ¨æ€é“¾æ¥å™¨å¤„ç†çš„ï¼Œæœ€ç»ˆä¼šæ ¹æ® cmd å­—æ®µçš„ä¸åŒç±»å‹ï¼Œä½¿ç”¨ä¸åŒçš„å‡½æ•°æ¥åŠ è½½ã€‚</p><p>Load commands çš„ç»“æ„å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">load_command</span> &#123;<br>    <span class="hljs-type">uint32_t</span> cmd;       <span class="hljs-comment">/* type of load command */</span><br>    <span class="hljs-type">uint32_t</span> cmdsize;   <span class="hljs-comment">/* total size of command in bytes */</span><br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">å‚æ•°ï¼š<span class="hljs-keyword">cmd</span><br></code></pre></td></tr></table></figure><p>ä»£è¡¨ Load commands çš„ç±»å‹ï¼Œå¦‚ LC_SEGMENT_64ã€LC_UUIDã€LC-CODE-SIGNATURE ç­‰ç­‰ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šcmdsize<br></code></pre></td></tr></table></figure><p>ä»£è¡¨ Load commands çš„å¤§å°ã€‚</p><p>ä¸‹é¢åˆ—ä¸¾å‡ ä¸ªçœ‹ä¸Šå»æ¯”è¾ƒç†Ÿæ‚‰çš„ Load commandsâ€¦</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// å°†æ–‡ä»¶çš„32ä½ æˆ– 64ä½çš„æ®µæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LC_SEGMENT  0x1 </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LC_SEGMENT_64   0x19    </span><br><br><span class="hljs-comment">// å”¯ä¸€çš„ UUIDï¼Œæ ‡ç¤ºäºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LC_UUID  0x1b    <span class="hljs-comment">/* the uuid */</span></span><br><br><span class="hljs-comment">// å¯åŠ¨åŠ¨æ€åŠ è½½è¿æ¥å™¨</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LC_LOAD_DYLINKER 0xe <span class="hljs-comment">/* load a dynamic linker */</span></span><br><br><span class="hljs-comment">// ä»£ç ç­¾åå’ŒåŠ å¯†</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LC_CODE_SIGNATURE 0x1d   <span class="hljs-comment">/* local of code signature */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LC_ENCRYPTION_INFO 0x21 <span class="hljs-comment">/* encrypted segment information */</span></span><br></code></pre></td></tr></table></figure><p>ä»¥ LC_SEGMENT_64 ç±»å‹ä¸ºä¾‹ï¼Œå®ƒä»£è¡¨å°†æ–‡ä»¶ä¸­64ä½çš„æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚å®ƒçš„ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">segment_command_64</span> &#123; <span class="hljs-comment">/* for 64-bit architectures */</span><br>    <span class="hljs-type">uint32_t</span>    cmd;        <span class="hljs-comment">/* LC_SEGMENT_64 */</span><br>    <span class="hljs-type">uint32_t</span>    cmdsize;    <span class="hljs-comment">/* includes sizeof section_64 structs */</span><br>    <span class="hljs-type">char</span>        segname[<span class="hljs-number">16</span>];    <span class="hljs-comment">/* segment name */</span><br>    <span class="hljs-type">uint64_t</span>    vmaddr;     <span class="hljs-comment">/* memory address of this segment */</span><br>    <span class="hljs-type">uint64_t</span>    vmsize;     <span class="hljs-comment">/* memory size of this segment */</span><br>    <span class="hljs-type">uint64_t</span>    fileoff;    <span class="hljs-comment">/* file offset of this segment */</span><br>    <span class="hljs-type">uint64_t</span>    filesize;   <span class="hljs-comment">/* amount to map from the file */</span><br>    <span class="hljs-type">vm_prot_t</span>   maxprot;    <span class="hljs-comment">/* maximum VM protection */</span><br>    <span class="hljs-type">vm_prot_t</span>   initprot;   <span class="hljs-comment">/* initial VM protection */</span><br>    <span class="hljs-type">uint32_t</span>    nsects;     <span class="hljs-comment">/* number of sections in segment */</span><br>    <span class="hljs-type">uint32_t</span>    flags;      <span class="hljs-comment">/* flags */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢è§£é‡Šä¸€ä¸‹å„å‚æ•°çš„ä½œç”¨ã€‚ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šsegname<br></code></pre></td></tr></table></figure><p>æ®µçš„åç§°ï¼Œä¸‹é¢çš„##2.3å°ç»“ä¸­æœ‰æ›´è¯¦ç»†çš„ä»‹ç»ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼švmaddr<br></code></pre></td></tr></table></figure><p>æ®µçš„è™šæ‹Ÿå†…å­˜åœ°å€ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼švmsize<br></code></pre></td></tr></table></figure><p>æ®µçš„è™šæ‹Ÿå†…å­˜å¤§å°</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šfileoff<br></code></pre></td></tr></table></figure><p>æ®µåœ¨æ–‡ä»¶ä¸­åç§»é‡ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šfilesize<br></code></pre></td></tr></table></figure><p>æ®µåœ¨æ–‡ä»¶ä¸­çš„å¤§å°ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šnsects<br></code></pre></td></tr></table></figure><p>æ®µä¸­æœ‰å¤šå°‘ secetionã€‚</p><p>ä»¥ä¸Šé¢ <strong>#ç¤ºä¾‹1</strong> ä¸­çš„ Load command 0 ä¸ºä¾‹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Load</span> command <span class="hljs-number">0</span><br>      <span class="hljs-attribute">cmd</span> LC_SEGMENT_64<br>  <span class="hljs-attribute">cmdsize</span> <span class="hljs-number">72</span><br>  <span class="hljs-attribute">segname</span> __PAGEZERO<br>   <span class="hljs-attribute">vmaddr</span> <span class="hljs-number">0</span>x0000000000000000<br>   <span class="hljs-attribute">vmsize</span> <span class="hljs-number">0</span>x0000000100000000<br>  <span class="hljs-attribute">fileoff</span> <span class="hljs-number">0</span><br> <span class="hljs-attribute">filesize</span> <span class="hljs-number">0</span><br>  <span class="hljs-attribute">maxprot</span> <span class="hljs-number">0</span>x00000000<br> <span class="hljs-attribute">initprot</span> <span class="hljs-number">0</span>x00000000<br>   <span class="hljs-attribute">nsects</span> <span class="hljs-number">0</span><br>    <span class="hljs-attribute">flags</span> <span class="hljs-number">0</span>x0<br></code></pre></td></tr></table></figure><p>å®ƒå°±æ˜¯å‘Šè¯‰åŠ è½½å™¨å°†è¯¥æ®µæ–‡ä»¶çš„å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ï¼šä» fileoff å¤„åŠ è½½ filesize å¤§å°åˆ°è™šæ‹Ÿå†…å­˜ vmaddr å¤„ã€‚ç”±äºè¿™é‡Œåœ¨å†…å­˜åœ°å€ç©ºé—´ä¸­æ˜¯ _PAGEZERO æ®µï¼ˆè¿™ä¸ªæ®µä¸å…·æœ‰è®¿é—®æƒé™ï¼Œç”¨æ¥å¤„ç†ç©ºæŒ‡é’ˆï¼‰æ‰€ä»¥å„å‚æ•°éƒ½æ˜¯é›¶ã€‚</p><h3 id="2-3-Segmentsï¼ˆæ®µæ•°æ®ï¼‰"><a href="#2-3-Segmentsï¼ˆæ®µæ•°æ®ï¼‰" class="headerlink" title="##2.3. Segmentsï¼ˆæ®µæ•°æ®ï¼‰"></a>##2.3. Segmentsï¼ˆæ®µæ•°æ®ï¼‰</h3><p>Segments åŒ…å«äº†å¾ˆå¤š segmentï¼Œæ¯ä¸€ä¸ª segment å®šä¹‰äº†ä¸€äº› Mach-O æ–‡ä»¶çš„æ•°æ®ã€åœ°å€å’Œå†…å­˜ä¿æŠ¤å±æ€§ï¼Œè¿™äº›æ•°æ®åœ¨åŠ¨æ€é“¾æ¥å™¨åŠ è½½ç¨‹åºæ—¶è¢«æ˜ å°„åˆ°äº†è™šæ‹Ÿå†…å­˜ä¸­ã€‚æ¯ä¸ªæ®µéƒ½æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œä¸€èˆ¬åŒ…æ‹¬ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__PAGEZERO</span><br></code></pre></td></tr></table></figure><p>ç©ºæŒ‡é’ˆé™·é˜±æ®µï¼Œæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ç¬¬ä¸€é¡µï¼Œç”¨äºæ•æ‰å¯¹NULLæŒ‡é’ˆçš„å¼•ç”¨ï¼›</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs excel">__<span class="hljs-built_in">TEXT</span><br></code></pre></td></tr></table></figure><p>åŒ…å«äº†æ‰§è¡Œä»£ç ä»¥åŠå…¶ä»–åªè¯»æ•°æ®ã€‚ ä¸ºäº†è®©å†…æ ¸å°†å®ƒç›´æ¥ä»å¯æ‰§è¡Œæ–‡ä»¶æ˜ å°„åˆ°å…±äº«å†…å­˜ï¼Œ é™æ€è¿æ¥å™¨è®¾ç½®è¯¥æ®µçš„è™šæ‹Ÿå†…å­˜æƒé™ä¸ºä¸å…è®¸å†™ã€‚å½“è¿™ä¸ªæ®µè¢«æ˜ å°„åˆ°å†…å­˜åå¯ä»¥è¢«æ‰€æœ‰è¿›ç¨‹å…±äº«ï¼ˆè¿™ä¸»è¦ç”¨åœ¨ Frameworksã€ Bundleså’Œå…±äº«åº“ç­‰ç¨‹åºä¸­ï¼Œä¹Ÿå¯ä»¥ä¸ºåŒä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„å¤šä¸ªè¿›ç¨‹æ‹·è´ä½¿ç”¨ï¼‰ã€‚</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__DATA</span><br></code></pre></td></tr></table></figure><p>åŒ…å«äº†ç¨‹åºæ•°æ®ï¼Œè¯¥æ®µå¯å†™ï¼›</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__OBJC</span><br></code></pre></td></tr></table></figure><p>Objective-Cè¿è¡Œæ—¶æ”¯æŒåº“ï¼›</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__LINKEDIT</span><br></code></pre></td></tr></table></figure><p>å«æœ‰ä¸ºåŠ¨æ€é“¾æ¥åº“ä½¿ç”¨çš„åŸå§‹æ•°æ®ï¼Œæ¯”å¦‚ç¬¦å·ï¼Œå­—ç¬¦ä¸²ï¼Œé‡å®šä½è¡¨æ¡ç›®ç­‰ç­‰ã€‚</p><h3 id="2-4-sectionï¼ˆåŒºæ•°æ®ï¼‰"><a href="#2-4-sectionï¼ˆåŒºæ•°æ®ï¼‰" class="headerlink" title="##2.4. sectionï¼ˆåŒºæ•°æ®ï¼‰"></a>##2.4. sectionï¼ˆåŒºæ•°æ®ï¼‰</h3><p>ä¸€èˆ¬æ®µåˆä¼šæŒ‰ä¸åŒçš„åŠŸèƒ½åˆ’åˆ†ä¸ºå‡ ä¸ªåŒºï¼ˆsectionï¼‰ã€‚åŒºçš„å­—æ¯ä¸ºå°å†™ï¼ŒåŒæ ·åŠ ä¸¤ä¸ªä¸‹åˆ’çº¿ä½œä¸ºå‰ç¼€ã€‚ä¸‹é¢åˆ—å‡ºæ®µä¸­å¯èƒ½åŒ…å«çš„ sectionï¼š</p><ul><li>__TEXTæ®µ</li></ul><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__text</span>, <span class="hljs-variable">__cstring</span>, <span class="hljs-variable">__picsymbol_stub</span>, <span class="hljs-variable">__symbol_stub</span>, <span class="hljs-variable">__const</span>, <span class="hljs-variable">__litera14</span>, <span class="hljs-variable">__litera18</span>;<br></code></pre></td></tr></table></figure><ul><li>__DATAæ®µ</li></ul><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__data</span>, <span class="hljs-variable">__la_symbol_ptr</span>, <span class="hljs-variable">__nl_symbol_ptr</span>, <span class="hljs-variable">__dyld</span>, <span class="hljs-variable">__const</span>, <br><span class="hljs-variable">__mod_init_func</span>, <span class="hljs-variable">__mod_term_func</span>, <span class="hljs-variable">__bss</span>, <span class="hljs-variable">__commom</span>;<br></code></pre></td></tr></table></figure><ul><li>__IMPORTæ®µ</li></ul><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__jump_table</span>, <span class="hljs-variable">__pointers</span>;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ __TEXT æ®µä¸­çš„ __text æ˜¯å®é™…ä¸Šçš„ä»£ç éƒ¨åˆ†ï¼›__DATA æ®µçš„ __data æ˜¯å®é™…çš„åˆå§‹æ•°æ®ã€‚</p><p>section çš„æ•°æ®ç»“æ„ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">section</span> &#123; <span class="hljs-comment">/* for 32-bit architectures */</span><br>    <span class="hljs-type">char</span>        sectname[<span class="hljs-number">16</span>];   <span class="hljs-comment">/* name of this section */</span><br>    <span class="hljs-type">char</span>        segname[<span class="hljs-number">16</span>];    <span class="hljs-comment">/* segment this section goes in */</span><br>    <span class="hljs-type">uint32_t</span>    addr;       <span class="hljs-comment">/* memory address of this section */</span><br>    <span class="hljs-type">uint32_t</span>    size;       <span class="hljs-comment">/* size in bytes of this section */</span><br>    <span class="hljs-type">uint32_t</span>    offset;     <span class="hljs-comment">/* file offset of this section */</span><br>    <span class="hljs-type">uint32_t</span>    align;      <span class="hljs-comment">/* section alignment (power of 2) */</span><br>    <span class="hljs-type">uint32_t</span>    reloff;     <span class="hljs-comment">/* file offset of relocation entries */</span><br>    <span class="hljs-type">uint32_t</span>    nreloc;     <span class="hljs-comment">/* number of relocation entries */</span><br>    <span class="hljs-type">uint32_t</span>    flags;      <span class="hljs-comment">/* flags (section type and attributes)*/</span><br>    <span class="hljs-type">uint32_t</span>    reserved1;  <span class="hljs-comment">/* reserved (for offset or index) */</span><br>    <span class="hljs-type">uint32_t</span>    reserved2;  <span class="hljs-comment">/* reserved (for count or sizeof) */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­éƒ¨åˆ†å‚æ•°çš„ä»‹ç»:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šsectname<br></code></pre></td></tr></table></figure><p>section çš„åå­—ï¼Œå¦‚ä¸Šé¢æåˆ°çš„ __textã€__cstringç­‰ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">å‚æ•°ï¼šsegname<br></code></pre></td></tr></table></figure><p>section æ‰€å±çš„ segmentï¼Œæ¯”å¦‚ __TEXTã€‚</p><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nim">å‚æ•°ï¼š<span class="hljs-keyword">addr</span><br></code></pre></td></tr></table></figure><p>section åœ¨å†…å­˜çš„èµ·å§‹ä½ç½®ã€‚</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">å‚æ•°ï¼šsize<br></code></pre></td></tr></table></figure><p>section çš„å¤§å°ã€‚</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">å‚æ•°ï¼š<span class="hljs-built_in">offset</span><br></code></pre></td></tr></table></figure><p>section çš„æ–‡ä»¶åç§»é‡ã€‚</p><p>#ç¤ºä¾‹2ï¼šé€šè¿‡ otool â€“sæŸ¥çœ‹æŸä¸ª section çš„ä¿¡æ¯</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tap">$ otool -s __TEXT __text a.out<br>a.out:<br>Contents of (__TEXT,__text) section<br>0000000100000f50 <span class="hljs-number"> 55 </span>48<span class="hljs-number"> 89 </span>e5<span class="hljs-number"> 48 </span>83 ec<span class="hljs-number"> 20 </span>48 8d<span class="hljs-number"> 05 </span>47<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>c7 <br>0000000100000f60 <span class="hljs-number"> 45 </span>fc<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 89 </span>7d f8<span class="hljs-number"> 48 </span>89<span class="hljs-number"> 75 </span>f0<span class="hljs-number"> 48 </span>89 c7 <br>0000000100000f70  b0<span class="hljs-number"> 00 </span>e8 0d<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span>31 c9<span class="hljs-number"> 89 </span>45 ec<span class="hljs-number"> 89 </span>c8<span class="hljs-number"> 48 </span>83 <br>0000000100000f80  c4<span class="hljs-number"> 20 </span>5d c3 <br></code></pre></td></tr></table></figure><p>ç”±äº-s __TEXT __text å¾ˆå¸¸è§ï¼Œotool å¯¹å…¶è®¾ç½®äº†ä¸€ä¸ªç¼©å†™ -t ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ·»åŠ  -v æ¥æŸ¥çœ‹åæ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs llvm">$ otool -t -v a.out<br>a.out:<br>(__TEXT<span class="hljs-punctuation">,</span>__text) <span class="hljs-keyword">section</span><br>_main:<br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">50</span>  pushq <span class="hljs-variable">%rbp</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">51</span>  movq  <span class="hljs-variable">%rsp</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rbp</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">54</span>  subq  $<span class="hljs-number">0x20</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rsp</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">58</span>  leaq  <span class="hljs-number">0x47</span>(<span class="hljs-variable">%rip</span>)<span class="hljs-punctuation">,</span> <span class="hljs-variable">%rax</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">5</span>f  movl  $<span class="hljs-number">0x0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">4</span>(<span class="hljs-variable">%rbp</span>)<br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">66</span>  movl  <span class="hljs-variable">%edi</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">8</span>(<span class="hljs-variable">%rbp</span>)<br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">69</span>  movq  <span class="hljs-variable">%rsi</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">10</span>(<span class="hljs-variable">%rbp</span>)<br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">6</span>d  movq  <span class="hljs-variable">%rax</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rdi</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">70</span>  movb  $<span class="hljs-number">0x0</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%al</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">72</span>  callq <span class="hljs-number">0x100000f84</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">77</span>  xorl  <span class="hljs-variable">%ecx</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%ecx</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">79</span>  movl  <span class="hljs-variable">%eax</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">14</span>(<span class="hljs-variable">%rbp</span>)<br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">7</span><span class="hljs-keyword">c</span>  movl  <span class="hljs-variable">%ecx</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%eax</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">7</span>e  addq  $<span class="hljs-number">0x20</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rsp</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">82</span>  popq  <span class="hljs-variable">%rbp</span><br><span class="hljs-number">0000000100000</span>f<span class="hljs-number">83</span>  retq<br></code></pre></td></tr></table></figure><hr><h2 id="3-Mach-O-amp-èƒ–æ–‡ä»¶"><a href="#3-Mach-O-amp-èƒ–æ–‡ä»¶" class="headerlink" title="#3 Mach-O &amp; èƒ–æ–‡ä»¶"></a>#3 Mach-O &amp; èƒ–æ–‡ä»¶</h2><p>OS X æœ‰ä¸¤ç§ç±»å‹çš„ç›®æ ‡æ–‡ä»¶ï¼šMach-O å’Œ <strong>universal binary</strong> ï¼Œåè€…å°±æ˜¯é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå«èƒ–æ–‡ä»¶ã€‚åŒºåˆ«åœ¨äºï¼š</p><ul><li><p>Mach-O æ–‡ä»¶åªåŒ…å«ä¸€ç§æ¶æ„ï¼ˆi386ã€x86_64ã€arm64 ç­‰ç­‰ï¼‰çš„å¯¹è±¡ä»£ç ï¼›</p></li><li><p>èƒ–æ–‡ä»¶å¯èƒ½åŒæ—¶åŒ…å«è‹¥å¹²â€œåŒ…å«ä¸åŒæ¶æ„ï¼ˆi386ã€armã€arm64 ç­‰ç­‰ï¼‰å¯¹è±¡ä»£ç â€çš„å¯¹è±¡æ–‡ä»¶ã€‚</p></li></ul><p>å®é™…ä¸Š universal binary æ–‡ä»¶åªä¸è¿‡æ˜¯å°†æ”¯æŒä¸åŒæ¶æ„çš„ Mach-O æ–‡ä»¶æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå†åœ¨æ–‡ä»¶èµ·å§‹ä½ç½®åŠ ä¸Š fat_header æ¥è¯´æ˜æ‰€åŒ…å«çš„ Mach-O æ–‡ä»¶æ”¯æŒçš„æ¶æ„å’Œåç§»åœ°å€ä¿¡æ¯ã€‚</p><p>èƒ–æ–‡ä»¶çš„ç»“æ„ï¸°</p><table><thead><tr><th align="center">fat_header</th></tr></thead><tbody><tr><td align="center">fat_arch</td></tr><tr><td align="center">fat_arch</td></tr><tr><td align="center">ã€‚ã€‚ã€‚</td></tr></tbody></table><p>å…¶ä¸­ fat_header çš„æ•°æ®ç»“æ„åœ¨ mach-o/fat.h å¤´æ–‡ä»¶ä¸Šå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">define</span> FAT_MAGIC   0xcafebabe</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FAT_CIGAM  0xbebafeca  <span class="hljs-comment">/* NXSwapLong(FAT_MAGIC) */</span></span><br> <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fat_header</span> &#123;<br>    <span class="hljs-type">uint32_t</span>    magic;        <span class="hljs-comment">/* FAT_MAGIC */</span><br>    <span class="hljs-type">uint32_t</span>    nfat_arch;    <span class="hljs-comment">/* number of structs that follow */</span><br>&#125;;<br> <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fat_arch</span> &#123;<br>    <span class="hljs-type">cpu_type_t</span>  cputype;  <span class="hljs-comment">/* cpu specifier (int) */</span><br>    <span class="hljs-type">cpu_subtype_t</span>   cpusubtype;   <span class="hljs-comment">/* machine specifier (int) */</span><br>    <span class="hljs-type">uint32_t</span>    offset;       <span class="hljs-comment">/* file offset to this object file */</span><br>    <span class="hljs-type">uint32_t</span>    size;     <span class="hljs-comment">/* size of this object file */</span><br>    <span class="hljs-type">uint32_t</span>    align;        <span class="hljs-comment">/* alignment as a power of 2 */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜:</p><ul><li>magicå­—æ®µ</li></ul><p>å°±æ˜¯ä¸Šé¢è¯´çš„é­”æ•°ï¼ŒåŠ è½½å™¨é€šè¿‡è¿™ä¸ªé­”æ•°å€¼æ¥åˆ¤æ–­è¿™æ˜¯ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Œèƒ–äºŒè¿›åˆ¶æ–‡ä»¶çš„é­”æ•°å€¼æ˜¯0xcafebabeï¼›</p><ul><li>nfat_archå­—æ®µ</li></ul><p>æ˜¯æŒ‡å½“å‰çš„èƒ–äºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«äº†å¤šå°‘ä¸ªä¸åŒæ¶æ„çš„ Mach-O æ–‡ä»¶ã€‚æœ‰å¤šå°‘ä¸ªä¸åŒæ¶æ„çš„ Mach-O æ–‡ä»¶ï¼Œå°±æœ‰å¤šå°‘ä¸ª fat_archï¼Œç”¨äºè¯´æ˜å¯¹åº” Mach-O æ–‡ä»¶å¤§å°ã€æ”¯æŒçš„CPUæ¶æ„ã€åç§»åœ°å€ç­‰ï¼›</p><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œxxx.app&#x2F;xxx æ–‡ä»¶å¹¶ä¸æ˜¯ Mach-O æ ¼å¼æ–‡ä»¶ï¼Œç”±äºç°åœ¨éœ€è¦æ”¯æŒä¸åŒ CPU æ¶æ„çš„ iOS è®¾å¤‡ï¼Œæˆ‘ä»¬ç¼–è¯‘æ‰“åŒ…å‡ºæ¥çš„æ‰§è¡Œæ–‡ä»¶ä¸€èˆ¬éƒ½æ˜¯èƒ–æ–‡ä»¶ã€‚å½“ç„¶ï¼Œæ”¯æŒçš„æ¶æ„è¶Šå¤šï¼Œæœ€ç»ˆæ‰“å‡ºæ¥çš„åŒ…å°±ä¼šè¶Šå¤§ï¼Œæ‰€ä»¥é¡¹ç›®é‡Œçš„ Architectures å’Œ Valid Architectures é€‰é¡¹è¦æ ¹æ®éœ€æ±‚æ¥é…ç½®å“Ÿã€‚</p><p>#ç¤ºä¾‹3ï¼šWeChat.app&#x2F;WeChat æ–‡ä»¶çš„ä¿¡æ¯</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">$ <span class="hljs-keyword">file</span> WeChat<br>WeChat: Mach-O universal binary <span class="hljs-keyword">with</span> <span class="hljs-number">2</span> architectures: <br>[arm_v7:Mach-O executable arm_v7] [arm64]<br>WeChat (<span class="hljs-keyword">for</span> <span class="hljs-keyword">architecture</span> armv7):  Mach-O executable arm_v7<br>WeChat (<span class="hljs-keyword">for</span> <span class="hljs-keyword">architecture</span> arm64):  Mach-O <span class="hljs-number">64</span>-<span class="hljs-built_in">bit</span> executable arm64<br></code></pre></td></tr></table></figure><p>æœ€åï¼Œäº†è§£ Mach-O æ–‡ä»¶å¯¹äºä½¿ç”¨ dSYM è§£æå´©æºƒæ—¥å¿—ã€é€†å‘å·¥ç¨‹ã€bitcodeã€åº”ç”¨ç˜¦èº«ç­‰ä¼šæœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼æ›´å¤šç›¸å…³çš„å†…å®¹ä¹‹åç»§ç»­æ…¢æ…¢ç ”ç©¶ã€‚ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/videos/play/wwdc2016/406/?time=90">Â©WWDC 2016</a></p><p>#<a href="http://wiki.jikexueyuan.com/project/objc/Build-tool/6-3.html">Â©æå®¢å­¦é™¢</a></p><p>#<a href="https://www.jianshu.com/p/bcc7ba20f900">Â©ç®€ä¹¦1</a></p><p>#<a href="https://www.jianshu.com/p/54d842db3f69">Â©ç®€ä¹¦2</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é€†å‘å·¥ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ipa é‡æ–°ç­¾å</title>
    <link href="/2019/03/15/resign.html"/>
    <url>/2019/03/15/resign.html</url>
    
    <content type="html"><![CDATA[<h2 id="1ã€éœ€æ±‚ï¼š"><a href="#1ã€éœ€æ±‚ï¼š" class="headerlink" title="1ã€éœ€æ±‚ï¼š"></a>1ã€éœ€æ±‚ï¼š</h2><ul><li>éä¼ä¸šè¯ä¹¦ç­¾åçš„ <code>ipa</code> æƒ³è¦åœ¨ä¼ä¸šå†…åˆ†å‘ã€‚</li><li>å¯¹å•†åº—ä¸­ä¸‹è½½çš„åº”ç”¨ç ¸å£³å¹¶ä¿®æ”¹å†…å®¹åï¼Œå¸Œæœ›é‡æ–°æ‰“åŒ…å¹¶å®‰è£…åˆ°æ‰‹æœºä¸Šï¼›</li></ul><p>è¿™äº›éƒ½éœ€è¦å¯¹<code>ipa</code>é‡æ–°ç­¾å~</p><h2 id="2ã€åŸç†"><a href="#2ã€åŸç†" class="headerlink" title="2ã€åŸç†"></a>2ã€åŸç†</h2><p>ç§»é™¤åŸæœ‰ç­¾åï¼Œé€šè¿‡<code>codesign</code>å·¥å…·å¯¹åŸ ipa ä½¿ç”¨æ–°è¯ä¹¦é‡æ–°ç­¾åå¹¶å¾—åˆ°æ–°çš„å®‰è£…åŒ…ã€‚</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs inform7">$ codesign<br>Usage: codesign -s identity <span class="hljs-comment">[-fv*]</span> <span class="hljs-comment">[-o flags]</span> <span class="hljs-comment">[-r reqs]</span> <span class="hljs-comment">[-i ident]</span> path ... # sign<br>       codesign -v <span class="hljs-comment">[-v*]</span> <span class="hljs-comment">[-R=&lt;req string&gt;|-R &lt;req file path&gt;]</span> path|<span class="hljs-comment">[+]</span>pid ... # verify<br>       codesign -d <span class="hljs-comment">[options]</span> path ... # display contents<br>       codesign -h pid ... # display hosting paths<br></code></pre></td></tr></table></figure><h2 id="3ã€æµç¨‹"><a href="#3ã€æµç¨‹" class="headerlink" title="3ã€æµç¨‹"></a>3ã€æµç¨‹</h2><h3 id="3-1-å‡†å¤‡å·¥ä½œï¼š"><a href="#3-1-å‡†å¤‡å·¥ä½œï¼š" class="headerlink" title="3.1.å‡†å¤‡å·¥ä½œï¼š"></a>3.1.å‡†å¤‡å·¥ä½œï¼š</h3><ul><li>è§£å‹ipa</li></ul><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>unzip xx.ipa<br></code></pre></td></tr></table></figure><ul><li>æ‰¾åˆ°å¼€å‘è€…è¯ä¹¦</li></ul><p>è¯ä¹¦å¯ä»¥åœ¨é’¥åŒ™ä¸²ä¸­æŸ¥æ‰¾ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¡Œæ¥æŸ¥æ‰¾ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">$ <span class="hljs-keyword">security</span> find-<span class="hljs-keyword">identity</span> -p codesigning -v<br></code></pre></td></tr></table></figure><ul><li>æ‰¾åˆ°å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶å¹¶å¤åˆ¶åˆ°<code>xx.app</code>æ–‡ä»¶å¤¹ä¸‹</li></ul><p>å¦‚æœæ˜¯è‡ªå·±çš„ ipa é‚£ä¹ˆè¿™ä¸ª<code>.mobileprovision</code>æ–‡ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨ç°æˆçš„ï¼Œä»<code>Xcode-&gt;è´¦æˆ·</code>ä¸­æ‰¾åˆ°ï¼Œshow in finder åå¤åˆ¶ä¸€ä»½é‡å‘½åä¸º<code>embedded.mobileprovision</code>ï¼Œæ‹–åˆ°<code>.app</code>æ–‡ä»¶å¤¹ä¸‹å³å¯<br><br/></p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œæ“ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cp</span> xx.mobileprovision Payload/xx.app/embedded.mobileprovision</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå¤åˆ¶åˆ°<code>xx.app</code>ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ä¸€å®šè¦å‘½åä¸º<code>embedded.mobileprovision</code>ï¼</p><ul><li>ä¿®æ”¹åŒ…çš„ Bundle Identifier</li></ul><p>å¦‚æœæ˜¯åˆ«äººçš„ ipa é‚£ä¹ˆå°±è¦éœ€è¦ä¿®æ”¹åŸå®‰è£…åŒ…çš„<code>info.plist</code>ä¸­çš„<code>Bundle identifier</code>ï¼Œä½¿å…¶ä¸é…ç½®æ–‡ä»¶ä¸­çš„<code>Bundle Identifier</code>ä¿æŒä¸€è‡´ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ <span class="hljs-regexp">/usr/</span>libexec<span class="hljs-regexp">/PlistBuddy -c &quot;Set :CFBundleIdentifier com.xx.xx&quot; Payload/</span>xx.app/Info.plist<br></code></pre></td></tr></table></figure><ul><li>ç”Ÿæˆæ–°çš„ entitlements.plist</li></ul><p><a href="https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/AboutEntitlements.html">Entitlements</a> æ˜¯åº”ç”¨åŠŸèƒ½å’Œæˆæƒç›¸å…³çš„æ–‡ä»¶ï¼Œæ¶‰åŠåˆ°iCloudã€æ¨é€ç­‰åŠŸèƒ½çš„é…ç½®ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶é‡æ–°ç”Ÿæˆä¸€ä»½ï¼Œåé¢ç­¾åè¦ç”¨åˆ°ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">$ security cms -D -<span class="hljs-selector-tag">i</span> xx<span class="hljs-selector-class">.mobileprovision</span> &gt; profile.plist<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä¼šç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ plistï¼Œæˆ‘ä»¬åªéœ€è¦é‡Œé¢çš„<code>Entitlements</code>å­—æ®µï¼Œæ‰§è¡Œå‘½ä»¤è¡Œï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ <span class="hljs-regexp">/usr/</span>libexec/PlistBuddy -x -c <span class="hljs-string">&#x27;Print :Entitlements&#x27;</span> profile.plist &gt; entitlements.plist<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹:</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_entitleplist.png" alt="plist"></p><ul><li>ç§»é™¤ä¹‹å‰çš„ç­¾åæ–‡ä»¶å¤¹ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">rm</span> -rf Payload/xx.app/_CodeSignature</span><br></code></pre></td></tr></table></figure><h3 id="3-2-é‡æ–°ç­¾åï¼š"><a href="#3-2-é‡æ–°ç­¾åï¼š" class="headerlink" title="3.2.é‡æ–°ç­¾åï¼š"></a>3.2.é‡æ–°ç­¾åï¼š</h3><p>é‡æ–°ç­¾åæœ‰é¡ºåºï¼Œå…ˆæŠŠ<code>framework</code>å’Œ<code>dylib</code>ç­¾åï¼Œæœ€åå†ç­¾å<code>xx.app/xx</code>ï¼Œé¡ºåºå¼„é”™äº†ï¼Œå°±ç®—ç­¾åæˆåŠŸä¹Ÿå¯èƒ½ä¼šå®‰è£…å¤±è´¥!</p><ul><li>é‡æ–°ç­¾åframeworkï¼š</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ codesign -f -s <span class="hljs-string">&quot;iPhone Distribution: xxxx (xx)&quot;</span> --entitlements entitlements.plist <span class="hljs-regexp">/Payload/</span>xx.app<span class="hljs-regexp">/Frameworks/yy</span>.framework<br></code></pre></td></tr></table></figure><ul><li>é‡æ–°ç­¾ååº”ç”¨çš„æ‰§è¡Œæ–‡ä»¶</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ codesign -f -s <span class="hljs-string">&quot;iPhone Distribution: xxxx (xx)&quot;</span> --entitlements entitlements.plist Payload<span class="hljs-regexp">/xx.app/</span>xx<br></code></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹åº”ç”¨ç­¾åä¿¡æ¯</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">codesign -vv -d Payload/xx.app</span><br></code></pre></td></tr></table></figure><h3 id="3-3-è°ƒè¯•"><a href="#3-3-è°ƒè¯•" class="headerlink" title="3.3.è°ƒè¯•"></a>3.3.è°ƒè¯•</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ios-deploy -d -b Payload/xx.app</span><br></code></pre></td></tr></table></figure><p>å‡ºç°<code>success</code>å­—æ ·ï¼Œå°±è¯´æ˜æˆåŠŸäº†~<br><br/></p><p>å¦‚æœé‡åˆ°é”™è¯¯æç¤ºï¼šâ€œError: There was an internal API error. AMDeviceSecureInstallApplication(0, device, url, options, install_callback, 0)â€,å°±å¯èƒ½å­˜åœ¨æœ‰ framework æˆ–è€… dylib æœªç­¾åçš„æƒ…å†µã€‚è¿™æ—¶å°±éœ€è¦æŠŠ app æ–‡ä»¶å¤¹ä¸‹çš„ framework å…¨éƒ½ç­¾åã€‚<br><br/></p><p>é‡æ–°æ‰“åŒ…ï¼Œç”Ÿæˆæ–°çš„ipa</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">$ zip -r <span class="hljs-keyword">new</span><span class="hljs-type"></span>.ipa Payload/<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡ iTunes æˆ–ç¬¬ä¸‰æ–¹å·¥å…·å®‰è£…åˆ°æ‰‹æœºäº†~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://www.jb51.net/article/132328.htm">Â©ä¼ é€é—¨</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é€†å‘å·¥ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>App çš„å¯åŠ¨è¿‡ç¨‹</title>
    <link href="/2019/02/25/launch.html"/>
    <url>/2019/02/25/launch.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æ–‡ç« æ•´ç†è‡ª <a href="https://techblog.toutiao.com/2017/01/17/iosspeed/">å¤´æ¡æŠ€æœ¯</a> å’Œ <a href="https://www.jianshu.com/p/43db6b0aab8e">DevilH</a> ç­‰çš„åšå®¢ï¼Œå…·ä½“è¯·çœ‹æœ€åçš„å‚è€ƒé“¾æ¥ã€‚</p></blockquote><h2 id="å¯åŠ¨è¿‡ç¨‹åˆ†è§£"><a href="#å¯åŠ¨è¿‡ç¨‹åˆ†è§£" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹åˆ†è§£"></a>å¯åŠ¨è¿‡ç¨‹åˆ†è§£</h2><p>åº”ç”¨å¯åŠ¨çš„è¿‡ç¨‹å¯åˆ†ä¸ºä¸¤æ­¥ï¼š</p><blockquote><p><strong>t</strong>ï¼ˆæ€»ï¼‰&#x3D; <strong>t1</strong>ï¼ˆ<code>mainå‡½æ•°</code>ä¹‹å‰ï¼‰ + <strong>t2</strong>ï¼ˆ<code>mainå‡½æ•°</code>ä¹‹åï¼‰</p></blockquote><p><strong>t1</strong>ï¼šåŠ è½½ç³»ç»ŸåŠ¨æ€åº“å’Œåº”ç”¨å¯æ‰§è¡Œæ–‡ä»¶ï¼›</p><p><strong>t2</strong>ï¼šæ„å»ºç•Œé¢å¹¶å®Œæˆæ¸²æŸ“å’Œå±•ç¤ºï¼š<code>mainå‡½æ•°</code>åˆ°<code>-application:didFinishLaunchingWithOptions:</code>å›è°ƒæ‰§è¡Œç»“æŸï¼›</p><h3 id="1ã€main-å‡½æ•°ä¹‹å‰"><a href="#1ã€main-å‡½æ•°ä¹‹å‰" class="headerlink" title="#1ã€main å‡½æ•°ä¹‹å‰"></a>#1ã€main å‡½æ•°ä¹‹å‰</h3><p>mainå‡½æ•°ä¹‹å‰å¯åŠ¨è¿‡ç¨‹çš„ç®€å•æ€»ç»“ï¼š</p><ol><li>ç³»ç»Ÿå†…æ ¸<code>XNU</code>å…ˆè¯»å–åº”ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒåŠ è½½åŠ¨æ€é“¾æ¥å™¨<code>dyld</code>ï¼›</li><li>åŠ¨æ€é“¾æ¥å™¨åˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼Œå¼€å¯ç¼“å­˜ç­–ç•¥ï¼ŒåŠ è½½ç¨‹åºç›¸å…³ä¾èµ–åº“ï¼Œå¹¶å¯¹è¿™äº›åº“è¿›è¡Œé“¾æ¥ï¼›</li><li>æ¥ç€è°ƒç”¨æ¯ä¸ªä¾èµ–åº“çš„åˆå§‹åŒ–æ–¹æ³•ï¼ˆruntimeåœ¨è¿™ä¸€æ­¥è¢«åˆå§‹åŒ–ï¼‰ï¼›</li><li>å½“æ‰€æœ‰ä¾èµ–åº“åˆå§‹åŒ–å®Œæˆåï¼Œå†åˆå§‹åŒ–ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™æ—¶runtimeä¼šå¯¹é¡¹ç›®ä¸­æ‰€æœ‰ç±»è¿›è¡Œç±»ç»“æ„åˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨æ‰€æœ‰çš„<code>+load</code>æ–¹æ³•ï¼›</li><li>æœ€å<code>dyld</code>è¿”å›<code>mainå‡½æ•°</code>åœ°å€ï¼Œ<code>mainå‡½æ•°</code>è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬ä¾¿æ¥åˆ°äº†ç†Ÿæ‚‰çš„ç¨‹åºå…¥å£ã€‚</li></ol><h4 id="1-1-XUN-åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶"><a href="#1-1-XUN-åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶" class="headerlink" title="1.1.XUN åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶"></a>1.1.XUN åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶</h4><p>å¤§è‡´çš„è¿‡ç¨‹æ˜¯ï¼š</p><ul><li>å†…æ ¸å¯åŠ¨è¿›ç¨‹ç®¡ç†å™¨ï¼Œä¸ºæˆ‘ä»¬çš„åº”ç”¨åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼›</li><li>è°ƒç”¨<code>load_machfile()</code>å‡½æ•°åŠ è½½<code>Mach-O</code>ï¼Œè¿™é‡Œä¼šè®¾ç½®è™šæ‹Ÿå†…å­˜å¤§å°ã€è®¾ç½®<code>ASLR</code>éšæœºæ•°ï¼›<code>load_machfile()</code>å†…éƒ¨ç»§ç»­è°ƒç”¨<code>parse_machfile()</code>å‡½æ•°å¯¹<code>Mach-O</code>æ–‡ä»¶è¿›è¡Œæ·±åº¦è§£æã€‚</li><li><code>parse_machfile</code>å†…éƒ¨å…ˆå°†<code>Mach-O</code>æ–‡ä»¶çš„æ‰€æœ‰çš„åŠ è½½å‘½ä»¤<code>Load Commends</code>æ˜ å°„è¿›å†…æ ¸çš„å†…å­˜ä¸­ï¼Œç„¶ååˆ†ä¸‰è¶Ÿè§£æè¿™äº›åŠ è½½å‘½ä»¤ã€‚æˆ‘ä»¬åº”ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶å’Œ<code>dyld</code>éƒ½æ˜¯<code>Mach-O</code>æ–‡ä»¶ï¼Œæ‰€ä»¥<code>parse_machfile()</code>åœ¨è§£æå¯æ‰§è¡Œæ–‡ä»¶æ—¶ä¼šç»§ç»­è°ƒç”¨<code>load_dylinker()</code>æ¥å¤„ç†åŠ è½½å‘½ä»¤<code>LC_LOAD_DYLINKER</code>ã€‚</li><li><code>load_dylinker()</code>å‡½æ•°å†…é€’å½’è°ƒç”¨<code>parse_machfile()</code>è§£æ<code>dyld</code>ï¼Œè§£ææˆåŠŸå<code>dyld</code>å¼€å§‹åŠ è½½å…±äº«åº“ã€‚</li><li>è§£æå®Œå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ç±»å‹çš„<code>Mach-O</code>æ–‡ä»¶(å‡è®¾ä¸ºA)ä¹‹åï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°Açš„å…¥å£ç‚¹ï¼›ä½†çº¿ç¨‹å¹¶ä¸ç«‹åˆ»è¿›å…¥åˆ°è¿™ä¸ªå…¥å£ç‚¹ã€‚è¿™æ˜¯ç”±äºæˆ‘ä»¬è¿˜ä¼šåŠ è½½<code>dyld</code>ï¼Œåœ¨<code>load_dylinker()</code>ä¸­ï¼Œ<code>dyld</code>ä¼šä¿å­˜Açš„å…¥å£ç‚¹ï¼Œé€’å½’è°ƒç”¨<code>parse_machfile()</code>ä¹‹åï¼Œå°†çº¿ç¨‹çš„å…¥å£ç‚¹è®¾ä¸º<code>dyld</code>çš„å…¥å£ç‚¹ï¼›<code>dyld</code>å®ŒæˆåŠ è½½åº“çš„å·¥ä½œä¹‹åï¼Œå†å°†å…¥å£ç‚¹è®¾å›Açš„å…¥å£ç‚¹ï¼Œç¨‹åºå¯åŠ¨å®Œæˆã€‚</li></ul><h4 id="1-2-dyldçš„å·¥ä½œæµç¨‹"><a href="#1-2-dyldçš„å·¥ä½œæµç¨‹" class="headerlink" title="1.2.dyldçš„å·¥ä½œæµç¨‹"></a>1.2.dyldçš„å·¥ä½œæµç¨‹</h4><p>dyld åŠ è½½æˆåŠŸåä¼šæ¥ç®¡åç»­çš„å¯åŠ¨ä»»åŠ¡ï¼š</p><ol><li>load dylibs image è¯»å–åº“é•œåƒæ–‡ä»¶</li><li>Rebase image</li><li>Bind image</li><li>Objc setup</li><li>initializers</li></ol><p><strong>1.2.1.load dylibs image</strong><br><br/></p><p>dyldå°†å¯æ‰§è¡Œæ–‡ä»¶ä»¥åŠä¾èµ–çš„åº“é€’å½’åœ°åŠ è½½è¿›å†…å­˜ï¼Œç”Ÿæˆå¯¹åº”çš„é•œåƒå¯¹è±¡ï¼š</p><ol><li>åˆ†ææ‰€ä¾èµ–çš„åŠ¨æ€åº“</li><li>æ‰¾åˆ°åŠ¨æ€åº“çš„mach-oæ–‡ä»¶</li><li>æ‰“å¼€æ–‡ä»¶</li><li>éªŒè¯æ–‡ä»¶</li><li>åœ¨ç³»ç»Ÿæ ¸å¿ƒæ³¨å†Œæ–‡ä»¶ç­¾å</li><li>å¯¹åŠ¨æ€åº“çš„æ¯ä¸€ä¸ªsegmentè°ƒç”¨mmap()</li></ol><p>é’ˆå¯¹è¿™ä¸€æ­¥éª¤çš„ä¼˜åŒ–æœ‰ï¼š</p><ol><li>å‡å°‘éç³»ç»Ÿåº“çš„ä¾èµ–</li><li>åˆå¹¶éç³»ç»Ÿåº“</li><li>ä½¿ç”¨é™æ€èµ„æºï¼Œæ¯”å¦‚æŠŠä»£ç åŠ å…¥ä¸»ç¨‹åº</li></ol><p><strong>1.2.2.å¯¹é•œåƒè¿›è¡Œé“¾æ¥</strong><br><br/></p><p>å¯¹ä¸Šé¢ç”Ÿæˆçš„é•œåƒè¿›è¡Œé“¾æ¥ï¼Œä¸»è¦æ˜¯å¯¹é•œåƒè¿›è¡Œ<code>rebase/bind</code>ã€‚<br><br/></p><p>ç”±äºASLR(address space layout randomization)çš„å­˜åœ¨ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€é“¾æ¥åº“åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åŠ è½½åœ°å€æ¯æ¬¡å¯åŠ¨éƒ½ä¸å›ºå®šï¼Œæ‰€ä»¥éœ€è¦è¿™2æ­¥æ¥ä¿®å¤é•œåƒä¸­çš„èµ„æºæŒ‡é’ˆï¼Œæ¥æŒ‡å‘æ­£ç¡®çš„åœ°å€ã€‚rebaseä¿®å¤çš„æ˜¯æŒ‡å‘å½“å‰é•œåƒå†…éƒ¨çš„èµ„æºæŒ‡é’ˆï¼› è€ŒbindæŒ‡å‘çš„æ˜¯é•œåƒå¤–éƒ¨çš„èµ„æºæŒ‡é’ˆã€‚<br><br/></p><p>rebaseæ­¥éª¤å…ˆè¿›è¡Œï¼Œéœ€è¦æŠŠé•œåƒè¯»å…¥å†…å­˜ï¼Œå¹¶ä»¥pageä¸ºå•ä½è¿›è¡ŒåŠ å¯†éªŒè¯ï¼Œä¿è¯ä¸ä¼šè¢«ç¯¡æ”¹ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥çš„ç“¶é¢ˆåœ¨IOã€‚bindåœ¨å…¶åè¿›è¡Œï¼Œç”±äºè¦æŸ¥è¯¢ç¬¦å·è¡¨ï¼Œæ¥æŒ‡å‘è·¨é•œåƒçš„èµ„æºï¼ŒåŠ ä¸Šåœ¨rebaseé˜¶æ®µï¼Œé•œåƒå·²è¢«è¯»å…¥å’ŒåŠ å¯†éªŒè¯ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥çš„ç“¶é¢ˆåœ¨äºCPUè®¡ç®—ã€‚<br><br/></p><p>ä¼˜åŒ–è¯¥é˜¶æ®µçš„å…³é”®åœ¨äºå‡å°‘<code>__DATA segment</code>ä¸­çš„æŒ‡é’ˆæ•°é‡ã€‚å¯ä»¥ä¼˜åŒ–çš„ç‚¹æœ‰ï¼š</p><ol><li>å‡å°‘ Objc ç±»æ•°é‡ï¼Œ å‡å°‘ selector æ•°é‡</li><li>å‡å°‘ C++ è™šå‡½æ•°æ•°é‡</li><li>è½¬è€Œä½¿ç”¨ Swift stuctï¼ˆå…¶å®æœ¬è´¨ä¸Šå°±æ˜¯ä¸ºäº†å‡å°‘ç¬¦å·çš„æ•°é‡ï¼‰</li></ol><p><strong>1.2.3.Objc setup</strong><br><br/></p><p>è¿™ä¸€æ­¥ä¸»è¦å·¥ä½œæ˜¯è°ƒç”¨å„é•œåƒçš„åˆå§‹åŒ–æ–¹æ³•ï¼š</p><ol><li>æ³¨å†ŒObjcç±» (class registration)</li><li>æŠŠcategoryçš„å®šä¹‰æ’å…¥æ–¹æ³•åˆ—è¡¨ (category registration)</li><li>ä¿è¯æ¯ä¸€ä¸ªselectorå”¯ä¸€ (selctor uniquing)</li></ol><p>ç”±äºä¹‹å‰2æ­¥éª¤çš„ä¼˜åŒ–ï¼Œè¿™ä¸€æ­¥å®é™…ä¸Šæ²¡æœ‰ä»€ä¹ˆå¯åšçš„ã€‚<br><br/></p><p><strong>1.2.4.initializers</strong><br><br/></p><p>ä»¥ä¸Šä¸‰æ­¥å±äºé™æ€è°ƒæ•´(fix-up)ï¼Œéƒ½æ˜¯åœ¨ä¿®æ”¹__DATA segmentä¸­çš„å†…å®¹ï¼Œè€Œè¿™é‡Œåˆ™å¼€å§‹åŠ¨æ€è°ƒæ•´ï¼Œå¼€å§‹åœ¨å †å’Œå †æ ˆä¸­å†™å…¥å†…å®¹ï¼š</p><ol><li>Objcçš„<code>+load()</code>å‡½æ•°</li><li>C++çš„æ„é€ å‡½æ•°å±æ€§å‡½æ•°ï¼Œå½¢å¦‚ attribute((constructor)) void DoSomeInitializationWork()</li><li>éåŸºæœ¬ç±»å‹çš„C++é™æ€å…¨å±€å˜é‡çš„åˆ›å»º(é€šå¸¸æ˜¯ç±»æˆ–ç»“æ„ä½“)(non-trivial initializer) ï¼Œæ¯”å¦‚ä¸€ä¸ªå…¨å±€é™æ€ç»“æ„ä½“çš„æ„å»ºï¼Œå¦‚æœåœ¨æ„é€ å‡½æ•°ä¸­æœ‰ç¹é‡çš„å·¥ä½œï¼Œé‚£ä¹ˆä¼šæ‹–æ…¢å¯åŠ¨é€Ÿåº¦ã€‚</li></ol><p>è‡³æ­¤ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­å’ŒåŠ¨æ€åº“æ‰€æœ‰çš„ç¬¦å·(Classï¼ŒProtocolï¼ŒSelectorï¼ŒIMPï¼Œâ€¦)éƒ½å·²ç»æŒ‰æ ¼å¼æˆåŠŸåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¢« runtime æ‰€ç®¡ç†ã€‚åœ¨è¿™ä¹‹å runtime çš„é‚£äº›æ–¹æ³•(åŠ¨æ€æ·»åŠ  Classã€swizzle ç­‰ç­‰)æ‰èƒ½ç”Ÿæ•ˆã€‚<br><br/></p><p>æ•´ä¸ªäº‹ä»¶ç”±dyldä¸»å¯¼ï¼Œå®Œæˆè¿è¡Œç¯å¢ƒçš„åˆå§‹åŒ–åï¼Œå°†äºŒè¿›åˆ¶æ–‡ä»¶æŒ‰æ ¼å¼åŠ è½½åˆ°å†…å­˜ï¼ŒåŠ¨æ€é“¾æ¥ä¾èµ–åº“ï¼Œå¹¶ç”± runtime è´Ÿè´£åŠ è½½æˆ objc å®šä¹‰çš„ç»“æ„ï¼Œæ‰€æœ‰åˆå§‹åŒ–å·¥ä½œç»“æŸåï¼Œdyldè°ƒç”¨çœŸæ­£çš„ main å‡½æ•°ã€‚<br><br/></p><p>å¦‚æœç¨‹åºåˆšåˆšè¢«è¿è¡Œè¿‡ï¼Œé‚£ä¹ˆç¨‹åºçš„ä»£ç ä¼šè¢«dyldç¼“å­˜ï¼Œå› æ­¤å³ä½¿æ€æ‰è¿›ç¨‹å†æ¬¡é‡å¯åŠ è½½æ—¶é—´ä¹Ÿä¼šç›¸å¯¹å¿«ä¸€ç‚¹ï¼Œå¦‚æœé•¿æ—¶é—´æ²¡æœ‰å¯åŠ¨æˆ–è€…å½“å‰dyldçš„ç¼“å­˜å·²ç»è¢«å…¶ä»–åº”ç”¨å æ®ï¼Œé‚£ä¹ˆè¿™æ¬¡å¯åŠ¨æ‰€èŠ±è´¹çš„æ—¶é—´å°±è¦é•¿ä¸€ç‚¹ï¼Œè¿™å°±æ˜¯<code>çƒ­å¯åŠ¨</code>å’Œ<code>å†·å¯åŠ¨</code>çš„æ¦‚å¿µã€‚<br><br/></p><p>æ€ä¹ˆè¡¡é‡<code>main()</code>ä¹‹å‰çš„è€—æ—¶å‘¢ï¼Ÿè‹¹æœå®˜æ–¹æä¾›äº†ä¸€ç§æ–¹æ³•ï¼šåœ¨Xcodeä¸­ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡<code>DYLD_PRINT_STATISTICS</code>å’Œ<code>DYLD_PRINT_STATISTICS_DETAILS</code>åè¿è¡Œæ¥æŸ¥çœ‹è€—æ—¶ã€‚</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">E<span class="hljs-function"><span class="hljs-title">dit</span> Schemes-&gt;</span>R<span class="hljs-function"><span class="hljs-title">un</span>-&gt;</span>A<span class="hljs-function"><span class="hljs-title">rguments</span>-&gt;</span>E<span class="hljs-function"><span class="hljs-title">nvironment</span> Variables-&gt;</span>æ–°å¢ä¸Šè¿°å˜é‡ä¹‹ä¸€ï¼Œvalue=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>è®¾ç½®åå†æ¬¡å¯åŠ¨APPå³å¯åœ¨æ§åˆ¶å°çœ‹åˆ°æ—¥å¿—ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Total</span> pre-main time: <span class="hljs-number">1</span>.<span class="hljs-number">3</span> seconds (<span class="hljs-number">100</span>.<span class="hljs-number">0</span>%)<br>         <span class="hljs-attribute">dylib</span> loading time: <span class="hljs-number">160</span>.<span class="hljs-number">66</span> milliseconds (<span class="hljs-number">11</span>.<span class="hljs-number">5</span>%)<br>        <span class="hljs-attribute">rebase</span>/binding time: <span class="hljs-number">1</span>.<span class="hljs-number">1</span> seconds (<span class="hljs-number">81</span>.<span class="hljs-number">2</span>%)<br>            <span class="hljs-attribute">ObjC</span> setup time:  <span class="hljs-number">52</span>.<span class="hljs-number">53</span> milliseconds (<span class="hljs-number">3</span>.<span class="hljs-number">7</span>%)<br>           <span class="hljs-attribute">initializer</span> time:  <span class="hljs-number">47</span>.<span class="hljs-number">49</span> milliseconds (<span class="hljs-number">3</span>.<span class="hljs-number">4</span>%)<br>           <span class="hljs-attribute">slowest</span> intializers :<br>               <span class="hljs-attribute">libSystem</span>.dylib :   <span class="hljs-number">3</span>.<span class="hljs-number">80</span> milliseconds (<span class="hljs-number">0</span>.<span class="hljs-number">2</span>%)<br></code></pre></td></tr></table></figure><hr><h3 id="2ã€main-å‡½æ•°ä¹‹å"><a href="#2ã€main-å‡½æ•°ä¹‹å" class="headerlink" title="#2ã€main å‡½æ•°ä¹‹å"></a>#2ã€main å‡½æ•°ä¹‹å</h3><p>1ã€æ‰§è¡Œmainå‡½æ•°;</p><p>2ã€æ‰§è¡ŒUIApplicationMainå‡½æ•°ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">åˆ›å»ºUIApplicationï¼Œå¯åŠ¨ä¸»Runloop<span class="hljs-comment">;</span><br>åˆ›å»ºAppDelegateå¯¹è±¡ï¼Œå¼€å§‹å¤„ç†ç³»ç»Ÿäº‹ä»¶<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>3ã€æ£€æŸ¥Info.plistè®¾ç½®ã€åˆ›å»ºæ˜¾ç¤ºä¸»çª—å£ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">åŠ è½½SB<span class="hljs-comment">;</span><br>åˆ›å»ºKeywindow<span class="hljs-comment">;</span><br>åˆ›å»ºrootViewController<span class="hljs-comment">;</span><br>æ˜¾ç¤ºä¸»çª—å£<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><hr><h3 id="3ã€ä¼˜åŒ–å¯åŠ¨æ—¶é—´"><a href="#3ã€ä¼˜åŒ–å¯åŠ¨æ—¶é—´" class="headerlink" title="#3ã€ä¼˜åŒ–å¯åŠ¨æ—¶é—´:"></a>#3ã€ä¼˜åŒ–å¯åŠ¨æ—¶é—´:</h3><p>å¯¹äº main() è°ƒç”¨ä¹‹å‰çš„è€—æ—¶æˆ‘ä»¬å¯ä»¥ä¼˜åŒ–çš„ç‚¹æœ‰ï¼š</p><ol><li>å‡å°‘ä¸å¿…è¦çš„ frameworkï¼›</li><li>åˆå¹¶æˆ–è€…åˆ å‡ä¸€äº›OCç±»ï¼›</li><li>åˆ å‡ä¸€äº›æ— ç”¨çš„é™æ€å˜é‡;</li><li>åˆ å‡æ²¡æœ‰è¢«è°ƒç”¨åˆ°æˆ–è€…å·²ç»åºŸå¼ƒçš„æ–¹æ³•ï¼›</li><li>å°†ä¸å¿…é¡»åœ¨+loadæ–¹æ³•ä¸­åšçš„äº‹æƒ…å»¶è¿Ÿåˆ°+initializeä¸­ï¼›</li><li>å°½é‡ä¸è¦ç”¨C++è™šå‡½æ•°(åˆ›å»ºè™šå‡½æ•°è¡¨æœ‰å¼€é”€)ã€‚</li></ol><p>å¯¹äº main() å‡½æ•°è°ƒç”¨ä¹‹åæˆ‘ä»¬å¯ä»¥ä¼˜åŒ–çš„ç‚¹æœ‰ï¼š</p><ol><li>ä¸ä½¿ç”¨xibï¼Œç›´æ¥è§†ç”¨ä»£ç åŠ è½½é¦–é¡µè§†å›¾ï¼›</li><li>releaseç‰ˆæœ¬ä¸è¦ä½¿ç”¨ NSLog æ‰“å°æ—¥å¿—ï¼›</li><li>NSUserDefaultsä¸­ä¿å­˜çš„å†…å®¹ä¸å®œè¿‡å¤šã€‚</li><li>æ¢³ç†åº”ç”¨å¯åŠ¨æ—¶å‘é€çš„æ‰€æœ‰ç½‘ç»œè¯·æ±‚ï¼Œæ˜¯å¦å¯ä»¥ç»Ÿä¸€åœ¨å¼‚æ­¥çº¿ç¨‹è¯·æ±‚ï¼›</li></ol><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://techblog.toutiao.com/2017/01/17/iosspeed/">Â©å¤´æ¡æŠ€æœ¯åšå®¢-ä»Šæ—¥å¤´æ¡iOSå®¢æˆ·ç«¯å¯åŠ¨é€Ÿåº¦ä¼˜åŒ–</a></p><p>#<a href="https://www.jianshu.com/p/43db6b0aab8e">Â©DevilH-iOSç¨‹åºå¯åŠ¨</a></p><p>#<a href="https://mp.weixin.qq.com/s/I60p2M-IHDmeUanDUkFdVw">Â©MissionPeak-XNUã€dyldæºç åˆ†æMach-Oå’ŒåŠ¨æ€åº“çš„åŠ è½½è¿‡ç¨‹(ä¸Š)</a></p><p>#<a href="http://oncenote.com/2015/06/01/How-App-Launch/">Â©Jaminâ€™s blog-ç”±Appçš„å¯åŠ¨è¯´èµ·</a></p><p>#<a href="https://oleb.net/blog/2011/06/app-launch-sequence-ios/">Â©Ole Begemann-The App Launch Sequence on iOS</a></p><p>#<a href="https://www.jianshu.com/p/65901441903e">Â©alvin_wang-iOSç¼–è¯‘ä¸appå¯åŠ¨</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¼–è¯‘ä¸å¯åŠ¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–è¯‘å™¨</title>
    <link href="/2019/02/15/compile.html"/>
    <url>/2019/02/15/compile.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-ç¼–è¯‘-x2F-è§£é‡Šå‹è¯­è¨€"><a href="#1-ç¼–è¯‘-x2F-è§£é‡Šå‹è¯­è¨€" class="headerlink" title="1.ç¼–è¯‘&#x2F;è§£é‡Šå‹è¯­è¨€"></a>1.ç¼–è¯‘&#x2F;è§£é‡Šå‹è¯­è¨€</h3><ul><li>ç¼–è¯‘å‹è¯­è¨€</li></ul><p>ä»£ç é¡»ç¼–è¯‘æˆæœºå™¨ç æ‰èƒ½åœ¨CPUä¸Šæ‰§è¡Œçš„è¯­è¨€ï¼Œå¦‚OCå’ŒSwiftï¼Œå…¶ä¼˜ç‚¹æ˜¯ä»£ç æ‰§è¡Œæ•ˆç‡é«˜ã€‚</p><ul><li>è§£é‡Šå‹è¯­è¨€</li></ul><p>è§£é‡Šå‹è¯­è¨€ï¼Œå¦‚ JavaScript å’Œ Pythonï¼Œä»£ç ä¸éœ€è¦ç»è¿‡ç¼–è¯‘å™¨ï¼Œè€Œæ˜¯é€šè¿‡è§£é‡Šå™¨ç›´æ¥å°†ä»£ç è§£é‡ŠæˆCPUå¯ä»¥æ‰§è¡Œçš„ä»£ç ã€‚ç¼–å†™çµæ´»ï¼Œä½†æ‰§è¡Œæ•ˆç‡ä½ä¸€äº›~</p><p>æœ¬ç¯‡ä¸»è¦å…³æ³¨ç¼–è¯‘å‹è¯­è¨€ã€‚ç¼–è¯‘è¿‡ç¨‹å¯ä»¥åˆ’åˆ†ä¸ºå‰ç«¯å’Œåç«¯ä¸¤éƒ¨åˆ†ï¼š</p><h3 id="2-ç¼–è¯‘å™¨å‰ç«¯ï¼šClang"><a href="#2-ç¼–è¯‘å™¨å‰ç«¯ï¼šClang" class="headerlink" title="2.ç¼–è¯‘å™¨å‰ç«¯ï¼šClang"></a>2.ç¼–è¯‘å™¨å‰ç«¯ï¼šClang</h3><p>ç¼–è¯‘å™¨å‰ç«¯å°†ä¸åŒçš„é«˜çº§ç¼–ç¨‹è¯­è¨€ç»è¿‡è¯æ³•åˆ†æã€è¯­æ³•åˆ†æè½¬åŒ–ä¸ºä¸å‰ç«¯è¯­è¨€æ— å…³çš„ç»Ÿä¸€çš„ä¸­é—´è¡¨ç¤ºã€‚iOS ä¸­çš„ç¼–è¯‘å™¨å‰ç«¯ä½¿ç”¨çš„æ˜¯ Clangï¼Œå®ƒæ˜¯ä¸€ä¸ª C++ ç¼–å†™çš„ã€åŸºäºLLVM çš„ C&#x2F;C++&#x2F;Objective-C&#x2F;Objective-C++ ç¼–è¯‘å™¨ã€‚å…¶ä¸»è¦ä»»åŠ¡æ˜¯å¤„ç†ä¸€äº›å’Œå…·ä½“æœºå™¨æ— å…³çš„é’ˆå¯¹è¯­è¨€çš„åˆ†ææ“ä½œï¼š</p><p>é¢„å¤„ç†ï¼š</p><ul><li>ç¬¦å·åŒ– (Tokenization)</li><li>å®å®šä¹‰çš„å±•å¼€</li><li>#include çš„å±•å¼€ã€‚</li></ul><p>è¯­æ³•å’Œè¯­ä¹‰åˆ†æï¼š</p><ul><li>å°†ç¬¦å·åŒ–åçš„å†…å®¹è½¬åŒ–ä¸ºä¸€æ£µè§£ææ ‘ (parse tree)</li><li>è§£ææ ‘åšè¯­ä¹‰åˆ†æï¼ˆåŒ…å«ç±»å‹æ£€æŸ¥å’Œå…¶ä»–æ£€æŸ¥ï¼‰</li><li>è¾“å‡ºä¸€æ£µæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Tree* (AST)ï¼‰</li></ul><p>ç”Ÿæˆä»£ç </p><ul><li>å°† AST è½¬æ¢ä¸ºæ›´ä½çº§çš„ä¸­é—´ç  (LLVM IR)</li></ul><h3 id="3-ç¼–è¯‘å™¨åç«¯ï¼šLLVM"><a href="#3-ç¼–è¯‘å™¨åç«¯ï¼šLLVM" class="headerlink" title="3.ç¼–è¯‘å™¨åç«¯ï¼šLLVM"></a>3.ç¼–è¯‘å™¨åç«¯ï¼šLLVM</h3><p>ç¼–è¯‘å™¨åç«¯è´Ÿè´£å°†ä¸­é—´ä»£ç è¿›è¡Œä¼˜åŒ–å¹¶æœ€ç»ˆç”Ÿæˆå¯¹åº”å¹³å°çš„æ±‡ç¼–ä»£ç ã€‚LLVM å±äºç¼–è¯‘å™¨åç«¯ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯ï¼š</p><p>ä»£ç ä¼˜åŒ–</p><ul><li>å¯¹ç”Ÿæˆçš„ä¸­é—´ç åšä¼˜åŒ–</li><li>ç”Ÿæˆç‰¹å®šç›®æ ‡ä»£ç </li><li>è¾“å‡ºæ±‡ç¼–ä»£ç </li></ul><p>æ±‡ç¼–å™¨</p><ul><li>å°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºä»¥.o ç»“å°¾çš„ç›®æ ‡å¯¹è±¡æ–‡ä»¶ï¼ˆå°†å¯è¯»çš„æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨ä»£ç ï¼‰ã€‚</li></ul><p>é“¾æ¥å™¨</p><ul><li>è¯»å–æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶å’Œåº“å¹¶è§£å†³æ‰€æœ‰æœªçŸ¥ç¬¦å·çš„é—®é¢˜ï¼Œå°†å®ƒä»¬ç¼–ç è¿›ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæˆ–åŠ¨æ€åº“ï¼‰ä¸­ã€‚</li></ul><h3 id="4-Xcode-buildæµç¨‹ï¼š"><a href="#4-Xcode-buildæµç¨‹ï¼š" class="headerlink" title="4.Xcode buildæµç¨‹ï¼š"></a>4.Xcode buildæµç¨‹ï¼š</h3><p>é€šè¿‡è§£æ Xcode ç¼–è¯‘ logï¼Œå¯ä»¥å‘ç° Xcode æ˜¯æ ¹æ® target åˆ†å¼€è¿›è¡Œç¼–è¯‘çš„ã€‚æ¯ä¸ª target çš„å…·ä½“çš„ç¼–è¯‘è¿‡ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡å±•å¼€ log æ—¥å¿—è·å¾—ã€‚åŸºæœ¬çš„æ ¼å¼å°±æ˜¯é¦–å…ˆç®€æ˜ä¸€å¥è¯´æ˜è¦å¹²ä»€ä¹ˆï¼Œç„¶åç¼©è¿›çš„å‡ è¡Œè¯´æ˜å…·ä½“çš„æ“ä½œã€‚æ¯”å¦‚ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Build target CodeMix of project CodeMix with configuration <span class="hljs-built_in">Debug</span><br><br>CompileC /Users/<span class="hljs-built_in">..</span>/XXViewController.o CodeMix/XXViewController.m <br>normal x86_64 objective-c com.apple.compilers.llvm.clang.1_0.compiler<br>    cd /Users/<span class="hljs-built_in">..</span>/CodeMix<br>    <span class="hljs-built_in">export</span> <span class="hljs-attribute">LANG</span>=en_US.US-ASCII<br>    <span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=â€œ../XXViewController.o<br><br>Ld /Users/<span class="hljs-built_in">..</span>/Debug-iphonesimulator/CodeMix.app/CodeMix normal x86_64<br>    cd /Users/<span class="hljs-built_in">..</span>/CodeMix<br>    <span class="hljs-built_in">export</span> <span class="hljs-attribute">IPHONES_DEPLOYMENT_TARGET</span>=11.2<br>    <span class="hljs-built_in">..</span><br><br>PhaseScriptExecution Run\<span class="hljs-built_in"> Script </span>/Users/<span class="hljs-built_in">..</span>/Script-0AC86E9E1FF6721A00098A24.sh<br>    cd /Users/Macmafia/Desktop/CodeMix<br>    <span class="hljs-built_in">export</span> <span class="hljs-attribute">ACTION</span>=build<br>    <span class="hljs-built_in">export</span> <span class="hljs-attribute">AD_HOC_CODE_SIGNING_ALLOWED</span>=<span class="hljs-literal">YES</span><br>    <span class="hljs-built_in">export</span> <span class="hljs-attribute">ALTERNATE_GROUP</span>=staff<br><br>    /bin/sh -c /Users/<span class="hljs-built_in">..</span>/Script-0AC86E9E1FF6721A00098A24.sh<br><br>PRAGMA <span class="hljs-attribute">foreign_keys</span>=OFF;<br>BEGIN TRANSACTION;<br>CREATE TABLE symbols(src text, des text);<br>COMMIT;<br><br>Touch /Users/<span class="hljs-built_in">..</span>/Build/Products/Debug-iphonesimulator/CodeMix.app<br>    cd /Users/<span class="hljs-built_in">..</span>/CodeMix<br>    <span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-string">&quot;/Applications/Xcode.app/../Debug-iphonesimulator/CodeMix.app</span><br><span class="hljs-string"></span><br><span class="hljs-string">CodeSign /Users/../Debug-iphonesimulator/CodeMix.app</span><br><span class="hljs-string">    cd /Users/../CodeMix</span><br><span class="hljs-string">    export CODESIGN_ALLOCATE=/Applications/Xcode.app/../codesign_allocate</span><br><span class="hljs-string">    </span><br><span class="hljs-string">Signing Identity:     &quot;</span>-&quot;<br>    <span class="hljs-built_in">..</span><br>Build succeeded    2018/1/26 ä¸‹åˆ9:35<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œå¤§è‡´çš„è¿‡ç¨‹æ˜¯ï¼š</p><ul><li>compile swiftæ–‡ä»¶</li><li>compileå„ä¸ª.mæ–‡ä»¶ï¼ˆæŒ‰åå­—å‡åºï¼‰</li><li>compile xib</li><li>compile storyboard</li><li>link storyboards</li><li>copyé™æ€èµ„æºï¼ŒåŒ…æ‹¬imgï¼Œstringï¼Œfont</li><li>compile asset catalogs</li><li>run custom shell script</li><li>process info.plist</li><li>copy Swift standard libraries into xx.appï¼ˆæ‹·è´swiftæ ‡å‡†åº“ï¼‰</li><li>sign appï¼ˆä»£ç ç­¾åï¼‰</li><li>touch appï¼ˆç”Ÿæˆ.appæ–‡ä»¶ï¼‰</li><li>validate app(çœŸæœºbuildæœ‰)</li></ul><hr><p>å‚è€ƒæ–‡ç« ï¼š</p><p>#<a href="https://objccn.io/issue-6-2/">Â©ç¼–è¯‘å™¨-objccn</a> </p><p>#<a href="http://wiki.jikexueyuan.com/project/objc/Build-tool/6-3.html">Â©æå®¢å­¦é™¢-OCæœŸåˆŠ</a></p><p>#<a href="https://blog.csdn.net/u012491514/article/details/24736041">Â©GCCç¼–è¯‘å™¨</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç¼–è¯‘ä¸å¯åŠ¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ´¾å‘æœºåˆ¶</title>
    <link href="/2018/12/12/static-dynamic.html"/>
    <url>/2018/12/12/static-dynamic.html</url>
    
    <content type="html"><![CDATA[<p>å‡½æ•°&#x2F;æ–¹æ³•æŠŠä»£ç å†…èšåˆ°ä¸€å¤„å¹¶å¯¹å¤–æš´éœ²å‡½æ•°åï¼Œè¿™æé«˜äº†ä»£ç çš„å¤ç”¨æ€§ï¼Œä¹Ÿå¯¹å¤–éšè—äº†å…·ä½“çš„å®ç°è¿‡ç¨‹ã€‚æ ¹æ®å‡½æ•°åæ‰¾åˆ°å…·ä½“çš„å‡½æ•°å®ç°ï¼Œè¿™å°±æ˜¯å‡½æ•°æ´¾å‘çš„è¿‡ç¨‹ã€‚å‡½æ•°æ´¾å‘çš„æœºåˆ¶åˆ†ä¸¤ç§ï¼š</p><ul><li>é™æ€æ´¾å‘</li><li>åŠ¨æ€æ´¾å‘</li></ul><hr><h3 id="ä¸€ã€é™æ€æ´¾å‘"><a href="#ä¸€ã€é™æ€æ´¾å‘" class="headerlink" title="ä¸€ã€é™æ€æ´¾å‘"></a>ä¸€ã€é™æ€æ´¾å‘</h3><blockquote><p>static dispatch is a form of polymorphism fully resolved during compile time. It is a form of method dispatch, which describes how a language or environment will select which implementation of a method or function to use.</p></blockquote><blockquote><p>Dynamic dispatch contrasts with static dispatch, in which the implementation of a polymorphic operation is selected at compile-time. </p></blockquote><p>é™æ€æ´¾å‘æœºåˆ¶ä¸‹ï¼Œâ€œæ–¹æ³•çš„å®ç°åœ¨ç¼–è¯‘æœŸå°±å·²ç¡®å®šâ€ï¼Œå³ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸå°±å·²ç»èƒ½ç¡®å®šå‡½æ•°å…·ä½“å®ç°çš„ä½ç½®åœ¨å“ªã€‚è°ƒç”¨å‡½æ•°æ—¶ï¼Œruntime ä¼šç›´æ¥è·³è½¬åˆ°å‡½æ•°çš„å†…å­˜åœ°å€ä¸Šæ‰§è¡Œå…·ä½“çš„å®ç°ã€‚<br><br/></p><p><strong>ä¼˜ç‚¹</strong>ï¼šæ‰§è¡Œå¿«ã€æ€§èƒ½å¥½ã€ç¼–è¯‘å™¨èƒ½è¿›è¡Œå†…è”ç­‰ä¼˜åŒ–ã€‚<br><br/></p><p><strong>ç¼ºç‚¹</strong>ï¼šç¼ºä¹åŠ¨æ€æ€§ï¼Œå‡½æ•°å®ç°åœ¨è¿è¡ŒæœŸä¸èƒ½ä¿®æ”¹ï¼Œæ— æ³•æ»¡è¶³æŸäº›ç‰¹å®šçš„éœ€æ±‚ï¼Œæ¯”å¦‚åœ¨è¿è¡Œæ—¶æ›¿æ¢æŸä¸ªæ–¹æ³•ã€‚</p><h3 id="äºŒã€åŠ¨æ€æ´¾å‘"><a href="#äºŒã€åŠ¨æ€æ´¾å‘" class="headerlink" title="äºŒã€åŠ¨æ€æ´¾å‘"></a>äºŒã€åŠ¨æ€æ´¾å‘</h3><blockquote><p>Dynamic dispatch is the process of selecting which implementation of a polymorphic operation (method or function) to call at run time. </p></blockquote><p>åŠ¨æ€æ´¾å‘ï¼Œæ˜¯æŒ‡â€œåœ¨è¿è¡Œæ—¶å†³å®šæ–¹æ³•è°ƒç”¨å“ªä¸ªå®ç°â€çš„è¿‡ç¨‹ã€‚åŠ¨æ€æ´¾å‘æœºåˆ¶äº§ç”Ÿçš„åŸå› æ˜¯é¢å‘å¯¹è±¡è¯­è¨€çš„å¤šæ€æ€§ã€‚åŠ¨æ€æ´¾å‘æœºåˆ¶ä¸‹ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸè¿˜ä¸çŸ¥é“å‡½æ•°çš„å…·ä½“å®ç°æ˜¯å“ªä¸ªï¼›åœ¨æ‰§è¡Œå‡½æ•°æ—¶<code>runtime</code>æ‰ä¼šæ ¹æ®å‡½æ•°åå»å‡½æ•°è¡¨ä¸­æŸ¥æ‰¾å¹¶æ‰§è¡Œå…·ä½“çš„å®ç°ã€‚æ¯ç§è¯­è¨€éƒ½æœ‰è‡ªå·±çš„æœºåˆ¶æ¥æ”¯æŒåŠ¨æ€æ´¾å‘ï¼Œä¾‹å¦‚swiftæ”¯æŒå‡½æ•°è¡¨æ´¾å‘ã€æ¶ˆæ¯æ´¾å‘~<br><br/></p><p><strong>ç¼ºç‚¹</strong>ï¼šéœ€è¦æŸ¥è¡¨ï¼Œæ‰§è¡Œæ•ˆç‡ç›¸å¯¹ä½ä¸€äº›ã€‚</p><h4 id="2-1-å‡½æ•°è¡¨æ´¾å‘"><a href="#2-1-å‡½æ•°è¡¨æ´¾å‘" class="headerlink" title="2.1.å‡½æ•°è¡¨æ´¾å‘"></a>2.1.å‡½æ•°è¡¨æ´¾å‘</h4><p>è¿™æ˜¯<code>ç¼–è¯‘å‹è¯­è¨€</code>æœ€å¸¸é‡‡ç”¨çš„å‡½æ•°æ´¾å‘æœºåˆ¶ã€‚ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸä¸ºæ¯ä¸ªç±»åˆ›å»ºä¸€ä¸ªä¸ä¹‹ç›¸å…³è”çš„å‡½æ•°è¡¨<code>virtual table</code>ï¼Œå³<code>vtable</code>ã€‚å®ƒæ˜¯ä¸€ä¸ªç”±å‡½æ•°æŒ‡é’ˆç»„æˆçš„æ•°ç»„ï¼ŒæŒ‡é’ˆæŒ‡å‘çš„æ˜¯å‡½æ•°çš„å…·ä½“å®ç°ã€‚<br><br/></p><p>#<a href="https://www.raizlabs.com/dev/2016/12/swift-method-dispatch/?utm_campaign=This+Week+in+Swift">ç¤ºä¾‹1</a>ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">ParentClass</span> &#123;<br>    <span class="hljs-function">func <span class="hljs-title">method1</span>()</span> &#123;&#125;<br>    <span class="hljs-function">func <span class="hljs-title">method2</span>()</span> &#123;&#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title">ChildClass</span>: <span class="hljs-title">ParentClass</span> &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">override</span> func <span class="hljs-title">method2</span>()</span> &#123;&#125;<br>    <span class="hljs-function">func <span class="hljs-title">method3</span>()</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸¤ä¸ª dispatch tableï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_virtual_dispatch.png" alt="table dispatch"></p><p>è°ƒç”¨æŸä¸ªæ–¹æ³•ï¼š</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode">let obj = ChildClass<span class="hljs-comment">()</span><br>obj.method<span class="hljs-number">2</span><span class="hljs-comment">()</span><br></code></pre></td></tr></table></figure><p>æ´¾å‘æµç¨‹ï¼š</p><ol><li>runtime ä¼šå…ˆå»è¯»å– <code>å‡½æ•°è¡¨</code> 0xB00ï¼›</li><li>æ ¹æ®å‡½æ•°çš„ç´¢å¼•å»è¯»å–å‡½æ•°æŒ‡é’ˆï¼šfunction2 ç´¢å¼•å€¼æ˜¯ 1ï¼Œæ‰€ä»¥å»è¯»å– 0xB00 + 1ï¼›</li><li>æœ€åè·³è½¬åˆ°å‡½æ•°å¯¹åº”çš„å†…å­˜åœ°å€ 0x222 ä¸Šæ‰§è¡Œå…·ä½“çš„å®ç°ã€‚</li></ol><h4 id="2-2-æ¶ˆæ¯æ´¾å‘"><a href="#2-2-æ¶ˆæ¯æ´¾å‘" class="headerlink" title="2.2.æ¶ˆæ¯æ´¾å‘"></a>2.2.æ¶ˆæ¯æ´¾å‘</h4><p>è¿™æ˜¯OCä¸­çš„æ´¾å‘æœºåˆ¶ï¼ŒOCä¸­æ–¹æ³•çš„è°ƒç”¨ä¼šè¢«è½¬åŒ–ä¸ºæ¶ˆæ¯ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">objc<span class="hljs-constructor">_msgSend(<span class="hljs-params">id</span> <span class="hljs-params">self</span>, SEL <span class="hljs-params">op</span>, <span class="hljs-operator">...</span>)</span><br></code></pre></td></tr></table></figure><ul><li>å‚æ•°1ï¼šè°ƒç”¨è€…ï¼›</li><li>å‚æ•°2ï¼šè°ƒç”¨çš„æ–¹æ³•ï¼›</li><li>çœç•¥å·ï¼šæ–¹æ³•çš„Nä¸ªå‚æ•°ã€‚</li></ul><p>æ´¾å‘æµç¨‹ï¼š</p><ol><li>æ–¹æ³•çš„è°ƒç”¨è€…ä¼šé€šè¿‡<code>isa</code>æŒ‡é’ˆæ‰¾åˆ°å…¶æ‰€å±çš„ç±»ã€‚</li><li>runtime ä¼šå…ˆå»<code>cache</code>ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ–¹æ³•ï¼›</li><li>è‹¥<code>cache</code>ä¸­æ²¡æœ‰æ‰¾åˆ°åˆ™å»<code>methodLists</code>ä¸­æŸ¥æ‰¾ã€‚</li><li>æ‰¾åˆ°åé€šè¿‡å‡½æ•°æŒ‡é’ˆè·³è½¬åˆ°å¯¹åº”çš„å®ç°ä¸­æ‰§è¡Œï¼Œå¹¶å°†æ–¹æ³•åŠ å…¥åˆ°<code>cache</code>ä¸­ä»¥ä¾¿ä¸‹æ¬¡æŸ¥æ‰¾ï¼›</li><li>å¦‚æœ<code>methodLists</code>ä¸­ä¹Ÿæ²¡æ‰¾åˆ°ï¼Œåˆ™ç»§ç»­é¡ºç€ç»§æ‰¿å…³ç³»åˆ°çˆ¶ç±»ä¸­æŸ¥æ‰¾ï¼›</li><li>å¦‚æœç›´åˆ°æ ¹ç±» NSObject éƒ½è¿˜æ²¡æ‰¾åˆ°åˆ™ä¼šå°è¯•<code>åŠ¨æ€æ–¹æ³•å†³è®®</code>æˆ–<code>æ¶ˆæ¯è½¬å‘</code>æœºåˆ¶ï¼›</li><li>å¦‚æœæ²¡æœ‰å®ç°è¿™ä¸¤ç§æœºåˆ¶ï¼Œåˆ™æ–¹æ³•çš„è°ƒç”¨ä¼šå› æ‰¾ä¸åˆ°å¯¹åº”çš„å®ç°è€ŒæŠ¥è¿è¡Œæ—¶é”™è¯¯ã€‚</li></ol><p>æ¶ˆæ¯æ´¾å‘æœºåˆ¶æ˜¯è¿™ä¸‰ç§æ´¾å‘æœºåˆ¶ä¸­æœ€å…·åŠ¨æ€æ€§çš„ï¼Œä½ å¯ä»¥ç”¨<code>swizzling</code>é»‘é­”æ³•ä¿®æ”¹å‡½æ•°çš„å®ç°ï¼›ä¹Ÿå¯ä»¥ç”¨<code>isa-swizzling</code>ä¿®æ”¹å¯¹è±¡æœ¬èº«ï¼Œå¦‚KVOçš„<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html#//apple_ref/doc/uid/20002307-BAJEAIEE">åº•å±‚å®ç°</a>ã€‚<br><br/></p><p>å¦å¤–ï¼ŒSwift ä½œä¸ºé™æ€è¯­è¨€å¤©ç„¶æ”¯æŒé™æ€æ´¾å‘ï¼Œä½†å®ƒä¹Ÿç”¨åˆ°äº†OCçš„<code>runtime library</code>ï¼Œæ‰€ä»¥åŒæ ·æ”¯æŒæ¶ˆæ¯æ´¾å‘ã€‚</p><hr><h2 id="ä¸‰ã€Swiftçš„æ´¾å‘æœºåˆ¶"><a href="#ä¸‰ã€Swiftçš„æ´¾å‘æœºåˆ¶" class="headerlink" title="ä¸‰ã€Swiftçš„æ´¾å‘æœºåˆ¶"></a>ä¸‰ã€Swiftçš„æ´¾å‘æœºåˆ¶</h2><p>Swift çš„å‡½æ•°æ´¾å‘æœºåˆ¶å› å‡½æ•°å®šä¹‰çš„ä½ç½®ã€ç‰¹åˆ«å£°æ˜ç­‰è€Œå¼‚ï¼š<br><br/></p><table><thead><tr><th align="center">è®¾å®š</th><th align="center">é™æ€æ´¾å‘</th><th align="center">å‡½æ•°è¡¨æ´¾å‘</th><th align="center">æ¶ˆæ¯æ´¾å‘</th></tr></thead><tbody><tr><td align="center">ç‰¹åˆ«å£°æ˜</td><td align="center">static &#x2F; final</td><td align="center">-</td><td align="center">dynamic</td></tr><tr><td align="center">class</td><td align="center">extensions</td><td align="center">initial declaration</td><td align="center">æ ‡æ³¨ä¸º@objcçš„extensions</td></tr><tr><td align="center">protocol</td><td align="center">extensions</td><td align="center">initial declaration</td><td align="center">-</td></tr><tr><td align="center">value type</td><td align="center">all func</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="center"><br/></td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table><p>#é™æ€æ´¾å‘ï¼š</p><ol><li><code>static</code> æˆ– <code>final</code> æ ‡æ³¨çš„å‡½æ•°ä¸èƒ½è¢«é‡å†™ï¼Œæ‰€ä»¥ä¸å…·æœ‰å¤šæ€æ€§ï¼Œä½¿ç”¨é™æ€æ´¾å‘ï¼›</li><li><code>final</code> æ ‡æ³¨çš„ç±»ä¼šå¤±å»æ‰€æœ‰åŠ¨æ€çš„èƒ½åŠ›ï¼Œå…¶ä¸­çš„å‡½æ•°ä¹Ÿæ˜¯ä½¿ç”¨é™æ€æ´¾å‘ï¼›</li><li>Enumã€Struct æ˜¯å€¼ç±»å‹ï¼Œä¸èƒ½ç»§æ‰¿åˆ«çš„ç±»å‹ä¹Ÿå°±æ²¡æœ‰é‡å†™ä¸€è¯´ï¼Œå…¶å‡½æ•°æ€»æ˜¯é™æ€æ´¾å‘ï¼›</li><li>åè®®çš„æ‰©å±•ä¸­å®šä¹‰çš„å‡½æ•°æ˜¯é™æ€æ´¾å‘ï¼›</li><li>ç±»çš„æ‰©å±•ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œé™¤äº†æ ‡è®°ä¸º<code>@objc</code>çš„å¤–ï¼Œå…¶ä»–éƒ½æ˜¯é™æ€æ´¾å‘ã€‚</li></ol><p>#åŠ¨æ€æ´¾å‘ï¼š</p><ol><li>ç±»æˆ–åè®®ä¸­å£°æ˜çš„åŸå§‹å‡½æ•°ï¼Œä½¿ç”¨çš„æ˜¯å‡½æ•°è¡¨æ´¾å‘ï¼›</li><li>ç»§æ‰¿è‡ªNSObjectæˆ–å…¶å­ç±»çš„Swiftç±»ä¸­ï¼Œè¢«é‡å†™çš„OCç±»çš„å‡½æ•°ä½¿ç”¨çš„è¿˜æ˜¯OCçš„æ¶ˆæ¯æ´¾å‘ï¼›</li><li>ç”± <code>dynamic</code> æ ‡è®°çš„å‡½æ•°ä½¿ç”¨çš„æ˜¯æ¶ˆæ¯æ´¾å‘ï¼›</li><li>Extensions ä¸­æ ‡è®°ä¸º<code>@objc</code>çš„å‡½æ•°ä½¿ç”¨çš„æ˜¯æ¶ˆæ¯æ´¾å‘ã€‚</li></ol><p>#ç¤ºä¾‹2ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Eat</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">eat</span>()  <span class="hljs-comment">//å‡½æ•°è¡¨æ´¾å‘</span><br>&#125;<br><br><span class="hljs-keyword">extension</span> <span class="hljs-title class_">Eat</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">eat</span>() &#123;<span class="hljs-comment">//å‡½æ•°è¡¨æ´¾å‘</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;eat()åè®®æ–¹æ³•çš„é»˜è®¤å®ç°ï¼Œä¸æ˜¯é‡å†™å“¦ï¼ˆswiftåˆ†ç±»ä¸­ä¸èƒ½é‡å†™åŸç±»ä¸­å·²æœ‰çš„æ–¹æ³•ï¼‰~&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">drink</span>() &#123;<span class="hljs-comment">//é™æ€æ´¾å‘</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Sheep</span>: <span class="hljs-title class_">Eat</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">eat</span>() &#123;<span class="hljs-comment">//å‡½æ•°è¡¨æ´¾å‘</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;eatçš„å®ç°&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">drink</span>() &#123;<span class="hljs-comment">//å‡½æ•°è¡¨æ´¾å‘</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;dinkçš„å®ç°&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">run</span>() &#123;&#125; <span class="hljs-comment">//æ¶ˆæ¯æ´¾å‘</span><br>&#125;<br><br><span class="hljs-keyword">extension</span> <span class="hljs-title class_">Sheep</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">jump</span>() &#123;&#125; <span class="hljs-comment">//é™æ€æ´¾å‘</span><br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">sleep</span>() &#123;&#125; <span class="hljs-comment">//æ¶ˆæ¯æ´¾å‘</span><br>&#125;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">DiceNumber</span> : <span class="hljs-title class_">Int</span> &#123;<br>    <span class="hljs-keyword">case</span> one <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">case</span> two<br>    <span class="hljs-keyword">case</span> three<br>    <span class="hljs-keyword">case</span> four<br>    <span class="hljs-keyword">case</span> five<br>    <span class="hljs-keyword">case</span> six<br>    <br>    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateDirection</span>(<span class="hljs-params">num</span>:<span class="hljs-type">DiceNumber</span>) &#123;<span class="hljs-comment">//é™æ€æ´¾å‘</span><br>        <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> num<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Dice</span> &#123;<br>    <span class="hljs-keyword">var</span> slides <span class="hljs-operator">=</span> <span class="hljs-number">6</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">random</span>(<span class="hljs-params">dice</span>: <span class="hljs-type">DiceNumber</span>) -&gt; <span class="hljs-type">Int</span> &#123;<span class="hljs-comment">//é™æ€æ´¾å‘</span><br>        <span class="hljs-keyword">return</span> dice.rawValue<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="å››ã€åŠ¨-x2F-é™æ€è¯­è¨€"><a href="#å››ã€åŠ¨-x2F-é™æ€è¯­è¨€" class="headerlink" title="å››ã€åŠ¨&#x2F;é™æ€è¯­è¨€"></a>å››ã€åŠ¨&#x2F;é™æ€è¯­è¨€</h2><p>åŠ¨æ€&#x2F;é™æ€è¯­è¨€ä¸€èˆ¬æ˜¯æŒ‡åŠ¨æ€&#x2F;é™æ€ç¼–ç¨‹è¯­è¨€ï¼Œå¼ºè°ƒçš„æ˜¯â€œç¨‹åºåœ¨è¿è¡ŒæœŸæ˜¯å¦å¯æ‰©å±•â€ã€‚</p><h4 id="4-1-åŠ¨æ€è¯­è¨€"><a href="#4-1-åŠ¨æ€è¯­è¨€" class="headerlink" title="4.1.åŠ¨æ€è¯­è¨€"></a>4.1.åŠ¨æ€è¯­è¨€</h4><blockquote><p>Dynamic programming language, in computer science, is a class of high-level programming languages which, at runtime, execute many common programming behaviors that static programming languages perform during compilation. These behaviors could include extension of the program, by adding new code, by extending objects and definitions, or by modifying the type system. </p></blockquote><p>åŠ¨æ€è¯­è¨€æ˜¯ç¨‹åºåœ¨è¿è¡ŒæœŸå¯ä»¥æ‰©å±•çš„ä¸€ç±»è¯­è¨€ï¼ŒåŒ…æ‹¬ï¼šæ·»åŠ æ–°ä»£ç ã€æ‰©å±•å¯¹è±¡æˆ–å®šä¹‰ã€ä¿®æ”¹ç±»å‹ç³»ç»Ÿã€‚å¸¸è§çš„åŠ¨æ€è¯­è¨€æœ‰ï¼š<code>JavaScript</code>ã€<code>Python</code>ã€<code>Ruby</code>ã€<code>PHP</code>ä»¥åŠ<code>OC</code>ã€‚</p><h4 id="4-2-é™æ€è¯­è¨€"><a href="#4-2-é™æ€è¯­è¨€" class="headerlink" title="4.2.é™æ€è¯­è¨€"></a>4.2.é™æ€è¯­è¨€</h4><p>é™æ€è¯­è¨€æ˜¯ä¸åŠ¨æ€è¯­è¨€ç›¸å¯¹åº”ï¼Œè¿è¡ŒæœŸç¨‹åºä¸å¯æ‰©å±•ã€‚å¸¸è§çš„é™æ€è¯­è¨€æœ‰ï¼š<code>Java</code>ã€<code>C</code>ã€<code>C++</code>ã€‚<br><br/></p><p>Swift ä¹Ÿæ˜¯é™æ€è¯­è¨€ï¼ŒSwift ä¸­å£°æ˜çš„æ–¹æ³•ã€å±æ€§åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šã€‚åŒæ—¶ Swift ä¹Ÿæ”¯æŒåŠ¨æ€ç»‘å®šå’Œæ´¾å‘ï¼Œåªä¸è¿‡éœ€è¦å°†ç±»ä¸­çš„å±æ€§ã€æ–¹æ³•æ ‡æ³¨ä¸º <code>@objc</code>å’Œ<code>dynamic</code>ï¼Œè¿™æ · Swift çš„åŠ¨æ€ç‰¹æ€§å°±å¯ä»¥ä½¿ç”¨ OC çš„è¿è¡Œæ—¶æœºåˆ¶æ¥å®ç°ã€‚</p><h2 id="äº”ã€åŠ¨-x2F-é™æ€ç±»å‹è¯­è¨€"><a href="#äº”ã€åŠ¨-x2F-é™æ€ç±»å‹è¯­è¨€" class="headerlink" title="äº”ã€åŠ¨&#x2F;é™æ€ç±»å‹è¯­è¨€"></a>äº”ã€åŠ¨&#x2F;é™æ€ç±»å‹è¯­è¨€</h2><p>é™æ€&#x2F;åŠ¨æ€ç±»å‹è¯­è¨€å¼ºè°ƒçš„æ˜¯â€œæ•°æ®ç±»å‹â€åœ¨ä½•æ—¶ç¡®å®šã€‚</p><h4 id="5-1-é™æ€ç±»å‹è¯­è¨€"><a href="#5-1-é™æ€ç±»å‹è¯­è¨€" class="headerlink" title="5.1.é™æ€ç±»å‹è¯­è¨€"></a>5.1.é™æ€ç±»å‹è¯­è¨€</h4><p>é™æ€ç±»å‹è¯­è¨€ï¼Œæ˜¯æ•°æ®ç±»å‹åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šä¸‹æ¥çš„è¯­è¨€ï¼Œä¸€èˆ¬åœ¨ä½¿ç”¨å˜é‡ä¹‹å‰è¦æ˜ç¡®å£°æ˜å˜é‡çš„ç±»å‹ã€‚ä»£è¡¨è¯­è¨€æœ‰ï¼š<code>C</code>ã€<code>C++</code>ã€<code>C#</code>ã€<code>Java</code>ã€<code>Delphi</code>ä»¥åŠ<code>OC</code>ã€‚</p><h4 id="5-2-åŠ¨æ€ç±»å‹è¯­è¨€"><a href="#5-2-åŠ¨æ€ç±»å‹è¯­è¨€" class="headerlink" title="5.2.åŠ¨æ€ç±»å‹è¯­è¨€"></a>5.2.åŠ¨æ€ç±»å‹è¯­è¨€</h4><p>åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œæ˜¯åœ¨è¿è¡ŒæœŸé—´æ‰å»åšæ•°æ®ç±»å‹æ£€æŸ¥çš„è¯­è¨€ã€‚ä¸€èˆ¬å˜é‡åœ¨ä½¿ç”¨ä¹‹å‰ä¸éœ€è¦æ˜ç¡®å£°æ˜ç±»å‹ï¼Œè¢«èµ‹å€¼æ—¶æ‰çŸ¥é“æ•°æ®å…·ä½“çš„ç±»å‹ã€‚ä»£è¡¨è¯­è¨€æœ‰ï¼š<code>Python</code>ã€<code>Ruby</code>ä»¥åŠä¸€äº›è„šæœ¬è¯­è¨€å¦‚<code>JavaScript</code>ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://blog.csdn.net/lvxiangan/article/details/78391281">Â©CSDN</a></p><p>#<a href="https://en.wikipedia.org/wiki/Dynamic_programming_language">Â©ç»´åŸºç™¾ç§‘-Dynamic programming language</a></p><p>#<a href="https://en.wikipedia.org/wiki/Type_system">Â©ç»´åŸºç™¾ç§‘-Type_system</a></p><p>#<a href="https://en.wikipedia.org/wiki/Dynamic_dispatch">Â©ç»´åŸºç™¾ç§‘-Dynamic dispatch</a></p><p>#<a href="https://en.wikipedia.org/wiki/Static_dispatch">Â©ç»´åŸºç™¾ç§‘-Static dispatch</a></p><p>#<a href="https://trinhngocthuyen.github.io/2017-09-25-method-dispatch-in-swift.html">Â©Method dispatch in Swift</a></p><p>#<a href="https://www.jianshu.com/p/7272e46d47f4">Â©ç®€ä¹¦-alvin_wang</a></p><p>#<a href="https://www.raizlabs.com/dev/2016/12/swift-method-dispatch/?utm_campaign=This+Week+in+Swift">Â©BRIAN KING</a></p><p>#<a href="https://github.com/devedbox/SwiftWT/wiki/Dynamic-Swift">Â©devedbox-Dynamic Swift</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runtime</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¸¸ç”¨æ’åºç®—æ³•</title>
    <link href="/2018/10/09/algorithm.html"/>
    <url>/2018/10/09/algorithm.html</url>
    
    <content type="html"><![CDATA[<h3 id="å†’æ³¡æ’åº"><a href="#å†’æ³¡æ’åº" class="headerlink" title="å†’æ³¡æ’åº"></a>å†’æ³¡æ’åº</h3><blockquote><p>å®ƒé‡å¤åœ°èµ°è®¿è¿‡è¦æ’åºçš„å…ƒç´ åˆ—ï¼Œä¾æ¬¡æ¯”è¾ƒä¸¤ä¸ªç›¸é‚»çš„å…ƒç´ ï¼Œå¦‚æœä»–ä»¬çš„é¡ºåºï¼ˆå¦‚ä»å¤§åˆ°å°ã€é¦–å­—æ¯ä»Aåˆ°Zï¼‰é”™è¯¯å°±æŠŠä»–ä»¬äº¤æ¢è¿‡æ¥ã€‚èµ°è®¿å…ƒç´ çš„å·¥ä½œæ˜¯é‡å¤åœ°è¿›è¡Œç›´åˆ°æ²¡æœ‰ç›¸é‚»å…ƒç´ éœ€è¦äº¤æ¢ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å…ƒç´ å·²ç»æ’åºå®Œæˆã€‚</p></blockquote><p>è¿™ä¸ªç®—æ³•çš„åå­—ç”±æ¥æ˜¯å› ä¸ºè¶Šå¤§çš„å…ƒç´ ä¼šç»ç”±äº¤æ¢æ…¢æ…¢â€œæµ®â€åˆ°æ•°åˆ—çš„é¡¶ç«¯ï¼ˆå‡åºæˆ–é™åºæ’åˆ—ï¼‰ï¼Œå°±å¦‚åŒç¢³é…¸é¥®æ–™ä¸­äºŒæ°§åŒ–ç¢³çš„æ°”æ³¡æœ€ç»ˆä¼šä¸Šæµ®åˆ°é¡¶ç«¯ä¸€æ ·ï¼Œæ•…åâ€œå†’æ³¡æ’åºâ€ã€‚</p><p>#å†’æ³¡æ’åºçš„Swiftç¤ºä¾‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stylus">func <span class="hljs-built_in">bubbleSort</span>(_ nums: inout <span class="hljs-selector-attr">[Int]</span>) &#123;<br>    let n = nums<span class="hljs-selector-class">.count</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> ..&lt; n-<span class="hljs-number">1</span> &#123;<span class="hljs-comment">//å¾ªç¯n-1æ¬¡</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> ..&lt; (n - <span class="hljs-number">1</span> - i) &#123;<br>            <span class="hljs-keyword">if</span> nums<span class="hljs-selector-attr">[j]</span> &gt; nums<span class="hljs-selector-attr">[j + 1]</span> &#123;<br>                nums<span class="hljs-selector-class">.swapAt</span>(j, j + <span class="hljs-number">1</span>)<span class="hljs-comment">//å‡åºæ’åˆ—</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">print</span>(nums)<span class="hljs-comment">//æ‰“å°ç»“æœ</span><br>&#125;<br><span class="hljs-comment">//è°ƒç”¨ç¤ºä¾‹ </span><br><span class="hljs-selector-tag">var</span> nums = <span class="hljs-selector-attr">[5,8,1,4,2,7,6,3]</span><br><span class="hljs-function"><span class="hljs-title">bubbleSort</span><span class="hljs-params">(&amp;nums)</span></span><br></code></pre></td></tr></table></figure><h3 id="é¸¡å°¾é…’æ’åº"><a href="#é¸¡å°¾é…’æ’åº" class="headerlink" title="é¸¡å°¾é…’æ’åº"></a>é¸¡å°¾é…’æ’åº</h3><blockquote><p>é¸¡å°¾é…’æ’åºä¹Ÿå°±æ˜¯å®šå‘å†’æ³¡æ’åºï¼Œæ˜¯å†’æ³¡æ’åºçš„ä¸€ç§å˜å½¢ã€‚æ­¤æ¼”ç®—æ³•ä¸å†’æ³¡æ’åºçš„ä¸åŒå¤„åœ¨äºæ’åºæ—¶æ˜¯ä»¥åŒå‘åœ¨åºåˆ—ä¸­è¿›è¡Œæ’åºã€‚</p></blockquote><ol><li>å‰åŠè½®ï¼Œä»å‰å¾€åæ¯”è¾ƒç›¸é‚»ä¸¤ä¸ªå…ƒç´ ï¼Œå°†æœ€å¤§å…ƒç´ ç§»åˆ°æœ€å;</li><li>ååŠè½®ï¼Œä»å·²æ’å¥½åºå…ƒç´ çš„å‰ä¸€ä½å‘å‰ï¼Œæ¯”è¾ƒç›¸é‚»å…ƒç´ ï¼Œå°†æœ€å°å…ƒç´ ç§»åˆ°æœ€å‰;</li><li>åå¤æ‰§è¡Œ1.2ä¸¤æ­¥ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ éƒ½æ’åºå®Œã€‚</li></ol><p>#é¸¡å°¾é…’æ’åºçš„Swiftè¯­è¨€ç¤ºä¾‹ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">func cocktailSort(sourceArr <span class="hljs-built_in">array</span>: <span class="hljs-keyword">inout</span> [Int]) -&gt; Void<br>&#123;<br>    let n = <span class="hljs-built_in">array</span>.count<br>    var left = <span class="hljs-number">0</span><br>    var right = n - <span class="hljs-number">1</span><br>    <br>    <span class="hljs-keyword">while</span> left &lt; right &#123;<br>        <br>        <span class="hljs-comment">//å‰åŠè½® å°†æœ€å¤§å…ƒç´ ç§»åˆ°æœ€å</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> left ..&lt; right &#123;<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">array</span>[i] &gt; <span class="hljs-built_in">array</span>[i+<span class="hljs-number">1</span>]&#123;<br>                <span class="hljs-built_in">array</span>.swapAt(i, i+<span class="hljs-number">1</span>)<br>            &#125;<br>        &#125;<br>        right -= <span class="hljs-number">1</span><br>        <br>        <span class="hljs-comment">//ååŠè½® å°†æœ€å°å…ƒç´ ç§»åˆ°æœ€å‰</span><br>        <span class="hljs-keyword">if</span> left &lt; right &#123;<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> (left+<span class="hljs-number">1</span> ... right).reversed() &#123;<span class="hljs-comment">//ä»åå‘å‰éå†</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">array</span>[i<span class="hljs-number">-1</span>] &gt; <span class="hljs-built_in">array</span>[i]&#123;<br>                    <span class="hljs-built_in">array</span>.swapAt(i<span class="hljs-number">-1</span>, i)<br>                &#125;<br>            &#125;<br>            left += <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é€‰æ‹©æ’åº"><a href="#é€‰æ‹©æ’åº" class="headerlink" title="é€‰æ‹©æ’åº"></a>é€‰æ‹©æ’åº</h3><blockquote><p>é€‰æ‹©æ’åºä¹Ÿæ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯åœ¨åºåˆ—ä¸­æ‰¾åˆ°æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œæ”¾åˆ°åºåˆ—çš„èµ·å§‹ä½ç½®ä½œä¸ºå·²æ’åºåºåˆ—ï¼›ç„¶åï¼Œå†ä»å‰©ä½™æœªæ’åºå…ƒç´ ä¸­ç»§ç»­å¯»æ‰¾æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œæ”¾åˆ°å·²æ’åºåºåˆ—çš„æœ«å°¾ã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ å‡æ’åºå®Œæ¯•ã€‚</p></blockquote><p>#é€‰æ‹©æ’åºçš„Swiftè¯­è¨€ç¤ºä¾‹ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">func selectSort(sourceArr <span class="hljs-built_in">array</span>: <span class="hljs-keyword">inout</span> [Int]) -&gt; Void<br>&#123;<br>    let n = <span class="hljs-built_in">array</span>.count<br>    <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> ..&lt; n<span class="hljs-number">-1</span> &#123;<span class="hljs-comment">// iä¸ºå·²æ’åºåºåˆ—çš„æœ«å°¾</span><br>        var min = i<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> i+<span class="hljs-number">1</span> ..&lt; n &#123;<span class="hljs-comment">// æœªæ’åºåºåˆ—</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">array</span>[j] &lt; <span class="hljs-built_in">array</span>[min] &#123;<span class="hljs-comment">// æ‰¾å‡ºæœªæ’åºåºåˆ—ä¸­çš„æœ€å°å€¼</span><br>                min = j<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> min != i &#123;<br>            <span class="hljs-built_in">array</span>.swapAt(min, i)<span class="hljs-comment">// æ”¾åˆ°å·²æ’åºåºåˆ—çš„æœ«å°¾ï¼Œè¯¥æ“ä½œå¾ˆæœ‰å¯èƒ½æŠŠç¨³å®šæ€§æ‰“ä¹±ï¼Œæ‰€ä»¥é€‰æ‹©æ’åºæ˜¯ä¸ç¨³å®šçš„æ’åºç®—æ³•</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ’å…¥æ’åº"><a href="#æ’å…¥æ’åº" class="headerlink" title="æ’å…¥æ’åº"></a>æ’å…¥æ’åº</h3><blockquote><p>æ’å…¥æ’åºæ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†éå¸¸ç±»ä¼¼äºæŠ“æ‰‘å…‹ç‰Œï¼Œå¯¹äºæœªæ’åºæ•°æ®(å³æ‰‹æŠ“åˆ°çš„ç‰Œ)ï¼Œåœ¨å·²æ’åºåºåˆ—(å·¦æ‰‹å·²ç»æ’å¥½åºçš„æ‰‹ç‰Œ)ä¸­ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç›¸åº”ä½ç½®å¹¶æ’å…¥ã€‚</p></blockquote><p>æ’å…¥æ’åºåœ¨å®ç°ä¸Šï¼Œé€šå¸¸é‡‡ç”¨in-placeæ’åºï¼ˆå³åªéœ€ç”¨åˆ°O(1)çš„é¢å¤–ç©ºé—´çš„æ’åºï¼‰ï¼Œå› è€Œåœ¨ä»åå‘å‰æ‰«æè¿‡ç¨‹ä¸­ï¼Œéœ€è¦åå¤æŠŠå·²æ’åºå…ƒç´ é€æ­¥å‘åæŒªä½ï¼Œä¸ºæœ€æ–°å…ƒç´ æä¾›æ’å…¥ç©ºé—´ã€‚</p><ol><li>ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œè¯¥å…ƒç´ å¯ä»¥è®¤ä¸ºå·²ç»è¢«æ’åº</li><li>å–å‡ºä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨å·²ç»æ’åºçš„å…ƒç´ åºåˆ—ä¸­ä»åå‘å‰æ‰«æ</li><li>å¦‚æœè¯¥å…ƒç´ ï¼ˆå·²æ’åºï¼‰å¤§äºæ–°å…ƒç´ ï¼Œå°†è¯¥å…ƒç´ ç§»åˆ°ä¸‹ä¸€ä½ç½®</li><li>é‡å¤æ­¥éª¤3ï¼Œç›´åˆ°æ‰¾åˆ°å·²æ’åºçš„å…ƒç´ å°äºæˆ–è€…ç­‰äºæ–°å…ƒç´ çš„ä½ç½®</li><li>å°†æ–°å…ƒç´ æ’å…¥åˆ°è¯¥ä½ç½®å</li><li>é‡å¤æ­¥éª¤2~5</li></ol><p>#æ’å…¥æ’åºçš„Cè¯­è¨€ç¤ºä¾‹ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">InsertionSort</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> A[], <span class="hljs-built_in">int</span> n</span>)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> = A[i]; <span class="hljs-comment">// å³æ‰‹æŠ“åˆ°ä¸€å¼ æ‰‘å…‹ç‰Œ</span><br>        <span class="hljs-built_in">int</span> j = i - <span class="hljs-number">1</span>;  <span class="hljs-comment">// æ‹¿åœ¨å·¦æ‰‹ä¸Šçš„ç‰Œæ€»æ˜¯æ’åºå¥½çš„</span><br>        <span class="hljs-keyword">while</span> (j &gt;= <span class="hljs-number">0</span> &amp;&amp; A[j] &gt; <span class="hljs-keyword">get</span>) <span class="hljs-comment">//å°†å³æ‰‹æŠ“åˆ°çš„ç‰Œä¸å·¦æ‰‹æ‰‹ç‰Œä»å³å‘å·¦è¿›è¡Œæ¯”è¾ƒ</span><br>        &#123;<br>            A[j + <span class="hljs-number">1</span>] = A[j]; <span class="hljs-comment">//å¦‚æœè¯¥å·¦æ‰‹æ‰‹ç‰Œæ¯”å³æ‰‹æŠ“åˆ°çš„ç‰Œå¤§ï¼Œå°±å°†å…¶å³ç§»</span><br>            j--;<br>        &#125;<br>        A[j + <span class="hljs-number">1</span>] = <span class="hljs-keyword">get</span>; <span class="hljs-comment">//ç›´åˆ°è¯¥æ‰‹ç‰Œæ¯”å³æ‰‹æŠ“åˆ°çš„ç‰Œå°(æˆ–ç›¸ç­‰)ï¼Œå°†å³æ‰‹æŠ“åˆ°çš„ç‰Œæ’å…¥åˆ°è¯¥æ‰‹ç‰Œå³è¾¹</span><br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">main</span>()</span><br>&#123;<br>    <span class="hljs-built_in">int</span> A[] = &#123; <span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span> &#125;;<span class="hljs-comment">// ä»å°åˆ°å¤§æ’å…¥æ’åº</span><br>    <span class="hljs-built_in">int</span> n = <span class="hljs-keyword">sizeof</span>(A) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">int</span>);<br>    InsertionSort(A, n);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¿«é€Ÿæ’åºç®—æ³•"><a href="#å¿«é€Ÿæ’åºç®—æ³•" class="headerlink" title="å¿«é€Ÿæ’åºç®—æ³•"></a>å¿«é€Ÿæ’åºç®—æ³•</h3><blockquote><p>é€šè¿‡ä¸€è¶Ÿæ’åºå°†è¦æ’åºçš„æ•°æ®åˆ†å‰²æˆç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°æ®éƒ½æ¯”å¦å¤–ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°æ®éƒ½è¦å°ï¼Œç„¶åå†æŒ‰æ­¤æ–¹æ³•å¯¹è¿™ä¸¤éƒ¨åˆ†æ•°æ®åˆ†åˆ«è¿›è¡Œå¿«é€Ÿæ’åºï¼Œæ•´ä¸ªæ’åºè¿‡ç¨‹å¯ä»¥é€’å½’è¿›è¡Œï¼Œä»¥æ­¤è¾¾åˆ°æ•´ä¸ªæ•°æ®å˜æˆæœ‰åºåºåˆ—ã€‚</p></blockquote><p>è®¾è¦æ’åºçš„æ•°ç»„æ˜¯A[0]â€¦â€¦A[N-1]ï¼Œé¦–å…ˆä»»æ„é€‰å–ä¸€ä¸ªæ•°æ®ï¼ˆé€šå¸¸é€‰ç”¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªæ•°ï¼‰ä½œä¸ºå…³é”®æ•°æ®ï¼Œç„¶åå°†æ‰€æœ‰æ¯”å®ƒå°çš„æ•°éƒ½æ”¾åˆ°å®ƒå‰é¢ï¼Œæ‰€æœ‰æ¯”å®ƒå¤§çš„æ•°éƒ½æ”¾åˆ°å®ƒåé¢ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºä¸€è¶Ÿå¿«é€Ÿæ’åºã€‚</p><p>ä¸€è¶Ÿå¿«é€Ÿæ’åºçš„ç®—æ³•æ˜¯ï¼š</p><ol><li>è®¾ç½®ä¸¤ä¸ªå˜é‡iã€jï¼Œæ’åºå¼€å§‹çš„æ—¶å€™ï¼ši&#x3D;0ï¼Œj&#x3D;N-1ï¼›</li><li>ä»¥ç¬¬ä¸€ä¸ªæ•°ç»„å…ƒç´ ä½œä¸ºå…³é”®æ•°æ®ï¼Œèµ‹å€¼ç»™keyï¼Œå³key&#x3D;A[0]ï¼›</li><li>ä»jå¼€å§‹å‘å‰æœç´¢ï¼Œå³ç”±åå¼€å§‹å‘å‰æœç´¢(jâ€“)ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå°äºkeyçš„å€¼A[j]ï¼Œå°†A[j]å’ŒA[i]äº’æ¢ï¼›</li><li>ä»iå¼€å§‹å‘åæœç´¢ï¼Œå³ç”±å‰å¼€å§‹å‘åæœç´¢(i++)ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºkeyçš„A[i]ï¼Œå°†A[i]å’ŒA[j]äº’æ¢ï¼›</li><li>é‡å¤ç¬¬3ã€4æ­¥ï¼Œç›´åˆ°i&#x3D;jï¼› </li><li>ç„¶åï¼Œå¯¹keyä¸¤è¾¹çš„æ•°æ®ï¼Œå†åˆ†ç»„åˆ†åˆ«è¿›è¡Œä¸Šè¿°çš„è¿‡ç¨‹ï¼Œç›´åˆ°ä¸èƒ½å†åˆ†ç»„ä¸ºæ­¢ã€‚</li></ol><p>#å¿«é€Ÿæ’åºçš„Cè¯­è¨€ç¤ºä¾‹ï¼š</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">void</span> <span class="hljs-built_in">sort</span>(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right)<br>&#123;<br>    <span class="hljs-keyword">if</span>(left &gt;= right)&#123; <span class="hljs-comment">//å¦‚æœå·¦è¾¹ç´¢å¼•å¤§äºæˆ–è€…ç­‰äºå³è¾¹çš„ç´¢å¼•å°±ä»£è¡¨å·²ç»æ•´ç†å®Œæˆä¸€ä¸ªç»„äº†</span><br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    <span class="hljs-type">int</span> i = left;<br>    <span class="hljs-type">int</span> j = right;<br>    <span class="hljs-type">int</span> <span class="hljs-built_in">key</span> = a[left];<span class="hljs-comment">//1\2.é»˜è®¤å–æœ€å‰è¾¹çš„å€¼</span><br>     <br>    <span class="hljs-keyword">while</span>(i &lt; j) <span class="hljs-comment">//5.åœ¨å½“ç»„å†…å¯»æ‰¾</span><br>    &#123;<br>        <span class="hljs-comment">//3.ä»åå‘å‰æ‰¾ç¬¬ä¸€ä¸ªå°äºkeyçš„æ•°</span><br>        <span class="hljs-keyword">while</span>(i &lt; j &amp;&amp; a[j] &gt;= <span class="hljs-built_in">key</span>)<br>        &#123;<br>            j--;<span class="hljs-comment">//å‘å‰å¯»æ‰¾</span><br>        &#125;<br>        a[i] = a[j];<span class="hljs-comment">//æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„æ•°åå°±æŠŠå®ƒèµ‹ç»™å‰é¢çš„è¢«æ‹¿èµ°çš„içš„å€¼</span><br>        <br>        <span class="hljs-comment">//4.ä»å‰å‘åæ‰¾ç¬¬ä¸€ä¸ªå¤§äºkeyçš„æ•° </span><br>        <span class="hljs-keyword">while</span>(i &lt; j &amp;&amp; a[i] &lt;= <span class="hljs-built_in">key</span>)<br>        &#123;<br>            i++;<span class="hljs-comment">//å‘åå¯»æ‰¾</span><br>        &#125;<br>        a[j] = a[i];<br>    &#125;<br>    a[i] = <span class="hljs-built_in">key</span>;<span class="hljs-comment">//å½“åœ¨å½“ç»„å†…æ‰¾å®Œä¸€éä»¥åå°±æŠŠä¸­é—´æ•°keyå›å½’</span><br>    <br>    <span class="hljs-comment">//æœ€åç”¨åŒæ ·çš„æ–¹å¼å¯¹åˆ†å‡ºæ¥çš„å·¦è¾¹çš„å°ç»„è¿›è¡ŒåŒä¸Šçš„åšæ³•</span><br>    <span class="hljs-built_in">sort</span>(a, left, i - <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//ç”¨åŒæ ·çš„æ–¹å¼å¯¹åˆ†å‡ºæ¥çš„å³è¾¹çš„å°ç»„è¿›è¡ŒåŒä¸Šçš„åšæ³•</span><br>    <span class="hljs-built_in">sort</span>(a, i + <span class="hljs-number">1</span>, right);<br>    <span class="hljs-comment">//æœ€åå¯èƒ½ä¼šå‡ºç°å¾ˆå¤šåˆ†å·¦å³ï¼Œç›´åˆ°æ¯ä¸€ç»„çš„ i = j ä¸ºæ­¢ã€‚</span><br></code></pre></td></tr></table></figure><p>æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•ï¼Œå¯¹æ•°ç»„ {49ï¼Œ38ï¼Œ65ï¼Œ97ï¼Œ76ï¼Œ13ï¼Œ27} è¿›è¡Œå¿«é€Ÿæ’åºï¼š</p><ul><li>è¿›è¡Œä¸€æ¬¡å¿«é€Ÿæ’åºä¹‹åï¼Œæ•°ç»„è¢«åˆ’åˆ†ä¸º {27ï¼Œ38ï¼Œ13} 49 {76ï¼Œ97ï¼Œ65}å‰åä¸¤éƒ¨åˆ†ã€‚49ä¹‹å‰çš„æ‰€æœ‰æ•°éƒ½æ¯”å®ƒå°ï¼Œ49ä¹‹åçš„æ‰€æœ‰æ•°éƒ½æ¯”å®ƒå¤§ï¼›</li><li>åˆ†åˆ«å¯¹å‰åä¸¤éƒ¨åˆ†è¿›è¡Œå¿«é€Ÿæ’åºï¼š{27ï¼Œ38ï¼Œ13} ç»ç¬¬ä¸‰æ­¥å’Œç¬¬å››æ­¥äº¤æ¢åå˜æˆ {13ï¼Œ27ï¼Œ38} å®Œæˆæ’åºã€‚</li><li>{76ï¼Œ97ï¼Œ65} ç»ç¬¬ä¸‰æ­¥å’Œç¬¬å››æ­¥äº¤æ¢åå˜æˆ {65ï¼Œ76ï¼Œ97} å®Œæˆæ’åºã€‚</li><li>æœ€ç»ˆæ’åºç»“æœä¸ºï¼š{13ï¼Œ27ï¼Œ38ï¼Œ65ï¼Œ76ï¼Œ97}ã€‚</li></ul><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="http://www.cnblogs.com/eniac12/p/5329396.html">Â©SteveWang-å¸¸ç”¨æ’åºç®—æ³•æ€»ç»“(ä¸€)</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swift-@objc\@objcMember\dynamic</title>
    <link href="/2018/09/15/swift-dynamic.html"/>
    <url>/2018/09/15/swift-dynamic.html</url>
    
    <content type="html"><![CDATA[<h4 id="1-objc"><a href="#1-objc" class="headerlink" title="1.@objc"></a>1.@objc</h4><p>å°†Swiftä¸­çš„å…ƒç´ æš´éœ²ç»™OCè¿è¡Œæ—¶ï¼Œä»¥ä¾¿åœ¨OCä¸­è°ƒç”¨Swiftä»£ç ã€‚</p><p>å¸¸è§çš„ï¼Œå¦‚Swiftä¸­ç»™æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶æ—¶ï¼Œéœ€è¦ç»™selectoræ·»åŠ @objcæ ‡è®°ã€‚å› ä¸ºSELæ˜¯OCè¿è¡Œæ—¶ä¸­çš„ç‰¹æ€§ï¼Œruntimeæ ¹æ®SELæŸ¥æ‰¾å‡½æ•°çš„å®ç°ã€‚è¦å°†æŒ‰é’®å›è°ƒå‡½æ•°æš´éœ²ç»™OCè¿è¡Œæ—¶ï¼Œéœ€è¦å°†å…¶æ ‡è®°ä¸º<code>@objc</code>ï¼Œä»è€Œè®©OCè¿è¡Œæ—¶è¿›è¡Œæ¶ˆæ¯æ´¾å‘ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>: <span class="hljs-title class_">UIViewController</span> &#123;<br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() &#123;<br>        <span class="hljs-keyword">let</span> btn <span class="hljs-operator">=</span> <span class="hljs-type">UIButton</span>.<span class="hljs-keyword">init</span>(type: .custom)<br>        btn.addTarget(<span class="hljs-keyword">self</span>, action: <span class="hljs-keyword">#selector</span>(btnCallback), for: .touchUpInside)<br>    &#125;<br>    <br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">btnCallback</span>()&#123;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>OCå·¥ç¨‹ä¸­è°ƒç”¨Swiftä»£ç æ—¶ï¼Œä¹Ÿéœ€è¦å°†Swiftä»£ç æ ‡è®°ä¸º@objcï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">// OCä¸­å®šä¹‰SWiftç±» ç¼–è¯‘åä¼šç”Ÿæˆâ€å·¥ç¨‹å-Swift.hâ€œå¤´æ–‡ä»¶ï¼Œé‡Œé¢åŒ…æ‹¬äº†è‡ªåŠ¨ç”Ÿæˆçš„OCç‰ˆä»£ç </span><br><span class="hljs-keyword">import</span> Foundation<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SwiftFile</span> : <span class="hljs-title class_">NSObject</span> &#123;<br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">var</span> name : <span class="hljs-type">String</span>?<br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">let</span> nick : <span class="hljs-type">String</span><br>    <br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>:<span class="hljs-type">String</span>,<span class="hljs-params">nick</span>:<span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name<br>        <span class="hljs-keyword">self</span>.nick <span class="hljs-operator">=</span> nick<br>        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()<br>    &#125;<br>    <br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">swiftInstanceMethod</span>(<span class="hljs-params">name</span>:<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">String</span> &#123;<br>        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;name is:<span class="hljs-subst">\(name)</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">func</span> <span class="hljs-title class_">swiftClassMethod</span>(<span class="hljs-title class_">nick</span>:<span class="hljs-title class_">String</span>) -&gt; <span class="hljs-title class_">String</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;nick is:<span class="hljs-subst">\(nick)</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> nick<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// OCå·¥ç¨‹å¼•ç”¨swiftä»£ç </span><br>#<span class="hljs-keyword">import</span> &quot;AppDelegate.h&quot;<br>#<span class="hljs-keyword">import</span> &quot;ASDF-Swift.h&quot; <span class="hljs-comment">//å¯¼å…¥ swift æ–‡ä»¶å¯¹åº”çš„ OC ç‰ˆå¤´æ–‡ä»¶</span><br><br><span class="hljs-meta">@implementation</span> <span class="hljs-type">AppDelegate</span><br><br><span class="hljs-operator">-</span> (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-type">UIApplication</span> <span class="hljs-operator">*</span>)application<br>didFinishLaunchingWithOptions:(<span class="hljs-type">NSDictionary</span> <span class="hljs-operator">*</span>)launchOptions<br>&#123;<br>    <span class="hljs-type">SwiftFile</span> <span class="hljs-operator">*</span>sf <span class="hljs-operator">=</span> [[<span class="hljs-type">SwiftFile</span> alloc] initWithName:@<span class="hljs-string">&quot;swift&quot;</span> nick:@<span class="hljs-string">&quot;sf&quot;</span>];<br>    sf.name <span class="hljs-operator">=</span> @<span class="hljs-string">&quot;Swift4.1&quot;</span>;<br>    [sf swiftInstanceMethodWithName:@<span class="hljs-string">&quot;Hello&quot;</span>];<br>    [<span class="hljs-type">SwiftFile</span> swiftClassMethodWithNick:@<span class="hljs-string">&quot;newNick&quot;</span>];<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-type">YES</span>;<br>&#125;<br><span class="hljs-meta">@end</span><br></code></pre></td></tr></table></figure><h4 id="2-objcMember"><a href="#2-objcMember" class="headerlink" title="2.@objcMember"></a>2.@objcMember</h4><p>æ ‡è®°Swiftä¸­çš„ç±»ï¼Œå°†å…¶æ‰€æœ‰å…ƒç´ éƒ½æš´éœ²ç»™OCï¼Œç­‰åŒäºä¸ºæ‰€æœ‰å…ƒç´ åŠ ä¸Š<code>@objc</code>ã€‚</p><p>æ³¨æ„ï¼šè¿™äº›å…ƒç´ ä¸åŒ…æ‹¬Swiftç‹¬æœ‰è€ŒOCä¸­æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„å…ƒç´ ç±»å‹ï¼Œå¦‚Tupleã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">@objc</span>Members<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> : <span class="hljs-title class_">NSObject</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">eat</span>() &#123; &#125; <span class="hljs-comment">// éšå¼æ·»åŠ äº† @objc</span><br>    <br>    <span class="hljs-comment">// ä¸ä¼šæ·»åŠ  @objc, å› ä¸ºOCä¸­æ²¡æœ‰å…ƒç»„</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">drink</span>() -&gt; (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>)<span class="hljs-operator">?</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>&#125;<br> <br><span class="hljs-keyword">extension</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">call</span>() &#123; &#125;   <span class="hljs-comment">// éšå¼æ·»åŠ äº† @objc</span><br>&#125;<br> <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> : <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">miao</span>() &#123; &#125;   <span class="hljs-comment">// éšå¼æ·»åŠ äº† @objc</span><br>&#125;<br> <br><span class="hljs-keyword">extension</span> <span class="hljs-title class_">Cat</span> &#123;<br>  <span class="hljs-keyword">func</span> <span class="hljs-title function_">paw</span>() &#123; &#125;   <span class="hljs-comment">// éšå¼æ·»åŠ äº† @objc</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºä½•æœ‰è¿™ä¸ªå…³é”®å­—å‘¢ï¼ŸSwift3åŠå…¶ä¹‹å‰ç‰ˆæœ¬ä¸­ç»§æ‰¿è‡ªNSObjectçš„ç±»ï¼Œç¼–è¯‘å™¨ä¼šç»™æ‰€æœ‰çš„éprivateç±»åŠå…¶æˆå‘˜åŠ ä¸Š@objcã€‚swift4ä¹‹åè‹¹æœä¸å†é»˜è®¤è¿™ä¹ˆåšï¼Œä½†æä¾›äº†@objcMemberå…³é”®å­—ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆï¼Œç»™è¢«å…¶æ ‡è®°çš„ç±»åŠå…¶æˆå‘˜æ·»åŠ @objcå…³é”®å­—ã€‚</p><h4 id="3-dynamic"><a href="#3-dynamic" class="headerlink" title="3.dynamic"></a>3.dynamic</h4><p>æ ‡è®°ç±»çš„æˆå‘˜ï¼Œä½¿å…¶å±æ€§æ–¹æ³•ç­‰è¿›è¡ŒåŠ¨æ€æ´¾å‘ã€‚</p><p>è¢«æ ‡è®°ä¸º@objcçš„å…ƒç´ ä¸ä¸€å®šä¼šå˜æˆåŠ¨æ€æ´¾å‘ï¼ŒSwiftä¾ç„¶å¯èƒ½ä¼šå°†å…¶ä¼˜åŒ–ä¸ºé™æ€è°ƒç”¨ã€‚å¦‚æœåœ¨Swiftä¸­ç¡®å®éœ€è¦ç”¨åˆ°åŠ¨æ€æ´¾å‘æœºåˆ¶ï¼Œæ¯”å¦‚KVOæˆ–è€…æ–¹æ³•äº¤æ¢ç­‰ç‰¹æ€§æ—¶ï¼Œåˆ™éœ€è¦å°†å…¶æ ‡è®°ä¸º dynamicã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">People</span>: <span class="hljs-title class_">NSObject</span> &#123;  <span class="hljs-comment">//éœ€è¦ç»§æ‰¿è‡ªNSObject</span><br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">dynamic</span> <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment">//@objcåœ¨Swift4ä¹‹åå¿…é¡»è¦æ·»åŠ </span><br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">dynamic</span> <span class="hljs-keyword">var</span> age <span class="hljs-operator">=</span> <span class="hljs-number">20</span><br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> &#123;<br><br>    <span class="hljs-keyword">let</span> p <span class="hljs-operator">=</span> <span class="hljs-type">People</span>.<span class="hljs-keyword">init</span>()<br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() &#123;<br>        p.addObserver(<span class="hljs-keyword">self</span>, forKeyPath: <span class="hljs-keyword">#keyPath</span>(<span class="hljs-type">People</span>.name), options: [.new], context: <span class="hljs-literal">nil</span>)<br>        p.addObserver(<span class="hljs-keyword">self</span>, forKeyPath: <span class="hljs-string">&quot;age&quot;</span>, options: [.new], context: <span class="hljs-literal">nil</span>)<br>    &#125;<br>    <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewWillAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) &#123;<br>        p.name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;kitt&quot;</span><br>        p.age <span class="hljs-operator">=</span> <span class="hljs-number">21</span><br>    &#125;<br>    <br>    <span class="hljs-comment">//ç›‘å¬å›è°ƒ</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">observeValue</span>(<span class="hljs-params">forKeyPath</span> <span class="hljs-params">keyPath</span>: <span class="hljs-type">String</span>?, <span class="hljs-params">of</span> <span class="hljs-params">object</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>, <span class="hljs-params">change</span>: [<span class="hljs-params">NSKeyValueChangeKey</span> : <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>, <span class="hljs-params">context</span>: <span class="hljs-type">UnsafeMutableRawPointer</span>?) &#123;<br>        <span class="hljs-keyword">if</span> keyPath <span class="hljs-operator">==</span> <span class="hljs-string">&quot;name&quot;</span> &#123;<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;new Name:<span class="hljs-subst">\(change<span class="hljs-operator">!</span>[NSKeyValueChangeKey.newKey] <span class="hljs-operator">??</span> <span class="hljs-string">&quot;Default&quot;</span>)</span>&quot;</span>)<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> keyPath <span class="hljs-operator">==</span> <span class="hljs-string">&quot;age&quot;</span> &#123;<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;new age:<span class="hljs-subst">\(change<span class="hljs-operator">!</span>[NSKeyValueChangeKey.newKey] <span class="hljs-operator">??</span> <span class="hljs-string">&quot;Default&quot;</span>)</span>&quot;</span>)<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">deinit</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Deinit&quot;</span>)<br>        p.removeObserver(<span class="hljs-keyword">self</span>, forKeyPath: <span class="hljs-string">&quot;name&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœPeopleç±»ä¸­å»æ‰dynamicå…³é”®å­—ï¼Œåˆ™ç»™å±æ€§èµ‹å€¼æ—¶<code>p.age = 21</code>ä¸ä¼šè§¦å‘ç›‘å¬çš„å›è°ƒã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swifté«˜é˜¶å‡½æ•°</title>
    <link href="/2018/09/14/swift-map.html"/>
    <url>/2018/09/14/swift-map.html</url>
    
    <content type="html"><![CDATA[<h4 id="1-map"><a href="#1-map" class="headerlink" title="1.map"></a>1.map</h4><p>éå†é›†åˆå¹¶å¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä»è€Œå°†å…ƒç´ æ˜ å°„æˆæ–°å€¼å¹¶æ”¾åœ¨<code>æ•°ç»„</code>ä¸­è¿”å›ï¼Œæ–°å€¼å¯ä»¥æ˜¯åŸç±»å‹ä¹Ÿå¯ä»¥æ˜¯<code>æ–°çš„ç±»å‹</code>ã€‚</p><ul><li>å¯¹æ•°ç»„</li></ul><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs maxima">//å°†å…ƒç´ æ˜ å°„æˆ<span class="hljs-built_in">string</span>ç±»å‹<br><span class="hljs-built_in">let</span> intArr = [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]<br><span class="hljs-built_in">let</span> newArr = intArr.<span class="hljs-built_in">map</span> &#123; <span class="hljs-string">&quot;\($0)&quot;</span> &#125;<br><span class="hljs-built_in">print</span>(newArr)  //æ‰“å°ç»“æœï¼š[<span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>]<br></code></pre></td></tr></table></figure><ul><li>å¯¹set</li></ul><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs maxima">//å°†å…ƒç´ +<span class="hljs-number">1</span>å¹¶æ˜ å°„æˆ<span class="hljs-built_in">string</span>ç±»å‹<br><span class="hljs-built_in">let</span> intSet = [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]<br><span class="hljs-built_in">let</span> newSet = intSet.<span class="hljs-built_in">map</span> &#123; (e) -&gt; String <span class="hljs-keyword">in</span><br>    <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;\(e+1)&quot;</span><br>&#125;<br><span class="hljs-built_in">print</span>(newSet)  //æ‰“å°ç»“æœï¼š[<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>]<br></code></pre></td></tr></table></figure><ul><li>å¯¹å­—å…¸</li></ul><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs maxima"><span class="hljs-built_in">let</span> dic = [<span class="hljs-string">&quot;a&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;b&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;c&quot;</span>:<span class="hljs-number">2</span>]<br>//<span class="hljs-number">1</span>.å°†valueæ˜ å°„æˆ<span class="hljs-built_in">string</span>ç±»å‹<br><span class="hljs-built_in">let</span> arr1 = dic.<span class="hljs-built_in">map</span> &#123; (<span class="hljs-built_in">key</span>: String, value: Int) <span class="hljs-keyword">in</span><br>    <span class="hljs-built_in">return</span> [<span class="hljs-built_in">key</span>,<span class="hljs-string">&quot;\(value)&quot;</span>] <br>&#125;<br>//<span class="hljs-number">2</span>.å–valueå¹¶å°†å…¶æ˜ å°„æˆ<span class="hljs-built_in">string</span>ç±»å‹<br><span class="hljs-built_in">let</span> arr2 = dic.<span class="hljs-built_in">map</span> &#123; (<span class="hljs-built_in">key</span>: String, value: Int) <span class="hljs-keyword">in</span><br>    <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;\(value)&quot;</span><br>&#125;<br><span class="hljs-built_in">print</span>(arr1)  //æ‰“å°ç»“æœï¼š[[<span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>], [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>], [<span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>]]<br><span class="hljs-built_in">print</span>(arr2)  //æ‰“å°ç»“æœï¼š[<span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>]<br></code></pre></td></tr></table></figure><h4 id="2-flatMap"><a href="#2-flatMap" class="headerlink" title="2.flatMap"></a>2.flatMap</h4><p>åŠŸèƒ½1ï¼šä¸<code>map</code>ç±»ä¼¼ï¼Œéå†é›†åˆä¸­çš„å…ƒç´ å°†å…¶æ˜ å°„ä¸ºæ–°å€¼å¹¶ä»¥æ•°ç»„å½¢å¼è¿”å›ã€‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">let</span> intAra =<span class="hljs-meta"> [0,1,2,3,4,5]</span><br><span class="hljs-attribute">let</span> r0 = intAra.map &#123; $<span class="hljs-number">0</span>+<span class="hljs-number">1</span>&#125;<br><span class="hljs-attribute">let</span> r1 = intAra.flatMap &#123; $<span class="hljs-number">0</span>+<span class="hljs-number">1</span>&#125;<br><span class="hljs-attribute">print</span>(r0) //æ‰“å°ï¼š[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<br><span class="hljs-attribute">print</span>(r1) //æ‰“å°ï¼š[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<br></code></pre></td></tr></table></figure><p>åŠŸèƒ½2ï¼šflatMapèƒ½å¯¹å¤šç»´æ•°ç»„è¿›è¡Œé™ç»´ï¼Œè¿”å›ä¸€ç»´æ•°ç»„ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua">let lv2Arr = <span class="hljs-string">[[1,2,3],[4,5,6]]</span>;<br>var result0 = lv2Arr.map &#123; $<span class="hljs-number">0.</span>map&#123; $<span class="hljs-number">0</span> + <span class="hljs-number">2</span> &#125; &#125;<br>var result1 = lv2Arr.flatMap &#123; $<span class="hljs-number">0.</span>map&#123; $<span class="hljs-number">0</span> + <span class="hljs-number">2</span> &#125; &#125;<br><span class="hljs-built_in">print</span>(result0) //<span class="hljs-string">[[3, 4, 5], [6, 7, 8]]</span>  -&gt;è¿”å›çš„è¿˜æ˜¯äºŒç»´æ•°ç»„<br><span class="hljs-built_in">print</span>(result1) //[<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]      -&gt;è¿”å›çš„æ˜¯ä¸€ç»´æ•°ç»„<br></code></pre></td></tr></table></figure><p>åŠŸèƒ½3ï¼šå¯¹é›†åˆä¸­çš„å¯é€‰ç±»å‹è¿›è¡Œæ‹†åŒ…ï¼Œä¸”åªæœ‰æ‹†åŒ…æˆåŠŸçš„å…ƒç´ æ‰ä¼šåœ¨ç»“æœä¸­è¿”å›ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">let a:String? = <span class="hljs-string">&quot;opt&quot;</span>     <span class="hljs-regexp">//</span>å¯é€‰ç±»å‹<br>let arr = [<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,nil,a] <span class="hljs-regexp">//</span>åŒ…å«nilä¸å¯é€‰<br>let map = arr.map&#123; <span class="hljs-variable">$0</span> &#125;<br>let flatMap = arr.flatMap&#123; <span class="hljs-variable">$0</span> &#125;<br>print(map)     <span class="hljs-regexp">//</span>[Optional(<span class="hljs-string">&quot;a&quot;</span>), Optional(<span class="hljs-string">&quot;b&quot;</span>), nil, Optional(<span class="hljs-string">&quot;opt&quot;</span>)]<br>print(flatMap) <span class="hljs-regexp">//</span>[<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;opt&quot;</span>]  -&gt;å¯é€‰æ‹†åŒ…ï¼Œä¸”nilè¢«è¿‡æ»¤æ‰<br></code></pre></td></tr></table></figure><h4 id="3-filter"><a href="#3-filter" class="headerlink" title="3.filter"></a>3.filter</h4><p>éå†é›†åˆä¸­çš„å…ƒç´ ï¼Œå°†ç¬¦åˆæŸä¸ªæ¡ä»¶çš„å…ƒç´ ç»„åˆæˆæ–°çš„æ•°ç»„å¹¶è¿”å›ã€‚</p><ul><li>å¯¹æ•°ç»„</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">//å–é›†åˆä¸­å¤§äº0çš„å…ƒç´ </span><br>let intArr = <span class="hljs-selector-attr">[0,1,2]</span><br>let aArr = intArr<span class="hljs-selector-class">.filter</span> &#123; value -&gt; Bool <span class="hljs-keyword">in</span><br>    return value &gt; <span class="hljs-number">0</span><br>&#125;<br>let bArr = intArr.<span class="hljs-attribute">filter</span>&#123; $<span class="hljs-number">0</span> &gt; <span class="hljs-number">0</span> &#125; //å°¾éšé—­åŒ…çš„å†™æ³•<br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(aArr)</span></span> <span class="hljs-comment">//æ‰“å°ç»“æœï¼š[1, 2]</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(bArr)</span></span> <span class="hljs-comment">//æ‰“å°ç»“æœï¼š[1, 2]</span><br></code></pre></td></tr></table></figure><ul><li>å¯¹å­—å…¸</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">//å–é›†åˆä¸­å¤§äº0çš„å…ƒç´ </span><br>let dic0 = <span class="hljs-selector-attr">[<span class="hljs-string">&quot;a&quot;</span>:0,<span class="hljs-string">&quot;b&quot;</span>:1,<span class="hljs-string">&quot;c&quot;</span>:2]</span><br>let dic1 = dic0<span class="hljs-selector-class">.filter</span> &#123; (key: String, value: Int) <span class="hljs-keyword">in</span><br>    return value &gt; <span class="hljs-number">0</span><br>&#125;<br>let dic2 = dic0<span class="hljs-selector-class">.filter</span> &#123; $<span class="hljs-number">0</span><span class="hljs-selector-class">.value</span> &gt; <span class="hljs-number">0</span> &#125;  <span class="hljs-comment">//å°¾éšé—­åŒ…çš„å†™æ³•</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(dic1)</span></span> <span class="hljs-comment">//æ‰“å°ç»“æœï¼š[&quot;c&quot;: 2, &quot;b&quot;: 1]</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(dic2)</span></span> <span class="hljs-comment">//æ‰“å°ç»“æœï¼š[&quot;c&quot;: 2, &quot;b&quot;: 1]</span><br></code></pre></td></tr></table></figure><h4 id="4-reduce"><a href="#4-reduce" class="headerlink" title="4.reduce"></a>4.reduce</h4><p>éå†é›†åˆæŠŠæ‰€æœ‰å…ƒç´ ç»„åˆèµ·æ¥ï¼Œè®¡ç®—æˆä¸€ä¸ªæ–°å€¼å¹¶è¿”å›ã€‚<code>reduce</code>å¯æ¥æ”¶ä¸€ä¸ªåˆå§‹å€¼ã€‚</p><ul><li>å¯¹æ•°ç»„</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>è®¡ç®—æ‰€æœ‰å…ƒç´ çš„å’Œ<br>let numbers = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]<br>let sum0 = numbers.reduce(<span class="hljs-number">0</span>) &#123; (x,y) <span class="hljs-keyword">in</span><br>    <span class="hljs-regexp">//</span>print(<span class="hljs-string">&quot;\(x),\(y)&quot;</span>)<br>    return (x + y)<br>&#125;<br><span class="hljs-regexp">//</span>åˆå§‹å€¼ä¸º<span class="hljs-number">1</span>ï¼Œè®¡ç®—å…ƒç´ çš„å’Œ<br>let sum1 = numbers.reduce(<span class="hljs-number">1</span>) &#123; <span class="hljs-variable">$0</span>+<span class="hljs-variable">$1</span> &#125; <span class="hljs-regexp">//</span>å°¾éšé—­åŒ…çš„å†™æ³•<br>print(sum0) <span class="hljs-regexp">//</span>æ‰“å°ï¼š<span class="hljs-number">10</span><br>print(sum1) <span class="hljs-regexp">//</span>æ‰“å°ï¼š<span class="hljs-number">11</span><br><br><span class="hljs-regexp">//</span>å¯¹äºsum0ï¼Œå…¶è®¡ç®—è¿‡ç¨‹ä¸ºï¼š<br><span class="hljs-number">1</span>.åˆå§‹å€¼ä¸º<span class="hljs-number">0</span>ï¼Œxä¸º<span class="hljs-number">0</span>ï¼Œyä¸º<span class="hljs-number">1</span> -&gt; è¿”å› x + y ã€‚æ‰€ä»¥åˆå§‹å€¼æˆ–è€…ç»“æœå˜ä¸º <span class="hljs-number">1</span>ã€‚<br><span class="hljs-number">2</span>.åˆå§‹å€¼æˆ–è€…ç»“æœå˜ä¸º <span class="hljs-number">1</span>ï¼Œxä¸º<span class="hljs-number">1</span>ï¼Œyä¸º<span class="hljs-number">2</span> -&gt; è¿”å› x + y ã€‚æ‰€ä»¥åˆå§‹å€¼æˆ–è€…ç»“æœå˜ä¸º <span class="hljs-number">3</span>ã€‚<br><span class="hljs-number">3</span>.åˆå§‹å€¼æˆ–è€…ç»“æœå˜ä¸º <span class="hljs-number">3</span>ï¼Œxä¸º<span class="hljs-number">3</span>ï¼Œyä¸º<span class="hljs-number">3</span> -&gt; è¿”å› x + y ã€‚æ‰€ä»¥åˆå§‹å€¼æˆ–è€…ç»“æœå˜ä¸º <span class="hljs-number">6</span>ã€‚<br><span class="hljs-number">4</span>.åˆå§‹å€¼æˆ–è€…ç»“æœå˜ä¸º <span class="hljs-number">6</span>ï¼Œxä¸º<span class="hljs-number">6</span>ï¼Œyä¸º<span class="hljs-number">4</span> -&gt; è¿”å› x + y ã€‚æ‰€ä»¥åˆå§‹å€¼æˆ–è€…ç»“æœå˜ä¸º <span class="hljs-number">10</span>ã€‚<br></code></pre></td></tr></table></figure><ul><li>å¯¹å­—å…¸</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">let dic0 = <span class="hljs-selector-attr">[<span class="hljs-string">&quot;a&quot;</span>:0,<span class="hljs-string">&quot;b&quot;</span>:1,<span class="hljs-string">&quot;c&quot;</span>:2,<span class="hljs-string">&quot;d&quot;</span>:4]</span><br>let reduce = dic0<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">0</span>) &#123; (result, dic) <span class="hljs-keyword">in</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\(result),\(dic.key),\(dic.value)&quot;</span>)<br>    return result + dic<span class="hljs-selector-class">.value</span><br>&#125;<br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(reduce)</span></span> <span class="hljs-comment">//æ‰“å°ï¼š7</span><br><br><span class="hljs-comment">//å–æ¶ˆæ³¨é‡ŠæŸ¥çœ‹reduceçš„è®¡ç®—è¿‡ç¨‹ï¼š</span><br><span class="hljs-number">0</span>,d,<span class="hljs-number">4</span><br><span class="hljs-number">4</span>,<span class="hljs-selector-tag">b</span>,<span class="hljs-number">1</span><br><span class="hljs-number">5</span>,<span class="hljs-selector-tag">a</span>,<span class="hljs-number">0</span><br><span class="hljs-number">5</span>,c,<span class="hljs-number">2</span><br><span class="hljs-number">7</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swift ä¸­çš„å¸¸è§é—®é¢˜</title>
    <link href="/2018/09/13/swift-faq.html"/>
    <url>/2018/09/13/swift-faq.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-Struct-ä¸-Class"><a href="#1-Struct-ä¸-Class" class="headerlink" title="1.Struct ä¸ Class"></a>1.Struct ä¸ Class</h3><p>ç›¸åŒç‚¹ï¼š</p><ul><li>å®šä¹‰å±æ€§å’Œæ–¹æ³•ï¼›</li><li>ä½¿ç”¨ä¸‹æ ‡è¯­æ³•<code>subscript syntax</code>ï¼›</li><li>å®šä¹‰åˆå§‹åŒ–å™¨è®¾ç½®åˆå§‹çŠ¶æ€ï¼›</li><li>æ·»åŠ æ‰©å±•ã€å®ç°åè®®ï¼›</li></ul><p>class ç‹¬æœ‰çš„ç‰¹æ€§ï¼š</p><ul><li>ç»§æ‰¿</li><li>ç±»å‹è½¬æ¢<code>Type casting</code></li><li>ææ„</li><li>class çš„å®ä¾‹å¯è¢«å¤šä¸ªå¯¹è±¡å¼•ç”¨</li></ul><p>æœ€å¤§çš„ä¸åŒï¼šstruct æ˜¯å€¼ç±»å‹ï¼Œclass æ˜¯å¼•ç”¨ç±»å‹ã€‚</p><h3 id="2-æ¯”è¾ƒç¬¦ï¼š-ä¸"><a href="#2-æ¯”è¾ƒç¬¦ï¼š-ä¸" class="headerlink" title="2.æ¯”è¾ƒç¬¦ï¼š==ä¸==="></a>2.æ¯”è¾ƒç¬¦ï¼š<code>==</code>ä¸<code>===</code></h3><blockquote><p>Note that identical to (represented by three equals signs, or &#x3D;&#x3D;&#x3D;) doesnâ€™t mean the same thing as equal to (represented by two equals signs, or &#x3D;&#x3D;). Identical to means that two constants or variables of class type refer to exactly the same class instance. Equal to means that two instances are considered equal or equivalent in value, for some appropriate meaning of equal, as defined by the typeâ€™s designer.</p></blockquote><blockquote><p>When you define your own custom structures and classes, itâ€™s your responsibility to decide what qualifies as two instances being equal. </p></blockquote><ul><li><code>===</code>è¡¨ç¤ºä¸¤ä¸ªå®ä¾‹å¼•ç”¨äº†ç›¸åŒçš„å¯¹è±¡ï¼Œå¼ºè°ƒâ€œå¼•ç”¨â€ç›¸åŒï¼›</li><li><code>==</code> è¡¨ç¤ºä¸¤ä¸ªå®ä¾‹ä¸­çš„å€¼â€œç›¸ç­‰â€ï¼Œè‡³äºå“ªäº›å€¼ç›¸ç­‰ï¼Œéœ€è¦è‡ªå·±åœ¨ç±»ä¸­å®šä¹‰ï¼›</li></ul><p>2.1ã€è‡ªå®šä¹‰ç±»æ—¶ï¼Œå®ç°<code>Equatable</code>åè®®å¹¶é‡å†™å…¨å±€æ“ä½œç¬¦<code>==</code>æ¥å†³å®šä¸¤ä¸ªæ“ä½œæ•°æ˜¯å¦ç›¸ç­‰ã€‚</p><p>#ç¤ºä¾‹1</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>:Equatable &#123;<br>    <br>    <span class="hljs-keyword">var</span> name: <span class="hljs-built_in">String</span>?<br>    <br>    <span class="hljs-keyword">static</span> func ==<span class="hljs-function"><span class="hljs-params">(lhs:Cat, rhs:Cat)</span> -&gt;</span> Bool &#123;<br>        <span class="hljs-keyword">if</span> lhs.name == rhs.name&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨å¹¶æ‰“å°ç»“æœï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">let cat1 = <span class="hljs-built_in">Cat</span>()<br>let cat2 = <span class="hljs-built_in">Cat</span>()<br>cat1<span class="hljs-selector-class">.name</span> = <span class="hljs-string">&quot;Miao&quot;</span><br>cat2<span class="hljs-selector-class">.name</span> = <span class="hljs-string">&quot;Miao&quot;</span><br><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(cat1 == cat2)</span></span> <span class="hljs-comment">//true</span><br></code></pre></td></tr></table></figure><p>2.2ã€æ³¨æ„ï¼Œ<code>===</code>çš„å·¦å³ä¸¤ä¸ªæ“ä½œæ•°å¿…é¡»æ˜¯ç±»çš„å®ä¾‹ï¼Œå¯¹æšä¸¾æˆ–ç»“æ„ä½“åŠå…¶å˜ç§ï¼ˆStringã€Arrayã€Dictionaryï¼‰ç­‰ä½¿ç”¨æ—¶ä¼šæŠ¥é”™ã€‚</p><h3 id="3-å±æ€§çš„ä¿®é¥°ç¬¦"><a href="#3-å±æ€§çš„ä¿®é¥°ç¬¦" class="headerlink" title="3.å±æ€§çš„ä¿®é¥°ç¬¦"></a>3.å±æ€§çš„ä¿®é¥°ç¬¦</h3><h4 id="3-1-å¼ºå¼±"><a href="#3-1-å¼ºå¼±" class="headerlink" title="3.1.å¼ºå¼±"></a>3.1.å¼ºå¼±</h4><p>Swift é‡Œå±æ€§é»˜è®¤æ˜¯å¼ºç±»å‹çš„ï¼ŒOC ä¸­<code>strong</code>å±æ€§åœ¨ Swift ä¸­ä¼šè½¬æ¢ä¸º<code>å­˜å‚¨å±æ€§</code>ã€‚</p><p>Swift ä¸­çš„<code>weak</code>å¯¹åº” OC ä¸­çš„<code>weak</code>ï¼Œä»…èƒ½ä¿®é¥°å¼•ç”¨ç±»å‹çš„å±æ€§ï¼Œä¸èƒ½ä¿®é¥°<code>String</code>ã€<code>Int</code>ç­‰å€¼ç±»å‹å±æ€§ï¼ˆå®ƒä»¬å®è´¨ä¸Šæ˜¯ç»“æ„ä½“ï¼‰ï¼›</p><p>å¦å¤–ï¼Œ<code>weak</code>ä¿®é¥°çš„å±æ€§å¿…é¡»æ˜¯ optional å¯¹è±¡ç±»å‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™â€œâ€™weakâ€™ variable should have optional type â€˜xxClass?â€™â€ã€‚</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> ani:Animal?<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œweak ä¸€èˆ¬ç”¨æ¥è§£å†³å¯¹è±¡é—´æˆ–é—­åŒ…å±æ€§ä¸å…¶æ‰€å±å¯¹è±¡ä¹‹é—´çš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p><h4 id="3-2-è¯»å†™"><a href="#3-2-è¯»å†™" class="headerlink" title="3.2.è¯»å†™"></a>3.2.è¯»å†™</h4><p>Swiftä¸­æ²¡æœ‰<code>readwrite</code>å’Œ<code>readonly</code>ç‰¹æ€§ã€‚</p><p>å¯¹äº<code>å­˜å‚¨å±æ€§</code>ï¼Œä½¿ç”¨<code>let</code>è¡¨æ˜å…¶ä¸ºåªè¯»ï¼›ä½¿ç”¨<code>var</code>è¡¨æ˜å…¶ä¸ºå¯è¯»ï¼å¯å†™ã€‚</p><p>å¯¹äº<code>è®¡ç®—å±æ€§</code>ï¼Œä¸ºå…¶æä¾›ä¸€ä¸ª getter æ–¹æ³•ï¼Œä½¿å…¶æˆä¸ºå¯è¯»çš„ï¼›æä¾› setter æ–¹æ³•ï¼Œä½¿å…¶æˆä¸ºå¯å†™çš„ã€‚å¦‚æœåªæä¾›äº† getter è€Œæ²¡æœ‰ setterï¼Œåˆ™å±æ€§åªè¯»ï¼›è®¡ç®—å±æ€§ä¸èƒ½åªæä¾› setter ä¸æä¾› getterï¼Œå¦åˆ™æŠ¥é”™â€œVariable with a setter must also have a getterâ€ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">var</span> aInt: <span class="hljs-built_in">Int</span> &#123;<br>        <span class="hljs-keyword">get</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-keyword">set</span> &#123;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-åŸå­æ€§"><a href="#3-3-åŸå­æ€§" class="headerlink" title="3.3.åŸå­æ€§"></a>3.3.åŸå­æ€§</h4><p>OC ä¸­çš„<code>atomic</code>å’Œ<code>nonatomic</code>åœ¨ Swift ä¸­æ²¡æœ‰å¯¹åº”çš„ä¿®é¥°ç¬¦ï¼ŒSwift ä¸­å±æ€§é»˜è®¤æ˜¯<code>nonatomic</code>çš„ï¼Œå¯ä»¥é€šè¿‡ OC ä¸­ç±»ä¼¼çš„é”æœºåˆ¶æ¥ä¿è¯å±æ€§å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨ã€‚</p><h4 id="3-4-æ‹·è´"><a href="#3-4-æ‹·è´" class="headerlink" title="3.4.æ‹·è´"></a>3.4.æ‹·è´</h4><p>åœ¨Swiftä¸­ï¼ŒOCçš„<code>copy</code>è¢«è½¬æ¢ä¸º<code>@NSCopying</code>å±æ€§ã€‚è¿™ä¸€ç±»å±æ€§é¡»éµå®ˆ <code>NSCopying</code>åè®®ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Book</span>: <span class="hljs-title class_">NSCopying</span> &#123;<br>    <span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>?<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">copy</span>(<span class="hljs-params">with</span> <span class="hljs-params">zone</span>: <span class="hljs-type">NSZone</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>) -&gt; <span class="hljs-keyword">Any</span> &#123;<br>        <span class="hljs-keyword">let</span> copy <span class="hljs-operator">=</span> <span class="hljs-type">Book</span>()<br>        copy.name <span class="hljs-operator">=</span> name<br>        <span class="hljs-keyword">return</span> copy<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BooksShelf</span> &#123;<br>    <span class="hljs-keyword">@NSCopying</span> <span class="hljs-keyword">var</span> book: <span class="hljs-type">Book</span>?<br>&#125;<br><br><span class="hljs-comment">//è°ƒç”¨åŠæ—¥å¿—</span><br><span class="hljs-keyword">let</span> book1 <span class="hljs-operator">=</span> <span class="hljs-type">Book</span>()<br>book1.name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;swift&quot;</span><br><span class="hljs-keyword">let</span> bookShelf <span class="hljs-operator">=</span> <span class="hljs-type">BooksShelf</span>()<br>bookShelf.book <span class="hljs-operator">=</span> book1<br><span class="hljs-built_in">print</span>(bookShelf.book <span class="hljs-operator">===</span> book1)<span class="hljs-comment">//false</span><br></code></pre></td></tr></table></figure><h3 id="5-finalã€staticã€class"><a href="#5-finalã€staticã€class" class="headerlink" title="5.finalã€staticã€class"></a>5.finalã€staticã€class</h3><h4 id="5-1-final"><a href="#5-1-final" class="headerlink" title="5.1.final"></a>5.1.final</h4><p>ä¿®é¥°ç±»åŠå…¶å…ƒç´ ï¼Œå¼ºè°ƒä¸èƒ½è¢«ç»§æ‰¿å’Œé‡å†™ã€‚</p><ul><li>final åªèƒ½ä¿®é¥°ç±»å’Œç±»ä¸­çš„å…ƒç´ ï¼Œä¸èƒ½ä¿®é¥°å€¼ç±»å‹çš„ç»“æ„ä½“å’Œæšä¸¾ï¼Œå®ƒä»¬æœ¬èº«å°±ä¸èƒ½è¢«ç»§æ‰¿ï¼›</li><li>final ä¿®é¥°çš„æ–¹æ³•ã€å±æ€§ã€ä¸‹æ ‡ä¸èƒ½è¢«é‡å†™ï¼›</li><li>final ä¿®é¥°æ•´ä¸ªç±»æ—¶æ­¤ç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼Œå…¶ä¸­çš„å…ƒç´ ä¹Ÿå°†è¢«æ ‡è®°ä¸º finalï¼Œå› æ­¤ä¸èƒ½é‡å†™ï¼›</li></ul><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">var</span> aInt: <span class="hljs-built_in">Int</span>&#123;<br>        <span class="hljs-keyword">get</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    func callFunction() &#123;<br>        print(<span class="hljs-string">&quot;A&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>:<span class="hljs-type">A</span> &#123; <span class="hljs-comment">// æŠ¥é”™â€œInheritance from a final class &#x27;A&#x27;â€</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> aInt: <span class="hljs-built_in">Int</span> &#123; <span class="hljs-comment">// æŠ¥é”™â€œProperty overrides a &#x27;final&#x27; propertyâ€</span><br>        <span class="hljs-keyword">get</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">override</span> func callFunction() &#123; <span class="hljs-comment">//æŠ¥é”™â€œInstance method overrides a &#x27;final&#x27; instance methodâ€</span><br>        print(<span class="hljs-string">&quot;B&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>final</code>ä¿®é¥°ç±»çš„å±æ€§ã€æ–¹æ³•æ—¶åªæ˜¯å°†å…¶æ ‡è®°ä¸ºä¸èƒ½é‡å†™ï¼Œå¹¶ä¸ä¼šå°†å…¶å˜æˆç±»å±æ€§æˆ–ç±»æ–¹æ³•ã€‚</p><h4 id="5-2-static"><a href="#5-2-static" class="headerlink" title="5.2.static"></a>5.2.static</h4><p>ä¿®é¥°ç±»ä¸­å…ƒç´ ï¼Œå¼ºè°ƒå±äºç±»ã€ä¸å¯é‡å†™ã€‚</p><ul><li>static å¯ä»¥ä¿®é¥°ç±»ä¸­çš„å…ƒç´ ï¼Œä½†ä¸èƒ½ä¿®é¥°ç±»æœ¬èº«;</li><li>static å¯ä»¥ä¿®é¥°ç»“æ„ä½“ä¸­çš„å…ƒç´ ï¼Œä½†ä¸èƒ½ä¿®é¥°ç»“æ„ä½“æœ¬èº«ï¼›</li><li>static ä¸èƒ½ä¿®é¥°æšä¸¾åŠå…¶å…ƒç´ ï¼›</li><li>static ä¿®é¥°çš„å±æ€§å°†æˆä¸ºé™æ€å±æ€§ï¼Œä¿®é¥°çš„æ–¹æ³•å°†æˆä¸ºé™æ€æ–¹æ³•ï¼Œä¸èƒ½é‡å†™ï¼Œéœ€é€šè¿‡ç±»å‹åæ¥è°ƒç”¨ï¼›</li></ul><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs stylus">class A &#123;<br>    static <span class="hljs-selector-tag">var</span> aInt: Int = <span class="hljs-number">1</span><br>    static func <span class="hljs-built_in">callFunction</span>() &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;A.aInt:\(aInt)&quot;</span>)<br>    &#125;<br>&#125;<br>class B:A &#123;<br>    <span class="hljs-selector-tag">var</span> aInt: Int = <span class="hljs-number">2</span> <span class="hljs-comment">// å±æ€§å‰ä¸èƒ½åŠ override å¦åˆ™ä¼šæŠ¥é”™â€œProperty does not override any property from its superclassâ€</span><br><br>    func <span class="hljs-built_in">callFunction</span>() &#123; <span class="hljs-comment">// æ–¹æ³•å‰ä¸èƒ½åŠ override å¦åˆ™ä¼šæŠ¥é”™â€œMethod does not override any method from its superclassâ€</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;B.aInt:\(aInt)&quot;</span>)<br>    &#125;<br>&#125;<br>A<span class="hljs-selector-class">.aInt</span> <span class="hljs-comment">// 1</span><br>B<span class="hljs-selector-class">.aInt</span> <span class="hljs-comment">// 1</span><br>A<span class="hljs-selector-class">.callFunction</span>() <span class="hljs-comment">// A.aInt:1</span><br>let <span class="hljs-selector-tag">b</span> = <span class="hljs-built_in">B</span>()<br><span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.aInt</span> <span class="hljs-comment">// 2</span><br><span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.callFunction</span>()  <span class="hljs-comment">// æ‰“å° B.aInt:2</span><br></code></pre></td></tr></table></figure><h4 id="5-3-class"><a href="#5-3-class" class="headerlink" title="5.3.class"></a>5.3.class</h4><p>ä¿®é¥°ç±»ä¸­å…ƒç´ ï¼Œå¼ºè°ƒå±äºç±»ã€å¯é‡å†™ã€‚</p><ul><li>class åªèƒ½ç”¨åœ¨ç±»ä¸­ï¼Œä¸èƒ½ä¿®é¥°ç»“æ„ä½“æˆ–æšä¸¾åŠå®ƒä»¬çš„å…ƒç´ ï¼›</li><li>class ä¿®é¥°çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¯ä»¥è¢«é‡å†™ï¼›</li><li>class ä¿®é¥°çš„å±æ€§æ˜¯ç±»å±æ€§ï¼Œä¿®é¥°çš„æ–¹æ³•æ˜¯ç±»æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡â€œç±»å.xxâ€ç›´æ¥è°ƒç”¨ï¼›</li><li>class å¯ä»¥ä¿®é¥°è®¡ç®—å±æ€§ï¼Œä¸èƒ½ä¿®é¥°å­˜å‚¨å±æ€§ï¼Œå› ä¸ºå­˜å‚¨å±æ€§å±äºç±»çš„å®ä¾‹ï¼›</li></ul><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">var</span> <span class="hljs-title">aInt</span>: <span class="hljs-type">Int</span> &#123;<br>        <span class="hljs-keyword">get</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-keyword">set</span> &#123;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">func</span> <span class="hljs-title">callFunction</span>() &#123;<br>        print(<span class="hljs-string">&quot;A&quot;</span>)<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>:<span class="hljs-type">A</span> &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">var</span> <span class="hljs-title">aInt</span>: <span class="hljs-type">Int</span> &#123;<br>        <span class="hljs-keyword">get</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>        &#125;<br>        <span class="hljs-keyword">set</span> &#123;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">func</span> <span class="hljs-title">callFunction</span>() &#123;<br>        print(<span class="hljs-string">&quot;B&quot;</span>)<br>    &#125;<br>&#125;<br>A.aInt <span class="hljs-comment">// æ‰“å°ï¼š1</span><br>B.aInt <span class="hljs-comment">// æ‰“å°ï¼š2</span><br>let b = B()<br>B.callFunction() <span class="hljs-comment">// æ‰“å°ï¼šB</span><br></code></pre></td></tr></table></figure><h3 id="6-å­—ç¬¦ä¸²æˆªå–"><a href="#6-å­—ç¬¦ä¸²æˆªå–" class="headerlink" title="6.å­—ç¬¦ä¸²æˆªå–"></a>6.å­—ç¬¦ä¸²æˆªå–</h3><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xquery">var <span class="hljs-type">text</span> = <span class="hljs-string">&quot;123456&quot;</span><br><span class="hljs-keyword">let</span> <span class="hljs-keyword">start</span> = <span class="hljs-type">text</span>.startIndex<br><span class="hljs-keyword">let</span> index<span class="hljs-number">0</span> = <span class="hljs-type">text</span>.index(<span class="hljs-keyword">start</span>, offsetBy: <span class="hljs-number">0</span>)<br><span class="hljs-keyword">let</span> index1 = <span class="hljs-type">text</span>.index(<span class="hljs-keyword">start</span>, offsetBy: <span class="hljs-number">3</span>)<br><span class="hljs-keyword">let</span> subText = <span class="hljs-type">text</span>[<span class="hljs-keyword">start</span>...index<span class="hljs-number">0</span>]  // <span class="hljs-string">&quot;1&quot;</span> (ç­‰ä»·äº<span class="hljs-type">text</span>[<span class="hljs-keyword">start</span>])<br><span class="hljs-keyword">let</span> subText1 = <span class="hljs-type">text</span>[<span class="hljs-keyword">start</span>...index1] // <span class="hljs-string">&quot;1234&quot;</span><br><span class="hljs-keyword">let</span> subText2 = <span class="hljs-type">text</span>.dropFirst(<span class="hljs-number">1</span>)    // <span class="hljs-string">&quot;23456&quot;</span><br><span class="hljs-keyword">let</span> subText3 = subText2.prefix(<span class="hljs-number">2</span>)   // <span class="hljs-string">&quot;23&quot;</span><br></code></pre></td></tr></table></figure><h3 id="7-è®¿é—®æ§åˆ¶ç¬¦"><a href="#7-è®¿é—®æ§åˆ¶ç¬¦" class="headerlink" title="7.è®¿é—®æ§åˆ¶ç¬¦"></a>7.è®¿é—®æ§åˆ¶ç¬¦</h3><p>äº”ç§è®¿é—®ä¿®é¥°ç¬¦ï¼ŒæŒ‰ä»é«˜åˆ°ä½æ’åºæ˜¯ï¼šopen &gt; public &gt; interal &gt; fileprivate &gt; privateã€‚</p><ul><li>openï¼šå¯ä»¥è¢«ä»»ä½•æ¨¡å—çš„ä»£ç è®¿é—®ï¼Œå¯ä»¥è¢«ç»§æ‰¿å’Œé‡å†™ã€‚</li><li>public: å¯ä»¥è¢«ä»»ä½•æ¨¡å—çš„ä»£ç è®¿é—®ï¼Œæ¨¡å—å¤–ä¸å¯ç»§æ‰¿å’Œé‡å†™ã€‚</li><li>internalï¼šé»˜è®¤è®¿é—®çº§åˆ«ï¼Œæºä»£ç æ‰€åœ¨çš„æ•´ä¸ªæ¨¡å—éƒ½å¯ä»¥è®¿é—®ã€‚</li><li>fileprivateï¼šåªèƒ½åœ¨å½“å‰æ–‡ä»¶ä¸­è®¿é—®ï¼Œå½“å‰ç±»çš„æ‰©å±•ä¸­ä¹Ÿå¯ä»¥ã€‚</li><li>privateï¼šåªèƒ½åœ¨å½“å‰ç±»ä¸­è®¿é—®ï¼Œå½“å‰ç±»çš„æ‰©å±•ä¸­ä¹Ÿå¯ä»¥è®¿é—®ã€‚</li></ul><h3 id="8-defer"><a href="#8-defer" class="headerlink" title="8.defer"></a>8.defer</h3><p><code>defer</code>ç”¨äºåœ¨ç¦»å¼€å½“å‰ä»£ç å—<code>å‰</code>æ‰§è¡Œä¸€ç³»åˆ—è¯­å¥ï¼Œå¦‚å…³é—­æ•°æ®åº“ã€æ¸…ç†å¯¹è±¡ç­‰ã€‚</p><p>å½“å‰ä»£ç å—å­˜åœ¨å¤šä¸ª<code>defer</code>è¯­å¥æ—¶ï¼Œdeferè¯­å¥ä¼šæŒ‰ç…§å®šä¹‰æ—¶çš„é¡ºåºä»åå¾€å‰æ‰§è¡Œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">aDefer</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++ç¬¬ä¸€è¡Œ&quot;</span>)<br>    <span class="hljs-keyword">defer</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++defer 1&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">defer</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++defer 2&quot;</span>)<br>    &#125;<br><span class="hljs-comment">//    print(&quot;++æµ‹è¯•deferæ˜¯å¦ä¸­æ–­&quot;)</span><br><span class="hljs-comment">//    if true &#123;</span><br><span class="hljs-comment">//        return</span><br><span class="hljs-comment">//    &#125;</span><br>    <span class="hljs-keyword">defer</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++defer 3&quot;</span>)<br>    &#125;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++è¦ç»“æŸå’¯&quot;</span>)<br>&#125;<br><span class="hljs-comment">//è°ƒç”¨</span><br>aDefer()<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">æ‰“å°ç»“æœï¼š</span><br><span class="hljs-comment">++ç¬¬ä¸€è¡Œ</span><br><span class="hljs-comment">++è¦ç»“æŸå’¯</span><br><span class="hljs-comment">++defer 3</span><br><span class="hljs-comment">++defer 2</span><br><span class="hljs-comment">++defer 1</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>deferè¯­å¥å¯ä»¥è¢«returnï¼Œerrorç­‰æ‰“æ–­ï¼Œå³æ‰§è¡Œåˆ°deferè¯­å¥å‰å¦‚æœä»£ç å·²ç»è¿”å›ï¼Œé‚£ä¹ˆdeferå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚å¯å°†ä¸Šé¢ä¾‹å­ä¸­çš„æ³¨é‡Šè¯­å¥æ‰“å¼€å¹¶é‡æ–°è¿è¡Œçœ‹çœ‹ç»“æœï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">æ‰“å°æ—¥å¿—ï¼š</span><br><span class="hljs-literal">++</span><span class="hljs-comment">ç¬¬ä¸€è¡Œ</span><br><span class="hljs-literal">++</span><span class="hljs-comment">æµ‹è¯•deferæ˜¯å¦ä¸­æ–­</span><br><span class="hljs-literal">++</span><span class="hljs-comment">defer 2</span><br><span class="hljs-literal">++</span><span class="hljs-comment">defer 1</span><br></code></pre></td></tr></table></figure><p>å³ç¬¬ä¸‰ä¸ªdeferå‰ä»£ç å—è¢«returnï¼Œåˆ™åç»­deferåŠâ€print(â€œ++è¦ç»“æŸå’¯â€)â€œå‡æœªæ‰§è¡Œã€‚</p><h3 id="9-typealias"><a href="#9-typealias" class="headerlink" title="9.typealias"></a>9.typealias</h3><p>ä½œç”¨ï¼šç»™å·²æœ‰ç±»å‹é‡æ–°å®šä¹‰åç§°ï¼Œæ–¹ä¾¿ä»£ç é˜…è¯»ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//eg:1.å·²æœ‰ç±»å‹çš„é‡æ–°å‘½å</span><br>typealias  Address = CGPoint<br><br><span class="hljs-keyword">let</span> point: CGPoint = <span class="hljs-constructor">CGPoint(<span class="hljs-params">x</span>: 0,<span class="hljs-params">y</span>: 0)</span><br><span class="hljs-comment">//ç­‰ä»·äº</span><br><span class="hljs-keyword">let</span> point: Address = <span class="hljs-constructor">CGPoint(<span class="hljs-params">x</span>: 0,<span class="hljs-params">y</span>: 0)</span><br></code></pre></td></tr></table></figure><p>å¸¸è§åº”ç”¨åœºæ™¯ï¼šå®šä¹‰é—­åŒ…ï¼Œç±»ä¼¼ocçš„ block å®šä¹‰ã€‚</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livescript">typealias <span class="hljs-function"><span class="hljs-title">successBlock</span> = <span class="hljs-params">(_ code: Int, _ message: <span class="hljs-built_in">String</span>)</span> -&gt;</span> Void<br><span class="hljs-keyword">var</span> callBack: successBlock?<br>self.callBack!(code: <span class="hljs-number">200</span>, message: <span class="hljs-string">&quot;ok&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="10-associatedtype"><a href="#10-associatedtype" class="headerlink" title="10.associatedtype"></a>10.associatedtype</h3><p>åè®®ä¸­ä¸æ”¯æŒ<code>&lt;T&gt;</code>è¿™ç§æ–¹å¼å®šä¹‰æ³›å‹ï¼Œä½¿ç”¨<code>associatedtype</code>å…³é”®å­—å®šä¹‰æŸç§æ³›å‹ï¼Œåœ¨åè®®çš„å®ç°ç±»ä¸­æ‰æŒ‡æ˜æ­¤æ³›å‹å…·ä½“æ˜¯ä½•ç±»å‹ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Container</span> &#123;<br>    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Item</span>  <span class="hljs-comment">//è¿™ä¸ªItemå°±æ˜¯æ³›å‹ï¼Œå¯ç°åœ¨åè®®ä¸­ç”¨ç€</span><br>    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Item</span>)<br>    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> &#123; <span class="hljs-keyword">get</span> &#125;<br>    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">i</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Item</span> &#123; <span class="hljs-keyword">get</span> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ç°åè®®</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">IntStack</span>: <span class="hljs-title class_">Container</span> &#123;<br>    <span class="hljs-comment">// IntStack ç±»çš„è‡ªæœ‰éƒ¨åˆ†</span><br>    <span class="hljs-keyword">var</span> items: [<span class="hljs-type">Int</span>] <span class="hljs-operator">=</span> []<br>    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">push</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Int</span>) &#123;<br>        items.append(item)<br>    &#125;<br>    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">pop</span>() -&gt; <span class="hljs-type">Int</span> &#123;<br>        <span class="hljs-keyword">return</span> items.removeLast()<br>    &#125;<br>    <span class="hljs-comment">// å®ç° Container åè®®çš„éƒ¨åˆ†</span><br>    <span class="hljs-keyword">typealias</span> <span class="hljs-type">Item</span> <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>  <span class="hljs-comment">//è¿™é‡ŒæŒ‡æ˜Itemæ˜¯Intç±»å‹</span><br>    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Int</span>) &#123;<br>        <span class="hljs-keyword">self</span>.push(item)<br>    &#125;<br>    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> &#123;<br>        <span class="hljs-keyword">return</span> items.count<br>    &#125;<br>    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">i</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> &#123;<br>        <span class="hljs-keyword">return</span> items[i]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="11-é€ƒé€¸é—­åŒ…"><a href="#11-é€ƒé€¸é—­åŒ…" class="headerlink" title="11.é€ƒé€¸é—­åŒ…"></a>11.é€ƒé€¸é—­åŒ…</h3><blockquote><p>A closure is said to escape a function when the closure is passed as an argument to the function, but is called after the function returns. When you declare a function that takes a closure as one of its parameters, you can write @escaping before the parameterâ€™s type to indicate that the closure is allowed to escape.</p></blockquote><p>å½“é—­åŒ…ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œåœ¨å‡½æ•°<code>return</code>ä¹‹åè¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å°±è¯´è¿™ä¸ªé—­åŒ…ä»å‡½æ•°ä¸­é€ƒç¦»ï¼Œå³<code>é€ƒé€¸é—­åŒ…</code>ï¼Œä½¿ç”¨<code>@escaping</code>æ¥æ ‡ç¤ºã€‚</p><p>è¿™ç§æƒ…å†µå¸¸è§äºå‡½æ•°ä¸­å‘èµ·äº†ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚å¹¶æŠŠé—­åŒ…ä½œä¸ºå¼‚æ­¥æ“ä½œçš„å›è°ƒã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">// é€ƒé€¸é—­åŒ…ç¤ºä¾‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetHelper</span> &#123; <span class="hljs-comment">//ç½‘ç»œå·¥å…·ç±»</span><br>    <br>    <span class="hljs-keyword">var</span> statusOK <span class="hljs-operator">=</span> <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">httpRequest</span>(<span class="hljs-params">withUrl</span> <span class="hljs-params">url</span>:<span class="hljs-type">String</span>,<br>                     <span class="hljs-params">succeesCallback</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Data</span>?,<span class="hljs-type">URLResponse</span>?)-&gt;(),<br>                     <span class="hljs-params">failCallback</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Error</span>?)-&gt;()) &#123;<br>        <span class="hljs-comment">//é€ƒé€¸é—­åŒ…å¿…é¡»ç”¨@escapingå£°æ˜;</span><br>        <span class="hljs-comment">//å¦åˆ™ç¼–è¯‘æ—¶æŠ¥é”™ Escaping closure captures non-escaping parameter &#x27;succeesCallback&#x27;</span><br>        <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>url.isEmpty <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++URL is nil~&quot;</span>)<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++task start&quot;</span>)<br>        <span class="hljs-keyword">let</span> urlT:<span class="hljs-type">URL</span>? <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: url)<br>        <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>.shared.dataTask(with: urlT<span class="hljs-operator">!</span>) &#123;(data:<span class="hljs-type">Data</span>?, response:<span class="hljs-type">URLResponse</span>?, error:<span class="hljs-type">Error</span>?) <span class="hljs-keyword">in</span><br>            <span class="hljs-keyword">if</span> error <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-keyword">self</span>.statusOK <span class="hljs-operator">=</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// é€ƒé€¸é—­åŒ…ä¸­ä½¿ç”¨åˆ°é—­åŒ…æ‰€åœ¨ç±»å‹æ—¶ éœ€è¦æ˜¾å¼çš„è°ƒç”¨self ä»¥ä¾¿æé†’è‡ªå·±æ•è·äº†self, ä¸å†™ç¼–è¯‘å™¨ä¼šæŠ¥é”™!</span><br>                failCallback(error) <span class="hljs-comment">//è°ƒç”¨é€ƒé€¸é—­åŒ…</span><br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">self</span>.statusOK <span class="hljs-operator">=</span> <span class="hljs-literal">true</span><br>                succeesCallback(data,response) <span class="hljs-comment">//è°ƒç”¨é€ƒé€¸é—­åŒ…</span><br>            &#125;<br>        &#125;<br>        task.resume() <span class="hljs-comment">// å¼€å§‹ä»»åŠ¡</span><br>    &#125;<br>&#125;<br><span class="hljs-comment">// å‘èµ·ç½‘ç»œè¯·æ±‚</span><br><span class="hljs-keyword">var</span> netHelper <span class="hljs-operator">=</span> <span class="hljs-type">NetHelper</span>()<br>netHelper.httpRequest(withUrl: <span class="hljs-string">&quot;https://www.baidu.com&quot;</span>, succeesCallback: &#123; (data, response) <span class="hljs-keyword">in</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++Network finished successfully~<span class="hljs-subst">\n</span> response:<span class="hljs-subst">\(response<span class="hljs-operator">!</span>)</span>&quot;</span>)<br>&#125;) &#123; (error) <span class="hljs-keyword">in</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++error:<span class="hljs-subst">\(error<span class="hljs-operator">!</span>)</span>&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="12-autoclosure"><a href="#12-autoclosure" class="headerlink" title="12.autoclosure"></a>12.autoclosure</h3><blockquote><p>An autoclosure is a closure thatâ€™s automatically created to wrap an expression thatâ€™s being passed as an argument to a function. It doesnâ€™t take any arguments, and when itâ€™s called, it returns the value of the expression thatâ€™s wrapped inside of it. This syntactic convenience lets you omit braces around a functionâ€™s parameter by writing a normal expression instead of an explicit closure.</p></blockquote><p>è‡ªåŠ¨é—­åŒ…ï¼Œä¸€ç§è‡ªåŠ¨åˆ›å»ºçš„é—­åŒ…ï¼Œç”¨æ¥æŠŠä½œä¸ºå‡½æ•°å‚æ•°çš„è¡¨è¾¾å¼è¿›è¡Œæ‰“åŒ…ã€‚å®ƒä¸æ¥å—ä»»ä½•å®é™…å‚æ•°ï¼Œå½“å®ƒè¢«è°ƒç”¨æ—¶ï¼Œä¼šè¿”å›å†…éƒ¨æ‰“åŒ…çš„è¡¨è¾¾å¼çš„å€¼ã€‚è¿™ä¸ªè¯­æ³•çš„å¥½å¤„åœ¨äºé€šè¿‡å†™æ™®é€šè¡¨è¾¾å¼ä»£æ›¿æ˜¾ç¤ºé—­åŒ…ï¼Œä½¿ä½ çœç•¥å‡½æ•°å‚æ•°çš„<code>&#123;&#125;</code>æ‹¬å·ã€‚å®ƒå…è®¸ä½ å»¶è¿Ÿå¤„ç†ï¼Œé—­åŒ…å†…çš„ä»£ç ç›´åˆ°ä½ è°ƒç”¨å®ƒæ—¶æ‰ä¼šè¿è¡Œï¼Œå¯¹äºæœ‰å‰¯ä½œç”¨æˆ–è€…å ç”¨èµ„æºçš„ä»£ç æ¥è¯´å¾ˆæœ‰ä½œç”¨ã€‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-tag">var</span> customersInLine = <span class="hljs-selector-attr">[<span class="hljs-string">&quot;Chris&quot;</span>, <span class="hljs-string">&quot;Alex&quot;</span>, <span class="hljs-string">&quot;Ewa&quot;</span>, <span class="hljs-string">&quot;Barry&quot;</span>, <span class="hljs-string">&quot;Daniella&quot;</span>]</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(customersInLine.count)</span></span><br><span class="hljs-comment">// æ‰“å°ç»“æœ &quot;5&quot;</span><br><br><span class="hljs-comment">//1ã€å®šä¹‰ä¸€ä¸ªblockï¼Œå…¶ç±»å‹ä¸º()-&gt;Stringï¼Œæ­¤æ—¶blockå†…çš„ä»£ç å°šæœªæ‰§è¡Œ</span><br>let customerProvider = &#123; customersInLine<span class="hljs-selector-class">.remove</span>(at: <span class="hljs-number">0</span>) &#125; <br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(customersInLine.count)</span></span><br><span class="hljs-comment">// æ‰“å°ç»“æœ &quot;5&quot;</span><br><br><span class="hljs-comment">//2ã€è°ƒç”¨é—­åŒ…è¡¨è¾¾å¼ï¼ŒçœŸæ­£æ‰§è¡Œä¸Šé¢å®šä¹‰çš„block</span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;Now serving \(customerProvider())!&quot;</span>)</span></span><br><span class="hljs-comment">// æ‰“å°ç»“æœ &quot;Now serving Chris!&quot;</span><br><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(customersInLine.count)</span></span><br><span class="hljs-comment">// æ‰“å°ç»“æœ &quot;4&quot;</span><br></code></pre></td></tr></table></figure><p>å½“ä½ ä¼ ä¸€ä¸ªé—­åŒ…ä½œä¸ºå‚æ•°åˆ°å‡½æ•°æ—¶ï¼Œä½ ä¼šå¾—åˆ°ä¸å»¶è¿Ÿå¤„ç†ç›¸åŒçš„è¡Œä¸º:</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">var</span> customersInLine = [<span class="hljs-string">&quot;Chris&quot;</span>,<span class="hljs-string">&quot;Alex&quot;</span>,<span class="hljs-string">&quot;Ewa&quot;</span>,<span class="hljs-string">&quot;Barry&quot;</span>,<span class="hljs-string">&quot;Daniella&quot;</span>]<br> <br><span class="hljs-regexp">//å®šä¹‰blockï¼Œå…¶ç±»å‹ä¸º()-&gt;Stringï¼Œæ­¤æ—¶å°šæœªæ‰§è¡Œ</span><br><span class="hljs-regexp">let customProvider = &#123;customersInLine.remove(at: 0)&#125;</span><br><span class="hljs-regexp"> </span><br><span class="hljs-regexp"> //</span>å®šä¹‰å‡½æ•°ï¼Œæ¥å—ä¸€ä¸ª<span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span><span class="hljs-built_in">String</span>ç±»å‹çš„blockä½œä¸ºå‚æ•°<br>func serve<span class="hljs-function"><span class="hljs-params">(custom customerProvider:() -&gt;<span class="hljs-built_in">String</span>)</span>&#123;</span><br><span class="hljs-function">    <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;Now serving\(customerProvider())!&quot;</span>)</span></span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function"><span class="hljs-title">serve</span><span class="hljs-params">(custom: &#123;customersInLine.remove(at: <span class="hljs-number">0</span>)&#125;)</span></span><br></code></pre></td></tr></table></figure><p>@autoclosureå°†å‚æ•°æ ‡è®°ä¸ºä½¿ç”¨è‡ªåŠ¨é—­åŒ…ï¼Œå†è°ƒç”¨å‡½æ•°æ—¶å®ƒå°±åƒæ¥å—äº†ä¸€ä¸ªString å‚æ•°è€Œéé—­åŒ…ï¼Œå› ä¸ºå‚æ•°è¢«è‡ªåŠ¨åœ°è½¬æ¢ä¸ºäº†é—­åŒ…ã€‚</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">var</span> customersInLine = [<span class="hljs-string">&quot;Chris&quot;</span>,<span class="hljs-string">&quot;Alex&quot;</span>,<span class="hljs-string">&quot;Ewa&quot;</span>,<span class="hljs-string">&quot;Barry&quot;</span>,<span class="hljs-string">&quot;Daniella&quot;</span>]<br> <br><span class="hljs-regexp">//å®šä¹‰é—­åŒ…</span><br><span class="hljs-regexp">let customProvider = &#123;customersInLine.remove(at: 0)&#125;</span><br><span class="hljs-regexp"> </span><br><span class="hljs-regexp">//</span>å°†é—­åŒ…å‚æ•°æ ‡è®°ä¸º@autoclosure<br>func serve<span class="hljs-function"><span class="hljs-params">(custom customerProvider: @autoclosure () -&gt;<span class="hljs-built_in">String</span> )</span>&#123;</span><br><span class="hljs-function">    <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;Now serving \(customerProvider())!&quot;</span>)</span></span><br><span class="hljs-function">&#125;</span><br><span class="hljs-function">//è°ƒç”¨å‡½æ•°æ—¶ï¼Œä¸éœ€è¦å†å†™èŠ±æ‹¬å·&#123;&#125;ï¼Œ@<span class="hljs-title">autoclosure</span>ä¼šæ ¹æ®ä¸Šé¢çš„å®šä¹‰ï¼Œè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºé—­åŒ…</span><br><span class="hljs-function"><span class="hljs-title">serve</span><span class="hljs-params">(custom: customersInLine.remove(at: <span class="hljs-number">0</span>))</span></span><br></code></pre></td></tr></table></figure><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://github.com/CocoaChina-editors/Welcome-to-Swift/blob/master/UsingSwiftwithCocoaandObjective-C%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C.md">Â©Swiftç¿»è¯‘ç»„</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swift ä¸ OC çš„æ··ç¼–</title>
    <link href="/2018/09/02/swift-mixmatch.html"/>
    <url>/2018/09/02/swift-mixmatch.html</url>
    
    <content type="html"><![CDATA[<h2 id="æ··ç¼–çš„ä¸¤ç§æƒ…å†µï¼š"><a href="#æ··ç¼–çš„ä¸¤ç§æƒ…å†µï¼š" class="headerlink" title="æ··ç¼–çš„ä¸¤ç§æƒ…å†µï¼š"></a>æ··ç¼–çš„ä¸¤ç§æƒ…å†µï¼š</h2><p>â‘ Swift å·¥ç¨‹ä¸­ä½¿ç”¨ Objective-C æ–‡ä»¶ï¼›</p><p>â‘¡Objective-C å·¥ç¨‹ä¸­ä½¿ç”¨ Swift æ–‡ä»¶ã€‚</p><p>æœ¬æ–‡æ‰€ç”¨ Xcode ç‰ˆæœ¬ï¼š9.4.1</p><h3 id="1-Swift-ä¸­æ··ç¼–-OC"><a href="#1-Swift-ä¸­æ··ç¼–-OC" class="headerlink" title="1.Swift ä¸­æ··ç¼– OC"></a>1.Swift ä¸­æ··ç¼– OC</h3><p>Swift å·¥ç¨‹ä¸­ä½¿ç”¨ OC æ–‡ä»¶æ—¶éœ€è¦ä¾èµ– <code>æ¡¥æ¥å¤´æ–‡ä»¶</code> å°† OC ä¸­çš„å±æ€§ã€æ¥å£ç­‰æš´éœ²ç»™ Swiftã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ Swift å·¥ç¨‹ä¸­é¦–æ¬¡åˆ›å»º OC æ–‡ä»¶æ—¶ï¼ŒXcode ä¼šè‡ªåŠ¨æç¤ºä½ æ˜¯å¦åˆ›å»ºæ¡¥æ¥å¤´æ–‡ä»¶ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_swift_OC_Header.png" alt="æ¡¥æ¥å¤´æ–‡ä»¶"></p><p>é€‰æ‹©åˆ›å»ºåï¼Œå·¥ç¨‹ç›®å½•ä¸‹ä¼šå¤šå‡ºä¸€ä¸ªä»¥ â€œå·¥ç¨‹å-Bridging-Header.hâ€ å‘½åçš„å¤´æ–‡ä»¶:</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_swift_OC_dir.png" alt="swiftå·¥ç¨‹ä¸­OCæ–‡ä»¶ç›®å½•"></p><p>Xcode ä¼šè‡ªåŠ¨è®¾ç½®å¥½ç›¸å…³ä¿¡æ¯ï¼Œå¯åœ¨ â€œTargetsâ€“&gt;Build Settingsâ€“&gt;Swift Compiler - Generalâ€ æŸ¥çœ‹ï¼Œä¸€èˆ¬ä¸ç”¨åšä¿®æ”¹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_swift_OC.png" alt="swiftä½¿ç”¨OCæ–‡ä»¶çš„è®¾ç½®"></p><p>å¦‚æœä½ å¿½ç•¥äº†ä¹‹å‰ Xcode çš„æç¤ºï¼Œæ²¡åˆ›å»ºæ¡¥æ¥å¤´æ–‡ä»¶ï¼Œåé¢ä½ è¿˜æœ‰æœºä¼šã€‚ç¨åä½ å¯ä»¥æŒ‰ç…§ä¸Šé¢çš„å‘½åè§„åˆ™è‡ªå·±æ–°å»ºä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œåœ¨ â€œTargetsâ€“&gt;Build Settingsâ€“&gt;Swift Compiler - Generalâ€ ä¸­æ‰‹åŠ¨è®¾ç½®å¥½ â€œObjective-C Bridging Headerâ€ é€‰é¡¹çš„è·¯å¾„å³å¯ã€‚</p><p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨ â€œHelloSwift-Bridging-Header.hâ€ æ–‡ä»¶ä¸­å¯¼å…¥ä½ æƒ³æš´éœ²çš„ OC å¤´æ–‡ä»¶äº†ï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">#<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;OCFile.h&quot;</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨ Swift å·¥ç¨‹ä¸­ä½¿ç”¨åˆšåˆšåˆ›å»ºçš„ OC ç±»<code>OCFile</code>äº†ï¼Œå®Œæ•´ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//OCFile.h</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-built_in">NS_ENUM</span>(<span class="hljs-built_in">NSInteger</span>, Direction) &#123;<br>    DirectionEast,<span class="hljs-comment">//Swiftä¸­ä¼šè¢«ç¼–è¯‘ä¸º.eastï¼ˆOCä¸­çš„æšä¸¾å‰ç¼€åœ¨Swiftä¸­ä¼šè¢«æˆªæ–­ï¼‰</span><br>    DirectionWest,<br>    DirectionSouth,<br>    DirectionNorth,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">OCFile</span> : <span class="hljs-title">NSObject</span></span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-type">int</span> aInt;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>, <span class="hljs-keyword">nonnull</span>) <span class="hljs-built_in">NSArray</span> *anArr;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *str;<br><br>- (<span class="hljs-type">void</span>)instanceFunction:(Direction)direction;<br>+ (<span class="hljs-type">void</span>)classFunction;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//OCFile.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;OCFile.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">OCFile</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSDictionary</span> *aDic;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">OCFile</span></span><br><br>-(<span class="hljs-keyword">instancetype</span>)init<br>&#123;<br>    <span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>) &#123;<br>        aDouble = <span class="hljs-number">0.001</span>;<br>        aInte = <span class="hljs-number">1</span>;<br>        _aInt = <span class="hljs-number">2</span>;<br>        _anArr = @[@(<span class="hljs-number">123</span>)];<br>        _aDic = @&#123;<span class="hljs-string">@&quot;k1&quot;</span>:_anArr&#125;;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)instanceFunction:(Direction)direction<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++call instance method&quot;</span>);<br>&#125;<br><br>+ (<span class="hljs-type">void</span>)classFunction<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++call class method&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨<code>AppDelegate.swift</code>ä¸­ç›´æ¥ä½¿ç”¨OCç±»ï¼Œä¸éœ€è¦å†å¯¼å…¥å…¶å¤´æ–‡ä»¶ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">import</span> UIKit<br><br><span class="hljs-keyword">@UIApplicationMain</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> &#123;<br><br>    <span class="hljs-keyword">var</span> window: <span class="hljs-type">UIWindow</span>?<br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,<br>                     <span class="hljs-params">didFinishLaunchingWithOptions</span><br>        <span class="hljs-params">launchOptions</span>: [<span class="hljs-params">UIApplicationLaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span><br>    &#123;<br>        <span class="hljs-keyword">let</span> ocf <span class="hljs-operator">=</span> <span class="hljs-type">OCFile</span>()<br>        ocf.instanceFunction(<span class="hljs-type">Direction</span>.east)<br>        <span class="hljs-type">OCFile</span>.classFunction()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++<span class="hljs-subst">\(ocf.anArr)</span>&quot;</span>)<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-OC-ä¸­æ··ç¼–-Swift"><a href="#2-OC-ä¸­æ··ç¼–-Swift" class="headerlink" title="2.OC ä¸­æ··ç¼– Swift"></a>2.OC ä¸­æ··ç¼– Swift</h3><p>OC å·¥ç¨‹ä¸­ä½¿ç”¨ Swift æ–‡ä»¶éœ€è¦ä¸€ä¸ªå‘½åæ ¼å¼ä¸º â€œå·¥ç¨‹å-Swift.hâ€ çš„å¤´æ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ª Objective-C å¤´æ–‡ä»¶ï¼Œè¢«è§†ä¸º Swift ä»£ç çš„<code>umbrella header</code>ã€‚å®ƒåŒ…å«äº†ä½ å·¥ç¨‹ target é‡Œæ‰€æœ‰ Swift ä»£ç ä¸­å®šä¹‰çš„æ¥å£ã€å±æ€§ç­‰ã€‚æœ‰äº†å®ƒ Swift æ–‡ä»¶ä¸­æ ‡è®°ä¸º <code>open</code>ã€<code>public</code>ã€<code>internal</code> çš„ä¿¡æ¯æ‰èƒ½æš´éœ²ç»™ OC ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯åœ¨ä½ ç¼–è¯‘å·¥ç¨‹ï¼ˆcommand+Bï¼‰å Xcode è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¸éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ›å»ºï¼Œä¹Ÿä¸ä¼šæ˜¾ç¤ºåœ¨å·¥ç¨‹ç›®å½•ä¸­ã€‚ä¸‹é¢æ˜¯å…·ä½“æ­¥éª¤ï¼š</p><p>åœ¨ OC å·¥ç¨‹ä¸­æ–°å»º Swift æ–‡ä»¶ï¼šâ€œcommand+N -&gt; swift Fileâ€ï¼Œç›®å½•å¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_mix_match_dir.png" alt="OCå·¥ç¨‹ä¸­swiftæ–‡ä»¶ç›®å½•"></p><p>å¦‚æœæ˜¯é¦–æ¬¡åˆ›å»º Swift æ–‡ä»¶ï¼ŒXcode åŒæ ·ä¼šæç¤ºæ–°å»ºæ¡¥æ¥å¤´æ–‡ä»¶ï¼Œè¿™é‡Œå¯ä»¥ä¸åˆ›å»ºã€‚ä¹‹å Xcode ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è®¾ç½®å¥½ â€œObjective-C Generated Interface Header Nameâ€ é€‰é¡¹ï¼Œæˆ‘ä»¬ä¸ç”¨åšä»€ä¹ˆä¿®æ”¹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_mix_match.png" alt="OCä¸­ä½¿ç”¨swiftæ–‡ä»¶"></p><p>è‡ªå®šä¹‰ä½ çš„ Swift ç±»ï¼š</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">import</span> Foundation<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SwiftFile</span> : NSObject &#123;<br>    @objc <span class="hljs-keyword">var</span> name : <span class="hljs-built_in">String</span>?<br>    @objc <span class="hljs-keyword">let</span> nick : <span class="hljs-built_in">String</span><br>    <br>    @objc init(name:<span class="hljs-built_in">String</span>,nick:<span class="hljs-built_in">String</span>) &#123;<br>        self.name = name<br>        self.nick = nick<br>        super.init()<br>    &#125;<br>    <br>    @objc func swiftInstanceMethod<span class="hljs-function"><span class="hljs-params">(name:<span class="hljs-built_in">String</span>)</span> -&gt;</span> <span class="hljs-built_in">String</span> &#123;<br>        self.name = name<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;name is:\(name)&quot;</span>)<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <br>    @objc <span class="hljs-keyword">class</span> <span class="hljs-title class_">func</span> swiftClassMethod<span class="hljs-function"><span class="hljs-params">(nick:<span class="hljs-built_in">String</span>)</span> -&gt;</span> <span class="hljs-built_in">String</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;nick is:\(nick)&quot;</span>)<br>        <span class="hljs-keyword">return</span> nick<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç”¨åˆ°æ­¤ Swift æ–‡ä»¶çš„åœ°æ–¹å¯¼å…¥ â€œå·¥ç¨‹å-swift.hâ€ å¤´æ–‡ä»¶å³å¯ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;AppDelegate.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ASDF-Swift.h&quot;</span> <span class="hljs-comment">//å¯¼å…¥ swift æ–‡ä»¶å¯¹åº”çš„ OC ç‰ˆå¤´æ–‡ä»¶</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    SwiftFile *sf = [[SwiftFile alloc] initWithName:<span class="hljs-string">@&quot;swift&quot;</span> nick:<span class="hljs-string">@&quot;sf&quot;</span>];<br>    sf.name = <span class="hljs-string">@&quot;Swift4.1&quot;</span>;<br>    [sf swiftInstanceMethodWithName:<span class="hljs-string">@&quot;Hello&quot;</span>];<br>    [SwiftFile swiftClassMethodWithNick:<span class="hljs-string">@&quot;newNick&quot;</span>];<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>command + B ç¼–è¯‘ä¹‹åï¼Œcommand + ç‚¹å‡»è¿™ä¸ª<code>ASDF-Swift.h</code>å°±èƒ½çœ‹åˆ°å…¶ä¸­çš„å†…å®¹äº†ã€‚é‡Œé¢æ˜¯ Xcode å¸®æˆ‘ä»¬ç”Ÿæˆçš„ <code>SwiftFile.swift</code> çš„ OC ç‰ˆå¤´æ–‡ä»¶ï¼Œå†…å®¹å¾ˆé•¿ï¼Œé‡è¦å†…å®¹æ‘˜å½•å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">SwiftFile</span> : <span class="hljs-title">NSObject</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> * _Nullable name;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> * _Nonnull nick;<br>- (<span class="hljs-keyword">nonnull</span> <span class="hljs-keyword">instancetype</span>)initWithName:(<span class="hljs-built_in">NSString</span> * _Nonnull)name nick:(<span class="hljs-built_in">NSString</span> * _Nonnull)nick OBJC_DESIGNATED_INITIALIZER;<br>- (<span class="hljs-built_in">NSString</span> * _Nonnull)swiftInstanceMethodWithName:(<span class="hljs-built_in">NSString</span> * _Nonnull)name SWIFT_WARN_UNUSED_RESULT;<br>- (<span class="hljs-keyword">nonnull</span> <span class="hljs-keyword">instancetype</span>)init SWIFT_UNAVAILABLE;<br>+ (<span class="hljs-keyword">nonnull</span> <span class="hljs-keyword">instancetype</span>)new SWIFT_DEPRECATED_MSG(<span class="hljs-string">&quot;-init is unavailable&quot;</span>);<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul><li><strong>public ä¸ private</strong></li></ul><p>OC ä¸­ä½¿ç”¨ Swift æ–‡ä»¶æ—¶ï¼Œ<code>å·¥ç¨‹å-Swift.h</code>æ–‡ä»¶ä¸­åªèƒ½å°† Swift æ–‡ä»¶ä¸­æ ‡æ³¨ä¸º <code>open</code>ã€<code>public</code>ã€<code>internal</code> çš„ç±»ã€å±æ€§å’Œæ¥å£ç­‰æš´éœ²ç»™ OCï¼Œ<code>fileprivate</code>å’Œ<code>private</code>æ ‡è®°çš„ä¿¡æ¯å¯¹ OC ä¸å¯è§ã€‚Swift ä¸­é»˜è®¤çš„è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦æ˜¯<code>internal</code>ã€‚</p><ul><li><strong>ç‰ˆæœ¬å˜æ›´</strong></li></ul><p>Swift 3.x ä¸­ç±»åªè¦ç»§æ‰¿äº† NSObjectï¼Œç¼–è¯‘å™¨ä¼šéšå¼åœ°ä¸ºæ‰€æœ‰<code>public</code>çš„å±æ€§æˆ–æ–¹æ³•æ·»åŠ <code>@objc</code>æ ‡æ³¨ï¼Œè¿™æ ·å°±èƒ½æŠŠ Swift çš„å±æ€§ã€å‡½æ•°ç­‰æš´éœ²ç»™ OCï¼›ä½† Swift 4.x ä¸­ç»§æ‰¿è‡ª NSObject çš„ç±»ä¸å†éšå¼æ·»åŠ <code>@objc</code>ï¼Œéœ€è¦æ‰‹åŠ¨æ ‡æ³¨ã€‚</p><ul><li><strong>ç»§æ‰¿é—®é¢˜</strong></li></ul><p>Swift ç±»å¯ä»¥ç»§æ‰¿è‡ª OC ç±»ï¼Œä½†åè¿‡æ¥ OC ç±»ä¸èƒ½ç»§æ‰¿ Swift ç±»ã€‚</p><ul><li><strong>å®å®šä¹‰</strong></li></ul><p>Swift ä¸­ä½¿ç”¨ OC ä¸­çš„<code>å®</code>æ—¶ï¼Œå¯ä»¥å°†ç®€å•çš„å®å®šä¹‰æˆå…¨å±€å¸¸é‡ï¼Œå¯¹äºå¤æ‚çš„å®å¯ä»¥å°†å…¶å®šä¹‰æˆå‡½æ•°ã€‚</p><ul><li><strong>Swift ä¸­ç‹¬æœ‰çš„ç‰¹æ€§</strong></li></ul><p>å°† Swift ä»£ç å¯¼å…¥ OC åï¼Œä½ å¯ä»¥è®¿é—®åœ¨ Swift ç±»æˆ–åè®®ä¸­ä½¿ç”¨<code>@objc</code>æ ‡è®°çš„ä»»ä½•å¯¹è±¡ï¼Œåªè¦è¯¥å¯¹è±¡ä¸ OC å…¼å®¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯éƒ¨åˆ† Swift ç‹¬æœ‰çš„ç‰¹æ€§ä¸èƒ½åœ¨ OC ä¸­ä½¿ç”¨ï¼ŒåŒ…æ‹¬ï¼šæ³›å‹ã€å…ƒç»„ã€éIntç±»å‹çš„æšä¸¾ã€å¯å˜å‚æ•°ã€å‡½æ•°åµŒå¥—ç­‰ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/documentation/swift/migrating_your_objective_c_code_to_swift">Â©Apple</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swift ä¸­ç›‘å¬å±æ€§å˜åŒ–</title>
    <link href="/2018/08/31/swift-kvo-observer.html"/>
    <url>/2018/08/31/swift-kvo-observer.html</url>
    
    <content type="html"><![CDATA[<h2 id="1ã€å±æ€§è§‚å¯Ÿå™¨"><a href="#1ã€å±æ€§è§‚å¯Ÿå™¨" class="headerlink" title="1ã€å±æ€§è§‚å¯Ÿå™¨"></a>1ã€å±æ€§è§‚å¯Ÿå™¨</h2><p>Swift æä¾›äº†<code>å±æ€§è§‚å¯Ÿå™¨</code>æ¥ç›‘å¬è‡ªèº«<code>å­˜å‚¨å±æ€§</code>çš„å˜åŒ–ã€‚è§‚å¯Ÿå™¨åªèƒ½ç”¨äºç›‘å¬é<code>lazy</code>å­˜å‚¨å±æ€§ã€‚å¯¹äºè®¡ç®—å±æ€§ï¼Œå®ƒå·²ç»å†…å«äº†<code>get&#123;&#125;</code>å’Œ<code>set&#123;&#125;</code>ï¼Œé—­åŒ…å†…å·²ç»çŸ¥é“å±æ€§çš„å˜åŒ–ï¼Œä¸éœ€è¦å†æä¾›è§‚å¯Ÿå™¨ã€‚å¯¹äºä»çˆ¶ç±»ç»§æ‰¿ä¸‹æ¥çš„å­˜å‚¨å±æ€§æˆ–è®¡ç®—å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å­ç±»ä¸­é‡å†™å±æ€§çš„<code>getter</code>å’Œ<code>setter</code>æ¥ä¸ºå®ƒä»¬æ·»åŠ å±æ€§è§‚å¯Ÿå™¨ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>&#123;<br>    <br>    <span class="hljs-keyword">var</span> nick : <span class="hljs-type">String</span> &#123;<br>        <span class="hljs-keyword">willSet</span>&#123;<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++New value:<span class="hljs-subst">\(newValue)</span>&quot;</span>)<br>        &#125;<br>        <span class="hljs-keyword">didSet</span>&#123;<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++Old value:<span class="hljs-subst">\(oldValue)</span>&quot;</span>)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>:<span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">self</span>.nick <span class="hljs-operator">=</span> name<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨åŠè¾“å‡ºç»“æœï¼š</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">var</span> <span class="hljs-keyword">st</span> = Student(name: <span class="hljs-string">&quot;HALO&quot;</span>)<br><span class="hljs-keyword">st</span>.nick = <span class="hljs-string">&quot;james&quot;</span><br><span class="hljs-comment">//è¾“å‡º</span><br>++++New value:james<br>++++Old value:HALO<br></code></pre></td></tr></table></figure><p>è§‚å¯Ÿå™¨åªèƒ½ç”¨æ¥è§‚å¯Ÿè‡ªèº«å±æ€§ï¼ˆåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿ä¸‹æ¥çš„å±æ€§ï¼‰çš„å˜åŒ–ã€‚</p><h2 id="2ã€ä½¿ç”¨KVOè§‚å¯Ÿå±æ€§"><a href="#2ã€ä½¿ç”¨KVOè§‚å¯Ÿå±æ€§" class="headerlink" title="2ã€ä½¿ç”¨KVOè§‚å¯Ÿå±æ€§"></a>2ã€ä½¿ç”¨KVOè§‚å¯Ÿå±æ€§</h2><p>æ¡ä»¶1ï¼šè§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…éƒ½è¦ç»§æ‰¿è‡ª<code>NSObject</code></p><p>KVO æ˜¯ OC ä¸­çš„ç‰¹æ€§ï¼Œåœ¨ OC ä¸­å®ƒæ˜¯åŸºäº runtime çš„åŠ¨æ€åˆ†å‘æœºåˆ¶å’Œ KVCï¼Œé€šè¿‡<code>key</code>æ¥ç›‘å¬<code>value</code>çš„å˜åŒ–ã€‚OC ä¸­æ‰€æœ‰çš„ç±»éƒ½ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿è‡ª NSObjectï¼Œè€Œæ ¹ç±» NSObject é»˜è®¤éµå®ˆäº†<code>NSKeyValueCoding</code>åè®®ï¼Œæ‰€ä»¥è¿™äº›ç±»æ‰èƒ½å®ç° KVOã€‚Swift class åªæœ‰ç»§æ‰¿äº† NSObject æ‰èƒ½æ‹¥æœ‰è¿™äº›ç‰¹æ€§ã€‚å¯¹äºæ²¡æœ‰çˆ¶ç±»æˆ–è€…ä¸ç»§æ‰¿ NSObject çš„æƒ…å†µï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸Šé¢æåˆ°çš„è§‚å¯Ÿå™¨æ¥å®ç°æ­¤åŠŸèƒ½ã€‚</p><p>æ¡ä»¶2ï¼šéœ€è¦å°†å±æ€§æ ‡è®°ä¸º<code>@objc</code>å’Œ<code>dynamic</code></p><p><code>@objc</code>æ ‡è®°ç”¨æ¥å°† Swift ç±»ä¸­çš„å±æ€§æš´éœ²ç»™ OCï¼›ä½ ä¹Ÿå¯ä»¥å°†ç±»æ ‡æ³¨ä¸º<code>@objcMembers</code>ï¼Œä½¿ç”¨è¿™ç§æ ‡æ³¨çš„ç±»ä¼šéšå¼åœ°ä¸ºç±»ä¸­æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•æ·»åŠ <code>@objc</code>æ ‡æ³¨ã€‚</p><p>å¦å¤–ï¼ŒSwift ä¸­é»˜è®¤å…³é—­äº†åŠ¨æ€æ´¾å‘æœºåˆ¶ï¼Œå£°æ˜ä¸º<code>@objc</code>çš„å±æ€§æˆ–æ–¹æ³•æœ‰å¯èƒ½ä¼šè¢« Swift ä¼˜åŒ–ä¸ºé™æ€è°ƒç”¨ï¼Œä¸ä¸€å®šä¼šåŠ¨æ€æ´¾å‘ï¼Œæ‰€ä»¥è¿˜éœ€å°†å±æ€§æ ‡è®°ä¸º<code>dynamic</code>æ‰èƒ½å¼€å¯è¿è¡Œæ—¶ä»è€Œç›‘å¬å±æ€§çš„å˜åŒ–ã€‚</p><h3 id="æ–¹æ¡ˆ1ï¼ˆaddObserver-ï¼‰"><a href="#æ–¹æ¡ˆ1ï¼ˆaddObserver-ï¼‰" class="headerlink" title="æ–¹æ¡ˆ1ï¼ˆaddObserver:ï¼‰"></a>æ–¹æ¡ˆ1ï¼ˆaddObserver:ï¼‰</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">People</span>: <span class="hljs-title class_">NSObject</span> &#123;<br>    <br>    <span class="hljs-comment">//å®šä¹‰å¾…ç›‘å¬çš„å±æ€§</span><br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">dynamic</span> <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;defaultName&quot;</span><br>    <span class="hljs-comment">//æ›´æ–°å±æ€§å€¼</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateName</span>(<span class="hljs-params">pName</span>:<span class="hljs-type">String</span>) -&gt; () &#123;<br>        name <span class="hljs-operator">=</span> pName<br>    &#125;<br>    <br>    <span class="hljs-comment">//æ³¨å†Œç›‘å¬</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>() &#123;<br>        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()<br>        addObserver(<span class="hljs-keyword">self</span>, forKeyPath: <span class="hljs-string">&quot;name&quot;</span>, options: [.new,.old], context: <span class="hljs-literal">nil</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">//å¤„ç†ç›‘å¬</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">observeValue</span>(<span class="hljs-params">forKeyPath</span> <span class="hljs-params">keyPath</span>: <span class="hljs-type">String</span>?,<br>                               <span class="hljs-params">of</span> <span class="hljs-params">object</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>,<br>                               <span class="hljs-params">change</span>: [<span class="hljs-params">NSKeyValueChangeKey</span> : <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>,<br>                               <span class="hljs-params">context</span>: <span class="hljs-type">UnsafeMutableRawPointer</span>?) &#123;<br>        <span class="hljs-keyword">if</span> keyPath <span class="hljs-operator">==</span> <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-keyword">let</span> newName <span class="hljs-operator">=</span> change<span class="hljs-operator">?</span>[.newKey] &#123;<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++name updated to: <span class="hljs-subst">\(newName)</span>&quot;</span>)<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">super</span>.observeValue(forKeyPath: keyPath, of: object, change: change, context: context)<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//ææ„ä¸­ç§»é™¤ç›‘å¬</span><br>    <span class="hljs-keyword">deinit</span> &#123;<br>        removeObserver(<span class="hljs-keyword">self</span>, forKeyPath: <span class="hljs-string">&quot;name&quot;</span>, context: <span class="hljs-literal">nil</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++å·²ç§»é™¤ç›‘å¬&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨æ–¹æ³•ä¸è¾“å‡ºç»“æœï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//è°ƒç”¨ï¼š</span><br><span class="hljs-keyword">let</span> people = <span class="hljs-constructor">People()</span><br>people.update<span class="hljs-constructor">Name(<span class="hljs-params">pName</span>: <span class="hljs-string">&quot;Dav&quot;</span>)</span><br>people.set<span class="hljs-constructor">Value(<span class="hljs-string">&quot;Hello&quot;</span>, <span class="hljs-params">forKey</span>: <span class="hljs-string">&quot;name&quot;</span>)</span><br><span class="hljs-comment">//è¾“å‡ºç»“æœï¼š</span><br>++++name updated <span class="hljs-keyword">to</span>: Dav<br>++++name updated <span class="hljs-keyword">to</span>: Hello<br>++++å·²ç§»é™¤ç›‘å¬<br></code></pre></td></tr></table></figure><h3 id="æ–¹æ¡ˆ2ï¼ˆobserveé—­åŒ…ï¼‰"><a href="#æ–¹æ¡ˆ2ï¼ˆobserveé—­åŒ…ï¼‰" class="headerlink" title="æ–¹æ¡ˆ2ï¼ˆobserveé—­åŒ…ï¼‰"></a>æ–¹æ¡ˆ2ï¼ˆobserveé—­åŒ…ï¼‰</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">People</span>: <span class="hljs-title class_">NSObject</span> &#123;<br>    <br>    <span class="hljs-comment">//å®šä¹‰å¾…ç›‘å¬çš„å±æ€§</span><br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">dynamic</span> <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&quot;defaultName&quot;</span><br>    <span class="hljs-comment">//æ›´æ–°å±æ€§å€¼</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateName</span>(<span class="hljs-params">pName</span>:<span class="hljs-type">String</span>) -&gt; () &#123;<br>        name <span class="hljs-operator">=</span> pName<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span>: <span class="hljs-title class_">NSObject</span> &#123;<br>    <br>    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">var</span> objToObserve : <span class="hljs-type">People</span> <span class="hljs-comment">//æ³¨æ„è¿™é‡Œä¹Ÿè¦æ ‡è®°ä¸º@objc</span><br>    <br>    <span class="hljs-keyword">var</span> observation : <span class="hljs-type">NSKeyValueObservation</span>?<br>    <br>    <span class="hljs-comment">//æ³¨å†Œç›‘å¬</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">object</span> : <span class="hljs-type">People</span>) &#123;<br>        objToObserve <span class="hljs-operator">=</span> object<br>        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()<br>        <br>        observation <span class="hljs-operator">=</span> observe(\.objToObserve.name,options: [.old, .new], changeHandler: &#123; (object, change) <span class="hljs-keyword">in</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;name updated from: <span class="hljs-subst">\(change.oldValue<span class="hljs-operator">!</span>)</span>, updated to: <span class="hljs-subst">\(change.newValue<span class="hljs-operator">!</span>)</span>&quot;</span>)<br>        &#125;)<br>    &#125;<br>    <br>    <span class="hljs-keyword">deinit</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++++Observer Deinited&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨æ–¹æ³•ä¸è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//è°ƒç”¨ï¼š</span><br><span class="hljs-keyword">let</span> people = <span class="hljs-constructor">People()</span><br><span class="hljs-keyword">let</span> observer = <span class="hljs-constructor">Observer(<span class="hljs-params">object</span>: <span class="hljs-params">people</span>)</span><br>people.update<span class="hljs-constructor">Name(<span class="hljs-params">pName</span>: <span class="hljs-string">&quot;Dav&quot;</span>)</span><br>people.set<span class="hljs-constructor">Value(<span class="hljs-string">&quot;Hello&quot;</span>, <span class="hljs-params">forKey</span>: <span class="hljs-string">&quot;name&quot;</span>)</span><br><span class="hljs-comment">//è¾“å‡ºç»“æœï¼š</span><br>++++name updated from: defaultName, updated <span class="hljs-keyword">to</span>: Dav<br>++++name updated from: Dav, updated <span class="hljs-keyword">to</span>: Hello<br>++++Observer Deinited<br></code></pre></td></tr></table></figure><hr><p>ç›¸å…³å‚è€ƒ</p><p>#<a href="https://developer.apple.com/documentation/swift/cocoa_design_patterns/using_key_value_observing_in_swift">Â©swiftå®˜æ–¹æ–‡æ¡£</a></p><p>#<a href="https://tech.glowing.com/cn/implement-kvo/">Â©è‡ªå·±å®ç°KVO</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swifté—­åŒ…æ•è·å˜é‡&amp;å¾ªç¯å¼•ç”¨</title>
    <link href="/2018/08/20/swift-refcycle.html"/>
    <url>/2018/08/20/swift-refcycle.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-é—­åŒ…ä¸­çš„å˜é‡æ•è·"><a href="#1-é—­åŒ…ä¸­çš„å˜é‡æ•è·" class="headerlink" title="1.é—­åŒ…ä¸­çš„å˜é‡æ•è·"></a>1.é—­åŒ…ä¸­çš„å˜é‡æ•è·</h3><h4 id="1-1-é—­åŒ…é»˜è®¤å¼•ç”¨å˜é‡"><a href="#1-1-é—­åŒ…é»˜è®¤å¼•ç”¨å˜é‡" class="headerlink" title="1.1.é—­åŒ…é»˜è®¤å¼•ç”¨å˜é‡"></a>1.1.é—­åŒ…é»˜è®¤å¼•ç”¨å˜é‡</h4><blockquote><p>A closure can capture constants and variables from the surrounding context in which it is defined. The closure can then refer to and modify the values of those constants and variables from within its body, even if the original scope that defined the constants and variables no longer exists.</p></blockquote><blockquote><p>As an optimization, Swift may instead capture and store a copy of a value if that value is not mutated by a closure, and if the value is not mutated after the closure is created.</p></blockquote><blockquote><p>Swift also handles all memory management involved in disposing of variables when they are no longer needed.</p></blockquote><p>å¦‚ä½ æ‰€çŸ¥ï¼ŒOC ä¸­ block ä¼šæ•è·å˜é‡ï¼Œä¸”æ•è·çš„æ˜¯å˜é‡çš„å€¼ã€‚</p><p>Swift çš„é—­åŒ…ä¹Ÿä¼šè‡ªåŠ¨æ•è·å…¶ä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„å˜é‡ï¼Œä½†ä¸ OC ä¸­ block ä¸åŒçš„æ˜¯ï¼Œé—­åŒ…é»˜è®¤æ•è·çš„æ˜¯<strong>å˜é‡çš„å¼•ç”¨</strong>ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨é—­åŒ…å†…ä¿®æ”¹å®ƒä»¬çš„å€¼ã€‚æ¢å¥è¯è¯´ï¼ŒSwift é—­åŒ…ä¸­å˜é‡çš„é»˜è®¤è¡Œä¸ºä¸ OC ä¸­<code>__block</code> å˜é‡ä¸€è‡´ã€‚</p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// Block å¼•ç”¨å˜é‡</span><br>func <span class="hljs-built_in">blockRetain</span>() &#123;<br>    <span class="hljs-selector-tag">var</span> num = <span class="hljs-number">1</span><br>    let block1 = &#123; <span class="hljs-comment">// æœ€ç®€å•çš„é—­åŒ… å†…éƒ¨å¼•ç”¨äº†å˜é‡</span><br>        num += <span class="hljs-number">1</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\(num)&quot;</span>)<br>    &#125;<br>    num += <span class="hljs-number">1</span><br>    <span class="hljs-built_in">block1</span>()<br>&#125;<br><span class="hljs-function"><span class="hljs-title">blockRetain</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// æ‰“å° &quot;3&quot;</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>num</code>æ˜¯å±€éƒ¨å˜é‡ï¼Œå®ƒåœ¨<code>block1</code>ä¸­å’Œä¹‹åéƒ½è¢«ä¿®æ”¹äº†ï¼Œè€Œè¿™ä¸¤å¤„æ”¹å˜ä¹Ÿéƒ½å½±å“äº†æœ€ç»ˆæ‰“å°çš„ä¿¡æ¯ã€‚è¿™è¯´æ˜<code>block1</code>ä¸­æ˜¯å¯¹<code>num</code>å˜é‡è¿›è¡Œäº†å¼•ç”¨ï¼Œè€Œéå€¼çš„å¤åˆ¶ï¼Œè¿™ä¸OCä¸­ block å¯¹å˜é‡çš„æ•è·æœ‰å¾ˆå¤§çš„ä¸åŒã€‚</p><h4 id="1-2-é—­åŒ…æ•è·å˜é‡"><a href="#1-2-é—­åŒ…æ•è·å˜é‡" class="headerlink" title="1.2.é—­åŒ…æ•è·å˜é‡"></a>1.2.é—­åŒ…æ•è·å˜é‡</h4><p>å¦‚æœä¸æƒ³è¢«å¼•ç”¨è€Œæ˜¯è¢«å¤åˆ¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>æ•è·åˆ—è¡¨</code>ï¼š</p><p>#ç¤ºä¾‹2ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// Block æ•è·å˜é‡</span><br>func <span class="hljs-built_in">blockCapture</span>() &#123;<br>    <span class="hljs-selector-tag">var</span> num = <span class="hljs-number">1</span><br>    let block2 = &#123; <span class="hljs-selector-attr">[num]</span> <span class="hljs-keyword">in</span> <span class="hljs-comment">//å£°æ˜æ•è·åˆ—è¡¨ æ•è·å˜é‡ è€Œéå¼•ç”¨</span><br>        <span class="hljs-comment">//num += 1 // æ­¤å¤„ä¼šæŠ¥é”™:Left side of mutating operator isn&#x27;t mutable: &#x27;num&#x27; is an immutable capture</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\(num)&quot;</span>)<br>    &#125;<br>    num += <span class="hljs-number">1</span><br>    <span class="hljs-built_in">block2</span>()<br>&#125;<br><span class="hljs-function"><span class="hljs-title">blockCapture</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// æ‰“å° &quot;1&quot;</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå®šä¹‰æ•è·åˆ—è¡¨ä¹‹åï¼Œ<code>num</code>åœ¨ block ä¸­è¢«æ•è·ï¼Œä½†è¿™æ¬¡æ˜¯è¢«å¤åˆ¶ä¸”æˆä¸ºäº†ä¸€ä¸ªå¸¸é‡ï¼Œä¸èƒ½åœ¨ block å†…è¢«ä¿®æ”¹ã€‚block ä¹‹åçš„ä¿®æ”¹ä¹Ÿå¹¶æœªå½±å“åˆ° block å†…çš„æ‰“å°ç»“æœï¼Œè¿™æ‰æœ‰ç‚¹åƒOCä¸­çš„ blockã€‚</p><h4 id="1-3-é—­åŒ…çš„ä¼˜åŒ–"><a href="#1-3-é—­åŒ…çš„ä¼˜åŒ–" class="headerlink" title="1.3.é—­åŒ…çš„ä¼˜åŒ–"></a>1.3.é—­åŒ…çš„ä¼˜åŒ–</h4><p>Swift å‡ºäºæ€§èƒ½è€ƒè™‘ä¼šå¯¹é—­åŒ…åšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚å®ƒä¼šè‡ªåŠ¨åˆ¤æ–­ä½ æ˜¯å¦åœ¨é—­åŒ…å†…æˆ–é—­åŒ…å¤–ä¿®æ”¹äº†å˜é‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šç›´æ¥æŒæœ‰ä¸€ä»½è¯¥<strong>å˜é‡çš„æ‹·è´</strong>ã€‚</p><h3 id="2-é—­åŒ…çš„å¾ªç¯å¼•ç”¨"><a href="#2-é—­åŒ…çš„å¾ªç¯å¼•ç”¨" class="headerlink" title="2.é—­åŒ…çš„å¾ªç¯å¼•ç”¨"></a>2.é—­åŒ…çš„å¾ªç¯å¼•ç”¨</h3><h4 id="2-1-äº§ç”ŸåŸå› "><a href="#2-1-äº§ç”ŸåŸå› " class="headerlink" title="2.1.äº§ç”ŸåŸå› "></a>2.1.äº§ç”ŸåŸå› </h4><p>A strong reference cycle can also occur if you assign a closure to a property of a class instance, and the body of that closure captures the instance. This capture might occur because the closureâ€™s body accesses a property of the instance, such as self.someProperty, or because the closure calls a method on the instance, such as self.someMethod(). In either case, these accesses cause the closure to â€œcaptureâ€ self, creating a strong reference cycle.</p><p>ä¸ OC ä¸­çš„ block ç±»ä¼¼ï¼ŒSwift é—­åŒ…ä¹Ÿä¼šå¼ºå¼•ç”¨è¢«å®ƒæ•è·çš„å¯¹è±¡ï¼Œä»è€Œå¼•å‘å¯èƒ½çš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p><p>æ¯”å¦‚å¯¹è±¡æŒæœ‰ä¸€ä¸ªé—­åŒ…å±æ€§ï¼Œè€Œé—­åŒ…ä½“ä¸­é€šè¿‡<code>self.</code>è°ƒç”¨äº†å¯¹è±¡çš„å±æ€§æˆ–æ–¹æ³•ï¼Œä»è€Œæ•è·äº†self æœ¬èº«ï¼Œé€ æˆå¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: UIViewController &#123;<br><br>    <span class="hljs-keyword">var</span> name :<span class="hljs-built_in">String</span>? = <span class="hljs-string">&quot;s&quot;</span><br>    <span class="hljs-keyword">var</span> sBlock:<span class="hljs-function"><span class="hljs-params">(()-&gt;())</span>? //å®šä¹‰é—­åŒ…å±æ€§ï¼Œ<span class="hljs-title">VC</span>å¼ºå¼•ç”¨é—­åŒ…</span><br><span class="hljs-function">    </span><br><span class="hljs-function">    <span class="hljs-title">override</span> <span class="hljs-title">func</span> <span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">super</span>.<span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span></span><br><span class="hljs-function">        <span class="hljs-title">sBlock</span> = &#123;</span><br><span class="hljs-function">            //é—­åŒ…è®¿é—®<span class="hljs-title">VC</span>çš„å…¶ä»–æˆå‘˜ï¼Œé—­åŒ…æ•è·å¹¶å¼ºå¼•ç”¨<span class="hljs-title">self</span>å¯¹è±¡</span><br><span class="hljs-function">            <span class="hljs-title">self</span>.<span class="hljs-title">name</span> = &quot;<span class="hljs-title">x</span>&quot; </span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function"></span><br><span class="hljs-function">    <span class="hljs-title">deinit</span>&#123;</span><br><span class="hljs-function">        <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;++ deinited !&quot;</span>)</span>//å› ä¸ºé—­åŒ…çš„å¾ªç¯å¼•ç”¨ï¼Œè¿™é‡Œææ„å¹¶ä¸ä¼šæ‰§è¡Œ</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="2-2-è§£å†³æ–¹æ¡ˆ"><a href="#2-2-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="2.2.è§£å†³æ–¹æ¡ˆ"></a>2.2.è§£å†³æ–¹æ¡ˆ</h4><p>You resolve a strong reference cycle between a closure and a class instance by defining a capture list as part of the closureâ€™s definition.Each item in a capture list is a pairing of the weak or unowned keyword with a reference to a class instance (such as self) or a variable initialized with some value (such as delegate &#x3D; self.delegate!). </p><p><strong>æ•è·åˆ—è¡¨</strong>ä¹Ÿå¯ä»¥è§£å†³é—­åŒ…çš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼ŒæŠŠè¢«æ•è·çš„å˜é‡æ ‡è®°ä¸º<code>weak</code> æˆ– <code>unowned</code>å³å¯ã€‚</p><ul><li>ç»™å¸¦å‚æ•°çš„é—­åŒ…å®šä¹‰æ•è·åˆ—è¡¨ï¼š</li></ul><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">var</span> aClosure: <span class="hljs-function"><span class="hljs-params">(Int, <span class="hljs-built_in">String</span>)</span> -&gt;</span> <span class="hljs-built_in">String</span> = &#123;<br>    [unowned self, weak delegate = self.delegate!] <span class="hljs-function"><span class="hljs-params">(index: Int, stringToProcess: <span class="hljs-built_in">String</span>)</span> -&gt;</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">in</span><br>    <span class="hljs-regexp">//é—­åŒ…å…·ä½“å†…å®¹</span><br><span class="hljs-regexp">&#125;</span><br></code></pre></td></tr></table></figure><ul><li>ç»™ä¸å¸¦å‚æ•°çš„é—­åŒ…å®šä¹‰æ•è·åˆ—è¡¨ï¼š</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">var</span> aClosure: () -&gt; <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> &#123;<br>    [<span class="hljs-keyword">unowned</span> <span class="hljs-keyword">self</span>, <span class="hljs-keyword">weak</span> delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.delegate<span class="hljs-operator">!</span>] <span class="hljs-keyword">in</span><br>    <span class="hljs-comment">//é—­åŒ…å…·ä½“å†…å®¹</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œä¸Šé¢#ç¤ºä¾‹1ä¸­çš„é—®é¢˜å¯ä»¥è¿™æ ·è§£å†³ï¼š</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: UIViewController &#123;<br><br>    <span class="hljs-keyword">var</span> name :<span class="hljs-built_in">String</span>? = <span class="hljs-string">&quot;s&quot;</span><br>    <span class="hljs-keyword">var</span> sBlock:<span class="hljs-function"><span class="hljs-params">(()-&gt;())</span>?</span><br><span class="hljs-function">    </span><br><span class="hljs-function">    <span class="hljs-title">override</span> <span class="hljs-title">func</span> <span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span> &#123;</span><br><span class="hljs-function">        <span class="hljs-title">super</span>.<span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span></span><br><span class="hljs-function">        <span class="hljs-title">sBlock</span> = &#123;</span><br><span class="hljs-function">            [<span class="hljs-title">unowned</span> <span class="hljs-title">self</span>] <span class="hljs-title">in</span> //å®šä¹‰æ•è·åˆ—è¡¨</span><br><span class="hljs-function">            <span class="hljs-title">self</span>.<span class="hljs-title">name</span> = &quot;<span class="hljs-title">x</span>&quot;</span><br><span class="hljs-function">        &#125;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">    </span><br><span class="hljs-function">    <span class="hljs-title">deinit</span>&#123;</span><br><span class="hljs-function">        <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-string">&quot;++ deinited !&quot;</span>)</span> //èƒ½æ­£å¸¸ææ„</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="3-weak-ä¸-unowned-çš„åŒºåˆ«"><a href="#3-weak-ä¸-unowned-çš„åŒºåˆ«" class="headerlink" title="3.weak ä¸ unowned çš„åŒºåˆ«"></a>3.weak ä¸ unowned çš„åŒºåˆ«</h3><p><strong>weak</strong></p><p>A weak reference is a reference that does not keep a strong hold on the instance it refers to, and so does not stop ARC from disposing of the referenced instance. </p><p>Use a weak reference when the other instance has a shorter lifetimeâ€”that is, when the other instance can be deallocated first. </p><p><strong>unowned</strong></p><p>Like a weak reference, an unowned reference does not keep a strong hold on the instance it refers to. Unlike a weak reference, however, an unowned reference is used when the other instance has the same lifetime or a longer lifetime.</p><p>Use an unowned reference only when you are sure that the reference always refers to an instance that has not been deallocated.</p><p>If you try to access the value of an unowned reference after that instance has been deallocated, youâ€™ll get a runtime error.</p><p>weak ä¸ unowned çš„ä½œç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨æ¥è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚åŒºåˆ«åœ¨äºï¼š</p><p><strong>ç”Ÿå‘½å‘¨æœŸï¼š</strong></p><p><strong>weak</strong> å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸€èˆ¬ &lt; weak å¯¹è±¡æ‰€åœ¨çš„ç±»çš„å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“è®¿é—®è¯¥ weak å¯¹è±¡æ—¶å®ƒå¯èƒ½å·²ç»è¢«é‡Šæ”¾äº†ï¼Œæ¯”å¦‚ delegateã€æˆ¿å­ä¸­çš„ç§Ÿå®¢ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123; <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name &#125;<br>    <span class="hljs-keyword">var</span> apartment: <span class="hljs-type">Apartment</span>?<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(name)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Apartment</span> &#123;<br>    <span class="hljs-keyword">let</span> unit: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">unit</span>: <span class="hljs-type">String</span>) &#123; <span class="hljs-keyword">self</span>.unit <span class="hljs-operator">=</span> unit &#125;<br>    <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> tenant: <span class="hljs-type">Person</span>?<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Apartment <span class="hljs-subst">\(unit)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> john: <span class="hljs-type">Person</span>?<br><span class="hljs-keyword">var</span> unit4A: <span class="hljs-type">Apartment</span>?<br>john <span class="hljs-operator">=</span> <span class="hljs-type">Person</span>(name: <span class="hljs-string">&quot;John Appleseed&quot;</span>)<br>unit4A <span class="hljs-operator">=</span> <span class="hljs-type">Apartment</span>(unit: <span class="hljs-string">&quot;4A&quot;</span>)<br><br><span class="hljs-comment">// ç›¸äº’æŒæœ‰</span><br>john<span class="hljs-operator">!</span>.apartment <span class="hljs-operator">=</span> unit4A<br>unit4A<span class="hljs-operator">!</span>.tenant <span class="hljs-operator">=</span> john<br><br><span class="hljs-comment">// çœ‹çœ‹æ˜¯å¦èƒ½è°ƒç”¨å„è‡ªçš„ææ„å‡½æ•°</span><br>john <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>unit4A <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight mizar"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mizar">John Appleseed <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br>Apartment 4A <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br></code></pre></td></tr></table></figure><p>è¯´æ˜ä¸¤ä¸ªå¯¹è±¡éƒ½å·²ç»é¡ºåˆ©é‡Šæ”¾äº†~</p><p><strong>unowned</strong> å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸€èˆ¬ &gt;&#x3D; unowned å¯¹è±¡æ‰€åœ¨çš„ç±»çš„å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚æ¯”å¦‚ Customer ä¸ CreditCardï¼Œäººå¯èƒ½æ²¡æœ‰ä¿¡ç”¨å¡ï¼Œä½†ä¿¡ç”¨å¡ä¸€å®šå¾—æœ‰ä¸ªä¸»äººï¼ŒCustomerçš„ç”Ÿå‘½å‘¨æœŸæ¯” CreditCard é•¿ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> &#123;<br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">var</span> card: <span class="hljs-type">CreditCard</span>?<br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(name)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCard</span> &#123;<br>    <span class="hljs-keyword">let</span> number: <span class="hljs-type">UInt64</span><br>    <span class="hljs-keyword">unowned</span> <span class="hljs-keyword">let</span> customer: <span class="hljs-type">Customer</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">number</span>: <span class="hljs-type">UInt64</span>, <span class="hljs-params">customer</span>: <span class="hljs-type">Customer</span>) &#123;<br>        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> number<br>        <span class="hljs-keyword">self</span>.customer <span class="hljs-operator">=</span> customer<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Card #<span class="hljs-subst">\(number)</span> is being deinitialized&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-comment">// ç›¸äº’æŒæœ‰</span><br><span class="hljs-keyword">var</span> john: <span class="hljs-type">Customer</span>? <span class="hljs-operator">=</span> <span class="hljs-type">Customer</span>(name: <span class="hljs-string">&quot;John Appleseed&quot;</span>)<br>john<span class="hljs-operator">!</span>.card <span class="hljs-operator">=</span> <span class="hljs-type">CreditCard</span>(number: <span class="hljs-number">1234_5678_9012_3456</span>, customer: john<span class="hljs-operator">!</span>)<br><span class="hljs-comment">// å°è¯•çœ‹Customerå’ŒCreditCardå¯¹è±¡æ˜¯å¦èƒ½é¡ºåˆ©ææ„</span><br>john <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight mizar"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mizar">John Appleseed <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br>Card #1234567890123456 <span class="hljs-keyword">is</span> <span class="hljs-keyword">being</span> deinitialized<br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ªå®ä¾‹éƒ½é¡ºåˆ©ææ„å¹¶é‡Šæ”¾å†…å­˜~</p><p><strong>é‡æŒ‡é’ˆé—®é¢˜</strong></p><p><strong>weak</strong> å¯¹è±¡é‡Šæ”¾åå¼±å¼•ç”¨ä¹Ÿéšå³æ¶ˆå¤±ï¼Œç»§ç»­è®¿é—®è¯¥å¯¹è±¡æ—¶ç¨‹åºä¼šå¾—åˆ° nilï¼Œä¸ä¼šå´©æºƒã€‚</p><p><strong>unowned</strong> å¯¹è±¡åœ¨é‡Šæ”¾åï¼Œä¾ç„¶æœ‰ä¸€ä¸ªæ— æ•ˆçš„å¼•ç”¨æŒ‡å‘å¯¹è±¡ï¼Œå®ƒä¸æ˜¯ Optional ä¹Ÿä¸æŒ‡å‘ nilã€‚å¦‚æœç»§ç»­è®¿é—®è¯¥å¯¹è±¡å°±ä¼šå´©æºƒã€‚</p><h3 id="4-åæ€"><a href="#4-åæ€" class="headerlink" title="4.åæ€"></a>4.åæ€</h3><p>å¾ªç¯å¼•ç”¨ï¼Œä»å…¶å‘½åæ¥çœ‹å®é™…ä¸Šæ˜¯ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li>å¾ªç¯</li><li>å¼•ç”¨</li></ul><p>å³å¯¹è±¡ä¹‹é—´å‡ºç°äº†ç›¸äº’å¼•ç”¨çš„æ€ªåœˆã€‚åœ¨è§£å†³æ­¤ç±»é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ååº”å¾€å¾€æ˜¯ä½¿ç”¨<code>weak</code>æˆ–<code>unowned</code>æ¥å¼±å¼•ç”¨å¯¹è±¡ï¼Œä»è€Œæ‰“ç ´è¿™ä¸ªç¯ï¼Œè¿™è§£å†³äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼›</p><p>å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»ç¬¬äºŒä¸ªé—®é¢˜æ¥å…¥æ‰‹ï¼šä»”ç»†å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ‰€è§åˆ°çš„å¾ªç¯å¼•ç”¨ä¸€èˆ¬éƒ½æ˜¯å‡ºç°åœ¨ä¸¤ä¸ªæˆ–å¤šä¸ª<code>å¼•ç”¨</code>ç±»å‹ä¹‹é—´ï¼Œæ¯”å¦‚<code>é—­åŒ…</code>å’Œ<code>ç±»</code>ä¹‹é—´ã€‚æ‰€ä»¥æ¢ä¸ªè§’åº¦æ¥æƒ³ï¼Œå¦‚æœå°†å¼•ç”¨ç±»å‹æ”¹æˆå€¼ç±»å‹ï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸å­˜åœ¨ç›¸äº’<code>å¼•ç”¨</code>çš„æƒ…å†µäº†ï¼Œæ¯”å¦‚å¯èƒ½çš„è¯ï¼Œå°†æŸäº›<code>ç±»</code>æ”¹æˆå€¼ç±»å‹çš„<code>ç»“æ„ä½“</code>æ¥å®ç°:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Customer</span> &#123; <span class="hljs-comment">// å°†æ­¤ç±»æ”¹æˆç”±ç»“æ„ä½“æ¥å®ç°</span><br>    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><br>    <span class="hljs-keyword">var</span> card: <span class="hljs-type">CreditCard</span>?<br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) &#123;<br>        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCard</span> &#123;<br>    <span class="hljs-keyword">let</span> number: <span class="hljs-type">UInt64</span><br>    <span class="hljs-keyword">let</span> customer: <span class="hljs-type">Customer</span> <span class="hljs-comment">// è¿™é‡Œä¹Ÿä¸å†éœ€è¦ unowned ä¿®é¥°äº†</span><br>    <span class="hljs-keyword">init</span>(<span class="hljs-params">number</span>: <span class="hljs-type">UInt64</span>, <span class="hljs-params">customer</span>: <span class="hljs-type">Customer</span>) &#123;<br>        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> number<br>        <span class="hljs-keyword">self</span>.customer <span class="hljs-operator">=</span> customer<br>    &#125;<br>    <span class="hljs-keyword">deinit</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Card #<span class="hljs-subst">\(number)</span> is being deinitialized&quot;</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// playgroundä¸­å®šä¹‰çš„æ–¹æ³•</span><br><span class="hljs-keyword">func</span> <span class="hljs-title function_">tryStruct</span>()&#123;<br>    <span class="hljs-keyword">var</span> customer <span class="hljs-operator">=</span> <span class="hljs-type">Customer</span>(name: <span class="hljs-string">&quot;XXX&quot;</span>)<br>    <span class="hljs-keyword">let</span> card <span class="hljs-operator">=</span> <span class="hljs-type">CreditCard</span>(number: <span class="hljs-number">10</span>, customer: customer)<br>    customer.card <span class="hljs-operator">=</span> card;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">tryStruct</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">Card <span class="hljs-string">#10</span> <span class="hljs-keyword">is</span> being deinitialized<br></code></pre></td></tr></table></figure><p>åˆ†æï¼š</p><ul><li>å®¢æˆ·å¯¹è±¡æ˜¯ç»“æ„ä½“ï¼Œä½œä¸ºä¿¡ç”¨å¡çš„å‚æ•°æ—¶æ˜¯å€¼çš„æ‹·è´è€Œéå¼•ç”¨ï¼Œå› æ­¤ä¸å­˜åœ¨ç›¸äº’å¼•ç”¨ä¸€è¯´ï¼›</li><li>ä½œä¸ºå€¼ç±»å‹çš„å®¢æˆ·å¯¹è±¡ï¼Œåœ¨å‡ºäº†æ–¹æ³•ä½“ä¹‹åè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚</li></ul><p>ç»¼ä¸Šï¼Œè§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜æ—¶ï¼Œå¯ä»¥ä»å¼±åŒ–å¼•ç”¨å’Œæ›¿æ¢æˆå€¼ç±»å‹ä¸¤å¤„å…¥æ‰‹~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html#ID52">Â©Swift:ARC</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¾ªç¯å¼•ç”¨</tag>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swiftä¸­Errorå¼‚å¸¸</title>
    <link href="/2018/08/18/swift-error.html"/>
    <url>/2018/08/18/swift-error.html</url>
    
    <content type="html"><![CDATA[<h4 id="1-å¼‚å¸¸çš„è¡¨ç¤º"><a href="#1-å¼‚å¸¸çš„è¡¨ç¤º" class="headerlink" title="1.å¼‚å¸¸çš„è¡¨ç¤º"></a>1.å¼‚å¸¸çš„è¡¨ç¤º</h4><p>Swiftä¸­ç”¨å®ç°äº†<code>Error</code>åè®®çš„ç±»å‹è¡¨ç¤ºå¼‚å¸¸ï¼Œé€šå¸¸ç”¨æšä¸¾æ¥è¡¨ç¤ºä¸€ç»„é”™è¯¯ä¿¡æ¯ã€‚</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-keyword">enum</span> VendingMachineError: Error &#123;<br>    <span class="hljs-keyword">case</span> invalidSelection<br>    <span class="hljs-keyword">case</span> insufficientFunds(coinsNeeded: <span class="hljs-built_in">Int</span>)<br>    <span class="hljs-keyword">case</span> outOfStock<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-æŠ›å‡ºå¼‚å¸¸"><a href="#2-æŠ›å‡ºå¼‚å¸¸" class="headerlink" title="2.æŠ›å‡ºå¼‚å¸¸"></a>2.æŠ›å‡ºå¼‚å¸¸</h4><p>åœ¨æ–¹æ³•çš„å‚æ•°åï¼Œè¿”å›å€¼å‰ä½¿ç”¨<code>throws</code>æ ‡è®°å¯èƒ½æ–¹æ³•å¯èƒ½æŠ›å‡ºå¼‚å¸¸ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Item</span> &#123;<br>    <span class="hljs-keyword">var</span> price: <span class="hljs-type">Int</span><br>    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span><br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">VendingMachine</span> &#123;<br>    <span class="hljs-keyword">var</span> inventory <span class="hljs-operator">=</span> [<br>        <span class="hljs-string">&quot;Candy Bar&quot;</span>: <span class="hljs-type">Item</span>(price: <span class="hljs-number">12</span>, count: <span class="hljs-number">7</span>),<br>        <span class="hljs-string">&quot;Chips&quot;</span>: <span class="hljs-type">Item</span>(price: <span class="hljs-number">10</span>, count: <span class="hljs-number">4</span>),<br>        <span class="hljs-string">&quot;Pretzels&quot;</span>: <span class="hljs-type">Item</span>(price: <span class="hljs-number">7</span>, count: <span class="hljs-number">11</span>)<br>    ]<br>    <span class="hljs-keyword">var</span> coinsDeposited <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">vend</span>(<span class="hljs-params">itemNamed</span> <span class="hljs-params">name</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">throws</span> &#123;   <span class="hljs-comment">//æŠ›å‡ºå¼‚å¸¸</span><br>        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> item <span class="hljs-operator">=</span> inventory[name] <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-type">VendingMachineError</span>.invalidSelection<br>        &#125;<br><br>        <span class="hljs-keyword">guard</span> item.count <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-type">VendingMachineError</span>.outOfStock<br>        &#125;<br><br>        <span class="hljs-keyword">guard</span> item.price <span class="hljs-operator">&lt;=</span> coinsDeposited <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-type">VendingMachineError</span>.insufficientFunds(coinsNeeded: item.price <span class="hljs-operator">-</span> coinsDeposited)<br>        &#125;<br><br>        coinsDeposited <span class="hljs-operator">-=</span> item.price<br><br>        <span class="hljs-keyword">var</span> newItem <span class="hljs-operator">=</span> item<br>        newItem.count <span class="hljs-operator">-=</span> <span class="hljs-number">1</span><br>        inventory[name] <span class="hljs-operator">=</span> newItem<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Dispensing <span class="hljs-subst">\(name)</span>&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-å¼‚å¸¸çš„å¤„ç†"><a href="#3-å¼‚å¸¸çš„å¤„ç†" class="headerlink" title="3.å¼‚å¸¸çš„å¤„ç†"></a>3.å¼‚å¸¸çš„å¤„ç†</h4><p>å¼‚å¸¸è¢«æŠ›å‡ºåï¼Œå¿…é¡»è¦æœ‰ç›¸åº”çš„ä»£ç å—å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚å¯åˆ†å››ç§å¤„ç†æ–¹æ³•ï¼š</p><ul><li>å°†å¼‚å¸¸ä¼ é€’ç»™è°ƒç”¨æ­¤å‡½æ•°çš„ä»£ç ï¼›</li><li>ä½¿ç”¨do-catchè¯­å¥å¤„ç†å¼‚å¸¸ï¼›</li><li>å°†å¼‚å¸¸ä½œä¸ºå¯é€‰ç±»å‹å¤„ç†ï¼›</li><li>æ–­è¨€å¼‚å¸¸ç»ä¸ä¼šå‘ç”Ÿï¼Œä¸‡ä¸€çœŸçš„å‘ç”Ÿåˆ™é—ªé€€ï¼›</li></ul><p>å¼‚å¸¸ä¼šæ”¹å˜ä»£ç çš„æ‰§è¡Œè·¯å¾„ï¼Œä½¿ç”¨<code>try</code>ã€<code>try?</code>æˆ–è€…<code>try!</code>æ ‡è®°å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„åœ°æ–¹ã€‚</p><ul><li>ç¤ºä¾‹1ï¼šä¼ é€’å¼‚å¸¸</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">let</span> favoriteSnacks <span class="hljs-operator">=</span> [<br>    <span class="hljs-string">&quot;Alice&quot;</span>: <span class="hljs-string">&quot;Chips&quot;</span>,<br>    <span class="hljs-string">&quot;Bob&quot;</span>: <span class="hljs-string">&quot;Licorice&quot;</span>,<br>    <span class="hljs-string">&quot;Eve&quot;</span>: <span class="hljs-string">&quot;Pretzels&quot;</span>,<br>]<br><span class="hljs-keyword">func</span> <span class="hljs-title function_">buyFavoriteSnack</span>(<span class="hljs-params">person</span>: <span class="hljs-type">String</span>, <span class="hljs-params">vendingMachine</span>: <span class="hljs-type">VendingMachine</span>) <span class="hljs-keyword">throws</span> &#123; <span class="hljs-comment">//å‘ä¸Šä¼ é€’å¼‚å¸¸</span><br>    <span class="hljs-keyword">let</span> snackName <span class="hljs-operator">=</span> favoriteSnacks[person] <span class="hljs-operator">??</span> <span class="hljs-string">&quot;Candy Bar&quot;</span><br>    <span class="hljs-keyword">try</span> vendingMachine.vend(itemNamed: snackName)  <span class="hljs-comment">//å°†å¼‚å¸¸å‘ä¸Šä¼ é€’</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç¤ºä¾‹2ï¼šdo-catch</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-keyword">try</span> expression<br>    statements<br>&#125; <span class="hljs-keyword">catch</span> pattern <span class="hljs-number">1</span> &#123;<br>    statements<br>&#125; <span class="hljs-keyword">catch</span> pattern <span class="hljs-number">2</span> <span class="hljs-keyword">where</span> condition &#123;<br>    statements<br>&#125; <span class="hljs-keyword">catch</span> pattern <span class="hljs-number">3</span>, pattern <span class="hljs-number">4</span> <span class="hljs-keyword">where</span> condition &#123;<br>    statements<br>&#125; <span class="hljs-keyword">catch</span> &#123;<br>    statements<br>&#125;<br><br><span class="hljs-comment">//å…·ä½“æ¡ˆä¾‹</span><br><span class="hljs-keyword">var</span> vendingMachine <span class="hljs-operator">=</span> <span class="hljs-type">VendingMachine</span>()<br>vendingMachine.coinsDeposited <span class="hljs-operator">=</span> <span class="hljs-number">8</span><br><span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-keyword">try</span> buyFavoriteSnack(person: <span class="hljs-string">&quot;Alice&quot;</span>, vendingMachine: vendingMachine)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Success! Yum.&quot;</span>)<br>&#125; <span class="hljs-keyword">catch</span> <span class="hljs-type">VendingMachineError</span>.invalidSelection &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Invalid Selection.&quot;</span>)<br>&#125; <span class="hljs-keyword">catch</span> <span class="hljs-type">VendingMachineError</span>.outOfStock &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Out of Stock.&quot;</span>)<br>&#125; <span class="hljs-keyword">catch</span> <span class="hljs-type">VendingMachineError</span>.insufficientFunds(<span class="hljs-keyword">let</span> coinsNeeded) &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Insufficient funds. Please insert an additional <span class="hljs-subst">\(coinsNeeded)</span> coins.&quot;</span>)<br>&#125; <span class="hljs-keyword">catch</span> &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Unexpected error: <span class="hljs-subst">\(error)</span>.&quot;</span>)<br>&#125;<br><span class="hljs-comment">// Prints &quot;Insufficient funds. Please insert an additional 2 coins.&quot;</span><br></code></pre></td></tr></table></figure><ul><li>ç¤ºä¾‹3ï¼štry?è½¬ä¸ºå¯é€‰ç±»å‹</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function">func <span class="hljs-title">someThrowingFunction</span>() throws -&gt; Int</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">let</span> x = <span class="hljs-keyword">try</span>? someThrowingFunction()<br><br><span class="hljs-keyword">let</span> y: Int?<br><span class="hljs-keyword">do</span> &#123;<br>    y = <span class="hljs-function"><span class="hljs-keyword">try</span> <span class="hljs-title">someThrowingFunction</span>()</span><br><span class="hljs-function">&#125; <span class="hljs-keyword">catch</span></span> &#123;<br>    y = nil<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<code>try?</code>å°†å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•çš„è¿”å›å€¼è½¬æ¢æˆå¯é€‰ç±»å‹ã€‚å¦‚æœæœªæŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™try?è¡¨è¾¾å¼çš„å€¼å³ä¸ºå‡½æ•°çš„å€¼ï¼›å¦‚æœæŠ›å‡ºäº†å¼‚å¸¸åˆ™è¡¨è¾¾å¼çš„å€¼ä¸ºnilã€‚</p><ul><li>ç¤ºä¾‹4ï¼štry!</li></ul><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">let</span> photo = <span class="hljs-keyword">try</span>! load<span class="hljs-constructor">Image(<span class="hljs-params">atPath</span>: <span class="hljs-string">&quot;./Resources/John Appleseed.jpg&quot;</span>)</span><br></code></pre></td></tr></table></figure><p><code>try!</code>æ–­è¨€æ­¤æ–¹æ³•çš„è°ƒç”¨ä¸ä¼šå‡ºç°å¼‚å¸¸ï¼Œå¦‚æœçœŸçš„æŠ›å‡ºå¼‚å¸¸åˆ™ä¼šæŠ¥è¿è¡Œæ—¶é”™è¯¯ã€‚</p><h4 id="4-å…¼å®¹NSError"><a href="#4-å…¼å®¹NSError" class="headerlink" title="4.å…¼å®¹NSError"></a>4.å…¼å®¹NSError</h4><p>Swiftä¸­<code>Error</code>å¯ç›´æ¥è½¬æ¢æˆOCä¸­çš„<code>NSError</code>, å¦‚<code>SomeError.error0 as NSError</code>ï¼Œåªæ˜¯æ²¡æœ‰errorCode, domainç­‰ä¿¡æ¯ã€‚å¦‚æœæƒ³å’ŒNSErrorä¸€æ ·, åˆ™éœ€è¦å®ç°<code>LocalizedError</code>ä¸<code>CustomNSError</code>åè®®:</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">SwiftError</span>: <span class="hljs-title class_">Error</span>, <span class="hljs-title class_">LocalizedError</span>, <span class="hljs-title class_">CustomNSError</span> &#123;<br>    <span class="hljs-keyword">case</span> error0, error1<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> errorDescription: <span class="hljs-type">String</span>? &#123;<br>        <span class="hljs-keyword">switch</span> <span class="hljs-keyword">self</span> &#123;<br>        <span class="hljs-keyword">case</span> .error0:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error description error0&quot;</span><br>        <span class="hljs-keyword">case</span> .error1:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error description error1&quot;</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">var</span> errorCode: <span class="hljs-type">Int</span> &#123;<br>        <span class="hljs-keyword">switch</span> <span class="hljs-keyword">self</span> &#123;<br>        <span class="hljs-keyword">case</span> .error0:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        <span class="hljs-keyword">case</span> .error1:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> errorDomain: <span class="hljs-type">String</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error domain SwiftError&quot;</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> errorUserInfo: [<span class="hljs-type">String</span> : <span class="hljs-keyword">Any</span>] &#123;<br>        <span class="hljs-keyword">switch</span> <span class="hljs-keyword">self</span> &#123;<br>        <span class="hljs-keyword">case</span> .error0:<br>            <span class="hljs-keyword">return</span> [<span class="hljs-string">&quot;info&quot;</span>: <span class="hljs-string">&quot;This is Error0&quot;</span>]<br>        <span class="hljs-keyword">case</span> .error1:<br>            <span class="hljs-keyword">return</span> [<span class="hljs-string">&quot;info&quot;</span>: <span class="hljs-string">&quot;This is error1&quot;</span>]<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-built_in">print</span>(<span class="hljs-type">SwiftError</span>.error0 <span class="hljs-keyword">as</span> <span class="hljs-type">NSError</span>) <span class="hljs-comment">//__lldb_expr_7.SwiftError.error0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-type">SwiftError</span>.error0.errorCode)  <span class="hljs-comment">//0</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swift-is/asç±»å‹æ£€æŸ¥</title>
    <link href="/2018/08/16/swift-as.html"/>
    <url>/2018/08/16/swift-as.html</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h3><p>ä½œä¸ºé¢å‘å¯¹è±¡çš„è¯­è¨€ï¼ŒOC ä¸ Swift éƒ½å…·æœ‰å¤šæ€æ€§ï¼Œæœ‰æ—¶ä¼šå¤§é‡ä½¿ç”¨ç±»ç°‡ï¼Œå› æ­¤æè¿°å¯¹è±¡çš„ä¿¡æ¯æˆä¸ºäº†å¸¸è§éœ€æ±‚ã€‚</p><ul><li>åˆ¤æ–­å¯¹è±¡åœ¨ç»§æ‰¿æ ‘ä¸Šçš„ä½ç½®ï¼›</li><li>åˆ¤æ–­å¯¹è±¡æ˜¯å¦éµå®ˆäº†æŸä¸ªåè®®ï¼›</li></ul><p>è¿™äº›éƒ½æ˜¯å¯¹è±¡<code>å†…çœ</code>èƒ½åŠ›çš„ä¸€éƒ¨åˆ†ï¼Œæœ¬æ–‡å°†å°è¯•å¯¹ OC å’Œ Swift ä¸­è¿™äº›åœºæ™¯çš„å®ç°åšä¸€æ¬¡æ•´ç†ã€‚</p><h3 id="äºŒã€OCç‰ˆ"><a href="#äºŒã€OCç‰ˆ" class="headerlink" title="äºŒã€OCç‰ˆ"></a>äºŒã€OCç‰ˆ</h3><p>NSObject<code>åè®®</code>ä¸­æä¾›äº†è¯¸å¤šå†…çœæ–¹æ³•ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºä»¥ä¸‹ä¸‰ä¸ªï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs erlang">//NSObject.h<br>@protocol NSObject<br>...<br>- <span class="hljs-params">(BOOL)</span>isKindOfClass:<span class="hljs-params">(Class)</span>aClass; // æè¿°å¯¹è±¡çš„å®Œæ•´ç»§æ‰¿æ ‘ï¼ˆåŒ…æ‹¬ç›´å±ç±»ã€çˆ¶ç±»ã€åŸºç±»ï¼‰<br>- <span class="hljs-params">(BOOL)</span>isMemberOfClass:<span class="hljs-params">(Class)</span>aClass; // æè¿°å¯¹è±¡æœ¬èº«ç›´å±çš„ç±»<br>- <span class="hljs-params">(BOOL)</span>conformsToProtocol:<span class="hljs-params">(Protocol *)</span>aProtocol;<br>...<br>@<span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸¤ä¸ªç±»ï¼Œä»¥æ–¹ä¾¿æ¥ä¸‹æ¥çš„è®¨è®ºï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">// protocol</span><br><span class="hljs-variable">@protocol</span> MakeNoise &lt;NSObject&gt;<br>- (void)scream;<br><span class="hljs-variable">@end</span><br><br><span class="hljs-comment">// Animal</span><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">Animal </span>: NSObject&lt;MakeNoise&gt;<br><span class="hljs-variable">@end</span><br><br><span class="hljs-variable">@implementation</span> Animal<br>- (void)scream&#123;<br>    <span class="hljs-selector-tag">NSLog</span>(@<span class="hljs-string">&quot;++++Animal scream~&quot;</span>);<br>&#125;<br>@<span class="hljs-selector-tag">end</span><br><br><span class="hljs-comment">// Cat</span><br>@<span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">Cat</span> : <span class="hljs-selector-tag">Animal</span><br>@<span class="hljs-selector-tag">property</span> (nonatomic, copy) <span class="hljs-selector-tag">NSString</span> *<span class="hljs-selector-tag">name</span>; <span class="hljs-comment">//å­ç±»ç‹¬æœ‰çš„å±æ€§</span><br>@<span class="hljs-selector-tag">end</span><br><br>@<span class="hljs-selector-tag">implementation</span> <span class="hljs-selector-tag">Cat</span><br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">scream</span>&#123;<br>    <span class="hljs-selector-tag">NSLog</span>(@<span class="hljs-string">&quot;+++Cat miao~&quot;</span>);<br>&#125;<br>@<span class="hljs-selector-tag">end</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿›å…¥æ­£é¢˜~</p><h4 id="1-isMemberOfClass"><a href="#1-isMemberOfClass" class="headerlink" title="1.isMemberOfClass"></a>1.isMemberOfClass</h4><p><strong>å®šä¹‰ï¼š</strong></p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(BOOL)</span>isMemberOfClass:<span class="hljs-params">(Class)</span>aClass;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨ï¼š</strong></p><blockquote><p>Returns a Boolean value that indicates whether the receiver is an instance of a given class.</p></blockquote><p>æ£€æŸ¥å¯¹è±¡æ˜¯å¦æ˜¯æŸä¸ªç±»çš„<code>ç›´å±å¯¹è±¡</code>ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">- (void)classCast&#123;<br>    Animal *animal = <span class="hljs-literal">[A<span class="hljs-identifier">nimal</span> <span class="hljs-identifier">new</span>]</span>;<br>    Cat *cat = <span class="hljs-literal">[C<span class="hljs-identifier">at</span> <span class="hljs-identifier">new</span>]</span>;<br>    Animal *aniCat = <span class="hljs-literal">[C<span class="hljs-identifier">at</span> <span class="hljs-identifier">new</span>]</span>; <span class="hljs-comment">// çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»ï¼Œå³æŠŠå­ç±»è½¬æˆçˆ¶ç±»ï¼Œå‘ä¸Šè½¬å‹</span><br>    Cat *catAni = <span class="hljs-literal">[A<span class="hljs-identifier">nimal</span> <span class="hljs-identifier">new</span>]</span>; <span class="hljs-comment">// å­ç±»æŒ‡é’ˆæŒ‡å‘çˆ¶ç±»ï¼Œå³æŠŠçˆ¶ç±»è½¬åŒ–æˆå­ç±»ï¼Œå‘ä¸‹è½¬å‹ï¼ŒOCä¸­ä¸èƒ½è¿™ä¹ˆåš</span><br>    <span class="hljs-comment">// catAni.name; è¿™é‡Œç¼–è¯‘å™¨ä¸ä¼šæŠ¥é”™ï¼Œä½†è¿è¡Œæ—¶ä¼šé—ªé€€ï¼Œå› ä¸ºcatAniå®é™…ä¸ŠæŒ‡å‘çš„æ˜¯çˆ¶ç±»Animalï¼Œè€ŒAnimalæ˜¾ç„¶æ²¡æœ‰nameå±æ€§ã€‚</span><br>    <br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[animal isMemberOfClass:[Animal class]]:%d&quot;</span>,[<span class="hljs-params">animal</span> <span class="hljs-params">isMemberOfClass</span>:[Animal <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[cat isMemberOfClass:[Animal class]]:%d&quot;</span>,[<span class="hljs-params">cat</span> <span class="hljs-params">isMemberOfClass</span>:[Animal <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[cat isMemberOfClass:[Cat class]]:%d&quot;</span>,[<span class="hljs-params">cat</span> <span class="hljs-params">isMemberOfClass</span>:[Cat <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[aniCat isMemberOfClass:[Animal class]]:%d&quot;</span>,[<span class="hljs-params">aniCat</span> <span class="hljs-params">isMemberOfClass</span>:[Animal <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[aniCat isMemberOfClass:[Cat class]]:%d&quot;</span>,[<span class="hljs-params">aniCat</span> <span class="hljs-params">isMemberOfClass</span>:[Cat <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[catAni isMemberOfClass:[Cat class]]:%d&quot;</span>,[<span class="hljs-params">catAni</span> <span class="hljs-params">isMemberOfClass</span>:[Cat <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[catAni isMemberOfClass:[Animal class]]:%d&quot;</span>,[<span class="hljs-params">catAni</span> <span class="hljs-params">isMemberOfClass</span>:[Animal <span class="hljs-params">class</span>]])</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">+++[animal isMemberOfClass:[Animal <span class="hljs-keyword">class</span>]]:<span class="hljs-symbol">1</span><br>+++[<span class="hljs-symbol">cat</span> <span class="hljs-symbol">isMemberOfClass:</span>[<span class="hljs-symbol">Animal</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">0</span><br>+++[<span class="hljs-symbol">cat</span> <span class="hljs-symbol">isMemberOfClass:</span>[<span class="hljs-symbol">Cat</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">1</span><br>+++[<span class="hljs-symbol">aniCat</span> <span class="hljs-symbol">isMemberOfClass:</span>[<span class="hljs-symbol">Animal</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">0</span><br>+++[<span class="hljs-symbol">aniCat</span> <span class="hljs-symbol">isMemberOfClass:</span>[<span class="hljs-symbol">Cat</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">1</span><br>+++[<span class="hljs-symbol">catAni</span> <span class="hljs-symbol">isMemberOfClass:</span>[<span class="hljs-symbol">Cat</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">0</span><br>+++[<span class="hljs-symbol">catAni</span> <span class="hljs-symbol">isMemberOfClass:</span>[<span class="hljs-symbol">Animal</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">1</span><br></code></pre></td></tr></table></figure><p>åˆ†æï¼š</p><ul><li>animal ç›´å±äº Animal ç±»;</li><li>cat ç›´å±äº Cat ç±»ï¼Œä¸ç›´å±äº Animal ç±»ï¼›</li><li>aniCatå’ŒcatAniéƒ½ç›´å±äºå®ƒå®é™…æŒ‡å‘çš„ç±»ï¼Œä¸ç›´å±äºå£°æ˜å®ƒçš„ç±»ï¼›</li></ul><p><strong>ç»“è®ºï¼š</strong></p><ul><li>isMemberOfClass é€‚åˆç”¨æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦<code>ç›´å±äº</code>æŸä¸ªç±»ã€‚</li><li>çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»æ—¶ï¼Œæ­¤å¯¹è±¡å®è´¨ä¸Šæ˜¯å­ç±»çš„å®ä¾‹ï¼›</li><li>å­ç±»æŒ‡é’ˆæŒ‡å‘çˆ¶ç±»æ—¶ï¼Œæ­¤å¯¹è±¡å®è´¨ä¸Šæ˜¯çˆ¶ç±»çš„å®ä¾‹ã€‚</li></ul><p>é¢å¤–ä¿¡æ¯ï¼š</p><blockquote><p>OCä¸­ä¸å…è®¸å‘ä¸‹è½¬å‹ï¼Œä¸èƒ½å°†çˆ¶ç±»è½¬åŒ–æˆå­ç±»ï¼Œå³å­ç±»æŒ‡é’ˆæŒ‡å‘çˆ¶ç±»ã€‚</p></blockquote><p>è¿™æ˜¯å› ä¸ºçˆ¶ç±»ä¸­æ²¡æœ‰å­ç±»çš„å±æ€§å’Œæ–¹æ³•ï¼Œè¿™æ ·è½¬æ¢å‡ºæ¥çš„å­ç±»å¯¹è±¡å®é™…ä¸Šè¿˜æ˜¯æŒ‡å‘çˆ¶ç±»ï¼Œå®ƒä¸èƒ½ä½¿ç”¨å­ç±»ä¸­çš„å±æ€§å’Œæ–¹æ³•ã€‚è¿™ä¹ˆåšè™½ç„¶ç¼–è¯‘æœŸä¸ä¼šæŠ¥é”™ï¼Œä½†è¿è¡Œæ—¶ä¼šé—ªé€€ã€‚</p><h4 id="2-isKindOfClass"><a href="#2-isKindOfClass" class="headerlink" title="2.isKindOfClass"></a>2.isKindOfClass</h4><p><strong>å®šä¹‰ï¼š</strong></p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(BOOL)</span>isKindOfClass:<span class="hljs-params">(Class)</span>aClass;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨ï¼š</strong></p><blockquote><p>Returns a Boolean value that indicates whether the receiver is an instance of given class or an instance of any class that inherits from that class.</p></blockquote><p>æ£€æŸ¥å¯¹è±¡æ˜¯å¦åœ¨æŸä¸ªç»§æ‰¿æ ‘ä¸Šï¼ŒåŒ…æ‹¬å¯¹è±¡ç›´å±çš„ç±»ã€å¯¹è±¡çš„çˆ¶ç±»ã€åŸºç±»ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">- (void)classCast&#123;<br>    Animal *animal = <span class="hljs-literal">[A<span class="hljs-identifier">nimal</span> <span class="hljs-identifier">new</span>]</span>;<br>    Cat *cat = <span class="hljs-literal">[C<span class="hljs-identifier">at</span> <span class="hljs-identifier">new</span>]</span>;<br>    Animal *aniCat = <span class="hljs-literal">[C<span class="hljs-identifier">at</span> <span class="hljs-identifier">new</span>]</span>; <span class="hljs-comment">// çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»ï¼Œå³å°†å­ç±»è½¬æˆçˆ¶ç±»ï¼Œå‘ä¸Šè½¬å‹</span><br>    Cat *catAni = <span class="hljs-literal">[A<span class="hljs-identifier">nimal</span> <span class="hljs-identifier">new</span>]</span>; <span class="hljs-comment">// å­ç±»æŒ‡é’ˆæŒ‡å‘çˆ¶ç±»ï¼Œå³æŠŠçˆ¶ç±»è½¬åŒ–æˆå­ç±»ï¼Œå‘ä¸‹è½¬å‹ï¼ŒOCä¸­ä¸èƒ½è¿™ä¹ˆåš</span><br>    <br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[animal isKindOfClass:[Animal class]]:%d&quot;</span>,[<span class="hljs-params">animal</span> <span class="hljs-params">isKindOfClass</span>:[Animal <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[cat isKindOfClass:[Animal class]]:%d&quot;</span>,[<span class="hljs-params">cat</span> <span class="hljs-params">isKindOfClass</span>:[Animal <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[cat isKindOfClass:[Cat class]]:%d&quot;</span>,[<span class="hljs-params">cat</span> <span class="hljs-params">isKindOfClass</span>:[Cat <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[aniCat isKindOfClass:[Animal class]]:%d&quot;</span>,[<span class="hljs-params">aniCat</span> <span class="hljs-params">isKindOfClass</span>:[Animal <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[aniCat isKindOfClass:[Cat class]]:%d&quot;</span>,[<span class="hljs-params">aniCat</span> <span class="hljs-params">isKindOfClass</span>:[Cat <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[catAni isKindOfClass:[Cat class]]:%d&quot;</span>,[<span class="hljs-params">catAni</span> <span class="hljs-params">isKindOfClass</span>:[Cat <span class="hljs-params">class</span>]])</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++[catAni isKindOfClass:[Animal class]]:%d&quot;</span>,[<span class="hljs-params">catAni</span> <span class="hljs-params">isKindOfClass</span>:[Animal <span class="hljs-params">class</span>]])</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">+++[animal isKindOfClass:[Animal <span class="hljs-keyword">class</span>]]:<span class="hljs-symbol">1</span><br>+++[<span class="hljs-symbol">cat</span> <span class="hljs-symbol">isKindOfClass:</span>[<span class="hljs-symbol">Animal</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">1</span><br>+++[<span class="hljs-symbol">cat</span> <span class="hljs-symbol">isKindOfClass:</span>[<span class="hljs-symbol">Cat</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">1</span><br>+++[<span class="hljs-symbol">aniCat</span> <span class="hljs-symbol">isKindOfClass:</span>[<span class="hljs-symbol">Animal</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">1</span><br>+++[<span class="hljs-symbol">aniCat</span> <span class="hljs-symbol">isKindOfClass:</span>[<span class="hljs-symbol">Cat</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">1</span><br>+++[<span class="hljs-symbol">catAni</span> <span class="hljs-symbol">isKindOfClass:</span>[<span class="hljs-symbol">Cat</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">0</span><br>+++[<span class="hljs-symbol">catAni</span> <span class="hljs-symbol">isKindOfClass:</span>[<span class="hljs-symbol">Animal</span> <span class="hljs-symbol">class</span>]]:<span class="hljs-symbol">1</span><br></code></pre></td></tr></table></figure><p>åˆ†æï¼šanimalã€catã€aniCatã€catAni æ˜¯å…¶ç›´å±ç±»ã€çˆ¶ç±»ã€åŸºç±»çš„æ‰€å±ç±»ã€‚</p><p><strong>ç»“è®ºï¼š</strong>åªè¦åœ¨å¯¹è±¡ç›´å±ç±»åŠå…¶ä¹‹ä¸Šçš„ç»§æ‰¿æ ‘ä¸Šï¼ŒisKindOfClasséƒ½ä¼šè¿”å› YESã€‚</p><h4 id="3-conformsToProtocol"><a href="#3-conformsToProtocol" class="headerlink" title="3.conformsToProtocol"></a>3.conformsToProtocol</h4><p><strong>å®šä¹‰ï¼š</strong></p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(BOOL)</span>conformsToProtocol:<span class="hljs-params">(Protocol *)</span>aProtocol;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨ï¼š</strong></p><blockquote><p>Returns a Boolean value that indicates whether the receiver conforms to a given protocol.</p></blockquote><p>æ£€æµ‹å¯¹è±¡æ˜¯å¦éµå®ˆäº†æŸä¸ªåè®®ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">- (<span class="hljs-keyword">void</span>)protocolCast&#123;<br>    Animal *animal = [Animal <span class="hljs-keyword">new</span>];<br>    Cat *cat = [Cat <span class="hljs-keyword">new</span>];<br>    Animal *aniCat = [Cat <span class="hljs-keyword">new</span>]; <span class="hljs-comment">// çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»ï¼Œå³å°†å­ç±»è½¬æˆçˆ¶ç±»ï¼Œå‘ä¸Šè½¬å‹</span><br>    <br>    NSLog(@<span class="hljs-string">&quot;+++[animal conformsToProtocol:@protocol(MakeNoise)]:%d&quot;</span>,<br>    [animal conformsToProtocol:<span class="hljs-meta">@protocol(MakeNoise)</span>]);<br>    <br>    NSLog(@<span class="hljs-string">&quot;+++[cat conformsToProtocol:@protocol(MakeNoise)]:%d&quot;</span>,<br>    [cat conformsToProtocol:<span class="hljs-meta">@protocol(MakeNoise)</span>]);<br>    <br>    NSLog(@<span class="hljs-string">&quot;+++[aniCat conformsToProtocol:@protocol(MakeNoise)]:%d&quot;</span>,<br>    [aniCat conformsToProtocol:<span class="hljs-meta">@protocol(MakeNoise)</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">+++[animal conformsToProtocol:<span class="hljs-meta">@protocol(MakeNoise)</span>]:<span class="hljs-number">1</span><br>+++[cat conformsToProtocol:<span class="hljs-meta">@protocol(MakeNoise)</span>]:<span class="hljs-number">1</span><br>+++[aniCat conformsToProtocol:<span class="hljs-meta">@protocol(MakeNoise)</span>]:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>åˆ†æï¼š</p><ul><li>animal å¯¹è±¡æ‰€å±ç±»æ˜¾å¼å£°æ˜å¹¶éµå®ˆäº† MakeNoise åè®®ï¼›</li><li>cat ç›´å±ç±»è™½æœªç›´æ¥å£°æ˜éµå®ˆ MakeNoise åè®®ï¼Œä½†å®ƒä¼šç»§æ‰¿å…¶çˆ¶ç±»çš„ç‰¹ç‚¹ï¼Œé»˜è®¤ä¹Ÿéµå®ˆäº†çˆ¶ç±»çš„åè®®ï¼›</li><li>aniCat å®è´¨ä¸Šæ˜¯ Cat ç±»å‹ï¼Œæ‰€ä»¥è·Ÿ cat ä¸€æ ·ï¼Œé»˜è®¤ç»§æ‰¿çˆ¶ç±»çš„ç‰¹ç‚¹ï¼Œä¹Ÿéµå®ˆäº†çˆ¶ç±»ä¸­çš„åè®®ã€‚</li></ul><p><strong>ç»“è®ºï¼š</strong>è‹¥çˆ¶ç±»éµå®ˆäº†æŸåè®®ï¼Œè€Œå­ç±»æœªç›´æ¥éµå®ˆæ­¤åè®®ï¼Œåˆ™å­ç±»ä¾ç„¶ä¼šä»çˆ¶ç±»ä¸­ç»§æ‰¿æ­¤åè®®ã€‚</p><h3 id="ä¸‰ã€Swiftç‰ˆ"><a href="#ä¸‰ã€Swiftç‰ˆ" class="headerlink" title="ä¸‰ã€Swiftç‰ˆ"></a>ä¸‰ã€Swiftç‰ˆ</h3><blockquote><p>Type casting is a way to check the type of an instance, or to treat that instance as a different superclass or subclass from somewhere else in its own class hierarchy.<br>Type casting in Swift is implemented with the is and as operators. These two operators provide a simple and expressive way to check the type of a value or cast a value to a different type.<br>You can also use type casting to check whether a type conforms to a protocol, as described in Checking for Protocol Conformance.</p></blockquote><p><code>is</code>å’Œ<code>as</code>æ“ä½œç¬¦çš„ä½œç”¨ï¼š</p><ul><li>æè¿°å®ä¾‹çš„ç±»å‹ï¼›</li><li>æ£€æŸ¥ç±»å‹æ˜¯å¦éµå®ˆäº†æŸä¸ªåè®®ã€‚</li></ul><p>å…ˆå®šä¹‰ä¸¤ä¸ªç±»ï¼Œæ–¹ä¾¿æ¥ä¸‹æ¥çš„è®¨è®ºï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">MakeNoise</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">scream</span>()<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>: <span class="hljs-title class_">MakeNoise</span> &#123;<br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">scream</span>() &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++<span class="hljs-subst">\(<span class="hljs-keyword">self</span>)</span>++xxxxx~&quot;</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>: <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">scream</span>() &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++<span class="hljs-subst">\(<span class="hljs-keyword">self</span>)</span>:++Miao~&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-isç±»å‹æ£€æŸ¥"><a href="#1-isç±»å‹æ£€æŸ¥" class="headerlink" title="1.isç±»å‹æ£€æŸ¥"></a>1.isç±»å‹æ£€æŸ¥</h4><blockquote><p>Use the type check operator (is) to check whether an instance is of a certain subclass type. The type check operator returns true if the instance is of that subclass type and false if it is not.</p></blockquote><p><code>is</code>ç”¨æ¥æ£€æŸ¥å®ä¾‹æ˜¯å¦å±äºæŸä¸ªç±»æˆ–å­ç±»ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">checkType</span>() &#123;<br>    <span class="hljs-keyword">let</span> animal <span class="hljs-operator">=</span> <span class="hljs-type">Animal</span>()<br>    <span class="hljs-keyword">let</span> cat <span class="hljs-operator">=</span> <span class="hljs-type">Cat</span>()<br>    <span class="hljs-keyword">let</span> aniCat : <span class="hljs-type">Animal</span> <span class="hljs-operator">=</span> <span class="hljs-type">Cat</span>() <span class="hljs-comment">//çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»ï¼Œå‘ä¸Šè½¬å‹</span><br>        <br>    <span class="hljs-comment">// is ç±»å‹æ£€æŸ¥</span><br>    <span class="hljs-keyword">if</span> animal <span class="hljs-keyword">is</span> <span class="hljs-type">Cat</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++animal is Cat~&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">if</span> cat <span class="hljs-keyword">is</span> <span class="hljs-type">Animal</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++cat is Animal~&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">if</span> aniCat <span class="hljs-keyword">is</span> <span class="hljs-type">Animal</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++aniCat is Animal~&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">if</span> aniCat <span class="hljs-keyword">is</span> <span class="hljs-type">Cat</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++aniCat is Cat~&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs inform7">+++cat <span class="hljs-keyword">is</span> <span class="hljs-keyword">Animal</span>~<br>+++aniCat <span class="hljs-keyword">is</span> <span class="hljs-keyword">Animal</span>~<br>+++aniCat <span class="hljs-keyword">is</span> Cat~<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ä¿¡æ¯æ˜¾ç¤ºï¼š<code>is</code>ä¸ä»…å¯æ£€æµ‹å‡ºå®ä¾‹ç›´å±çš„ç±»ï¼Œä¹Ÿå¯ä»¥æ£€æµ‹å…¶æ‰€å±çš„çˆ¶ç±»~</p><p><strong>ç»“è®ºï¼š</strong><code>is</code>çš„ä½œç”¨ä¸OCä¸­<code>isKindOfClass</code>ç±»ä¼¼ï¼Œç”¨äºæ£€æµ‹å®ä¾‹æ‰€åœ¨çš„ç»§æ‰¿æ ‘ã€‚</p><h4 id="2-aså‘ä¸Šè½¬å‹"><a href="#2-aså‘ä¸Šè½¬å‹" class="headerlink" title="2.aså‘ä¸Šè½¬å‹"></a>2.aså‘ä¸Šè½¬å‹</h4><p>è½¬å‹åˆ†ä¸ºä¸¤ç§ï¼šå‘ä¸Šè½¬å‹å’Œå‘ä¸‹è½¬å‹ï¼Œ<code>as</code>ä¸»è¦ç”¨äºå‘ä¸Šè½¬å‹ï¼ŒSwiftä¸æ”¯æŒå‘ä¸‹è½¬å‹ã€‚</p><p><strong>ä½œç”¨ï¼š</strong>æ£€æŸ¥å®ä¾‹Aæ˜¯å¦å¯ä»¥å‘ä¸Šè½¬å‹æˆç›®æ ‡ç±»åŠå…¶å­ç±»çš„å®ä¾‹ï¼Œå¦‚æœå¯ä»¥åˆ™è¿”å›å®ä¾‹Aï¼Œå¦åˆ™æŠ¥é”™ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">func up<span class="hljs-constructor">Cast()</span> &#123;<br>    <span class="hljs-keyword">let</span> animal = <span class="hljs-constructor">Animal()</span><br>    <span class="hljs-keyword">let</span> cat = <span class="hljs-constructor">Cat()</span><br>    <span class="hljs-keyword">let</span> aniCat : Animal = <span class="hljs-constructor">Cat()</span> <span class="hljs-comment">//çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»</span><br>    <span class="hljs-comment">// as å‘ä¸Šè½¬å‹</span><br>    <span class="hljs-keyword">let</span> catAsAnimal = (cat <span class="hljs-keyword">as</span> Animal)<br>    <br>    <span class="hljs-comment">// è·å–åœ°å€</span><br>    print(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Unmanaged</span>.</span></span>pass<span class="hljs-constructor">Unretained(<span class="hljs-params">cat</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">Opaque()</span>)<br>    print(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Unmanaged</span>.</span></span>pass<span class="hljs-constructor">Unretained(<span class="hljs-params">catAsAnimal</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">Opaque()</span>)<br>    <br>    <span class="hljs-comment">//æ£€æŸ¥çˆ¶ç±»ç»§æ‰¿æ ‘</span><br>    <span class="hljs-keyword">if</span> catAsAnimal is Animal &#123;<br>        print(<span class="hljs-string">&quot;++++catAsAnimal is Animal~&quot;</span>)<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        print(<span class="hljs-string">&quot;++++catAsAnimal is NOT Animal~&quot;</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">//æ£€æŸ¥å­ç±»ç»§æ‰¿æ ‘</span><br>    <span class="hljs-keyword">if</span> catAsAnimal is Cat &#123;<br>        print(<span class="hljs-string">&quot;++++catAsAnimal is Cat~&quot;</span>)<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        print(<span class="hljs-string">&quot;++++catAsAnimal is NOT Cat~&quot;</span>)<br>    &#125;<br>        <br>    <span class="hljs-comment">// animal as Cat // è¿™é‡Œä¼šæŠ¥é”™</span><br>    aniCat <span class="hljs-keyword">as</span> Animal<br>    <span class="hljs-comment">// aniCat as Cat // è¿™é‡Œä¼šæŠ¥é”™</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs inform7">0x00006000030dc660<br>0x00006000030dc660<br>++++catAsAnimal <span class="hljs-keyword">is</span> <span class="hljs-keyword">Animal</span>~<br>++++catAsAnimal <span class="hljs-keyword">is</span> Cat~<br></code></pre></td></tr></table></figure><p><code>catAsAnimal</code>ä¸<code>cat</code>å®ä¾‹çš„å†…å­˜åœ°å€ç›¸åŒï¼Œè¯´æ˜å®ä¾‹asè½¬å‹æˆåŠŸåå¾—åˆ°çš„è¿”å›å€¼ä¸å…¶æœ¬èº«æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚</p><p><code>as</code>å¯ä»¥ä»£æ›¿<code>is</code>çš„åŠŸèƒ½ï¼Œå¯ä»¥ç”¨äºæ£€æŸ¥å®ä¾‹å¯¹è±¡æ˜¯å¦åœ¨æŸä¸ªç±»çš„ç»§æ‰¿æ ‘ä¸­ï¼›</p><p><code>as</code>ä¸èƒ½ç”¨äºå‘ä¸‹è½¬å‹ï¼Œå³çˆ¶ç±»è½¬å­ç±»ï¼Œä¼šç›´æ¥æŠ¥é”™ï¼ŒåŸå› åœ¨ä¸Šé¢OCç‰ˆä¸­å·²ç»åˆ†æè¿‡~</p><h4 id="3-as-as-è½¬å‹"><a href="#3-as-as-è½¬å‹" class="headerlink" title="3.as?\as!è½¬å‹"></a>3.as?\as!è½¬å‹</h4><p><strong>ä½œç”¨ï¼š</strong>ä¸<code>as</code>ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå¼ºè°ƒçš„æ˜¯ä½ æ˜¯å¦ç¡®å®šè½¬å‹ä¸€å®šæˆåŠŸã€‚</p><ul><li>as?ï¼Œç”¨äºè½¬å‹æœªå¿…æˆåŠŸæ—¶ï¼Œè¿”å›å¯é€‰ç±»å‹ï¼Œç”¨å¯é€‰ç»‘å®šæŸ¥çœ‹æ˜¯å¦è½¬å‹æˆåŠŸï¼›</li><li>as!ï¼Œç”¨äºè½¬å‹ä¸€å®šæˆåŠŸæ—¶ï¼Œå¦‚æœè½¬å‹å¤±è´¥åˆ™ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ã€‚</li></ul><p><code>as?</code>è¿”å›çš„æ˜¯ç›®æ ‡ç±»çš„å¯é€‰ç±»å‹ï¼Œå¦‚æœè½¬å‹å¤±è´¥åˆ™å¯é€‰å€¼ä¸ºnilï¼Œé€šè¿‡å¯é€‰ç»‘å®šå³å¯åˆ¤æ–­ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">downCast</span>() &#123;<br>    <span class="hljs-keyword">let</span> animal <span class="hljs-operator">=</span> <span class="hljs-type">Animal</span>()<br>    <span class="hljs-keyword">let</span> cat <span class="hljs-operator">=</span> <span class="hljs-type">Cat</span>()<br>    <span class="hljs-keyword">let</span> aniCat : <span class="hljs-type">Animal</span> <span class="hljs-operator">=</span> <span class="hljs-type">Cat</span>() <span class="hljs-comment">//çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»ï¼Œå‘ä¸Šè½¬å‹</span><br>        <br>    <span class="hljs-comment">// as?\as! è½¬å‹</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> aniCat <span class="hljs-keyword">as?</span> <span class="hljs-type">Animal</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++aniCat as? Animal~&quot;</span>) <span class="hljs-comment">// æˆç«‹</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> aniCat <span class="hljs-keyword">as?</span> <span class="hljs-type">Cat</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++aniCat as? Cat~&quot;</span>) <span class="hljs-comment">// æˆç«‹</span><br>    &#125;<br>        <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> animal <span class="hljs-keyword">as?</span> <span class="hljs-type">Animal</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++animal as? Animal~&quot;</span>) <span class="hljs-comment">// æˆç«‹</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¼ºåˆ¶å‘ä¸‹è½¬å‹</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> animal <span class="hljs-keyword">as?</span> <span class="hljs-type">Cat</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++animal as? Cat~&quot;</span>) <span class="hljs-comment">// ä¸æˆç«‹</span><br>    &#125;<br>        <br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> cat <span class="hljs-keyword">as?</span> <span class="hljs-type">Animal</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++cat as? Animal~&quot;</span>) <span class="hljs-comment">// æˆç«‹</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> cat <span class="hljs-keyword">as?</span> <span class="hljs-type">Cat</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++cat as? Cat~&quot;</span>) <span class="hljs-comment">// æˆç«‹</span><br>    &#125;<br><br>    cat <span class="hljs-keyword">as!</span> <span class="hljs-type">Animal</span> <span class="hljs-comment">// è¿è¡Œæ­£å¸¸</span><br>    animal <span class="hljs-keyword">as!</span> <span class="hljs-type">Cat</span> <span class="hljs-comment">// è¿è¡Œæ—¶é”™è¯¯</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stata">+++aniCat <span class="hljs-keyword">as</span>? Animal~<br>+++aniCat <span class="hljs-keyword">as</span>? <span class="hljs-keyword">Cat</span>~<br>+++animal <span class="hljs-keyword">as</span>? Animal~<br>+++<span class="hljs-keyword">cat</span> <span class="hljs-keyword">as</span>? Animal~<br>+++<span class="hljs-keyword">cat</span> <span class="hljs-keyword">as</span>? <span class="hljs-keyword">Cat</span>~<br></code></pre></td></tr></table></figure><p><strong>ç»“è®ºï¼š</strong><code>as?</code>å’Œ<code>as!</code>æ›´å¤šçš„æ˜¯ç”¨æ¥æ£€æµ‹å¼‚å¸¸æƒ…å†µï¼Œè½¬å‹å¤±è´¥åˆ™å¯é€‰å€¼ä¸ºnilã€‚</p><h4 id="4-æ£€æµ‹åè®®"><a href="#4-æ£€æµ‹åè®®" class="headerlink" title="4.æ£€æµ‹åè®®"></a>4.æ£€æµ‹åè®®</h4><p><code>is</code>å’Œ<code>as</code>æ“ä½œç¬¦é™¤äº†å¯ä»¥æ£€æµ‹ç»§æ‰¿å…³ç³»ï¼Œè¿˜å¯ä»¥ç”¨æ¥æ£€æµ‹æ˜¯å¦éµå®ˆäº†æŸç§åè®®ï¼š</p><blockquote><p>You can use the is and as operators described in Type Casting to check for protocol conformance, and to cast to a specific protocol. Checking for and casting to a protocol follows exactly the same syntax as checking for and casting to a type:</p></blockquote><blockquote><p>The is operator returns true if an instance conforms to a protocol and returns false if it doesnâ€™t.</p></blockquote><blockquote><p>The as? version of the downcast operator returns an optional value of the protocolâ€™s type, and this value is nil if the instance doesnâ€™t conform to that protocol.</p></blockquote><blockquote><p>The as! version of the downcast operator forces the downcast to the protocol type and triggers a runtime error if the downcast doesnâ€™t succeed.</p></blockquote><ul><li>å˜é‡éµå®ˆäº†åè®®æ—¶<code>is</code>ä¼šè¿”å›çœŸï¼›å¦åˆ™è¿”å›å‡ï¼›</li><li>as?è¿”å›ä¸€ä¸ªéµå®ˆäº†æŒ‡å®šåè®®çš„å¯é€‰å€¼ï¼Œå¦‚æœå®ä¾‹æœªéµå®ˆåè®®åˆ™å¯é€‰å€¼ä¸ºnilï¼›</li><li>as!å°†å®ä¾‹å¼ºåˆ¶è½¬å‹æˆéµå®ˆæŒ‡å®šåè®®çš„å¯¹è±¡ï¼Œå¦‚æœè½¬å‹å¤±è´¥åˆ™æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ã€‚</li></ul><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">conformsTo</span>() &#123;<br>    <span class="hljs-keyword">let</span> animal <span class="hljs-operator">=</span> <span class="hljs-type">Animal</span>()<br>    <span class="hljs-keyword">let</span> cat <span class="hljs-operator">=</span> <span class="hljs-type">Cat</span>()<br>    <span class="hljs-keyword">let</span> aniCat : <span class="hljs-type">Animal</span> <span class="hljs-operator">=</span> <span class="hljs-type">Cat</span>() <span class="hljs-comment">//çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»ï¼Œå‘ä¸Šè½¬å‹</span><br>        <br>    <span class="hljs-keyword">if</span> animal <span class="hljs-keyword">is</span> <span class="hljs-type">MakeNoise</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++animal conforms to MakeNoise~&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">if</span> cat <span class="hljs-keyword">is</span> <span class="hljs-type">MakeNoise</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++cat conforms to MakeNoise~&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">if</span> aniCat <span class="hljs-keyword">is</span> <span class="hljs-type">MakeNoise</span> &#123;<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;+++aniCat conforms to MakeNoise~&quot;</span>)<br>    &#125;<br>        <br>    animal <span class="hljs-keyword">as?</span> <span class="hljs-type">MakeNoise</span> <span class="hljs-comment">// è¿è¡Œæ­£å¸¸</span><br>    cat <span class="hljs-keyword">as!</span> <span class="hljs-type">MakeNoise</span> <span class="hljs-comment">// è¿è¡Œæ­£å¸¸</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">+++animal conforms <span class="hljs-keyword">to</span> MakeNoise~<br>+++<span class="hljs-keyword">cat</span> conforms <span class="hljs-keyword">to</span> MakeNoise~<br>+++aniCat conforms <span class="hljs-keyword">to</span> MakeNoise~<br></code></pre></td></tr></table></figure><h3 id="å››ã€ç»“å°¾"><a href="#å››ã€ç»“å°¾" class="headerlink" title="å››ã€ç»“å°¾"></a>å››ã€ç»“å°¾</h3><p>ä»ä¸Šé¢çš„ç¤ºä¾‹å’Œåˆ†ææ¥çœ‹ï¼ŒOCä¸­çš„ä¸‰ä¸ªå†…çœæ–¹æ³•å„å¸å…¶èŒï¼š</p><ul><li>isMemberOfClass åªèƒ½ç”¨æ¥åˆ¤æ–­å¯¹è±¡çš„ç›´å±ç±»ï¼›</li><li>isKindOfClass ä¸ä»…èƒ½åˆ¤æ–­å¯¹è±¡çš„ç›´å±ç±»ï¼Œä¹Ÿèƒ½åˆ¤æ–­å…¶é—´æ¥çˆ¶ç±»å’ŒåŸºç±»ï¼›</li><li>conformsToProtocol ç”¨æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦ç›´æ¥æˆ–é—´æ¥å®ç°äº†æŸåè®®ï¼›</li></ul><p>è€Œ Swift åˆ™å¯¹ OC ä¸­çš„å†…çœè¿›è¡Œäº†æŠ½è±¡ï¼Œiså’Œaséƒ½èƒ½èƒœä»»ä»¥ä¸Šä¸‰ç§ä»»åŠ¡ï¼Œåªæ˜¯ï¼š</p><ul><li>is æ›´åå‘å•çº¯çš„æ£€æŸ¥åŠŸèƒ½ï¼Œç±»ä¼¼äº isKindOfClass çš„ä½œç”¨ï¼›</li><li>as é™¤äº†æ£€æŸ¥åŠŸèƒ½å¤–ï¼Œè¿˜å¤šäº†å°è¯•å»è½¬å‹çš„åŠŸèƒ½ï¼Œä½œç”¨æ›´ä¸°å¯Œä¸€äº›ã€‚</li></ul><p>æ‰€ä»¥ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆè¯­è¨€å’ŒåŠŸèƒ½éœ€è¦ï¼Œé€‰æ‹©åˆé€‚çš„å†…çœæ–¹æ³•æ¥æè¿°å¯¹è±¡çš„ç±»å‹å’Œåè®®ä¿¡æ¯~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://docs.swift.org/swift-book/LanguageGuide/TypeCasting.html">Â©doc.swift</a></p><p>#<a href="https://developer.apple.com/documentation/objectivec/1418956-nsobject/1418511-iskindofclass?language=occ">Â©Dev.apple</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Swiftå¯é€‰æ‹†åŒ…</title>
    <link href="/2018/08/15/swift-unwrap.html"/>
    <url>/2018/08/15/swift-unwrap.html</url>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>You use optionals in situations where a value may be absent. An optional represents two possibilities: Either there is a value, and you can unwrap the optional to access that value, or there isnâ€™t a value at all.</p></blockquote><p>å¯é€‰ç”¨æ¥è¡¨ç¤ºå€¼çš„æˆ–ç¼ºï¼Œå½“å¯é€‰æ²¡æœ‰å€¼æ—¶ç›¸å½“äºOCä¸­çš„nilï¼Œè€Œå½“æœ‰å€¼æ—¶æˆ‘ä»¬éœ€è¦å¯¹å¯é€‰è¿›è¡Œæ‹†åŒ…æ‰èƒ½å–å‡ºå’Œè®¿é—®è¿™ä¸ªå€¼ã€‚æœ¬ç¯‡å°†å¯¹å¯é€‰çš„æ‹†åŒ…æ–¹å¼åšä¸€æ¬¡æ±‡æ€»~</p><h3 id="1-å¼ºåˆ¶æ‹†åŒ…"><a href="#1-å¼ºåˆ¶æ‹†åŒ…" class="headerlink" title="1.å¼ºåˆ¶æ‹†åŒ…"></a>1.å¼ºåˆ¶æ‹†åŒ…</h3><blockquote><p>Once youâ€™re sure that the optional does contain a value, you can access its underlying value by adding an exclamation mark (!) to the end of the optionalâ€™s name. The exclamation mark effectively says, â€œI know that this optional definitely has a value; please use it.â€ This is known as forced unwrapping of the optionalâ€™s value:</p></blockquote><p>å¼ºåˆ¶æ‹†åŒ…æ˜¯æŒ‡å½“ç¡®å®šå¯é€‰æœ‰å€¼æ—¶ï¼Œåœ¨å¯é€‰åæ ‡æ³¨ä¸€ä¸ª<code>!</code>ï¼Œè¡¨æ˜â€œæˆ‘ç¡®å®šå¯é€‰æœ‰å€¼ï¼Œè¯·ç»™æˆ‘å€¼â€ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">let</span> possibleNumber = <span class="hljs-string">&quot;123&quot;</span><br><span class="hljs-keyword">let</span> convertedNumber = Int(possibleNumber)<br>// convertedNumber <span class="hljs-keyword">is</span> inferred <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> of <span class="hljs-built_in">type</span> <span class="hljs-string">&quot;Int?&quot;</span>, <span class="hljs-built_in">or</span> <span class="hljs-string">&quot;optional Int&quot;</span><br><br><span class="hljs-keyword">print</span>(<span class="hljs-string">&quot;convertedNumber has an integer value of \(convertedNumber!).&quot;</span>) // è¿™ä¸ªconvertedNumber!å³ä¸ºå¼ºåˆ¶æ‹†åŒ…<br><br>// Prints <span class="hljs-string">&quot;convertedNumber has an integer value of 123.&quot;</span><br></code></pre></td></tr></table></figure><h3 id="2-å¯é€‰ç»‘å®š"><a href="#2-å¯é€‰ç»‘å®š" class="headerlink" title="2.å¯é€‰ç»‘å®š"></a>2.å¯é€‰ç»‘å®š</h3><blockquote><p>You use optional binding to find out whether an optional contains a value, and if so, to make that value available as a temporary constant or variable. Optional binding can be used with if and while statements to check for a value inside an optional, and to extract that value into a constant or variable, as part of a single action.</p></blockquote><p>å¯é€‰ç»‘å®šæ˜¯å½“å¯é€‰æœ‰å€¼æ—¶å°†å€¼ç»‘å®šåˆ°ä¸€ä¸ªä¸´æ—¶å˜é‡æˆ–å¸¸é‡ä¸­çš„ä¸€ç§æ–¹æ³•ï¼Œå¤šç”¨åœ¨<code>if</code>å’Œ<code>while</code>è¯­å¥ä¸­ã€‚</p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> actualNumber <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(possibleNumber) &#123; <span class="hljs-comment">// æœ‰å€¼æ—¶ç»‘å®šåˆ°ä¸´æ—¶å¸¸é‡actualNumberä¸­</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;The string <span class="hljs-subst">\&quot;</span><span class="hljs-subst">\(possibleNumber)</span><span class="hljs-subst">\&quot;</span> has an integer value of <span class="hljs-subst">\(actualNumber)</span>&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;The string <span class="hljs-subst">\&quot;</span><span class="hljs-subst">\(possibleNumber)</span><span class="hljs-subst">\&quot;</span> could not be converted to an integer&quot;</span>)<br>&#125;<br><span class="hljs-comment">// Prints &quot;The string &quot;123&quot; has an integer value of 123&quot;</span><br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹2ï¼šifä¸­å¤šä¸ªå¯é€‰ç»‘å®šç»„åˆ</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> firstNumber <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(<span class="hljs-string">&quot;4&quot;</span>), <span class="hljs-keyword">let</span> secondNumber <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(<span class="hljs-string">&quot;42&quot;</span>), firstNumber <span class="hljs-operator">&lt;</span> secondNumber <span class="hljs-operator">&amp;&amp;</span> secondNumber <span class="hljs-operator">&lt;</span> <span class="hljs-number">100</span> &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;<span class="hljs-subst">\(firstNumber)</span> &lt; <span class="hljs-subst">\(secondNumber)</span> &lt; 100&quot;</span>)<br>&#125;<br><span class="hljs-comment">// Prints &quot;4 &lt; 42 &lt; 100&quot;</span><br></code></pre></td></tr></table></figure><h3 id="3-éšå¼æ‹†åŒ…å˜é‡å£°æ˜"><a href="#3-éšå¼æ‹†åŒ…å˜é‡å£°æ˜" class="headerlink" title="3.éšå¼æ‹†åŒ…å˜é‡å£°æ˜"></a>3.éšå¼æ‹†åŒ…å˜é‡å£°æ˜</h3><blockquote><p>Sometimes itâ€™s clear from a programâ€™s structure that an optional will always have a value, after that value is first set. In these cases, itâ€™s useful to remove the need to check and unwrap the optionalâ€™s value every time itâ€™s accessed, because it can be safely assumed to have a value all of the time.<br>These kinds of optionals are defined as implicitly unwrapped optionals. You write an implicitly unwrapped optional by placing an exclamation mark (String!) rather than a question mark (String?) after the type that you want to make optional.</p></blockquote><p>æœ‰æ—¶å½“å¯é€‰è¢«é¦–æ¬¡èµ‹å€¼ä¹‹åï¼Œèƒ½ç¡®å®šæ­¤å¯é€‰åç»­å¿…å®šæœ‰å€¼ï¼Œä¸”ä¸ä¼šå†è¢«è®¾ç½®ä¸ºnilã€‚è¿™æ—¶ä¸ºäº†ä¸å¿…æ¯æ¬¡è®¿é—®å¯é€‰å˜é‡æ—¶éƒ½è¿›è¡Œæ‹†åŒ…æˆ–æ£€æŸ¥ï¼Œå¯åœ¨å£°æ˜å¯é€‰æ—¶å¾€å…¶åé¢æ ‡æ³¨ä¸€ä¸ª<code>!</code>ï¼Œè¿™ç§å¯é€‰å°±æ˜¯éšå¼æ‹†åŒ…çš„å¯é€‰ã€‚</p><p>ä½¿ç”¨éšå¼æ‹†åŒ…å¯é€‰æ—¶ï¼Œå¯ä»¥åƒæ™®é€šå¯é€‰ä¸€æ ·è¿›è¡Œå¯é€‰ç»‘å®šï¼Œä¹Ÿå¯ä»¥åƒéå¯é€‰å˜é‡ä¸€æ ·ä¸å¿…åœ¨å…¶ååŠ <code>!</code>ï¼š</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> <span class="hljs-attr">possibleString</span>: <span class="hljs-title class_">String</span>? = <span class="hljs-string">&quot;An optional string.&quot;</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">forcedString</span>: <span class="hljs-title class_">String</span> = possibleString! <span class="hljs-comment">// requires an exclamation mark</span><br><br><span class="hljs-keyword">let</span> <span class="hljs-attr">assumedString</span>: <span class="hljs-title class_">String</span>! = <span class="hljs-string">&quot;An implicitly unwrapped optional string.&quot;</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">implicitString</span>: <span class="hljs-title class_">String</span> = assumedString <span class="hljs-comment">// no need for an exclamation mark</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> definiteString = assumedString &#123;<br>    <span class="hljs-title function_">print</span>(definiteString)<br>&#125;<br><span class="hljs-comment">// Prints &quot;An implicitly unwrapped optional string.&quot;</span><br></code></pre></td></tr></table></figure><h3 id="4-å¯é€‰é“¾"><a href="#4-å¯é€‰é“¾" class="headerlink" title="4.å¯é€‰é“¾"></a>4.å¯é€‰é“¾</h3><blockquote><p>Optional chaining is a process for querying and calling properties, methods, and subscripts on an optional that might currently be nil. If the optional contains a value, the property, method, or subscript call succeeds; if the optional is nil, the property, method, or subscript call returns nil. Multiple queries can be chained together, and the entire chain fails gracefully if any link in the chain is nil.</p></blockquote><p>å½“å¯é€‰å¯¹è±¡è°ƒç”¨å±æ€§ã€æ–¹æ³•æˆ–ä¸‹æ ‡æ—¶ï¼Œå¯é€‰æœ¬èº«å¯èƒ½ä¸ºnilã€‚å¦‚æœä¸ºnilï¼Œåˆ™è°ƒç”¨å¤±è´¥ï¼›å¦‚æœä¸ä¸ºnilï¼Œåˆ™è°ƒç”¨æˆåŠŸã€‚</p><p>å¤šä¸ªè°ƒç”¨å¯ä»¥é“¾æ¥åˆ°ä¸€èµ·å¹¶è¿”å›ä¸€ä¸ªå¯é€‰å€¼ï¼Œä¸€æ—¦å…¶ä¸­æŸä¸ªè°ƒç”¨è¿”å›nilæ—¶ï¼Œæ•´ä¸ªè°ƒç”¨é“¾å°±ä¼šå¤±è´¥ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">var</span> residence: <span class="hljs-type">Residence</span>?<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Residence</span> &#123;<br>    <span class="hljs-keyword">var</span> numberOfRooms: <span class="hljs-type">Int</span> &#123;<br>        <span class="hljs-keyword">get</span> &#123;<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;++numberOfRooms is 1)&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-keyword">set</span> &#123;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">let</span> john <span class="hljs-operator">=</span> <span class="hljs-type">Person</span>()<br><span class="hljs-keyword">let</span> opt <span class="hljs-operator">=</span> john.residence<span class="hljs-operator">?</span>.numberOfRooms <span class="hljs-comment">// opt is a Int? type</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> roomCount <span class="hljs-operator">=</span> opt &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;John&#x27;s residence has <span class="hljs-subst">\(roomCount)</span> room(s).&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Unable to retrieve the number of rooms.&quot;</span>)<br>&#125;<br><span class="hljs-comment">// Prints &quot;Unable to retrieve the number of rooms.&quot;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„â€john.residence?.numberOfRoomsâ€å°±æ˜¯ä¸€ä¸ªå¯é€‰é“¾ï¼Œæ­¤å¯é€‰é“¾è¿”å›ä¸€ä¸ª<code>Int?</code>ç±»å‹çš„å¯é€‰<code>opt</code>ï¼Œå°†å…¶æ‹†åŒ…å³å¯ã€‚</p><p>å˜é‡<code>john</code>åˆå§‹åŒ–æ—¶å…¶<code>residence</code>å¯¹è±¡å¹¶æœªèµ‹å€¼ï¼Œå³ä¸ºnilï¼Œæ‰€ä»¥æ•´ä¸ªå¯é€‰é“¾è°ƒç”¨å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå†è®¿é—®åç»­çš„<code>numberOfRooms</code>å±æ€§ã€‚å› ä¸ºå¯é€‰é“¾å¤±è´¥äº†ï¼Œæ‰€ä»¥å¯¹<code>opt</code>è¿›è¡Œå¯é€‰ç»‘å®šæ—¶å–ä¸åˆ°å€¼ï¼Œå› æ­¤è¾“å‡ºæœ€åä¸€è¡Œ~</p><h3 id="5-ç©ºåˆè¿ç®—ç¬¦"><a href="#5-ç©ºåˆè¿ç®—ç¬¦" class="headerlink" title="5.ç©ºåˆè¿ç®—ç¬¦??"></a>5.ç©ºåˆè¿ç®—ç¬¦??</h3><blockquote><p>The nil-coalescing operator (a ?? b) unwraps an optional a if it contains a value, or returns a default value b if a is nil. The expression a is always of an optional type. The expression b must match the type that is stored inside a.</p></blockquote><p>ç©ºåˆè¿ç®—ç¬¦åœ¨å¯é€‰<code>a</code>æœ‰å€¼æ—¶ä¼šå¯¹<code>a</code>è¿›è¡Œæ‹†åŒ…å¹¶è¿”å›æ‹†åŒ…åçš„å€¼<code>a!</code>ï¼›å¦‚æœå¯é€‰<code>a</code>æ²¡æœ‰å€¼åˆ™è¿”å›é»˜è®¤å€¼<code>b</code>ã€‚</p><p><code>b</code>çš„å€¼å¿…é¡»ä¸<code>a</code>çš„ç±»å‹ä¸€è‡´ã€‚</p><p>ç©ºåˆè¿ç®—ç¬¦æ˜¯ä¸‹é¢ä»£ç çš„ç¼©å†™:</p><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl">a != nil ? a! : b<br></code></pre></td></tr></table></figure><h3 id="6-guardæ¨¡å¼åŒ¹é…"><a href="#6-guardæ¨¡å¼åŒ¹é…" class="headerlink" title="6.guardæ¨¡å¼åŒ¹é…"></a>6.guardæ¨¡å¼åŒ¹é…</h3><blockquote><p>A guard statement, like an if statement, executes statements depending on the Boolean value of an expression. You use a guard statement to require that a condition must be true in order for the code after the guard statement to be executed. Unlike an if statement, a guard statement always has an else clauseâ€”the code inside the else clause is executed if the condition is not true.</p></blockquote><p><code>guard</code>å’Œ<code>if</code>è¯­å¥ä¸€æ ·ï¼Œéƒ½æ˜¯æ ¹æ®ç´§éšå…¶åçš„ Boolean å‹è¡¨è¾¾å¼è€Œå†³å®šåç»­è¡Œä¸ºï¼Œä¸åŒçš„æ˜¯<code>guard</code>çš„å£°æ˜ä¸­ä¸€å®šè¦æœ‰ä¸€ä¸ª<code>else</code>ä»£ç å—ã€‚åœ¨<code>guard</code>è¯­å¥ä¸­ï¼Œå¦‚æœè¡¨è¾¾å¼ä¸ºçœŸæ‰ä¼šç»§ç»­æ‰§è¡Œ<code>guard</code>å£°æ˜ä¹‹åçš„ä»£ç ï¼Œå¦åˆ™å°±æ‰§è¡Œå…¶<code>else</code>ä»£ç å—ä¸­çš„ä»£ç ã€‚</p><p>åŸºäºè¿™äº›ï¼Œæˆ‘ä»¬å¯ä»¥åƒåœ¨<code>if</code>è¯­å¥ä¸­ä¸€æ ·ï¼Œåœ¨<code>guard</code>ä¸­ä½¿ç”¨å¯é€‰ç»‘å®šè¿›è¡Œæ‹†åŒ…ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">person</span>: [<span class="hljs-params">String</span>: <span class="hljs-type">String</span>]) &#123;<br>    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> person[<span class="hljs-string">&quot;name&quot;</span>] <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// å¯é€‰ç»‘å®š</span><br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello <span class="hljs-subst">\(name)</span>!&quot;</span>)<br><br>    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> location <span class="hljs-operator">=</span> person[<span class="hljs-string">&quot;location&quot;</span>] <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// å¯é€‰ç»‘å®š</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;I hope the weather is nice near you.&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;I hope the weather is nice in <span class="hljs-subst">\(location)</span>.&quot;</span>)<br>&#125;<br><br>greet(person: [<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;John&quot;</span>])<br><span class="hljs-comment">// Prints &quot;Hello John!&quot;</span><br><span class="hljs-comment">// Prints &quot;I hope the weather is nice near you.&quot;</span><br>greet(person: [<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jane&quot;</span>, <span class="hljs-string">&quot;location&quot;</span>: <span class="hljs-string">&quot;Cupertino&quot;</span>])<br><span class="hljs-comment">// Prints &quot;Hello Jane!&quot;</span><br><span class="hljs-comment">// Prints &quot;I hope the weather is nice in Cupertino.&quot;</span><br></code></pre></td></tr></table></figure><h3 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h3><p>ä»¥ä¸Šå‡ ç§å°±æ˜¯å¸¸è§çš„æ‹†åŒ…æ–¹æ³•ï¼Œ1å’Œ3æ˜¯å¼ºåˆ¶æ‹†åŒ…ï¼Œæœ‰å¯èƒ½å‡ºé”™æ‰€ä»¥ä¸å®‰å…¨ï¼Œå»ºè®®ä½¿ç”¨å…¶ä»–å‡ ç§æ–¹æ³•è¿›è¡Œæ‹†åŒ…~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://docs.swift.org/swift-book/LanguageGuide/TheBasics.html">Â©Swift.org</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>swift</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Github è®¿é—®æ…¢çš„è§£å†³æ–¹æ¡ˆ</title>
    <link href="/2018/07/23/fast-github.html"/>
    <url>/2018/07/23/fast-github.html</url>
    
    <content type="html"><![CDATA[<p>Githubä¸ºå›½å¤–ç½‘ç«™ï¼Œæ‰€ä»¥åŸŸåè§£ææ—¶é€Ÿåº¦æ…¢çš„ã€‚ã€‚è§£å†³æ­¤é—®é¢˜æœ‰ä¿©æ–¹æ³•ï¼š</p><ul><li>æŒ‚VPN</li><li>ä¿®æ”¹hostsé…ç½®</li></ul><p>æœ¬æ–‡è®²çš„æ˜¯ç¬¬äºŒç§ï¼Œä¿®æ”¹hostsæ–‡ä»¶ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><h2 id="1ã€æ‰“å¼€hostæ–‡ä»¶"><a href="#1ã€æ‰“å¼€hostæ–‡ä»¶" class="headerlink" title="#1ã€æ‰“å¼€hostæ–‡ä»¶"></a>#1ã€æ‰“å¼€hostæ–‡ä»¶</h2><ul><li>ç›´æ¥é€šè¿‡Finder</li></ul><p>å¿«æ·é”® command + shift + Gï¼Œè¾“å…¥â€œ&#x2F;etcâ€ï¼Œå›è½¦å³å¯è¿›å…¥etcæ–‡ä»¶å¤¹ï¼Œæ‰¾åˆ°hostsæ–‡ä»¶ï¼Œç›´æ¥é€šè¿‡ç³»ç»Ÿçš„â€œæ–‡æœ¬ç¼–è¾‘â€æ‰“å¼€å³å¯ã€‚</p><ul><li>ä½¿ç”¨ç»ˆç«¯æ‰“å¼€</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo vi <span class="hljs-regexp">/etc/</span>hosts<br></code></pre></td></tr></table></figure><p>è¾“å…¥å¯†ç åä¼šçœ‹åˆ°ç›®å‰hostsæ–‡ä»¶çš„é…ç½®ä¿¡æ¯ï¼š</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment">##</span><br><span class="hljs-comment"># Host Database</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># localhost is used to configure the loopback interface</span><br><span class="hljs-comment"># when the system is booting.  Do not change this entry.</span><br><span class="hljs-comment">##</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>localhost<br><span class="hljs-number">255.255</span>.<span class="hljs-number">255.255</span>broadcasthost<br>::<span class="hljs-number">1</span>             localhost <br></code></pre></td></tr></table></figure><h2 id="2ã€æŸ¥è¯¢GithubåŸŸåå¯¹åº”çš„ipåœ°å€"><a href="#2ã€æŸ¥è¯¢GithubåŸŸåå¯¹åº”çš„ipåœ°å€" class="headerlink" title="#2ã€æŸ¥è¯¢GithubåŸŸåå¯¹åº”çš„ipåœ°å€"></a>#2ã€æŸ¥è¯¢GithubåŸŸåå¯¹åº”çš„ipåœ°å€</h2><p>åœ¨æµè§ˆå™¨ä¸­è®¿é—® <a href="https://www.ipaddress.com/">æ­¤ç½‘ç«™</a>ï¼Œåœ¨å…¶æœç´¢æ¡†ä¸­åˆ†åˆ«è¾“å…¥â€œgithub.comâ€ ä¸ â€œgithub.global.ssl.fastly.netâ€ï¼ŒæŸ¥è¯¢å¹¶è®°å½•ä¸‹å…¶å¯¹åº”çš„ipåœ°å€ã€‚æˆ‘çš„æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">192.30.253.112</span> github.com<br><span class="hljs-number">151.101.13.194</span>github.global.ssl.fastly.net<br></code></pre></td></tr></table></figure><h2 id="3ã€ä¿®æ”¹hostsæ–‡ä»¶"><a href="#3ã€ä¿®æ”¹hostsæ–‡ä»¶" class="headerlink" title="#3ã€ä¿®æ”¹hostsæ–‡ä»¶"></a>#3ã€ä¿®æ”¹hostsæ–‡ä»¶</h2><p>é€šè¿‡â€œæ–‡æœ¬ç¼–è¾‘â€å·¥å…· æˆ–è€… ç»ˆç«¯ä¸­ä½¿ç”¨ vi å‘½ä»¤æ‰“å¼€hostsæ–‡ä»¶ï¼Œå°†ä¸Šé¢ä¸¤è¡Œè®°å½•å†™å…¥hostsæ–‡ä»¶ï¼Œä¿å­˜å¹¶é€€å‡ºã€‚ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">##<br># Host Database<br>#<br># localhost is used to configure the loopback interface<br># when the system is booting.  Do not change this entry.<br>##<br><span class="hljs-number">127.0.0.1</span>localhost<br><span class="hljs-number">255.255.255.255</span>broadcasthost<br>::<span class="hljs-number">1</span>             localhost <br><br><span class="hljs-number">192.30.253.112</span> github.com<br><span class="hljs-number">151.101.13.194</span>github.global.ssl.fastly.net<br></code></pre></td></tr></table></figure><h2 id="4ã€é‡æ–°è®¿é—®-Github-com"><a href="#4ã€é‡æ–°è®¿é—®-Github-com" class="headerlink" title="#4ã€é‡æ–°è®¿é—® Github.com~"></a>#4ã€é‡æ–°è®¿é—® Github.com~</h2><p>ç°åœ¨ï¼Œé‡æ–°è®¿é—® <a href="https://github.com/">Github.com</a> è¯•è¯•~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://blog.csdn.net/wu__di/article/details/50538916">Â©ä¼ é€é—¨</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç»“åˆdSYMæ–‡ä»¶åˆ†æcrashæ—¥å¿—</title>
    <link href="/2018/07/11/dsym.html"/>
    <url>/2018/07/11/dsym.html</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€dSYM"><a href="#ä¸€ã€dSYM" class="headerlink" title="ä¸€ã€dSYM"></a>ä¸€ã€<strong>dSYM</strong></h2><h4 id="1-1-dSYM"><a href="#1-1-dSYM" class="headerlink" title="1.1.dSYM"></a>1.1.dSYM</h4><p>è°ƒè¯•ç¬¦å·è¡¨ï¼Œæ˜¯è‹¹æœä¸ºè°ƒè¯•å’Œå®šä½é—®é¢˜è€Œä½¿ç”¨çš„ä¸€ç§è°ƒè¯•æ–‡ä»¶ã€‚è°ƒè¯•ç¬¦å·ä¿¡æ¯åœ¨æ„å»ºåº”ç”¨æ—¶å°±ä¿å­˜åœ¨<code>Mach-O</code>æ–‡ä»¶ä¸­äº†ï¼Œè€Œ<code>.dSYM</code>å°±æ˜¯ä»<code>Mach-O</code>æ–‡ä»¶ä¸­æŠ½å–è°ƒè¯•ä¿¡æ¯è€Œå¾—åˆ°çš„ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ç›®å½•ã€‚å®ƒä½¿ç”¨çš„æ˜¯ DWARF ç»“æ„ï¼Œåœ¨ .xcarchive ç›®å½•ä¸­å…¶å±‚æ¬¡ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">.xcarchive</span><br><span class="hljs-params">--dSYMs</span><br>  |<span class="hljs-params">--Your</span>.app.dSYM<br>    |<span class="hljs-params">--Contents</span><br>      |<span class="hljs-params">--Resources</span><br>        |<span class="hljs-params">--DWARF</span><br></code></pre></td></tr></table></figure><p>è¦ç”Ÿæˆ dSYM æ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨ Xcode çš„<code>Build Settings</code>ä¸­è¿™æ ·è®¾ç½®ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Generate <span class="hljs-built_in">Debug</span> Symbols = <span class="hljs-literal">YES</span><br><span class="hljs-built_in">Debug</span> Information Format = <span class="hljs-string">&quot;DWARF with dSYM File&quot;</span><br></code></pre></td></tr></table></figure><p>åä¹‹ï¼Œå¦‚æœä½ ä¸æƒ³ç”Ÿæˆ dSYM æ–‡ä»¶ï¼Œåˆ™å¯ä»¥è¿™æ ·é…ç½®ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Generate <span class="hljs-built_in">Debug</span> Symbols = <span class="hljs-literal">NO</span><br>æˆ–è€…<br><span class="hljs-built_in">Debug</span> Information Format = <span class="hljs-string">&quot;DWARF&quot;</span><br></code></pre></td></tr></table></figure><h4 id="1-2-DWARF"><a href="#1-2-DWARF" class="headerlink" title="1.2.DWARF"></a>1.2.DWARF</h4><p>DWARFï¼ˆDebuggingWith Arbitrary Record Formatsï¼‰ï¼Œæ˜¯ ELF å’Œ Mach-O ç­‰æ–‡ä»¶æ ¼å¼ä¸­ç”¨æ¥å­˜å‚¨å’Œå¤„ç†è°ƒè¯•ä¿¡æ¯çš„æ ‡å‡†æ ¼å¼ï¼Œ.dSYMä¸­çœŸæ­£ä¿å­˜ç¬¦å·è¡¨æ•°æ®çš„æ˜¯ DWARF æ–‡ä»¶ã€‚DWARF ä¸­ä¸åŒçš„æ•°æ®éƒ½ä¿å­˜åœ¨ç›¸åº”çš„ sectionï¼ˆèŠ‚ï¼‰ä¸­ï¼ŒELF æ–‡ä»¶é‡Œæ‰€æœ‰çš„ section åç§°éƒ½ä»¥â€.debug_â€å¼€å¤´ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">|<span class="hljs-string"> Section Name         </span>|<span class="hljs-string"> Contents                                          </span>|<br>|<span class="hljs-string"> -------------------- </span>|<span class="hljs-string"> ------------------------------------------------  </span>|<br>|<span class="hljs-string"> .debug_abbrev        </span>|<span class="hljs-string"> Abbreviations used in the .debug_info section     </span>|<br>|<span class="hljs-string"> .debug_aranges       </span>|<span class="hljs-string"> A mapping between memory address and compilation  </span>|<br>|<span class="hljs-string"> .debug_frame         </span>|<span class="hljs-string"> Call Frame Information                            </span>|<br>|<span class="hljs-string"> .debug_info          </span>|<span class="hljs-string"> The core DWARF data containing DIEs               </span>|<br>|<span class="hljs-string"> .debug_line          </span>|<span class="hljs-string"> Line Number Program                               </span>|<br>|<span class="hljs-string"> .debug_loc           </span>|<span class="hljs-string"> Macro descriptions                                </span>|<br>|<span class="hljs-string"> .debug_macinfo       </span>|<span class="hljs-string"> A lookup table for global objects and functions   </span>|<br>|<span class="hljs-string"> .debug_pubnames      </span>|<span class="hljs-string"> A lookup table for global objects and functions   </span>|<span class="hljs-string"> </span><br><span class="hljs-string"></span>|<span class="hljs-string"> .debug_pubtypes      </span>|<span class="hljs-string"> A lookup table for global types                   </span>|<br>|<span class="hljs-string"> .debug_ranges        </span>|<span class="hljs-string"> Address ranges referenced by DIEs                 </span>|<br>|<span class="hljs-string"> .debug_str           </span>|<span class="hljs-string"> String table used by .debug_info</span><br></code></pre></td></tr></table></figure><p>Mach-Oä¸­å…³äº section çš„å‘½åå’ŒELFç¨æœ‰åŒºåˆ«ï¼ŒæŠŠåç§°å‰çš„.æ¢æˆäº†_ï¼Œä¾‹å¦‚.debug_infoå˜æˆäº†_debug_infoã€‚</p><p>ä¿å­˜åœ¨ DAWARF ä¸­çš„ä¿¡æ¯æ˜¯é«˜åº¦å‹ç¼©çš„ï¼Œå¯ä»¥é€šè¿‡ dwarfdump å‘½ä»¤ä»ä¸­æå–å‡ºå¯è¯»ä¿¡æ¯ã€‚å‰æ–‡æ‰€è¿°çš„é‚£äº› section ä¸­ï¼Œå®šä½ CrashLog åªéœ€è¦ç”¨åˆ°.debug_info å’Œ .debug_lineã€‚ç”±äºè§£æå‡ºæ¥çš„æ•°æ®é‡è¾ƒå¤§ï¼Œä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œå°±å°†å…¶ä¿å­˜åœ¨æ–‡æœ¬ä¸­ã€‚ä¸¤ä¸ª section çš„æ•°æ®æå–æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>.debug_info</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">$ dwarfdump -e --debug-<span class="hljs-meta">info</span> YourApp.dSYM/Contents/Resources/DWARF &gt; <span class="hljs-meta">info</span>-e.txt<br></code></pre></td></tr></table></figure><ul><li>.debug_line</li></ul><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">$ dwarfdump -e --<span class="hljs-keyword">debug</span>-<span class="hljs-keyword">line</span> YourApp.dSYM/Contents/Resources/DWARF &gt; <span class="hljs-keyword">line</span>-e.txt<br></code></pre></td></tr></table></figure><h4 id="1-3-å´©æºƒè§£æè¿‡ç¨‹"><a href="#1-3-å´©æºƒè§£æè¿‡ç¨‹" class="headerlink" title="1.3.å´©æºƒè§£æè¿‡ç¨‹"></a>1.3.å´©æºƒè§£æè¿‡ç¨‹</h4><ul><li>è®¡ç®—å´©æºƒåœ°å€å¯¹åº”ç¬¦å·è¡¨ä¸­çš„åœ°å€</li></ul><p>ä¸‹é¢çš„ç¬¬äºŒç« èŠ‚ä¸­ä¼šè¯¦ç»†è®²è§£å´©æºƒæ—¥å¿—ä¸­çš„ stack addressã€load address ä»¥åŠæ€æ ·è®¡ç®—å´©æºƒåœ°å€åœ¨ç¬¦å·è¡¨ä¸­çš„ symbol addressï¼Œè¿™é‡Œä»¥ 0x52846 ä¸ºä¾‹ã€‚</p><ul><li>.debug_info</li></ul><p>.debug_info ä¸­æœ€åŸºæœ¬çš„æè¿°å•å…ƒä¸ºDIEï¼ˆDebug Information Entryï¼‰ï¼Œè¯¦æƒ…è¯·å‚è€ƒ DWARF å®˜æ–¹ç½‘ç«™ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ ¹æ®ç¬¦å·è¡¨å´©æºƒåœ°å€ 0x52846 ä».debug_info ä¸­å–å‡ºåŒ…å«è¿™ä¸ªåœ°å€çš„DIEå•å…ƒã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œç›´æ¥è´´å‡ºäº†ä» info-e.txt ä¸­å–å‡ºçš„å¯¹åº”DIEï¼Œå…¶éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-number">0</span><span class="hljs-variable">x00062112</span>:     <span class="hljs-variable">function</span> [<span class="hljs-number">99</span>] *<br>                <span class="hljs-variable">low</span> <span class="hljs-function"><span class="hljs-title">pc</span>( <span class="hljs-number">0</span><span class="hljs-variable">x000502e0</span> )</span><br>                <span class="hljs-variable">high</span> <span class="hljs-function"><span class="hljs-title">pc</span>( <span class="hljs-number">0</span><span class="hljs-variable">x00053730</span> )</span><br>                <span class="hljs-variable">frame</span> <span class="hljs-function"><span class="hljs-title">base</span>( <span class="hljs-variable">r7</span> )</span><br>                <span class="hljs-variable"><span class="hljs-class">object</span></span> <span class="hljs-function"><span class="hljs-title">pointer</span>( &#123;<span class="hljs-number">0</span><span class="hljs-variable">x0006212a</span>&#125; )</span><br>                <span class="hljs-function"><span class="hljs-title">name</span>( <span class="hljs-string">&quot;-[OBDFirstConnectViewController showOilPricePickerView]&quot;</span> )</span><br>                <span class="hljs-variable">decl</span> <span class="hljs-function"><span class="hljs-title">file</span>( <span class="hljs-string">&quot;/YourSourcePath/OBDFirstConnectViewController.m&quot;</span> )</span><br>                <span class="hljs-variable">decl</span> <span class="hljs-function"><span class="hljs-title">line</span>( <span class="hljs-number">870</span> )</span><br>                <span class="hljs-function"><span class="hljs-title">prototyped</span>( <span class="hljs-number">0</span><span class="hljs-variable">x01</span> )</span><br>                <span class="hljs-variable">APPLE</span> <span class="hljs-variable">instruction</span> <span class="hljs-variable">set</span> <span class="hljs-function"><span class="hljs-title">architecture</span>( <span class="hljs-number">0</span><span class="hljs-variable">x01</span> )</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œè¯¥DIEåŒ…å«çš„æ˜¯æ–¹æ³•-[OBDFirstConnectViewController showOilPricePickerView]çš„å†…å®¹ï¼Œå…¶åœ°å€èŒƒå›´æ˜¯ 0x000502e0â€“0x00053730ï¼Œæˆ‘ä»¬çš„ç›®æ ‡åœ°å€ 0x52846 æ­£æ˜¯åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œæ‰€ä»¥å¯ä»¥åˆ¤å®šå´©æºƒå‘ç”Ÿåœ¨è¯¥æ–¹æ³•çš„æŸä¸€è¡Œä¸­ã€‚<br><br/></p><p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œä¸Šé¢è¿™æ®µDIEæ˜¯ä¸ºäº†ä»‹ç»æ–¹ä¾¿ç›´æ¥è´´å‡ºæ¥çš„ï¼Œå®é™…åº”ç”¨çš„æ—¶å€™éœ€è¦é€šè¿‡æœç´¢ç®—æ³•æ‰¾å‡ºåŒ…å«ç›®æ ‡ç¬¦å·è¡¨å´©æºƒåœ°å€ï¼ˆè¿™é‡Œæ˜¯0x52846ï¼‰çš„DIEã€‚<br><br/></p><p>ä»ä¸Šè¿°DIEä¸­æˆ‘ä»¬å¯ä»¥è·å–åˆ°è¿™äº›ä¿¡æ¯ï¼š</p><ol><li>å´©æºƒæ‰€åœ¨æºç æ–‡ä»¶ï¼š&#x2F;YourSourcePath&#x2F;OBDFirstConnectViewController.m</li><li>å‘ç”Ÿå´©æºƒçš„æ–¹æ³•ï¼š-[OBDFirstConnectViewController showOilPricePickerView]</li><li>å‘ç”Ÿå´©æºƒçš„æ–¹æ³•åœ¨æºæ–‡ä»¶ä¸­çš„è¡Œå·ï¼š870</li></ol><ul><li>. debug_line</li></ul><p>æˆªæ­¢ç›®å‰ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°å‘ç”Ÿäº†å´©æºƒçš„æ–¹æ³•çš„ç›¸å…³ä¿¡æ¯ï¼Œä½†è¦æƒ³ç¡®å®šå´©æºƒå‘ç”Ÿçš„å…·ä½“è¡Œå·ï¼Œè¿˜éœ€è¦.debug_line çš„å¸®åŠ©ã€‚<br><br/></p><p>.debug_line ä»¥ä¸€ä¸ªæ–¹æ³•ä¸ºåŸºæœ¬å—ï¼Œè®°äº†è¯¥æ–¹æ³•ä¸­æ¯ä¸€è¡Œå¯¹åº”çš„ç¬¦å·è¡¨åœ°å€ã€‚é€šè¿‡.debug_info å¾—çŸ¥å´©æºƒå‘ç”Ÿçš„æ–¹æ³•åœ°å€èŒƒå›´æ˜¯ 0x000502e0â€“0x00053730ï¼Œé€šè¿‡èµ·å§‹åœ°å€ 0x000502e0 å†è§£æ. debug_line å¾—åˆ°çš„ line-e.txt ä¸­ç›´æ¥æœç´¢å³å¯å¾—åˆ°å´©æºƒæ‰€åœ¨æ–¹æ³•çš„. debug_line æ•°æ®ï¼Œå…¶ä¸­éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0</span>x000000<span class="hljs-number">00000502e0</span>    <span class="hljs-number">870</span> /YourSourcePath/OBDFirstConnectViewController.m<br><span class="hljs-number">0</span>x000000<span class="hljs-number">00000502e0</span>      <span class="hljs-number">0</span><br><span class="hljs-number">0</span>x000000<span class="hljs-number">00000502f0</span>    <span class="hljs-number">872</span><br><span class="hljs-number">0</span>x000000000005033c    <span class="hljs-number">873</span><br><span class="hljs-number">0</span>x00000<span class="hljs-number">00000050374</span>    <span class="hljs-number">874</span><br><span class="hljs-number">0</span>x000000000005039e    <span class="hljs-number">875</span><br><span class="hljs-number">0</span>x000000<span class="hljs-number">00000503c8</span>    <span class="hljs-number">876</span><br>...<br><span class="hljs-number">0</span>x00000<span class="hljs-number">00000052812</span>    <span class="hljs-number">880</span><br><span class="hljs-number">0</span>x000000000005283e    <span class="hljs-number">881</span><br><span class="hljs-number">0</span>x00000<span class="hljs-number">00000052846</span>    <span class="hljs-number">882</span><br><span class="hljs-number">0</span>x000000<span class="hljs-number">00000528c8</span>    <span class="hljs-number">883</span><br>...<br></code></pre></td></tr></table></figure><p>. debug_line æ®µçš„ç¬¬ä¸€è¡Œå†…å®¹æ ‡è¯†äº†è¯¥æ–¹æ³•çš„èµ·å§‹ç¬¦å·è¡¨åœ°å€ï¼Œè¡Œå·åŠæ–¹æ³•æ‰€åœ¨æ–‡ä»¶è·¯å¾„ï¼Œé€šè¿‡ä¹‹å‰å¾—åˆ°çš„å´©æºƒåœ°å€ 0x52846 å³å¯å¾—çŸ¥å´©æºƒå‘ç”Ÿåœ¨ 882 è¡Œã€‚<br><br/></p><p>è‡³æ­¤æˆ‘ä»¬å·²ç»æ ¹æ®å´©æºƒåœ°å€è§£æå‡ºäº†å´©æºƒå‘ç”Ÿä½ç½®çš„è¯¦ç»†ä¿¡æ¯ï¼š</p><ol><li>å´©æºƒæ‰€åœ¨æºç æ–‡ä»¶ï¼š&#x2F;YourSourcePath&#x2F;OBDFirstConnectViewController.mï¼›</li><li>å‘ç”Ÿå´©æºƒçš„æ–¹æ³•ï¼š-[OBDFirstConnectViewController showOilPricePickerView]ï¼›</li><li>å‘ç”Ÿå´©æºƒçš„æ–¹æ³•åœ¨æºæ–‡ä»¶ä¸­çš„è¡Œå·ï¼š870ï¼›</li><li>å´©æºƒå‘ç”Ÿåœ¨æºæ–‡ä»¶ä¸­å¾—è¡Œå·ï¼š882ã€‚</li></ol><h2 id="äºŒã€-crash-æ—¥å¿—æ–‡ä»¶"><a href="#äºŒã€-crash-æ—¥å¿—æ–‡ä»¶" class="headerlink" title="äºŒã€**.crash æ—¥å¿—æ–‡ä»¶**"></a>äºŒã€**.crash æ—¥å¿—æ–‡ä»¶**</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Incident Identifier:</span> <span class="hljs-number">28593639</span><span class="hljs-number">-9021</span><span class="hljs-string">-4BF9-A730-0A4E644EE52E</span><br><span class="hljs-attr">CrashReporter Key:</span>   <span class="hljs-string">cf719616d48fff95262c17eaf002e4de3d3f9842</span><br><span class="hljs-attr">Hardware Model:</span>      <span class="hljs-string">iPhone8,1</span><br><span class="hljs-attr">Process:</span>             <span class="hljs-string">WeChat</span> [<span class="hljs-number">25431</span>]<br><span class="hljs-attr">Path:</span>                <span class="hljs-string">/var/../WeChat.app/WeChat</span><br><span class="hljs-attr">Identifier:</span>          <span class="hljs-string">com.tencent.xin</span><br><span class="hljs-attr">Version:</span>             <span class="hljs-number">6.5</span><span class="hljs-number">.7</span><span class="hljs-number">.32</span> <span class="hljs-string">(6.5.7)</span><br><span class="hljs-attr">Code Type:</span>           <span class="hljs-string">ARM-64</span> <span class="hljs-string">(Native)</span><br><span class="hljs-attr">Parent Process:</span>      <span class="hljs-string">launchd</span> [<span class="hljs-number">1</span>]<br><br><span class="hljs-attr">Date/Time:</span>           <span class="hljs-number">2017-04-29 14:12:13.13</span> <span class="hljs-string">+0800</span><br><span class="hljs-attr">Launch Time:</span>         <span class="hljs-number">2017-04-26 03:26:06.06</span> <span class="hljs-string">+0800</span><br><span class="hljs-attr">OS Version:</span>          <span class="hljs-string">iOS</span> <span class="hljs-number">9.3</span><span class="hljs-number">.5</span> <span class="hljs-string">(13G36)</span><br><span class="hljs-attr">Report Version:</span>      <span class="hljs-number">105</span><br><br><span class="hljs-attr">Exception Type:</span>  <span class="hljs-number">00000020</span><br><span class="hljs-attr">Exception Codes:</span> <span class="hljs-number">0x000000008badf00d</span><br><span class="hljs-attr">Exception Note:</span>  <span class="hljs-string">SIMULATED</span> <span class="hljs-string">(this</span> <span class="hljs-string">is</span> <span class="hljs-string">NOT</span> <span class="hljs-string">a</span> <span class="hljs-string">crash)</span><br><span class="hljs-attr">Highlighted by Thread:</span>  <span class="hljs-number">0</span><br><br><span class="hljs-attr">Thread 0 name:  Dispatch queue:</span> <span class="hljs-string">com.apple.main-thread</span><br><span class="hljs-attr">Thread 0:</span><br><span class="hljs-number">0</span>   <span class="hljs-string">libsystem_kernel.dylib</span>            <span class="hljs-number">0x0000000180f99014</span> <span class="hljs-number">0x180f98000</span> <span class="hljs-string">+</span> <span class="hljs-number">4116</span><br><span class="hljs-number">1</span>   <span class="hljs-string">libdispatch.dylib</span>                 <span class="hljs-number">0x0000000180e763e8</span> <span class="hljs-number">0x180e64000</span> <span class="hljs-string">+</span> <span class="hljs-number">74728</span><br><span class="hljs-number">2</span>   <span class="hljs-string">FrontBoardServices</span>                <span class="hljs-number">0x0000000182db63d4</span> <span class="hljs-number">0x182d94000</span> <span class="hljs-string">+</span> <span class="hljs-number">140244</span><br><span class="hljs-number">3</span>   <span class="hljs-string">FrontBoardServices</span>                <span class="hljs-number">0x0000000182d9e910</span> <span class="hljs-number">0x182d94000</span> <span class="hljs-string">+</span> <span class="hljs-number">43280</span><br><span class="hljs-number">15</span>  <span class="hljs-string">GraphicsServices</span>                  <span class="hljs-number">0x0000000182be0088</span> <span class="hljs-number">0x182bd4000</span> <span class="hljs-string">+</span> <span class="hljs-number">49288</span><br><span class="hljs-number">16</span>  <span class="hljs-string">UIKit</span>                             <span class="hljs-number">0x00000001865e6088</span> <span class="hljs-number">0x186568000</span> <span class="hljs-string">+</span> <span class="hljs-number">516232</span><br><span class="hljs-number">17</span>  <span class="hljs-string">WeChat</span>                            <span class="hljs-number">0x00000001000fbea4</span> <span class="hljs-number">0x100058000</span> <span class="hljs-string">+</span> <span class="hljs-number">671396</span><br><br><span class="hljs-attr">Binary Images:</span><br><span class="hljs-number">0x100058000</span> <span class="hljs-bullet">-</span> <span class="hljs-number">0x1033c3fff</span> <span class="hljs-string">WeChat</span> <span class="hljs-string">arm64</span>  <span class="hljs-string">&lt;8b7a21136f4434dfb2771b8a4218a0f1&gt;</span> <br><span class="hljs-string">/var/containers/Bundle/Application/26524DA8-D1E8-430D-8ECA-9D5ABE3CE3CA/WeChat.app/WeChat</span><br><span class="hljs-string">..</span><br></code></pre></td></tr></table></figure><p>ï¼ˆä¸Šé¢æ˜¯ä¸€ä¸ªcrashæ–‡ä»¶çš„å¤§è‡´å†…å®¹ï¼Œä¸ºäº†ç®€æ´åˆ é™¤äº†ä¸€éƒ¨åˆ†ï¼‰</p><h4 id="2-1-å‚æ•°"><a href="#2-1-å‚æ•°" class="headerlink" title="2.1.å‚æ•°"></a>2.1.å‚æ•°</h4><ul><li><strong>uuidï¼š</strong></li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Incident</span> Identifier: <span class="hljs-number">28593639</span>-<span class="hljs-number">9021</span>-<span class="hljs-number">4</span>BF9-A730-<span class="hljs-number">0</span>A4E644EE52E<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯å´©æºƒæ–‡ä»¶ä¸­çš„ uuid ï¼Œæ ¹æ®è¿™ä¸ª uuid å¯ç¡®å®šä¸ dSYM æ–‡ä»¶æ˜¯å¦åŒ¹é…ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">dwarfdump <span class="hljs-attr">--uuid</span> appName<span class="hljs-selector-class">.app</span>.dSYM/<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤è¡Œä¼šæ‰“å°å‡ºè¯¥ dSYM æ–‡ä»¶å†…æ‰€æœ‰æ¶æ„çš„ uuidã€‚</p><ul><li><strong>è¿›ç¨‹å[ID]</strong></li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Process</span>:             WeChat<span class="hljs-meta"> [25431]</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢ â€œWeChatâ€ è¡¨ç¤ºçš„æ˜¯å´©æºƒæ‰€åœ¨è¿›ç¨‹çš„åå­—ï¼Œæ‹¬å·ä¸­çš„æ•°å­—å³ä¸ºæ­¤è¿›ç¨‹çš„IDã€‚</p><ul><li><strong>CPUæ¶æ„ï¼š</strong></li></ul><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-built_in">Code</span> <span class="hljs-built_in">Type</span>:           ARM<span class="hljs-number">-64</span> (Native)<br></code></pre></td></tr></table></figure><ul><li><strong>ç¨‹åºè¿è¡Œæ—¶çš„æ˜ å°„ä¿¡æ¯:ï¼ˆBinary Imagesï¼‰</strong></li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">Binary Images:<br><span class="hljs-number">0</span>x100058000 - <span class="hljs-number">0</span>x1033c3fff WeChat arm64  &lt;<span class="hljs-number">8</span>b7a21136f4434dfb2771b8a4218a0f1&gt; <br><span class="hljs-regexp">/var/</span>containers<span class="hljs-regexp">/Bundle/</span>Application<span class="hljs-regexp">/26524DA8-D1E8-430D-8ECA-9D5ABE3CE3CA/</span>WeChat.app/WeChat<br></code></pre></td></tr></table></figure><ol><li>ç¬¬ä¸€åˆ—ï¼Œåº”ç”¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ä»£ç æ®µçš„èµ·å§‹åœ°å€~ç»ˆæ­¢åœ°å€ï¼›ï¼ˆ0x100058000 - 0x1033c3fffï¼‰</li><li>ç¬¬äºŒåˆ—ï¼Œæ˜ å°„æ–‡ä»¶åï¼›ï¼ˆWeChatï¼‰</li><li>ç¬¬ä¸‰åˆ—ï¼Œuuidï¼›ï¼ˆ8b7a21136f4434dfb2771b8a4218a0f1ï¼‰</li><li>ç¬¬å››åˆ—ï¼Œæ˜ å°„æ–‡ä»¶è·¯å¾„ï¼›</li></ol><ul><li><strong>å´©æºƒçš„å †æ ˆä¿¡æ¯ï¼ˆThread Backtraceï¼‰ï¼š</strong></li></ul><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0</span>   libsystem_kernel<span class="hljs-number">.</span>dylib            <span class="hljs-number">0x0000000180f99014</span> <span class="hljs-number">0x180f98000</span> + <span class="hljs-number">4116</span><br><span class="hljs-number">1</span>   libdispatch<span class="hljs-number">.</span>dylib                 <span class="hljs-number">0x0000000180e763e8</span> <span class="hljs-number">0x180e64000</span> + <span class="hljs-number">74728</span><br><span class="hljs-number">2</span>   FrontBoardServices                <span class="hljs-number">0x0000000182db63d4</span> <span class="hljs-number">0x182d94000</span> + <span class="hljs-number">140244</span><br><span class="hljs-number">3</span>   FrontBoardServices                <span class="hljs-number">0x0000000182d9e910</span> <span class="hljs-number">0x182d94000</span> + <span class="hljs-number">43280</span><br>..<br><span class="hljs-number">15</span>  GraphicsServices                  <span class="hljs-number">0x0000000182be0088</span> <span class="hljs-number">0x182bd4000</span> + <span class="hljs-number">49288</span><br><span class="hljs-number">16</span>  UIKit                             <span class="hljs-number">0x00000001865e6088</span> <span class="hljs-number">0x186568000</span> + <span class="hljs-number">516232</span><br><span class="hljs-number">17</span>  WeChat                            <span class="hljs-number">0x00000001000fbea4</span> <span class="hljs-number">0x100058000</span> + <span class="hljs-number">671396</span><br></code></pre></td></tr></table></figure><ol><li>ç¬¬ä¸€åˆ—ï¼šè°ƒç”¨é¡ºåºï¼›ï¼ˆ0ã€1ã€2ã€3ï¼‰</li><li>ç¬¬äºŒåˆ—ï¼šäºŒè¿›åˆ¶åº“åï¼›ï¼ˆWeChatã€UIKitï¼‰</li><li>ç¬¬ä¸‰åˆ—ï¼šè¿›ç¨‹åœ¨è¿è¡Œæ—¶å‘ç”Ÿå´©æºƒå¤„çš„åœ°å€ï¼›(stack address)</li><li>ç¬¬å››åˆ—ï¼šè¿›ç¨‹è¿è¡Œæ—¶çš„èµ·å§‹åœ°å€ï¼›(load address)</li><li>ç¬¬äº”åˆ—ï¼šå´©æºƒå¤„è·ç¦»è¿›ç¨‹èµ·å§‹åœ°å€çš„åç§»é‡ï¼›(slide)</li></ol><p>æ³¨æ„ï¼ï¼è¿™é‡Œçš„ â€œstack addressâ€ ä¸ â€œload addressâ€ éƒ½æ˜¯16è¿›åˆ¶çš„ï¼Œè€Œ â€œslideâ€ åˆ™æ˜¯10è¿›åˆ¶çš„ã€‚</p><hr><h4 id="2-2-stack-address"><a href="#2-2-stack-address" class="headerlink" title="2.2.stack address"></a>2.2.stack address</h4><p>è®¡ç®—ä¸€ä¸‹ä½ å°±ä¼šå‘ç°ï¼Œä¸Šé¢å †æ ˆä¿¡æ¯ä¸­ï¼Œç¬¬å››åˆ—+ç¬¬äº”åˆ— çš„å†…å®¹ä¸ç¬¬ä¸‰åˆ—åœ¨å®è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚ä»¥ä¸‹é¢çš„å´©æºƒå †æ ˆä¿¡æ¯çš„ç¬¬ 9 è¡Œä¸ºä¾‹ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">Thread <span class="hljs-number">0</span>:<br><span class="hljs-number">0</span>   libobjc<span class="hljs-number">.</span>A<span class="hljs-number">.</span>dylib         <span class="hljs-number">0x33f10f60</span> <span class="hljs-number">0x33efe000</span> + <span class="hljs-number">77664</span><br><span class="hljs-number">1</span>   Foundation              <span class="hljs-number">0x273526ac</span> <span class="hljs-number">0x2734a000</span> + <span class="hljs-number">34476</span><br><span class="hljs-number">9</span>   Your                    <span class="hljs-number">0x000f0846</span> <span class="hljs-number">0xa2000</span> + <span class="hljs-number">321606</span><br><span class="hljs-number">28</span>  Your                    <span class="hljs-number">0x0024643a</span> <span class="hljs-number">0xa2000</span> + <span class="hljs-number">1721402</span><br><span class="hljs-number">29</span>  libdyld<span class="hljs-number">.</span>dylib           <span class="hljs-number">0x34484aac</span> <span class="hljs-number">0x34483000</span> + <span class="hljs-number">6828</span><br><br>Binary Images:<br><span class="hljs-number">0xa2000</span> - <span class="hljs-number">0x541fff</span> Your armv7<br>/var/mobile/Containers/Bundle/Application/645D3184-4C20-<span class="hljs-number">4161</span>-924B-BDE170FA64CC/Your<span class="hljs-number">.</span>app/Your<br></code></pre></td></tr></table></figure><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">stack address <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x000f0846<span class="hljs-comment">;</span><br>load address <span class="hljs-operator">=</span> <span class="hljs-number">0</span>xa2000<span class="hljs-comment">;</span><br><span class="hljs-attribute">slide</span> <span class="hljs-operator">=</span> <span class="hljs-number">321606</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å°† slide è½¬æ¢ä¸º 16 è¿›åˆ¶åï¼ˆå³ 0x4E846ï¼‰ä¸ load address ç›¸åŠ ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">0x000f0846</span> = <span class="hljs-number">0</span>xa2000 + <span class="hljs-number">0</span>x4E846<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™ä¹ˆä¸€ä¸ªå…¬å¼ï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">stack address</span> = load address + slide;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼ï¼è¿™é‡Œ â€œstack addressâ€ å’Œ â€œload addressâ€ å‡ä¸ºç¨‹åºåœ¨è¿è¡Œæ—¶çš„åœ°å€ã€‚è¦æƒ³åˆ©ç”¨ç¬¦å·è¡¨è§£æå‡ºå´©æºƒå¯¹åº”ä½ç½®ï¼Œéœ€è¦è®¡ç®—å‡ºç¬¦å·è¡¨ä¸­å¯¹åº”çš„å´©æºƒå †æ ˆåœ°å€ï¼ˆsymbol addressï¼‰ã€‚</p><h4 id="2-3-symbol-address"><a href="#2-3-symbol-address" class="headerlink" title="2.3.symbol address"></a>2.3.symbol address</h4><p>æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªåº”ç”¨æ—¶ï¼Œå†…æ ¸ä¼šä¸ºè¯¥åº”ç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶æŠŠåº”ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åˆ°ä¸€ç‰‡è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ã€‚iOS4.3 åä¸ºäº†é˜»æ­¢å†…å­˜æº¢å‡ºæ”»å‡»è‹¹æœåœ¨iOSä¸­ä½¿ç”¨äº† <a href="https://ctinusdev.github.io/2017/08/20/Mach-OBasis_ASLR/">ASLR</a> æŠ€æœ¯ã€‚è¿™æ ·è¿›ç¨‹æ¯æ¬¡å¯åŠ¨æ—¶ï¼Œåœ°å€ç©ºé—´éƒ½ä¼šè¢«ç®€å•åœ°éšæœºåŒ–ï¼Œæ‰€ä»¥æ¯æ¬¡åŠ è½½æ—¶åœ°å€éƒ½ä¸ä¸€æ ·ã€‚è¿™é‡Œçš„éšæœºåªæ˜¯åç§»ä¸æ˜¯æ…ä¹±ï¼Œå®ç°æ–¹å¼æ˜¯é€šè¿‡å†…æ ¸å°† Mach-O çš„æ®µâ€œå¹³ç§»â€æŸä¸ªéšæœºæ•°ã€‚<br><br/></p><p>æ ¹æ®è™šæ‹Ÿå†…å­˜åç§»é‡ä¸å˜åŸç†ï¼Œåªè¦æä¾›äº†ç¬¦å·è¡¨ __TEXT æ®µçš„èµ·å§‹åœ°å€(vmaddr)ï¼Œå†åŠ ä¸Šåç§»é‡ï¼ˆè¿™é‡Œä¸º0x4E846ï¼‰å°±èƒ½å¾—åˆ°ç¬¦å·è¡¨ä¸­çš„å †æ ˆåœ°å€ï¼ˆsymbol addressï¼‰ï¼Œè®¡ç®—æ–¹æ³•ä¸ºï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">symbol address</span> = vmaddr + slide;<br></code></pre></td></tr></table></figure><p>å¦‚ä½•è·å–ç¬¦å·è¡¨ä¸­çš„ __TEXT æ®µèµ·å§‹åœ°å€å‘¢?</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$otool</span> -l xx.app.dSYM<span class="hljs-regexp">/Contents/</span>Resources<span class="hljs-regexp">/DWARF/</span>xx<br></code></pre></td></tr></table></figure><p>æ³¨æ„æŠŠ xx æ›¿æ¢ä¸ºä½ è‡ªå·±çš„åº”ç”¨åã€‚è¿è¡Œç»“æœä¸­çš„ç‰‡æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Load</span> command <span class="hljs-number">3</span><br>      <span class="hljs-attribute">cmd</span> LC_SEGMENT<br>  <span class="hljs-attribute">cmdsize</span> <span class="hljs-number">736</span><br>  <span class="hljs-attribute">segname</span> __TEXT<br>   <span class="hljs-attribute">vmaddr</span> <span class="hljs-number">0</span>x00004000<br>   <span class="hljs-attribute">vmsize</span> <span class="hljs-number">0</span>x00700000<br>  <span class="hljs-attribute">fileoff</span> <span class="hljs-number">0</span><br> <span class="hljs-attribute">filesize</span> <span class="hljs-number">0</span><br>  <span class="hljs-attribute">maxprot</span> <span class="hljs-number">0</span>x00000005<br> <span class="hljs-attribute">initprot</span> <span class="hljs-number">0</span>x00000005<br>   <span class="hljs-attribute">nsects</span> <span class="hljs-number">10</span><br>    <span class="hljs-attribute">flags</span> <span class="hljs-number">0</span>x0<br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„ vmaddr 0x00004000 å­—æ®µå³ä¸º __TEXT æ®µçš„èµ·å§‹åœ°å€ã€‚</p><p>ç”±å…¬å¼ï¼š</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">symbol address</span> = vmaddr + slide;<br></code></pre></td></tr></table></figure><p>å¯å¾—å‡ºï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">0x52846</span> = <span class="hljs-number">0</span>x4000 + <span class="hljs-number">0</span>x4E846<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å³ç¬¦å·è¡¨ä¸­çš„å´©æºƒåœ°å€ &#x3D; 0x52846ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ ¹æ®è¿™ä¸ªåœ°å€è§£æå‡ºå´©æºƒä½ç½®äº†ã€‚</p><hr><h2 id="ä¸‰ã€è§£ææ–¹æ¡ˆ"><a href="#ä¸‰ã€è§£ææ–¹æ¡ˆ" class="headerlink" title="ä¸‰ã€è§£ææ–¹æ¡ˆ"></a>ä¸‰ã€è§£ææ–¹æ¡ˆ</h2><h3 id="dwarfdump"><a href="#dwarfdump" class="headerlink" title="dwarfdump"></a>dwarfdump</h3><p>å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-variable">$dwarfdump</span> --<span class="hljs-keyword">arch</span> armv7 Your.<span class="hljs-keyword">app</span>.dSYM --<span class="hljs-keyword">lookup</span> 0x52846 | grep &#x27;<span class="hljs-keyword">Line</span> <span class="hljs-keyword">table</span>&#x27;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¿™é‡Œçš„ armv7 æ˜¯è¿è¡Œè®¾å¤‡çš„ CPU æŒ‡ä»¤é›†ï¼Œè€Œä¸æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶çš„æŒ‡ä»¤é›†ã€‚æ¯”å¦‚ armv7 æŒ‡ä»¤é›†çš„äºŒè¿›åˆ¶æ–‡ä»¶è¿è¡Œåœ¨ arm64 æŒ‡ä»¤é›†çš„è®¾å¤‡ä¸Šï¼Œè¿™ä¸ªåœ°æ–¹åº”è¯¥å†™ arm64ã€‚</p><ul><li>â€“lookup åé¢è·Ÿçš„ä¸€å®šæ˜¯ç»è¿‡å‡†ç¡®è®¡ç®—çš„ç¬¦å·è¡¨ä¸­çš„å´©æºƒåœ°å€</li><li>ä½¿ç”¨ dwarfdump è§£æçš„ç»“æœè¾ƒæ‚ä¹±ï¼Œå› æ­¤ä½¿ç”¨ grep å‘½ä»¤æŠ“å–å…¶ä¸­å…³é”®ç‚¹å±•ç¤ºå‡ºæ¥</li></ul><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">Line</span> <span class="hljs-keyword">table</span> dir : <span class="hljs-string">&#x27;/data/.../Src/OBDConnectSetting/Controller&#x27;</span><br><span class="hljs-type">Line</span> <span class="hljs-keyword">table</span> file: <span class="hljs-string">&#x27;OBDFirstConnectViewController.m&#x27;</span> <span class="hljs-type">line</span> <span class="hljs-number">882</span>, <span class="hljs-keyword">column</span> <span class="hljs-number">5</span> <span class="hljs-keyword">with</span> <span class="hljs-keyword">start</span> address <span class="hljs-number">0x000000000052768</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ç¬¬ä¸€è¡Œæ˜¯ç¼–è¯‘æ—¶æ–‡ä»¶ç›®å½•ï¼Œç¬¬äºŒè¡ŒåŒ…å«äº†å´©æºƒå‘ç”Ÿçš„æ–‡ä»¶åç§°ä»¥åŠæ–‡ä»¶ä¸­å…·ä½“è¡Œå·ç­‰ä¿¡æ¯ï¼Œæœ‰äº†è¿™äº›ä¿¡æ¯å°±èƒ½å‡†ç¡®å®šä½å´©æºƒåŸå› å•¦ã€‚</p><hr><h3 id="atos"><a href="#atos" class="headerlink" title="atos"></a>atos</h3><p>atos å‘½ä»¤å¯ä»¥è§£æå‡ºæŒ‡å®šæŸä¸€è¡Œçš„å †æ ˆï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$atos</span> -o <span class="hljs-regexp">/Users/</span>xxx<span class="hljs-regexp">/crash/</span>AppName.app/AppName -arch armv7 <span class="hljs-number">0</span>x52846<br></code></pre></td></tr></table></figure><p>å…¶æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">-<span class="hljs-selector-attr">[OBDFirstConnectViewController showOilPricePickerView]</span> (in Your) (OBDFirstConnectViewController.m:<span class="hljs-number">882</span>)<br></code></pre></td></tr></table></figure><hr><h3 id="æ— éœ€è®¡ç®—å´©æºƒåœ°å€"><a href="#æ— éœ€è®¡ç®—å´©æºƒåœ°å€" class="headerlink" title="æ— éœ€è®¡ç®—å´©æºƒåœ°å€"></a>æ— éœ€è®¡ç®—å´©æºƒåœ°å€</h3><p>atos è¿˜æä¾›äº†å¦å¤–ä¸€ç§æ— éœ€è®¡ç®—å´©æºƒåœ°å€å¯¹åº”çš„ç¬¦å·è¡¨åœ°å€çš„æ–¹å¼ï¼Œå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$atos</span> -o Your.app.dSYM<span class="hljs-regexp">/Contents/</span>Resources<span class="hljs-regexp">/DWARF/</span>Your -arch armv7 -l [load address] [stack address]<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ -l é€‰é¡¹æŒ‡å®šäº†äºŒè¿›åˆ¶æ–‡ä»¶åœ¨è¿è¡Œæ—¶çš„ <strong>load address</strong> (0xa2000)ï¼Œåé¢è·Ÿçš„æ˜¯å´©æºƒå‘ç”Ÿæ—¶çš„ <strong>stack address</strong> (0x000f0846)ã€‚è§£æç»“æœï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">-<span class="hljs-selector-attr">[OBDFirstConnectViewController showOilPricePickerView]</span> (in Your) (OBDFirstConnectViewController.m:<span class="hljs-number">882</span>)<br></code></pre></td></tr></table></figure><h3 id="shellè„šæœ¬"><a href="#shellè„šæœ¬" class="headerlink" title="shellè„šæœ¬"></a>shellè„šæœ¬</h3><p>æ¡Œé¢æ–°å»ºä¸€ä¸ªcrashæ–‡ä»¶å¤¹ï¼ŒæŠŠdSYMæ–‡ä»¶ã€å‹ç›Ÿæ—¥å¿—txt åŠ shell è„šæœ¬æ”¾è¿›æ¥ã€‚</p><ul><li>å‹ç›Ÿæ—¥å¿—å†…å®¹ï¼š</li></ul><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">Application received signal SIGSEGV<br>(null)<br>((<br><span class="hljs-number">0</span> CoreFoundation<span class="hljs-number">0x0000000190f311b8</span> <span class="hljs-number">0x0000000190e01000</span> + <span class="hljs-number">1245624</span><br><span class="hljs-number">1</span> libobjc<span class="hljs-number">.</span>A<span class="hljs-number">.</span>dylib<span class="hljs-number">0x000000018f96855c</span> objc_exception_throw + <span class="hljs-number">56</span><br><span class="hljs-number">2</span> CoreFoundation<span class="hljs-number">0x0000000190f3108c</span> <span class="hljs-number">0x0000000190e01000</span> + <span class="hljs-number">1245324</span><br><span class="hljs-number">3</span> Foundation<span class="hljs-number">0x00000001919e902c</span> <span class="hljs-number">0x000000019193b000</span> + <span class="hljs-number">712748</span><br><span class="hljs-number">4</span> UIKit<span class="hljs-number">0x00000001976c5704</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">9365252</span><br><span class="hljs-number">5</span> UIKit<span class="hljs-number">0x00000001976c5afc</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">9366268</span><br><span class="hljs-number">6</span> UIKit<span class="hljs-number">0x00000001976c6f0c</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">9371404</span><br><span class="hljs-number">7</span> UIKit<span class="hljs-number">0x00000001975f1c10</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">8498192</span><br><span class="hljs-number">8</span> UIKit<span class="hljs-number">0x00000001975f1e28</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">8498728</span><br><span class="hljs-number">9</span> MyApp<span class="hljs-number">0x0000000100223668</span> <span class="hljs-number">0x00000001000ac000</span> + <span class="hljs-number">1537640</span><br><span class="hljs-number">10</span> MyApp<span class="hljs-number">0x00000001001e1588</span> <span class="hljs-number">0x00000001000ac000</span> + <span class="hljs-number">1267080</span><br><span class="hljs-number">11</span> UIKit<span class="hljs-number">0x00000001973aef80</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">6127488</span><br><span class="hljs-number">12</span> UIKit<span class="hljs-number">0x00000001973b2748</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">6141768</span><br><span class="hljs-number">13</span> UIKit<span class="hljs-number">0x0000000196f7973c</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">1713980</span><br><span class="hljs-number">14</span> UIKit<span class="hljs-number">0x0000000196e180f0</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">266480</span><br><span class="hljs-number">15</span> UIKit<span class="hljs-number">0x00000001973a2680</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">6076032</span><br><span class="hljs-number">16</span> UIKit<span class="hljs-number">0x00000001973a21e0</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">6074848</span><br><span class="hljs-number">17</span> UIKit<span class="hljs-number">0x00000001973a149c</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">6071452</span><br><span class="hljs-number">18</span> UIKit<span class="hljs-number">0x0000000196e1630c</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">258828</span><br><span class="hljs-number">19</span> UIKit<span class="hljs-number">0x0000000196de6da0</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">64928</span><br><span class="hljs-number">20</span> MyApp<span class="hljs-number">0x00000001005b01b4</span> __cxa_throw + <span class="hljs-number">2250128</span><br><span class="hljs-number">21</span> UIKit<span class="hljs-number">0x00000001975d075c</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">8361820</span><br><span class="hljs-number">22</span> UIKit<span class="hljs-number">0x00000001975ca130</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">8335664</span><br><span class="hljs-number">23</span> CoreFoundation<span class="hljs-number">0x0000000190edeb5c</span> <span class="hljs-number">0x0000000190e01000</span> + <span class="hljs-number">908124</span><br><span class="hljs-number">24</span> CoreFoundation<span class="hljs-number">0x0000000190ede4a4</span> <span class="hljs-number">0x0000000190e01000</span> + <span class="hljs-number">906404</span><br><span class="hljs-number">25</span> CoreFoundation<span class="hljs-number">0x0000000190edc0a4</span> <span class="hljs-number">0x0000000190e01000</span> + <span class="hljs-number">897188</span><br><span class="hljs-number">26</span> CoreFoundation<span class="hljs-number">0x0000000190e0a2b8</span> CFRunLoopRunSpecific + <span class="hljs-number">444</span><br><span class="hljs-number">27</span> GraphicsServices<span class="hljs-number">0x00000001928be198</span> GSEventRunModal + <span class="hljs-number">180</span><br><span class="hljs-number">28</span> UIKit<span class="hljs-number">0x0000000196e517fc</span> <span class="hljs-number">0x0000000196dd7000</span> + <span class="hljs-number">501756</span><br><span class="hljs-number">29</span> UIKit<span class="hljs-number">0x0000000196e4c534</span> UIApplicationMain + <span class="hljs-number">208</span><br><span class="hljs-number">30</span> MyApp<span class="hljs-number">0x00000001001b5804</span> <span class="hljs-number">0x00000001000ac000</span> + <span class="hljs-number">1087492</span><br><span class="hljs-number">31</span> libdyld<span class="hljs-number">.</span>dylib<span class="hljs-number">0x000000018fded5b8</span> <span class="hljs-number">0x000000018fde9000</span> + <span class="hljs-number">17848</span><br>)<br><br>dSYM UUID: 1852C4B7-<span class="hljs-number">8391</span>-<span class="hljs-number">3615</span>-ADA5-2EE58D11DDED<br><span class="hljs-meta">CPU</span> Type: armv7<br>Slide Address: <span class="hljs-number">0x00004000</span><br>Binary Image: MyApp<br>Base Address: <span class="hljs-number">0x000ca000</span><br></code></pre></td></tr></table></figure><ul><li>shellè„šæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs bash">DSYM=<span class="hljs-variable">$1</span><br>LOGFILE=<span class="hljs-variable">$2</span><br><br><span class="hljs-keyword">if</span> [ ! -n <span class="hljs-string">&quot;<span class="hljs-variable">$DSYM</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt; DSYM is missing!!!&quot;</span><br>  <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [ ! -n <span class="hljs-string">&quot;<span class="hljs-variable">$LOGFILE</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&gt;&gt;&gt;&gt; log file is missing!!!&quot;</span><br>  <span class="hljs-built_in">exit</span><br><span class="hljs-keyword">fi</span> <br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/////////////////////&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot; Info get... &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/////////////////////&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><br>DSYM_UUID_KEY=<span class="hljs-string">&quot;dSYM UUID: &quot;</span><br>DSYM_CPUTYPE_KEY=<span class="hljs-string">&quot;CPU Type: &quot;</span><br>DSYM_BINARY_KEY=<span class="hljs-string">&quot;Binary Image: &quot;</span><br><br><span class="hljs-comment"># first loop get uuid, cpu, binary</span><br><span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> singleLine<br><span class="hljs-keyword">do</span><br>str=<span class="hljs-string">&quot;<span class="hljs-variable">$singleLine</span>&quot;</span><br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$str</span> == <span class="hljs-variable">$DSYM_UUID_KEY</span>* ]]; <span class="hljs-keyword">then</span><br>UUID=<span class="hljs-variable">$&#123;str#*&quot;$DSYM_UUID_KEY&quot;&#125;</span>;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Log UUID: &quot;</span><span class="hljs-variable">$UUID</span>; <br><span class="hljs-keyword">elif</span> [[ <span class="hljs-variable">$str</span> == <span class="hljs-variable">$DSYM_CPUTYPE_KEY</span>* ]]; <span class="hljs-keyword">then</span><br>CPU=<span class="hljs-variable">$&#123;str#*&quot;$DSYM_CPUTYPE_KEY&quot;&#125;</span>;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Log CPU: &quot;</span><span class="hljs-variable">$CPU</span>; <br><span class="hljs-keyword">elif</span> [[ <span class="hljs-variable">$str</span> == <span class="hljs-variable">$DSYM_BINARY_KEY</span>* ]]; <span class="hljs-keyword">then</span><br>BINARY=<span class="hljs-variable">$&#123;str#*&quot;$DSYM_BINARY_KEY&quot;&#125;</span>;<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Log BINARY: &quot;</span><span class="hljs-variable">$BINARY</span>; <br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">done</span> &lt; <span class="hljs-variable">$LOGFILE</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/////////////////////&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot; Info check... &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/////////////////////&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><br>checkUUID=`dwarfdump --uuid <span class="hljs-variable">$DSYM</span> -<span class="hljs-built_in">arch</span> <span class="hljs-variable">$CPU</span>`<br>checkUUID=<span class="hljs-variable">$&#123;checkUUID#*&quot;UUID: &quot;&#125;</span><br>checkUUID=<span class="hljs-variable">$&#123;checkUUID%&quot; ($CPU)&quot;*&#125;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;DSYM UUID: <span class="hljs-variable">$checkUUID</span>&quot;</span><br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$UUID</span>&quot;</span> == <span class="hljs-string">&quot;<span class="hljs-variable">$checkUUID</span>&quot;</span> ]]; <span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;UUID check passed.&quot;</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Warning!!!!!! UUID is not the same.. even though the code could be.&quot;</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/////////////////////&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot; Log trace... &quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/////////////////////&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment">#final loop get trace</span><br><span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> singleLine<br><span class="hljs-keyword">do</span><br>str=<span class="hljs-string">&quot;<span class="hljs-variable">$singleLine</span>&quot;</span><br> <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$str</span> == <span class="hljs-variable">$DSYM_BINARY_KEY</span>* ]]; <span class="hljs-keyword">then</span><br><span class="hljs-comment">#delete image</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">else</span><br><br>str=<span class="hljs-variable">$&#123;str#*&quot; &quot;&#125;</span><br>fuck=<span class="hljs-string">&quot; <span class="hljs-variable">$BINARY</span>&quot;</span><br><span class="hljs-comment"># fuck space - -</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$str</span> == *<span class="hljs-variable">$BINARY</span>* ]]; <span class="hljs-keyword">then</span><br>str=<span class="hljs-variable">$&#123;str#*&quot;$BINARY &quot;&#125;</span>;<br>str=<span class="hljs-variable">$&#123;str%&quot; &quot;*&#125;</span><br><span class="hljs-comment"># echo &quot;adrress: &quot;$str; </span><br><span class="hljs-built_in">echo</span> `atos -o <span class="hljs-variable">$DSYM</span>/Contents/Resources/DWARF/<span class="hljs-variable">$BINARY</span> -<span class="hljs-built_in">arch</span> <span class="hljs-variable">$CPU</span> <span class="hljs-variable">$str</span>`<br><span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">done</span> &lt; <span class="hljs-variable">$LOGFILE</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œè„šæœ¬:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">.<span class="hljs-regexp">/trace_dsyms.sh Release.dSYM/</span> crash<br></code></pre></td></tr></table></figure><hr><h3 id="symbolicatecrash"><a href="#symbolicatecrash" class="headerlink" title="symbolicatecrash"></a>symbolicatecrash</h3><p><strong>symbolicatecrash</strong> æ˜¯Xcodeè‡ªå¸¦çš„ä¸€ä¸ªåˆ†æå·¥å…·ï¼Œå¯ä»¥é€šè¿‡æœºå™¨ä¸Šçš„å´©æºƒæ—¥å¿—å’Œåº”ç”¨çš„.dSYMæ–‡ä»¶å®šä½å‘ç”Ÿå´©æºƒçš„ä½ç½®ï¼ŒæŠŠcrashæ—¥å¿—ä¸­çš„åœ°å€æ›¿æ¢æˆä»£ç ç›¸åº”ä½ç½®ã€‚<br><br/></p><p>1ã€æ–‡ä»¶å‡†å¤‡ï¼š<strong>.app</strong> ä¸ <strong>.dSYM</strong> æ–‡ä»¶</p><ul><li>æ‹·è´ <strong>.crash</strong> æ–‡ä»¶åˆ°æ¡Œé¢æ–°å»ºçš„crashæ–‡ä»¶å¤¹å†…ï¼›</li><li>Xcode-&gt;Window-&gt;Organizer-&gt;APP-&gt;Show in Finderï¼›</li><li><strong>.xcarchive</strong>æ–‡ä»¶-&gt;æ˜¾ç¤ºåŒ…å†…å®¹ï¼Œæ‰¾åˆ° <em>.app.dSYM ä¸</em> .appæ–‡ä»¶ï¼Œå¹¶å¤åˆ¶åˆ° crash ç›®å½•ä¸­ï¼›</li></ul><p>2ã€æ‰¾åˆ°symbolicatecrash</p><ul><li>ç»ˆç«¯ä¸­æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼š</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">find</span> <span class="hljs-regexp">/Applications/</span>Xcode.app -name symbolicatecrash -type f<br></code></pre></td></tr></table></figure><ul><li>ç¨ç­‰å°±ä¼šè¾“å‡ºsymbolicatecrashè·¯å¾„</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/Applications/</span>Xcode.app<span class="hljs-regexp">/Contents/</span>SharedFrameworks<span class="hljs-regexp">/DVTFoundation.framework/</span>Versions<span class="hljs-regexp">/A/</span>Resources/symbolicatecrash<br></code></pre></td></tr></table></figure><ul><li>æ‹·è´symbolicatecrashåˆ°crashç›®å½•ä¸­ï¼Œä¸ä¸Šé¢ä¿©æ–‡ä»¶æ”¾åˆ°ä¸€èµ·ã€‚</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cp <span class="hljs-regexp">/Applications/</span>Xcode.app<span class="hljs-regexp">/Contents/</span>SharedFrameworks<span class="hljs-regexp">/DVTFoundation.framework/</span>Versions<span class="hljs-regexp">/A/</span>Resources<span class="hljs-regexp">/symbolicatecrash /</span>Users<span class="hljs-regexp">/xxx/</span>Desktop/crash<br><br></code></pre></td></tr></table></figure><p>3ã€æ‰§è¡Œsymbolicatecrash</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/Users/</span>xxx<span class="hljs-regexp">/Desktop/</span>crash<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">.<span class="hljs-regexp">/symbolicatecrash /</span>Users<span class="hljs-regexp">/xxx/</span>Desktop<span class="hljs-regexp">/crash/</span>xxx.crash <span class="hljs-regexp">/Users/</span>xxx<span class="hljs-regexp">/Desktop/</span>crash/xxx.app.dSYM &gt; new_symbol.crash<br></code></pre></td></tr></table></figure><ul><li>è¿™æ—¶å€™ç»ˆç«¯æœ‰å¯èƒ½ä¼šå‡ºç°ï¼š</li></ul><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs subunit"><span class="hljs-keyword">Error: </span>&quot;DEVELOPER_DIR&quot; is not defined at ./symbolicatecrash line 69.<br></code></pre></td></tr></table></figure><ul><li>è¾“å…¥å‘½ä»¤ï¼š</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">export</span> <span class="hljs-attribute">DEVELOPER_DIR</span>=<span class="hljs-string">&quot;/Applications/XCode.app/Contents/Developer&quot;</span><br></code></pre></td></tr></table></figure><ul><li><p>å†æ‰§è¡Œï¼Œè¿™æ—¶å€™ç»ˆç«¯å°†ä¼šè¿›è¡Œå¤„ç†äº†ã€‚</p></li><li><p>ç»ˆç«¯å®Œæˆåï¼Œåœ¨ crash æ–‡ä»¶å¤¹é‡Œä¼šå¤šå‡ºä¸€ä¸ªnew_symbol.crashæ–‡ä»¶ï¼Œæ‰“å¼€å³å¯æŸ¥çœ‹BUGè¯¦æƒ…ã€‚</p></li></ul><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="http://foggry.com/blog/2015/07/27/ru-he-shou-dong-jie-xi-crashlog/">Â©ç‹ä¸­å‘¨-æ‰‹åŠ¨è§£æCrashLogä¹‹â€”-æ–¹æ³•ç¯‡</a></p><p>#<a href="http://foggry.com/blog/2015/08/10/ru-he-shou-dong-jie-xi-crashlogzhi-yuan-li-pian/">Â©ç‹ä¸­å‘¨-æ‰‹åŠ¨è§£æCrashLogä¹‹â€”-åŸç†ç¯‡</a></p><p>#<a href="https://ctinusdev.github.io/2017/08/20/Mach-OBasis_ASLR/">Â©ctinusdev-Mach-Oæ–‡ä»¶ä»‹ç»ä¹‹ASLR</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¼‚å¸¸</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çº¦æŸä¸å¸ƒå±€</title>
    <link href="/2018/06/22/autolayout.html"/>
    <url>/2018/06/22/autolayout.html</url>
    
    <content type="html"><![CDATA[<h2 id="1-Autoresizing"><a href="#1-Autoresizing" class="headerlink" title="#1.Autoresizing"></a>#1.Autoresizing</h2><p><code>Autoresizing</code>æ˜¯è‹¹æœæ—©æœŸçš„ç•Œé¢é€‚é…æ–¹æ¡ˆï¼Œé‚£æ—¶è‹¹æœçš„è®¾å¤‡è¿˜ä¸ç®—å¤šï¼ŒiPhone åªæœ‰ 4s åŠå…¶ä¹‹å‰çš„äº§å“ï¼Œéƒ½æ˜¯3.5è‹±å¯¸å±å¹•ï¼›iPad ä¹Ÿåªæœ‰ iPad1ã€iPad2ï¼Œéƒ½æ˜¯9.7è‹±å¯¸ã€‚å¹¶ä¸”å½“æ—¶ iOS ä¸Šçš„åº”ç”¨å¾ˆå°‘éœ€è¦é€‚é…æ¨ªå±ï¼Œæ‰€ä»¥<code>Autoresizing</code>èƒ½å¤Ÿæ»¡è¶³ç»å¤§éƒ¨åˆ†çš„é€‚é…éœ€æ±‚ã€‚<br><br/></p><p>1.1.<code>xib</code>æˆ–è€…<code>æ•…äº‹æ¿</code>(iOS5)ä¸­çš„6æ¡çº¿ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_AutoResizing.png" alt="autoresizing"></p><p>1.2.ä»£ç ä¸­çš„6ä¸ªæšä¸¾å€¼ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">typedef</span> <span class="hljs-built_in">NS_OPTIONS</span>(<span class="hljs-built_in">NSUInteger</span>, <span class="hljs-built_in">UIViewAutoresizing</span>) &#123;<br>    <span class="hljs-built_in">UIViewAutoresizingNone</span>                 = <span class="hljs-number">0</span>,         <span class="hljs-comment">//ä¸å˜</span><br>    <span class="hljs-built_in">UIViewAutoresizingFlexibleLeftMargin</span>   = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>,    <span class="hljs-comment">//ä¸çˆ¶è§†å›¾çš„å·¦è¾¹è·å¯å˜ï¼Œä»¥ä¿è¯å³è¾¹è·ä¸å˜</span><br>    <span class="hljs-built_in">UIViewAutoresizingFlexibleWidth</span>        = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,    <span class="hljs-comment">//è‡ªåŠ¨è°ƒæ•´è‡ªèº«å®½åº¦ï¼Œä»¥ä¿è¯å·¦å³è¾¹è·ä¸å˜</span><br>    <span class="hljs-built_in">UIViewAutoresizingFlexibleRightMargin</span>  = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,    <span class="hljs-comment">//ä¸çˆ¶è§†å›¾çš„å³è¾¹è·å¯å˜ï¼Œä»¥ä¿è¯å·¦è¾¹è·ä¸å˜</span><br>    <span class="hljs-built_in">UIViewAutoresizingFlexibleTopMargin</span>    = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,    <span class="hljs-comment">//ä¸çˆ¶è§†å›¾çš„ä¸Šè¾¹è·å¯å˜ï¼Œä»¥ä¿è¯åº•éƒ¨è¾¹è·ä¸å˜</span><br>    <span class="hljs-built_in">UIViewAutoresizingFlexibleHeight</span>       = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,    <span class="hljs-comment">//è‡ªåŠ¨è°ƒæ•´è‡ªèº«é«˜åº¦ï¼Œä»¥ä¿è¯ä¸Šä¸‹è¾¹è·ä¸å˜</span><br>    <span class="hljs-built_in">UIViewAutoresizingFlexibleBottomMargin</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>     <span class="hljs-comment">//ä¸çˆ¶è§†å›¾çš„ä¸‹è¾¹è·å¯å˜ï¼Œä»¥ä¿è¯ä¸Šè¾¹è·ä¸å˜</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™6ä¸ªæšä¸¾å€¼åœ¨å®é™…åº”ç”¨æ—¶ä¸€èˆ¬éƒ½æ˜¯ç»„åˆèµ·æ¥ä½¿ç”¨ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// è·Ÿéšçˆ¶è§†å›¾çš„å®½åº¦å’Œé«˜åº¦ç­‰æ¯”ç¼©æ”¾ï¼Œä»¥ä¿è¯ä¸Šä¸‹å·¦å³è¾¹è·éƒ½ä¸å˜</span><br>view.autoresizingMask = <span class="hljs-built_in">UIViewAutoresizingFlexibleWidth</span> | <span class="hljs-built_in">UIViewAutoresizingFlexibleHeight</span>;<br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>Autoresizing</code>ï¼Œä½ å¯ä»¥æ–¹ä¾¿çš„è®¾ç½®æŸä¸ªæ§ä»¶<del><strong>ç›¸å¯¹äºå…¶çˆ¶è§†å›¾çš„å¸ƒå±€</strong></del>ä½†è¿™ä¹Ÿæ˜¯å®ƒçš„æœ€å¤§ç¼ºç‚¹ï¼šå®ƒåªèƒ½ç”¨äºè®¾ç½®å­è§†å›¾ç›¸å¯¹äºå…¶çˆ¶è§†å›¾çš„å¸ƒå±€ï¼Œå¯¹äºä¸å…¶åŒçº§çš„å…„å¼Ÿè§†å›¾ï¼Œæˆ–è€…å…¶ä»–çˆ¶è§†å›¾å†…çš„å­è§†å›¾ä¹‹é—´çš„ä½ç½®å…³ç³»ï¼Œå®ƒèƒ½åšçš„å¾ˆå°‘ã€‚</p><h2 id="2-AutoLayout"><a href="#2-AutoLayout" class="headerlink" title="#2.AutoLayout"></a>#2.AutoLayout</h2><p>2012å¹´ iOS6 å‘å¸ƒï¼Œéšä¹‹è€Œæ¥çš„è®¾å¤‡æ˜¯ 4.0 è‹±å¯¸çš„ iPhone 5ï¼Œæˆ‘ä»¬éœ€è¦é€‚é…çš„å±å¹•å°ºå¯¸å¤šäº†ä¸€ä¸ªã€‚ä¸ºäº†å‡å°‘å¼€å‘è€…çš„é€‚é…å·¥ä½œé‡ï¼Œè‹¹æœæä¾›äº†åŸºäº<code>çº¦æŸ</code>çš„<code>AutoLayout</code>ï¼Œå³è‡ªåŠ¨å¸ƒå±€è¿™ä¸€é€‚é…æ–¹æ¡ˆã€‚<code>çº¦æŸ</code>æ¡ä»¶æ§åˆ¶äº†å„æ§ä»¶ä¹‹é—´çš„ä½ç½®å…³ç³»ï¼Œä¸”ä¸å±€é™äºå­æ§ä»¶ä¸å…¶çˆ¶è§†å›¾ä¹‹é—´äº†ï¼Œä»»æ„ä¸¤ä¸ªæ§ä»¶ä¹‹é—´éƒ½å¯ä»¥è®¾ç½®çº¦æŸå…³ç³»ã€‚<br><br/></p><p>2.1.æ•…äº‹æ¿ä¸­å¼€å¯è‡ªåŠ¨å¸ƒå±€ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_autolayout.png" alt="AutoLayout"></p><p>2.2.ä»£ç ä¸­è®¾ç½®çº¦æŸï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">_mTitle.translatesAutoresizingMaskIntoConstraints = <span class="hljs-literal">NO</span>;<br><span class="hljs-comment">//mTitle å®½åº¦ 100</span><br><span class="hljs-built_in">NSLayoutConstraint</span> *widthcons = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:_mTitle<br>                             attribute:<span class="hljs-built_in">NSLayoutAttributeWidth</span><br>                             relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span><br>                                toItem:<span class="hljs-literal">nil</span><br>                             attribute:<span class="hljs-built_in">NSLayoutAttributeNotAnAttribute</span><br>                            multiplier:<span class="hljs-number">1.</span>f<br>                              constant:<span class="hljs-number">100.</span>f];<br><span class="hljs-comment">//mTitle åœ¨self.viewä¸­æ°´å¹³å±…ä¸­</span><br><span class="hljs-built_in">NSLayoutConstraint</span> *deltXcons =[<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:_mTitle<br>                                                            attribute:<span class="hljs-built_in">NSLayoutAttributeCenterX</span><br>                                                            relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span><br>                                                               toItem:<span class="hljs-keyword">self</span>.view<br>                                                            attribute:<span class="hljs-built_in">NSLayoutAttributeCenterX</span><br>                                                           multiplier:<span class="hljs-number">1.</span>f<br>                                                             constant:<span class="hljs-number">0</span>];<br><span class="hljs-comment">//mTitle åœ¨self.viewä¸­å‚ç›´å±…ä¸­</span><br><span class="hljs-built_in">NSLayoutConstraint</span> *deltYcons =[<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:_mTitle<br>                                                            attribute:<span class="hljs-built_in">NSLayoutAttributeCenterY</span><br>                                                            relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span><br>                                                               toItem:<span class="hljs-keyword">self</span>.view<br>                                                            attribute:<span class="hljs-built_in">NSLayoutAttributeCenterY</span><br>                                                           multiplier:<span class="hljs-number">1.</span>f<br>                                                             constant:<span class="hljs-number">0</span>];<br>[<span class="hljs-keyword">self</span>.view addConstraint:widthcons];<br>[<span class="hljs-keyword">self</span>.view addConstraint:deltXcons];<br>[<span class="hljs-keyword">self</span>.view addConstraint:deltYcons];<br>__<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) wSf = <span class="hljs-keyword">self</span>;<br>[<span class="hljs-built_in">UIView</span> animateWithDuration:<span class="hljs-number">0.5</span> animations:^&#123;<br>    __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(wSf) sSf = wSf;<br>    [sSf.mTitle layoutIfNeeded];<br>&#125;];<br></code></pre></td></tr></table></figure><ul><li>å‚æ•°1ï¼šattribute</li></ul><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs elm">typedef <span class="hljs-type">NS_ENUM</span>(<span class="hljs-type">NSInteger</span>, <span class="hljs-type">NSLayoutAttribute</span>) &#123;<br>    <span class="hljs-type">NSLayoutAttributeLeft</span> = 1,<br>    <span class="hljs-type">NSLayoutAttributeRight</span>,<br>    <span class="hljs-type">NSLayoutAttributeTop</span>,<br>    <span class="hljs-type">NSLayoutAttributeBottom</span>,<br>    <span class="hljs-type">NSLayoutAttributeLeading</span>,<br>    <span class="hljs-type">NSLayoutAttributeTrailing</span>,<br>    <span class="hljs-type">NSLayoutAttributeWidth</span>,<br>    <span class="hljs-type">NSLayoutAttributeHeight</span>,<br>    <span class="hljs-type">NSLayoutAttributeCenterX</span>,<br>    <span class="hljs-type">NSLayoutAttributeCenterY</span>,<br>    <span class="hljs-type">NSLayoutAttributeLastBaseline</span>,<br>    <span class="hljs-type">NSLayoutAttributeBaseline</span> <span class="hljs-type">NS_SWIFT_UNAVAILABLE</span>(&quot;<span class="hljs-type">Use</span> &#x27;lastBaseline&#x27; instead&quot;) = <span class="hljs-type">NSLayoutAttributeLastBaseline</span>,<br>    <span class="hljs-type">NSLayoutAttributeFirstBaseline</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <br>    <br>    <span class="hljs-type">NSLayoutAttributeLeftMargin</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <span class="hljs-type">NSLayoutAttributeRightMargin</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <span class="hljs-type">NSLayoutAttributeTopMargin</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <span class="hljs-type">NSLayoutAttributeBottomMargin</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <span class="hljs-type">NSLayoutAttributeLeadingMargin</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <span class="hljs-type">NSLayoutAttributeTrailingMargin</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <span class="hljs-type">NSLayoutAttributeCenterXWithinMargins</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <span class="hljs-type">NSLayoutAttributeCenterYWithinMargins</span> <span class="hljs-type">NS_ENUM_AVAILABLE_IOS(8_0)</span>,<br>    <br>    <span class="hljs-type">NSLayoutAttributeNotAnAttribute</span> = 0<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>å‚æ•°2ï¼šrelation</li></ul><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs elm">typedef <span class="hljs-type">NS_ENUM</span>(<span class="hljs-type">NSInteger</span>, <span class="hljs-type">NSLayoutRelation</span>) &#123;<br>    <span class="hljs-type">NSLayoutRelationLessThanOrEqual</span> = -1,<br>    <span class="hljs-type">NSLayoutRelationEqual</span> = 0,<br>    <span class="hljs-type">NSLayoutRelationGreaterThanOrEqual</span> = 1,<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>å‚æ•°3ï¼šmultiplier</li></ul><p>æ¯”ä¾‹æˆ–è€…å€æ•°ï¼Œæœ€ç»ˆçº¦æŸçš„å€¼ &#x3D; multiplier * constantã€‚</p><ul><li>å‚æ•°4ï¼šconstant</li></ul><p>é»˜è®¤å€æ•°ä¸º1æ—¶çš„çº¦æŸçš„å€¼ã€‚</p><br/><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p><ul><li>åœ¨æ·»åŠ çº¦æŸä¹‹å‰ï¼Œé¡»ç¡®ä¿æ§ä»¶å·²ç»æ·»åŠ åˆ°çˆ¶è§†å›¾ä¸­ï¼›</li><li>æ§ä»¶çš„ translatesAutoresizingMaskIntoConstraints å¿…é¡»è¦è®¾ç½®ä¸ºNO~</li></ul><p>å¦å¤–ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡<code>VFL</code>æ ¼å¼åˆ›å»º<code>NSLayoutConstraint</code>ï¼Œä¸è¿‡å®ƒæ¯”è¾ƒæŠ½è±¡ï¼Œä¸å®¹æ˜“ç†è§£ï¼Œè¿™é‡Œæš‚ä¸ä»‹ç»äº†ã€‚</p><h2 id="3-SizeClasses"><a href="#3-SizeClasses" class="headerlink" title="#3.SizeClasses"></a>#3.SizeClasses</h2><p>2014å¹´ iOS8 å‘å¸ƒï¼Œéšä¹‹è€Œæ¥çš„è®¾å¤‡æ˜¯4.7è‹±å¯¸çš„ iphone6 å’Œ5.5è‹±å¯¸çš„ iphone6 Plusã€‚è¿™æ ·æˆ‘ä»¬éœ€è¦é€‚é…çš„å±å¹•å°ºå¯¸åˆå¤šäº†ä¸¤æ¬¾ï¼Œé€‚é…éš¾åº¦è¿›ä¸€æ­¥å¢åŠ ã€‚è¿™æ—¶è‹¹æœæå‡ºäº†<code>SizeClasses</code>æ¦‚å¿µï¼Œè¿™æ˜¯è‹¹æœå¯¹è¯¸å¤šè®¾å¤‡å®½é«˜å°ºå¯¸çš„ä¸€ç§æŠ½è±¡ï¼Œå®ƒå°†è®¾å¤‡çš„å°ºå¯¸åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li>Compactï¼ˆç´§å‡‘å‹ï¼‰</li><li>Regularï¼ˆå®½å¤§å‹ï¼‰</li><li>Anyï¼ˆä»»æ„ï¼Œå³compactæˆ–è€…Regularï¼‰</li></ul><p>è¿™ä¸‰ç§æŠ½è±¡å°ºå¯¸çš„ç»„åˆï¼Œå¯ä»¥æè¿°ä»»æ„ç±»å‹çš„è®¾å¤‡åŠå…¶æ¨ªç«–å±çŠ¶æ€ã€splitViewç­‰ï¼Œæ¯”å¦‚ï¼š<br><br/></p><p>ï¼ˆw<strong>R</strong> h<strong>R</strong>ï¼‰è¡¨ç¤ºæ¨ªç«–å±çŠ¶æ€ä¸‹å…¨å±çš„iPadï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_sizeclasses1.png" alt="sizeclass1"><br><img src="https://davidlii.nos-eastchina1.126.net/pic_sizeclasses2.png" alt="sizeclass2"></p><p>ï¼ˆw<strong>C</strong> h<strong>R</strong>ï¼‰è¡¨ç¤ºç«–å±çŠ¶æ€ä¸‹çš„iPhoneï¼Œæˆ–è€…iPadä¸Š 1&#x2F;3 çš„ splitViewï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_sizeclasses3.png" alt="sizeclass3"></p><p>ï¼ˆw<strong>C</strong> h<strong>C</strong>ï¼‰è¡¨ç¤ºæ¨ªå±çŠ¶æ€ä¸‹çš„é plus ç‰ˆiPhoneï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_sizeclasses4.png" alt="sizeclass4"></p><p>ï¼ˆw<strong>R</strong> h<strong>C</strong>ï¼‰è¡¨ç¤ºæ¨ªå±çŠ¶æ€ä¸‹çš„ plus ç‰ˆiPhoneï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_sizeclasses5.png" alt="sizeclass5"></p><p>éœ€è¦æ³¨æ„ï¼š<code>SizeClasses</code>åªæ˜¯å¯¹è®¾å¤‡å°ºå¯¸çš„æŠ½è±¡ï¼ŒçœŸæ­£çš„å¸ƒå±€è¿˜éœ€è¦ä¾èµ–å¹¶å¼€å¯<code>AutoLayout</code>ã€‚</p><h2 id="4-å¸ƒå±€æ¥å£"><a href="#4-å¸ƒå±€æ¥å£" class="headerlink" title="#4.å¸ƒå±€æ¥å£"></a>#4.å¸ƒå±€æ¥å£</h2><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (void)layoutSubviews<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>ç³»ç»Ÿä¼šåœ¨è§†å›¾éœ€è¦é‡æ–°è®¡ç®—å…¶<code>frame</code>æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œè¿™äº›æƒ…å†µåŒ…æ‹¬ï¼š</p><ul><li>æ”¹å˜äº†è§†å›¾çš„ frameï¼›</li><li>æ›´æ–°äº†è§†å›¾çš„çº¦æŸï¼›</li><li>æ”¹å˜äº†è§†å›¾å±‚çº§ï¼Œå¦‚æ–°å¢å­è§†å›¾ï¼›</li><li>å±å¹•æ—‹è½¬äº†ï¼›</li></ul><p>ä½ ä¹Ÿå¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼Œä»¥ä¾¿è‡ªå®šä¹‰è§†å›¾åŠå…¶å­è§†å›¾çš„å¸ƒå±€ä¿¡æ¯ã€‚<br><br/></p><p>æ­¤æ–¹æ³•ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ï¼Œä¸å»ºè®®æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨ã€‚çœŸæœ‰éœ€è¦æ—¶ä½¿ç”¨ [view layoutIfNeeded] æ¥è®©ç³»ç»Ÿè‡ªåŠ¨è§¦å‘æ­¤æ–¹æ³•ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (void)layoutIfNeeded<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å‘Šè¯‰å¸ƒå±€ç³»ç»Ÿ<code>ç«‹å³</code>æ›´æ–°å¸ƒå±€ã€‚æ¯”å¦‚ä½ æ›´æ–°äº†çº¦æŸå¹¶æƒ³ç«‹åˆ»å¼€å§‹ä½ç§»åŠ¨ç”»æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨æ­¤æ–¹æ³•å³å¯ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (void)setNeedsLayout<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å°†è§†å›¾æ ‡è®°ä¸ºéœ€è¦æ›´æ–°å¸ƒå±€ï¼Œä½†ä¸ä¼šç«‹é©¬è¿›è¡Œï¼Œè€Œæ˜¯åœ¨ä¸‹ä¸€ä¸ª update cycle ä¸­è¿›è¡Œã€‚</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">- (<span class="hljs-type">void</span>)drawRect:(CGRect)rect;<br></code></pre></td></tr></table></figure><p>è‹¥éœ€è¦åœ¨å½“å‰è§†å›¾ä¸Šç»˜åˆ¶è‡ªå®šä¹‰çš„å†…å®¹ï¼Œåˆ™é‡å†™æ­¤æ–¹æ³•ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">-  void)setNeedsDisplay<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å°†è§†å›¾æ ‡è®°ä¸ºéœ€è¦é‡ç»˜ï¼Œå…¶å®è´¨æ˜¯ layer çš„é‡ç»˜ï¼Œæœ€ç»ˆä¼šè§¦å‘-drawRect:æ–¹æ³•ã€‚</p><h2 id="5-çº¦æŸçš„å±æ€§-amp-æ¥å£"><a href="#5-çº¦æŸçš„å±æ€§-amp-æ¥å£" class="headerlink" title="#5.çº¦æŸçš„å±æ€§&amp;æ¥å£"></a>#5.çº¦æŸçš„å±æ€§&amp;æ¥å£</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-comment">/* By default, the autoresizing mask on a view gives rise to </span><br><span class="hljs-comment">constraints that fully determine the view&#x27;s position. </span><br><span class="hljs-comment">This allows the auto layout system to track the frames of views </span><br><span class="hljs-comment">whose layout is controlled manually (through -setFrame:, for example).</span><br><span class="hljs-comment">When you elect to position the view using auto layout by </span><br><span class="hljs-comment">adding your own constraints, you must set this property to NO. </span><br><span class="hljs-comment">IB will do this for you.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">BOOL</span> translatesAutoresizingMaskIntoConstraints; <span class="hljs-comment">// Default YES</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯<code>Autoresizing</code>æ—¶ä»£çš„äº§ç‰©ï¼Œä½¿ç”¨ IB åˆ›å»ºè§†å›¾æ—¶ï¼Œæ­¤å±æ€§é»˜è®¤ä¸º NOï¼›çº¯ä»£ç æ·»åŠ è§†å›¾æ—¶ï¼Œå…¶é»˜è®¤å€¼ä¸º YESã€‚å½“æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ å’Œä¿®æ”¹çº¦æŸæ—¶ï¼Œéœ€è¦å°†æ­¤å±æ€§ç½®ä¸º NOã€‚å› ä¸ºè§†å›¾çš„ AutoresizingMask ä¼šè¢«è½¬æ¢æˆå¯¹åº”æ•ˆæœçš„çº¦æŸã€‚è¿™æ ·å¾ˆå¯èƒ½ä¸æˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ çš„å…¶å®ƒçº¦æŸæœ‰å†²çªã€‚æ­¤å±æ€§è®¾ç½®æˆ NO æ—¶ï¼ŒAutoresizingMask å°±ä¸ä¼šå˜æˆçº¦æŸï¼Œå³å½“å‰è§†å›¾çš„ AutoresizingMask å¤±æ•ˆäº†ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (BOOL)needsUpdateConstraints<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>â€œConstraint-based layout systemâ€ ä½¿ç”¨æ­¤è¿”å›å€¼å»å†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨ updateConstraints ä½œä¸ºæ­£å¸¸å¸ƒå±€è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (void)updateConstraints<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>ç³»ç»Ÿæ›´æ–°çº¦æŸï¼Œè‡ªå®šä¹‰ view æ—¶å¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼Œåœ¨å…¶ä¸­æ·»åŠ  view éœ€è¦çš„å±€éƒ¨ contraintsã€‚æ³¨æ„ï¼šè¦åœ¨å®ç°åœ¨æœ€åè°ƒç”¨ [super updateConstraints]ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (void)updateConstraintsIfNeeded<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>ç«‹å³è§¦å‘çº¦æŸæ›´æ–°ï¼Œè‡ªåŠ¨æ›´æ–°å¸ƒå±€ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (void)setNeedsUpdateConstraints<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å½“æœ‰çº¦æŸéœ€è¦æ›´æ–°æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æ¥æ ‡è®°è¿™äº›çº¦æŸéœ€è¦åœ¨æœªæ¥çš„æŸä¸ªç‚¹æ›´æ–°ï¼Œç³»ç»Ÿä¹‹åè°ƒç”¨ updateConstraintsã€‚</p><h2 id="6-è‡ªåŠ¨å¸ƒå±€è¿‡ç¨‹"><a href="#6-è‡ªåŠ¨å¸ƒå±€è¿‡ç¨‹" class="headerlink" title="#6.è‡ªåŠ¨å¸ƒå±€è¿‡ç¨‹"></a>#6.è‡ªåŠ¨å¸ƒå±€è¿‡ç¨‹</h2><p><code>updating constraints</code> -&gt; <code>layout</code> -&gt; <code>display</code>ï¼Œæ¯ä¸€ä¸ªæ­¥éª¤éƒ½ä¾èµ–äºä¸Šä¸€æ­¥ã€‚</p><ul><li>updating constraints</li></ul><p>ä»ä¸‹å‘ä¸Šï¼ˆfrom subview to superviewï¼‰ï¼Œä¸ºä¸‹ä¸€æ­¥å‡†å¤‡ä¿¡æ¯ã€‚å¯ä»¥è°ƒç”¨ setNeedUpdateConstraints è§¦å‘æ­¤æ­¥ã€‚constraints çš„æ”¹å˜ä¹Ÿä¼šè§¦å‘æ­¤æ­¥ã€‚ä½†æ˜¯å½“ä½ è‡ªå®šä¹‰è§†å›¾æ—¶ï¼Œè‹¥ä¸€äº›æ”¹å˜å¯èƒ½ä¼šå½±å“åˆ°å¸ƒå±€æ—¶ï¼Œéœ€è¦è‡ªå·±å»è°ƒç”¨ updateConstraintsIfNeeded ä»¥é€šçŸ¥è‡ªåŠ¨å¸ƒå±€æ›´æ–°çº¦æŸã€‚</p><ul><li>layout</li></ul><p>ä»ä¸Šå‘ä¸‹ï¼ˆfrom superview to subviewï¼‰ï¼Œæ­¤æ­¥ä¸»è¦åº”ç”¨ä¸Šä¸€æ­¥çš„ä¿¡æ¯å»è®¾ç½®è§†å›¾çš„ center å’Œ boundsã€‚å¯ä»¥é€šè¿‡è°ƒç”¨ setNeedsLayout å»è§¦å‘æ­¤æ­¥éª¤ï¼Œæ­¤æ–¹æ³•ä¸ä¼šç«‹å³åº”ç”¨ layoutã€‚å¦‚æœæƒ³è¦ç³»ç»Ÿç«‹å³çš„æ›´æ–° layoutï¼Œå¯ä»¥è°ƒç”¨ layoutIfNeededã€‚å¦å¤–è‡ªå®šä¹‰è§†å›¾æ—¶å¯ä»¥é‡å†™ layoutSubViews æ–¹æ³•æ¥å¾—åˆ°æ›´å¤šçš„å®šåˆ¶åŒ–æ•ˆæœã€‚</p><ul><li>display</li></ul><p>ä»ä¸Šå‘ä¸‹ï¼ˆfrom superview to subviewï¼‰ã€‚æ­¤æ­¥æ˜¯æŠŠè§†å›¾æ¸²æŸ“åˆ°å±å¹•ä¸Šï¼Œå®ƒä¸ä½ æ˜¯å¦ä½¿ç”¨ Auto layout æ— å…³ï¼Œé€šè¿‡è°ƒç”¨ setNeedsDisplay è§¦å‘ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ UIView çš„ drawRect æ–¹æ³•ã€‚</p><h2 id="7-VCä¸­è§†å›¾çš„å¸ƒå±€è¿‡ç¨‹"><a href="#7-VCä¸­è§†å›¾çš„å¸ƒå±€è¿‡ç¨‹" class="headerlink" title="#7.VCä¸­è§†å›¾çš„å¸ƒå±€è¿‡ç¨‹"></a>#7.VCä¸­è§†å›¾çš„å¸ƒå±€è¿‡ç¨‹</h2><ul><li>-loadView</li><li>viewDidLoad</li><li>viewWillAppear</li><li>updateViewConstraints</li><li>viewWillLayoutSubviews</li><li>viewDidLayoutSubviews</li><li>viewDidAppear</li><li>viewWillDisAppear</li><li>viewDidDisAppear</li></ul><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">/* Base implementation sends -updateConstraints to the view.</span><br><span class="hljs-comment">When a view has a view controller, this message is sent </span><br><span class="hljs-comment">to the view controller during the autolayout updateConstraints </span><br><span class="hljs-comment">pass in lieu of sending updateConstraints directly to the view.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">You may override this method in a UIViewController subclass for </span><br><span class="hljs-comment">updating custom constraints instead of subclassing your view </span><br><span class="hljs-comment">and overriding -[UIView updateConstraints].</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Overrides must call super or send -updateConstraints to the view.</span><br><span class="hljs-comment">*/</span><br>- (<span class="hljs-keyword">void</span>)updateViewConstraints;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œè¿™ä¸ª<code>-updateViewConstraints</code>æ–¹æ³•æ˜¯ UIViewController ä¸­çš„ï¼Œä¸æ˜¯ UIView ä¸­çš„<code>-updateConstraints</code>æ–¹æ³•ã€‚ã€‚â€œview å±äºæŸä¸ª VCâ€ï¼ˆæ¯”å¦‚ self.viewï¼‰ï¼Œå½“æ­¤ view éœ€è¦æ‰§è¡Œ<code>updateConstraints</code>æ—¶ï¼Œä¼šè°ƒç”¨ VC çš„<code>updateViewConstraints</code>ï¼Œè¿™æ ·å°±ä¸ç”¨ä½ å†è‡ªå®šä¹‰æ­¤ view å¹¶é‡å†™å…¶<code>updateConstraints</code>æ–¹æ³•äº†ã€‚æ–¹æ³•ä¸­éœ€è¦è°ƒç”¨å…¶ super æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯è°ƒç”¨å…¶æ‰€æœ‰ subview çš„ updateConstraints æ–¹æ³•ï¼Œè¿™æ ·å°±è‡ªä¸Šè€Œä¸‹çš„å®Œæˆäº†å¸ƒå±€ã€‚<br><br/></p><p>å¦å¤–ï¼ŒupdateViewConstraintsã€viewWillLayoutSubviewsã€viewDidLayoutSubviews åœ¨å½“å‰ vc å¸ƒå±€è¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•åœ¨ç¦»å¼€å½“å‰æ§åˆ¶å™¨æ—¶ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚</p><h2 id="8-å°ç»“"><a href="#8-å°ç»“" class="headerlink" title="#8.å°ç»“"></a>#8.å°ç»“</h2><p>é™¤äº†<code>self.view</code>å¤–ï¼Œå…¶ä»–è§†å›¾çš„å®é™… frame è¦åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•æ‰§è¡Œå®Œä¹‹åæ‰èƒ½ç¡®å®šï¼š</p><ul><li>view çš„ layoutSubViews;</li><li>VC çš„ viewDidLayoutSubviews;</li></ul><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬çœŸçš„éœ€è¦ frame æ—¶è¦åœ¨è¿™ä¸ªä¸¤ä¸ªæ—¶é—´ç‚¹ä»¥åå†å»è·å–ã€‚è¿™å°±æ˜¯ viewDidLoad é‡Œé€šè¿‡<code>setFrame</code>çš„æ–¹å¼ä¿®æ”¹åŸå…ˆåœ¨xibé‡Œæ‹–åŠ¨çš„çº¦æŸä»£ç æ— æ•ˆçš„ç—‡ç»“æ‰€åœ¨ã€‚å› ä¸º updateViewConstraints åœ¨ viewDidLoad åæ‰§è¡Œï¼Œä¼šè¦†ç›–æ‰ä¹‹å‰çš„è®¾ç½®çš„frameï¼Œæ‰€ä»¥æ— æ•ˆã€‚<br><br/></p><p>å¦å¤–éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼šåœ¨ä½¿ç”¨ sb æˆ–è€… xib åŠ è½½ VC æ—¶ï¼ŒviewDidLoad ä¸­åªæœ‰ self.view çš„ frame ä¿¡æ¯æ˜¯å‡†ç¡®çš„ï¼Œå…¶ä»–æ‰€æœ‰çš„æ§ä»¶çš„ frame éƒ½æ˜¯å®ƒä»¬åœ¨ sb æˆ– xib ä¸­çš„åŸå§‹å°ºå¯¸ï¼Œä¸å½“å‰è®¾å¤‡å¯èƒ½ä¸ç¬¦ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://blog.csdn.net/zpz5789/article/details/50922469">Â©zpz5789-Updating constraintsã€Layout</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å­—ç¬¦ä¸²å±æ€§çš„ä¿®é¥°ç¬¦</title>
    <link href="/2018/06/15/str-modifier.html"/>
    <url>/2018/06/15/str-modifier.html</url>
    
    <content type="html"><![CDATA[<p>æ—¥å¸¸å®è·µä¸­ï¼Œæˆ‘ä»¬ç»å¸¸è¦å£°æ˜ä¸€äº›å­—ç¬¦ä¸²å±æ€§ï¼ŒåŒ…æ‹¬<code>NSString</code>å’Œ<code>NSMutableString</code>ï¼Œè€Œå­—ç¬¦ä¸²æœ€å¸¸ç”¨çš„ä¿®é¥°ç¬¦å°±è¦æ•°<code>strong</code>å’Œ<code>copy</code>äº†ã€‚è¿™ä¸¤ä¸ªä¿®é¥°ç¬¦å¯¹å­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿ</p><h4 id="1-ä¸å¯å˜æºå­—ç¬¦ä¸²"><a href="#1-ä¸å¯å˜æºå­—ç¬¦ä¸²" class="headerlink" title="1.ä¸å¯å˜æºå­—ç¬¦ä¸²"></a>1.ä¸å¯å˜æºå­—ç¬¦ä¸²</h4><p>#ç¤ºä¾‹1ï¼šç”¨ NSString èµ‹å€¼</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSString</span> *aStrongStr;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *aCopyStr;<br><span class="hljs-keyword">@end</span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//ç”¨ NSString èµ‹å€¼</span><br>    <span class="hljs-built_in">NSString</span> *oriStr = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;A&quot;</span>];<br>    <br>    <span class="hljs-keyword">self</span>.aStrongStr = oriStr;<br>    <span class="hljs-keyword">self</span>.aCopyStr = oriStr;<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++oriStr:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,oriStr,&amp;oriStr,oriStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Strong:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aStrongStr,&amp;_aStrongStr,_aStrongStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Copy:    å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aCopyStr,&amp;_aCopyStr,_aCopyStr);<br><br>    <span class="hljs-comment">//æ”¹å˜ oriStr çš„æŒ‡é’ˆ</span><br>    oriStr = <span class="hljs-string">@&quot;B&quot;</span>;<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++oriStr1:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,oriStr,&amp;oriStr,oriStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Strong1:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aStrongStr,&amp;_aStrongStr,_aStrongStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Copy1:    å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aCopyStr,&amp;_aCopyStr,_aCopyStr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">++oriStr:  å€¼åœ°å€:<span class="hljs-number">0xcee763de400efcf2</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x7ffeea6357e8</span>,  å€¼:A<br>++Strong:  å€¼åœ°å€:<span class="hljs-number">0xcee763de400efcf2</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x600003c7ff28</span>,  å€¼:A<br>++Copy:    å€¼åœ°å€:<span class="hljs-number">0xcee763de400efcf2</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x600003c7ff30</span>,  å€¼:A<br>++oriStr1:  å€¼åœ°å€:<span class="hljs-number">0x1055d67d0</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x7ffeea6357e8</span>,  å€¼:B<br>++Strong1:  å€¼åœ°å€:<span class="hljs-number">0xcee763de400efcf2</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x600003c7ff28</span>,  å€¼:A<br>++Copy1:    å€¼åœ°å€:<span class="hljs-number">0xcee763de400efcf2</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x600003c7ff30</span>,  å€¼:A<br></code></pre></td></tr></table></figure><p>å½“ä½¿ç”¨ NSString ç±»å‹çš„<code>oriStr</code>ç»™<code>strong</code>å’Œ<code>copy</code>ä¿®é¥°çš„å­—ç¬¦ä¸²å¯¹è±¡èµ‹å€¼æ—¶ï¼Œä¸¤ä¸ªå¯¹è±¡å†…ä¿å­˜çš„æ˜¯å­—ç¬¦ä¸²<code>oriStr</code>å€¼å¯¹è±¡<code>A</code>çš„åœ°å€æŒ‡é’ˆã€‚å› ä¸º<code>oriStr</code>æ˜¯ä¸å¯å˜å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥åªèƒ½ä¿®æ”¹<code>oriStr</code>çš„æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æ–°çš„å€¼<code>B</code>æ—¶ï¼Œæ­¤æ—¶<code>strong</code>ä¸<code>copy</code>çš„å¯¹è±¡å†…ä¿å­˜çš„æŒ‡é’ˆå¹¶æ²¡å˜ï¼Œè¿˜æ˜¯æŒ‡å‘å€¼åŸå€¼å¯¹è±¡<code>A</code>çš„åœ°å€ã€‚æ‰€ä»¥<code>oriStr</code>æŒ‡é’ˆçš„æ–°å˜åŒ–ä¸ä¼šå½±å“å‰ä¸¤è€…å†…çš„æŒ‡é’ˆã€‚</p><h4 id="2-å¯å˜æºå­—ç¬¦ä¸²"><a href="#2-å¯å˜æºå­—ç¬¦ä¸²" class="headerlink" title="2.å¯å˜æºå­—ç¬¦ä¸²"></a>2.å¯å˜æºå­—ç¬¦ä¸²</h4><p>#ç¤ºä¾‹2ï¼šç”¨ NSMutableString èµ‹å€¼</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSString</span> *aStrongStr;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *aCopyStr;<br><span class="hljs-keyword">@end</span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//ç”¨ NSMutableString èµ‹å€¼</span><br>    <span class="hljs-built_in">NSMutableString</span> *oriStr = [<span class="hljs-built_in">NSMutableString</span> stringWithFormat:<span class="hljs-string">@&quot;A&quot;</span>];<br>    <br>    <span class="hljs-keyword">self</span>.aStrongStr = oriStr;<br>    <span class="hljs-keyword">self</span>.aCopyStr = oriStr;<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++oriStr:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,oriStr,&amp;oriStr,oriStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Strong:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aStrongStr,&amp;_aStrongStr,_aStrongStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Copy:    å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aCopyStr,&amp;_aCopyStr,_aCopyStr);<br>    <br>    <span class="hljs-comment">//æ”¹å˜ oriStr çš„å€¼(æ³¨æ„ï¼Œä¸æ˜¯æ”¹å˜æŒ‡é’ˆ)</span><br>    [oriStr setString:<span class="hljs-string">@&quot;B&quot;</span>];<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++oriStr1:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,oriStr,&amp;oriStr,oriStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Strong1:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aStrongStr,&amp;_aStrongStr,_aStrongStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Copy1:    å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aCopyStr,&amp;_aCopyStr,_aCopyStr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">++oriStr:  å€¼åœ°å€:<span class="hljs-number">0</span>x6000<span class="hljs-number">02b960a0</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0</span>x7ffee<span class="hljs-number">292d7e8</span>,  å€¼:<span class="hljs-keyword">A</span><br>++Strong:  å€¼åœ°å€:<span class="hljs-number">0</span>x6000<span class="hljs-number">02b960a0</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0</span>x60<span class="hljs-number">00025f6c08</span>,  å€¼:<span class="hljs-keyword">A</span><br>++Copy:    å€¼åœ°å€:<span class="hljs-number">0</span>xfac5ab<span class="hljs-number">7f38f70e39</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0</span>x60<span class="hljs-number">00025f6c10</span>,  å€¼:<span class="hljs-keyword">A</span><br>++oriStr1:  å€¼åœ°å€:<span class="hljs-number">0</span>x6000<span class="hljs-number">02b960a0</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0</span>x7ffee<span class="hljs-number">292d7e8</span>,  å€¼:B<br>++Strong1:  å€¼åœ°å€:<span class="hljs-number">0</span>x6000<span class="hljs-number">02b960a0</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0</span>x60<span class="hljs-number">00025f6c08</span>,  å€¼:B<br>++Copy1:    å€¼åœ°å€:<span class="hljs-number">0</span>xfac5ab<span class="hljs-number">7f38f70e39</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0</span>x60<span class="hljs-number">00025f6c10</span>,  å€¼:<span class="hljs-keyword">A</span><br></code></pre></td></tr></table></figure><p>å½“ä½¿ç”¨ NSMutableString ç±»å‹çš„<code>oriStr</code>ç»™<code>strong</code>ç±»å‹çš„å­—ç¬¦ä¸²èµ‹å€¼æ—¶ï¼Œ<code>_aStrongStr</code>å¯¹<code>oriStr</code>çš„å€¼å¯¹è±¡<code>A</code>çš„åœ°å€è¿›è¡Œäº†æŒ‡é’ˆæ‹·è´ï¼ŒäºŒè€…å€¼ç›¸ç­‰ã€‚å½“<code>oriStr</code>å€¼å¯¹è±¡çš„æŒ‡é’ˆæœªå˜ä½†å€¼å˜æˆ<code>B</code>æ—¶ï¼Œ<code>_aStrongStr</code>ä¸­å€¼å¯¹è±¡æŒ‡é’ˆè·Ÿ<code>oriStr</code>ä¸€æ ·ä¹Ÿæ²¡å˜ï¼Œæ‰€ä»¥å…¶å€¼ä¹Ÿä¼šå˜æˆ<code>B</code>ã€‚</p><p>å½“ä½¿ç”¨ NSMutableString ç±»å‹çš„<code>oriStr</code>ç»™<code>copy</code>ç±»å‹çš„å­—ç¬¦ä¸²èµ‹å€¼æ—¶ï¼Œ<code>_aCopyStr</code>å¯¹<code>oriStr</code>çš„å€¼å¯¹è±¡è¿›è¡Œäº†æ·±æ‹·è´ï¼ŒäºŒè€…æŒ‡å‘äº†ä¸åŒçš„å¯¹è±¡ã€‚å½“<code>oriStr</code>çš„å€¼å˜åŒ–æ—¶ï¼Œ<code>_aCopyStr</code>çš„å€¼å¹¶æœªè·Ÿç€å˜åŒ–è€Œæ˜¯ä¿æŒä¸å˜ã€‚</p><h4 id="3-å°ç»“"><a href="#3-å°ç»“" class="headerlink" title="3.å°ç»“"></a>3.å°ç»“</h4><p>1ã€å½“æºå­—ç¬¦ä¸²ä¸º<code>NSString</code>ç±»å‹ï¼Œç»™<code>strong</code>å’Œ<code>copy</code>ä¿®é¥°çš„å±æ€§èµ‹å€¼æ—¶ï¼Œæ•ˆæœä¸€æ ·ï¼Œéƒ½æ˜¯æµ…æ‹·è´ï¼Œå¾—åˆ°çš„ä¸¤ä¸ªå¯¹è±¡éƒ½ä¸æºå­—ç¬¦ä¸²çš„å€¼ç›¸åŒã€‚åŒæ—¶ï¼Œç”±äºæºå­—ç¬¦ä¸²ä¸å¯å˜ï¼Œå¦‚æœæƒ³ä¿®æ”¹è¿™ä¸¤ä¸ªå¯¹è±¡çš„å€¼ï¼Œå¯ä»¥å°†äºŒè€…æŒ‡å‘æ–°çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæˆ–ç›´æ¥ç”¨å­—ç¬¦ä¸²å­—é¢é‡èµ‹å€¼ã€‚<br><br/></p><p>2ã€å½“æºå­—ç¬¦ä¸²ä¸º<code>NSMutableString</code>ç±»å‹ï¼Œç»™<code>strong</code>ä¿®é¥°çš„å±æ€§èµ‹å€¼æ—¶ï¼Œä¹Ÿæ˜¯æµ…æ‹·è´ï¼Œä½†è¦æ³¨æ„ï¼Œç”±äºæºå­—ç¬¦ä¸²æ˜¯å¯å˜çš„ï¼Œæ‰€ä»¥æºå­—ç¬¦ä¸²çš„å˜åŒ–ä¼šå½±å“åˆ°<code>strong</code>ä¿®é¥°çš„å±æ€§åŠå…¶å¯¹åº”çš„æˆå‘˜å˜é‡ã€‚<br><br/></p><p>3ã€å½“æºå­—ç¬¦ä¸²ä¸º<code>NSMutableString</code>ç±»å‹ï¼Œä½¿ç”¨<code>copy</code>ä¿®é¥°çš„å±æ€§èµ‹å€¼æ—¶ï¼Œæ˜¯æ·±æ‹·è´ï¼Œæ–°å¯¹è±¡çš„å€¼ä¸æºå­—ç¬¦ä¸²çš„å€¼ç›¸åŒï¼Œä½†äºŒè€…çš„æŒ‡é’ˆä¸åŒï¼Œä¸ä¼šç›¸äº’å½±å“ã€‚</p><hr><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å±æ€§å¹¶ç»™å…¶èµ‹å€¼æ—¶ï¼Œå¹¶ä¸å¸Œæœ›æºå­—ç¬¦ä¸²åç»­çš„ä¿®æ”¹ä¼šå½±å“åˆ°æˆ‘ä»¬çš„å­—ç¬¦ä¸²å±æ€§ï¼Œæ‰€ä»¥ï¼Œ<strong>ç»¼åˆèµ·æ¥è¿˜æ˜¯ä½¿ç”¨<code>copy</code>ç¨³å¦¥</strong>ã€‚è¿™æ ·ï¼Œå¦‚æœæºå­—ç¬¦ä¸²ä¸º<code>NSString</code>ç±»å‹ï¼Œå…¶å†…å®¹ä¸å¯å˜ï¼Œæ‰€ä»¥ä¸å­˜åœ¨åç»­å½±å“ï¼›å¦‚æœæºå­—ç¬¦ä¸²ä¸º<code>NSMutableString</code>ç±»å‹ï¼Œå› ä¸º<code>copy</code>ä¼šåšæ·±æ‹·è´ï¼Œæ‰€ä»¥ä¹Ÿä¸å­˜åœ¨åç»­å½±å“çš„é—®é¢˜ã€‚</p><h4 id="4-ç»™å±æ€§æˆå‘˜å˜é‡çš„èµ‹å€¼"><a href="#4-ç»™å±æ€§æˆå‘˜å˜é‡çš„èµ‹å€¼" class="headerlink" title="4.ç»™å±æ€§æˆå‘˜å˜é‡çš„èµ‹å€¼"></a>4.ç»™å±æ€§æˆå‘˜å˜é‡çš„èµ‹å€¼</h4><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåœ¨ç»™å±æ€§èµ‹å€¼æ—¶ï¼Œä½¿ç”¨çš„éƒ½æ˜¯<code>self.å±æ€§ = xx</code>æ ¼å¼ï¼Œè€Œç›´æ¥ç»™å±æ€§çš„æˆå‘˜å˜é‡èµ‹å€¼æ—¶ï¼Œå³<code>_å±æ€§å = xx</code>ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSString</span> *aStrongStr;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *aCopyStr;<br><span class="hljs-keyword">@end</span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//ç”¨ NSMutableString èµ‹å€¼</span><br>    <span class="hljs-built_in">NSMutableString</span> *oriStr = [<span class="hljs-built_in">NSMutableString</span> stringWithFormat:<span class="hljs-string">@&quot;A&quot;</span>];<br>    <br>    <span class="hljs-comment">//æ³¨æ„è¿™é‡Œæ˜¯ç»™å±æ€§å¯¹åº”çš„æˆå‘˜å˜é‡èµ‹å€¼</span><br>    _aStrongStr = oriStr;<br>    _aCopyStr = oriStr;<br>    [oriStr setString:<span class="hljs-string">@&quot;B&quot;</span>];<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++oriStr:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,oriStr,&amp;oriStr,oriStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Strong:  å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aStrongStr,&amp;_aStrongStr,_aStrongStr);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Copy:    å€¼åœ°å€:%p,  å¯¹è±¡åœ°å€:%p,  å€¼:%@&quot;</span>,_aCopyStr,&amp;_aCopyStr,_aCopyStr);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">++oriStr:  å€¼åœ°å€:<span class="hljs-number">0x60000101a760</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x7ffee854ed68</span>,  å€¼:B<br>++Strong:  å€¼åœ°å€:<span class="hljs-number">0x60000101a760</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x60000101e148</span>,  å€¼:B<br>++Copy:    å€¼åœ°å€:<span class="hljs-number">0x60000101a760</span>,  å¯¹è±¡åœ°å€:<span class="hljs-number">0x60000101e150</span>,  å€¼:B<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­æ˜¯ç»™å±æ€§å¯¹åº”çš„<code>æˆå‘˜å˜é‡</code>èµ‹å€¼çš„ï¼è™½ç„¶æºå­—ç¬¦ä¸²è¿˜æ˜¯<code>NSMutableString</code>ç±»å‹ï¼Œä½†ä»æ‰“å°çš„æ—¥å¿—æ¥çœ‹ï¼Œ<code>copy</code>ä¿®é¥°çš„å±æ€§å¹¶æœªåšæ·±æ‹·è´ï¼Œä¸”å®ƒçš„å€¼å§‹ç»ˆå—åˆ°æºå­—ç¬¦ä¸²å˜åŒ–çš„å½±å“ã€‚è¿™æ˜¯å› ä¸ºï¼Œä»¥ä¸‹åˆ’çº¿å¼€å¤´çš„æˆå‘˜å˜é‡æ˜¯ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ çš„ï¼Œç»™å…¶èµ‹å€¼æ—¶ï¼Œå¹¶ä¸ä¼šè§¦å‘å±æ€§çš„ setterï¼Œä¹Ÿå°±æ²¡æœ‰é»˜è®¤çš„<code>copy</code>æ“ä½œï¼Œå› æ­¤ä¹Ÿå°±ä¸ä¼šæœ‰<code>copy</code>æ•ˆæœ~</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å†…å­˜ç®¡ç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‹·è´ç›¸å…³çŸ¥è¯†ç‚¹</title>
    <link href="/2018/06/14/copy.html"/>
    <url>/2018/06/14/copy.html</url>
    
    <content type="html"><![CDATA[<h2 id="1-æ‹·è´-åˆæ¢"><a href="#1-æ‹·è´-åˆæ¢" class="headerlink" title="1.æ‹·è´-åˆæ¢"></a>1.æ‹·è´-åˆæ¢</h2><blockquote><p>The exact meaning of â€œcopyâ€ can vary from class to class, but a copy must be a functionally independent object with values identical to the original at the time the copy was made.</p></blockquote><p>ä¸Šé¢çš„æ‘˜è¦æè¿°äº†<code>æ‹·è´</code>çš„ä¸‰ä¸ªåŸºæœ¬ç‰¹å¾ï¼š</p><ul><li>åœ¨ä¸åŒçš„ç±»ä¸­æœ‰ä¸åŒçš„çš„å…·ä½“å«ä¹‰ï¼›</li></ul><p>æ‹·è´å¯ä»¥ä½œç”¨äºä¸åŒçš„å¯¹è±¡ä¸Šï¼Œæ¯”å¦‚å€¼ç±»å‹å’ŒæŒ‡é’ˆç±»å‹ã€å­—ç¬¦ä¸²å’Œé›†åˆã€å¯å˜å¯¹è±¡å’Œä¸å¯å˜å¯¹è±¡ç­‰ã€‚å¯¹äºä¸åŒçš„å¯¹è±¡ï¼Œæ‹·è´æœ‰ç€ä¸åŒçš„æ„ä¹‰å’Œæ•ˆæœï¼Œåé¢ä¼šç»§ç»­ä»‹ç»ã€‚</p><ul><li>æ¯ä¸€ä»½æ‹·è´éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼›</li></ul><p>ä¸€ä¸ªå€¼ç±»å‹å¯¹è±¡è¢«ä½œä¸ºæ–¹æ³•çš„å‚æ•°ä¼ é€’æˆ–è€…ä½œä¸ºè¿”å›å€¼æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„æ˜¯å®ƒçš„æ‹·è´ï¼Œè€Œä¸æ˜¯å®ƒæœ¬èº«ã€‚æ¯”å¦‚ä¸‹é¢çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªå­—ç¬¦ä¸²èµ‹å€¼ç»™å¯¹è±¡çš„<code>name</code>å®ä¾‹å˜é‡ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">- (<span class="hljs-type">void</span>)setName:(NSString *)aName<br>&#123;<br>    [<span class="hljs-type">name</span> autorelease];<br>    <span class="hljs-type">name</span> = [aName <span class="hljs-keyword">copy</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿å­˜<code>aName</code>çš„æ‹·è´äº§ç”Ÿçš„æ•ˆæœå°±æ˜¯ï¼šäº§ç”Ÿäº†ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œå¯¹è±¡çš„å€¼ä¸åŸå¯¹è±¡ä¸€è‡´ã€‚åç»­å¯¹åŸå¯¹è±¡çš„æ“ä½œä¸ä¼šå½±å“åˆ°æ–°å¯¹è±¡ï¼Œå¯¹æ–°å¯¹è±¡çš„æ“ä½œä¹Ÿä¸ä¼šå½±å“åˆ°åŸå¯¹è±¡ã€‚å†æ¯”å¦‚ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šåœ¨ä¸€ä¸ªæ–¹æ³•ä¸­è¿”å›æŸä¸ªå¯¹è±¡çš„æ‹·è´ï¼Œè€Œä¸æ˜¯å¯¹è±¡æœ¬èº«ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">- (NSString *)<span class="hljs-type">name</span><br>&#123;<br>    <span class="hljs-keyword">return</span> [[<span class="hljs-type">name</span> <span class="hljs-keyword">copy</span>] autorelease];<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ<code>name</code>çš„ getter è¿”å›çš„å°±æ˜¯<code>name</code>çš„ä¸€ä»½æ‹·è´~</p><ul><li>æ‹·è´çš„å€¼ä¸å‘ç”Ÿæ‹·è´æ—¶çš„åŸå¯¹è±¡çš„å€¼ä¿æŒä¸€è‡´ã€‚</li></ul><p>ä¸Šé¢è¯´äº†ï¼Œæ‹·è´ä¹‹åï¼ŒåŸå¯¹è±¡ä¸æ–°å¯¹è±¡ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ã€‚æ–°å¯¹è±¡çš„å€¼ä¸å‘ç”Ÿæ‹·è´æ—¶åŸå¯¹è±¡çš„å€¼ä¿æŒä¸€è‡´ï¼Œåç»­åŸå¯¹è±¡çš„å€¼æ€ä¹ˆå˜åŒ–ï¼Œå¹¶ä¸å½±å“æ–°å¯¹è±¡çš„å€¼ã€‚</p><h2 id="2-OCæ‹·è´åè®®"><a href="#2-OCæ‹·è´åè®®" class="headerlink" title="2.OCæ‹·è´åè®®"></a>2.OCæ‹·è´åè®®</h2><h3 id="2-1-æ‹·è´åè®®"><a href="#2-1-æ‹·è´åè®®" class="headerlink" title="2.1.æ‹·è´åè®®"></a>2.1.æ‹·è´åè®®</h3><p><code>NSObject.h</code>ä¸­å®šä¹‰äº†ä¸¤ä¸ªå…³äºæ‹·è´çš„å®ä¾‹æ–¹æ³•ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">- (<span class="hljs-built_in">id</span>)<span class="hljs-keyword">copy</span>;<br></code></pre></td></tr></table></figure><blockquote><p>The copy method is defined for all NSObjects and simply invokes copyWithZone: with the default zone.</p></blockquote><p><code>copy</code>æ–¹æ³•æ˜¯ä¸€ä¸ªä¾¿åˆ©æ–¹æ³•ï¼Œç”¨æ¥è°ƒç”¨<code>copyWithZone:</code>æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªä¸å¯å˜å¯¹è±¡ã€‚åè€…æ˜¯<code>NSCopying</code>åè®®çš„åè®®æ–¹æ³•ã€‚å¦‚æœä¸€ä¸ªç»§æ‰¿è‡ª NSObject çš„ç±»çš„å®ä¾‹å¯¹è±¡è¦è°ƒç”¨<code>copy</code>æ—¶ï¼Œé‚£ä¹ˆè¯¥ç±»å°±å¿…é¡»å®ç°æ­¤åè®®ï¼Œå¦åˆ™ä¼šæŠ¥å¼‚å¸¸ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (id)mutableCopy<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><blockquote><p>Convenience method for classes that adopt the NSMutableCopying protocol. This method just calls the NSMutableCopying protocol method mutableCopyWithZone: with the zone as NULL. An exception is raised if there is no implementation for mutableCopyWithZone:.</p></blockquote><p>ä¸<code>copy</code>ä¸€æ ·ï¼Œ<code>mutableCopy</code>ä¹Ÿæ˜¯ä¸€ä¸ªä¾¿åˆ©æ–¹æ³•ï¼Œç”¨æ¥è°ƒç”¨<code>NSMutableCopying</code>åè®®çš„åè®®æ–¹æ³•<code>mutableCopyWithZone:</code>ã€‚æ­¤æ–¹æ³•ä¸»è¦ç”¨æ¥è¿”å›ä¸€ä¸ªå¯å˜å¯¹è±¡ã€‚åŒæ ·çš„ï¼Œå¯¹è±¡éœ€è¦è°ƒç”¨<code>mutableCopy</code>æ—¶ï¼Œå…¶æ‰€å±ç±»å¿…é¡»å®ç°æ­¤åè®®ï¼Œå¹¶åœ¨åè®®æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªå¯å˜å¯¹è±¡ã€‚åªæœ‰é‚£äº›æœ‰å¯å˜å’Œä¸å¯å˜ä¹‹åˆ†çš„ç±»æ‰éœ€è¦å®ç°æ­¤åè®®ï¼Œå¦åˆ™åº”è¯¥å®ç°<code>NSCopying</code>åè®®ã€‚å¦‚æœæŸä¸ªç±»æ—¢æœ‰å¯å˜ç‰ˆæœ¬åˆæœ‰ä¸å¯å˜ç‰ˆæœ¬ï¼Œé‚£å°±éœ€è¦åŒæ—¶å®ç°è¿™ä¸¤ä¸ªåè®®ã€‚</p><h3 id="2-2-ç»§æ‰¿ä¸æ‹·è´åè®®"><a href="#2-2-ç»§æ‰¿ä¸æ‹·è´åè®®" class="headerlink" title="2.2.ç»§æ‰¿ä¸æ‹·è´åè®®"></a>2.2.ç»§æ‰¿ä¸æ‹·è´åè®®</h3><p>å‡è®¾æœ‰<code>A</code>ã€<code>B</code>ä¸¤ä¸ªç±»ï¼ŒB ç»§æ‰¿è‡ª Aï¼Œå¦‚æœ A ä¸­æ²¡æœ‰å®ç° NSCopying æˆ– NSMutableCopying åè®®ï¼Œè€Œ B å®ç°äº†ï¼Œé‚£ä¹ˆåœ¨ B ç±»çš„åè®®æ–¹æ³•ä¸­å°±æ—¢éœ€è¦æ‹·è´è‡ªå·±å£°æ˜çš„å±æ€§ï¼Œåˆéœ€è¦æ‹·è´ä»çˆ¶ç±»ç»§æ‰¿è€Œæ¥çš„å±æ€§ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//çˆ¶ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Model</span> : <span class="hljs-title">NSObject</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Model</span></span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">SubModel</span> : <span class="hljs-title">Model</span>&lt;<span class="hljs-title">NSCopying</span>&gt;</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *subName;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">SubModel</span></span><br><br>-(<span class="hljs-type">id</span>)copyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone<br>&#123;<br>    SubModel *newSubModel = [[[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>] alloc] init];<br>    newSubModel.name = [<span class="hljs-keyword">self</span>.name <span class="hljs-keyword">copy</span>];<span class="hljs-comment">//æ‹·è´çˆ¶ç±»å±æ€§</span><br>    newSubModel.subName = [<span class="hljs-keyword">self</span>.subName <span class="hljs-keyword">copy</span>];<span class="hljs-comment">//æ‹·è´å­ç±»å±æ€§</span><br>    <br>    <span class="hljs-keyword">return</span> newSubModel;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å¦‚æœ A ç±»ä¸­å®ç°äº†æ‹·è´åè®®ï¼Œé‚£ä¹ˆä½œä¸ºå­ç±»ï¼ŒB ä¼šç»§æ‰¿æ­¤åè®®ï¼Œæ‰€ä»¥ B åªéœ€åœ¨è‡ªå·±çš„ç±»ä¸­é‡å†™åè®®æ–¹æ³•ï¼Œè°ƒç”¨ super å®ç°çˆ¶ç±»å±æ€§çš„æ‹·è´ï¼Œå¹¶æ‹·è´è‡ªå·±ç±»ä¸­å£°æ˜çš„å±æ€§ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//çˆ¶ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Model</span> : <span class="hljs-title">NSObject</span>&lt;<span class="hljs-title">NSCopying</span>&gt;</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Model</span></span><br><br>-(<span class="hljs-type">id</span>)copyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone<br>&#123;<br>    Model *newModel = [[[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>] allocWithZone:zone] init];<br>    newModel.name = [<span class="hljs-keyword">self</span>.name <span class="hljs-keyword">copy</span>];<br>    <span class="hljs-keyword">return</span> newModel;<br>&#125;<br><br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">SubModel</span> : <span class="hljs-title">Model</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *subName;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">SubModel</span></span><br><br>-(<span class="hljs-type">id</span>)copyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone<br>&#123;<br>    SubModel *newSubModel = [<span class="hljs-variable language_">super</span> copyWithZone:zone];<span class="hljs-comment">//è°ƒç”¨super</span><br>    newSubModel.subName = [<span class="hljs-keyword">self</span>.subName <span class="hljs-keyword">copy</span>];<span class="hljs-comment">//æ‹·è´å­ç±»å±æ€§</span><br>    <br>    <span class="hljs-keyword">return</span> newSubModel;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-å¯-x2F-ä¸å¯å˜å¯¹è±¡"><a href="#2-3-å¯-x2F-ä¸å¯å˜å¯¹è±¡" class="headerlink" title="2.3.å¯&#x2F;ä¸å¯å˜å¯¹è±¡"></a>2.3.å¯&#x2F;ä¸å¯å˜å¯¹è±¡</h3><p><code>copy</code>è¿”å›çš„æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œ<code>mutableCopy</code>è¿”å›çš„æ˜¯å¯å˜å¯¹è±¡ã€‚æŒ‰ç…§ <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/ObjectMutability/ObjectMutability.html">Appleæ–‡æ¡£</a> çš„è¯´æ³•ï¼Œå¯¹è±¡é»˜è®¤æ˜¯å¯å˜çš„ã€‚è¿™å¾ˆå¥½ç†è§£ï¼Œæ¯”å¦‚ä½ è‡ªå®šä¹‰çš„<code>å®¢æˆ·</code>å®ä½“ï¼Œå½“å®¢æˆ·çš„ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯¹åº”çš„å®ä½“å¯¹è±¡åº”è¯¥èƒ½æ›´æ–°ç›¸å…³å­—æ®µã€‚å¤§å¤šæ•°çš„å¯¹è±¡éƒ½å…è®¸ä½ é€šè¿‡ setter å‡½æ•°ä¿®æ”¹å®ƒå†…éƒ¨å°è£…çš„æ•°æ®ï¼ŒFoundation æ¡†æ¶ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å¯å˜ç±»å‹ï¼Œå¦‚ï¼š</p><ul><li>NSMutableArray</li><li>NSMutableDictionary</li><li>NSMutableSet</li><li>NSMutableIndexSet</li><li>NSMutableCharacterSet</li><li>NSMutableData</li><li>NSMutableString</li><li>NSMutableAttributedString</li><li>NSMutableURLRequest</li></ul><p>æ—¢ç„¶å¯¹è±¡é»˜è®¤æ˜¯å¯å˜çš„ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æœ‰ä¸å¯å˜å¯¹è±¡å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œä¸å¯å˜å¯¹è±¡å¯ä»¥é˜²æ­¢è¢«å¤šå¤„å¼•ç”¨æ—¶å› ä¸€æ–¹çš„ä¿®æ”¹å¯¼è‡´å…¶ä»–æ‰€æœ‰å¼•ç”¨çš„åœ°æ–¹éƒ½æ„å¤–åœ°å‘ç”Ÿå˜åŒ–çš„æƒ…å†µï¼Œæ¯”å¦‚ä½ æŒæœ‰çš„ tableview æ•°æ®æºæ•°ç»„æ˜¯å¯å˜çš„ï¼Œå¦‚æœåœ¨åˆ«çš„åœ°æ–¹è¢«å¼•ç”¨ä¸”å…¶ä¸­çš„æ•°æ®è¢«æ¸…ç©ºäº†ï¼Œé‚£ä¹ˆä½ çš„åˆ—è¡¨å°±ä¼šå‡ºé—®é¢˜ã€‚å¦å¤–ï¼Œä¸å¯å˜å¯¹è±¡åœ¨æ€§èƒ½ä¸Šæ›´æœ‰ä¼˜åŠ¿ï¼Œå› ä¸ºå®ƒä»¬ä¸éœ€è¦åƒå¯å˜å¯¹è±¡é‚£æ ·å§‹ç»ˆç»´æŒä¸€ä»½å¯å˜å­˜å‚¨ã€‚</p><p>æˆ‘ä»¬é€šå¸¸ä¼šä¸Šé¢æåˆ°çš„é›†åˆç±»æˆ–è€… NSString å’Œ block ç­‰å¯¹è±¡å‘é€è¿™ä¸¤ä¸ªæ¶ˆæ¯ï¼Œä»è€Œè·å¾—ä¸€ä¸ªæ–°çš„æ‹·è´å¯¹è±¡ï¼Œè¿™äº›æ“ä½œçš„èƒŒåæ˜¯æ¡†æ¶å¸®æˆ‘ä»¬å¤„ç†äº†åè®®æ–¹æ³•çš„å®ç°åŠå…¶è¿”å›å€¼ã€‚</p><p>å¯¹äºæˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»çš„å®ä¾‹ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨è¿™ä¿©æ–¹æ³•ï¼Œä½†æ˜¯ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°å¯¹åº”çš„åè®®æ–¹æ³•ï¼Œè‡ªå·±å®šä¹‰è¿”å›å€¼ã€‚åè®®æ–¹æ³•å†…çš„è¿”å›å€¼å¯ä»¥æ˜¯ selfï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå±æ€§å€¼ä¸ self å±æ€§å€¼ä¸€è‡´çš„æ–°å¯¹è±¡ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚è€Œå®šã€‚</p><p><strong>å°ç»“ï¼š</strong> ç»“åˆä»¥ä¸Šåˆ†æå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åªæ˜¯ä¸€ç§<code>ä¾¿åˆ©æ–¹æ³•</code>ã€‚å½“å‘å¯¹è±¡å‘é€è¿™ä¸¤ä¸ªæ¶ˆæ¯æ—¶ï¼Œå®ƒä»¬åªæ˜¯ä¼šåœ¨å¯¹è±¡æ‰€å±çš„ç±»ä¸­æŸ¥æ‰¾å¹¶è°ƒç”¨å¯¹åº”çš„åè®®æ–¹æ³•ï¼Œè¿”å›å¯å˜æˆ–ä¸å¯å˜çš„æ–°å¯¹è±¡ã€‚è¿™ç‚¹ç±»ä¼¼äºæˆ‘ä»¬å¸¸ç”¨çš„<code>ä¾¿åˆ©åˆå§‹åŒ–å‡½æ•°</code>ï¼Œæœ€ç»ˆè°ƒç”¨æŒ‡å®šåˆå§‹åŒ–å‡½æ•°ã€‚ä»å¦ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Œ<code>copy</code>å¹¶ä¸ç­‰ä»·äºæµ…æ‹·è´ï¼Œ<code>mutableCopy</code>ä¹Ÿå¹¶ç­‰ä»·äºæ·±æ‹·è´ï¼Œå°¤å…¶æ˜¯å½“ä½ åœ¨è‡ªå®šä¹‰çš„ç±»ä¸­å®ç°æ‹·è´çš„åè®®æ–¹æ³•æ—¶ï¼Œæ·±æ‹·è´è¿˜æ˜¯æµ…æ‹·è´å¯æ ¹æ®ä½ çš„éœ€æ±‚è€Œå®šã€‚å…·ä½“ä»€ä¹ˆæ˜¯æ·±æ‹·è´å’Œæµ…æ‹·è´ï¼Œæ¥ä¸‹æ¥ç»§ç»­ä»‹ç»ã€‚</p><h2 id="3-æ·±-x2F-æµ…æ‹·è´"><a href="#3-æ·±-x2F-æµ…æ‹·è´" class="headerlink" title="3.æ·±&#x2F;æµ…æ‹·è´"></a>3.æ·±&#x2F;æµ…æ‹·è´</h2><h3 id="3-1-æ¦‚å¿µ"><a href="#3-1-æ¦‚å¿µ" class="headerlink" title="3.1.æ¦‚å¿µ"></a>3.1.æ¦‚å¿µ</h3><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Collections/Articles/Copying.html">(Appleæ–‡æ¡£)ï¼š</a></p><blockquote><p>Copying an object creates a new object with the same class and properties as the original object. You copy an object when you want your own version of the data that the object contains. If you receive an object from elsewhere in an application but do not copy it, you share the object with its owner (and perhaps others), who might change the encapsulated contents. If you are creating a subclass, you might consider making it possible for others to copy instances of your class. Generally, an object should be â€œcopyableâ€ when it is a value objectâ€”an object whose main purpose is to encapsulate some data.</p></blockquote><p>æ‹·è´ï¼šåˆ›é€ å‡ºä¸€ä¸ªå‰¯æœ¬ï¼Œå‰¯æœ¬ä¸åŸå¯¹è±¡çš„ç±»ååŠå±æ€§ç›¸åŒã€‚</p><blockquote><p>Copies of objects can be shallow or deep. Both shallow- and deep-copy approaches directly duplicate scalar properties but differ on how they handle pointer references, particularly references to objects (for example, NSString *str). A deep copy duplicates the objects referenced while a shallow copy duplicates only the references to those objects. So if object A is shallow-copied to object B, object B refers to the same instance variable (or property) that object A refers to. Deep-copying objects is preferred to shallow-copying, especially with value objects.</p></blockquote><p>å¯¹è±¡çš„æ‹·è´å¯ä»¥åˆ†ä¸º<code>æµ…æ‹·è´</code>å’Œ<code>æ·±æ‹·è´</code>ä¸¤ç§æƒ…å½¢ï¼ŒäºŒè€…åœ¨å¤„ç†ç®€å•çš„çº¯é‡å±æ€§ï¼ˆInt,floatç­‰ï¼‰æ—¶ï¼Œéƒ½æ˜¯ç›´æ¥æ‹·è´å±æ€§çš„å€¼åˆ°æ–°å¯¹è±¡ï¼›ä¸åŒç‚¹åœ¨äºå¯¹æŒ‡é’ˆç±»å‹çš„å¤„ç†ä¸Šï¼š</p><ul><li><strong>æµ…æ‹·è´</strong>ï¼šæŒ‡é’ˆæ‹·è´ï¼Œå³å°†åŸå§‹å¯¹è±¡çš„æŒ‡é’ˆå€¼å¤åˆ¶åˆ°å‰¯æœ¬ä¸­ï¼ŒåŸå§‹å¯¹è±¡å’Œå‰¯æœ¬å…±äº«æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ã€‚</li><li><strong>æ·±æ‹·è´</strong>ï¼šå¯¹è±¡æ‹·è´ï¼Œå³å¤åˆ¶æŒ‡é’ˆæ‰€æŒ‡å‘çš„æ•°æ®ï¼Œå¹¶å°†å…¶èµ‹ç»™å‰¯æœ¬çš„å®ä¾‹å˜é‡ã€‚å› æ­¤å‰¯æœ¬å’ŒåŸå§‹å¯¹è±¡æŒ‡å‘ä¸åŒçš„åœ°å€ï¼Œåœ¨å‰¯æœ¬å’ŒåŸå¯¹è±¡ä¸Šçš„ä¿®æ”¹äº’ä¸å½±å“ã€‚</li></ul><h3 id="3-2-ä½¿ç”¨"><a href="#3-2-ä½¿ç”¨" class="headerlink" title="3.2.ä½¿ç”¨"></a>3.2.ä½¿ç”¨</h3><p>å¯¹è±¡æ˜¯æ·±æ‹·è´è¿˜æ˜¯æµ…æ‹·è´ï¼Œå¯ä»¥é€šè¿‡å…¶ setter æ¥åæ˜ ã€‚å¦‚æœ setter ä¸­æ‹·è´äº†ä¸€ä»½æ–°çš„å¯¹è±¡ï¼Œé‚£ä¹ˆæ­¤å¯¹è±¡åº”è¯¥ä½¿ç”¨<code>æ·±æ‹·è´</code>ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haxe">- (void)setMyVariable:<span class="hljs-type"></span>(id)<span class="hljs-keyword">new</span><span class="hljs-type">Value</span><br>&#123;<br>    [myVariable autorelease];<br>    myVariable = [<span class="hljs-keyword">new</span><span class="hljs-type">Value</span> copy];<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœ setter ä¸­åªæ˜¯<code>retain</code>äº†æ–°å€¼ï¼Œåˆ™æ­¤å¯¹è±¡åº”è¯¥ä½¿ç”¨<code>æµ…æ‹·è´</code>ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haxe">- (void)setMyVariable:<span class="hljs-type"></span>(id)<span class="hljs-keyword">new</span><span class="hljs-type">Value</span><br>&#123;<br>    [myVariable autorelease];<br>    myVariable = [<span class="hljs-keyword">new</span><span class="hljs-type">Value</span> retain];<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœ setter ä¸­åªæ˜¯ç®€å•çš„å°†æ–°å€¼èµ‹å€¼ç»™åŸå¯¹è±¡ï¼Œåˆ™æ­¤å¯¹è±¡åº”è¯¥ä½¿ç”¨<code>æµ…æ‹·è´</code>ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haxe">- (void)setMyVariable:<span class="hljs-type"></span>(id)<span class="hljs-keyword">new</span><span class="hljs-type">Value</span><br>&#123;<br>    myVariable = <span class="hljs-keyword">new</span><span class="hljs-type">Value</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-æ‹·è´æ·±åº¦"><a href="#3-3-æ‹·è´æ·±åº¦" class="headerlink" title="3.3.æ‹·è´æ·±åº¦"></a>3.3.æ‹·è´æ·±åº¦</h3><p>å¼€ç¯‡æåˆ°äº†æ‹·è´å¯¹è±¡çš„ç‰¹ç‚¹ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯æ–°å¯¹è±¡ä¸åŸå¯¹è±¡ç›¸äº’ç‹¬ç«‹ã€‚ä¸ºäº†ä¿è¯æ–°å¯¹è±¡çš„å®Œå…¨ç‹¬ç«‹æ€§ï¼Œæ•´ä¸ªå¯¹è±¡çš„éƒ½éœ€è¦æ·±æ‹·è´ï¼ŒåŒ…æ‹¬å…¶ä¸­çš„æ¯ä¸ªå±æ€§å’Œå®ä¾‹å˜é‡ã€‚å¦‚æœå±æ€§å’Œå®ä¾‹å˜é‡åˆåŒ…æ‹¬äº†å­å±æ€§å’Œå®ä¾‹å˜é‡ï¼Œé‚£ä¹ˆè¿™äº›å­å±æ€§å’Œå®ä¾‹å˜é‡ä¹Ÿéœ€è¦æ·±æ‹·è´ï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™å°±æ˜¯å•å±‚æ·±æ‹·è´å’Œå®Œå…¨æ·±æ‹·è´ã€‚æ¯”å¦‚ä¸€ä¸ª<code>å•†é“º</code>å®ä½“ï¼Œå…¶ä¸­åŒ…å«äº†<code>å®¢æˆ·</code>å®ä½“ï¼Œè€Œå®¢æˆ·å®ä½“åˆåŒ…å«äº†<code>è´¦æˆ·</code>å®ä½“ï¼Œå¦‚æœæ‹·è´<code>å•†é“º</code>æ—¶åªå¯¹<code>å®¢æˆ·</code>è¿›è¡Œäº†æ·±æ‹·è´ï¼ˆå³ï¼šé‡å†™æ‹·è´åè®®æ–¹æ³•å¹¶è¿”å›å®¢æˆ·å¯¹è±¡çš„ä¸€ä»½å†…å®¹æ‹·è´ï¼‰ï¼Œé‚£å°±æ˜¯å•å±‚æ·±æ‹·è´ï¼›å¦‚æœè¿<code>è´¦æˆ·</code>ä¹Ÿæ·±æ‹·è´ï¼Œé‚£å°±æ˜¯å®Œå…¨æ·±æ‹·è´ã€‚</p><p>æœ‰äº›æƒ…å†µä¸‹å¯¹è±¡è¿›è¡Œæ‹·è´æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ··ç€æ¥ï¼Œæ¯”å¦‚å¯¹äº intã€float è¿™ç§çº¯é‡ç±»å‹ï¼Œç›´æ¥æ‹·è´å…¶å€¼ï¼›å¯¹äºæŒ‡é’ˆç±»å‹çš„å˜é‡ï¼Œå®ƒæŒ‡å‘æŸå—æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ·±æ‹·è´ï¼Œæ‹·è´æ•°æ®è€ŒéæŒ‡é’ˆï¼›å¯¹äº delegate è¿™ç§å®ä¾‹å˜é‡ï¼Œå¯ä»¥ä½¿ç”¨æµ…æ‹·è´ï¼Œå³æ‹·è´æŒ‡é’ˆï¼›</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">@<span class="hljs-keyword">interface</span> <span class="hljs-symbol">Product</span> : <span class="hljs-symbol">NSObject</span> &lt;<span class="hljs-symbol">NSCopying</span>&gt;<br>&#123;<br>    NSString *productName;<br>    <span class="hljs-built_in">float</span> price;<br>    id delegate;<br>&#125;<br>@end<br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œå¯¹<code>Product</code>å¯¹è±¡è¿›è¡Œæ‹·è´æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹<code>productName</code>è¿›è¡Œæ·±æ‹·è´ï¼Œå› ä¸ºå®ƒè¡¨ç¤ºä¸€ä¸ªæ•°æ®çš„å€¼ï¼›å¯¹ä¸<code>delegate</code>ï¼Œå®ƒåœ¨ä¸¤ä¸ªå¯¹è±¡ä¸­æ‰€èµ·åˆ°çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥åº”è¯¥ä½¿ç”¨æµ…æ‹·è´ï¼Œå³ä¸¤ä¸ªå¯¹è±¡å…±äº«åŒä¸€ä¸ªæŒ‡é’ˆã€‚ä¸‹é¢çš„è¡¨æ ¼ä»£è¡¨äº†<code>Product</code>å¯¹è±¡å’Œå…¶æ‹·è´åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_object_ori.png" alt="åŸå¯¹è±¡"></p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_object_copy.png" alt="å‰¯æœ¬"></p><p><code>productName</code>æŒ‡é’ˆçš„å€¼ä¸åŒï¼Œè¡¨ç¤ºåŸå¯¹è±¡å’Œæ‹·è´å¯¹è±¡æœ‰å„è‡ªçš„ string ç±»å‹<code>productName</code>å€¼ã€‚<code>delegate</code>çš„æŒ‡é’ˆç›¸åŒï¼Œå®ƒä»¬å…±äº«ä¸€ä¸ªä»£ç†ã€‚</p><h2 id="4-ä¸å¯å˜å­—ç¬¦ä¸²çš„æ‹·è´"><a href="#4-ä¸å¯å˜å­—ç¬¦ä¸²çš„æ‹·è´" class="headerlink" title="4.ä¸å¯å˜å­—ç¬¦ä¸²çš„æ‹·è´"></a>4.ä¸å¯å˜å­—ç¬¦ä¸²çš„æ‹·è´</h2><p>#ç¤ºä¾‹4.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *str1 = <span class="hljs-string">@&quot;hello&quot;</span>;<br><span class="hljs-built_in">NSString</span> *str2 = [str1 <span class="hljs-keyword">copy</span>]; <span class="hljs-comment">// æµ…æ‹·è´</span><br><span class="hljs-built_in">NSString</span> *str3 = [str1 mutableCopy]; <span class="hljs-comment">// æ·±æ‹·è´</span><br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;str1 = %p&quot;</span>,str1);<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;str2 = %p&quot;</span>,str2);<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;str3 = %p&quot;</span>,str3);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">str1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x10ae55810<br><span class="hljs-attribute">str2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x10ae55810<br><span class="hljs-attribute">str3</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x600000258ea0<br></code></pre></td></tr></table></figure><p>ä»æ‰“å°å‡ºçš„å†…å­˜åœ°å€åˆ†æï¼šstr1 ä¸ str2 æŒ‡å‘åŒä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹ä¸å¯å˜å­—ç¬¦ä¸²çš„ copy æ“ä½œåªæ˜¯æŒ‡é’ˆæ‹·è´ï¼›è€Œ str3 ä¸ str1 æŒ‡å‘äº†ä¸åŒçš„å†…å­˜åŒºåŸŸï¼Œè¯´æ˜å¯¹ä¸å¯å˜å­—ç¬¦ä¸²çš„ mutableCopy äº§ç”Ÿäº†æ–°çš„å¯¹è±¡ï¼Œæ­¤å¯¹è±¡çš„å†…å­˜åœ°å€ä¸ str1 æŒ‡å‘çš„åœ°å€å®Œå…¨ä¸åŒã€‚</p><blockquote><p>ç»“è®º1ï¼šå¯¹äºä¸å¯å˜å­—ç¬¦ä¸²çš„ copy æ˜¯æµ…æ‹·è´ï¼ŒmutableCopy æ˜¯æ·±æ‹·è´ã€‚</p></blockquote><h2 id="5-å¯å˜å­—ç¬¦ä¸²çš„æ‹·è´"><a href="#5-å¯å˜å­—ç¬¦ä¸²çš„æ‹·è´" class="headerlink" title="5.å¯å˜å­—ç¬¦ä¸²çš„æ‹·è´"></a>5.å¯å˜å­—ç¬¦ä¸²çš„æ‹·è´</h2><p>#ç¤ºä¾‹5.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSMutableString</span> *str1 = [<span class="hljs-built_in">NSMutableString</span> stringWithString:<span class="hljs-string">@&quot;hello&quot;</span>];<br><span class="hljs-built_in">NSString</span> *str2 = [str1 <span class="hljs-keyword">copy</span>]; <span class="hljs-comment">// æ·±æ‹·è´</span><br><span class="hljs-built_in">NSString</span> *str3 = [str1 mutableCopy]; <span class="hljs-comment">// æ·±æ‹·è´</span><br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;str1 = %p&quot;</span>,str1);<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;str2 = %p&quot;</span>,str2);<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;str3 = %p&quot;</span>,str3);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">str1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x604000451040<br><span class="hljs-attribute">str2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>xa00006f6c6c65685<br><span class="hljs-attribute">str3</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x604000450fe0<br></code></pre></td></tr></table></figure><p>å¯¹å¯å˜å­—ç¬¦ä¸²çš„ä¸¤ç§å¤åˆ¶éƒ½äº§ç”Ÿäº†æ–°çš„å¯¹è±¡ï¼Œä¸‰ä¸ªå¯¹è±¡çš„åœ°å€å®Œå…¨ä¸åŒã€‚</p><blockquote><p>ç»“è®º2ï¼šå¯¹äºå¯å˜å­—ç¬¦ä¸²çš„å¤åˆ¶ï¼Œä¸è®º copy è¿˜æ˜¯ mutableCopy éƒ½æ˜¯æ·±æ‹·è´ã€‚</p></blockquote><h2 id="6-æ‹·è´ä¸å­—ç¬¦ä¸²å¯å˜æ€§"><a href="#6-æ‹·è´ä¸å­—ç¬¦ä¸²å¯å˜æ€§" class="headerlink" title="6.æ‹·è´ä¸å­—ç¬¦ä¸²å¯å˜æ€§"></a>6.æ‹·è´ä¸å­—ç¬¦ä¸²å¯å˜æ€§</h2><p>#ç¤ºä¾‹6.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *str1 = <span class="hljs-string">@&quot;hi&quot;</span>;<br><span class="hljs-built_in">NSMutableString</span> *str2 = [str1 mutableCopy];<br>[str2 appendString:<span class="hljs-string">@&quot;xx&quot;</span>];<br><br><span class="hljs-built_in">NSMutableString</span> *str3 = [<span class="hljs-built_in">NSMutableString</span> stringWithString:<span class="hljs-string">@&quot;hello&quot;</span>];<br><span class="hljs-built_in">NSMutableString</span> *str4 = [str3 <span class="hljs-keyword">copy</span>]; <span class="hljs-comment">// ä¸å¯å˜</span><br><span class="hljs-built_in">NSMutableString</span> *str5 = [str3 mutableCopy]; <span class="hljs-comment">// å¯å˜</span><br><br>[str4 appendString:<span class="hljs-string">@&quot;world&quot;</span>]; <span class="hljs-comment">//æŠ¥é”™</span><br>[str5 appendString:<span class="hljs-string">@&quot;Kitty&quot;</span>]; <span class="hljs-comment">//æ­£å¸¸</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹åœ¨è¿è¡Œåˆ° [str4 appendString:@â€worldâ€] è¿™ä¸€è¡Œæ—¶ä¼šæŠ¥é”™â€œunrecognized selector sent to instanceâ€ï¼Œè¿™å°±æ˜¯è¯´å¯å˜å­—ç¬¦ä¸²åœ¨æ‰§è¡Œ copy æ“ä½œåè¿”å›çš„å¯¹è±¡ä¸å†æ˜¯å¯å˜å­—ç¬¦ä¸²ï¼Œå› æ­¤å¯¹å…¶æ‰§è¡Œ appendString æ–¹æ³•æ—¶å‡ºç°äº†å´©æºƒã€‚æ³¨é‡Šæ‰è¿™ä¸€è¡Œåï¼Œç¨‹åºæ­£å¸¸æ‰§è¡Œã€‚</p><blockquote><p>ç»“è®º3ï¼šå­—ç¬¦ä¸²ï¼Œä¸è®ºæ˜¯å¯å˜è¿˜æ˜¯ä¸å¯å˜ï¼Œæ‰§è¡Œ copy åè¿”å›çš„å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼›mutableCopy åè¿”å›çš„å¯¹è±¡æ˜¯å¯å˜çš„ã€‚</p></blockquote><h2 id="7-è‡ªå®šä¹‰ç±»çš„æ‹·è´"><a href="#7-è‡ªå®šä¹‰ç±»çš„æ‹·è´" class="headerlink" title="7.è‡ªå®šä¹‰ç±»çš„æ‹·è´"></a>7.è‡ªå®šä¹‰ç±»çš„æ‹·è´</h2><p>#ç¤ºä¾‹7.1ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@interface</span> <span class="hljs-attribute">Model </span>: NSObject&lt;NSCopying, NSMutableCopying&gt;<br><span class="hljs-variable">@property</span> (nonatomic, copy) NSString *name;<br><span class="hljs-variable">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;Model.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Model</span></span><br><br>- (<span class="hljs-type">id</span>)copyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone<br>&#123;<br>    <span class="hljs-comment">/*å¯è¿”å›ä¸€ä»½å€¼æ‹·è´ï¼Œä¹Ÿå¯ä»¥è¿”å›ä¸€ä»½æŒ‡é’ˆæ‹·è´ï¼Œè¿™é‡Œæˆ‘è¿”å›çš„æ˜¯å€¼æ‹·è´ï¼›</span><br><span class="hljs-comment">     *å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥â€˜return selfâ€™ï¼Œè¿”å›ä¸€ä»½selfå®ä¾‹çš„æŒ‡é’ˆï¼Œè¿™ä¹ˆåšä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œå› ä½ çš„éœ€æ±‚è€Œå®šã€‚</span><br><span class="hljs-comment">     */</span> <br>    Model *newModel = [[[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>] allocWithZone:zone] init];<br>    newModel.name = [<span class="hljs-keyword">self</span>.name <span class="hljs-keyword">copy</span>]; <span class="hljs-comment">// ä½¿ç”¨copy</span><br>    <br>    <span class="hljs-keyword">return</span> newModel;<br>&#125;<br><br>- (<span class="hljs-type">id</span>)mutableCopyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone<br>&#123;<br>    Model *newModel = [[[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>] allocWithZone:zone] init];<br>    newModel.name = [<span class="hljs-keyword">self</span>.name mutableCopy]; <span class="hljs-comment">// ä½¿ç”¨mutableCopy</span><br><br>    <span class="hljs-keyword">return</span> newModel;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨è‡ªå®šä¹‰çš„ç±»ä¸­å®ç°äº†å¯å˜å’Œä¸å¯å˜æ‹·è´çš„åè®®ï¼Œè¿”å›çš„å¯¹è±¡æ ¹æ®è‡ªå·±çš„éœ€æ±‚è€Œå®šã€‚</p><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">Model</span> *<span class="hljs-keyword">model</span> = [<span class="hljs-keyword">Model</span> new];<br><span class="hljs-keyword">model</span>.name = @<span class="hljs-string">&quot;sakura&quot;</span>;<br>NSLog(@<span class="hljs-string">&quot;++++model = %p;&quot;</span>,<span class="hljs-keyword">model</span>);<br><br><span class="hljs-keyword">Model</span> *copymodel = [<span class="hljs-keyword">model</span> copy]; <span class="hljs-comment">// æ·±æ‹·è´</span><br>NSLog(@<span class="hljs-string">&quot;++++copymodel = %p&quot;</span>,copymodel);<br><br><span class="hljs-keyword">Model</span> *mutableCopymodel = [<span class="hljs-keyword">model</span> mutableCopy]; <span class="hljs-comment">// æ·±æ‹·è´</span><br>NSLog(@<span class="hljs-string">&quot;++++mutableCopymodel = %p&quot;</span>,mutableCopymodel);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">model = 0x600002748bb0;</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">copymodel = 0x6000027585d0</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">mutableCopymodel = 0x600002748bc0</span><br></code></pre></td></tr></table></figure><blockquote><p>ç»“è®º4ï¼šå¯¹äºæˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»ï¼Œå…¶ copy ä¸ mutableCopy æ˜¯æ·±&#x2F;æµ…æ‹·è´å› æˆ‘ä»¬è‡ªå·±çš„éœ€æ±‚è€Œå®šã€‚</p></blockquote><h2 id="8-é›†åˆç±»å¯¹è±¡çš„æ‹·è´"><a href="#8-é›†åˆç±»å¯¹è±¡çš„æ‹·è´" class="headerlink" title="8.é›†åˆç±»å¯¹è±¡çš„æ‹·è´"></a>8.é›†åˆç±»å¯¹è±¡çš„æ‹·è´</h2><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Collections/Articles/Copying.html">æ–‡æ¡£æ‘˜è¦</a></p><blockquote><p>There are two kinds of object copying: shallow copies and deep copies. The normal copy is a shallow copy that produces a new collection that shares ownership of the objects with the original. Deep copies create new objects from the originals and add those to the new collection. </p></blockquote><ul><li>é›†åˆå¯¹è±¡çš„æµ…æ‹·è´ï¼š</li></ul><p>å¯¹OCä¸­é›†åˆç±»å¯¹è±¡çš„æ‹·è´ï¼Œé»˜è®¤æ˜¯æµ…æ‹·è´ã€‚é›†åˆçš„æµ…æ‹·è´ä¼šäº§ç”Ÿæ–°çš„é›†åˆå¯¹è±¡ï¼Œæ–°æ—§é›†åˆå†…çš„å…ƒç´ æŒ‡é’ˆç›¸åŒã€‚åŸé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ ä¼šæ”¶åˆ°ä¸€æ¡ retain æ¶ˆæ¯ï¼Œå¼•ç”¨è®¡æ•°+1ï¼Œå®ƒä»¬çš„æŒ‡é’ˆä¼šè¢«æ‹·è´åˆ°æ–°å»ºçš„é›†åˆä¸­ã€‚ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œä»¥å®ç°é›†åˆå¯¹è±¡çš„æµ…æ‹·è´ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">-copyWithZone:ï¼ˆå¦‚ [anArr copyWithZone:<span class="hljs-literal">nil</span>];ï¼‰<br>-mutableCopyWithZone:<br>-initWithArray:copyItems:<span class="hljs-literal">NO</span>ï¼ˆç¬¬äºŒä¸ªå‚æ•°ä¸º<span class="hljs-literal">NO</span>ï¼‰<br>-initWithDictionary:copyItems:<span class="hljs-literal">NO</span>ï¼ˆç¬¬äºŒä¸ªå‚æ•°ä¸º<span class="hljs-literal">NO</span>ï¼‰<br></code></pre></td></tr></table></figure><ul><li>é›†åˆå¯¹è±¡çš„æ·±æ‹·è´ï¼š</li></ul><p>é›†åˆçš„æ·±æ‹·è´ä¼šäº§ç”Ÿæ–°çš„é›†åˆå¯¹è±¡ï¼Œæ–°æ—§é›†åˆå†…çš„å…ƒç´ æŒ‡é’ˆä¸ç›¸åŒï¼Œæ–°é›†åˆä¸­çš„å…ƒç´ æ˜¯ä»åŸé›†åˆä¸­çš„å…ƒç´ æ‹·è´è€Œæ¥ã€‚</p><p>æ–¹æ¡ˆ1ï¼šï¼ˆé€šè¿‡é›†åˆç±»å¯¹è±¡çš„å®ä¾‹æ–¹æ³•ï¼‰</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gams">- initWithArray:copyItems:<span class="hljs-keyword">YES</span>ï¼ˆç¬¬äºŒä¸ªå‚æ•°ä¸º<span class="hljs-keyword">YES</span>ï¼‰<br>- initWithDictionary:copyItems:<span class="hljs-keyword">YES</span>ï¼ˆç¬¬äºŒä¸ªå‚æ•°ä¸º<span class="hljs-keyword">YES</span>ï¼‰<br></code></pre></td></tr></table></figure><p>copyItems çš„å‚æ•° &#x3D; YESï¼Œè¿™ç§æ–¹å¼ä¸‹é›†åˆä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ copyWithZone: æ–¹æ³•ï¼Œå¦‚æœè¿™äº›å¯¹è±¡å®ç°äº† NSCopying åè®®ï¼Œé‚£ä¹ˆè¿™äº›å¯¹è±¡ä¼šè¢«æ·±æ‹·è´åˆ°æ–°é›†åˆä¸­ã€‚å¦‚æœæ²¡æœ‰å®ç° NSCopying åè®®ï¼Œåˆ™è¿è¡Œæ—¶ä¼šæŠ¥é”™ã€‚</p><p>æ–¹æ¡ˆ2ï¼šï¼ˆé€šè¿‡å½’æ¡£è§£æ¡£ï¼‰</p><blockquote><p>If you need a true deep copy, such as when you have an array of arrays, you can archive and then unarchive the collection, provided the contents all conform to the NSCoding protocol. </p></blockquote><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nsis">NSArray* trueDeepCopyArray = [NSKeyedUn<span class="hljs-params">archive</span>r un<span class="hljs-params">archive</span>ObjectWithData:<br>                                [NSKeyed<span class="hljs-params">Archive</span>r <span class="hljs-params">archive</span>dDataWithRootObject:oldArray]]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯é›†åˆçœŸæ­£æ„ä¹‰ä¸Šçš„æ·±æ‹·è´ï¼Œè¿™ç§æ–¹å¼ä¸‹é›†åˆä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½è¦å®ç° NSCoding åè®®ï¼Œä¸ç„¶ä¹Ÿä¼šå‡ºç°å´©æºƒã€‚</p><p>#ç¤ºä¾‹8.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Model</span> : <span class="hljs-title">NSObject</span>&lt;<span class="hljs-title">NSCopying</span>,<span class="hljs-title">NSMutableCopying</span>&gt;</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Model</span></span><br><br>- (<span class="hljs-type">id</span>)copyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++call Model copyWithZone~&quot;</span>);<br>    <br>    Model *newModel = [[[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>] allocWithZone:zone] init];<br>    newModel.name = [<span class="hljs-keyword">self</span>.name <span class="hljs-keyword">copy</span>];<br>    <br>    <span class="hljs-keyword">return</span> newModel;<br>&#125;<br><br>- (<span class="hljs-type">id</span>)mutableCopyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++call Model mutableCopyWithZone~&quot;</span>);<br>    <br>    Model *newModel = [[[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>] allocWithZone:zone] init];<br>    newModel.name = [<span class="hljs-keyword">self</span>.name mutableCopy];<br><br>    <span class="hljs-keyword">return</span> newModel;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Model *model = <span class="hljs-literal">[[M<span class="hljs-identifier">odel</span> <span class="hljs-identifier">alloc</span>]</span> init];<br>NSArray *<span class="hljs-built_in">array</span> = <span class="hljs-literal">[NSA<span class="hljs-identifier">rray</span> <span class="hljs-identifier">arrayWithObject</span>:<span class="hljs-identifier">model</span>]</span>;<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++model:%p&quot;</span>,<span class="hljs-params">model</span>)</span>;<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++array:%p,+++array[0]:%p&quot;</span>,<span class="hljs-params">array</span>,<span class="hljs-params">array</span>[0])</span>;<br>    <br>NSArray *zoneArray = <span class="hljs-literal">[<span class="hljs-identifier">array</span> <span class="hljs-identifier">copyWithZone</span>:<span class="hljs-identifier">nil</span>]</span>;<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++zoneArray:%p,+++zoneArray[0]:%p&quot;</span>,<span class="hljs-params">zoneArray</span>,<span class="hljs-params">zoneArray</span>[0])</span>;<br>    <br>NSArray *noCopyArr = <span class="hljs-literal">[[NSA<span class="hljs-identifier">rray</span> <span class="hljs-identifier">alloc</span>]</span> initWithArray:<span class="hljs-built_in">array</span> copyItems:NO];<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++noCopyArr:%p,+++noCopyArr[0]:%p&quot;</span>,<span class="hljs-params">noCopyArr</span>,<span class="hljs-params">noCopyArr</span>[0])</span>;<br>    <br>NSArray *copyArray = <span class="hljs-literal">[[NSA<span class="hljs-identifier">rray</span> <span class="hljs-identifier">alloc</span>]</span> initWithArray:<span class="hljs-built_in">array</span> copyItems:YES];<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++copyArray:%p,+++copyArray[0]:%p&quot;</span>,<span class="hljs-params">copyArray</span>,<span class="hljs-params">copyArray</span>[0])</span>;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">model:0x600003124780</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">array:0x6000031246f0</span><span class="hljs-string">,</span><span class="hljs-literal">+++</span><span class="hljs-comment">array</span><span class="hljs-title">[</span><span class="hljs-comment">0</span><span class="hljs-title">]</span><span class="hljs-comment">:0x600003124780</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">zoneArray:0x6000031246f0</span><span class="hljs-string">,</span><span class="hljs-literal">+++</span><span class="hljs-comment">zoneArray</span><span class="hljs-title">[</span><span class="hljs-comment">0</span><span class="hljs-title">]</span><span class="hljs-comment">:0x600003124780</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">noCopyArr:0x6000031246e0</span><span class="hljs-string">,</span><span class="hljs-literal">+++</span><span class="hljs-comment">noCopyArr</span><span class="hljs-title">[</span><span class="hljs-comment">0</span><span class="hljs-title">]</span><span class="hljs-comment">:0x600003124780</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">call Model copyWithZone~</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">copyArray:0x60000313f550</span><span class="hljs-string">,</span><span class="hljs-literal">+++</span><span class="hljs-comment">copyArray</span><span class="hljs-title">[</span><span class="hljs-comment">0</span><span class="hljs-title">]</span><span class="hljs-comment">:0x600003124440</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—ä¿¡æ¯æ˜¾ç¤ºï¼š</p><ul><li>-copyWithZone:è¿”å›çš„çš„æ•°ç»„å¯¹è±¡ä¸åŸæ•°ç»„å¯¹è±¡çš„æŒ‡é’ˆç›¸åŒï¼Œå†…éƒ¨å…ƒç´ çš„æŒ‡é’ˆä¹Ÿç›¸åŒï¼›</li><li>-initWithArray:copyItems:NO è¿”å›çš„æ•°ç»„å¯¹è±¡ä¸åŸæ•°ç»„å¯¹è±¡çš„æŒ‡é’ˆä¸åŒï¼Œå†…éƒ¨å…ƒç´ çš„æŒ‡é’ˆç›¸åŒï¼›</li><li>-initWithArray:copyItems:YES è¿”å›çš„æ•°ç»„å¯¹è±¡ä¸åŸæ•°ç»„å¯¹è±¡çš„æŒ‡é’ˆä¸åŒï¼Œå†…éƒ¨å…ƒç´ çš„æŒ‡é’ˆä¹Ÿä¸ç›¸åŒï¼Œä¸”è‡ªåŠ¨è°ƒç”¨äº†å…ƒç´ çš„æ‹·è´åè®®æ–¹æ³•ï¼›</li></ul><p>è¿™äº›éƒ½å°è¯äº†ä¸Šé¢å…³äºé›†åˆå¯¹è±¡æ·±æ‹·è´ã€æµ…æ‹·è´æ—¶å†…éƒ¨å…ƒç´ çš„ä¸åŒã€‚</p><h2 id="9-æ‹·è´ä¸é›†åˆçš„å¯å˜æ€§"><a href="#9-æ‹·è´ä¸é›†åˆçš„å¯å˜æ€§" class="headerlink" title="9.æ‹·è´ä¸é›†åˆçš„å¯å˜æ€§"></a>9.æ‹·è´ä¸é›†åˆçš„å¯å˜æ€§</h2><ul><li>-copyWithZone:</li></ul><blockquote><p>makes the surface level immutable. All deeper levels have the mutability they previously had.</p></blockquote><p>ä¸Šå±‚ä¸å¯å˜ï¼Œå…¶ä»–æ›´æ·±å±‚å¯¹è±¡çš„å¯å˜æ€§ä¸åŸå¯¹è±¡ç›¸åŒã€‚</p><ul><li>-initWithArray:copyItems:NO:</li></ul><blockquote><p>gives the surface level the mutability of the class it is allocated as. All deeper levels have the mutability they previously had.</p></blockquote><p>ä¸Šå±‚å¯å˜æ€§ä¸å…¶åˆå§‹åŒ–æ—¶çš„ç±»å‹ä¿æŒä¸€è‡´ï¼Œå…¶ä»–æ›´æ·±å±‚çš„å¯å˜æ€§ä¸åŸå¯¹è±¡ç›¸åŒã€‚</p><p>#ç¤ºä¾‹9.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)testWithNoCopy<br>&#123;<br>    <span class="hljs-built_in">NSMutableArray</span> *element = [[<span class="hljs-built_in">NSMutableArray</span> alloc] initWithObjects:@(<span class="hljs-number">1</span>), <span class="hljs-literal">nil</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++element:%p,elementClass:%@&quot;</span>,element,[element <span class="hljs-keyword">class</span>]);<br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *mutArr1 = [[<span class="hljs-built_in">NSMutableArray</span> alloc] initWithObjects:element, <span class="hljs-literal">nil</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++mutArr1:%p&quot;</span>,mutArr1);<br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *mutArr2 = [[<span class="hljs-built_in">NSMutableArray</span> alloc] initWithArray:mutArr1 copyItems:<span class="hljs-literal">NO</span>];<br>    [mutArr2 addObject:@(<span class="hljs-number">2</span>)];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++mutArr2:%p, mutArr2Class:%@, mutArr2.count:%lu&quot;</span>,mutArr2,[mutArr2 <span class="hljs-keyword">class</span>],mutArr2.count);<br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *arrAt0 = mutArr2[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++arrAt0:%p, arrAt0Class:%@&quot;</span>,arrAt0,[arrAt0 <span class="hljs-keyword">class</span>]);<br>    <br>    [arrAt0 addObject:@(<span class="hljs-number">3</span>)];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++arrAt0.count:%lu&quot;</span>,(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)arrAt0.count);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++element.count:%lu&quot;</span>,(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)element.count);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vim">++++elemen<span class="hljs-variable">t:0x60000229de00</span>,elementClas<span class="hljs-variable">s:__NSArrayM</span><br>++++mutArr1:<span class="hljs-number">0</span>x600002283810<br>++++mutArr2:<span class="hljs-number">0</span>x6000022838d0, mutArr2Clas<span class="hljs-variable">s:__NSArrayM</span>, mutArr2.coun<span class="hljs-variable">t:2</span><br>++++arrAt0:<span class="hljs-number">0</span>x60000229de00, arrAt0Clas<span class="hljs-variable">s:__NSArrayM</span><br>++++arrAt0.coun<span class="hljs-variable">t:2</span><br>++++element.coun<span class="hljs-variable">t:2</span><br></code></pre></td></tr></table></figure><p>mutArr2 æ˜¯é€šè¿‡-initWithArray:copyItems:NO äº§ç”Ÿçš„æ–°æ•°ç»„ï¼Œå†…éƒ¨å…ƒç´ ä»å¯å˜æ•°ç»„ mutArr1 ä¸­æ‹·è´è€Œæ¥ã€‚ç¤ºä¾‹ä¸­ [mutArr2 addObject:@(2)] å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œè¯´æ˜ initWithArray:copyItems:NO äº§ç”Ÿçš„ mutArr2 æ­£å¦‚å…¶åˆ›å»ºæ—¶å£°æ˜çš„é‚£æ ·ï¼Œæ˜¯ä¸€ä¸ªå¯å˜æ•°ç»„ï¼Œå³ï¼šä¸Šå±‚å¯å˜æ€§ä¸å…¶åˆå§‹åŒ–æ—¶çš„ç±»å‹ä¿æŒä¸€è‡´~</p><p>arrAt0 ä½œä¸º mutArr2 çš„å­å…ƒç´ ï¼ŒæŒ‡é’ˆä¸ element ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åˆ›å»º mutArr2 æ—¶åªæ˜¯æ‹·è´äº† mutArr1 ä¸­å…ƒç´  element çš„æŒ‡é’ˆã€‚å› æ­¤ï¼ŒarrAt0 ä¹Ÿæ˜¯ä¸€ä¸ªå¯å˜æ•°ç»„ï¼Œèƒ½æ­£å¸¸æ‰§è¡Œ [arrAt0 addObject:@(3)]ï¼Œå³ï¼šå…¶ä»–æ›´æ·±å±‚çš„å¯å˜æ€§ä¸åŸå¯¹è±¡ç›¸åŒã€‚</p><ul><li>-initWithArray:copyItems:YES:</li></ul><blockquote><p>gives the surface level the mutability of the class it is allocated as. The next level is immutable, and all deeper levels have the mutability they previously had.</p></blockquote><p>ä¸Šå±‚å¯å˜æ€§ä¸å…¶åˆå§‹åŒ–æ—¶çš„ç±»å‹ä¿æŒä¸€è‡´ï¼Œæ¥ä¸‹æ¥çš„ä¸€å±‚ä¸å¯å˜ï¼Œå…¶ä»–æ›´æ·±å±‚çš„å¯å˜æ€§ä¸åŸå¯¹è±¡ç›¸åŒã€‚</p><p>#ç¤ºä¾‹9.2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)testWithCopy<br>&#123;<br>    <span class="hljs-built_in">NSMutableArray</span> *inArr = [[<span class="hljs-built_in">NSMutableArray</span> alloc] initWithObjects:@(<span class="hljs-number">1</span>), <span class="hljs-literal">nil</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++inArr:%p, inArrClass:%@&quot;</span>,inArr,[inArr <span class="hljs-keyword">class</span>]);<br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *element = [[<span class="hljs-built_in">NSMutableArray</span> alloc] initWithObjects:inArr, <span class="hljs-literal">nil</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++element:%p,elementClass:%@&quot;</span>,element,[element <span class="hljs-keyword">class</span>]);<br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *mutArr1 = [[<span class="hljs-built_in">NSMutableArray</span> alloc] initWithObjects:element, <span class="hljs-literal">nil</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++mutArr1:%p&quot;</span>,mutArr1);<br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *mutArr2 = [[<span class="hljs-built_in">NSMutableArray</span> alloc] initWithArray:mutArr1 copyItems:<span class="hljs-literal">YES</span>];<br>    [mutArr2 addObject:@(<span class="hljs-number">2</span>)];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++mutArr2:%p, mutArr2Class:%@, mutArr2.count:%lu&quot;</span>,mutArr2,[mutArr2 <span class="hljs-keyword">class</span>],mutArr2.count);<br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *arrAt0 = mutArr2[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++arrAt0:%p, arrAt0Class:%@&quot;</span>,arrAt0,[arrAt0 <span class="hljs-keyword">class</span>]);<br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *inArrAt0 = arrAt0[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++inArrAt0:%p, inArrAt0Class:%@&quot;</span>,inArrAt0,[inArrAt0 <span class="hljs-keyword">class</span>]);<br>    <br>    [inArrAt0 addObject:@(<span class="hljs-number">3</span>)];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++inArrAt0.count:%lu&quot;</span>,(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)inArrAt0.count);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++inArr.count:%lu&quot;</span>,(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)inArr.count);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">++++inArr:<span class="hljs-number">0</span>x6000028a4150, inArrClas<span class="hljs-variable">s:__NSArrayM</span><br>++++elemen<span class="hljs-variable">t:0x6000028bd0b0</span>,elementClas<span class="hljs-variable">s:__NSArrayM</span><br>++++mutArr1:<span class="hljs-number">0</span>x6000028bd3e0<br>++++mutArr2:<span class="hljs-number">0</span>x6000028bd470, mutArr2Clas<span class="hljs-variable">s:__NSArrayM</span>, mutArr2.coun<span class="hljs-variable">t:2</span><br>++++arrAt0:<span class="hljs-number">0</span>x6000024e19d0, arrAt0Clas<span class="hljs-variable">s:__NSSingleObjectArrayI</span><br>++++inArrAt0:<span class="hljs-number">0</span>x6000028a4150, inArrAt0Clas<span class="hljs-variable">s:__NSArrayM</span><br>++++inArrAt0.coun<span class="hljs-variable">t:2</span><br>++++inArr.coun<span class="hljs-variable">t:2</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒmutArr2Class:__NSArrayMï¼Œè¯´æ˜ mutArr2 ä»ç„¶æ˜¯ä¸€ä¸ªå¯å˜æ•°ç»„ï¼Œå³ï¼šä¸Šå±‚å¯å˜æ€§ä¸å…¶åˆå§‹åŒ–æ—¶çš„ç±»å‹ä¿æŒä¸€è‡´~</p><p>arrAt0Class:__NSSingleObjectArrayIï¼Œä¸” arrAt0 ä¸ element çš„æŒ‡é’ˆä¸å†ç›¸åŒï¼Œè¯´æ˜ arrAt0 æ˜¯å†…å®¹æ‹·è´è€ŒéæŒ‡é’ˆæ‹·è´ï¼Œä¸”ä¸å¯å˜ï¼Œå³ï¼šæ¥ä¸‹æ¥çš„ä¸€å±‚ä¸å¯å˜~</p><p>inArrAt0Class:__NSArrayMï¼ŒinArrAt0 ä¸º arrAt0 ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¯¹åº”ç€ inArrï¼Œä¸”äºŒè€…çš„æŒ‡é’ˆç›¸åŒï¼Œå³ï¼šå…¶ä»–æ›´æ·±å±‚çš„å¯å˜æ€§ä¸åŸå¯¹è±¡ç›¸åŒã€‚</p><p>å¦å¤–ï¼ŒmutArr2 æ˜¯ä¸€ä¸ªé›†åˆï¼Œç®—æ˜¯æœ€ä¸Šå±‚ã€‚arrAt0 ä½œä¸º mutArr2 é›†åˆçš„ç¬¬ä¸€å±‚ï¼Œå¯¹åº”ç€ mutArr1 ä¸­çš„ elementï¼Œä½† arrAt0 ä¸ element çš„æŒ‡é’ˆä¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´ initWithArray:copyItems:YES äº§ç”Ÿçš„é›†åˆä¸­ï¼Œæœ€ä¸Šå±‚æ˜¯æ·±æ‹·è´ï¼›inArrAt0 ä½œä¸º arrAt0 çš„å…ƒç´ ï¼Œæ˜¯ mutArr2 çš„ç¬¬äºŒå±‚ï¼Œå®ƒçš„æŒ‡é’ˆä¸ inArr çš„æŒ‡é’ˆç›¸åŒï¼Œä¸” [inArrAt0 addObject:@(3)] ä¹‹å inArr.count ä¹Ÿéšç€å˜åŒ–ï¼Œè¿™è¯´æ˜ä»ç¬¬äºŒå±‚å¼€å§‹å°±å·²ç»æ˜¯æŒ‡é’ˆæ‹·è´ï¼Œå³æµ…æ‹·è´äº†~</p><blockquote><p>ç»“è®º5ï¼šé›†åˆçš„æ·±æ‹·è´ï¼Œåªæ˜¯å•å±‚æ·±æ‹·è´ï¼Œæ›´æ·±å±‚å¼€å§‹å…ƒç´ å°±åªæ˜¯æŒ‡é’ˆæ‹·è´äº†~</p></blockquote><ul><li>Archiving and unarchiving:</li></ul><blockquote><p>Archiving and unarchiving the collection leaves the mutability of all levels as it was before.</p></blockquote><p>æ‰€æœ‰å±‚çš„å¯å˜æ€§ä¸åŸå¯¹è±¡å®Œå…¨ç›¸åŒã€‚</p><p>#ç¤ºä¾‹9.3ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSMutableArray</span> * array;<br></code></pre></td></tr></table></figure><p>å¯¹<code>array</code>å±æ€§æ‰§è¡Œ<code>add</code>æ“ä½œä¼šå‘ç”Ÿä»€ä¹ˆ?</p><p><code>copy</code>æ–¹æ³•è¿”å›çš„é›†åˆæ˜¯ä¸å¯å˜é›†åˆï¼Œæ•…è€Œè¿™é‡Œ<code>array</code>å±æ€§å®é™…ä¸Šæ˜¯ä¸å¯å˜çš„ï¼Œå¯¹å…¶æ‰§è¡Œå¢åˆ å¯¹è±¡æ“ä½œæ—¶ä¼šé—ªé€€ã€‚</p><h2 id="10-é›†åˆçš„copyä¸mutableCopy"><a href="#10-é›†åˆçš„copyä¸mutableCopy" class="headerlink" title="10.é›†åˆçš„copyä¸mutableCopy"></a>10.é›†åˆçš„copyä¸mutableCopy</h2><p>#ç¤ºä¾‹10.1ï¼šå¯¹ä¸å¯å˜é›†åˆç±»å¯¹è±¡çš„æ‹·è´</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Model *m = <span class="hljs-literal">[[M<span class="hljs-identifier">odel</span> <span class="hljs-identifier">alloc</span>]</span> init];<br>NSArray *element = @<span class="hljs-literal">[<span class="hljs-identifier">m</span>]</span>;<br>NSArray *oriArray = @<span class="hljs-literal">[<span class="hljs-identifier">element</span>]</span>;<br>NSMutableArray *copyArray = <span class="hljs-literal">[<span class="hljs-identifier">oriArray</span> <span class="hljs-identifier">copy</span>]</span>;<br>NSMutableArray *mutableCopyArray = <span class="hljs-literal">[<span class="hljs-identifier">oriArray</span> <span class="hljs-identifier">mutableCopy</span>]</span>;<br>    <br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++oriArr:%p,element:%p&quot;</span>,<span class="hljs-params">oriArray</span>,<span class="hljs-params">element</span>)</span>;<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++copyArr:%p,indexAt0:%p&quot;</span>,<span class="hljs-params">copyArray</span>,<span class="hljs-params">copyArray</span>[0])</span>;<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++mutableCopyArr:%p,indexAt0:%p&quot;</span>,<span class="hljs-params">mutableCopyArray</span>,<span class="hljs-params">mutableCopyArray</span>[0])</span>;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">+++oriArr:<span class="hljs-number">0</span>x60<span class="hljs-number">00039f0760</span>,element:<span class="hljs-number">0</span>x60<span class="hljs-number">00039f06b0</span><br>++++copyArr:<span class="hljs-number">0</span>x60<span class="hljs-number">00039f0760</span>,indexAt0:<span class="hljs-number">0</span>x60<span class="hljs-number">00039f06b0</span><br>++++mutableCopyArr:<span class="hljs-number">0</span>x60<span class="hljs-number">00035a59b0</span>,indexAt0:<span class="hljs-number">0</span>x60<span class="hljs-number">00039f06b0</span><br></code></pre></td></tr></table></figure><p>ä¸å¯å˜æ•°ç»„ oriArray ä¸­åŒ…å«äº†ä¸€ä¸ªæ•°ç»„å¯¹è±¡ element ã€‚ä»æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼ŒoriArray ä¸ä»å…¶ copy å‡ºæ¥çš„æ•°ç»„ copyArray æŒ‡å‘åŒä¸€ç‰‡å†…å­˜ï¼Œè€Œä¸ä»å…¶ mutableCopy å‡ºæ¥çš„æ•°ç»„ mutableCopyArray çš„å†…å­˜ä¸åŒã€‚è¿™ä¸ä¸å¯å˜éé›†åˆç±»å¯¹è±¡ç±»ä¼¼ï¼Œå¯¹ä¸å¯å˜æ•°ç»„çš„ copy åªæ˜¯æŒ‡é’ˆæ‹·è´ï¼Œä¸ä¼šäº§ç”Ÿæ–°çš„é›†åˆå¯¹è±¡ï¼›mutableCopy æ˜¯å†…å®¹æ‹·è´ï¼Œä¼šäº§ç”Ÿæ–°çš„é›†åˆå¯¹è±¡ã€‚</p><blockquote><p>ç»“è®º6ï¼šå¯¹äºä¸å¯å˜é›†åˆå¯¹è±¡çš„ copy æ˜¯æŒ‡é’ˆæ‹·è´ï¼Œä¸äº§ç”Ÿæ–°å¯¹è±¡ï¼›mutableCopy æ˜¯å†…å®¹æ‹·è´ï¼Œä¼šäº§ç”Ÿæ–°å¯¹è±¡ï¼›ä¸¤ç§æƒ…å†µä¸‹é›†åˆå†…å…ƒç´ éƒ½æ˜¯æŒ‡é’ˆæ‹·è´ã€‚</p></blockquote><p>#ç¤ºä¾‹10.2ï¼šå¯¹å¯å˜é›†åˆç±»å¯¹è±¡çš„æ‹·è´</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">Model *m = [[Model alloc] init];<br><span class="hljs-built_in">NSArray</span> *element = @[m];<br><span class="hljs-built_in">NSMutableArray</span> *oriArray = [<span class="hljs-built_in">NSMutableArray</span> arrayWithObject:element];<br><span class="hljs-built_in">NSMutableArray</span> *copyArray = [oriArray <span class="hljs-keyword">copy</span>];<br><span class="hljs-built_in">NSMutableArray</span> *mutableCopyArray = [oriArray mutableCopy];<br>    <br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++oriArr:%p,element:%p&quot;</span>,oriArray,element);<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++copyArr:%p,indexAt0:%p&quot;</span>,copyArray,copyArray[<span class="hljs-number">0</span>]);<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++mutableCopyArr:%p,indexAt0:%p&quot;</span>,mutableCopyArray,mutableCopyArray[<span class="hljs-number">0</span>]);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">+++oriArr:<span class="hljs-number">0</span>x60000102dd10,element:<span class="hljs-number">0</span>x6<span class="hljs-number">00001c64c40</span><br>++++copyArr:<span class="hljs-number">0</span>x6<span class="hljs-number">00001c73360</span>,indexAt0:<span class="hljs-number">0</span>x6<span class="hljs-number">00001c64c40</span><br>++++mutableCopyArr:<span class="hljs-number">0</span>x6<span class="hljs-number">00001033900</span>,indexAt0:<span class="hljs-number">0</span>x6<span class="hljs-number">00001c64c40</span><br></code></pre></td></tr></table></figure><p>å¯¹å¯å˜æ•°ç»„ oriArray çš„ä¸¤ç§æ‹·è´éƒ½æ˜¯å†…å®¹æ‹·è´ï¼Œéƒ½äº§ç”Ÿäº†æ–°çš„é›†åˆå¯¹è±¡ã€‚</p><blockquote><p>ç»“è®º7ï¼šå¯¹äºå¯å˜é›†åˆå¯¹è±¡çš„ copy å’Œ mutableCopy éƒ½æ˜¯å†…å®¹æ‹·è´ï¼Œä¼šäº§ç”Ÿæ–°çš„é›†åˆå¯¹è±¡ï¼›ä¸¤ç§æƒ…å†µä¸‹é›†åˆå†…å…ƒç´ éƒ½æ˜¯æŒ‡é’ˆæ‹·è´ã€‚</p></blockquote><p>ç¤ºä¾‹10.1ä¸ç¤ºä¾‹10.2ä¸­ï¼Œå…ƒç´  element ä¸ copyArray[0] å’Œ mutableCopyArray[0] éƒ½æ˜¯æŒ‡å‘åŒä¸€ç‰‡å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸¤ç§æ‹·è´ä¸‹ï¼Œæ–°æ—§é›†åˆå†…å®¹éƒ¨çš„å…ƒç´ éƒ½åªæ˜¯æŒ‡é’ˆæ‹·è´ã€‚</p><blockquote><p>ç»“è®º8ï¼šå¯¹äºå¯å˜å’Œä¸å¯å˜é›†åˆå¯¹è±¡çš„copy å’Œ mutableCopyï¼Œå…¶å†…éƒ¨å…ƒç´ å§‹ç»ˆéƒ½æ˜¯æŒ‡é’ˆæ‹·è´ã€‚</p></blockquote><p>#ç¤ºä¾‹10.3ï¼šé›†åˆå†…å…ƒç´ çš„æŒ‡é’ˆæ‹·è´</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSArray</span> *elementArr = [<span class="hljs-built_in">NSMutableArray</span> arrayWithObject:@<span class="hljs-number">1</span>];<br><span class="hljs-built_in">NSMutableArray</span> *oriArray = [<span class="hljs-built_in">NSMutableArray</span> arrayWithObject:elementArr];<br><span class="hljs-built_in">NSMutableArray</span> *mutableCopyArray = [oriArray mutableCopy];<br>[mutableCopyArray[<span class="hljs-number">0</span>] addObject:@<span class="hljs-number">2</span>];<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++objects in element:%p++++&quot;</span>,elementArr);<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSNumber</span> *num <span class="hljs-keyword">in</span> elementArr) &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++%d&quot;</span>,[num intValue]);<br>&#125;<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++objects in mutableCopyArray[0]:%p++++&quot;</span>,mutableCopyArray[<span class="hljs-number">0</span>]);<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSNumber</span> *num <span class="hljs-keyword">in</span> mutableCopyArray[<span class="hljs-number">0</span>]) &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++%d&quot;</span>,[num intValue]);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">objects in element:0x600000249450</span><span class="hljs-literal">++++</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">objects in mutableCopyArray</span><span class="hljs-title">[</span><span class="hljs-comment">0</span><span class="hljs-title">]</span><span class="hljs-comment">:0x600000249450</span><span class="hljs-literal">++++</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">2</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹æ˜¾ç¤ºï¼ŒmutableCopyArray å†…çš„å…ƒç´ ä¸ oriArray å†…çš„å…ƒç´ ï¼Œéƒ½æ˜¯æŒ‡å‘åŒä¸€ç‰‡åœ°å€ï¼Œä¹Ÿå°±æ˜¯ element çš„åœ°å€ã€‚å› æ­¤ï¼Œåç»­å¯¹ mutableCopyArray[0] æ‰§è¡Œæ·»åŠ æ•°æ®çš„æ“ä½œæ—¶ï¼Œelement æ•°ç»„ä¹Ÿå—åˆ°å½±å“ï¼Œè·Ÿç€å¢åŠ äº†ç›¸åŒçš„å¯¹è±¡ã€‚å› æ­¤å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ç•™æ„è¿™ä¸€ç‚¹ï¼</p><h2 id="11-å°ç»“"><a href="#11-å°ç»“" class="headerlink" title="11.å°ç»“"></a>11.å°ç»“</h2><ul><li>å¯å˜å¯¹è±¡çš„<code>copy</code>å’Œ<code>mutableCopy</code>éƒ½æ˜¯æ·±æ‹·è´ï¼›</li><li>ä¸å¯å˜å¯¹è±¡çš„<code>copy</code>æ˜¯æµ…æ‹·è´ï¼Œ<code>mutableCopy</code>æ˜¯æ·±æ‹·è´ï¼›</li><li><code>copy</code>æ–¹æ³•è¿”å›çš„éƒ½æ˜¯ä¸å¯å˜å¯¹è±¡ï¼›</li></ul><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/library/archive/documentation/LegacyTechnologies/WebObjects/WebObjects_3.5/Reference/Frameworks/ObjC/Foundation/Protocols/NSCopying/Description.html#//apple_ref/occ/intf/NSCopying">Â©Apple-Documentation-nscopying</a></p><p>#<a href="https://developer.apple.com/documentation/foundation/nscopying?language=objc">Â©Apple-Documentation-nscopyingæ–°</a></p><p>#<a href="https://developer.apple.com/documentation/foundation/nsmutablecopying?language=objc">Â©Apple-Documentation-nsmutablecopying</a></p><p>#<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/ObjectMutability/ObjectMutability.html">Â©Apple-Documentation-Object Mutability</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>KVO çš„åº•å±‚å®ç°</title>
    <link href="/2018/04/13/kvo.html"/>
    <url>/2018/04/13/kvo.html</url>
    
    <content type="html"><![CDATA[<h3 id="æ˜¯å•¥"><a href="#æ˜¯å•¥" class="headerlink" title="#æ˜¯å•¥?"></a>#æ˜¯å•¥?</h3><p>KVO æ˜¯é€šè¿‡ä¸€ä¸ª key æ¥æ‰¾åˆ°æŸä¸ªå±æ€§å¹¶ç›‘å¬å…¶å€¼çš„æ”¹å˜ã€‚å…¶å®è¿™ä¹Ÿæ˜¯ä¸€ç§å…¸å‹çš„è§‚å¯Ÿè€…æ¨¡å¼ã€‚</p><h3 id="å’‹ç”¨"><a href="#å’‹ç”¨" class="headerlink" title="#å’‹ç”¨?"></a>#å’‹ç”¨?</h3><ol><li>æ·»åŠ è§‚å¯Ÿè€…</li><li>åœ¨è§‚å¯Ÿè€…ä¸­å®ç°ç›‘å¬æ–¹æ³•ï¼š-observeValueForKeyPath: ofObject: change: context:ã€‚</li><li>ç§»é™¤è§‚å¯Ÿè€…</li></ol><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//Person.h</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Model.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Person</span> : <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">NSCoding</span>&gt;</span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">NSInteger</span> age;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSMutableArray</span> *nickArr;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) Model *model; <span class="hljs-comment">// åŒ…å«äº†ä¸€ä¸ªModelå¯¹è±¡</span><br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//Model.h</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Model</span> : <span class="hljs-title">NSObject</span></span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨ç›‘å¬è€…ç±»ä¸­æ³¨å†Œç›‘å¬çš„å±æ€§ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-keyword">static</span> <span class="hljs-type">void</span> *nickArrContext = &amp;nickArrContext;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    Person *p = [[Person alloc] init];<br>    <br>    <span class="hljs-comment">//ç›‘å¬p.model.nameå­—æ®µçš„å˜åŒ–</span><br>    [p addObserver:<span class="hljs-keyword">self</span> forKeyPath:<span class="hljs-string">@&quot;model.name&quot;</span><br>           options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span> context:<span class="hljs-literal">nil</span>];<br>    <span class="hljs-comment">//èµ‹å€¼ è§¦å‘è§‚å¯Ÿè€…</span><br>    p.model = [Model new];<br>    p.model.name = <span class="hljs-string">@&quot;211&quot;</span>;<br>    <br>    <span class="hljs-comment">//ç›‘å¬æ•°ç»„å±æ€§çš„å˜åŒ–</span><br>    [p addObserver:<span class="hljs-keyword">self</span> forKeyPath:<span class="hljs-string">@&quot;nickArr&quot;</span> options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span> context:nickArrContext];<br>    p.nickArr = [<span class="hljs-built_in">NSMutableArray</span> arrayWithObject:<span class="hljs-string">@&quot;david1&quot;</span>];<span class="hljs-comment">//ä¼šè§¦å‘å›è°ƒ</span><br>    [p.nickArr addObject:<span class="hljs-string">@&quot;Davi1&quot;</span>];<span class="hljs-comment">//ä¸ä¼šè§¦å‘å›è°ƒ</span><br>    <br>    <span class="hljs-built_in">NSMutableArray</span> *mutNickArr = [p mutableArrayValueForKey:<span class="hljs-string">@&quot;nickArr&quot;</span>];<br>    <span class="hljs-comment">//mutNickArr = [NSMutableArray arrayWithObject:@&quot;david2&quot;];å¦‚æœé‡æ–°èµ‹å€¼åå†è°ƒç”¨ addObjectå°†ä¸ä¼šè§¦å‘KVOå›è°ƒ</span><br>    [mutNickArr addObject:<span class="hljs-string">@&quot;Davi2&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++p.nickArr:%@&quot;</span>,p.nickArr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -ç›‘å¬å›è°ƒ</span><br>-(<span class="hljs-type">void</span>)observeValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath<br>                     ofObject:(<span class="hljs-type">id</span>)object<br>                       change:(<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSKeyValueChangeKey</span>,<span class="hljs-type">id</span>&gt; *)change<br>                      context:(<span class="hljs-type">void</span> *)context&#123;<br>    <span class="hljs-type">id</span> newValue = change[<span class="hljs-built_in">NSKeyValueChangeNewKey</span>];<br>    <br>    <span class="hljs-keyword">if</span> ([keyPath isEqualToString:<span class="hljs-string">@&quot;model.name&quot;</span>]) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++model.name newValue:%@&quot;</span>,newValue);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([keyPath isEqualToString:<span class="hljs-string">@&quot;nickArr&quot;</span>])&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++nickArr newValue:%@&quot;</span>,newValue);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs haxe">++++model.name <span class="hljs-keyword">new</span><span class="hljs-type">Value</span>:&lt;<span class="hljs-literal">null</span>&gt;<br>++++model.name <span class="hljs-keyword">new</span><span class="hljs-type">Value</span>:<span class="hljs-number">211</span><br>++++nickArr <span class="hljs-keyword">new</span><span class="hljs-type">Value</span>:(<br>    david1<br>)<br>++++nickArr <span class="hljs-keyword">new</span><span class="hljs-type">Value</span>:(<br>    Davi2<br>)<br>++++p.nickArr:<span class="hljs-type"></span>(<br>    david1,<br>    Davi1,<br>    Davi2<br>)<br></code></pre></td></tr></table></figure><p>æœ€åä¸è¦å¿˜è®°åœ¨åˆé€‚çš„æ—¶æœºï¼ˆå¦‚deallocæˆ–è€…å›è°ƒä¸­ï¼‰ç§»é™¤ç›‘å¬ã€‚</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[<span class="hljs-variable language_">self</span> <span class="hljs-symbol">removeObserver:</span><span class="hljs-variable language_">self</span> <span class="hljs-symbol">forKeyPath:</span>@<span class="hljs-string">&quot;name&quot;</span>];<br></code></pre></td></tr></table></figure><ul><li>æ•°ç»„çš„ç›‘å¬</li></ul><p>æ³¨æ„ï¼Œåœ¨ç›‘å¬æ•°ç»„å±æ€§<code>nickArr</code>æ—¶ï¼Œå¦‚æœæ˜¯ç»™æ­¤æ•°ç»„é‡æ–°èµ‹å€¼ï¼Œä¼šè§¦å‘å›è°ƒï¼›ä½†å¦‚æœç›´æ¥ä½¿ç”¨æ­¤æ•°ç»„æ·»åŠ å¯¹è±¡<code>addObject:</code>æ—¶ï¼Œä¸ä¼šè§¦å‘å›è°ƒï¼æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>mutableArrayValueForKey:</code>æ¥è¿”å›ä¸€ä¸ªåŸæ•°ç»„çš„<code>ä»£ç†æ•°ç»„å¯¹è±¡</code>ï¼Œä¹‹ååœ¨æ­¤ä»£ç†å¯¹è±¡ä¸Šçš„æ“ä½œéƒ½ä¼šåœ¨åŸå¯¹è±¡ä¸Šæœ‰ç›¸åŒçš„æ•ˆæœï¼Œå¹¶ä¸”ä¼šæ”¶åˆ°å›è°ƒã€‚ä¸‹é¢æ˜¯æ­¤æ–¹æ³•çš„ä½¿ç”¨è¯´æ˜ï¼š</p><blockquote><p>The default implementation of this method recognizes the same simple accessor methods and array accessor methods as -valueForKey:â€™s, and follows the same direct instance variable access policies, but always returns a mutable collection proxy object instead of the immutable collection that -valueForKey: would return.</p></blockquote><h3 id="KVOåº•å±‚åŸç†"><a href="#KVOåº•å±‚åŸç†" class="headerlink" title="#KVOåº•å±‚åŸç†?"></a>#KVOåº•å±‚åŸç†?</h3><p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html#//apple_ref/doc/uid/20002307-BAJEAIEE">å®˜æ–¹æ–‡æ¡£</a> è§£é‡Šå¦‚ä¸‹ï¼š<br><br/></p><p>Automatic key-value observing is implemented using a technique called isa-swizzling.<br><br/></p><p>The isa pointer, as the name suggests, points to the objectâ€™s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.<br><br/></p><p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.<br><br/></p><p>You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.<br><br/></p><p>ç®€è€Œè¨€ä¹‹ï¼Œè‹¹æœä½¿ç”¨äº†ä¸€ç§ isa äº¤æ¢çš„æŠ€æœ¯ã€‚å½“ä¸€ä¸ªç±»çš„å±æ€§è¢«è§‚å¯Ÿæ—¶ï¼ŒRuntime ä¼šåŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªä¸­é—´ç±»ï¼Œå°†åŸç±»çš„ isa æŒ‡é’ˆæŒ‡å‘æ­¤ä¸­é—´ç±»ã€‚ä¸­é—´ç±»ä¸­é‡å†™åŸç±»è¢«è§‚å¯Ÿå±æ€§çš„ setter æ–¹æ³•ï¼Œè¿™æ ·ç»™åŸç±»å±æ€§èµ‹å€¼æ—¶è°ƒç”¨çš„å®é™…ä¸Šæ˜¯ä¸­é—´ç±»çš„ setter æ–¹æ³•ã€‚é‡å†™çš„ setter æ–¹æ³•ä¼šè°ƒç”¨ [super setValue:newName forKey:@â€nameâ€] å¹¶åœ¨æ­¤æ–¹æ³•å‰ååˆ†åˆ«æ’å…¥ [self willChangeValueForKey:@â€œnameâ€] å’Œ [self didChangeValueForKey:@â€nameâ€]ï¼Œä»¥é€šçŸ¥è§‚å¯Ÿå¯¹è±¡å€¼çš„æ”¹å˜ã€‚<br><br/></p><p>ä»¥ä¸Šé¢æ¡ˆä¾‹ä¸­çš„ Model ä¸ºä¾‹ï¼Œå½“ name å±æ€§è¢«è§‚å¯Ÿåï¼ŒaModel å¯¹è±¡çš„ isa æŒ‡é’ˆè¢«æŒ‡å‘äº†ä¸€ä¸ªæ–°å»ºçš„ Model çš„ä¸­é—´ç±» NSKVONotifying_Modelï¼Œè¿™ä¸ªä¸­é—´ç±»é‡å†™äº†è¢«è§‚å¯Ÿå€¼çš„ setter æ–¹æ³•å’Œ class æ–¹æ³•ã€dealloc åŠ _isKVO æ–¹æ³•ï¼Œç„¶åä½¿ aModel å¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªæ–°å»ºçš„ç±»ã€‚æ‰€ä»¥äº‹å®ä¸Š aModel å˜ä¸ºäº† NSKVONotifying_Model çš„å®ä¾‹å¯¹è±¡ï¼Œæ‰§è¡Œæ–¹æ³•è¦ä»è¿™ä¸ªç±»çš„æ–¹æ³•åˆ—è¡¨é‡Œæ‰¾ã€‚<br><br/></p><p>è‹¹æœè­¦å‘Šæˆ‘ä»¬ï¼Œé€šè¿‡ isa è·å–ç±»çš„ç±»å‹æ˜¯ä¸å¯é çš„ï¼Œé€šè¿‡ class æ–¹æ³•æ‰èƒ½å¾—åˆ°æ­£ç¡®çš„ç±»ã€‚</p><h3 id="ä¸»åŠ¨è§¦å‘KVO"><a href="#ä¸»åŠ¨è§¦å‘KVO" class="headerlink" title="#ä¸»åŠ¨è§¦å‘KVO"></a>#ä¸»åŠ¨è§¦å‘KVO</h3><p>å¦‚ä¸Šæ‰€è¿°ï¼Œå½“å±æ€§å‘ç”Ÿå˜åŒ–æ—¶èƒ½æ”¶åˆ°é€šçŸ¥ï¼Œæ˜¯å› ä¸º Runtime ä½¿ç”¨ <code>isa-swizzling</code> æŠ€æœ¯åœ¨ä¸­é—´ç±»ä¸­å±æ€§çš„ <code>setter</code> èµ‹å€¼è¯­å¥å‰åä¸»åŠ¨è°ƒç”¨äº†ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š </p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(void)</span>willChangeValueForKey:<span class="hljs-params">(NSString *)</span>key;<br>- <span class="hljs-params">(void)</span>didChangeValueForKey:<span class="hljs-params">(NSString *)</span>key;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬éœ€è¦å±æ€§å€¼çš„æ”¹å˜åœ¨ç¬¦åˆæŸä¸ªæ¡ä»¶æ—¶æ‰è§¦å‘ KVO æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ul><li>é‡å†™ç±»æ–¹æ³• +automaticallyNotifiesObserversForKeyï¼Œç¦ç”¨ç›®æ ‡å±æ€§çš„ç³»ç»Ÿ KVO é€šçŸ¥ï¼›</li><li>å®šä¹‰å±æ€§å¹¶å£°æ˜åˆæˆè¯­å¥ï¼›</li><li>æä¾›å±æ€§çš„ getterã€setter å‡½æ•°å¹¶åœ¨ setter ä¸­æˆå‘˜å˜é‡èµ‹å€¼å‰ååŠ å…¥ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•ï¼›</li><li>æ³¨å†Œç›‘å¬äº‹ä»¶å¹¶é‡å†™å›è°ƒå‡½æ•°ï¼›</li></ul><p>#å®Œæ•´ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Person</span> : <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">NSCoding</span>&gt;</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Person</span></span><br><br><span class="hljs-keyword">@synthesize</span> name = _name; <span class="hljs-comment">//åˆæˆ</span><br><br><span class="hljs-comment">//åˆ¤æ–­ç›®æ ‡å±æ€§</span><br>+ (<span class="hljs-type">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="hljs-built_in">NSString</span> *)key<br>&#123;<br>    <span class="hljs-keyword">if</span> ([key isEqualToString:<span class="hljs-string">@&quot;name&quot;</span>]) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<span class="hljs-comment">//ç¦ç”¨ç³»ç»Ÿçš„é€šçŸ¥ï¼Œä¸ç„¶ä¼šè§¦å‘ä¸¤æ¬¡ KVO å›è°ƒ</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br><span class="hljs-comment">//è‡ªå·±å®ç°å­˜å–</span><br>- (<span class="hljs-built_in">NSString</span> *)name&#123;<br>    <span class="hljs-keyword">return</span> _name;<br>&#125;<br><br>-(<span class="hljs-type">void</span>)setName:(<span class="hljs-built_in">NSString</span> *)name&#123;<br>    <br>    <span class="hljs-keyword">if</span> ([name isEqualToString:<span class="hljs-string">@&quot;David&quot;</span>]) &#123;<span class="hljs-comment">//è®¾ç½®æ¡ä»¶</span><br>        [<span class="hljs-keyword">self</span> willChangeValueForKey:<span class="hljs-string">@&quot;name&quot;</span>];<span class="hljs-comment">// ä¸»åŠ¨è§¦å‘é€šçŸ¥</span><br>        _name = name;<br>        <span class="hljs-comment">//å…¶ä»–ä¸šåŠ¡é€»è¾‘</span><br>        [<span class="hljs-keyword">self</span> didChangeValueForKey:<span class="hljs-string">@&quot;name&quot;</span>];<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        _name = name;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨å¹¶æŸ¥çœ‹ç»“æœï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-keyword">self</span>.person = [Person new];<br>    [<span class="hljs-keyword">self</span>.person addObserver:<span class="hljs-keyword">self</span> forKeyPath:<span class="hljs-string">@&quot;name&quot;</span> options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span> context:<span class="hljs-literal">nil</span>];<br>    <span class="hljs-keyword">self</span>.person.name = <span class="hljs-string">@&quot;David&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)observeValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath<br>                     ofObject:(<span class="hljs-type">id</span>)object<br>                       change:(<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSKeyValueChangeKey</span>,<span class="hljs-type">id</span>&gt; *)change<br>                      context:(<span class="hljs-type">void</span> *)context&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å­—æ®µ:%@, New:%@&quot;</span>,keyPath,change);<br>    [<span class="hljs-keyword">self</span>.person removeObserver:<span class="hljs-keyword">self</span> forKeyPath:<span class="hljs-string">@&quot;name&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æœºåˆ¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>KVC çš„åº•å±‚å®ç°</title>
    <link href="/2018/04/12/kvc.html"/>
    <url>/2018/04/12/kvc.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-KVCæ˜¯å•¥"><a href="#1-KVCæ˜¯å•¥" class="headerlink" title="1.KVCæ˜¯å•¥?"></a>1.KVCæ˜¯å•¥?</h3><p>é”®å€¼ç¼–ç ï¼ˆkey value codingï¼‰æ˜¯ä¸€ç§å¯ä»¥é€šè¿‡å­—ç¬¦ä¸²çš„åå­—ï¼ˆkeyï¼‰æ¥è®¿é—®ç±»å±æ€§çš„æœºåˆ¶ã€‚åŒºåˆ«äºé€šè¿‡è°ƒç”¨Setterã€Getteræ¥è®¿é—®å±æ€§çš„æ–¹æ³•ã€‚</p><h3 id="2-å•¥ç”¨"><a href="#2-å•¥ç”¨" class="headerlink" title="2.å•¥ç”¨?"></a>2.å•¥ç”¨?</h3><p>é€šå¸¸æˆ‘ä»¬è¦è®¿é—®ä¸€ä¸ªç±»ä¸­å±æ€§çš„å€¼æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç‚¹è¯­æ³•ï¼ˆå¦‚ people.nameï¼‰ã€‚ä½†å½“ä½ æƒ³è®¿é—®ç§æœ‰å±æ€§æˆ–æˆå‘˜å˜é‡æ—¶ï¼Œç‚¹è¯­æ³•å°±æ²¡ç”¨äº†ã€‚è€Œæœ‰äº† KVC é—®é¢˜å°±è¿åˆƒè€Œè§£ã€‚</p><ul><li><strong>å¸¸ç”¨æ–¹æ³•?</strong></li></ul><p><code>NSKeyValueCoding.h</code>ä¸­æœ‰ä¸ª NSObject çš„åˆ†ç±»ï¼š<code>NSObject(NSKeyValueCoding)</code>ï¼Œå…¶ä¸­å®šä¹‰äº†ä»¥ä¸‹æ–¹æ³•ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(id)</span>valueForKey:<span class="hljs-params">(NSString *)</span>key;<br>- <span class="hljs-params">(id)</span>valueForKeyPath:<span class="hljs-params">(NSString *)</span>keyPath;<br>- <span class="hljs-params">(void)</span>setValue:<span class="hljs-params">(nullable id)</span>value forKey:<span class="hljs-params">(NSString *)</span>key;<br>- <span class="hljs-params">(void)</span>setValue:<span class="hljs-params">(nullable id)</span>value forKeyPath:<span class="hljs-params">(NSString *)</span>keyPath;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ-valueForKey: ä¸ -valueForKeyPath:åœ¨ä¸€èˆ¬çš„å±æ€§è®¿é—®æ—¶ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚ä½†è¦è®¿é—®ç±»ä¼¼ä¸‹é¢æ¡ˆä¾‹1ä¸­ Student.index è¿™ç§å­å±æ€§æ—¶ï¼Œå°±åªèƒ½ä½¿ç”¨åè€…ï¼Œä½¿ç”¨å‰è€…ç¼–è¯‘æ—¶æ²¡é—®é¢˜ä½†è¿è¡Œæ—¶ä¼šå´©æºƒã€‚<br><br/></p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@interface</span> <span class="hljs-attribute">Student </span>: NSObject<br><span class="hljs-variable">@property</span> (nonatomic,assign) int index;<br><span class="hljs-variable">@end</span><br><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">People </span>: NSObject<br>&#123;<br>    <span class="hljs-selector-tag">NSString</span> *<span class="hljs-selector-tag">name</span>;<span class="hljs-comment">//ç§æœ‰å˜é‡</span><br>    <span class="hljs-selector-tag">Student</span> *<span class="hljs-selector-tag">student</span>;<br>&#125;<br>@<span class="hljs-selector-tag">end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;People.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Student</span></span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">People</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *eMail;<span class="hljs-comment">//ç§æœ‰å±æ€§</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">People</span></span><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-symbol">People</span> *people = [<span class="hljs-symbol">People</span> new];<br><span class="hljs-symbol">Student</span> *student = [<span class="hljs-symbol">Student</span> new];<br><br>[people setValue:@<span class="hljs-string">&quot;David&quot;</span> forKey:@<span class="hljs-string">&quot;name&quot;</span>];<br>[people setValue:@<span class="hljs-string">&quot;email@&quot;</span> forKey:@<span class="hljs-string">&quot;eMail&quot;</span>];<br>[people setValue:student forKey:@<span class="hljs-string">&quot;student&quot;</span>];<br>[people setValue:@(<span class="hljs-number">101</span>) forKeyPath:@<span class="hljs-string">&quot;student.index&quot;</span>];<br><br><span class="hljs-symbol">NSString</span> *name = [people valueForKey:@<span class="hljs-string">&quot;name&quot;</span>];<br>int index = [[people valueForKeyPath:@<span class="hljs-string">&quot;student.index&quot;</span>] intValue];<br><span class="hljs-symbol">NSLog</span>(@<span class="hljs-string">&quot;++++name:%@ï¼Œindex:%d&quot;</span>,name,index);<br></code></pre></td></tr></table></figure><h3 id="3-åº•å±‚çš„åŸç†"><a href="#3-åº•å±‚çš„åŸç†" class="headerlink" title="3.åº•å±‚çš„åŸç†?"></a>3.åº•å±‚çš„åŸç†?</h3><p>åœ¨<code>NSKeyValueCoding.h</code>å¯¹<code>KVC</code>çš„å®ç°è¿‡ç¨‹æœ‰è¯¦ç»†çš„è§£é‡Šã€‚</p><h4 id="3-1-valueForKey"><a href="#3-1-valueForKey" class="headerlink" title="3.1.valueForKey:"></a>3.1.valueForKey:</h4><ol><li>åœ¨æ–¹æ³•æ¥æ”¶è€…çš„ç±»ä¸­å…ˆæŒ‰ç…§ getKeyï¼Œkeyï¼ŒisKey çš„é¡ºåºæŸ¥æ‰¾ getter æ–¹æ³•ï¼Œæ‰¾åˆ°ç›´æ¥è°ƒç”¨ã€‚å¦‚æœæ˜¯ BOOLï¼Œint ç­‰å†…å»ºå€¼ç±»å‹ï¼Œä¼šåš NSNumber ç±»å‹è½¬åŒ–ã€‚</li><li>æ²¡æœ‰æ‰¾åˆ°çš„è¯ï¼Œå¦‚æœæ–¹æ³•æ¥æ”¶è€…çš„ accessInstanceVariablesDirectly å±æ€§è¿”å›YESï¼ˆé»˜è®¤è¿”å›YESï¼‰ï¼Œé‚£ä¹ˆä¾æ¬¡æœç´¢ç¬¦åˆ_keyï¼Œ_isKeyï¼Œkeyï¼ŒisKey æ ¼å¼çš„æˆå‘˜å˜é‡ï¼Œæ‰¾åˆ°åè¿”å›å®ƒçš„å€¼ã€‚</li><li>å†æ²¡æ‰¾åˆ°çš„è¯ï¼Œä¼šè°ƒç”¨ -valueForUndefinedKeyï¼Œåœ¨æ²¡è¢«é‡å†™çš„æƒ…å†µä¸‹ï¼Œæ­¤æ–¹æ³•é»˜è®¤æŠ›å‡º NSUndefinedKeyException å¼‚å¸¸ã€‚</li></ol><h4 id="3-2-setValue-forKey"><a href="#3-2-setValue-forKey" class="headerlink" title="3.2.setValue:forKey:"></a>3.2.setValue:forKey:</h4><ol><li>é¦–å…ˆåœ¨æ–¹æ³•æ¥æ”¶è€…æ‰€å±çš„ç±»ä¸­æœç´¢ setKey: æ ¼å¼çš„æ–¹æ³•å¹¶æ£€æµ‹å…¶å‚æ•°ç±»å‹ã€‚å¦‚æœå‚æ•°ç±»å‹ç¬¦åˆåˆ™ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•ï¼›å¦‚æœå‚æ•°ä¸æ˜¯å¯¹è±¡æŒ‡é’ˆç±»å‹ä½†å€¼ä¸ºnilï¼Œåˆ™ä¼šè°ƒç”¨ -setNilValueForKey: å¹¶æŠ›å‡ºå¼‚å¸¸ï¼›</li><li>ç¬¬ä¸€æ­¥ä¸­æ²¡æœ‰æ‰¾åˆ°æ ¼å¼ç›¸ç¬¦çš„æ–¹æ³•çš„è¯ï¼Œå¦‚æœ accessInstanceVariablesDirectly å±æ€§è¿”å› YESã€‚é‚£ä¹ˆå°±å»ä¾æ¬¡æŸ¥è¯¢ç¬¦åˆ_keyï¼Œ_isKeyï¼Œkeyï¼ŒisKey æ ¼å¼çš„æˆå‘˜å˜é‡ï¼Œæ‰¾åˆ°åç»™å®ƒèµ‹å€¼ã€‚</li><li>å¦‚æœä»æ²¡æ‰¾åˆ°ç¬¦åˆçš„æˆå‘˜å˜é‡ï¼Œåˆ™è°ƒç”¨ setValue:forUnderfinedKey: å¹¶æŠ›å‡º NSUndefinedKeyException å¼‚å¸¸ã€‚</li></ol><p>ç”±ä¸Šè¿°è¿‡ç¨‹å¯ä»¥å¾—çŸ¥ï¼š<code>valueForKey</code>ä¼šè°ƒç”¨å±æ€§çš„<code>getter</code>ï¼Œ<code>setValue:forKey:</code>ä¼šè°ƒç”¨å±æ€§çš„<code>setter</code>å‡½æ•°ã€‚</p><p>#ç¤ºä¾‹2ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@interface</span> <span class="hljs-attribute">Model </span>: NSObject<br><span class="hljs-variable">@property</span> (nonatomic, strong) NSString *_modelString;<br><span class="hljs-variable">@end</span><br><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">People </span>: NSObject<br><span class="hljs-variable">@property</span> (nonatomic, strong) NSString *stringA;<br><span class="hljs-variable">@property</span> (nonatomic, strong) Model *modelA;<br><span class="hljs-variable">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;People.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Model</span></span><br>- (<span class="hljs-type">void</span>)set_modelString:(<span class="hljs-built_in">NSString</span> *)_modelString<br>&#123;<br>    __modelString = _modelString;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œ setter _modelString&quot;</span>);<br>&#125;<br>- (<span class="hljs-type">void</span>)setModelString:(<span class="hljs-built_in">NSString</span> *)modelString<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œ setter modelString&quot;</span>);<br>&#125;<br>- (<span class="hljs-type">void</span>)setNoExist1:(<span class="hljs-built_in">NSString</span> *)noExist<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œ setter noExist1 &quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">People</span></span><br><br>- (<span class="hljs-type">void</span>)setStringA:(<span class="hljs-built_in">NSString</span> *)stringA<br>&#123;<br>    _stringA = stringA;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œ setter stringA&quot;</span>);<br>&#125;<br>- (<span class="hljs-keyword">instancetype</span>)init<br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) &#123;<br>        <span class="hljs-keyword">self</span>.modelA = [[Model alloc] init];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)kvcTest<br>&#123;<br>    People *apeo = [[People alloc] init];<br>    <span class="hljs-comment">//è°ƒç”¨äº†setter</span><br>    apeo.stringA = <span class="hljs-string">@&quot;stringA setter&quot;</span>;<br>    <span class="hljs-comment">//ä¹Ÿè°ƒç”¨äº†setter</span><br>    â‘ [apeo setValue:<span class="hljs-string">@&quot;stringA KVC&quot;</span> forKey:<span class="hljs-string">@&quot;stringA&quot;</span>];<br>    <span class="hljs-comment">//æ²¡è°ƒç”¨setter ä½†æœ€ç»ˆèµ‹å€¼ç»™äº†æ­¤å±æ€§å¯¹åº”çš„æˆå‘˜å˜é‡_stringA</span><br>    â‘¡[apeo setValue:<span class="hljs-string">@&quot;_stringA KVC&quot;</span> forKey:<span class="hljs-string">@&quot;_stringA&quot;</span>]; <br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++apeo.stringA å€¼: %@&quot;</span>, apeo.stringA);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++++++++++++++++++++++++++++&quot;</span>);<br>    <br>    <span class="hljs-comment">// è°ƒç”¨-set_modelString:</span><br>    â‘¢[apeo setValue:<span class="hljs-string">@&quot;_modelString kvc&quot;</span> forKeyPath:<span class="hljs-string">@&quot;modelA._modelString&quot;</span>];<br>    <span class="hljs-comment">//ä¸å­˜åœ¨çš„å±æ€§ï¼Œä½†ä¼šè°ƒç”¨-setModelString:å‡½æ•°</span><br>    â‘£[apeo setValue:<span class="hljs-string">@&quot;modelString kvc&quot;</span> forKeyPath:<span class="hljs-string">@&quot;modelA.modelString&quot;</span>];<br>    <span class="hljs-comment">//æ²¡è°ƒç”¨setter ä½†æœ€ç»ˆèµ‹å€¼ç»™äº†modelAçš„å±æ€§å¯¹åº”çš„æˆå‘˜å˜é‡_modelString</span><br>    â‘¤[apeo setValue:<span class="hljs-string">@&quot;__modelString kvc&quot;</span> forKeyPath:<span class="hljs-string">@&quot;modelA.__modelString&quot;</span>];<br>    <br>    <span class="hljs-comment">//ä¸å­˜åœ¨çš„å±æ€§ ä½†ä¼šè°ƒç”¨å…¶setterå‡½æ•°-setNoExist1:</span><br>    â‘¥[apeo setValue:<span class="hljs-string">@&quot;noExist1&quot;</span> forKeyPath:<span class="hljs-string">@&quot;modelA.noExist1&quot;</span>];<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++apeo.modelA._modelString å€¼: %@&quot;</span>, apeo.modelA._modelString);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++++++++++++++++++++++++++++&quot;</span>);<br>    <br>    â‘¦<span class="hljs-built_in">NSString</span> *s1 = [apeo valueForKeyPath:<span class="hljs-string">@&quot;modelA._modelString&quot;</span>];<br>    â‘§<span class="hljs-built_in">NSString</span> *s2 = [apeo valueForKeyPath:<span class="hljs-string">@&quot;modelA.modelString&quot;</span>];<br>    â‘¨<span class="hljs-built_in">NSString</span> *s3 = [apeo valueForKeyPath:<span class="hljs-string">@&quot;modelA.__modelString&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++s1:%@ s2:%@ s3:%@&quot;</span>,s1,s2,s3);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code">+++</span>+æ‰§è¡Œ setter stringA<br><span class="hljs-code">+++</span>+æ‰§è¡Œ setter stringA<br><span class="hljs-section">++++apeo.stringA å€¼: _stringA KVC</span><br><span class="hljs-section">++++++++++++++++++++++++++++++</span><br><span class="hljs-code">+++</span>+æ‰§è¡Œ setter <span class="hljs-emphasis">_modelString</span><br><span class="hljs-emphasis">++++æ‰§è¡Œ setter modelString</span><br><span class="hljs-emphasis">++++æ‰§è¡Œ setter noExist1</span><br><span class="hljs-emphasis">++++apeo.modelA._modelString å€¼: __modelString kvc</span><br><span class="hljs-emphasis">++++++++++++++++++++++++++++++</span><br><span class="hljs-emphasis">++++s1:__modelString kvc s2:__modelString kvc s3:__</span>modelString kvc<br></code></pre></td></tr></table></figure><p>æ—¥å¿—æ˜¾ç¤ºï¼šâ‘ ~â‘¨å…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼›å…¶ä¸­â‘ â‘¢â‘£â‘¥ æ‰§è¡Œäº†setteræ–¹æ³•ï¼Œâ‘¦â‘§æ‰§è¡Œäº†getteræ–¹æ³•ï¼Œâ‘¡â‘¤â‘¨ç›´æ¥è®¿é—®çš„å®ä¾‹å˜é‡ã€‚</p><h4 id="3-3-å°ç»“"><a href="#3-3-å°ç»“" class="headerlink" title="3.3.å°ç»“"></a>3.3.å°ç»“</h4><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>id objectA = objectB.value2</code>æ—¶æ˜¯å¦ä»£è¡¨ objectB æœ‰ä¸€ä¸ª value2<code>å±æ€§</code>å‘¢ï¼Ÿå®é™…ä¸Šä¸ä¸€å®šï¼Œä¾‹å¦‚<code>object.class</code>ï¼ŒNSObject ä¸­ å¹¶æ²¡æœ‰<code>class</code>å±æ€§ï¼Œåªæœ‰ä¸€ä¸ª<code>class</code>æ–¹æ³•ã€‚<br><br/></p><p>OCçš„ç‚¹è¯­æ³•ä¸­ï¼Œ<code>.</code>è¡¨ç¤ºè°ƒç”¨æ–¹æ³•ï¼Œå³<code>.</code>æ“ä½œåªæ˜¯å»å¯»æ‰¾ä¸€ä¸ªåç§°åŒ¹é…å‚æ•°åŒ¹é…çš„æ–¹æ³•ã€‚æˆ‘ä»¬ä¹ ä»¥ä¸ºå¸¸çš„å±æ€§è°ƒç”¨åªæ˜¯å› ä¸ºå±æ€§åˆšå¥½æœ‰<code>getter</code>ï¼Œ<code>setter</code>æ–¹æ³•ç¬¦åˆè¦æ±‚è€Œå·²ã€‚å¦‚æœ<code>.</code>è¡¨è¾¾å¼åœ¨<code>=</code>å·¦è¾¹ï¼Œåˆ™è¯¥å±æ€§çš„<code>setter</code>æ–¹æ³•è¢«è°ƒç”¨ï¼›å¦‚æœ<code>.</code>è¡¨è¾¾å¼åœ¨<code>=</code>çš„å³è¾¹ï¼Œåˆ™å±æ€§çš„<code>getter</code>æ–¹æ³•è¢«è°ƒç”¨ã€‚</p><h3 id="KVCä¸é›†åˆè¿ç®—ç¬¦"><a href="#KVCä¸é›†åˆè¿ç®—ç¬¦" class="headerlink" title="#KVCä¸é›†åˆè¿ç®—ç¬¦"></a>#KVCä¸é›†åˆè¿ç®—ç¬¦</h3><p>å¤šæ•°æƒ…å†µä¸‹ï¼Œ<code>keyPath</code>è¢«ç”¨æ¥è¯»å–å¯¹è±¡ä¸­å­å¯¹è±¡çš„æŸä¸ªå±æ€§ï¼Œå¦‚ç¤ºä¾‹1ä¸­çš„<code>[people valueForKeyPath:@&quot;student.index&quot;]</code>ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè‹¹æœè¿˜å°†æ­¤æ–¹æ³•ç”¨åœ¨äº†é›†åˆä¸­ï¼Œç”¨ä»¥å®ç°æŸäº›å¸¸è§çš„é›†åˆè¿ç®—ï¼Œå¦‚æ±‚æœ€å¤§å€¼ã€æœ€å°å€¼ã€æ±‚å’Œç­‰ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¦ä»‹ç»çš„<code>é›†åˆè¿ç®—ç¬¦</code>åœ¨<code>KVC</code>ä¸­çš„åº”ç”¨ã€‚</p><blockquote><p>When you send a key-value coding compliant object the valueForKeyPath: message, you can embed a collection operator in the key path. A collection operator is one of a small list of keywords preceded by an at sign (@) that specifies an operation that the getter should perform to manipulate the data in some way before returning it. The default implementation of valueForKeyPath: provided by NSObject implements this behavior.</p></blockquote><br/><p>æˆ‘ä»¬å¯ä»¥åœ¨<code>keyPath</code>ä¸­åŠ å…¥<code>é›†åˆè¿ç®—ç¬¦</code>ï¼Œå®ƒä»¬ä»¥<code>@</code>å¼€å¤´ï¼Œç”¨æ¥æŒ‡å®šå¯¹æ•°æ®çš„æŸç§æ“ä½œï¼Œæœ€ç»ˆè¿”å›å¤„ç†åçš„ç»“æœã€‚å…·ä½“æ ¼å¼ä¸ºï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_keypath.jpg" alt="keypath"></p><p>æ ¼å¼è¯´æ˜ï¼š</p><ul><li>å·¦è¾¹ï¼šå°†è¦æ‰§è¡Œè¿ç®—çš„é›†åˆï¼›</li><li>ä¸­é—´ï¼šè¿ç®—ç¬¦ï¼›</li><li>å³è¾¹ï¼šé›†åˆä¸­å¯¹è±¡çš„å±æ€§ï¼›</li></ul><p>å¦‚æœæ˜¯æ•°ç»„è°ƒç”¨äº†<code>valueForKeyPath</code>ï¼Œåˆ™å·¦è¾¹éƒ¨åˆ†å¯ä»¥çœç•¥ï¼›<br><br/></p><p>è¿ç®—ç¬¦ä¸ºæ•°ç»„çš„<code>count</code>æ—¶å³è¾¹çš„éƒ¨åˆ†å¯ä»¥å¿½ç•¥ï¼Œå…¶ä»–è¿ç®—çš„å³è¾¹ä¸èƒ½ä¸ºç©ºã€‚<br><br/></p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//é“¶è¡Œå¡</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Card</span> : <span class="hljs-title">NSObject</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">int</span> cardNumber; <span class="hljs-comment">// ç¼–å·</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) <span class="hljs-type">float</span> money;    <span class="hljs-comment">// ä½™é¢</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//ç”¨æˆ·</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Card.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">User</span> : <span class="hljs-title">NSObject</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) <span class="hljs-built_in">NSInteger</span> age; <span class="hljs-comment">//å¹´é¾„</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>) <span class="hljs-built_in">NSArray</span> *cardArr; <span class="hljs-comment">//æ‹¥æœ‰çš„é“¶è¡Œå¡</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//è°ƒç”¨</span><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    Card *card1 = [Card new];<br>    card1.cardNumber = <span class="hljs-number">100</span>;<br>    card1.money = <span class="hljs-number">1000</span>;<br>    <br>    Card *card2 = [Card new];<br>    card2.cardNumber = <span class="hljs-number">101</span>;<br>    card2.money = <span class="hljs-number">2000</span>;<br>    <br>    User *user = [User new];<br>    user.age = <span class="hljs-number">20</span>;<br>    user.cardArr = @[card1,card2];<br>    <br>    User *user2 = [User new];<br>    user2.age = <span class="hljs-number">30</span>;<br>    <br>    <span class="hljs-built_in">NSArray</span> *userArr = @[user,user2];<br>    <br>    <span class="hljs-type">int</span> min = [[user valueForKeyPath:<span class="hljs-string">@&quot;cardArr.@min.money&quot;</span>] intValue];<br>    <span class="hljs-type">int</span> max = [[user valueForKeyPath:<span class="hljs-string">@&quot;cardArr.@max.money&quot;</span>] intValue];<br>    <span class="hljs-type">int</span> sum = [[user valueForKeyPath:<span class="hljs-string">@&quot;cardArr.@sum.money&quot;</span>] intValue];<br>    <span class="hljs-type">int</span> avg = [[user valueForKeyPath:<span class="hljs-string">@&quot;cardArr.@avg.money&quot;</span>] intValue];<br>    <span class="hljs-type">int</span> count = [[userArr valueForKeyPath:<span class="hljs-string">@&quot;cardArr.@count&quot;</span>] intValue];<br>    <span class="hljs-comment">//ç›´æ¥å¯¹æ•°ç»„è¿›è¡ŒæŸ¥è¯¢</span><br>    <span class="hljs-type">int</span> count2 = [[userArr valueForKeyPath:<span class="hljs-string">@&quot;@count&quot;</span>] intValue];<br>    <span class="hljs-type">int</span> maxAge = [[userArr valueForKeyPath:<span class="hljs-string">@&quot;@max.age&quot;</span>] intValue];<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹2ï¼šæ•°ç»„ä¸­æ•°å­—è¿ç®—</p><figure class="highlight stan"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stan">- (<span class="hljs-type">void</span>)kvcToSumArr<br>&#123;<br>    NSArray *<span class="hljs-type">array</span> = @[@<span class="hljs-string">&quot;1&quot;</span>,@<span class="hljs-string">&quot;2&quot;</span>, @<span class="hljs-string">&quot;3&quot;</span>];<br>    <span class="hljs-comment">// æœ€å¤§å€¼</span><br>    <span class="hljs-type">int</span> <span class="hljs-built_in">max</span> = [[<span class="hljs-type">array</span> valueForKeyPath:@<span class="hljs-string">&quot;@max.intValue&quot;</span>] intValue];<br>    <span class="hljs-comment">// æœ€å°å€¼</span><br>    <span class="hljs-type">int</span> <span class="hljs-built_in">min</span> = [[<span class="hljs-type">array</span> valueForKeyPath:@<span class="hljs-string">&quot;@min.intValue&quot;</span>] intValue];<br>    <span class="hljs-comment">// æ±‚å’Œ</span><br>    <span class="hljs-type">int</span> <span class="hljs-built_in">sum</span> = [[<span class="hljs-type">array</span> valueForKeyPath:@<span class="hljs-string">&quot;@sum.intValue&quot;</span>] intValue];<br>    <span class="hljs-comment">// å¹³å‡å€¼</span><br>    float avg = [[<span class="hljs-type">array</span> valueForKeyPath:@<span class="hljs-string">&quot;@avg.floatValue&quot;</span>] floatValue];<br>    <br>    NSLog(@<span class="hljs-string">&quot;+++Max:%d,Min:%d,Sum:%d,Avg:%f&quot;</span>,<span class="hljs-built_in">max</span>,<span class="hljs-built_in">min</span>,<span class="hljs-built_in">sum</span>,avg);<br>    <span class="hljs-comment">//è¾“å‡º+++Max:3,Min:1,Sum:6,Avg:2.000000</span><br>&#125;<br></code></pre></td></tr></table></figure><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueCoding/CollectionOperators.html">Â©Apple-KVC Using Collection Operators</a></p><p>#<a href="https://juejin.im/post/5ac5f4b46fb9a028d5675645">Â©æ˜é‡‘</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æœºåˆ¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>blockçš„å®ç°</title>
    <link href="/2018/03/15/block.html"/>
    <url>/2018/03/15/block.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-blockï¼š"><a href="#1-blockï¼š" class="headerlink" title="#1.blockï¼š"></a>#1.blockï¼š</h3><p>ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œ<code>block</code>æ˜¯å¸¦æœ‰è‡ªåŠ¨å˜é‡çš„<code>åŒ¿åå‡½æ•°</code>ï¼Œæ˜¯<code>é—­åŒ…</code>åœ¨ OC ä¸­çš„å®ç°ã€‚</p><h4 id="1-1-è¯­æ³•"><a href="#1-1-è¯­æ³•" class="headerlink" title="1.1.è¯­æ³•"></a>1.1.è¯­æ³•</h4><p>#blockè¡¨è¾¾å¼:</p><blockquote><p>^ è¿”å›å€¼ç±»å‹ (å‚æ•°åˆ—è¡¨) {è¡¨è¾¾å¼}</p></blockquote><p>#ç¤ºä¾‹1.1ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">^<span class="hljs-built_in">int</span>(<span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b) &#123;<br>    <span class="hljs-keyword">return</span> a * b;<br>&#125;;<br></code></pre></td></tr></table></figure><p>#blockç±»å‹å˜é‡:</p><blockquote><p>è¿”å›å€¼ç±»å‹ (^å˜é‡å)(å‚æ•°åˆ—è¡¨) &#x3D; Blockè¡¨è¾¾å¼</p></blockquote><p>#ç¤ºä¾‹1.2ï¼š</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-built_in">int</span> (^increment)(<span class="hljs-built_in">int</span>) = ^(<span class="hljs-built_in">int</span> <span class="hljs-keyword">count</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">count</span> + <span class="hljs-number">1</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>#blockç±»å‹å˜é‡ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼š</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">- (<span class="hljs-keyword">int</span>)blockAsParam:(<span class="hljs-keyword">int</span> (^)(<span class="hljs-keyword">int</span> a,<span class="hljs-keyword">int</span> b))ablock<br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">ablock</span><span class="hljs-params">(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>#blockç±»å‹å˜é‡ä½œä¸ºè¿”å›å€¼ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">- (<span class="hljs-built_in">int</span>(^)(<span class="hljs-built_in">int</span> a,<span class="hljs-built_in">int</span> b))blockAsReturnValue&#123;<br>    <span class="hljs-keyword">return</span> ^<span class="hljs-built_in">int</span> (<span class="hljs-built_in">int</span> x,<span class="hljs-built_in">int</span> y)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>#å®Œæ•´ç¤ºä¾‹1.3ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">UOBlocks</span> : <span class="hljs-title">NSObject</span></span><br>- (<span class="hljs-type">void</span>)callBlocks;<br>- (<span class="hljs-type">int</span>)blockAsParam:(<span class="hljs-type">int</span> (^)(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b))ablock;<span class="hljs-comment">//ä½œä¸ºå‚æ•°</span><br>- (<span class="hljs-type">int</span>(^)(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b))blockAsReturnValue;<span class="hljs-comment">//ä½œä¸ºè¿”å›å€¼</span><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;UOBlocks.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">int</span>(^multiBlock)(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b);<span class="hljs-comment">//å®å®šä¹‰</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">UOBlocks</span>()</span><br><span class="hljs-comment">//ä½œä¸ºå±æ€§</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) multiBlock mMultiBlock;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">int</span> (^clickBlock)(<span class="hljs-type">int</span> a);<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">UOBlocks</span></span><br><br>- (<span class="hljs-type">void</span>)callBlocks<br>&#123;<br>    <span class="hljs-keyword">self</span>.mMultiBlock = ^<span class="hljs-type">int</span>(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b) &#123;<br>        <span class="hljs-keyword">return</span> a * b;<br>    &#125;;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++%d&quot;</span>,<span class="hljs-keyword">self</span>.mMultiBlock(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>));<br>    <br>    <span class="hljs-keyword">self</span>.clickBlock = ^<span class="hljs-type">int</span>(<span class="hljs-type">int</span> a) &#123;<br>        <span class="hljs-keyword">return</span> a;<br>    &#125;;<br>    <span class="hljs-keyword">self</span>.clickBlock(<span class="hljs-number">5</span>);<br>&#125;<br><br>- (<span class="hljs-type">int</span>)blockAsParam:(<span class="hljs-type">int</span> (^)(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b))ablock<br>&#123;<br>    <span class="hljs-keyword">return</span> ablock(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>);<br>&#125;<br><br>- (<span class="hljs-type">int</span>(^)(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b))blockAsReturnValue&#123;<br>    <span class="hljs-keyword">return</span> ^<span class="hljs-type">int</span> (<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>#è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">UOBlocks *<span class="hljs-keyword">blocks </span>= [UOBlocks new];<br>[<span class="hljs-keyword">blocks </span>callBlocks];<br>[<span class="hljs-keyword">blocks </span><span class="hljs-keyword">blockAsParam:^int(int </span>a, int <span class="hljs-keyword">b) </span>&#123;<br>    return a * <span class="hljs-keyword">b;</span><br><span class="hljs-keyword"></span>&#125;];<br></code></pre></td></tr></table></figure><h3 id="2-ç±»å‹"><a href="#2-ç±»å‹" class="headerlink" title="#2.ç±»å‹"></a>#2.ç±»å‹</h3><ul><li><strong>NSGlobalBlock</strong></li></ul><p>å…¨å±€çš„é™æ€ blockã€‚ä¸ä¼šè®¿é—®ä»»ä½•å±€éƒ¨å˜é‡ã€‚</p><ul><li><strong>NSStackBlock</strong></li></ul><p>ä¿å­˜åœ¨æ ˆä¸­çš„ blockã€‚å†…éƒ¨è®¿é—®äº†æŸäº›å±€éƒ¨å˜é‡ï¼›å½“å‡½æ•°è¿”å›æ—¶ block ä¼šé”€æ¯ã€‚</p><ul><li><strong>NSMallocBlock</strong></li></ul><p>ä¿å­˜åœ¨å †ä¸­çš„ blockã€‚block è¢« copy æ—¶å…¶ isa æŒ‡é’ˆä¼šè¢«ä¿®æ”¹ä¸ºæ­¤ç±»å‹ï¼›å½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ block ä¼šé”€æ¯ã€‚<br><br/></p><p>ä¸‰ç§ç±»å‹çš„ block åˆ†åˆ«è¢«å­˜å‚¨åœ¨<code>å…¨å±€åŒº</code>ã€<code>æ ˆåŒº</code>ã€<code>å †åŒº</code>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨ ARC ç¯å¢ƒä¸­ï¼Œ block çš„ç±»å‹ä¼šä¸ä¸Šé¢çš„å®šä¹‰æœ‰æ‰€å·®å¼‚ï¼Œä¸”å¾€ä¸‹çœ‹~</p><h4 id="2-1-MRC"><a href="#2-1-MRC" class="headerlink" title="2.1.MRC"></a>2.1.MRC</h4><p><code>Xcode</code>-&gt;<code>Build Phases</code>-&gt;<code>Compile Sources</code>æ‰¾åˆ°<code>AppDelegate.m</code>ï¼Œè®¾ç½®<code>-fno-objc-arc</code>ï¼Œç¦ç”¨å…¶<code>ARC</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-type">int</span> aGlobalVar = <span class="hljs-number">10</span>;<br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^aCopyPropertyBlock)();<br><span class="hljs-keyword">@end</span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//On Global</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> aStaticVar = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-type">int</span> aConstVar = <span class="hljs-number">3</span>;<br>    <span class="hljs-type">void</span> (^aGlobalBlock)() = ^()&#123;<br>        aGlobalVar = <span class="hljs-number">1</span>;<br>        aStaticVar = <span class="hljs-number">3</span>;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%d&quot;</span>,aConstVar);<br>    &#125;;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aGlobalBlock info:%@&quot;</span>,aGlobalBlock);<br>    <br>    <span class="hljs-comment">//On Stack</span><br>    <span class="hljs-type">int</span> var = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">void</span> (^aStackBlock)() = ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++%d&quot;</span>,var);<br>    &#125;;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aStackBlock info:%@&quot;</span>,aStackBlock);<br>    <br>    <span class="hljs-comment">//copy</span><br>    <span class="hljs-type">void</span> (^aCopyBlock)() = [aGlobalBlock <span class="hljs-keyword">copy</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aCopyBlock info1:%@&quot;</span>,aCopyBlock);<br>    <br>    aCopyBlock = [aStackBlock <span class="hljs-keyword">copy</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aCopyBlock info2:%@&quot;</span>,aCopyBlock);<br>    <br>    <span class="hljs-comment">//property</span><br>    <span class="hljs-keyword">self</span>.aCopyPropertyBlock = ^&#123;<br>    &#125;;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aCopyPropertyBlock info1:%@&quot;</span>,<span class="hljs-keyword">self</span>.aCopyPropertyBlock);<br>    <br>    <span class="hljs-keyword">self</span>.aCopyPropertyBlock = aStackBlock;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aCopyPropertyBlock info2:%@&quot;</span>,<span class="hljs-keyword">self</span>.aCopyPropertyBlock);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">++aGlobalBlock info:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x10600a8f8</span>&gt;</span><br>++aStackBlock info:<span class="hljs-tag">&lt;<span class="hljs-name">__NSStackBlock__:</span> <span class="hljs-attr">0x7ffee9c35d30</span>&gt;</span><br>++aCopyBlock info1:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x10600a8f8</span>&gt;</span><br>++aCopyBlock info2:<span class="hljs-tag">&lt;<span class="hljs-name">__NSMallocBlock__:</span> <span class="hljs-attr">0x6000020a4ae0</span>&gt;</span><br>++aCopyPropertyBlock info1:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x10600a958</span>&gt;</span><br>++aCopyPropertyBlock info2:<span class="hljs-tag">&lt;<span class="hljs-name">__NSMallocBlock__:</span> <span class="hljs-attr">0x6000020bc990</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä»ç¤ºä¾‹åŠæ—¥å¿—å¯ä»¥çœ‹å‡º:</p><ul><li>æœªè®¿é—®ä»»ä½•å˜é‡ã€æˆ–è€…åªè®¿é—®äº†å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€å¸¸é‡çš„æ˜¯ <code>NSGlobalBlock</code>ï¼›</li><li>è®¿é—®äº†å±€éƒ¨å˜é‡çš„æ˜¯ <code>NSStackBlock</code>ï¼›</li><li>å¯¹ <code>NSGlobalBlock</code> çš„æ‹·è´è¿˜æ˜¯ <code>NSGlobalBlock</code>ï¼›</li><li>å¯¹ <code>NSStackBlock</code> çš„æ‹·è´å˜æˆäº† <code>NSMallocBlock</code>ï¼›</li><li>å¯¹äº <code>copy</code> ä¿®é¥°çš„ block å±æ€§ï¼Œå°†å…¶æŒ‡å‘ <code>NSStackBlock</code> ç±»å‹çš„ block2 æ—¶ï¼Œblock2 ä¼šè¢«æ‹·è´åˆ°å †åŒºï¼Œå˜æˆ <code>NSMallocBlock</code>ã€‚</li></ul><p><code>MRC</code>ç¯å¢ƒä¸­ block çš„ç±»å‹ä¸å‰é¢è®²åˆ°çš„å®šä¹‰ç›¸å»åˆï¼›å¦å¤–å¯¹äº block æ‹·è´åå¾—åˆ°çš„ç»“æœï¼Œå…¶ç±»å‹æ˜¯å¦å˜åŒ–ä¾æ®æº block è€Œå®šï¼Œ<strong>å¹¶ä¸æ˜¯æ‰€æœ‰çš„ block éƒ½ä¼šè¢«æ‹·è´åˆ°<code>å †ä¸Š</code></strong>~</p><h4 id="2-2-ARC"><a href="#2-2-ARC" class="headerlink" title="2.2.ARC"></a>2.2.ARC</h4><p>åˆ é™¤ä¹‹å‰åœ¨<code>AppDelegate.m</code>æ–‡ä»¶åçš„<code>-fno-objc-arc</code>ï¼Œå¯ç”¨<code>ARC</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^aCopyPropertyBlock)();<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-type">void</span> (^aStrongPropertyBlock)();<br><span class="hljs-keyword">@end</span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//On Global</span><br>    <span class="hljs-type">void</span> (^aGlobalBlock)() = ^()&#123;<br>    &#125;;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aGlobalBlock info:%@&quot;</span>,aGlobalBlock);<br>    <br>    <span class="hljs-comment">//On Stack</span><br>    <span class="hljs-type">int</span> var = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">void</span> (^aStackBlock)() = ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++%d&quot;</span>,var);<br>    &#125;;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aStackBlock info:%@&quot;</span>,aStackBlock);<br>    <br>    <span class="hljs-comment">//copy</span><br>    <span class="hljs-type">void</span> (^aCopyBlock)() = [aGlobalBlock <span class="hljs-keyword">copy</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aCopyBlock info1:%@&quot;</span>,aCopyBlock);<br>    <br>    aCopyBlock = [aStackBlock <span class="hljs-keyword">copy</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aCopyBlock info2:%@&quot;</span>,aCopyBlock);<br>    <br>    <span class="hljs-comment">//copy property</span><br>    <span class="hljs-keyword">self</span>.aCopyPropertyBlock = ^&#123;<br>    &#125;;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aCopyPropertyBlock info1:%@&quot;</span>,<span class="hljs-keyword">self</span>.aCopyPropertyBlock);<br>    <br>    <span class="hljs-keyword">self</span>.aCopyPropertyBlock = aStackBlock;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aCopyPropertyBlock info2:%@&quot;</span>,<span class="hljs-keyword">self</span>.aCopyPropertyBlock);<br>    <br>    <span class="hljs-comment">//strong property</span><br>    <span class="hljs-keyword">self</span>.aStrongPropertyBlock = ^&#123;<br>    &#125;;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aStrongPropertyBlock info1:%@&quot;</span>,<span class="hljs-keyword">self</span>.aStrongPropertyBlock);<br>    <br>    <span class="hljs-keyword">self</span>.aStrongPropertyBlock = aGlobalBlock;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aStrongPropertyBlock info2:%@&quot;</span>,<span class="hljs-keyword">self</span>.aStrongPropertyBlock);<br>    <br>    <span class="hljs-keyword">self</span>.aStrongPropertyBlock = aStackBlock;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aStrongPropertyBlock info3:%@&quot;</span>,<span class="hljs-keyword">self</span>.aStrongPropertyBlock);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml">++aGlobalBlock info:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x1001178f0</span>&gt;</span><br>++aStackBlock info:<span class="hljs-tag">&lt;<span class="hljs-name">__NSMallocBlock__:</span> <span class="hljs-attr">0x600003f5e160</span>&gt;</span><br>++aCopyBlock info1:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x1001178f0</span>&gt;</span><br>++aCopyBlock info2:<span class="hljs-tag">&lt;<span class="hljs-name">__NSMallocBlock__:</span> <span class="hljs-attr">0x600003f5e160</span>&gt;</span><br>++aCopyPropertyBlock info1:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x100117950</span>&gt;</span><br>++aCopyPropertyBlock info2:<span class="hljs-tag">&lt;<span class="hljs-name">__NSMallocBlock__:</span> <span class="hljs-attr">0x600003f5e160</span>&gt;</span><br>++aStrongPropertyBlock info1:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x100117990</span>&gt;</span><br>++aStrongPropertyBlock info2:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x1001178f0</span>&gt;</span><br>++aStrongPropertyBlock info3:<span class="hljs-tag">&lt;<span class="hljs-name">__NSMallocBlock__:</span> <span class="hljs-attr">0x600003f5e160</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä»ç¤ºä¾‹åŠæ—¥å¿—æ¥åˆ†æï¼š</p><ul><li>æœªè®¿é—®ä»»ä½•å˜é‡çš„æ˜¯ <code>NSGlobalBlock</code>ï¼›</li><li>è®¿é—®äº†å±€éƒ¨å˜é‡çš„æ˜¯ <code>NSMallocBlock</code>ï¼Œè€Œä¸å†æ˜¯ <code>NSStackBlock</code>ï¼›</li><li>å¯¹ <code>NSGlobalBlock</code> çš„æ‹·è´è¿˜æ˜¯ <code>NSGlobalBlock</code>ï¼›</li></ul><p><code>ARC</code>ä¸­ block çš„ç±»å‹ä¸å‰é¢çš„å®šä¹‰ä¸å†å®Œå…¨ç›¸åŒï¼Œå³ç¬¬äºŒæ¡ä¸­è®¿é—®äº†å±€éƒ¨å˜é‡çš„ block ä¸å†æ˜¯<code>NSStackBlock</code>ï¼Œè€Œæ˜¯<code>NSMallocBlock</code>ï¼ä¹Ÿå°±æ˜¯è¯´<code>ARC</code>ä¸­ åŸæœ¬åœ¨<code>æ ˆä¸Š</code>çš„ block ç°åœ¨ä¼šè¢«è‡ªåŠ¨æ‹·è´åˆ°<code>å †ä¸Š</code>ã€‚</p><h3 id="3-ä¿®é¥°ç¬¦"><a href="#3-ä¿®é¥°ç¬¦" class="headerlink" title="#3.ä¿®é¥°ç¬¦"></a>#3.ä¿®é¥°ç¬¦</h3><p><code>block</code>ä¹Ÿæ˜¯å¯¹è±¡ï¼Œä½œä¸ºå±æ€§æ—¶å…¶ä¿®é¥°ç¬¦å¯ä»¥ä½¿ç”¨<code>copy</code>å’Œ<code>strong</code>ã€‚ä¸è¿‡ï¼Œç›¸ä¿¡å¾ˆå¤šäººå’Œæˆ‘ä¸€æ ·ï¼Œä»å¼€å§‹æ¥å—çš„æ•™è‚²å°±æ˜¯ä½¿ç”¨<code>copy</code>ã€‚è¿™ä¸€ç« èŠ‚å°±æ¥æ¢è®¨ä¸ºä½•è¿™ä¹ˆåšï¼Œç¤ºä¾‹åˆ†ä¸º<code>MRC</code>å’Œ<code>ARC</code>ä¸¤ç§ç¯å¢ƒã€‚</p><h4 id="3-1-MRC"><a href="#3-1-MRC" class="headerlink" title="3.1.MRC"></a>3.1.MRC</h4><p>#ç¤ºä¾‹3.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">retain</span>) <span class="hljs-type">void</span> (^aBlock)();<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">void</span>)retBlock&#123;<br>    <span class="hljs-keyword">self</span>.aBlock = ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++aBlock&quot;</span>);<br>    &#125;;<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    [<span class="hljs-keyword">self</span> retBlock];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aBlock info1:%@&quot;</span>,<span class="hljs-keyword">self</span>.aBlock);<br>    <span class="hljs-keyword">self</span>.aBlock();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++</span><span class="hljs-comment">aBlock info1:</span>&lt;<span class="hljs-comment">__NSGlobalBlock__: 0x1032f78f8</span>&gt;<br><span class="hljs-literal">++++</span><span class="hljs-comment">aBlock</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸º<code>MRC</code>ç¯å¢ƒï¼Œblock å±æ€§<code>aBlock</code>å£°æ˜æ—¶ä½¿ç”¨çš„ä¿®é¥°ç¬¦ä¸º<code>retain</code>ã€‚å› ä¸ºæ²¡æœ‰å¼•ç”¨å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥æ­¤ block ä¸º<code>NSGlobalBlock</code>ç±»å‹ã€‚è¿è¡Œä¹‹åç¨‹åºæ­£å¸¸æ‰§è¡Œå’Œè¾“å‡ºæ—¥å¿—ï¼Œå³æˆ‘ä»¬<strong>èƒ½åœ¨å®šä¹‰åŸŸå¤–æ­£å¸¸è®¿é—®æ­¤<code>NSGlobalBlock</code>ç±»å‹çš„ block</strong>ã€‚<br><br/></p><p>#ç¤ºä¾‹3.2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)retBlock&#123;<br>    <span class="hljs-type">int</span> var = <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">self</span>.aBlock = ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++aBlock:%d&quot;</span>,var);<br>    &#125;;<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    [<span class="hljs-keyword">self</span> retBlock];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aBlock info1:%@&quot;</span>,<span class="hljs-keyword">self</span>.aBlock);<br>    <span class="hljs-keyword">self</span>.aBlock();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹å¯¹<code>retBlock</code>æ–¹æ³•ç¨ä½œä¿®æ”¹ï¼Œå³<code>aBlock</code>å¼•ç”¨äº†å±€éƒ¨å˜é‡ï¼Œå…¶ä»–ä»£ç ä¸å˜ã€‚è¿è¡Œä¹‹åç¨‹åºä¼šåœ¨â€œNSLog(@â€++aBlock info1:%@â€,self.aBlock);â€å¤„å´©æºƒï¼Œé”™è¯¯ä¿¡æ¯ä¸ºâ€œEXC_BAD_ACCESS (code&#x3D;1, address&#x3D;0x28)â€ï¼Œå³è®¿é—®äº†å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬<strong>ä¸èƒ½åœ¨å®šä¹‰åŸŸå¤–è®¿é—®<code>NSStackBlock</code>ç±»å‹çš„ block</strong>ï¼Œå³ä½¿å°†å…¶ä¿å­˜åˆ°é›†åˆä¸­ï¼Œåœ¨å®šä¹‰åŸŸå¤–è®¿é—®æ—¶ä¹Ÿä¼šå‡ºç°é‡æŒ‡é’ˆé—®é¢˜ã€‚<br><br/></p><p>è¿™æ˜¯å› ä¸º block å±æ€§<code>aBlock</code>è®¿é—®äº†å±€éƒ¨å˜é‡ï¼Œå±äº<code>NSStackBlock</code>ï¼Œè¢«åˆ†é…åœ¨<code>æ ˆä¸Š</code>ã€‚åŒæ—¶å…¶ä¿®é¥°ç¬¦ä¸º<code>retain</code>ï¼Œåªæ˜¯å¼•ç”¨å…³ç³»å¹¶ä¸æ”¹å˜å†…å­˜åˆ†å¸ƒã€‚æ ˆä¸Šçš„å˜é‡åœ¨å‡ºäº†å½“å‰å®šä¹‰åŸŸä¹‹åï¼Œéšæ—¶å¯èƒ½è¢«å›æ”¶ã€‚æ‰€ä»¥åœ¨å®šä¹‰åŸŸå¤–è®¿é—®æ­¤ block æ—¶ï¼Œ<code>aBlock</code>åœ¨æ ˆä¸Šçš„å†…å­˜å·²ç»è¢«å›æ”¶ï¼Œæœ€ç»ˆå‘ç”Ÿå´©æºƒã€‚å®é™…ä¸Šåœ¨å£°æ˜<code>aBlock</code>å±æ€§æ—¶ï¼Œç¼–è¯‘å™¨å°±å·²ç»ç»™å‡ºäº†è­¦ç¤ºâ€Retainâ€™ed block property does not copy the block - use copy attribute insteadâ€ã€‚<br><br/></p><p>#ç¤ºä¾‹3.3ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^aBlock)();<span class="hljs-comment">//ä¿®é¥°ç¬¦æ”¹ä¸ºcopy</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">void</span>)retBlock&#123;<br>    <span class="hljs-type">int</span> var = <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">self</span>.aBlock = ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++aBlock:%d&quot;</span>,var);<br>    &#125;;<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    [<span class="hljs-keyword">self</span> retBlock];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++aBlock info1:%@&quot;</span>,<span class="hljs-keyword">self</span>.aBlock);<br>    <span class="hljs-keyword">self</span>.aBlock();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­å±æ€§çš„ä¿®é¥°ç¬¦æ”¹ä¸º<code>copy</code>ï¼Œå…¶ä»–ä»£ç ä¸å˜ã€‚è¿è¡Œåè¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++</span><span class="hljs-comment">aBlock info1:</span>&lt;<span class="hljs-comment">__NSMallocBlock__: 0x600002adeb80</span>&gt;<br><span class="hljs-literal">++++</span><span class="hljs-comment">aBlock:10</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<code>copy</code>ä¿®é¥°ç¬¦æ—¶ï¼Œ<code>aBlock</code>ç±»å‹ä¸º<code>NSMallocBlock</code>ï¼Œå³è¢«æ‹·è´åˆ°äº†<code>å †ä¸Š</code>ï¼Œæ‰€ä»¥è¿™æ¬¡è®¿é—®<code>aBlock</code>æ—¶ï¼Œæ²¡æœ‰å†å‡ºç°é‡æŒ‡é’ˆé—®é¢˜ã€‚</p><h4 id="3-2-ARC"><a href="#3-2-ARC" class="headerlink" title="3.2.ARC"></a>3.2.ARC</h4><p>å†æ¥æ¢è®¨ä¸€ä¸‹<code>ARC</code>ç¯å¢ƒä¸­ block å±æ€§çš„ä¿®é¥°ç¬¦é—®é¢˜ã€‚<br><br/></p><p>#ç¤ºä¾‹3.4ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-type">void</span> (^aBlock1)();<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-type">void</span> (^aBlock2)();<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^aBlock3)();<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">void</span>)retBlock&#123;<br>    <span class="hljs-type">int</span> var = <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">self</span>.aBlock1 = ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++aBlock1&quot;</span>);<br>    &#125;;<br>    <span class="hljs-keyword">self</span>.aBlock2 = ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++aBlock2:%d&quot;</span>,var);<br>    &#125;;<br>    <span class="hljs-keyword">self</span>.aBlock3 = ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++aBlock3:%d&quot;</span>,var);<br>    &#125;;<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    [<span class="hljs-keyword">self</span> retBlock];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++info1:%@&quot;</span>,<span class="hljs-keyword">self</span>.aBlock1);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++info2:%@&quot;</span>,<span class="hljs-keyword">self</span>.aBlock2);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++info3:%@&quot;</span>,<span class="hljs-keyword">self</span>.aBlock3);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml">++info1:<span class="hljs-tag">&lt;<span class="hljs-name">__NSGlobalBlock__:</span> <span class="hljs-attr">0x10faa28f0</span>&gt;</span><br>++info2:<span class="hljs-tag">&lt;<span class="hljs-name">__NSMallocBlock__:</span> <span class="hljs-attr">0x6000029edbc0</span>&gt;</span><br>++info3:<span class="hljs-tag">&lt;<span class="hljs-name">__NSMallocBlock__:</span> <span class="hljs-attr">0x6000029ed9e0</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°<code>ARC</code>ç¯å¢ƒä¸‹ block å±æ€§ä¸è®ºæ˜¯å¦è®¿é—®äº†å±€éƒ¨å˜é‡ï¼Œåœ¨å…¶å®šä¹‰åŸŸå¤–éƒ½èƒ½æ­£å¸¸è®¿é—®å’Œè°ƒç”¨ã€‚ä¸”ä½¿ç”¨<code>strong</code>ä¿®é¥°ç¬¦æ—¶ block çš„ç±»å‹ä¹Ÿä¼šè‡ªåŠ¨å˜æˆ<code>NSMallocBlock</code>ï¼Œæ•ˆæœä¸ä½¿ç”¨<code>copy</code>æ—¶ä¸€æ ·ã€‚</p><h4 id="3-3-å°ç»“"><a href="#3-3-å°ç»“" class="headerlink" title="3.3.å°ç»“"></a>3.3.å°ç»“</h4><p>ç»¼ä¸Šï¼Œ<code>block</code>å±æ€§ä½¿ç”¨<code>copy</code>ä¿®é¥°ç¬¦æœ€ä¸ºç¨³å¦¥ï¼šæ²¡æœ‰å¼•ç”¨å±€éƒ¨å˜é‡çš„ block æ˜¯<code>NSGlobalBlock</code>ç±»å‹ï¼Œä½¿ç”¨<code>retain</code>ã€<code>strong</code>å’Œ<code>copy</code>ä¿®é¥°ç¬¦æ—¶ï¼Œéƒ½èƒ½æ­£å¸¸åœ¨å…¶å®šä¹‰åŸŸå¤–è®¿é—®å’Œè°ƒç”¨ï¼›å¼•ç”¨äº†å±€éƒ¨å˜é‡çš„ blockï¼ŒMRC ä¸­å±äº<code>NSStackBlock</code>ç±»å‹ï¼Œè¢«ä¿å­˜åœ¨<code>æ ˆä¸Š</code>éšæ—¶å¯èƒ½è¢«å›æ”¶ï¼Œä½¿ç”¨<code>retain</code>ä¿®é¥°ç¬¦æ—¶ï¼Œåœ¨å…¶å®šä¹‰åŸŸå¤–è°ƒç”¨ä¼šå‘ç”Ÿé‡æŒ‡é’ˆé—®é¢˜ï¼Œé™¤éä½¿ç”¨<code>copy</code>å°†å…¶æ‹·è´åˆ°<code>å †ä¸Š</code>ï¼›å¼•ç”¨äº†å±€éƒ¨å˜é‡çš„ blockï¼ŒARC ä¸­å±äº<code>NSMallocBlock</code>ç±»å‹ï¼Œè¢«åˆ†é…åœ¨<code>å †ä¸Š</code>ï¼Œä½¿ç”¨<code>strong</code>å’Œ<code>copy</code>ä¿®é¥°ç¬¦æ—¶éƒ½èƒ½åœ¨å…¶å®šä¹‰åŸŸå¤–æ­£å¸¸è®¿é—®å’Œè°ƒç”¨ï¼Œä¸”<code>strong</code>ä¿®é¥°çš„ block ä¼šè¢«è‡ªåŠ¨æ‹·è´åˆ°äº†<code>å †ä¸Š</code>ï¼Œæ•ˆæœä¸<code>copy</code>ä¸€æ ·ã€‚</p><h3 id="4-ç¼–è¯‘ä¸å®ç°"><a href="#4-ç¼–è¯‘ä¸å®ç°" class="headerlink" title="#4.ç¼–è¯‘ä¸å®ç°"></a>#4.ç¼–è¯‘ä¸å®ç°</h3><p>æ–°å»º command line tool å·¥ç¨‹ï¼Œåœ¨<code>main.m</code>æ–‡ä»¶ä¸­å†™ä¸€ä¸ª block çš„ç®€å•ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//main.m</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * argv[])</span> </span>&#123;<br>    @autoreleasepool &#123;<br>        <span class="hljs-type">int</span> count = <span class="hljs-number">10</span>;<br>        <span class="hljs-built_in">void</span> (^ blk)(<span class="hljs-type">void</span>) = ^()&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;varable in block:%d&quot;</span>,count);<br>        &#125;;<br>        <span class="hljs-built_in">blk</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ LLVM ç¼–è¯‘å™¨çš„<code>clang</code>å‘½ä»¤å°†æ­¤æ®µ OC ä»£ç è½¬æ¢æˆ C++ çš„æºä»£ç ï¼Œä»¥æŸ¥çœ‹ block çš„å…·ä½“å®ç°æ–¹å¼ï¼š</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">clang  -<span class="hljs-built_in">rewrite</span>-objc  main.m<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘åä¼šå¾—åˆ°ä¸€ä¸ª<code>main.cpp</code>æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ¯”è¾ƒé•¿ï¼Œè¯¦ç»†å†…å®¹å¯åˆ°è¿™é‡Œ <a href="https://davidlii.nos-eastchina1.126.net/code_main.cpp">æŸ¥çœ‹</a>ï¼Œè¿™é‡Œåªçœ‹é‡ç‚¹çš„éƒ¨åˆ†ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf">struct __block_impl &#123;<br>  void *isa<span class="hljs-comment">;</span><br>  int Flags<span class="hljs-comment">;</span><br>  int Reserved<span class="hljs-comment">;</span><br>  void *FuncPtr<span class="hljs-comment">;</span><br>&#125;<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ª<code>__block_impl</code>å°±æ˜¯ block çš„ç»“æ„ä½“ã€‚block åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šè¢«å½“åšç»“æ„ä½“è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œçš„<code>isa</code>å­—æ®µæŒ‡å‘ block æ‰€å±çš„ç±»å‹ï¼Œç¬¬#3ç« èŠ‚æœ‰å…·ä½“çš„ä»‹ç»ï¼›<code>FuncPtr</code>å­—æ®µè¡¨ç¤ºå‡½æ•°æŒ‡é’ˆï¼Œå³å¯¹åº”çš„æ˜¯ block ä¸­çš„<code>&#123; &#125;</code>éƒ¨åˆ†ï¼Œå®ƒä¼šæŒ‡å‘ä¸‹é¢ç¼–è¯‘å™¨ç»™æˆ‘ä»¬ç”Ÿæˆçš„é™æ€å‡½æ•°<code>__main_block_func_0</code>ã€‚</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sqf">static void <span class="hljs-variable">__main_block_func_0</span>(struct <span class="hljs-variable">__main_block_impl_0</span> *<span class="hljs-variable">__cself</span>) &#123;<br>    int <span class="hljs-built_in">count</span> = <span class="hljs-variable">__cself</span>-&gt;<span class="hljs-built_in">count</span>; <span class="hljs-comment">// bound by copy</span><br>    printf(<span class="hljs-string">&quot;varable in block:%d&quot;</span>,<span class="hljs-built_in">count</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªé™æ€å‡½æ•°<code>__xxx_block_func_0</code>æ˜¯ä¸€ä¸ªå‡½æ•°çš„å®ç°ï¼ˆå‰ç¼€ä¼šæ ¹æ®.mæ–‡ä»¶çš„å‘½åè€Œå˜)ï¼Œå¯¹åº”çš„æ˜¯ block ä¸­<code>&#123; &#125;</code>çš„éƒ¨åˆ†ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">struct</span> __main_block_impl_0 &#123;<br>  <span class="hljs-keyword">struct</span> __block_impl impl;<br>  <span class="hljs-keyword">struct</span> __main_block_desc_0* Desc;<br>  <span class="hljs-built_in">int</span> count;<br>  <span class="hljs-constructor">__main_block_impl_0(<span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">fp</span>, <span class="hljs-params">struct</span> <span class="hljs-params">__main_block_desc_0</span> <span class="hljs-operator">*</span><span class="hljs-params">desc</span>, <span class="hljs-params">int</span> <span class="hljs-params">_count</span>, <span class="hljs-params">int</span> <span class="hljs-params">flags</span>=0)</span> : count(_count) &#123;<br>    impl.isa = &amp;_NSConcreteStackBlock;<br>    impl.Flags = flags;<br>    impl.FuncPtr = fp;<br>    Desc = desc;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>__main_block_impl_0</code>æ˜¯è¯¥ block çš„å…·ä½“å®ç°ã€‚æ­¤ç»“æ„ä½“ä¸­<code>impl</code>å­—æ®µæ˜¯<code>__block_impl</code>ç»“æ„ä½“çš„å®ä¾‹ï¼Œ<code>__main_block_impl_0</code>æ˜¯å¯¹<code>__block_impl</code>çš„è¿›ä¸€æ­¥å°è£…ï¼›<code>count</code>å­—æ®µæ˜¯æˆ‘ä»¬å¼•å…¥çš„å¤–éƒ¨å˜é‡ï¼›<code>Desc</code>å³ç»“æ„ä½“çš„æè¿°ä¿¡æ¯ã€‚æœ€åç»“æ„ä½“å†…éƒ¨è¿˜æä¾›äº†ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°<code>__main_block_impl_0()</code>ï¼Œå‡½æ•°å†…å¯¹ç›¸å…³å­—æ®µè¿›è¡Œäº†åˆå§‹åŒ–ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">__main_block_desc_0</span> &#123;<br>  <span class="hljs-type">size_t</span> reserved;<br>  <span class="hljs-type">size_t</span> Block_size;<br>&#125; __main_block_desc_0_DATA = &#123; <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> __main_block_impl_0)&#125;;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ª<code>__main_block_desc_0</code>ç»“æ„ä½“ï¼Œç”¨æ¥æè¿°<code>__main_block_impl_0</code>ç»“æ„ä½“çš„ä¿¡æ¯ã€‚å…¶ä¸­çš„<code>Block_size</code>å­—æ®µç”¨äºè®°å½•ç»“æ„ä½“å¤§å°ï¼›åé¢çš„<code>__main_block_desc_0_DATA</code>å°±æ˜¯æ–°ç”Ÿæˆçš„<code>__main_block_desc_0</code>å®ä¾‹ã€‚</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs livescript">int main(int argc, <span class="hljs-keyword">const</span> char * argv[]) &#123;<br>    <span class="hljs-comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; <br>        int count = <span class="hljs-number">10</span>;<br>        <span class="hljs-literal">void</span> (* blk)(<span class="hljs-literal">void</span>) = ((<span class="hljs-literal">void</span> (*)())&amp;__main_block_impl_0((<span class="hljs-literal">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, count));<br>        <br>        <span class="hljs-function"><span class="hljs-params">((<span class="hljs-literal">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk)</span>;</span><br><span class="hljs-function">    &#125;</span><br><span class="hljs-function">    <span class="hljs-title">return</span> 0;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯<code>main.m</code>æ–‡ä»¶ä¸­ main å‡½æ•°ç¼–è¯‘åçš„å…·ä½“å†…å®¹ï¼Œçœ‹ä¸Šå»æœ‰ç‚¹å¤æ‚ï¼Œä¸‹é¢é€æ­¥è§£æè¿™æ®µå†…å®¹å…·ä½“åšäº†ä»€ä¹ˆï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__main_block_impl_0</span>((void *)<span class="hljs-variable">__main_block_func_0</span>, &amp;<span class="hljs-variable">__main_block_desc_0_DATA</span>, <span class="hljs-built_in">count</span>))<br></code></pre></td></tr></table></figure><p>#1ã€é€šè¿‡<code>__main_block_impl_0()</code>æ„é€ å™¨åˆ›å»ºäº†ä¸€ä¸ª<code>__main_block_impl_0</code>ç»“æ„ä½“çš„å®ä¾‹ã€‚å‚æ•°<code>__main_block_func_0</code>æ­£æ˜¯ä¸Šé¢æåˆ°çš„å‡½æ•°å®ç°ï¼Œå¯¹åº” blockçš„ <code>&#123; &#125;</code>é‡Œçš„å†…å®¹ï¼›<code>__main_block_desc_0_DATA</code>æ˜¯<code>__main_block_desc_0</code>ç»“æ„ä½“çš„å®ä¾‹ï¼Œæè¿°<code>__main_block_impl_0</code>ç»“æ„ä½“çš„å¤§å°ä¿¡æ¯ï¼›å‚æ•°<code>count</code>æ˜¯æˆ‘ä»¬ä¹‹å‰é€šè¿‡<code>int count = 10</code>å£°æ˜çš„å±€éƒ¨å˜é‡ï¼Œè¿™é‡Œä½œä¸ºå€¼ç±»å‹ä¼ è¿›æ¥ã€‚</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf">&amp;<span class="hljs-variable">__main_block_impl_0</span>((void *)<span class="hljs-variable">__main_block_func_0</span>, &amp;<span class="hljs-variable">__main_block_desc_0_DATA</span>, <span class="hljs-built_in">count</span>))<br></code></pre></td></tr></table></figure><p>#2ã€åœ¨ä¸Šä¸€æ­¥çš„åŸºç¡€ä¸ŠåŠ äº†<code>&amp;</code>è¿ç®—ç¬¦ï¼Œç”¨æ¥å–ä¸Šé¢åˆšåˆ›å»ºçš„<code>__main_block_impl_0</code>ç»“æ„ä½“å®ä¾‹çš„åœ°å€ã€‚</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">((void <span class="hljs-comment">(*)())&amp;__main_block_impl_0((void *)</span>__main_block_func_0, &amp;__main_block_desc_0_DATA, count))<br></code></pre></td></tr></table></figure><p>#3ã€æŠŠå®ä¾‹åœ°å€è½¬ä¸ºä¸€ä¸ªå‡½æ•°åœ°å€ã€‚</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">void <span class="hljs-comment">(* blk)(void) = ((void (*)</span>())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, count));<br></code></pre></td></tr></table></figure><p>#4ã€è¿™ä¸€æ•´å¥çš„ä½œç”¨å°±æ˜¯ï¼šå®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªæ–°åˆ›å»ºçš„<code>__main_block_impl_0</code>ç»“æ„ä½“çš„å®ä¾‹çš„åœ°å€ã€‚</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">((void <span class="hljs-comment">(*)(__block_impl *)</span>)((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);<br></code></pre></td></tr></table></figure><p>#5ã€è¿™æ˜¯ block çš„è°ƒç”¨<code>blk();</code>åœ¨ç¼–è¯‘åçš„ç»“æœï¼Œé€šè¿‡å‡½æ•°æŒ‡é’ˆ blk è°ƒç”¨å‡½æ•°çš„å®ç°<code>FnucPtr</code>ã€‚</p><h3 id="5-å˜é‡çš„æ•è·"><a href="#5-å˜é‡çš„æ•è·" class="headerlink" title="#5.å˜é‡çš„æ•è·"></a>#5.å˜é‡çš„æ•è·</h3><h4 id="5-1-æ•è·çš„å®ç°"><a href="#5-1-æ•è·çš„å®ç°" class="headerlink" title="5.1.æ•è·çš„å®ç°"></a>5.1.æ•è·çš„å®ç°</h4><p>ä¸Šé¢#4ç« èŠ‚çš„ç¤ºä¾‹ä¸­ï¼Œ<code>__main_block_impl_0</code> ç»“æ„ä½“ä¸­<code>impl.isa</code>æŒ‡å‘çš„æ˜¯<code>NSConcreteStackBlock</code>ç±»å‹ã€‚è¿™æ˜¯å› ä¸º main.m ä¸­æˆ‘ä»¬åœ¨ block å¤–å£°æ˜äº†ä¸€ä¸ªå˜é‡<code>int count = 10</code>ï¼Œå¹¶ä¸”åœ¨ block å†…éƒ¨è®¿é—®äº†è¯¥å˜é‡ï¼Œæ‰€ä»¥ block å®ä¾‹è¢«ä¿å­˜åœ¨äº†æ ˆä¸Šã€‚<br><br/></p><p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ block å†…ä¸è®¿é—®ä»»ä½•å±€éƒ¨å˜é‡ï¼Œ<code>impl.isa</code>åº”è¯¥æ˜¯æŒ‡å‘<code>NSConcreteGlobalBlock</code>ç±»å‹ï¼Œä½†å®é™…ä¸Š clang ç¼–è¯‘å‡ºæ¥çš„ç»“æœå´æ˜¯æŒ‡å‘<code>NSConcreteStackBlock</code>ç±»å‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//main.m</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * argv[])</span> </span>&#123;<br>    @autoreleasepool &#123;<br>        ^(<span class="hljs-type">void</span>)&#123;<br>        &#125;;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ç»“æœï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">struct</span> __main_block_impl_0 &#123;<br>  <span class="hljs-keyword">struct</span> __block_impl impl;<br>  <span class="hljs-keyword">struct</span> __main_block_desc_0* Desc;<br>  <span class="hljs-constructor">__main_block_impl_0(<span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">fp</span>, <span class="hljs-params">struct</span> <span class="hljs-params">__main_block_desc_0</span> <span class="hljs-operator">*</span><span class="hljs-params">desc</span>, <span class="hljs-params">int</span> <span class="hljs-params">flags</span>=0)</span> &#123;<br>    impl.isa = &amp;_NSConcreteStackBlock;<br>    impl.Flags = flags;<br>    impl.FuncPtr = fp;<br>    Desc = desc;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™å’Œ clang æ”¹å†™çš„å®ç°åŠ ARC æœ‰å…³ï¼Œå…³äºè¿™ä¸ªé—®é¢˜å¯ä»¥å‚è€ƒ <a href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/">å”å·§</a> çš„åšå®¢ï¼Œè¿™é‡Œæœ‰å…·ä½“çš„è§£é‡Šã€‚</p><br/><p>æ¯”è¾ƒè®¿é—®å’Œä¸è®¿é—®å±€éƒ¨å˜é‡çš„ä¸¤ä¸ªç‰ˆæœ¬ç¼–è¯‘åçš„<code>main.cpp</code>æ–‡ä»¶ï¼Œæ³¨æ„æ„é€ å‡½æ•°<code>__main_block_impl_0()</code>è¿™éƒ¨åˆ†ä»£ç ï¼š</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-comment">//è®¿é—®å±€éƒ¨å˜é‡</span><br>__main_block_impl_0(<span class="hljs-keyword">void</span> *fp, <br>    struct __main_block_desc_0 *<span class="hljs-keyword">desc</span>, <br>    <span class="hljs-built_in">int</span> _count, <span class="hljs-built_in">int</span> flags=<span class="hljs-number">0</span>) : <span class="hljs-keyword">count</span>(_count) &#123;<br>    <span class="hljs-comment">//ç•¥</span><br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">//æœªè®¿é—®å±€éƒ¨å˜é‡</span><br>__main_block_impl_0(<span class="hljs-keyword">void</span> *fp, <br>    struct __main_block_desc_0 *<span class="hljs-keyword">desc</span>, <br>    <span class="hljs-built_in">int</span> flags=<span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//ç•¥</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè®¿é—®äº†å±€éƒ¨å˜é‡æ—¶ï¼Œæ„é€ å‡½æ•°<code>__main_block_impl_0()</code>çš„å‚æ•°é‡Œä¼šå¤šå‡ºä¸€ä¸ª<code>_count</code>ï¼Œè¿™é‡Œå°±æ˜¯ <strong>block å¯¹å˜é‡çš„è‡ªåŠ¨æ•è·</strong>ã€‚åœ¨å£°æ˜ block æ—¶ï¼Œæ ˆä¸Šçš„å±€éƒ¨å˜é‡ <code>count</code> å°±å·²ç»ä»¥å‚æ•°çš„å½¢å¼è¢«ä¼ å…¥æ„é€ å‡½æ•°ä¸­ï¼Œä¹‹åè¢«å¤åˆ¶åˆ°<code>__main_block_impl_0</code>ç»“æ„ä½“ä¸­ã€‚</p><h4 id="5-2-å¯ä¿®æ”¹æ€§"><a href="#5-2-å¯ä¿®æ”¹æ€§" class="headerlink" title="5.2.å¯ä¿®æ”¹æ€§"></a>5.2.å¯ä¿®æ”¹æ€§</h4><p>æ•è·åå¯ä»¥ä¿®æ”¹çš„å˜é‡ï¼š</p><ul><li>é™æ€å˜é‡</li><li>å…¨å±€å˜é‡</li><li>é™æ€å…¨å±€å˜é‡</li></ul><p>æ•è·åä¸å¯ä»¥ä¿®æ”¹çš„å˜é‡ï¼š</p><ul><li>å±€éƒ¨å˜é‡</li></ul><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-type">int</span> aGloableVal = <span class="hljs-number">1</span>;<span class="hljs-comment">//å…¨å±€å˜é‡</span><br><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> aStaticGloable = <span class="hljs-number">2</span>;<span class="hljs-comment">//é™æ€å…¨å±€å˜é‡</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> aStaticVal = <span class="hljs-number">3</span>;<span class="hljs-comment">//é™æ€å˜é‡</span><br>    <span class="hljs-type">int</span> anInt = <span class="hljs-number">0</span>;<span class="hljs-comment">//å±€éƒ¨å˜é‡</span><br>    <span class="hljs-built_in">NSMutableArray</span> *array = [<span class="hljs-built_in">NSMutableArray</span> array];<span class="hljs-comment">//å¯å˜æ•°ç»„</span><br>    <br>    <span class="hljs-type">void</span> (^blockT)(<span class="hljs-type">int</span>) = ^(<span class="hljs-type">int</span> blockVal)&#123;<br>        aGloableVal = <span class="hljs-number">8</span>;<br>        aStaticGloable = <span class="hljs-number">9</span>;<br>        aStaticVal = <span class="hljs-number">10</span>;<span class="hljs-comment">//ä»¥ä¸Šä¸‰ä¸ªéƒ½å¯ä»¥æ­£å¸¸èµ‹å€¼</span><br>        <br>        <span class="hljs-comment">//anInt = 1;</span><br>        <span class="hljs-comment">//array = [NSMutableArray array];</span><br>        <span class="hljs-comment">//ä»¥ä¸Šä¸¤ä¸ªèµ‹å€¼æ“ä½œä¼šæŠ¥é”™:&quot;variable is not assignable&quot;!!</span><br>        [array addObject:<span class="hljs-string">@&quot;2&quot;</span>];<span class="hljs-comment">//æ•°ç»„å¯ä»¥æ­£å¸¸æ·»åŠ å¯¹è±¡</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;å±€éƒ¨å˜é‡:%d,\nå…¨å±€å˜é‡:%d,\né™æ€å…¨å±€å˜é‡:%d,\né™æ€å˜é‡:%d,\næ•°ç»„å®¹é‡:%lu&quot;</span>,<br>        anInt,aGloableVal,aStaticGloable,aStaticVal,(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)array.count);<br>    &#125;;<br>    aGloableVal = <span class="hljs-number">4</span>;<br>    aStaticGloable = <span class="hljs-number">5</span>;<br>    aStaticVal = <span class="hljs-number">6</span>;<br>    anInt = <span class="hljs-number">7</span>;<br>    [array addObject:<span class="hljs-string">@&quot;1&quot;</span>];<br>    <br>    blockT(<span class="hljs-number">5</span>);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">å±€éƒ¨å˜é‡:0,</span><br><span class="hljs-section">å…¨å±€å˜é‡:8,</span><br><span class="hljs-section">é™æ€å…¨å±€å˜é‡:9,</span><br><span class="hljs-section">é™æ€å˜é‡:10,</span><br><span class="hljs-section">æ•°ç»„å®¹é‡:2</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®ç¤ºä¾‹ï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼š<br><br/></p><p>1ã€<code>å…¨å±€å˜é‡</code>ã€<code>é™æ€å˜é‡</code>ã€<code>é™æ€å…¨å±€å˜é‡</code>åœ¨ block å†…å¯ä»¥é‡æ–°èµ‹å€¼ï¼Œè€Œ<code>å±€éƒ¨å˜é‡</code>ä¸è¡Œã€‚anInt åœ¨ block å†…éƒ¨é‡æ–°èµ‹å€¼æ—¶ï¼Œç¼–è¯‘å™¨æŠ¥é”™â€œvariable is not assignableâ€ã€‚<br><br/></p><p>2ã€<code>å…¨å±€å˜é‡</code>ã€<code>é™æ€å˜é‡</code>ã€<code>é™æ€å…¨å±€å˜é‡</code>åœ¨åˆå§‹åŒ–æ—¶éƒ½æœ‰é»˜è®¤å€¼ï¼Œblock å†…é‡æ–°èµ‹å€¼åï¼Œæœ€ç»ˆæ‰“å°å‡ºçš„éƒ½æ˜¯é‡æ–°ä¿®æ”¹ä¹‹åçš„å€¼ã€‚è€Œ<code>å±€éƒ¨å˜é‡</code> anInt åˆå§‹åŒ–æ—¶ &#x3D; 0ï¼Œåœ¨è°ƒç”¨ block ä¹‹å‰é‡æ–°èµ‹å€¼ &#x3D; 1ï¼›è€Œ block å†…æ‰“å°çš„ anInt çš„å€¼ä»ä¸ºèµ‹å€¼å‰çš„<code>0</code>ã€‚è¿™è¯´æ˜ block å†…æ•è·çš„å±€éƒ¨å˜é‡çš„å€¼æ˜¯ blok å£°æ˜ä¹‹å‰çš„é‚£ä¸ªå€¼ã€‚<br><br/></p><p>3ã€<code>å±€éƒ¨å˜é‡</code>array èµ‹å€¼æ—¶æŠ¥é”™â€œvariable is not assignableâ€ï¼Œè€Œæ‰§è¡Œ addObject æ“ä½œå´ä¸ä¼šæŠ¥é”™ã€‚æ‰€ä»¥ï¼Œblock ä¸­ä½¿ç”¨åˆ°çš„å±€éƒ¨å˜é‡å¯ä»¥æ‰§è¡Œæ“ä½œè€Œä¸èƒ½èµ‹å€¼ã€‚<br><br/></p><p>4ã€block æ•è·å±€éƒ¨å˜é‡ä»…ä»…åªæ•è· block é—­åŒ…é‡Œé¢ä¼šç”¨åˆ°çš„å€¼ï¼Œå…¶ä»–ç”¨ä¸åˆ°çš„å˜é‡ï¼Œå®ƒå¹¶ä¸ä¼šå»æ•è·ã€‚</p><h3 id="6-é—®é¢˜æ¥äº†"><a href="#6-é—®é¢˜æ¥äº†" class="headerlink" title="#6.é—®é¢˜æ¥äº†"></a>#6.é—®é¢˜æ¥äº†</h3><p><em>ä¸ºå•¥å…¨å±€å˜é‡ã€é™æ€å˜é‡åœ¨ block å†…èƒ½ä¿®æ”¹ï¼Œè€Œå±€éƒ¨å˜é‡ä¸èƒ½ä¿®æ”¹ï¼Ÿ</em><br><br/></p><p>å†…å­˜åŒºåŸŸåˆ†ä¸ºï¼šå †åŒºã€æ ˆåŒºã€å…¨å±€åŒº(æ•°æ®åŒº)ã€ä»£ç åŒºã€‚</p><ul><li>å…¨å±€å˜é‡ã€é™æ€å…¨å±€å˜é‡éƒ½å­˜å‚¨åœ¨å…¨å±€åŒºï¼Œæ‰€ä»¥åœ¨ block å†…å¯ä»¥ç›´æ¥è¢«ä¿®æ”¹ã€‚</li><li>é™æ€å˜é‡ä¼ é€’ç»™ block çš„æ˜¯å†…å­˜åœ°å€å€¼ï¼Œæ‰€ä»¥èƒ½åœ¨ block é‡Œé¢ç›´æ¥æ”¹å˜å€¼ã€‚</li><li>å±€éƒ¨å˜é‡æ˜¯ä»¥å€¼ä¼ é€’æ–¹å¼ä¼ é€’åˆ° block çš„æ„é€ å‡½æ•°é‡Œé¢å»çš„ã€‚ç”±äºåªæ•è·äº†å±€éƒ¨å˜é‡çš„å€¼ï¼Œå¹¶éå†…å­˜åœ°å€ï¼Œæ‰€ä»¥ block å†…éƒ¨ä¸èƒ½æ”¹å˜è‡ªåŠ¨å˜é‡çš„å€¼ã€‚</li></ul><p>æƒ³è¦åœ¨ block ä¸­ä¿®æ”¹å˜é‡çš„å€¼ï¼Œæœ‰2ç§æ–¹å¼ï¼š</p><ul><li>ä¼ é€’å†…å­˜åœ°å€æŒ‡é’ˆåˆ° block ä¸­;</li><li>æ”¹å˜å­˜å‚¨åŒºæ–¹å¼(å¦‚__block anInt);</li></ul><p>ä¸‹é¢çœ‹çœ‹é€šè¿‡<code>__block</code>ä¿®é¥°å˜é‡å¹¶åœ¨ block å†…ä¿®æ”¹å˜é‡å€¼çš„ç¤ºä¾‹ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * argv[])</span> </span>&#123;<br>    @autoreleasepool &#123;<br>        __block <span class="hljs-type">int</span> count = <span class="hljs-number">10</span>;<br>        <span class="hljs-built_in">void</span> (^ blk)(<span class="hljs-type">void</span>) = ^()&#123;<br>            count = <span class="hljs-number">11</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;update varable in block:%d&quot;</span>,count);<br>        &#125;;<br>        <span class="hljs-built_in">blk</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ clang ç¼–è¯‘åå¾—åˆ°æ–°çš„<code>main.cpp</code>æ–‡ä»¶ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sqf">struct <span class="hljs-variable">__Block_byref_count_0</span> &#123;<br>  void *<span class="hljs-variable">__isa</span>;<br><span class="hljs-variable">__Block_byref_count_0</span> *<span class="hljs-variable">__forwarding</span>;<br> int <span class="hljs-variable">__flags</span>;<br> int <span class="hljs-variable">__size</span>;<br> int <span class="hljs-built_in">count</span>;<br>&#125;;<br><br>struct <span class="hljs-variable">__main_block_impl_0</span> &#123;<br>  struct <span class="hljs-variable">__block_impl</span> impl;<br>  struct <span class="hljs-variable">__main_block_desc_0</span>* Desc;<br>  <span class="hljs-variable">__Block_byref_count_0</span> *<span class="hljs-built_in">count</span>; <span class="hljs-comment">// by ref</span><br>  <span class="hljs-variable">__main_block_impl_0</span>(void *fp, struct <span class="hljs-variable">__main_block_desc_0</span> *desc, <span class="hljs-variable">__Block_byref_count_0</span> *<span class="hljs-variable">_count</span>, int flags=<span class="hljs-number">0</span>) : <span class="hljs-built_in">count</span>(<span class="hljs-variable">_count</span>-&gt;<span class="hljs-variable">__forwarding</span>) &#123;<br>    impl.isa = &amp;<span class="hljs-variable">_NSConcreteStackBlock</span>;<br>    impl.Flags = flags;<br>    impl.FuncPtr = fp;<br>    Desc = desc;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æºç ä¸­å¢åŠ äº†ä¸€ä¸ª<code>__Block_byref_count_0</code>ç±»å‹çš„ç»“æ„ä½“ï¼Œå†…éƒ¨ä¿å­˜ç€æˆ‘ä»¬ç”¨<code>__block</code>ä¿®é¥°çš„å˜é‡<code>count</code>ã€‚è€Œ<code>__main_block_impl_0()</code>æ„é€ å‡½æ•°ä¸­å¼•ç”¨çš„æ˜¯<code>__Block_byref_count_0</code>çš„ç»“æ„ä½“æŒ‡é’ˆ<code>*_count</code>ã€‚è¿™é‡Œï¼Œç»“æ„ä½“æŒ‡é’ˆä¸èƒ½å†ä¿®æ”¹äº†ã€‚ä½†æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ç©ºé—´é‡Œçš„å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚å› æ­¤ï¼Œåœ¨ block å†…å†æ¬¡å¯¹<code>__block</code>ä¿®é¥°çš„å˜é‡èµ‹å€¼æ—¶ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡ä¿®æ”¹å˜é‡å¯¹åº”çš„ç»“æ„ä½“æŒ‡é’ˆå†…å­˜ç©ºé—´é‡Œçš„ value æ¥ä¿®æ”¹å˜é‡çš„å€¼ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Blocks/Articles/bxVariables.html">Â©Appleå®˜æ–¹æ–‡æ¡£</a> åŠ #<a href="http://www.cnblogs.com/YouXianMing/p/3702508.html?utm_source=tuicool&utm_medium=referral">Â©ç¿»è¯‘</a></p><p>#<a href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/">Â©å”å·§</a></p><p>#<a href="https://segmentfault.com/a/1190000006479320">Â©æ€å¦</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>block</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AFNetworking</title>
    <link href="/2018/01/31/source_code_afn.html"/>
    <url>/2018/01/31/source_code_afn.html</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€å¯¼å…¥åº“"><a href="#ä¸€ã€å¯¼å…¥åº“" class="headerlink" title="ä¸€ã€å¯¼å…¥åº“"></a>ä¸€ã€å¯¼å…¥åº“</h3><p>å¯¼å…¥ AFN çš„ Podfileï¼š</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs delphi">source <span class="hljs-string">&#x27;https://github.com/CocoaPods/Specs.git&#x27;</span><br><span class="hljs-keyword">platform</span> :ios, <span class="hljs-string">&#x27;8.0&#x27;</span><br>target <span class="hljs-string">&#x27;TargetName&#x27;</span> <span class="hljs-keyword">do</span><br>pod <span class="hljs-string">&#x27;AFNetworking&#x27;</span>, <span class="hljs-string">&#x27;~&gt; 3.0&#x27;</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>å†™è¿™ç¯‡æ–‡ç« æ—¶æœ€æ–°çš„ç‰ˆæœ¬æ˜¯AFNetworking (3.1.0)ã€‚</p><h3 id="äºŒã€æ¨¡å—åˆ’åˆ†"><a href="#äºŒã€æ¨¡å—åˆ’åˆ†" class="headerlink" title="äºŒã€æ¨¡å—åˆ’åˆ†"></a>äºŒã€æ¨¡å—åˆ’åˆ†</h3><table><thead><tr><th>æ¨¡å—</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>NSURLSession</td><td>å‘èµ·æ•°æ®è¯·æ±‚ã€ä¸Šä¼ ã€ä¸‹è½½ä»»åŠ¡ï¼Œåœ¨å›è°ƒä¸­å¤„ç†æ•°æ®ã€è¿›åº¦ç­‰ï¼›</td></tr><tr><td>Serialization</td><td>è¯·æ±‚ä¸å“åº”çš„åºåˆ—åŒ–ã€å‚æ•°æ‹¼æ¥ç­‰ï¼›</td></tr><tr><td>Reachability</td><td>ç½‘ç»œçŠ¶æ€çš„ç›‘å¬ï¼›</td></tr><tr><td>Security</td><td>ç½‘ç»œå®‰å…¨ç­–ç•¥æ¨¡å—ï¼Œå¤„ç†è¯ä¹¦éªŒè¯é—®é¢˜ï¼Œä¿è¯è®¿é—®æœåŠ¡å™¨æ—¶çš„å®‰å…¨æ€§ï¼›</td></tr><tr><td>UIKit</td><td>å¯¹å¸¸ç”¨è§†å›¾çš„æ‰©å±•ï¼Œç”¨äºæ§ä»¶ä¸­ç½‘ç»œèµ„æºçš„ä¸‹è½½ã€‚</td></tr></tbody></table><h3 id="ä¸‰ã€NSURLSession"><a href="#ä¸‰ã€NSURLSession" class="headerlink" title="ä¸‰ã€NSURLSession"></a>ä¸‰ã€NSURLSession</h3><h4 id="3-1-AFURLSessionManager"><a href="#3-1-AFURLSessionManager" class="headerlink" title="3.1.AFURLSessionManager"></a>3.1.AFURLSessionManager</h4><p>ç½‘ç»œè¯·æ±‚çš„åŸºç±»ï¼Œå®ƒåˆ›å»ºå¹¶ç»´æŠ¤äº†ä¸€ä¸ª<code>NSURLSession</code>å¯¹è±¡ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š</p><ul><li><strong>Init &amp; ç½‘ç»œè¯·æ±‚ç›¸å…³é…ç½®</strong>ï¼ˆå®‰å…¨ç­–ç•¥ã€é˜Ÿåˆ—ã€é”ï¼‰ã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (instancetype)initWithSessionConfiguration:<br>(<span class="hljs-type">NSURLSessionConfiguration</span> <span class="hljs-operator">*</span>)configuration <br>&#123;<br>    <span class="hljs-comment">//ç•¥..</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span>configuration) &#123;<br>        configuration <span class="hljs-operator">=</span> [<span class="hljs-type">NSURLSessionConfiguration</span> defaultSessionConfiguration];<br>    &#125;<br>    <span class="hljs-keyword">self</span>.sessionConfiguration <span class="hljs-operator">=</span> configuration;<br><br>    <span class="hljs-comment">//å›è°ƒæ‰€åœ¨é˜Ÿåˆ—</span><br>    <span class="hljs-keyword">self</span>.operationQueue <span class="hljs-operator">=</span> [[<span class="hljs-type">NSOperationQueue</span> alloc] <span class="hljs-keyword">init</span>];<br>    <span class="hljs-comment">//å¹¶å‘æ•° = 1ï¼ˆä¸²è¡Œï¼‰</span><br>    <span class="hljs-comment">/*æŒ‰ç…§URLSessionæ¥å£çš„è¦æ±‚ï¼Œå…¶å›è°ƒæ‰€åœ¨é˜Ÿåˆ—å¿…é¡»æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œ</span><br><span class="hljs-comment">     *æ‰€ä»¥é˜Ÿåˆ—çš„å¹¶å‘æ•°é¡»æ˜¯1ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯å›è°ƒçš„é¡ºåºã€‚*/</span><br>    <span class="hljs-keyword">self</span>.operationQueue.maxConcurrentOperationCount <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">self</span>.session <span class="hljs-operator">=</span> [<span class="hljs-type">NSURLSession</span> sessionWithConfiguration:<span class="hljs-keyword">self</span>.sessionConfiguration <br>    delegate:<span class="hljs-keyword">self</span> <br>    delegateQueue:<span class="hljs-keyword">self</span>.operationQueue];<br><br>    <span class="hljs-keyword">self</span>.responseSerializer <span class="hljs-operator">=</span> [<span class="hljs-type">AFJSONResponseSerializer</span> serializer];<br>    <span class="hljs-keyword">self</span>.securityPolicy <span class="hljs-operator">=</span> [<span class="hljs-type">AFSecurityPolicy</span> defaultPolicy];<br>    <br>    <span class="hljs-comment">//å­—å…¸ï¼šæ˜ å°„ NSURLSessionTask ä¸ AFURLSessionManagerTaskDelegate</span><br>    <span class="hljs-keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier <span class="hljs-operator">=</span> [[<span class="hljs-type">NSMutableDictionary</span> alloc] <span class="hljs-keyword">init</span>];<br><br>    <span class="hljs-keyword">self</span>.lock <span class="hljs-operator">=</span> [[<span class="hljs-type">NSLock</span> alloc] <span class="hljs-keyword">init</span>];<br>    <span class="hljs-keyword">self</span>.lock.name <span class="hljs-operator">=</span> <span class="hljs-type">AFURLSessionManagerLockName</span>;<br>    <br>    <span class="hljs-comment">//éå†å½“å‰æ­£åœ¨æ‰§è¡Œçš„ç½‘ç»œä»»åŠ¡ï¼Œæ ¹æ®ä»»åŠ¡æ ‡è¯†ç¬¦å°†å„ä¸ª block ç½®ä¸º nil</span><br>    [<span class="hljs-keyword">self</span>.session getTasksWithCompletionHandler:<span class="hljs-operator">^</span>(<br>    <span class="hljs-type">NSArray</span> <span class="hljs-operator">*</span>dataTasks, <span class="hljs-type">NSArray</span> <span class="hljs-operator">*</span>uploadTasks, <span class="hljs-type">NSArray</span> <span class="hljs-operator">*</span>downloadTasks) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">NSURLSessionDataTask</span> <span class="hljs-operator">*</span>task <span class="hljs-keyword">in</span> dataTasks) &#123;<br>            [<span class="hljs-keyword">self</span> addDelegateForDataTask:task <br>            uploadProgress:<span class="hljs-literal">nil</span> <br>            downloadProgress:<span class="hljs-literal">nil</span> <br>            completionHandler:<span class="hljs-literal">nil</span>];<br>        &#125;<br>    <span class="hljs-comment">//ç•¥..</span><br>    &#125;];<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œself.operationQueueæ˜¯è¯·æ±‚å›è°ƒæ—¶æ‰€åœ¨çš„é˜Ÿåˆ—ï¼Œè€Œéå‘èµ·è¯·æ±‚æ—¶çš„é˜Ÿåˆ—ã€‚å…¶ä¸­<code>maxConcurrentOperationCount</code>ä¸º1ï¼Œè¿™æ˜¯å› ä¸º NSURLSession ä¸ºäº†ä¿è¯å…¶å›è°ƒçš„é¡ºåºï¼Œè¦æ±‚å…¶<code>delegateQueue</code>å¿…é¡»æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼š</p><blockquote><p>An operation queue for scheduling the delegate calls and completion handlers. The queue should be a serial queue, in order to ensure the correct ordering of callbacks. If nil, the session creates a serial operation queue for performing all delegate method calls and completion handler calls.</p></blockquote><ul><li><strong>å‘èµ·ç½‘ç»œè¯·</strong>ï¼ˆNSURLSession æ”¯æŒçš„æ•°æ® &#x2F; ä¸Šä¼  &#x2F; ä¸‹è½½ä»»åŠ¡ï¼‰ã€‚</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>æ•°æ®ä»»åŠ¡<br>- (NSURLSessionDataTask *)dataTaskWithRequest:completionHandler:<br><span class="hljs-regexp">//</span>ä¸Šä¼ ä»»åŠ¡<br>- (NSURLSessionUploadTask *)uploadTaskWithRequest:fromFile:progress:completionHandler:<br><span class="hljs-regexp">//</span>ä¸‹è½½ä»»åŠ¡<br>- (NSURLSessionDownloadTask *)downloadTaskWithRequest:progress:destination:completionHandler:<br></code></pre></td></tr></table></figure><ul><li><strong>æ¥æ”¶æ•°æ® &amp; å¤„ç†å›è°ƒ</strong>ï¼ˆURLSession çš„å¼€å§‹ã€è¿›åº¦ã€å®Œæˆç­‰ç›¸å…³å›è°ƒï¼‰ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - NSURLSessionDataDelegate</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask<br>didReceiveData:(<span class="hljs-built_in">NSData</span> *)data<br>&#123;<br>    <span class="hljs-comment">//å–å‡ºå­—å…¸ä¸­çš„ Delegate å¯¹è±¡ï¼Œè®©å®ƒå¤„ç†åç»­çš„ä¸šåŠ¡é€»è¾‘ã€‚</span><br>    AFURLSessionManagerTaskDelegate *delegate = [<span class="hljs-keyword">self</span> delegateForTask:dataTask];<br>    [delegate URLSession:session <br>    dataTask:dataTask <br>    didReceiveData:data];<br>    <span class="hljs-comment">//ç•¥ã€‚ã€‚ã€‚</span><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - NSURLSessionDownloadDelegate</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>      downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask<br>didFinishDownloadingToURL:(<span class="hljs-built_in">NSURL</span> *)location<br>&#123;<br>    AFURLSessionManagerTaskDelegate *delegate = [<span class="hljs-keyword">self</span> delegateForTask:downloadTask];<br>    <span class="hljs-comment">//ç•¥ã€‚ã€‚ã€‚</span><br>    [delegate URLSession:session <br>    downloadTask:downloadTask <br>    didFinishDownloadingToURL:location];<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-AFHTTPSessionManager"><a href="#3-2-AFHTTPSessionManager" class="headerlink" title="3.2.AFHTTPSessionManager"></a>3.2.AFHTTPSessionManager</h4><p>ç»§æ‰¿è‡ª AFURLSessionManager å¹¶å°†å…¶ä¸­çš„ä»»åŠ¡è¿›ä¸€æ­¥å°è£…ä¸º 6 å¤§ç±»ï¼š</p><hr><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>GET</td><td>è¯·æ±‚æŒ‡å®šé¡µé¢çš„ä¿¡æ¯ï¼Œè¿”å›æ•°æ®å®ä½“ï¼›</td></tr><tr><td>HEAD</td><td>ä¸GETç±»ä¼¼ï¼Œä¸åŒåœ¨äºåªè¿”å›å¤´ä¿¡æ¯è€Œæ²¡æœ‰å…·ä½“æ•°æ®ï¼›</td></tr><tr><td>POST</td><td>å°†æ•°æ®å°è£…åœ¨è¯·æ±‚ä½“ä¸­ï¼Œä¸Šä¼ è‡³æŒ‡å®šç›®å½•ï¼Œç”±æœåŠ¡å™¨åˆ›å»ºæˆ–æ›´æ–°å¯¹åº”çš„èµ„æºï¼›</td></tr><tr><td>PUT</td><td>å°†æ•°æ®ä¼ é€ç»™æœåŠ¡å™¨ä»¥å–ä»£æŒ‡å®šæ–‡æ¡£ä¸­çš„å†…å®¹ï¼›</td></tr><tr><td>PATCH</td><td>æ˜¯å¯¹PUTæ–¹æ³•çš„è¡¥å……ï¼Œç”¨æ¥å¯¹å·²çŸ¥èµ„æºè¿›è¡Œå±€éƒ¨æ›´æ–°ï¼›</td></tr><tr><td>DELETE</td><td>è¯·æ±‚åˆ é™¤æŒ‡å®šé¡µé¢æˆ–èµ„æºï¼›</td></tr></tbody></table><hr><p>æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ruby">- (NSURLSessionDataTask*)<span class="hljs-variable constant_">GET</span><span class="hljs-symbol">:parameters</span><span class="hljs-symbol">:progress</span><span class="hljs-symbol">:success</span><span class="hljs-symbol">:failure</span>:<br><br>- (NSURLSessionDataTask*)<span class="hljs-variable constant_">POST</span><span class="hljs-symbol">:parameters</span><span class="hljs-symbol">:</span>...<span class="hljs-symbol">progress:</span><span class="hljs-symbol">success:</span><span class="hljs-symbol">failure:</span><br><br>- (NSURLSessionDataTask*)<span class="hljs-variable constant_">PUT</span><span class="hljs-symbol">:parameters</span><span class="hljs-symbol">:success</span><span class="hljs-symbol">:failure</span>:<br><br>- (NSURLSessionDataTask*)<span class="hljs-variable constant_">DELETE</span><span class="hljs-symbol">:parameters</span><span class="hljs-symbol">:success</span><span class="hljs-symbol">:failure</span>:<br><br>- (NSURLSessionDataTask*)<span class="hljs-variable constant_">HEAD</span><span class="hljs-symbol">:parameters</span><span class="hljs-symbol">:success</span><span class="hljs-symbol">:failure</span>:<br><br>- (NSURLSessionDataTask*)<span class="hljs-variable constant_">PATCH</span><span class="hljs-symbol">:parameters</span><span class="hljs-symbol">:success</span><span class="hljs-symbol">:failure</span><span class="hljs-symbol">:</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢ 6 ç§ä»»åŠ¡æœ€ç»ˆéƒ½ä¼šé€šè¿‡ä¸‹é¢è¿™ä¸ªç»Ÿä¸€çš„å…¥å£å‡½æ•°è°ƒç”¨çˆ¶ç±»ä¸­å¯¹åº”çš„æ–¹æ³•å‘èµ·ç½‘ç»œä»»åŠ¡ã€‚</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-comment">//AFHTTPSessionManager.m</span><br>- (NSURLSessionDataTask *)dataTaskWithHTTPMethod:<br><span class="hljs-symbol">URLString:</span>parameters:uploadProgress:downloadProgress:success:failure:<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-comment">//æ‹¼æ¥requestå‚æ•°</span><br>    NSMutableURLRequest *<span class="hljs-attr">request</span> <span class="hljs-operator">=</span> [self.requestSerializer<br><span class="hljs-symbol">    requestWithMethod:</span>method <br><span class="hljs-symbol">    URLString:</span>[[NSURL URLWithString:URLString <br><span class="hljs-symbol">    relativeToURL:</span>self.baseURL] absoluteString] <br><span class="hljs-symbol">    parameters:</span>parameters <br><span class="hljs-symbol">    error:</span><span class="hljs-variable">&amp;</span>serializationError]<span class="hljs-punctuation">;</span><br>    <span class="hljs-comment">/***ç•¥***/</span><br>    __block NSURLSessionDataTask *dataT<span class="hljs-attr">ask</span> <span class="hljs-operator">=</span> <span class="hljs-attr">nil</span><span class="hljs-punctuation">;</span><br>    <span class="hljs-comment">//è°ƒç”¨çˆ¶ç±» AFURLSessionManager ä¸­çš„æ–¹æ³•å‘èµ·è¯·æ±‚</span><br>    dataT<span class="hljs-attr">ask</span> <span class="hljs-operator">=</span> [self dataTaskWithRequest:request<br><span class="hljs-symbol">                          uploadProgress:</span>uploadProgress<br><span class="hljs-symbol">                        downloadProgress:</span>downloadProgress<br><span class="hljs-symbol">                       completionHandler:</span>^(/../) <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-comment">/**ç•¥**/</span><br>    <span class="hljs-punctuation">&#125;</span>]<span class="hljs-punctuation">;</span><br>    return dataT<span class="hljs-attr">ask</span><span class="hljs-punctuation">;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//AFURLSessionManager.m</span><br>- (<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:<br>uploadProgress:downloadProgress:completionHandler:<br>&#123;<br>    __block <span class="hljs-built_in">NSURLSessionDataTask</span> *dataTask = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-comment">//ä¿®å¤iOS8ä»¥ä¸‹å¹¶å‘é˜Ÿåˆ—ä¸­ä»»åŠ¡æ ‡è¯†ç¬¦ä¸å”¯ä¸€çš„é—®é¢˜ï¼ˆä¸²è¡Œ+åŒæ­¥ï¼‰</span><br>    url_session_manager_create_task_safely(^&#123;<br>        dataTask = [<span class="hljs-keyword">self</span>.session dataTaskWithRequest:request];<span class="hljs-comment">//å‘èµ·è¯·æ±‚</span><br>    &#125;);<br>    <span class="hljs-comment">//ç»‘å®š AFURLSessionManagerTaskDelegate å¯¹è±¡</span><br>    [<span class="hljs-keyword">self</span> addDelegateForDataTask:dataTask <br>    uploadProgress:uploadProgressBlock <br>    downloadProgress:downloadProgressBlock <br>    completionHandler:completionHandler];<br>    <span class="hljs-keyword">return</span> dataTask;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œå‘èµ·è¯·æ±‚çš„æ“ä½œè¢«æ”¾åœ¨ä¸€ä¸ªåä¸º url_session_manager_create_task_safely çš„ block é‡Œï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs scss">static void <span class="hljs-built_in">url_session_manager_create_task_safely</span>(<br>dispatch_block_t block) &#123;<br>    if (NSFoundationVersionNumber &lt; <br>    NSFoundationVersionNumber_With_Fixed_5871104061079552_bug) &#123;<br>        <span class="hljs-built_in">dispatch_sync</span>(url_session_manager_creation_queue(), block);<br>    &#125; else &#123;<br>        block();<br>    &#125;<br>&#125;<br>static dispatch_queue_t <span class="hljs-built_in">url_session_manager_creation_queue</span>() &#123;<br>    static dispatch_queue_t af_url_session_manager_creation_queue;<br>    static dispatch_once_t onceToken;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br>        af_url_session_manager_creation_queue = dispatch_queue_create(<br>        &quot;com.alamofire.networking.session.manager.creation&quot;, <br>        DISPATCH_QUEUE_SERIAL);<br>    &#125;);<br>    return af_url_session_manager_creation_queue;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ª block ä¸»è¦æ˜¯ç”¨æ¥ä¿®å¤ iOS8 ä»¥ä¸‹åˆ›å»º NSURLSession æ—¶ taskIdentifier ä¸å”¯ä¸€çš„é—®é¢˜ã€‚taskIdentifier åœ¨åé¢ä¼šè¢«ä½œä¸ºä¿å­˜ AFURLSessionManagerTaskDelegate å¯¹è±¡çš„ keyã€‚æ‰€ä»¥åœ¨å¤šä¸ª NSURLSession æ—¶ï¼Œå¦‚æœæ­¤å€¼ä¸å”¯ä¸€ï¼Œé‚£ä¹ˆ AFURLSessionManagerTaskDelegate å¯¹è±¡ä¸ dataTask çš„æ˜ å°„å°±ä¼šå‡ºé—®é¢˜ã€‚ä¿®å¤æ­¤é—®é¢˜çš„æ–¹æ³•å°±æ˜¯åœ¨iOS8ä»¥ä¸‹ä½¿ç”¨â€œä¸²è¡Œ + åŒæ­¥â€çš„æ–¹å¼å‘èµ·è¯·æ±‚ã€‚</p><h4 id="3-3-TaskDelegate"><a href="#3-3-TaskDelegate" class="headerlink" title="3.3.TaskDelegate"></a>3.3.TaskDelegate</h4><p>è¿™æ˜¯ä¸€ä¸ªå®šä¹‰åœ¨<code>AFURLSessionManager.m</code>å†…éƒ¨çš„ç±»ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AFURLSessionManagerTaskDelegate</span> : <span class="hljs-title">NSObject</span> </span><br><br>&lt;<span class="hljs-built_in">NSURLSessionTaskDelegate</span>, <br><span class="hljs-built_in">NSURLSessionDataDelegate</span>, <br><span class="hljs-built_in">NSURLSessionDownloadDelegate</span>&gt;<br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">weak</span>) AFURLSessionManager *manager;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSMutableData</span> *mutableData;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSProgress</span> *uploadProgress;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSProgress</span> *downloadProgress;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSURL</span> *downloadFileURL;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) AFURLSessionDownloadTaskDidFinishDownloadingBlock <br>downloadTaskDidFinishDownloading;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) AFURLSessionTaskProgressBlock uploadProgressBlock;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) AFURLSessionTaskProgressBlock downloadProgressBlock;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) AFURLSessionTaskCompletionHandler completionHandler;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ä½œç”¨ï¼šä½œä¸ºå·¥å…·ç±»ï¼Œå¤„ç† NSURLSession çš„æ•°æ®ä»£ç†ï¼Œå¦‚ï¼šæŒæœ‰è¿”å›çš„æ•°æ®ã€ç›‘å¬è¿›åº¦ã€å›åˆ°ä¸»çº¿ç¨‹ç­‰ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - NSURLSessionDataTaskDelegate</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask<br>didReceiveData:(<span class="hljs-built_in">NSData</span> *)data<br>&#123;<br>    [<span class="hljs-keyword">self</span>.mutableData appendData:data];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - NSURLSessionTaskDelegate</span><br>- (<span class="hljs-type">void</span>)URLSession:(__unused <span class="hljs-built_in">NSURLSession</span> *)session<br>task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>didCompleteWithError:(<span class="hljs-built_in">NSError</span> *)error<br>&#123;<br>    <span class="hljs-comment">//ç•¥..</span><br>    <span class="hljs-comment">//dispatch_group çš„æ–¹å¼å›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œ block</span><br>    <span class="hljs-keyword">if</span> (error) &#123;<br>        dispatch_group_async(<br>                manager.completionGroup ?: <br>                url_session_manager_completion_group(),<br>                manager.completionQueue ?: <br>                dispatch_get_main_queue(), ^&#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.completionHandler) &#123;<br>                <span class="hljs-keyword">self</span>.completionHandler(task.response, responseObject, error);<br>            &#125;<br>            <span class="hljs-comment">//ç•¥..</span><br>            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>                [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] <br>                postNotificationName:AFNetworkingTaskDidCompleteNotification <br>                object:task <br>                userInfo:userInfo];<span class="hljs-comment">//å‘é€é€šçŸ¥</span><br>            &#125;);<br>        &#125;);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">dispatch_async</span>(url_session_manager_processing_queue(), ^&#123;<br>            <span class="hljs-comment">//æ‰§è¡Œå›è°ƒ&amp;å‘é€é€šçŸ¥ ä»£ç ç•¥..</span><br>            &#125;);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•ä¸ AFURLSessionManager ç±»å…³è”èµ·æ¥çš„å‘¢ï¼Ÿ</p><p><code>#1.2</code>ç« èŠ‚ä¸­è¯´åˆ°ï¼ŒAFURLSessionManager æœ€ç»ˆä¼šé€šè¿‡ç»Ÿä¸€çš„å…¥å£è°ƒç”¨çˆ¶ç±»ä¸­çš„æ–¹æ³•å‘èµ·è¯·æ±‚ã€‚åœ¨çˆ¶ç±»å‘èµ·ç½‘ç»œè¯·æ±‚åï¼Œç´§æ¥ç€å°±ä¼šè°ƒç”¨åˆ° - addDelegateForDataTask:uploadProgress:downloadProgress:completionHandler:å‡½æ•°ï¼Œè·Ÿè¸ªä»£ç è¿›æ¥ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-operator">-</span> (<span class="hljs-keyword">void</span>)addDelegateForDataTask<span class="hljs-operator">:</span>(NSURLSessionDataTask <span class="hljs-operator">*</span>)dataTask<br>uploadProgress<span class="hljs-operator">:</span>(<span class="hljs-keyword">void</span> (<span class="hljs-operator">^</span>)(NSProgress <span class="hljs-operator">*</span>uploadProgress)) uploadProgressBlock<br>downloadProgress<span class="hljs-operator">:</span>(<span class="hljs-keyword">void</span> (<span class="hljs-operator">^</span>)(NSProgress <span class="hljs-operator">*</span>downloadProgress))<br>downloadProgressBlock<br>completionHandler<span class="hljs-operator">:</span>(<span class="hljs-keyword">void</span> (<span class="hljs-operator">^</span>)(<br>NSURLResponse <span class="hljs-operator">*</span>response, <span class="hljs-built_in">id</span> responseObject, NSError <span class="hljs-operator">*</span>error))<span class="hljs-keyword">completionHandler</span><br>&#123;<br>    AFURLSessionManagerTaskDelegate <span class="hljs-operator">*</span><span class="hljs-keyword">delegate</span> <span class="hljs-operator">=</span> [[AFURLSessionManagerTaskDelegate <br>    alloc] init];<br>    <span class="hljs-keyword">delegate</span>.manager <span class="hljs-operator">=</span> self;<br>    <span class="hljs-keyword">delegate</span>.completionHandler <span class="hljs-operator">=</span> completionHandler;<br><br>    dataTask.taskDescription <span class="hljs-operator">=</span> self.taskDescriptionForSessionTasks;<br>    [self setDelegate<span class="hljs-operator">:</span><span class="hljs-keyword">delegate</span> forTask<span class="hljs-operator">:</span>dataTask];<br><br>    <span class="hljs-keyword">delegate</span>.uploadProgressBlock <span class="hljs-operator">=</span> uploadProgressBlock;<br>    <span class="hljs-keyword">delegate</span>.downloadProgressBlock <span class="hljs-operator">=</span> downloadProgressBlock;<br>&#125;<br><span class="hljs-operator">-</span> (<span class="hljs-keyword">void</span>)setDelegate<span class="hljs-operator">:</span>(AFURLSessionManagerTaskDelegate <span class="hljs-operator">*</span>)<span class="hljs-keyword">delegate</span><br>forTask<span class="hljs-operator">:</span>(NSURLSessionTask <span class="hljs-operator">*</span>)task<br>&#123;<br>    [self.<span class="hljs-built_in">lock</span> <span class="hljs-built_in">lock</span>];<span class="hljs-comment">//ä¿è¯è¯»å†™æ“ä½œçš„çº¿ç¨‹å®‰å…¨</span><br>    self.mutableTaskDelegatesKeyedByTaskIdentifier<br>    [<span class="hljs-operator">@</span>(task.taskIdentifier)] <span class="hljs-operator">=</span> <span class="hljs-keyword">delegate</span>; <span class="hljs-comment">//ä»¥taskçš„æ ‡è¯†ç¬¦ä¸ºé”®ï¼Œä¸delegateè¿›è¡Œæ˜ å°„</span><br>    <br>    [<span class="hljs-keyword">delegate</span> setupProgressForTask<span class="hljs-operator">:</span>task];<br>    [self addNotificationObserverForTask<span class="hljs-operator">:</span>task];<br>    [self.<span class="hljs-built_in">lock</span> unlock];<br>&#125;<br><span class="hljs-operator">-</span> (AFURLSessionManagerTaskDelegate <span class="hljs-operator">*</span>)delegateForTask<span class="hljs-operator">:</span><br>(NSURLSessionTask <span class="hljs-operator">*</span>)<span class="hljs-keyword">task</span> <br>&#123;<br>    AFURLSessionManagerTaskDelegate <span class="hljs-operator">*</span><span class="hljs-keyword">delegate</span> <span class="hljs-operator">=</span> nil;<br>    [self.<span class="hljs-built_in">lock</span> <span class="hljs-built_in">lock</span>];<br>    <span class="hljs-keyword">delegate</span> <span class="hljs-operator">=</span> self.mutableTaskDelegatesKeyedByTaskIdentifier[<span class="hljs-operator">@</span>(task.taskIdentifier)];<br>    [self.<span class="hljs-built_in">lock</span> unlock];<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">delegate</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼ŒAFURLSessionManagerTaskDelegate æ˜¯é€šè¿‡ -setDelegate:forTask: æ–¹æ³•ï¼Œä½œä¸º AFURLSessionManager ä¸­ NSMutableDictionary *mutableTaskDelegatesKeyedByTaskIdentifier å­—å…¸å±æ€§çš„ value è¢«ä¿å­˜èµ·æ¥çš„ï¼Œkey åˆ™æ˜¯ NSURLSessionTask çš„ä»»åŠ¡æ ‡è¯†ç¬¦ã€‚åé¢ç”¨åˆ°æ—¶åˆé€šè¿‡-delegateForTask: æ ¹æ®æ ‡è¯†ç¬¦å–å‡ºtaskå¯¹åº”çš„ä»£ç†ã€‚</p><p>psï¼šAFURLSessionManagerTaskDelegate å®šä¹‰é‡Œæœ‰ä¸ªå±æ€§ï¼šAFURLSessionManager *managerï¼Œåœ¨å‡½æ•° -addDelegateForDataTask:uploadProgress:downloadProgress:completionHandler: é‡Œè¿™ä¸ª manager è¢«è®¾ç½®ä¸º selfã€‚é‚£ä¹ˆè¿™é‡Œå­˜åœ¨ä¸€ä¸ªå¼•ç”¨é“¾ï¼šAFURLSessionManager -&gt; mutableTaskDelegatesKeyedByTaskIdentifier -&gt; AFURLSessionManagerTaskDelegate -&gt; AFURLSessionManagerã€‚</p><p>è¿™é‡Œçœ‹ä¼¼æœ‰ä¸ªç›¸äº’å¼•ç”¨é—®é¢˜ï¼ŒAFN çš„å¤„ç†æ˜¯ä½¿ç”¨ weak å£°æ˜ manager å±æ€§ï¼ˆè§ä¸Šé¢çš„å®šä¹‰ï¼‰ï¼Œå¹¶ä¸”åœ¨è¯·æ±‚æ‰§è¡Œå®Œæˆåçš„å›è°ƒå‡½æ•°é‡Œåšäº†å¦‚ä¸‹å¤„ç†ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>didCompleteWithError:(<span class="hljs-built_in">NSError</span> *)error<br>&#123;<br>    AFURLSessionManagerTaskDelegate *delegate = [<span class="hljs-keyword">self</span> delegateForTask:task];<br>    <span class="hljs-keyword">if</span> (delegate) &#123;<br>        [delegate URLSession:session task:task didCompleteWithError:error];<br>        [<span class="hljs-keyword">self</span> removeDelegateForTask:task];<span class="hljs-comment">//æ³¨æ„ å°±æ˜¯è¿™ä¸€ä¸ªæ“ä½œ</span><br>    &#125;<br>&#125;<br>- (<span class="hljs-type">void</span>)removeDelegateForTask:(<span class="hljs-built_in">NSURLSessionTask</span> *)task <br>&#123;<br>    <span class="hljs-comment">//ã€‚ã€‚ã€‚</span><br>    [<span class="hljs-keyword">self</span>.lock lock];<br>    <span class="hljs-comment">//ç§»é™¤ AFURLSessionManagerTaskDelegate å¯¹è±¡</span><br>    [<span class="hljs-keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier <br>    removeObjectForKey:@(task.taskIdentifier)];<br>    [<span class="hljs-keyword">self</span>.lock unlock];<br>&#125;<br></code></pre></td></tr></table></figure><p>AFURLSessionManagerTaskDelegate å¯¹è±¡è¢«ä» mutableTaskDelegatesKeyedByTaskIdentifier å­—å…¸ä¸­ç§»é™¤ã€‚é‚£ä¹ˆè¿™ä¸ªå¼•ç”¨é“¾å°±è¢«æ‰“ç ´ï¼Œä¹Ÿå°±ä¸å­˜åœ¨ç›¸äº’å¼•ç”¨é—®é¢˜äº†ã€‚</p><h4 id="3-4-è¿›åº¦çš„ç›‘å¬"><a href="#3-4-è¿›åº¦çš„ç›‘å¬" class="headerlink" title="3.4.è¿›åº¦çš„ç›‘å¬"></a>3.4.è¿›åº¦çš„ç›‘å¬</h4><p>TaskDelegate ä½œä¸ºâ€œä»£ç†â€ä¼šç›‘å¬ä»»åŠ¡çš„è¿›åº¦ã€‚å…¶å†…éƒ¨æ˜¯é€šè¿‡ KVO ç›‘å¬ NSURLSessionTask çš„ countOfBytesSent ç­‰å­—æ®µå®ç°çš„ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)setupProgressForTask:(<span class="hljs-built_in">NSURLSessionTask</span> *)task <br>&#123;<br>    <span class="hljs-comment">//ã€‚ã€‚ã€‚</span><br>    [task addObserver:<span class="hljs-keyword">self</span><br>           forKeyPath:<span class="hljs-built_in">NSStringFromSelector</span>(<span class="hljs-keyword">@selector</span>(countOfBytesReceived))<br>              options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span><br>              context:<span class="hljs-literal">NULL</span>];<br>    [task addObserver:<span class="hljs-keyword">self</span><br>           forKeyPath:<span class="hljs-built_in">NSStringFromSelector</span>(<span class="hljs-keyword">@selector</span>(countOfBytesExpectedToReceive))<br>              options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span><br>              context:<span class="hljs-literal">NULL</span>];<br><br>    [task addObserver:<span class="hljs-keyword">self</span><br>           forKeyPath:<span class="hljs-built_in">NSStringFromSelector</span>(<span class="hljs-keyword">@selector</span>(countOfBytesSent))<br>              options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span><br>              context:<span class="hljs-literal">NULL</span>];<br>    [task addObserver:<span class="hljs-keyword">self</span><br>           forKeyPath:<span class="hljs-built_in">NSStringFromSelector</span>(<span class="hljs-keyword">@selector</span>(countOfBytesExpectedToSend))<br>              options:<span class="hljs-built_in">NSKeyValueObservingOptionNew</span><br>              context:<span class="hljs-literal">NULL</span>];<br>    <span class="hljs-comment">//ã€‚ã€‚ã€‚</span><br>&#125;<br><br>- (<span class="hljs-type">void</span>)observeValueForKeyPath:(<span class="hljs-built_in">NSString</span> *)keyPath <br>ofObject:(<span class="hljs-type">id</span>)object <br>change:(<span class="hljs-built_in">NSDictionary</span> *)change <br>context:(<span class="hljs-type">void</span> *)context <br>&#123;<br>    <span class="hljs-keyword">if</span> ([object isKindOfClass:[<span class="hljs-built_in">NSURLSessionTask</span> <span class="hljs-keyword">class</span>]] || <br>    [object isKindOfClass:[<span class="hljs-built_in">NSURLSessionDownloadTask</span> <span class="hljs-keyword">class</span>]]) &#123;<br>        <span class="hljs-keyword">if</span> ([keyPath isEqualToString:<br>        <span class="hljs-built_in">NSStringFromSelector</span>(<span class="hljs-keyword">@selector</span>(countOfBytesReceived))]) &#123;<br>            <span class="hljs-keyword">self</span>.downloadProgress.completedUnitCount = <br>            [change[<span class="hljs-built_in">NSKeyValueChangeNewKey</span>] longLongValue];<br>        &#125;<br>        <span class="hljs-comment">//ã€‚ã€‚ã€‚</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([object isEqual:<span class="hljs-keyword">self</span>.downloadProgress]) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.downloadProgressBlock) &#123;<br>            <span class="hljs-keyword">self</span>.downloadProgressBlock(object);<span class="hljs-comment">//ä¸‹è½½å›è°ƒ</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([object isEqual:<span class="hljs-keyword">self</span>.uploadProgress]) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.uploadProgressBlock) &#123;<br>            <span class="hljs-keyword">self</span>.uploadProgressBlock(object);<span class="hljs-comment">//ä¸Šä¼ å›è°ƒ</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å››ã€Serialization"><a href="#å››ã€Serialization" class="headerlink" title="å››ã€Serialization"></a>å››ã€Serialization</h3><h4 id="4-1-AFURLRequestSerialization"><a href="#4-1-AFURLRequestSerialization" class="headerlink" title="4.1.AFURLRequestSerialization"></a>4.1.AFURLRequestSerialization</h4><p>æ ¹æ®ç”¨æˆ·è®¾ç½®çš„è¯·æ±‚ç±»å‹ï¼Œè®¾ç½® NSURLRequest çš„å„é¡¹å‚æ•°ã€‚</p><ul><li>è‡ªå®šä¹‰å±æ€§å‚æ•°ï¼š</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">NSStringEncoding</span> stringEncoding;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-type">BOOL</span> allowsCellularAccess;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">NSURLRequestCachePolicy</span> cachePolicy;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-type">BOOL</span> HTTPShouldHandleCookies;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-type">BOOL</span> HTTPShouldUsePipelining;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">NSURLRequestNetworkServiceType</span> networkServiceType;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">NSTimeInterval</span> timeoutInterval;<br></code></pre></td></tr></table></figure><ul><li>è®¾ç½®è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ï¼š</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="hljs-built_in">NSString</span> *)method<br>URLString:(<span class="hljs-built_in">NSString</span> *)URLString<br>parameters:(<span class="hljs-type">id</span>)parameters<br>error:(<span class="hljs-built_in">NSError</span> *)error<br>&#123;<br>    <span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:URLString];<br>    <span class="hljs-built_in">NSMutableURLRequest</span> *mutableRequest = [[<span class="hljs-built_in">NSMutableURLRequest</span> <br>    alloc] initWithURL:url];<br>    <span class="hljs-comment">//è®¾ç½®HTTPMethodï¼ˆGET POSTç­‰ï¼‰</span><br>    mutableRequest.HTTPMethod = method;<br>    <span class="hljs-comment">//ã€‚ã€‚</span><br>    mutableRequest = [[<span class="hljs-keyword">self</span> requestBySerializingRequest:mutableRequest <br>    withParameters:parameters <br>    error:error] mutableCopy];<br>    <span class="hljs-keyword">return</span> mutableRequest;<br>&#125;<br><br>- (<span class="hljs-built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request<br>withParameters:(<span class="hljs-type">id</span>)parameters<br>error:(<span class="hljs-built_in">NSError</span> *)error<br>&#123;<br>    <span class="hljs-comment">//ã€‚ã€‚ã€‚</span><br>    <span class="hljs-keyword">if</span> (parameters) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.queryStringSerialization) &#123;<span class="hljs-comment">//å¦‚æœæœ‰è‡ªå®šä¹‰çš„è§£ææ–¹å¼</span><br>            <span class="hljs-built_in">NSError</span> *serializationError;<br>            query = <span class="hljs-keyword">self</span>.queryStringSerialization(<br>            request, parameters, &amp;serializationError);<br>            <span class="hljs-comment">//...</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//é»˜è®¤çš„è§£ææ–¹å¼</span><br>            <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">self</span>.queryStringSerializationStyle) &#123;<br>                <span class="hljs-keyword">case</span> AFHTTPRequestQueryStringDefaultStyle:<br>                    query = AFQueryStringFromParameters(parameters);<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//å¦‚æœæ˜¯GETã€HEADã€DELETEæ–¹æ³•ï¼Œå‚æ•°è¿½åŠ åˆ° URL å°¾éƒ¨</span><br>    <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.HTTPMethodsEncodingParametersInURI containsObject:<br>        [[request HTTPMethod] uppercaseString]]) &#123;<br>        <span class="hljs-keyword">if</span> (query &amp;&amp; query.length &gt; <span class="hljs-number">0</span>) &#123;<br>            mutableRequest.URL = [<span class="hljs-built_in">NSURL</span> URLWithString:<br>            [[mutableRequest.URL absoluteString] <br>            stringByAppendingFormat:mutableRequest.URL.query <br>            ? <span class="hljs-string">@&quot;&amp;%@&quot;</span> : <span class="hljs-string">@&quot;?%@&quot;</span>, query]];<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//POSTã€PUTæ–¹æ³•çš„å‚æ•°ä¼šæ”¾åˆ° HTTPBody é‡Œ</span><br>        <span class="hljs-keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="hljs-string">@&quot;Content-Type&quot;</span>]) &#123;<br>            [mutableRequest setValue:<br>            <span class="hljs-string">@&quot;application/x-www-form-urlencoded&quot;</span> <br>            forHTTPHeaderField:<span class="hljs-string">@&quot;Content-Type&quot;</span>];<br>        &#125;<br>        <span class="hljs-comment">//è®¾ç½®HTTPBody</span><br>        [mutableRequest setHTTPBody:<br>        [query dataUsingEncoding:<span class="hljs-keyword">self</span>.stringEncoding]];<br>    &#125;<br>    <span class="hljs-keyword">return</span> mutableRequest;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-2-AFHTTPResponseSerializer"><a href="#4-2-AFHTTPResponseSerializer" class="headerlink" title="4.2.AFHTTPResponseSerializer"></a>4.2.AFHTTPResponseSerializer</h4><p>æ ¡éªŒè¿”å›çš„<code>response</code>å’Œ<code>data</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)validateResponse:(<span class="hljs-built_in">NSHTTPURLResponse</span> *)response<br>                    data:(<span class="hljs-built_in">NSData</span> *)data<br>                   error:(<span class="hljs-built_in">NSError</span> * __autoreleasing *)error<br>&#123;<br>    <span class="hljs-type">BOOL</span> responseIsValid = <span class="hljs-literal">YES</span>;<br>    <span class="hljs-built_in">NSError</span> *validationError = <span class="hljs-literal">nil</span>;<br><br>    <span class="hljs-keyword">if</span> (response &amp;&amp; [response isKindOfClass:[<span class="hljs-built_in">NSHTTPURLResponse</span> <span class="hljs-keyword">class</span>]]) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.acceptableContentTypes &amp;&amp; <br>            ![<span class="hljs-keyword">self</span>.acceptableContentTypes containsObject:[response MIMEType]] &amp;&amp;<br>            !([response MIMEType] == <span class="hljs-literal">nil</span> &amp;&amp; [data length] == <span class="hljs-number">0</span>)) &#123;<br><br>            <span class="hljs-keyword">if</span> ([data length] &gt; <span class="hljs-number">0</span> &amp;&amp; [response URL]) &#123;<br>                <span class="hljs-comment">//ä¸æ”¯æŒçš„ content-type</span><br>                <span class="hljs-comment">//...ç•¥</span><br>                responseIsValid = <span class="hljs-literal">NO</span>;<br>            &#125;<br>            responseIsValid = <span class="hljs-literal">NO</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.acceptableStatusCodes &amp;&amp; <br>            ![<span class="hljs-keyword">self</span>.acceptableStatusCodes containsIndex:(<span class="hljs-built_in">NSUInteger</span>)response.statusCode] &amp;&amp; <br>            [response URL]) &#123;<br>                <span class="hljs-comment">//è¿”å›äº†ä¸æ”¯æŒçš„çŠ¶æ€ç </span><br>                <span class="hljs-comment">//...ç•¥</span><br>            responseIsValid = <span class="hljs-literal">NO</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (error &amp;&amp; !responseIsValid) &#123;<br>        *error = validationError;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> responseIsValid;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="äº”ã€Reachability"><a href="#äº”ã€Reachability" class="headerlink" title="äº”ã€Reachability"></a>äº”ã€Reachability</h3><p>ä½¿ç”¨ SystemConfiguration.framework ä¸­çš„ SCNetworkReachability ç±»ï¼Œç›‘å¬ç½‘ç»œçŠ¶æ€ï¼Œä¸»è¦å±æ€§ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> The current network reachability status.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) AFNetworkReachabilityStatus networkReachabilityStatus;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„ç½‘ç»œçŠ¶å†µæšä¸¾å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">typedef NS_ENUM(NSInteger, AFNetworkReachabilityStatus) &#123;<br>    AFNetworkReachabilityStatusUnknown          = -<span class="hljs-number">1</span>,<span class="hljs-regexp">//</span>æœªçŸ¥<br>    AFNetworkReachabilityStatusNotReachable     = <span class="hljs-number">0</span>, <span class="hljs-regexp">//</span>æœªè”ç½‘<br>    AFNetworkReachabilityStatusReachableViaWWAN = <span class="hljs-number">1</span>, <span class="hljs-regexp">//</span>èœ‚çªç½‘ç»œ<br>    AFNetworkReachabilityStatusReachableViaWiFi = <span class="hljs-number">2</span>, <span class="hljs-regexp">//</span>WIFI<br>    AFNetworkReachabilityStatusReachableVia2G = <span class="hljs-number">3</span>,   <span class="hljs-regexp">//</span><span class="hljs-number">2</span>G<br>    AFNetworkReachabilityStatusReachableVia3G = <span class="hljs-number">4</span>,   <span class="hljs-regexp">//</span><span class="hljs-number">3</span>G<br>    AFNetworkReachabilityStatusReachableVia4G = <span class="hljs-number">5</span>,   <span class="hljs-regexp">//</span><span class="hljs-number">4</span>G<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¯åœ¨ AppDelegate ä¸­å¼€å¯ç½‘ç»œçŠ¶æ€çš„ç›‘å¬ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application <br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//å¼€å¯AFNetworkingç½‘ç»œç›‘æµ‹</span><br>    AFNetworkReachabilityManager *shareMana = [AFNetworkReachabilityManager sharedManager];<br>    [shareMana startMonitoring];<br>    [shareMana setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) &#123;<br>        <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>            <span class="hljs-comment">// ...</span><br>        &#125;);<br>    &#125;];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å…­ã€Security"><a href="#å…­ã€Security" class="headerlink" title="å…­ã€Security"></a>å…­ã€Security</h3><p>å¤„ç†ä¸æœåŠ¡å™¨äº¤äº’æ—¶çš„éªŒè¯é—®é¢˜ï¼Œä¿è¯åº”ç”¨ä¸æœåŠ¡å™¨é€šä¿¡æ—¶çš„SSLè¿æ¥å®‰å…¨ã€‚</p><p>å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›è¡Œé€šä¿¡æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªSSLè¯ä¹¦ï¼Œå®¢æˆ·ç«¯éœ€è¦éªŒè¯è¯ä¹¦çš„é¢å‘æœºæ„ã€å…¬é’¥ã€æ˜¯å¦è¿‡æœŸç­‰ä¿¡æ¯ã€‚SSL Pinning å°±æ˜¯iOSä¸­ç”¨æ¥å¤„ç†æ­¤ç±»äº‹åŠ¡çš„ï¼Œå®ƒå¯ä»¥æŒ‰ç…§ä½ çš„è®¾ç½®ï¼Œå°†æœåŠ¡å™¨ä¸‹å‘çš„è¯ä¹¦ä¸æœ¬åœ°ä¿å­˜çš„è¯ä¹¦è¿›è¡Œå¯¹æ¯”ï¼ŒéªŒè¯é€šè¿‡æ‰èƒ½ç»§ç»­é€šä¿¡ã€‚è¿™äº›è®¾ç½®åœ¨ AFN ä¸­åˆ†ä¸‰ç±»ï¼š</p><hr><table><thead><tr><th>éªŒè¯æ¨¡å¼</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>AFSSLPinningModeNone</td><td>å®¢æˆ·ç«¯æ— æ¡ä»¶åœ°ä¿¡ä»»æœåŠ¡å™¨ç«¯è¿”å›çš„è¯ä¹¦ï¼Œä¸åšæ ¡éªŒï¼›</td></tr><tr><td>AFSSLPinningModePublicKey</td><td>åªéªŒè¯æœåŠ¡å™¨ç«¯è¿”å›çš„è¯ä¹¦ä¸­å…¬é’¥çš„éƒ¨åˆ†ï¼Œä¸æœ¬åœ°è¯ä¹¦ä¸€è‡´æ‰ç»§ç»­ï¼›æœ‰æ•ˆæœŸç­‰ä¸åšæ ¡éªŒï¼ˆçœå»è¿‡æœŸçš„éº»çƒ¦ï¼‰ï¼›</td></tr><tr><td>AFSSLPinningModeCertificate</td><td>éªŒè¯æœåŠ¡å™¨ç«¯è¿”å›çš„è¯ä¹¦å’Œæœ¬åœ°ä¿å­˜çš„è¯ä¹¦ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œæœ‰ä¸€é¡¹ä¸ç¬¦åˆåˆ™éªŒè¯å¤±è´¥ï¼›</td></tr></tbody></table><hr><p>AFN ä¼šæ ¹æ®ç”¨æˆ·è®¾ç½®çš„éªŒè¯æ¨¡å¼å¤„ç† SSL Pinning éªŒè¯ä¸šåŠ¡ã€‚å…¶ä¸­åä¸¤ç§éªŒè¯æ¨¡å¼éœ€è¦å°†æœåŠ¡å™¨çš„è¯ä¹¦æ–‡ä»¶æ‹·è´ä¸€ä»½ä¿å­˜åˆ°å·¥ç¨‹ç›®å½•ä¸­ã€‚</p><ul><li><strong>å…·ä½“å®è·µ</strong>ï¼š</li></ul><p>AFNçš„ AFHTTPSessionManager ç±»ä¸­æœ‰ä¸ª<code>securityPolicy</code>å±æ€§ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> The security policy used by created session to evaluate server trust for secure connections. </span><br><span class="hljs-comment"> *`AFURLSessionManager` uses the `defaultPolicy` unless otherwise specified.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) AFSecurityPolicy *securityPolicy;<br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬æˆ‘ä»¬æ˜¯åœ¨åŸºäº AFHTTPSessionManager çš„å•ä¾‹ç±»ä¸­ç»™ securityPolicy å±æ€§æŒ‡å®šä¸€ä¸ªéªŒè¯æ¨¡å¼ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">TLHttpAPIClient</span> : <span class="hljs-title">AFHTTPSessionManager</span></span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">TLHttpAPIClient</span></span><br>+ (<span class="hljs-keyword">instancetype</span>)sharedClient &#123;<br>    <span class="hljs-keyword">static</span> TLHttpAPIClient *sharedClient = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br>        sharedClient = [TLHttpAPIClient new];<br>        <br>        <span class="hljs-comment">// è®¾ç½®è¯ä¹¦éªŒè¯æ¨¡å¼</span><br>        AFSecurityPolicy *securityPolicy = [AFSecurityPolicy policyWithPinningMode:<br>                                                        AFSSLPinningModeCertificate];<br>        <span class="hljs-comment">// è¯ä¹¦åœ¨bundleä¸­çš„è·¯å¾„</span><br>        <span class="hljs-built_in">NSString</span> *cerPath = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string">@&quot;Demo&quot;</span> ofType:<span class="hljs-string">@&quot;cer&quot;</span>];<br>        <span class="hljs-built_in">NSData</span> *cerData  = [<span class="hljs-built_in">NSData</span> dataWithContentsOfFile:cerPath];<br>        [securityPolicy setPinnedCertificates:@[cerData]];<br>        <br>        sharedClient.securityPolicy = securityPolicy;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> sharedClient;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è‹¥ä½¿ç”¨ AFSSLPinningModeNone æ¨¡å¼ï¼Œåˆ™ä¸ç”¨è®¾ç½®è¯ä¹¦è·¯å¾„ã€‚ä½¿ç”¨è¯ä¹¦è¿›è¡ŒéªŒè¯æ—¶ï¼Œæ³¨æ„è¯ä¹¦æ˜¯å¦è¿‡æœŸã€‚</p><h3 id="ä¸ƒã€å°ç»“"><a href="#ä¸ƒã€å°ç»“" class="headerlink" title="ä¸ƒã€å°ç»“"></a>ä¸ƒã€å°ç»“</h3><p>æºç éƒ¨åˆ†æš‚æ—¶å…ˆå†™åˆ°è¿™ï¼ŒUIKit+AFNetworking éƒ¨åˆ†åŠå…¶ä»–ç»†èŠ‚å¾…ç»­~~è¯´è¯´ç›®å‰å¯¹AFNçš„æ„Ÿå—å§ã€‚</p><ul><li>è¯·æ±‚ã€åºåˆ—åŒ–ã€å®‰å…¨ã€ç½‘ç»œçŠ¶æ€ç­‰æ¨¡å—åˆ†å·¥æ¸…æ™°ï¼ŒèŒè´£æ˜ç¡®ï¼Œé«˜èšåˆã€ä½è€¦åˆï¼›</li><li>å¤§é‡ä½¿ç”¨ blockã€Cå‡½æ•°ï¼›</li><li>3.0ä¹‹åçš„ç‰ˆæœ¬æ­£å¼é‡‡ç”¨NSURLSessionï¼Œå¯¹å„ç§è¯·æ±‚è¿›è¡Œäº†å°è£…ï¼Œæ¥å£åˆ†å·¥æ˜ç¡®ï¼›</li><li>å¤©ç„¶ä½¿ç”¨å¼‚æ­¥è¯·æ±‚ï¼Œçœå»äº†2.xç‰ˆæœ¬ä¸­å°è£… NSOperation æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡å’Œæ§åˆ¶å¹¶å‘çš„éº»çƒ¦ï¼›</li><li>ä½¿ç”¨ defaultSessionConfiguration æ—¶ HTTPMaximumConnectionsPerHost å±æ€§é»˜è®¤ä¸º4 ï¼Œå³æ¯ä¸ªä¸»æœºé»˜è®¤åŒæ—¶å¹¶å‘è¯·æ±‚æ•°ä¸º4ä¸ªï¼›å¿…è¦æ—¶ä¹Ÿå¯è‡ªå·±æä¾›é¢å¤–çš„ OperationManager æ§åˆ¶å¹¶å‘ï¼›</li></ul><p>å¤šç¿»ç¿» AFN åœ¨Githubä¸Šçš„ <a href="https://github.com/AFNetworking/AFNetworking/issues">issue</a> å’Œè§£å†³æ–¹æ¡ˆï¼Œçœ‹äººå®¶æ˜¯æ€ä¹ˆè§£å†³é—®é¢˜çš„ï¼Œä¼šæœ‰å¾ˆå¤šæ”¶è·~</p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SDWebImage</title>
    <link href="/2018/01/28/source_code_sd.html"/>
    <url>/2018/01/28/source_code_sd.html</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€å¯¼å…¥-SDåº“ï¼š"><a href="#ä¸€ã€å¯¼å…¥-SDåº“ï¼š" class="headerlink" title="ä¸€ã€å¯¼å…¥ SDåº“ï¼š"></a>ä¸€ã€å¯¼å…¥ <a href="https://github.com/rs/SDWebImage">SDåº“</a>ï¼š</h3><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs delphi"><span class="hljs-keyword">platform</span> :ios, <span class="hljs-string">&#x27;10.0&#x27;</span><br><span class="hljs-comment">//ASDFæ›¿æ¢ä¸ºè‡ªå·±é¡¹ç›®çš„targetå</span><br>target â€˜ASDFâ€™ <span class="hljs-keyword">do</span><br>pod <span class="hljs-string">&#x27;SDWebImage&#x27;</span>, <span class="hljs-string">&#x27;~&gt; 3.7.3&#x27;</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><h3 id="äºŒã€ä¸‹è½½ç±»çš„å®ç°"><a href="#äºŒã€ä¸‹è½½ç±»çš„å®ç°" class="headerlink" title="äºŒã€ä¸‹è½½ç±»çš„å®ç°"></a>äºŒã€ä¸‹è½½ç±»çš„å®ç°</h3><p>ä»¥å¸¸ç”¨çš„<code>UIImageView</code>è®¾ç½®å›¾ç‰‡ä¸ºä¾‹ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(void)</span>sd_setImageWithURL:<span class="hljs-params">(NSURL *)</span>url <br>          placeholderImage:<span class="hljs-params">(UIImage *)</span>placeholder <br>                   options:<span class="hljs-params">(SDWebImageOptions)</span>options <br>                  progress:<span class="hljs-params">(SDWebImageDownloaderProgressBlock)</span>progressBlock <br>                 completed:<span class="hljs-params">(SDWebImageCompletionBlock)</span>completedBlock;<br></code></pre></td></tr></table></figure><p>å‚æ•°</p><ul><li>urlä¸ºå›¾ç‰‡åœ°å€ã€‚</li><li>placeholderä¸ºå ä½å›¾ã€‚</li><li>progressBlockä¸ºè¿›åº¦ã€‚</li><li>completedBlockä¸‹è½½å®Œæˆæˆ–æœ‰ç¼“å­˜æ—¶çš„å›è°ƒã€‚</li><li>optionsä¸ºé¢å¤–é€‰é¡¹ï¼Œä¸€èˆ¬ä½¿ç”¨ SDWebImageRetryFailed | SDWebImageLowPriorityï¼Œå…·ä½“å¦‚ä¸‹ï¼š</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">typedef NS_OPTIONS(NSUInteger, SDWebImageOptions) &#123;<br><br>    SDWebImageRetryFailed = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>,    <span class="hljs-regexp">//</span>ä¸‹è½½å¤±è´¥äº†ä¼šå†æ¬¡å°è¯•ä¸‹è½½(é»˜è®¤æƒ…å†µä¸‹å¤±è´¥çš„å›¾ç‰‡é“¾æ¥ä¸ä¼šå†é‡æ–°ä¸‹è½½)<br>    WebImageLowPriority = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,      <span class="hljs-regexp">//</span>UIScrollViewç­‰æ­£åœ¨æ»šåŠ¨æ—¶å»¶è¿Ÿä¸‹è½½å›¾ç‰‡ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸å»¶è¿Ÿï¼Œç«‹åˆ»å¼€å§‹ï¼‰<br>    SDWebImageCacheMemoryOnly = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,<span class="hljs-regexp">//</span>åªç¼“å­˜åˆ°å†…å­˜ä¸­<br>    SDWebImageProgressiveDownload = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,<span class="hljs-regexp">//</span> å›¾ç‰‡ä¼šè¾¹ä¸‹è¾¹æ˜¾ç¤º<br>    SDWebImageRefreshCached = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>, <span class="hljs-regexp">//</span>å¼ºåˆ¶é‡æ–°è¯·æ±‚å›¾ç‰‡å¹¶åˆ·æ–°ç¼“å­˜ï¼Œå°†ç¡¬ç›˜ç¼“å­˜äº¤ç»™ç³»ç»Ÿè‡ªå¸¦çš„NSURLCacheå»å¤„ç†<br>    SDWebImageContinueInBackground = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,<span class="hljs-regexp">//</span>åå°ä¸‹è½½<br>    SDWebImageHandleCookies = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>, <span class="hljs-regexp">//</span>å¤„ç†cookieï¼Œè¯·æ±‚çš„request.HTTPShouldHandleCookies ä¼šè¢«ç½®ä¸º YES;<br>    SDWebImageAllowInvalidSSLCertificates = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,<span class="hljs-regexp">//</span> å…è®¸ä¸å—ä¿¡ä»»çš„SSLè¯ä¹¦<br>    SDWebImageHighPriority = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>,  <span class="hljs-regexp">//</span>ä¼˜å…ˆä¸‹è½½ï¼Œä¸‹è½½ä»»åŠ¡çš„ä¼˜å…ˆçº§ä¸ºé«˜<br>    SDWebImageDelayPlaceholder = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>,<span class="hljs-regexp">//</span>å»¶è¿Ÿå ä½ç¬¦<br>    SDWebImageTransformAnimatedImage = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">10</span>,<span class="hljs-regexp">//</span>æ”¹å˜åŠ¨ç”»å½¢è±¡<br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="2-1-UIImageView-WebCache"><a href="#2-1-UIImageView-WebCache" class="headerlink" title="2.1.UIImageView+WebCache"></a>2.1.UIImageView+WebCache</h4><p>ä¸»è¦è´Ÿè´£å¯¹å¤–æš´éœ²è®¾ç½®å›¾ç‰‡çš„æ¥å£ï¼Œæœ¬ç±»ä¸­å…·ä½“å¤„ç†çš„äº‹é¡¹åŒ…æ‹¬ï¼š</p><ul><li>step.1 åœ¨æ–°çš„å›¾ç‰‡åŠ è½½å‰ï¼Œå–æ¶ˆæœ¬è§†å›¾ä¸Šä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„ä¸‹è½½ä»»åŠ¡ï¼›</li><li>step.2 äº¤ç”± SDWebImageManager å¤„ç†çœŸæ­£çš„å›¾ç‰‡ä¸‹è½½é€»è¾‘ï¼›</li><li>step.3 ä¿å­˜æ­¤æ¬¡ä¸‹è½½æ“ä½œï¼›</li><li>step.4 å›¾ç‰‡ä¸‹è½½æˆåŠŸæˆ–å¤±è´¥ï¼Œå›åˆ°ä¸»çº¿ç¨‹å›è°ƒæ•°æ®å¹¶ç»™è§†å›¾è®¾ç½®å›¾ç‰‡ï¼›</li></ul><p>æºç æ‘˜è¦ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// UIImageView+WebCache.m</span><br><br>- (<span class="hljs-type">void</span>)sd_setImageWithURL:(<span class="hljs-built_in">NSURL</span> *)url<br>placeholderImage:(<span class="hljs-built_in">UIImage</span> *)placeholder<br>options:(SDWebImageOptions)options<br>progress:(SDWebImageDownloaderProgressBlock)progressBlock<br>completed:(SDWebImageCompletionBlock)completedBlock<br>&#123;<br>    <span class="hljs-comment">//step.1 å–æ¶ˆä¹‹å‰æ­£åœ¨ä¸‹è½½çš„æ“ä½œ</span><br>    [<span class="hljs-keyword">self</span> sd_cancelCurrentImageLoad];<br>    <span class="hljs-comment">//ä¿å­˜è¯¥è§†å›¾ç”¨åˆ°çš„å›¾ç‰‡URL</span><br>    objc_setAssociatedObject(<span class="hljs-keyword">self</span>, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);<br>    <span class="hljs-comment">/*...*/</span><br>    <span class="hljs-keyword">if</span> (url) &#123;<br>        __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>)wself = <span class="hljs-keyword">self</span>;<br>        <span class="hljs-comment">//step.2 ç”±SDWebImageManagerä¸‹è½½å›¾ç‰‡</span><br>        <span class="hljs-type">id</span> &lt;SDWebImageOperation&gt; operation = [SDWebImageManager.sharedManager<br>        downloadImageWithURL:url<br>        options:options<br>        progress:progressBlock<br>        completed:^(<span class="hljs-built_in">UIImage</span> *image,<br>        <span class="hljs-built_in">NSError</span> *error, SDImageCacheType cacheType,<br>        <span class="hljs-type">BOOL</span> finished, <span class="hljs-built_in">NSURL</span> *imageURL)<br>        &#123;<br>            <span class="hljs-comment">/*step.4 å›¾ç‰‡ä¸‹è½½ç»“æœè¿”å›ï¼Œå›åˆ°ä¸»çº¿å±‚*/</span><br>        &#125;];<br>        <span class="hljs-comment">//step.3 ä¿å­˜æ­¤æ¬¡ä¸‹è½½æ“ä½œ</span><br>        [<span class="hljs-keyword">self</span> sd_setImageLoadOperation:operation forKey:<span class="hljs-string">@&quot;UIImageViewImageLoad&quot;</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ç°ç»†èŠ‚ï¼š</p><ul><li>1ã€åˆ›å»ºä¸‹è½½ä»»åŠ¡</li></ul><p>å›¾ç‰‡çš„ä¸‹è½½ä»»åŠ¡æ˜¯ç”± SDWebImageManager æ‰§è¡Œçš„ï¼Œå®ƒçš„å®ç°ç»†èŠ‚åé¢ä¼šè®²ï¼Œè¿™é‡Œåªéœ€è¦çŸ¥é“ä¸‹è½½çš„æ“ä½œç»è¿‡ä¸¤æ¬¡å°è£…ï¼Œæœ€ç»ˆè¢«å°è£…åˆ° SDWebImageCombinedOperation å¯¹è±¡ä¸­ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@protocol</span> SDWebImageOperation &lt;NSObject&gt;<br>- (void)cancel; <span class="hljs-comment">// åªå®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ªå–æ¶ˆçš„æ–¹æ³•~~</span><br><span class="hljs-variable">@end</span><br><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">SDWebImageCombinedOperation </span>: NSObject &lt;SDWebImageOperation&gt;<br><br><span class="hljs-variable">@property</span> (assign, nonatomic, getter = isCancelled) BOOL cancelled;<br><span class="hljs-variable">@property</span> (copy, nonatomic) SDWebImageNoParamsBlock cancelBlock; <span class="hljs-comment">// åœ¨åˆ›å»ºä»»åŠ¡æ—¶ä¼šè¢«èµ‹å€¼</span><br><span class="hljs-variable">@property</span> (strong, nonatomic) NSOperation *cacheOperation; <span class="hljs-comment">// çœŸæ­£æ‰§è¡Œä¸‹è½½ä»»åŠ¡çš„ç±»</span><br><br><span class="hljs-variable">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨è§†å›¾çš„åˆ†ç±»ä¸­è°ƒç”¨ SDWebImageManager è¿›è¡Œä¸‹è½½æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ª SDWebImageCombinedOperation ä»»åŠ¡å¯¹è±¡ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs erlang">// SDWebImageManager.m<br>- <span class="hljs-params">(id &lt;SDWebImageOperation&gt;)</span>downloadImageWithURL:<span class="hljs-params">(NSURL *)</span>url<br>                                         options:<span class="hljs-params">(SDWebImageOptions)</span>options<br>                                        progress:<span class="hljs-params">(SDWebImageDownloaderProgressBlock)</span>progressBlock<br>                                       completed:<span class="hljs-params">(SDWebImageCompletionWithFinishedBlock)</span>completedBlock&#123;<br>                                       <br>                        __block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];<br>                        // ç•¥...<br>                        return operation;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>2ã€ä¿å­˜ä¸‹è½½ä»»åŠ¡</li></ul><p>ä¸Šé¢è¿”å›çš„ SDWebImageCombinedOperation ä»»åŠ¡å¯¹è±¡ä¼šè¢«ä¿å­˜åˆ°å½“å‰è§†å›¾çš„å¯¹è±¡ä¸­ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> UIImageView+WebCache.m<br>[self sd_setImageLoadOperation:operation forKey:@<span class="hljs-string">&quot;UIImageViewImageLoad&quot;</span>];<br></code></pre></td></tr></table></figure><p>ä¿å­˜æ¥å£çš„å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// å±æ€§Getter</span><br>- (<span class="hljs-built_in">NSMutableDictionary</span> *)operationDictionary &#123;<br>    <span class="hljs-comment">// å¦‚æœå…³è”å¯¹è±¡å­˜åœ¨ï¼Œåˆ™è¿”å›å®ƒ</span><br>    <span class="hljs-built_in">NSMutableDictionary</span> *operations = objc_getAssociatedObject(<span class="hljs-keyword">self</span>, &amp;loadOperationKey);<br>    <span class="hljs-keyword">if</span> (operations) &#123;<br>        <span class="hljs-keyword">return</span> operations;<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœå…³è”å¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å¹¶è¿”å›å®ƒ</span><br>    operations = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>    objc_setAssociatedObject(<span class="hljs-keyword">self</span>, &amp;loadOperationKey, operations, OBJC_ASSOCIATION_RETAIN_NONATOMIC);<br>    <span class="hljs-keyword">return</span> operations;<br>&#125;<br><br><span class="hljs-comment">// ä¿å­˜ä»»åŠ¡</span><br>- (<span class="hljs-type">void</span>)sd_setImageLoadOperation:(<span class="hljs-type">id</span>)operation forKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-comment">// å¦‚æœåŒä¸€ä¸ªè§†å›¾ä¹‹å‰æœ‰ä¸‹è½½ä»»åŠ¡ï¼Œåˆ™å…ˆå–æ¶ˆä¹‹å‰çš„ä»»åŠ¡</span><br>    [<span class="hljs-keyword">self</span> sd_cancelImageLoadOperationWithKey:key];<br>    <span class="hljs-built_in">NSMutableDictionary</span> *operationDictionary = [<span class="hljs-keyword">self</span> operationDictionary];<br>    [operationDictionary setObject:operation forKey:key];<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹è½½ä»»åŠ¡ä¼šè¢«ä¿å­˜åˆ°å½“å‰åˆ†ç±»ä¸­çš„ operationDictionary å­—å…¸å±æ€§ä¸­ï¼Œæ­¤å±æ€§ä½¿ç”¨äº†å¯¹è±¡å…³è”æŠ€æœ¯æä¾›äº†Getterå’ŒSetterçš„å®ç°ã€‚</p><ul><li>3ã€å–æ¶ˆä¸Šä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„ä¸‹è½½ä»»åŠ¡ï¼›</li></ul><p>åœºæ™¯ï¼šcell è¢«é‡ç”¨æ—¶ä¸Šä¸€å¼ å›¾ç‰‡å°šæœªåŠ è½½å®Œï¼Œéœ€è¦å–æ¶ˆä¸Šä¸€æ¬¡çš„åŠ è½½ä»»åŠ¡å¹¶åŠ è½½æ–°çš„å›¾ç‰‡ã€‚<br><br/></p><p>å½“å‰è§†å›¾ä¸­æ‰€æœ‰çš„ä¸‹è½½ä»»åŠ¡éƒ½ä¿å­˜åœ¨<code>operationDictionary</code>ä¸­ï¼Œå–æ¶ˆä»»åŠ¡æ—¶è¦å…ˆä»æ­¤å­—å…¸ä¸­å–å‡ºä¹‹å‰çš„ä»»åŠ¡ï¼Œå†æ‰§è¡Œå–æ¶ˆæ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)sd_cancelCurrentImageLoad &#123;<br>    [<span class="hljs-keyword">self</span> sd_cancelImageLoadOperationWithKey:<span class="hljs-string">@&quot;UIImageViewImageLoad&quot;</span>];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)sd_cancelImageLoadOperationWithKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-comment">// Cancel in progress downloader from queue</span><br>    <span class="hljs-built_in">NSMutableDictionary</span> *operationDictionary = [<span class="hljs-keyword">self</span> operationDictionary];<br>    <span class="hljs-comment">// å–å‡ºä»»åŠ¡</span><br>    <span class="hljs-type">id</span> operations = [operationDictionary objectForKey:key];<br>    <span class="hljs-keyword">if</span> (operations) &#123;<br>        <span class="hljs-keyword">if</span> ([operations isKindOfClass:[<span class="hljs-built_in">NSArray</span> <span class="hljs-keyword">class</span>]]) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">id</span> &lt;SDWebImageOperation&gt; operation <span class="hljs-keyword">in</span> operations) &#123;<br>                <span class="hljs-keyword">if</span> (operation) &#123;<br>                    [operation cancel]; <span class="hljs-comment">// å–æ¶ˆ</span><br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([operations conformsToProtocol:<span class="hljs-class"><span class="hljs-keyword">@protocol</span>(<span class="hljs-title">SDWebImageOperation</span>)])</span>&#123;<br>            [(<span class="hljs-type">id</span>&lt;SDWebImageOperation&gt;) operations cancel]; <span class="hljs-comment">// å–æ¶ˆ</span><br>        &#125;<br>        [operationDictionary removeObjectForKey:key];  <span class="hljs-comment">//ä»å­—å…¸ä¸­ç§»é™¤ä¸Šä¸€ä¸ªä»»åŠ¡</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å–æ¶ˆæ“ä½œè°ƒç”¨çš„æ˜¯ SDWebImageCombinedOperation å¯¹è±¡ çš„ cancel æ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">SDWebImageCombinedOperation</span></span><br><br>- (<span class="hljs-type">void</span>)cancel &#123;<br>    <span class="hljs-keyword">self</span>.cancelled = <span class="hljs-literal">YES</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.cacheOperation) &#123;<br>        [<span class="hljs-keyword">self</span>.cacheOperation cancel];<br>        <span class="hljs-keyword">self</span>.cacheOperation = <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.cancelBlock) &#123;<br>        <span class="hljs-keyword">self</span>.cancelBlock();<br>        <br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> this is a temporary fix to #809.</span><br>        <span class="hljs-comment">// Until we can figure the exact cause of the crash, going with the ivar instead of the setter</span><br><span class="hljs-comment">//        self.cancelBlock = nil;</span><br>        _cancelBlock = <span class="hljs-literal">nil</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œæœ€ç»ˆå–æ¶ˆçš„æ˜¯çœŸæ­£çš„å›¾ç‰‡ä¸‹è½½ä»»åŠ¡<code>cacheOperation</code>å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ª NSOperation å®ä¾‹ã€‚</p><h4 id="2-2-SDWebImageManager"><a href="#2-2-SDWebImageManager" class="headerlink" title="2.2.SDWebImageManager"></a>2.2.SDWebImageManager</h4><p>ä¸Šé¢è§†å›¾åˆ†ç±»ä¸­åªç®€å•çš„å–æ¶ˆå’Œä¿å­˜äº†ä»»åŠ¡çš„å®ä¾‹ï¼Œå…·ä½“çš„ä¸‹è½½ä»»åŠ¡äº¤ç»™äº†<code>SDWebImageManager</code>ã€‚æœ¬ç« èŠ‚å°±æ¥è®²è§£æ­¤ç±»çš„å…·ä½“ä¸šåŠ¡ï¼š<br><br/></p><p>æ­¤ç±»ä¸»è¦ç”¨æ¥åšå…·ä½“ä¸‹è½½å‰çš„å„é¡¹æ£€æµ‹å’Œå‡†å¤‡ä»¥åŠå¤„ç†å›¾ç‰‡ä¸‹è½½æˆåŠŸåçš„å˜æ¢ã€ç¼“å­˜ç­‰ï¼š</p><ul><li>step.1 æ£€æµ‹URLä¹‹å‰æ˜¯å¦ä¸‹è½½å¤±è´¥ï¼ˆå¤±æ•ˆè¿‡çš„é“¾æ¥ä¸å†é‡å¤ä¸‹è½½ï¼‰ï¼›</li><li>step.2 æ ¹æ®URLç”Ÿæˆå¯¹åº”çš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œæœ‰ç¼“å­˜ä¸”ä¸è¦æ±‚å¼ºåˆ¶åˆ·æ–°ç¼“å­˜æ—¶ç›´æ¥ä½¿ç”¨ç¼“å­˜å›¾ç‰‡ï¼›</li><li>step.3 æ²¡æœ‰ç¼“å­˜æ—¶ï¼Œäº¤ç»™ SDWebImageDownloaderï¼Œå°è£…è¯·æ±‚å¹¶åˆ›å»ºä»»åŠ¡å’Œé˜Ÿåˆ—ï¼Œå‘èµ·ç½‘ç»œè¯·æ±‚ï¼›</li><li>step.4 ä¸‹è½½å®Œæˆåå¯¹å›¾ç‰‡åšå˜æ¢ã€ç¼“å­˜å›¾ç‰‡ã€è¿”å›ä¸»çº¿ç¨‹ï¼›</li></ul><p>æºç æ‘˜è¦ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// SDWebImageManager.m</span><br><br>- (<span class="hljs-type">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="hljs-built_in">NSURL</span> *)url<br>options:(SDWebImageOptions)options<br>progress:(SDWebImageDownloaderProgressBlock)progressBlock<br>completed:(SDWebImageCompletionWithFinishedBlock)completedBlock<br>&#123;<br>    <span class="hljs-comment">/*...*/</span><br>    __block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];<br><br>    <span class="hljs-comment">//step.1 æ£€æµ‹URLä¹‹å‰æ˜¯å¦ä¸‹è½½å¤±è´¥</span><br>    <span class="hljs-type">BOOL</span> isFailedUrl = <span class="hljs-literal">NO</span>;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>.failedURLs) &#123;<br>        isFailedUrl = [<span class="hljs-keyword">self</span>.failedURLs containsObject:url];<br>    &#125;<br>    <br>    <span class="hljs-comment">//URLé”™è¯¯æˆ–ä¹‹å‰ä¸‹è½½å¤±è´¥è¿‡ï¼Œåˆ™ä¸å†é‡å¤ä¸‹è½½å¤±æ•ˆçš„URL</span><br>    <span class="hljs-keyword">if</span> (url.absoluteString.length == <span class="hljs-number">0</span> || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;<br>        dispatch_main_sync_safe(^&#123;<br>            <span class="hljs-built_in">NSError</span> *error = ...;<br>            completedBlock(<span class="hljs-literal">nil</span>, error, SDImageCacheTypeNone, <span class="hljs-literal">YES</span>, url);<br>        &#125;);<br>        <span class="hljs-keyword">return</span> operation;<br>    &#125;<br><br>    <span class="hljs-comment">//å°†å½“å‰ä¸‹è½½ operation åŠ å…¥åˆ°æ•°ç»„ä¸­</span><br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>.runningOperations) &#123;<br>        [<span class="hljs-keyword">self</span>.runningOperations addObject:operation];<br>    &#125;<br>    <br>    <span class="hljs-comment">//step.2 æ ¹æ®URLç”Ÿæˆå¯¹åº”çš„keyæŸ¥è¯¢ç¼“å­˜ æ²¡æœ‰ç¼“å­˜åˆ™å¼€å§‹ä¸‹è½½</span><br>    <span class="hljs-built_in">NSString</span> *key = [<span class="hljs-keyword">self</span> cacheKeyForURL:url];<br>    operation.cacheOperation = [<span class="hljs-keyword">self</span>.imageCache queryDiskCacheForKey:key<br>                                                done:^(<span class="hljs-built_in">UIImage</span> *image, SDImageCacheType cacheType)&#123;<br>    <span class="hljs-comment">/*...*/</span><br>    <span class="hljs-keyword">if</span> ((!image || options &amp; SDWebImageRefreshCached) &amp;&amp;<br>    (![<span class="hljs-keyword">self</span>.delegate respondsToSelector:<br>    <span class="hljs-keyword">@selector</span>(imageManager:shouldDownloadImageForURL:)] ||<br>    [<span class="hljs-keyword">self</span>.delegate imageManager:<span class="hljs-keyword">self</span> shouldDownloadImageForURL:url]))<br>    &#123;<br>        <span class="hljs-comment">/*å¦‚æœæœ‰ç¼“å­˜ä½†é‡‡ç”¨äº† RefreshCached ç­–ç•¥ï¼Œ</span><br><span class="hljs-comment">        åˆ™æ‰§è¡Œå›è°ƒå¹¶ç»§ç»­ä¸‹è½½ï¼Œä»¥ä¾¿è®©æœåŠ¡å™¨åˆ·æ–° NSURLCache é‡Œçš„å†…å®¹ã€‚*/</span><br>        <span class="hljs-keyword">if</span> (image &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;<br>            dispatch_main_sync_safe(^&#123;<br>                completedBlock(image, <span class="hljs-literal">nil</span>, cacheType, <span class="hljs-literal">YES</span>, url);<br>            &#125;);<br>        &#125;<br>        <span class="hljs-comment">/*...*/</span><br>        <span class="hljs-comment">//step.4 ä½¿ç”¨imageDownloaderå¼€å¯ç½‘ç»œä¸‹è½½</span><br>        <span class="hljs-type">id</span> &lt;SDWebImageOperation&gt; subOperation = [<span class="hljs-keyword">self</span>.imageDownloader<br>        downloadImageWithURL:url<br>        options:downloaderOptions<br>        progress:progressBlock<br>        completed:^(<span class="hljs-built_in">UIImage</span> *downloadedImage, <span class="hljs-built_in">NSData</span> *data, <span class="hljs-built_in">NSError</span> *error, <span class="hljs-type">BOOL</span> finished)<br>        &#123;<br>            <span class="hljs-comment">//step.5 å›¾ç‰‡ä¸‹è½½å®Œæˆï¼Œæ ¹æ®è®¾ç½®è¿›è¡Œå›¾ç‰‡è½¬æ¢å’Œç¼“å­˜</span><br>            /.../<br>            <span class="hljs-keyword">if</span> (downloadedImage &amp;&amp; finished) &#123;<br>                <span class="hljs-comment">//step.5 å›¾ç‰‡ä¸‹è½½å®Œæˆï¼Œä¸éœ€è¦è½¬æ¢æ—¶ï¼Œå°†å›¾ç‰‡ä¿å­˜åˆ°ç¼“å­˜ä¸­å¹¶è¿”å›ä¸»çº¿ç¨‹</span><br>                [<span class="hljs-keyword">self</span>.imageCache storeImage:downloadedImage<br>                recalculateFromImage:<span class="hljs-literal">NO</span><br>                imageData:data<br>                forKey:key<br>                toDisk:cacheOnDisk];<br>            &#125;<br>            dispatch_main_sync_safe(^&#123;<br>                <span class="hljs-keyword">if</span> (!weakOperation.isCancelled) &#123;<br>                    completedBlock(downloadedImage, <span class="hljs-literal">nil</span>, SDImageCacheTypeNone, finished, url);<br>            &#125;<br>            &#125;);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/*...*/</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (image) &#123;<br>        <span class="hljs-comment">//step.3 æœ‰ç¼“å­˜ä¸”ä¸è¦æ±‚å¼ºåˆ¶åˆ·æ–°ç¼“å­˜æ—¶ï¼Œåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°å›¾ç‰‡ï¼Œç›´æ¥è¿”å›</span><br>        dispatch_main_sync_safe(^&#123;<br>            <span class="hljs-keyword">if</span> (!weakOperation.isCancelled) &#123;<br>                completedBlock(image, <span class="hljs-literal">nil</span>, cacheType, <span class="hljs-literal">YES</span>, url);<br>            &#125;<br>        &#125;);<br>    &#125;<br>    &#125;];<br>    <span class="hljs-keyword">return</span> operation;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§è‡´çš„å®ç°é€»è¾‘å·²åœ¨ä¸Šé¢çš„ä»£ç ä¸­æ ‡æ˜ï¼Œå›¾ç‰‡ä¸‹è½½å®Œæˆåæ‰€åšçš„è½¬æ¢å’Œç¼“å­˜ï¼Œå…¶å…·ä½“å®ç°é€»è¾‘ä¼šåœ¨åé¢è®²åˆ°ã€‚</p><h4 id="2-3-SDWebImageDownloader"><a href="#2-3-SDWebImageDownloader" class="headerlink" title="2.3.SDWebImageDownloader"></a>2.3.SDWebImageDownloader</h4><p>ä¸»è¦ä¸šåŠ¡ï¼š</p><ul><li>step.1 è®¾ç½® URLRequestã€‚</li><li>step.2 åˆ›å»ºä¸‹è½½ä»»åŠ¡ SDWebImageDownloaderOperationï¼ŒåŠ å…¥åˆ°æœ€å¤§å¹¶å‘æ•°&#x3D;6çš„ Queue ä¸­ï¼Œå¼€å§‹ä¸‹è½½ä»»åŠ¡ã€‚</li><li>step.3 ä¸‹è½½æˆåŠŸï¼Œè°ƒç”¨ CompletedBlockã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// SDWebImageDownloader.m</span><br><br>- (<span class="hljs-keyword">instancetype</span>)initWithSessionConfiguration:(<span class="hljs-built_in">NSURLSessionConfiguration</span> *)sessionConfiguration &#123;<br>    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init])) &#123;<br>        _operationClass = [SDWebImageDownloaderOperation <span class="hljs-keyword">class</span>];<br>        _shouldDecompressImages = <span class="hljs-literal">YES</span>; <span class="hljs-comment">//é»˜è®¤è§£å‹ç¼©ä¸‹è½½åˆ°çš„å›¾ç‰‡</span><br>        _executionOrder = SDWebImageDownloaderFIFOExecutionOrder;<br>        _downloadQueue = [<span class="hljs-built_in">NSOperationQueue</span> new];<br>        _downloadQueue.maxConcurrentOperationCount = <span class="hljs-number">6</span>; <span class="hljs-comment">//æœ€å¤§ä¸‹è½½å¹¶å‘æ•°</span><br>        _downloadQueue.name = <span class="hljs-string">@&quot;com.hackemist.SDWebImageDownloader&quot;</span>;<br>        <span class="hljs-comment">// çœç•¥ã€‚ã€‚ã€‚</span><br>        _HTTPHeaders = headerDictionary;<br>        _operationsLock = dispatch_semaphore_create(<span class="hljs-number">1</span>);<br>        _headersLock = dispatch_semaphore_create(<span class="hljs-number">1</span>);<br>        _downloadTimeout = <span class="hljs-number">15.0</span>;<br><br>        [<span class="hljs-keyword">self</span> createNewSessionWithConfiguration:sessionConfiguration];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)createNewSessionWithConfiguration:(<span class="hljs-built_in">NSURLSessionConfiguration</span> *)sessionConfiguration &#123;<br>    [<span class="hljs-keyword">self</span> cancelAllDownloads];<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.session) &#123;<br>        [<span class="hljs-keyword">self</span>.session invalidateAndCancel];<br>    &#125;<br>    <span class="hljs-keyword">self</span>.session = [<span class="hljs-built_in">NSURLSession</span> sessionWithConfiguration:sessionConfiguration<br>                                                 delegate:<span class="hljs-keyword">self</span><br>                                            delegateQueue:<span class="hljs-literal">nil</span>];<br>&#125;<br><br>- (<span class="hljs-type">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="hljs-built_in">NSURL</span> *)url<br>                                         options:(SDWebImageDownloaderOptions)options<br>                                        progress:(SDWebImageDownloaderProgressBlock)progressBlock<br>                                       completed:(SDWebImageDownloaderCompletedBlock)completedBlock<br>&#123;<br>    <span class="hljs-comment">/*...*/</span><br>    <span class="hljs-comment">//step.1 è®¾ç½®request</span><br>    <span class="hljs-built_in">NSMutableURLRequest</span> *request = [[<span class="hljs-built_in">NSMutableURLRequest</span> alloc]<br>                                    initWithURL:url<br>                                    cachePolicy:(options &amp; SDWebImageDownloaderUseNSURLCache ?<br>    <span class="hljs-built_in">NSURLRequestUseProtocolCachePolicy</span> :<span class="hljs-built_in">NSURLRequestReloadIgnoringLocalCacheData</span>)<br>                                timeoutInterval:timeoutInterval];<br><br>    request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);<br>    request.HTTPShouldUsePipelining = <span class="hljs-literal">YES</span>;<br>    request.allHTTPHeaderFields = wself.HTTPHeaders;<br><br>    <span class="hljs-comment">//step.2 åˆ›å»ºä¸‹è½½ Operation</span><br>    operation = [[SDWebImageDownloaderOperation alloc] initWithRequest:request<br>        options:options<br>        progress:^(<span class="hljs-built_in">NSInteger</span> receivedSize, <span class="hljs-built_in">NSInteger</span> expectedSize) &#123;...&#125;<br>        completed:^(<span class="hljs-built_in">UIImage</span> *image, <span class="hljs-built_in">NSData</span> *data, <span class="hljs-built_in">NSError</span> *error, <span class="hljs-type">BOOL</span> finished) &#123;<br>        <br>        SDWebImageDownloader *sself = wself;<br>        <span class="hljs-keyword">if</span> (!sself) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-comment">//step.3 ä¸‹è½½æˆåŠŸï¼Œæ‰§è¡Œå®Œæˆçš„callback</span><br>        __block <span class="hljs-built_in">NSArray</span> *callbacksForURL;<br>        dispatch_barrier_sync(sself.barrierQueue, ^&#123;<br>            callbacksForURL = [sself.URLCallbacks[url] <span class="hljs-keyword">copy</span>];<br>            <span class="hljs-keyword">if</span> (finished) &#123;<br>                [sself.URLCallbacks removeObjectForKey:url];<br>            &#125;<br>        &#125;);<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSDictionary</span> *callbacks <span class="hljs-keyword">in</span> callbacksForURL) &#123;<br>            SDWebImageDownloaderCompletedBlock callback = callbacks[kCompletedCallbackKey];<br>            <span class="hljs-keyword">if</span> (callback)<br>            callback(image, data, error, finished);<br>        &#125;<br>    &#125;<br>        cancelled:^&#123;...&#125;];<br><br>    operation.shouldDecompressImages = wself.shouldDecompressImages;<span class="hljs-comment">//æ˜¯å¦éœ€è¦è§£ç </span><br>    <span class="hljs-comment">//è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§</span><br>    <span class="hljs-keyword">if</span> (options &amp; SDWebImageDownloaderHighPriority) &#123;<br>        operation.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityHigh</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options &amp; SDWebImageDownloaderLowPriority) &#123;<br>        operation.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityLow</span>;<br>    &#125;<br>    <span class="hljs-comment">//ä»»åŠ¡åŠ åˆ°é˜Ÿåˆ—ä¸­</span><br>    [wself.downloadQueue addOperation:operation];<br>    <span class="hljs-keyword">if</span> (wself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) &#123;<br>        <span class="hljs-comment">//å¦‚æœè®¾ç½®äº†åè¿›çš„ä»»åŠ¡å…ˆæ‰§è¡Œï¼Œåˆ™æ·»åŠ ä¾èµ–å…³ç³»ï¼Œå‰ä¸€ä¸ªä»»åŠ¡ä¾èµ–å½“å‰ä»»åŠ¡</span><br>        [wself.lastAddedOperation addDependency:operation];<br>        wself.lastAddedOperation = operation;<br>    &#125;<br>    &#125;];<br>    <span class="hljs-keyword">return</span> operation;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-4-ä»»åŠ¡å’Œè¯·æ±‚"><a href="#2-4-ä»»åŠ¡å’Œè¯·æ±‚" class="headerlink" title="2.4.ä»»åŠ¡å’Œè¯·æ±‚"></a>2.4.ä»»åŠ¡å’Œè¯·æ±‚</h4><p>SDWebImageDownloaderOperationï¼Œè¿™æ˜¯çœŸæ­£æ‰§è¡Œå›¾ç‰‡ä¸‹è½½ä»»åŠ¡çš„åœ°æ–¹ã€‚</p><ul><li>é‡å†™äº†<code>start</code>å‡½æ•°ï¼›</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)start &#123;<br>    <span class="hljs-meta">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.isCancelled) &#123;<br>            <span class="hljs-keyword">self</span>.finished <span class="hljs-operator">=</span> <span class="hljs-type">YES</span>;<br>            [<span class="hljs-keyword">self</span> reset];<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br><span class="hljs-keyword">#if</span> <span class="hljs-type">TARGET_OS_IPHONE</span> <span class="hljs-operator">&amp;&amp;</span> __IPHONE_OS_VERSION_MAX_ALLOWED <span class="hljs-operator">&gt;=</span> __IPHONE_4_0<br>        <span class="hljs-type">Class</span> <span class="hljs-type">UIApplicationClass</span> <span class="hljs-operator">=</span> <span class="hljs-type">NSClassFromString</span>(@<span class="hljs-string">&quot;UIApplication&quot;</span>);<br>        <span class="hljs-type">BOOL</span> hasApplication <span class="hljs-operator">=</span> <span class="hljs-type">UIApplicationClass</span> <span class="hljs-operator">&amp;&amp;</span> <br>                        [<span class="hljs-type">UIApplicationClass</span> respondsToSelector:<span class="hljs-meta">@selector</span>(sharedApplication)];<br>        <br>        <span class="hljs-comment">// è¿›å…¥åå°æ—¶ï¼Œå¼€å¯åå°æ¨¡å¼</span><br>        <span class="hljs-keyword">if</span> (hasApplication <span class="hljs-operator">&amp;&amp;</span> [<span class="hljs-keyword">self</span> shouldContinueWhenAppEntersBackground]) &#123;<br>            __weak __typeof__ (<span class="hljs-keyword">self</span>) wself <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>;<br>            <span class="hljs-type">UIApplication</span> <span class="hljs-operator">*</span> app <span class="hljs-operator">=</span> [<span class="hljs-type">UIApplicationClass</span> performSelector:<span class="hljs-meta">@selector</span>(sharedApplication)];<br>            <span class="hljs-keyword">self</span>.backgroundTaskId <span class="hljs-operator">=</span> [app beginBackgroundTaskWithExpirationHandler:<span class="hljs-operator">^</span>&#123;<br>                __strong __typeof (wself) sself <span class="hljs-operator">=</span> wself;<br><br>                <span class="hljs-keyword">if</span> (sself) &#123;<br>                    [sself cancel];<br><br>                    [app endBackgroundTask:sself.backgroundTaskId];<br>                    sself.backgroundTaskId <span class="hljs-operator">=</span> <span class="hljs-type">UIBackgroundTaskInvalid</span>;<br>                &#125;<br>            &#125;];<br>        &#125;<br><span class="hljs-keyword">#endif</span><br><br>        <span class="hljs-comment">// åˆ›å»ºä¸‹è½½è¯·æ±‚</span><br>        <span class="hljs-keyword">self</span>.executing <span class="hljs-operator">=</span> <span class="hljs-type">YES</span>;<br>        <span class="hljs-keyword">self</span>.connection <span class="hljs-operator">=</span> [[<span class="hljs-type">NSURLConnection</span> alloc] initWithRequest:<span class="hljs-keyword">self</span>.request <br>                                                          delegate:<span class="hljs-keyword">self</span> startImmediately:<span class="hljs-type">NO</span>];<br>        <span class="hljs-keyword">self</span>.thread <span class="hljs-operator">=</span> [<span class="hljs-type">NSThread</span> currentThread];<br>    &#125;<br><br>    <span class="hljs-comment">// å¯åŠ¨</span><br>    [<span class="hljs-keyword">self</span>.connection start];<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.connection) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.progressBlock) &#123;<br>            <span class="hljs-keyword">self</span>.progressBlock(<span class="hljs-number">0</span>, <span class="hljs-type">NSURLResponseUnknownLength</span>);<br>        &#125;<br>        dispatch_async(dispatch_get_main_queue(), <span class="hljs-operator">^</span>&#123;<br>            [[<span class="hljs-type">NSNotificationCenter</span> defaultCenter] postNotificationName:<br>            <span class="hljs-type">SDWebImageDownloadStartNotification</span> object:<span class="hljs-keyword">self</span>];<br>        &#125;);<br><br>        <span class="hljs-comment">// åœ¨é»˜è®¤æ¨¡å¼ä¸‹è¿è¡Œå½“å‰runlooprunï¼Œç›´åˆ°è°ƒç”¨CFRunLoopStopåœæ­¢è¿è¡Œ</span><br>        <span class="hljs-keyword">if</span> (floor(<span class="hljs-type">NSFoundationVersionNumber</span>) <span class="hljs-operator">&lt;=</span> <span class="hljs-type">NSFoundationVersionNumber_iOS_5_1</span>) &#123;<br>            <span class="hljs-comment">// Make sure to run the runloop in our background thread so it can process downloaded data</span><br>            <span class="hljs-comment">// Note: we use a timeout to work around an issue with NSURLConnection cancel under iOS 5</span><br>            <span class="hljs-comment">// not waking up the runloop, leading to dead threads</span><br>            <span class="hljs-type">CFRunLoopRunInMode</span>(kCFRunLoopDefaultMode, <span class="hljs-number">10</span>, <span class="hljs-literal">false</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">CFRunLoopRun</span>();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span><span class="hljs-keyword">self</span>.isFinished) &#123;<br>            [<span class="hljs-keyword">self</span>.connection cancel];<br>            [<span class="hljs-keyword">self</span> connection:<span class="hljs-keyword">self</span>.connection didFailWithError:<br>            [<span class="hljs-type">NSError</span> errorWithDomain:<span class="hljs-type">NSURLErrorDomain</span> code:<span class="hljs-type">NSURLErrorTimedOut</span> <br>            userInfo:@&#123;<span class="hljs-type">NSURLErrorFailingURLErrorKey</span> : <span class="hljs-keyword">self</span>.request.<span class="hljs-type">URL</span>&#125;]];<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.completedBlock) &#123;<br>            <span class="hljs-keyword">self</span>.completedBlock(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, [<span class="hljs-type">NSError</span> errorWithDomain:<span class="hljs-type">NSURLErrorDomain</span> <br>                code:<span class="hljs-number">0</span> userInfo:@&#123;NSLocalizedDescriptionKey : @<span class="hljs-string">&quot;Connection can&#x27;t be initialized&quot;</span>&#125;], <span class="hljs-type">YES</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-keyword">#if</span> <span class="hljs-type">TARGET_OS_IPHONE</span> <span class="hljs-operator">&amp;&amp;</span> __IPHONE_OS_VERSION_MAX_ALLOWED <span class="hljs-operator">&gt;=</span> __IPHONE_4_0<br>    <span class="hljs-type">Class</span> <span class="hljs-type">UIApplicationClass</span> <span class="hljs-operator">=</span> <span class="hljs-type">NSClassFromString</span>(@<span class="hljs-string">&quot;UIApplication&quot;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-operator">!</span><span class="hljs-type">UIApplicationClass</span> <span class="hljs-operator">||</span> <span class="hljs-operator">!</span>[<span class="hljs-type">UIApplicationClass</span> respondsToSelector:<span class="hljs-meta">@selector</span>(sharedApplication)]) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.backgroundTaskId <span class="hljs-operator">!=</span> <span class="hljs-type">UIBackgroundTaskInvalid</span>) &#123;<br>        <span class="hljs-type">UIApplication</span> <span class="hljs-operator">*</span> app <span class="hljs-operator">=</span> [<span class="hljs-type">UIApplication</span> performSelector:<span class="hljs-meta">@selector</span>(sharedApplication)];<br>        [app endBackgroundTask:<span class="hljs-keyword">self</span>.backgroundTaskId];<br>        <span class="hljs-keyword">self</span>.backgroundTaskId <span class="hljs-operator">=</span> <span class="hljs-type">UIBackgroundTaskInvalid</span>;<br>    &#125;<br><span class="hljs-keyword">#endif</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ”¶åˆ°æ•°æ®çš„å›è°ƒ</li></ul><p>ä¸‹è½½è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ä»£ç†-connection: didReceiveData:æ¥æ”¶æ•°æ®å¹¶ä¿å­˜åˆ°ä¸€ä¸ª NSMutableData å¯¹è±¡ä¸­ã€‚å¦‚æœè®¾ç½®äº†â€œè¾¹ä¸‹è½½è¾¹æ˜¾ç¤ºâ€ï¼Œé‚£ä¹ˆè¿™é‡Œä¼šæ¸è¿›å¼çš„ç»˜åˆ¶å›¾ç‰‡ã€ç¼©æ”¾å›¾ç‰‡ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿˜ä¼šå¯¹å›¾ç‰‡è¿›è¡Œè§£ç ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection didReceiveData:(<span class="hljs-built_in">NSData</span> *)data &#123;<br>[<span class="hljs-keyword">self</span>.imageData appendData:data];<br>...<br><span class="hljs-comment">//ç»˜åˆ¶å›¾ç‰‡</span><br><span class="hljs-built_in">CGImageSourceRef</span> imageSource = <span class="hljs-built_in">CGImageSourceCreateWithData</span>((__bridge <span class="hljs-built_in">CFDataRef</span>)<span class="hljs-keyword">self</span>.imageData, <span class="hljs-literal">NULL</span>);<br>...<br><span class="hljs-built_in">CGImageRef</span> partialImageRef = <span class="hljs-built_in">CGImageSourceCreateImageAtIndex</span>(imageSource, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>...<br><span class="hljs-comment">//å›¾ç‰‡ç¼©æ”¾</span><br><span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> imageWithCGImage:partialImageRef scale:<span class="hljs-number">1</span> orientation:orientation];<br><span class="hljs-built_in">NSString</span> *key = [[SDWebImageManager sharedManager] cacheKeyForURL:<span class="hljs-keyword">self</span>.request.URL];<br><span class="hljs-built_in">UIImage</span> *scaledImage = [<span class="hljs-keyword">self</span> scaledImageForKey:key image:image];<br><br><span class="hljs-comment">//å›¾ç‰‡è§£ç </span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.shouldDecompressImages) &#123;<br>image = [<span class="hljs-built_in">UIImage</span> decodedImageWithImage:scaledImage];<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>image = scaledImage;<br>&#125;<br><span class="hljs-built_in">CGImageRelease</span>(partialImageRef);<br>dispatch_main_sync_safe(^&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.completedBlock) &#123;<br><span class="hljs-keyword">self</span>.completedBlock(image, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">NO</span>);<br>&#125;<br>&#125;);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å›¾ç‰‡ä¸‹è½½å®Œæˆçš„å›è°ƒ</li></ul><p>ä¸‹è½½å®Œæˆåï¼Œåœ¨ä»£ç†-connectionDidFinishLoadingä¸­å®Œæˆå›¾ç‰‡çš„ç¼©æ”¾ã€è§£ç å¹¶è¿”å›ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)connectionDidFinishLoading:(<span class="hljs-built_in">NSURLConnection</span> *)aConnection &#123;<br>SDWebImageDownloaderCompletedBlock completionBlock = <span class="hljs-keyword">self</span>.completedBlock;<br><span class="hljs-keyword">@synchronized</span>(<span class="hljs-keyword">self</span>) &#123;<br><span class="hljs-built_in">CFRunLoopStop</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>());<br>...<br>&#125;);<br>&#125;<br>...<br><span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> sd_imageWithData:<span class="hljs-keyword">self</span>.imageData];<br><br><span class="hljs-built_in">NSString</span> *key = [[SDWebImageManager sharedManager]<br>cacheKeyForURL:<span class="hljs-keyword">self</span>.request.URL];<br>image = [<span class="hljs-keyword">self</span> scaledImageForKey:key image:image];<br><br><span class="hljs-comment">// Do not force decoding animated GIFs</span><br><span class="hljs-keyword">if</span> (!image.images) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.shouldDecompressImages) &#123;<br>image = [<span class="hljs-built_in">UIImage</span> decodedImageWithImage:image];<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">CGSizeEqualToSize</span>(image.size, <span class="hljs-built_in">CGSizeZero</span>)) &#123;<br>completionBlock(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, [<span class="hljs-built_in">NSError</span>...], <span class="hljs-literal">YES</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>completionBlock(image, <span class="hljs-keyword">self</span>.imageData, <span class="hljs-literal">nil</span>, <span class="hljs-literal">YES</span>);<br>&#125;<br>...<br><span class="hljs-keyword">self</span>.completionBlock = <span class="hljs-literal">nil</span>;<br>[<span class="hljs-keyword">self</span> done];<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-5-å›¾ç‰‡ç¼©æ”¾ä¸è§£ç "><a href="#2-5-å›¾ç‰‡ç¼©æ”¾ä¸è§£ç " class="headerlink" title="2.5.å›¾ç‰‡ç¼©æ”¾ä¸è§£ç "></a>2.5.å›¾ç‰‡ç¼©æ”¾ä¸è§£ç </h4><ul><li>å›¾ç‰‡ç¼©æ”¾</li></ul><p>ä¸Šé¢ä¸¤ä¸ªä¸‹è½½çš„å›è°ƒä¸­è°ƒç”¨äº†ä¸€ä¸ªå…±åŒçš„æ–¹æ³•ï¼š</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs maxima">- (UIImage *)scaledImageForKey:(NSString *)<span class="hljs-built_in">key</span> <span class="hljs-built_in">image</span>:(UIImage *)<span class="hljs-built_in">image</span> &#123;<br>    <span class="hljs-built_in">return</span> SDScaledImageForKey(<span class="hljs-built_in">key</span>, <span class="hljs-built_in">image</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šæ ¹æ®å›¾ç‰‡URLå­—ç¬¦ä¸²æ¨æ–­å›¾ç‰‡çš„scaleï¼ŒæŒ‰æ­¤scaleç»˜åˆ¶ä¸€å¼ æ–°å›¾ã€‚<br><br/></p><p>ä¸ºå•¥è¦åšè¿™ä¸ªæ“ä½œå‘¢ï¼Ÿè¿™é‡Œè¦æåˆ°ä¸‰ä¸ªå…³äºå›¾ç‰‡å°ºå¯¸ä¿¡æ¯çš„æ¦‚å¿µï¼š<br><br/></p><p>1ã€<strong>pixel dimensions</strong><br><br/></p><p>è¿™æ˜¯æŒ‡å›¾ç‰‡çš„<code>å®é™…åƒç´ å°ºå¯¸</code>ï¼Œå°±æ˜¯åœ¨æ–‡ä»¶å¤¹ä¸­æ˜¾ç¤ºçš„çœŸå®å›¾ç‰‡å°ºå¯¸ã€‚æ¯”å¦‚@1xå›¾çš„å°ºå¯¸æ˜¯40*40ï¼Œé‚£ä¹ˆ@2xçš„å®é™…å°ºå¯¸å°±æ˜¯80*80ï¼Œ@3xçš„å®é™…å°ºå¯¸å°±æ˜¯120*120ã€‚å›¾ç‰‡çš„æ¸…æ™°åº¦åªå’Œå›¾ç‰‡æœ¬èº«çš„åƒç´ å°ºå¯¸æœ‰å…³ï¼Œå®é™…å°ºå¯¸è¶Šå¤§åˆ™å›¾ç‰‡æ˜¾ç¤ºè¶Šæ¸…æ™°ã€‚<br><br/></p><p>2ã€<strong>size</strong><br><br/></p><p><a href="https://developer.apple.com/documentation/uikit/uiimage/1624105-size">å®˜æ–¹æ–‡æ¡£</a>ä¸­æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š</p><blockquote><p>The logical dimensions of the image, measured in points.</p></blockquote><p>This value reflects the logical size of the image and takes the imageâ€™s current orientation into account. Multiply the size values by the value in the scale property to get the pixel dimensions of the image.<br><br/></p><p>size æ˜¯å›¾ç‰‡çš„<code>é€»è¾‘å°ºå¯¸</code>ï¼Œè€Œå›¾ç‰‡çš„å®é™…å°ºå¯¸è¦åœ¨sizeå¯¹åº”å­—æ®µçš„åŸºç¡€ä¸Šå†ä¹˜ä»¥scaleï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">å®é™…å®½åº¦ <span class="hljs-operator">=</span> size.width * scale<span class="hljs-comment">;</span><br>size.width <span class="hljs-operator">=</span> å®é™…å®½åº¦ / scale<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢çš„å…¬å¼ï¼Œå›¾ç‰‡çš„sizeéœ€è¦åœ¨å®é™…åƒç´ å°ºå¯¸çš„åŸºç¡€ä¸Šé™¤ä»¥å…¶scaleã€‚å¦‚æœ@1xå›¾çš„å®é™…å°ºå¯¸æ˜¯40*40ï¼Œåˆ™å…¶sizeä¸º40*40ï¼›@2xå›¾çš„å®é™…å°ºå¯¸æ˜¯80*80ï¼Œåˆ™å…¶sizeä¹Ÿä¸º40*40ï¼›@3xå›¾çš„å®é™…å°ºå¯¸æ˜¯120*120ï¼Œåˆ™å…¶sizeè¿˜æ˜¯40*40ï¼›è¿™æ ·ï¼Œå¦‚æœè®¾ç½®äº†imageviewçš„frameè‡ªé€‚åº”å…¶ç´ æçš„å¤§å°ï¼Œå°±èƒ½ä¿è¯åœ¨ä¸åŒåˆ†è¾¨ç‡çš„è®¾å¤‡ä¸Šimageview.frame.sizeçš„ä¸€è‡´æ€§ã€‚<br><br/></p><p>3ã€<strong>scale</strong><br><br/></p><p><a href="https://developer.apple.com/documentation/uikit/uiimage/1624110-scale">å®˜æ–¹æ–‡æ¡£</a>ä¸­æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š</p><blockquote><p>The scale factor of the image.</p></blockquote><p>If you load an image from a file whose name includes the @2x modifier, the scale is set to 2.0. You can also specify an explicit scale factor when initializing an image from a Core Graphics image. All other images are assumed to have a scale factor of 1.0.<br>If you multiply the logical size of the image (stored in the size property) by the value in this property, you get the dimensions of the image in pixels.</p><br/><p>è¿™æ˜¯å›¾ç‰‡çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œæ˜¯ä¸€ä¸ªCGFloatæ•°å€¼ï¼Œä¾å›¾ç‰‡æœ¬èº«çš„å‘½åè€Œå®šã€‚å¦‚æœå›¾ç‰‡åä¸º park@2x.png åˆ™å›¾ç‰‡çš„scaleå°±æ˜¯2ï¼›å¦‚æœå›¾ç‰‡åä¸º park@3x.png åˆ™å›¾ç‰‡çš„scaleå°±æ˜¯3ã€‚</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">UIImage <span class="hljs-symbol">*</span>p1 = [UIImage imageNamed:<span class="hljs-meta">@&quot;park</span><span class="hljs-meta">@2x&quot;];</span><br>UIImage <span class="hljs-symbol">*</span>p2 = [UIImage imageNamed:<span class="hljs-meta">@&quot;park</span><span class="hljs-meta">@3x&quot;];</span><br>NSLog(<span class="hljs-meta">@&quot;+++</span><span class="hljs-meta">@2x.scale:%.0f,</span> <span class="hljs-meta">@3x.scale:%.0f&quot;,p1.scale,p2.scale);</span><br>// æ—¥å¿—ï¼š+++<span class="hljs-meta">@2x.scale:2,</span> <span class="hljs-meta">@3x.scale:3</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>é™¤ä»¥@2xå’Œ@3xå‘½åçš„å›¾ç‰‡å¤–ï¼Œå…¶ä»–æ‰€æœ‰å›¾ç‰‡çš„scaleéƒ½æ˜¯1.0</strong>ã€‚è¿™é‡Œæ ‡äº†ç²—ä½“ï¼Œå› ä¸ºè¿™å¥è¯å¾ˆé‡è¦ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä»¥ park.png å‘½åï¼Œæˆ–è€…<strong>ä»ç½‘ç»œä¸Šä¸‹è½½çš„å›¾ç‰‡ï¼Œå®ƒä»¬çš„scaleé»˜è®¤éƒ½æ˜¯1.0</strong> ï¼ï¼ï¼è¿™ä¹Ÿæ­£æ˜¯SDåº“ä¸­ä¸‹è½½å®Œå›¾ç‰‡æˆ–è€…ä»ç¼“å­˜ä¸­å–å‡ºå›¾ç‰‡åï¼Œæ‰§è¡Œä¸Šé¢çš„æ–¹æ³•é‡ç½®å›¾ç‰‡scaleå±æ€§çš„åŸå› æ‰€åœ¨~<br><br/></p><p>ä¸ºäº†é€‚é…ä¸åŒå°ºå¯¸çš„iPhoneï¼Œæˆ‘ä»¬çš„ç´ æéœ€è¦æä¾›ä¸‰ä¸ªç‰ˆæœ¬ï¼Œpark.pngï¼Œpark@2x.pngï¼Œpart@3x.pngã€‚ä½¿ç”¨ç´ ææ—¶ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">UIImage</span> *img = [<span class="hljs-built_in">UIImage</span> imageNamed:<span class="hljs-string">@&quot;park&quot;</span>];<br></code></pre></td></tr></table></figure><p>ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®å½“å‰å±å¹•çš„scaleé€‰æ‹©å¯¹åº”åç¼€çš„å›¾ç‰‡ç´ æã€‚åœ¨4&#x2F;4sä¹‹åçš„æ‰‹æœºä¸Šç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½ä»¥@2xä¸ºåç¼€çš„å›¾ç‰‡ï¼›åœ¨6p ä¹‹åçš„plusç‰ˆæœ¬æ‰‹æœºä¸Šç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½ä»¥@3xä¸ºåç¼€çš„å›¾ç‰‡ã€‚<br><br/></p><p>é—®é¢˜æ¥äº†ï¼Œä»ç½‘ç»œä¸Šä¸‹è½½çš„å›¾ç‰‡å…¶scaleé»˜è®¤æ˜¯1.0ï¼Œè€Œå…¶å®é™…å°ºå¯¸æ˜¯ç¡®å®šçš„ã€‚æ ¹æ®å…¬å¼ï¼š<code>size</code> &#x3D; <code>å®é™…å°ºå¯¸</code> &#x2F; <code>scale</code>ï¼Œ<strong>åŒä¸€å¼ å›¾ï¼Œscaleè¶Šå°å…¶sizeå°±è¶Šå¤§</strong>ã€‚å¦‚æœè®¾ç½®äº†imageviewè‡ªé€‚åº”ç´ æçš„å¤§å°ï¼Œåˆ™æœ¬è¯¥ä½¿ç”¨@2xæˆ–@3xç´ æçš„è§†å›¾ï¼Œå…¶frame.sizeä¼šæ¯”é¢„æƒ³çš„è¦å¤§ï¼Œæ‰€ä»¥ä¸ºäº†æ•ˆæœçš„å‡†ç¡®æ€§ï¼Œè¿˜æ˜¯éœ€è¦æ­£ç¡®è®¾ç½®å›¾ç‰‡çš„scaleå‚æ•°ã€‚<br><br/></p><p>SDä¸­é‡ç½®å›¾ç‰‡scaleçš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">inline</span> <span class="hljs-built_in">UIImage</span> *SDScaledImageForKey(<span class="hljs-built_in">NSString</span> *key, <span class="hljs-built_in">UIImage</span> *image) &#123;<br>    <span class="hljs-keyword">if</span> (!image) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-comment">//æ•°ç»„ä¸ç©ºï¼Œåˆ™è¿”å›ä¸€ä¸ªåŠ¨å›¾</span><br>    <span class="hljs-keyword">if</span> ([image.images count] &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">NSMutableArray</span> *scaledImages = [<span class="hljs-built_in">NSMutableArray</span> array];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">UIImage</span> *tempImage <span class="hljs-keyword">in</span> image.images) &#123;<br>            [scaledImages addObject:SDScaledImageForKey(key, tempImage)];<br>        &#125;<br>        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIImage</span> animatedImageWithImages:scaledImages duration:image.duration];<br>    &#125;<br>    <span class="hljs-comment">//æ ¹æ®å›¾ç‰‡URLï¼Œåˆ¤æ–­å›¾ç‰‡æ¯”ä¾‹ï¼Œé‡æ–°ç»˜åˆ¶æ–°å›¾å¹¶è¿”å›</span><br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> ([[<span class="hljs-built_in">UIScreen</span> mainScreen] respondsToSelector:<span class="hljs-keyword">@selector</span>(scale)]) &#123;<br>            <span class="hljs-built_in">CGFloat</span> scale = [<span class="hljs-built_in">UIScreen</span> mainScreen].scale;<br>            <br>            <span class="hljs-comment">// &quot;@2x.png&quot; æˆ–è€… &quot;@2x.png&quot; å­—ç¬¦ä¸²çš„é•¿åº¦=7ï¼ŒåŠ ä¸Š@ç¬¦å·ä¹‹å‰çš„åå­—ï¼Œå¿…å®š&gt;=8</span><br>            <span class="hljs-keyword">if</span> (key.length &gt;= <span class="hljs-number">8</span>) &#123;<br>                <span class="hljs-built_in">NSRange</span> range = [key rangeOfString:<span class="hljs-string">@&quot;@2x.&quot;</span>];<br>                <span class="hljs-keyword">if</span> (range.location != <span class="hljs-built_in">NSNotFound</span>) &#123;<span class="hljs-comment">//URLåŒ…å«@2xï¼Œæ¨æµ‹ä¸º2å€å›¾</span><br>                    scale = <span class="hljs-number">2.0</span>;<br>                &#125;<br>                range = [key rangeOfString:<span class="hljs-string">@&quot;@3x.&quot;</span>];<br>                <span class="hljs-keyword">if</span> (range.location != <span class="hljs-built_in">NSNotFound</span>) &#123;<span class="hljs-comment">//URLåŒ…å«@3xï¼Œæ¨æµ‹ä¸º3å€å›¾</span><br>                    scale = <span class="hljs-number">3.0</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-built_in">UIImage</span> *scaledImage = [[<span class="hljs-built_in">UIImage</span> alloc] initWithCGImage:image.CGImage <br>                                                              scale:scale <br>                                                              orientation:image.imageOrientation];<br>            image = scaledImage;<br>        &#125;<br>        <span class="hljs-keyword">return</span> image;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å›¾ç‰‡è§£ç </li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSDä¼šå¯¹ä¸‹è½½çš„å›¾ç‰‡æ‰§è¡Œ<code>[UIImage decodedImageWithImage:scaledImage]</code>ï¼Œå³å›¾ç‰‡è§£ç ï¼ˆåŠ¨å›¾é™¤å¤–ï¼‰ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-built_in">UIImage</span> *)decodedImageWithImage:(<span class="hljs-built_in">UIImage</span> *)image &#123;<br>    <span class="hljs-comment">// while downloading huge amount of images</span><br>    <span class="hljs-comment">// autorelease the bitmap context</span><br>    <span class="hljs-comment">// and all vars to help system to free memory</span><br>    <span class="hljs-comment">// when there are memory warning.</span><br>    <span class="hljs-comment">// on iOS7, do not forget to call</span><br>    <span class="hljs-comment">// [[SDImageCache sharedImageCache] clearMemory];</span><br>    <span class="hljs-keyword">@autoreleasepool</span>&#123;<br>        <span class="hljs-comment">// do not decode animated images</span><br>        <span class="hljs-keyword">if</span> (image.images) &#123; <span class="hljs-keyword">return</span> image; &#125;<br>    <br>        <span class="hljs-built_in">CGImageRef</span> imageRef = image.CGImage;<br>    <br>        <span class="hljs-comment">//å›¾ç‰‡å¦‚æœæœ‰alphaé€šé“ï¼Œå°±è¿”å›åŸå§‹imageï¼Œå› ä¸ºjpgå›¾ç‰‡æœ‰alphaçš„è¯ï¼Œå°±ä¸å‹ç¼©</span><br>        <span class="hljs-built_in">CGImageAlphaInfo</span> alpha = <span class="hljs-built_in">CGImageGetAlphaInfo</span>(imageRef);<br>        <span class="hljs-type">BOOL</span> anyAlpha = (alpha == kCGImageAlphaFirst ||<br>                         alpha == kCGImageAlphaLast ||<br>                         alpha == kCGImageAlphaPremultipliedFirst ||<br>                         alpha == kCGImageAlphaPremultipliedLast);<br>    <br>        <span class="hljs-keyword">if</span> (anyAlpha) &#123; <span class="hljs-keyword">return</span> image; &#125;<br>    <br>        size_t width = <span class="hljs-built_in">CGImageGetWidth</span>(imageRef);<br>        size_t height = <span class="hljs-built_in">CGImageGetHeight</span>(imageRef);<br>    <br>        <span class="hljs-comment">// current</span><br>        <span class="hljs-built_in">CGColorSpaceModel</span> imageColorSpaceModel = <span class="hljs-built_in">CGColorSpaceGetModel</span>(<span class="hljs-built_in">CGImageGetColorSpace</span>(imageRef));<br>        <span class="hljs-built_in">CGColorSpaceRef</span> colorspaceRef = <span class="hljs-built_in">CGImageGetColorSpace</span>(imageRef);<br>        <br>        <span class="hljs-type">bool</span> unsupportedColorSpace = (imageColorSpaceModel == <span class="hljs-number">0</span> || <br>                                    imageColorSpaceModel == <span class="hljs-number">-1</span> || <br>                                    imageColorSpaceModel == kCGColorSpaceModelCMYK || <br>                                    imageColorSpaceModel == kCGColorSpaceModelIndexed);<br>        <span class="hljs-keyword">if</span> (unsupportedColorSpace)<span class="hljs-comment">//å¦‚æœå±äºä¸Šè¿°ä¸æ”¯æŒçš„ColorSpaceï¼Œåˆ™ColorSpaceå°±ä½¿ç”¨RGB</span><br>            colorspaceRef = <span class="hljs-built_in">CGColorSpaceCreateDeviceRGB</span>();<br>    <br>        <span class="hljs-built_in">CGContextRef</span> context = <span class="hljs-built_in">CGBitmapContextCreate</span>(<span class="hljs-literal">NULL</span>, width,<br>                                                     height,<br>                                                     <span class="hljs-built_in">CGImageGetBitsPerComponent</span>(imageRef),<br>                                                     <span class="hljs-number">0</span>,<br>                                                     colorspaceRef,<br>                                                     kCGBitmapByteOrderDefault | <br>                                                     kCGImageAlphaPremultipliedFirst);<br>    <br>        <span class="hljs-comment">// Draw the image into the context and retrieve the new image, which will now have an alpha layer</span><br>        <span class="hljs-built_in">CGContextDrawImage</span>(context, <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), imageRef);<br>        <span class="hljs-built_in">CGImageRef</span> imageRefWithAlpha = <span class="hljs-built_in">CGBitmapContextCreateImage</span>(context);<br>        <span class="hljs-built_in">UIImage</span> *imageWithAlpha = [<span class="hljs-built_in">UIImage</span> imageWithCGImage:imageRefWithAlpha <br>                                                      scale:image.scale orientation:image.imageOrientation];<br>    <br>        <span class="hljs-keyword">if</span> (unsupportedColorSpace)<br>            <span class="hljs-built_in">CGColorSpaceRelease</span>(colorspaceRef);<br>        <br>        <span class="hljs-built_in">CGContextRelease</span>(context);<br>        <span class="hljs-built_in">CGImageRelease</span>(imageRefWithAlpha);<br>        <br>        <span class="hljs-keyword">return</span> imageWithAlpha;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>SDä¸ºå•¥â€œå¤šæ­¤ä¸€ä¸¾â€å‘¢ï¼Ÿ<a href="https://www.cnblogs.com/chmhml/p/6817383.html">è¿™é‡Œ</a> æœ‰ç§è§£é‡Šï¼š</p><blockquote><p>ä¸€èˆ¬ä¸‹è½½çš„å›¾ç‰‡æˆ–è€…æˆ‘ä»¬æ‰‹åŠ¨æ‹–è¿›ä¸» bundle çš„å›¾ç‰‡éƒ½æ˜¯ PNG æˆ–è€… JPG æ ¼å¼çš„å›¾ç‰‡ï¼Œè¿™äº›å›¾ç‰‡éƒ½æ˜¯ç»è¿‡ç¼–ç å‹ç¼©åçš„å›¾ç‰‡æ•°æ®ï¼Œå¹¶ä¸æ˜¯æ§ä»¶å¯ä»¥ç›´æ¥æ˜¾ç¤ºçš„ä½å›¾ã€‚å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ â€œ[UIImage imageNamed:]â€ æ¥åŠ è½½å›¾ç‰‡ï¼Œç³»ç»Ÿé»˜è®¤ä¼šåœ¨ä¸»çº¿ç¨‹ç«‹å³è¿›è¡Œå›¾ç‰‡çš„è§£ç å·¥ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æŠŠå›¾ç‰‡æ•°æ®è§£ç æˆå¯ä¾›æ§ä»¶ç›´æ¥æ˜¾ç¤ºçš„ä½å›¾æ•°æ®ã€‚ç”±äºè¿™ä¸ªè§£ç æ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œå¹¶ä¸”é»˜è®¤æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œï¼Œæ‰€ä»¥å½“åœ¨ä¸»çº¿ç¨‹å¤§é‡è°ƒç”¨æ—¶å°±ä¼šäº§ç”Ÿå¡é¡¿ã€‚åŒæ—¶ç”±äºä½å›¾ä½“ç§¯è¾ƒå¤§ï¼Œæ‰€ä»¥åœ¨ç£ç›˜ç¼“å­˜ä¸­ä¸ä¼šç›´æ¥ç¼“å­˜ä½å›¾æ•°æ®ï¼Œè€Œæ˜¯ç¼–ç å‹ç¼©è¿‡çš„PNG æˆ–è€… JPG æ•°æ®ã€‚</p></blockquote><p>è¿™é‡Œæ›´å‡†ç¡®çš„è¯´ï¼Œ[UIImage imageNamed:] åŠ è½½å›¾ç‰‡æ—¶ï¼Œä¸æ˜¯ç«‹å³è§£ç çš„ï¼Œè€Œæ˜¯åœ¨å›¾ç‰‡è®¾ç½®åˆ°<code>UIImageView</code>æˆ–è€…<code>CALayer.contents</code>ä¸­ï¼Œå¹¶ä¸” CALayer è¢«æäº¤åˆ°GPUè¿›è¡Œæ¸²æŸ“å‰æ‰ä¼šè§£ç ã€‚å¦å¤–ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼åŠ è½½å›¾ç‰‡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç¼“å­˜ä¸€ä»½è¯¥å›¾ç‰‡ï¼Œåé¢å†ä½¿ç”¨æ­¤å›¾æ—¶ä¼šç›´æ¥ä»ç¼“å­˜ä¸­å–ï¼Œä¸å†æ¬¡è§£ç ã€‚å³ä½¿å¦‚æ­¤ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼åŠ è½½å›¾ç‰‡æ—¶ï¼Œæœ€åçš„è§£ç éƒ¨åˆ†ä»ç„¶æ—¶åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼Œæ‰€ä»¥å½“å¤§é‡åŠ è½½å›¾ç‰‡æ—¶ï¼Œä»ç„¶æœ‰å¯èƒ½ä¼šå‡ºç°å¡é¡¿ç°è±¡ã€‚<br><br/></p><p>SD è¿™é‡Œæ‰€åšçš„æ­£æ˜¯å¯¹å›¾ç‰‡è¿›è¡Œè§£ç ï¼Œè€Œä¸”æ˜¯åœ¨å¼‚æ­¥çº¿ç¨‹é‡Œã€‚<strong>SDç¼“å­˜å›¾ç‰‡åˆ°å†…å­˜æ—¶ä¿å­˜çš„æ˜¯è§£ç åçš„å›¾ç‰‡</strong>ï¼Œç¼“å­˜æ˜¯é€šè¿‡ NSCache å®ç°çš„ã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯æé«˜åŠ è½½å›¾ç‰‡çš„é€Ÿåº¦å’Œæ•ˆç‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒåœ¨è§£ç æ—¶ä¼šå ç”¨ç›¸å½“ä¸€éƒ¨åˆ†å†…å­˜ï¼Œæ˜¯å…¸å‹çš„ç©ºé—´æ¢æ—¶é—´ã€‚å¦‚æœä½ é‡åˆ°äº†å†…å­˜é—®é¢˜ï¼Œå¯ä»¥å°è¯•ç¦æ­¢è‡ªåŠ¨è§£ç æˆ–è€…æ¸…ç©ºç¼“å­˜ï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs inform7"><span class="hljs-comment">[<span class="hljs-comment">[SDImageCache sharedImageCache]</span> setShouldDecompressImages:NO]</span>;<br><span class="hljs-comment">[<span class="hljs-comment">[SDWebImageDownloader sharedDownloader]</span> setShouldDecompressImages:NO]</span>;<br><span class="hljs-comment">[<span class="hljs-comment">[SDImageCache sharedImageCache]</span> clearMemory]</span>;<br></code></pre></td></tr></table></figure><h3 id="ä¸‰ã€ç¼“å­˜ç±»çš„å®ç°"><a href="#ä¸‰ã€ç¼“å­˜ç±»çš„å®ç°" class="headerlink" title="ä¸‰ã€ç¼“å­˜ç±»çš„å®ç°"></a>ä¸‰ã€ç¼“å­˜ç±»çš„å®ç°</h3><p>å†™è¿™ç¯‡æ–‡ç« æ—¶æœ€æ–°sdç‰ˆæœ¬ä¸º3.7.3ï¼Œç¼“å­˜ç›¸å…³åŠŸèƒ½ä¸»è¦ç”± SDImageCache ç±»æä¾›ã€‚è¿™é‡Œçš„ç¼“å­˜åŒ…æ‹¬äº†å†…å­˜å’Œç£ç›˜ä¸¤ç§æ–¹å¼ã€‚å…¶ä¸­ï¼Œå†…å­˜ç¼“å­˜ä½¿ç”¨çš„æ˜¯ç»§æ‰¿è‡ª NSCache çš„ AutoPurgeCache ç±»ï¼›ç£ç›˜ç¼“å­˜çš„æ“ä½œè¢«å•ç‹¬æ”¾åœ¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ— ioQueue ä¸­ã€‚è¿™ä¸ªç±»ä¸­ä¸»è¦çš„æ–¹æ³•åŠå®ç°å¦‚ä¸‹ï¼š</p><h4 id="3-1-æŸ¥è¯¢å›¾ç‰‡ç¼“å­˜"><a href="#3-1-æŸ¥è¯¢å›¾ç‰‡ç¼“å­˜" class="headerlink" title="3.1.æŸ¥è¯¢å›¾ç‰‡ç¼“å­˜"></a>3.1.æŸ¥è¯¢å›¾ç‰‡ç¼“å­˜</h4><ul><li>step.1 ä»å†…å­˜ä¸­æ£€æµ‹ï¼›</li><li>step.2 ä»ç£ç›˜ä¸­æ£€æµ‹ï¼ˆå¼‚æ­¥+ä¸²è¡Œé˜Ÿåˆ—ï¼‰ï¼›</li><li>step.3 ç£ç›˜ä¸­æ£€æµ‹åˆ°ç¼“å­˜åï¼Œæ ¹æ®éœ€è¦ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼›</li><li>step.4 è¿”å›ç»“æœï¼›</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-built_in">NSOperation</span> *)queryDiskCacheForKey:(<span class="hljs-built_in">NSString</span> *)key<br>done:(SDWebImageQueryCompletedBlock)doneBlock<br>&#123;<br>...<br>    <span class="hljs-comment">//step.1 å…ˆä»å†…å­˜ä¸­æ£€æµ‹</span><br>    <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-keyword">self</span> imageFromMemoryCacheForKey:key];<br>    <span class="hljs-keyword">if</span> (image) &#123;<br>        doneBlock(image, SDImageCacheTypeMemory);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//step.2 å†…å­˜ä¸­æ²¡æœ‰å†ä»ç£ç›˜ä¸­æ£€æµ‹</span><br>    <span class="hljs-built_in">NSOperation</span> *operation = [<span class="hljs-built_in">NSOperation</span> new];<br>    <span class="hljs-built_in">dispatch_async</span>(<span class="hljs-keyword">self</span>.ioQueue, ^&#123;<br>        <span class="hljs-keyword">if</span> (operation.isCancelled) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>            <span class="hljs-built_in">UIImage</span> *diskImage = [<span class="hljs-keyword">self</span> diskImageForKey:key];<br>            <span class="hljs-comment">//step.3 ç£ç›˜ä¸­æ£€æµ‹åˆ°ç¼“å­˜å æ ¹æ®éœ€è¦ç¼“å­˜åˆ°å†…å­˜ä¸­</span><br>            <span class="hljs-keyword">if</span> (diskImage &amp;&amp; <span class="hljs-keyword">self</span>.shouldCacheImagesInMemory) &#123;<br>                <span class="hljs-built_in">NSUInteger</span> cost = SDCacheCostForImage(diskImage);<br>                [<span class="hljs-keyword">self</span>.memCache setObject:diskImage forKey:key cost:cost];<br>            &#125;<br><br>            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>                doneBlock(diskImage, SDImageCacheTypeDisk);<br>            &#125;);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> operation;<br>&#125;<br><br>- (<span class="hljs-built_in">UIImage</span> *)imageFromMemoryCacheForKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span>.memCache objectForKey:key];<br>&#125;<br><br>- (<span class="hljs-built_in">UIImage</span> *)diskImageForKey:(<span class="hljs-built_in">NSString</span> *)key &#123;<br>    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-keyword">self</span> diskImageDataBySearchingAllPathsForKey:key];<br>    <span class="hljs-keyword">if</span> (data) &#123;<br>        <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> sd_imageWithData:data];<br>         <span class="hljs-comment">// é‡ç½®å›¾ç‰‡scale</span><br>        image = [<span class="hljs-keyword">self</span> scaledImageForKey:key image:image];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.shouldDecompressImages) &#123;<br>            <span class="hljs-comment">// å›¾ç‰‡è§£ç </span><br>            image = [<span class="hljs-built_in">UIImage</span> decodedImageWithImage:image];<br>        &#125;<br>        <span class="hljs-keyword">return</span> image;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-2-ä¿å­˜å›¾ç‰‡"><a href="#3-2-ä¿å­˜å›¾ç‰‡" class="headerlink" title="3.2.ä¿å­˜å›¾ç‰‡"></a>3.2.ä¿å­˜å›¾ç‰‡</h4><p>å›¾ç‰‡ä¸‹è½½æˆåŠŸåï¼Œé»˜è®¤ä¼šä¿å­˜åˆ°å†…å­˜ä¸­ã€‚ä¿å­˜åˆ°ç£ç›˜æ—¶ï¼Œä¼šå…ˆæ£€æµ‹å›¾ç‰‡çš„æ ¼å¼ï¼Œæ–‡ä»¶åä¸ºURLå¯¹åº”çš„MD5å€¼ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)storeImage:(<span class="hljs-built_in">UIImage</span> *)image<br>recalculateFromImage:(<span class="hljs-type">BOOL</span>)recalculate<br>         imageData:(<span class="hljs-built_in">NSData</span> *)imageData<br>            forKey:(<span class="hljs-built_in">NSString</span> *)key<br>            toDisk:(<span class="hljs-type">BOOL</span>)toDisk<br>&#123;<br>    ...<br>    <span class="hljs-comment">//ä¿å­˜åˆ°å†…å­˜ NSCacheï¼Œcostä¸ºåƒç´ å€¼</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.shouldCacheImagesInMemory) &#123;<br>        <span class="hljs-built_in">NSUInteger</span> cost = SDCacheCostForImage(image);<br>        [<span class="hljs-keyword">self</span>.memCache setObject:image forKey:key cost:cost];<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (toDisk) &#123;<br>        <span class="hljs-built_in">dispatch_async</span>(<span class="hljs-keyword">self</span>.ioQueue, ^&#123;<br>            <span class="hljs-built_in">NSData</span> *data = imageData;<br><br>            <span class="hljs-keyword">if</span> (image &amp;&amp; (recalculate || !data)) &#123;<br>            <span class="hljs-meta">#<span class="hljs-keyword">if</span> TARGET_OS_IPHONE</span><br><br>                <span class="hljs-type">int</span> alphaInfo = <span class="hljs-built_in">CGImageGetAlphaInfo</span>(image.CGImage);<br>                <span class="hljs-type">BOOL</span> hasAlpha = !(alphaInfo == kCGImageAlphaNone ||<br>                alphaInfo == kCGImageAlphaNoneSkipFirst ||<br>                alphaInfo == kCGImageAlphaNoneSkipLast);<br>                <span class="hljs-type">BOOL</span> imageIsPng = hasAlpha;<br><br>                <span class="hljs-comment">//æ£€æµ‹ å›¾ç‰‡data çš„å‰ç¼€æ˜¯å¦æ˜¯ PNG æ ¼å¼</span><br>                <span class="hljs-keyword">if</span> ([imageData length] &gt;= [kPNGSignatureData length]) &#123;<br>                    imageIsPng = ImageDataHasPNGPreffix(imageData);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (imageIsPng) &#123;<br>                    data = <span class="hljs-built_in">UIImagePNGRepresentation</span>(image);<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    data = <span class="hljs-built_in">UIImageJPEGRepresentation</span>(image, (<span class="hljs-built_in">CGFloat</span>)<span class="hljs-number">1.0</span>);<br>                &#125;<br>            <span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>                data = [<span class="hljs-built_in">NSBitmapImageRep</span> representationOfImageRepsInArray:<br>                image.representations<br>                usingType: <span class="hljs-built_in">NSJPEGFileType</span> properties:<span class="hljs-literal">nil</span>];<br>            <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            &#125;<br><br>            <span class="hljs-comment">// get cache Path for image key</span><br>            <span class="hljs-built_in">NSString</span> *cachePathForKey = [<span class="hljs-keyword">self</span> defaultCachePathForKey:key];<br>            <span class="hljs-comment">// transform to NSUrl</span><br>            <span class="hljs-built_in">NSURL</span> *fileURL = [<span class="hljs-built_in">NSURL</span> fileURLWithPath:cachePathForKey];<br><br>            <span class="hljs-comment">// ä¿å­˜åˆ°ç£ç›˜ä¸­</span><br>            [_fileManager createFileAtPath:cachePathForKey contents:data attributes:<span class="hljs-literal">nil</span>];<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿å­˜åˆ°ç£ç›˜æ—¶ï¼Œå›¾ç‰‡çš„å‘½åè§„åˆ™å¦‚ä¸‹ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs prolog">- (<span class="hljs-symbol">NSString</span> *)cachedFileNameForKey:(<span class="hljs-symbol">NSString</span> *)key &#123;<br>    const char *str = [key <span class="hljs-symbol">UTF8String</span>];<br>    if (str == <span class="hljs-symbol">NULL</span>) &#123;<br>        str = <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    unsigned char r[<span class="hljs-symbol">CC_MD5_DIGEST_LENGTH</span>];<br>    <span class="hljs-symbol">CC_MD5</span>(str, (<span class="hljs-symbol">CC_LONG</span>)strlen(str), r);<br>    <span class="hljs-symbol">NSString</span> *filename = [<span class="hljs-symbol">NSString</span> stringWithFormat:<br>    @<span class="hljs-string">&quot;%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%@&quot;</span>,<br>    r[<span class="hljs-number">0</span>], r[<span class="hljs-number">1</span>], r[<span class="hljs-number">2</span>], r[<span class="hljs-number">3</span>], r[<span class="hljs-number">4</span>], r[<span class="hljs-number">5</span>],<br>    r[<span class="hljs-number">6</span>], r[<span class="hljs-number">7</span>], r[<span class="hljs-number">8</span>], r[<span class="hljs-number">9</span>], r[<span class="hljs-number">10</span>],<br>    r[<span class="hljs-number">11</span>], r[<span class="hljs-number">12</span>], r[<span class="hljs-number">13</span>], r[<span class="hljs-number">14</span>], r[<span class="hljs-number">15</span>],<br>    [[key pathExtension] isEqualToString:@<span class="hljs-string">&quot;&quot;</span>] ?<br>    @<span class="hljs-string">&quot;&quot;</span> : [<span class="hljs-symbol">NSString</span> stringWithFormat:@<span class="hljs-string">&quot;.%@&quot;</span>,<br>    [key pathExtension]]];<br>    return filename;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-æ¸…é™¤ç¼“å­˜"><a href="#3-3-æ¸…é™¤ç¼“å­˜" class="headerlink" title="3.3.æ¸…é™¤ç¼“å­˜"></a>3.3.æ¸…é™¤ç¼“å­˜</h4><p>ç¨‹åºå‡ºç°å†…å­˜è­¦å‘Šæ—¶ä¼šæ¸…é™¤å†…å­˜ä¸­çš„ç¼“å­˜ï¼›é€€å‡ºåº”ç”¨ã€è¿›å…¥åå°æ—¶åˆ™æ ¹æ®ä¸‹é¢çš„ç­–ç•¥æ¸…é™¤ç›¸å…³ç£ç›˜ç¼“å­˜ï¼š</p><ul><li>æ¸…é™¤è¿‡æœŸçš„æ–‡ä»¶ï¼Œé»˜è®¤ä¸€æ˜ŸæœŸ;</li><li>å¦‚æœè®¾ç½®äº†æœ€å¤§ç¼“å­˜ï¼Œä¸”å½“å‰ç¼“å­˜æ–‡ä»¶è¶…è¿‡äº†æ­¤é™åˆ¶ï¼Œåˆ™åˆ é™¤æœ€æ—§çš„æ–‡ä»¶ï¼Œç›´åˆ°å½“å‰ç¼“å­˜æ–‡ä»¶çš„å¤§å°ä¸ºæœ€å¤§ç¼“å­˜å¤§å°çš„ä¸€åŠ;</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)cleanDiskWithCompletionBlock:(SDWebImageNoParamsBlock)completionBlock<br>&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(<span class="hljs-keyword">self</span>.ioQueue, ^&#123;<br>        <span class="hljs-comment">/*...*/</span><br>        <span class="hljs-built_in">NSDate</span> *expirationDate = [<span class="hljs-built_in">NSDate</span> dateWithTimeIntervalSinceNow:<br>        -<span class="hljs-keyword">self</span>.maxCacheAge];<br>        <span class="hljs-built_in">NSMutableDictionary</span> *cacheFiles = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>        <span class="hljs-built_in">NSUInteger</span> currentCacheSize = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">//éå†ç¼“å­˜ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶</span><br>        <span class="hljs-built_in">NSMutableArray</span> *urlsToDelete = [[<span class="hljs-built_in">NSMutableArray</span> alloc] init];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSURL</span> *fileURL <span class="hljs-keyword">in</span> fileEnumerator) &#123;<br>            <span class="hljs-built_in">NSDictionary</span> *resourceValues = [fileURL resourceValuesForKeys:resourceKeys<br>            error:<span class="hljs-literal">NULL</span>];<br>            <span class="hljs-comment">/*...*/</span><br>            <span class="hljs-comment">// åˆ é™¤è¿‡æœŸçš„æ–‡ä»¶</span><br>            <span class="hljs-built_in">NSDate</span> *modificationDate = resourceValues[<span class="hljs-built_in">NSURLContentModificationDateKey</span>];<br>            <span class="hljs-keyword">if</span> ([[modificationDate laterDate:expirationDate]<br>            isEqualToDate:expirationDate]) &#123;<br>                [urlsToDelete addObject:fileURL];<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">/*...*/</span><br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSURL</span> *fileURL <span class="hljs-keyword">in</span> urlsToDelete) &#123;<br>            [_fileManager removeItemAtURL:fileURL error:<span class="hljs-literal">nil</span>];<br>        &#125;<br><br>        <span class="hljs-comment">//å¦‚æœå‰©ä¸‹çš„ç£ç›˜ç¼“å­˜è¶…è¿‡æœ€å¤§é™åˆ¶ï¼Œå†æ¬¡åˆ æ‰æœ€è€çš„æ–‡ä»¶ï¼Œ</span><br>        <span class="hljs-comment">//ç›´åˆ°å½“å‰ç¼“å­˜æ–‡ä»¶çš„å¤§å°ä¸ºæœ€å¤§ç¼“å­˜å¤§å°çš„ä¸€åŠ;</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.maxCacheSize &gt; <span class="hljs-number">0</span> &amp;&amp; currentCacheSize &gt; <span class="hljs-keyword">self</span>.maxCacheSize) &#123;<br>            <span class="hljs-keyword">const</span> <span class="hljs-built_in">NSUInteger</span> desiredCacheSize = <span class="hljs-keyword">self</span>.maxCacheSize / <span class="hljs-number">2</span>;<br><br>            <span class="hljs-built_in">NSArray</span> *sortedFiles = [cacheFiles keysSortedByValueWithOptions:<br>            <span class="hljs-built_in">NSSortConcurrent</span><br>            usingComparator:^<span class="hljs-built_in">NSComparisonResult</span>(<span class="hljs-type">id</span> obj1, <span class="hljs-type">id</span> obj2) &#123;<br>                <span class="hljs-keyword">return</span> [obj1[<span class="hljs-built_in">NSURLContentModificationDateKey</span>]<br>                compare:obj2[<span class="hljs-built_in">NSURLContentModificationDateKey</span>]];<br>            &#125;];<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSURL</span> *fileURL <span class="hljs-keyword">in</span> sortedFiles) &#123;<br>                <span class="hljs-keyword">if</span> ([_fileManager removeItemAtURL:fileURL error:<span class="hljs-literal">nil</span>])&#123;<br>                    <span class="hljs-built_in">NSDictionary</span> *resourceValues = cacheFiles[fileURL];<br>                    <span class="hljs-built_in">NSNumber</span> *totalAllocatedSize =<br>                    resourceValues[<span class="hljs-built_in">NSURLTotalFileAllocatedSizeKey</span>];<br><br>                    currentCacheSize -= [totalAllocatedSize unsignedIntegerValue];<br><br>                    <span class="hljs-keyword">if</span> (currentCacheSize &lt; desiredCacheSize) &#123;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (completionBlock) &#123;<br>            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>                completionBlock();<br>            &#125;);<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å››ã€åè®°"><a href="#å››ã€åè®°" class="headerlink" title="å››ã€åè®°"></a>å››ã€åè®°</h3><p>SD æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç½‘ç»œå›¾ç‰‡ä¸‹è½½åº“ï¼Œå®ƒä½¿åœ¨æŒ‰é’®ç­‰è§†å›¾ä¸­åŠ è½½ç½‘ç»œå›¾ç‰‡æˆ–æœ¬åœ°ç¼“å­˜å˜å¾—å¼‚å¸¸è½»æ¾ï¼Œæœ‰å¾ˆå¤šå€¼å¾—å­¦ä¹ çš„åœ°æ–¹ï¼š</p><ul><li>åº“ä¸­å„ç±»èŒè´£æ¸…æ™°ï¼›</li><li>ç½‘ç»œå›¾ç‰‡çš„ä¸‹è½½ã€è§£ç åŠç¼“å­˜ç­‰éƒ½ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼è¿›è¡Œï¼Œä¿è¯äº†ä¸»çº¿ç¨‹çš„æµç•…æ€§ï¼›</li><li>å¤§é‡ä½¿ç”¨ NSOperation å’Œ GCDï¼Œä¸ºæˆ‘ä»¬å¤„ç†çº¿ç¨‹åŒæ­¥é—®é¢˜æä¾›äº†èŒƒä¾‹ï¼›</li><li>å›¾ç‰‡åŠ è½½å‰ï¼Œå…ˆåœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è§£ç æˆä½å›¾ï¼Œä¸ºæˆ‘ä»¬ä¼˜åŒ–å›¾ç‰‡åŠ è½½æä¾›äº†çµæ„Ÿï¼›</li><li>è®¾è®¡è‰¯å¥½çš„ç¼“å­˜ç­–ç•¥ï¼Œæé«˜äº†åº”ç”¨çš„æ€§èƒ½è¡¨ç°ï¼›</li></ul><p>æœ¬æ–‡æ˜¯æ ¹æ®åŸé¡¹ç›®ä¸­ä½¿ç”¨çš„ 3.7.3 ç‰ˆæœ¬æ¥åˆ†æçš„ï¼Œç›®å‰SDçš„æœ€æ–°ç‰ˆæœ¬å·ä¸º 4.4.1ã€‚å¤§è‡´çœ‹äº†ä¸‹æœ€æ–°çš„ç‰ˆæœ¬ï¼Œç½‘ç»œä¸‹è½½éƒ¨åˆ†å·²ç»ä½¿ç”¨äº† URLSessionï¼Œä¹Ÿæ–°å¢äº†å¾ˆå¤šæ–°çš„ç±»ï¼Œåé¢æœ‰æ—¶é—´ä¼šç»§ç»­ç ”ç©¶ä¸€ä¸‹~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/documentation/uikit/uiimage#//apple_ref/occ/instp/UIImage/scale">Â©AppleDev-UIImage</a></p><p>#<a href="https://www.cnblogs.com/chmhml/p/6817383.html">Â©CHM-SDå›¾ç‰‡è§£ç </a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OCä¸­çš„å†…å­˜ç®¡ç†</title>
    <link href="/2018/01/21/autoreleasepool.html"/>
    <url>/2018/01/21/autoreleasepool.html</url>
    
    <content type="html"><![CDATA[<h3 id="MRC"><a href="#MRC" class="headerlink" title="MRC"></a>MRC</h3><h4 id="1-retain-x2F-release"><a href="#1-retain-x2F-release" class="headerlink" title="1.retain&#x2F;release"></a>1.retain&#x2F;release</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">NSObject</span></span><br><span class="hljs-comment">//...</span><br>- (<span class="hljs-keyword">instancetype</span>)<span class="hljs-keyword">retain</span> OBJC_ARC_UNAVAILABLE;<br>- (<span class="hljs-keyword">oneway</span> <span class="hljs-type">void</span>)release OBJC_ARC_UNAVAILABLE;<br>- (<span class="hljs-keyword">instancetype</span>)autorelease OBJC_ARC_UNAVAILABLE;<br>- (<span class="hljs-built_in">NSUInteger</span>)retainCount OBJC_ARC_UNAVAILABLE;<br><br>- (<span class="hljs-keyword">struct</span> _NSZone *)zone OBJC_ARC_UNAVAILABLE;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨MRCæ—¶ä»£ï¼Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°æ¥ç®¡ç†çš„ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡é¢‘ç¹åœ°æ‰‹åŠ¨æ·»åŠ <code>retain</code>æ¥ä½¿å¼•ç”¨è®¡æ•° +1ï¼Œé€šè¿‡<code>release</code>æ¥ä½¿å¼•ç”¨è®¡æ•° -1ï¼Œå½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œå¯¹è±¡ä¼šè¢«é”€æ¯ã€‚<br><br/></p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs haxe">- (void)setName:<span class="hljs-type"></span>(NSString *)<span class="hljs-keyword">new</span><span class="hljs-type">Name</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (_name != <span class="hljs-keyword">new</span><span class="hljs-type">Name</span>) &#123;<br>        [<span class="hljs-keyword">new</span><span class="hljs-type">Name</span> retain]<span class="hljs-comment">//å¼•ç”¨è®¡æ•°+1ï¼Œå¼ºå¼•ç”¨æ–°å€¼</span><br>        [_name release];<span class="hljs-comment">//å¼•ç”¨è®¡æ•°-1ï¼Œé‡Šæ”¾æ—§å€¼</span><br>        _name = <span class="hljs-keyword">new</span><span class="hljs-type">Name</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·çš„ç®¡ç†æ–¹å¼ä¸ä»…æ¯”è¾ƒç¹çï¼Œè€Œä¸”å¯èƒ½ä¼šå› ä¸ºç–å¿½å¤§æ„è€Œå¯¼è‡´å†…å­˜æ³„éœ²æˆ–è¿‡åº¦é‡Šæ”¾æƒ…å†µçš„å‘ç”Ÿã€‚æ¯”å¦‚ç¤ºä¾‹1ä¸­ï¼Œæˆ‘ä»¬æ˜¯å…ˆé€šè¿‡<code>retain</code>ä½¿<code>newName</code>å¼•ç”¨è®¡æ•° +1ï¼Œå†é€šè¿‡<code>release</code>ä½¿å¼•ç”¨è®¡æ•° -1ã€‚å¦‚æœè¿™ä¸¤è€…é¡ºåºé¢ å€’ï¼Œåˆ™å°±å¯èƒ½å‡ºé—®é¢˜ã€‚å‡è®¾<code>newName</code>å’Œ_name çš„æ—§å€¼æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆå…ˆ<code>release</code>æ—§å€¼å°±ä¼šä½¿æ—§å€¼çš„å¼•ç”¨è®¡æ•°ä¸º0ï¼Œä»è€Œå¯¼è‡´å¯¹è±¡è¢«æå‰é‡Šæ”¾ï¼Œåé¢å†èµ‹å€¼ç»™_name å°±æ— æ•ˆã€‚</p><h4 id="2-è‡ªåŠ¨é‡Šæ”¾æ± "><a href="#2-è‡ªåŠ¨é‡Šæ”¾æ± " class="headerlink" title="2.è‡ªåŠ¨é‡Šæ”¾æ± "></a>2.è‡ªåŠ¨é‡Šæ”¾æ± </h4><p>ä¸ release ç›¸æ¯”ï¼Œ<code>autorelease</code>ç®—æ˜¯ä¸€ç§å»¶è¿Ÿå¯¹è±¡é‡Šæ”¾æ—¶é—´çš„æ–¹å¼ã€‚å®ƒéœ€è¦é…åˆ autorelease pool(è‡ªåŠ¨é‡Šæ”¾æ± )ä½¿ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å¯¹è±¡æ ‡è®°ä¸º<code>autorelease</code>ï¼Œè¿™æ ·å¯¹è±¡å°±ä¼šè¢«è‡ªåŠ¨åŠ å…¥åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼›è‡ªåŠ¨é‡Šæ”¾æ± ä¼šåœ¨åˆé€‚çš„æ—¶æœºè‡ªåŠ¨æˆ–æ‰‹åŠ¨æ‰§è¡Œ<code>drain</code>æ–¹æ³•è¿›è¡Œé”€æ¯ï¼›é”€æ¯å‰ä¼šå‘å…¶å†…éƒ¨çš„è¿™äº›å¯¹è±¡å‘é€<code>release</code>æ¶ˆæ¯ï¼Œä»è€Œä½¿å¯¹è±¡çš„å¼•ç”¨è®¡æ•°-1ï¼›å½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œå¯¹è±¡çš„å†…å­˜ç©ºé—´å°±ä¼šè¢«é‡Šæ”¾ã€‚ä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«å¤šæ¬¡æ”¾å…¥åˆ°åŒä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± å†…ï¼Œå¹¶ä¸”æ¯æ¬¡æ”¾å…¥æ± å†…æ—¶éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡<code>release</code>æ–¹æ³•ã€‚</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs inform7">NSDictionary *dic = <span class="hljs-comment">[<span class="hljs-comment">[<span class="hljs-comment">[NSDictionary alloc]</span> init]</span> autorelease]</span>;<br></code></pre></td></tr></table></figure><p>è‡ªåŠ¨é‡Šæ”¾æ± åœ¨ MRC å’Œ ARC ä¸­æœ‰ä¸åŒçš„å½¢å¼å’Œä½¿ç”¨æ–¹æ³•ï¼š</p><ul><li>MRC ä¸­çš„ NSAutoreleasePool</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">NSAutoreleasePool</span> <span class="hljs-operator">*</span>pool <span class="hljs-operator">=</span> [[<span class="hljs-type">NSAutoreleasePool</span> alloc] <span class="hljs-keyword">init</span>];<br><span class="hljs-comment">// Code benefitting from a local autorelease pool.</span><br>[pool release];<br></code></pre></td></tr></table></figure><ul><li>ARC ä¸­çš„ @autoreleasepool{}</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-keyword">@autoreleasepool</span> &#123;<br>    // <span class="hljs-selector-tag">Code</span> benefitting <span class="hljs-selector-tag">from</span> <span class="hljs-selector-tag">a</span> local autorelease pool.<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ARCç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨ NSAutoreleasePool å¯¹è±¡ï¼Œè€Œè¦ä½¿ç”¨åè€…ã€‚æ ¹æ® <a href="https://developer.apple.com/documentation/foundation/nsautoreleasepool?language=objc">å¼€å‘æ–‡æ¡£</a> çš„æè¿°ï¼Œåè€…çš„æ•ˆç‡æ›´é«˜ã€‚</p><h4 id="3-poolçš„åˆ›å»º"><a href="#3-poolçš„åˆ›å»º" class="headerlink" title="3.poolçš„åˆ›å»º"></a>3.poolçš„åˆ›å»º</h4><h5 id="3-1-è‡ªåŠ¨"><a href="#3-1-è‡ªåŠ¨" class="headerlink" title="3.1.è‡ªåŠ¨"></a>3.1.è‡ªåŠ¨</h5><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç³»ç»Ÿå·²ç»ä¸ºæˆ‘ä»¬åˆ›å»ºäº†è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¹¶ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ›å»ºã€‚é‚£ä¹ˆç³»ç»Ÿæ˜¯ä»€ä¹ˆæ—¶å€™å¸®æˆ‘ä»¬åˆ›å»ºçš„è‡ªåŠ¨é‡Šæ”¾æ± å‘¢ã€‚ã€‚ã€‚ï¼Ÿè¿™å°±è¦ç»“åˆ runloop æ¥åˆ†æï¼Œä¸‹é¢è¿™æ®µå†…å®¹æ˜¯åº”ç”¨æ‰§è¡Œåˆ°didFinishLaunchingWithOptionsæ—¶ï¼Œé€šè¿‡ po [NSRunLoop currentRunLoop] æ‰“å°çš„å½“å‰runloopçš„ä¿¡æ¯ï¼š</p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs xquery">po [NSRunLoop currentRunLoop]<br>&lt;CFRunLoop <span class="hljs-number">0x600001cb0100</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;wakeup port = <span class="hljs-number">0x1f07</span>, stopped =<span class="hljs-built_in"> false</span>, ignoreWakeUps =<span class="hljs-built_in"> false</span>, <br>current mode = kCFRunLoopDefaultMode,<br>common modes = &lt;CFBasicHash <span class="hljs-number">0x600002ef2910</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">2</span>,<br>entries =&gt;<br>    <span class="hljs-number">0</span> : &lt;CFString <span class="hljs-number">0x116ab9be0</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;contents = <span class="hljs-string">&quot;UITrackingRunLoopMode&quot;</span>&#125;<br>    <span class="hljs-number">2</span> : &lt;CFString <span class="hljs-number">0x10bef8168</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;contents = <span class="hljs-string">&quot;kCFRunLoopDefaultMode&quot;</span>&#125;<br>&#125;<br>,<br>common mode items = &lt;CFBasicHash <span class="hljs-number">0x600002e81da0</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">13</span>,<br>entries =&gt;<br>    <span class="hljs-number">0</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b5e00</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x0</span>, callout = PurpleEventSignalCallback (<span class="hljs-number">0x110820188</span>)&#125;&#125;<br>    <span class="hljs-number">1</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b0540</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x6000015b5080</span>, callout = __handleEventQueue (<span class="hljs-number">0x116270912</span>)&#125;&#125;<br>    <span class="hljs-number">2</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b1f80</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = Yes, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x6000004b1680</span>, callout = FBSSerialQueueRunLoopSourceHandler (<span class="hljs-number">0x118c99f0b</span>)&#125;&#125;<br>    <span class="hljs-number">3</span> : &lt;CFRunLoopObserver <span class="hljs-number">0x6000011b0c80</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">1999000</span>, callout = _beforeCACommitHandler (<span class="hljs-number">0x1161aedfc</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x7ffe6b7018e0</span>&gt;&#125;<br>    <span class="hljs-number">4</span> : &lt;CFRunLoopObserver <span class="hljs-number">0x6000011b0be0</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;valid = Yes, activities = <span class="hljs-number">0x1</span>, repeats = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">2147483647</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="hljs-number">0x11617f1b1</span>), <span class="hljs-keyword">context</span> = &lt;CFArray <span class="hljs-number">0x600002efc360</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable-small,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>, values = (<br>    <span class="hljs-number">0</span> : <span class="language-xml">&lt;0x7ffe6c009058&gt;</span><br><span class="language-xml">)&#125;&#125;</span><br><span class="language-xml">    5 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0b40</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2001000</span>, callout = _afterCACommitHandler (<span class="hljs-number">0x1161aee75</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x7ffe6b7018e0</span>&gt;&#125;</span><span class="language-xml"></span><br><span class="language-xml">    6 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0aa0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2147483647</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="hljs-number">0x11617f1b1</span>), <span class="hljs-keyword">context</span> = &lt;CFArray <span class="hljs-number">0x600002efc360</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable-small,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>, values = (</span><br><span class="language-xquery">    <span class="hljs-number">0</span> : <span class="language-xml">&lt;0x7ffe6c009058&gt;</span></span><br><span class="language-xml"><span class="language-xquery">)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    7 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0cc0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">1</span>, info = <span class="hljs-number">0x2f03</span>, callout = PurpleEventCallback (<span class="hljs-number">0x110820194</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    13 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0e40</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource MIG Server&gt; &#123;port = <span class="hljs-number">13583</span>, subsystem = <span class="hljs-number">0x116a53448</span>, <span class="hljs-keyword">context</span> = <span class="hljs-number">0x0</span>&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    14 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0480</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">2</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x600002e81830</span>, callout = __handleHIDEventFetcherDrain (<span class="hljs-number">0x11627091e</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    15 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b05a0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2000000</span>, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (<span class="hljs-number">0x1117046ae</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x0</span>&gt;&#125;</span></span><span class="language-xml"></span><br><span class="language-xml">    18 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b4480</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource MIG Server&gt; &#123;port = <span class="hljs-number">42499</span>, subsystem = <span class="hljs-number">0x116a654b0</span>, <span class="hljs-keyword">context</span> = <span class="hljs-number">0x6000020acb80</span>&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    21 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b4640</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0x20</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, callout = _UIGestureRecognizerUpdateObserver (<span class="hljs-number">0x115d51473</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x600000bb5a40</span>&gt;&#125;</span></span><span class="language-xml"></span><br><span class="language-xml">&#125;</span><br><span class="language-xml">,</span><br><span class="language-xml">modes = <span class="hljs-tag">&lt;<span class="hljs-name">CFBasicHash</span> <span class="hljs-attr">0x600002ef2850</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">4</span>,</span></span><br><span class="language-xquery"><span class="language-xquery">entries =&gt;</span></span><br><span class="language-xquery"><span class="language-xquery">    <span class="hljs-number">2</span> : &lt;CFRunLoopMode <span class="hljs-number">0x600001bb4270</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;<span class="hljs-built_in">&#123;name</span> = UITrackingRunLoopMode, port set = <span class="hljs-number">0x5103</span>, queue = <span class="hljs-number">0x600000eb5500</span>, source = <span class="hljs-number">0x600000eb5600</span> <span class="hljs-built_in">(not</span> fired), timer port = <span class="hljs-number">0x5003</span>, </span></span><br><span class="language-xquery"><span class="language-xquery">    sources<span class="hljs-number">0</span> = &lt;CFBasicHash <span class="hljs-number">0x600002e81e30</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">4</span>,</span></span><br><span class="language-xquery"><span class="language-xquery">entries =&gt;</span></span><br><span class="language-xquery"><span class="language-xquery">    <span class="hljs-number">0</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b5e00</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x0</span>, callout = PurpleEventSignalCallback (<span class="hljs-number">0x110820188</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    4 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0540</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x6000015b5080</span>, callout = __handleEventQueue (<span class="hljs-number">0x116270912</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    5 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b1f80</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = Yes, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x6000004b1680</span>, callout = FBSSerialQueueRunLoopSourceHandler (<span class="hljs-number">0x118c99f0b</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    6 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0480</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">2</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x600002e81830</span>, callout = __handleHIDEventFetcherDrain (<span class="hljs-number">0x11627091e</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">&#125;</span><br><span class="language-xml">,</span><br><span class="language-xml">    sources1 = <span class="hljs-tag">&lt;<span class="hljs-name">CFBasicHash</span> <span class="hljs-attr">0x600002e81e60</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">3</span>,</span></span><br><span class="language-xquery"><span class="language-xquery">entries =&gt;</span></span><br><span class="language-xquery"><span class="language-xquery">    <span class="hljs-number">0</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b0e40</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource MIG Server&gt; &#123;port = <span class="hljs-number">13583</span>, subsystem = <span class="hljs-number">0x116a53448</span>, <span class="hljs-keyword">context</span> = <span class="hljs-number">0x0</span>&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    1 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b4480</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource MIG Server&gt; &#123;port = <span class="hljs-number">42499</span>, subsystem = <span class="hljs-number">0x116a654b0</span>, <span class="hljs-keyword">context</span> = <span class="hljs-number">0x6000020acb80</span>&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    2 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0cc0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">1</span>, info = <span class="hljs-number">0x2f03</span>, callout = PurpleEventCallback (<span class="hljs-number">0x110820194</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">&#125;</span><br><span class="language-xml">,</span><br><span class="language-xml">    observers = (</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0be0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0x1</span>, repeats = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">2147483647</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="hljs-number">0x11617f1b1</span>), <span class="hljs-keyword">context</span> = &lt;CFArray <span class="hljs-number">0x600002efc360</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable-small,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>, values = (\n\t<span class="hljs-number">0</span> : <span class="language-xml">&lt;0x7ffe6c009058&gt;\n)&#125;</span></span></span><span class="language-xml">&#125;&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b4640</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0x20</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, callout = _UIGestureRecognizerUpdateObserver (<span class="hljs-number">0x115d51473</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x600000bb5a40</span>&gt;&#125;</span></span><span class="language-xml">&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0c80</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">1999000</span>, callout = _beforeCACommitHandler (<span class="hljs-number">0x1161aedfc</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x7ffe6b7018e0</span>&gt;&#125;</span></span><span class="language-xml">&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b05a0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2000000</span>, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (<span class="hljs-number">0x1117046ae</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x0</span>&gt;&#125;</span></span><span class="language-xml">&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0b40</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2001000</span>, callout = _afterCACommitHandler (<span class="hljs-number">0x1161aee75</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x7ffe6b7018e0</span>&gt;&#125;</span></span><span class="language-xml">&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0aa0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2147483647</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="hljs-number">0x11617f1b1</span>), <span class="hljs-keyword">context</span> = &lt;CFArray <span class="hljs-number">0x600002efc360</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable-small,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>, values = (\n\t<span class="hljs-number">0</span> : <span class="language-xml">&lt;0x7ffe6c009058&gt;\n)&#125;</span></span></span><span class="language-xml">&#125;&quot;</span><br><span class="language-xml">),</span><br><span class="language-xml">    timers = (null),</span><br><span class="language-xml">    currently 563029792 (7903325957143) / soft deadline in: 1.84467362e+10 sec (@ -1) / hard deadline in: 1.84467362e+10 sec (@ -1)</span><br><span class="language-xml">&#125;,</span><br><span class="language-xml"></span><br><span class="language-xml">    3 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopMode</span> <span class="hljs-attr">0x600001bb4340</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery"><span class="hljs-built_in">&#123;name</span> = GSEventReceiveRunLoopMode, port set = <span class="hljs-number">0x2e03</span>, queue = <span class="hljs-number">0x600000eb5680</span>, source = <span class="hljs-number">0x600000eb5780</span> <span class="hljs-built_in">(not</span> fired), timer port = <span class="hljs-number">0x4e03</span>, </span></span><br><span class="language-xquery"><span class="language-xquery">    sources<span class="hljs-number">0</span> = &lt;CFBasicHash <span class="hljs-number">0x600002e81ef0</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>,</span></span><br><span class="language-xquery"><span class="language-xquery">entries =&gt;</span></span><br><span class="language-xquery"><span class="language-xquery">    <span class="hljs-number">0</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b5e00</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x0</span>, callout = PurpleEventSignalCallback (<span class="hljs-number">0x110820188</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">&#125;</span><br><span class="language-xml">,</span><br><span class="language-xml">    sources1 = <span class="hljs-tag">&lt;<span class="hljs-name">CFBasicHash</span> <span class="hljs-attr">0x600002e81f20</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>,</span></span><br><span class="language-xquery"><span class="language-xquery">entries =&gt;</span></span><br><span class="language-xquery"><span class="language-xquery">    <span class="hljs-number">2</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b0f00</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">1</span>, info = <span class="hljs-number">0x2f03</span>, callout = PurpleEventCallback (<span class="hljs-number">0x110820194</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">&#125;</span><br><span class="language-xml">,</span><br><span class="language-xml">    observers = (null),</span><br><span class="language-xml">    timers = (null),</span><br><span class="language-xml">    currently 563029792 (7903327601583) / soft deadline in: 1.84467362e+10 sec (@ -1) / hard deadline in: 1.84467362e+10 sec (@ -1)</span><br><span class="language-xml">&#125;,</span><br><span class="language-xml"></span><br><span class="language-xml">    4 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopMode</span> <span class="hljs-attr">0x600001bb04e0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery"><span class="hljs-built_in">&#123;name</span> = kCFRunLoopDefaultMode, port set = <span class="hljs-number">0x210b</span>, queue = <span class="hljs-number">0x600000eb1500</span>, source = <span class="hljs-number">0x600000eb1600</span> <span class="hljs-built_in">(not</span> fired), timer port = <span class="hljs-number">0x1d07</span>, </span></span><br><span class="language-xquery"><span class="language-xquery">    sources<span class="hljs-number">0</span> = &lt;CFBasicHash <span class="hljs-number">0x600002e81e90</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">4</span>,</span></span><br><span class="language-xquery"><span class="language-xquery">entries =&gt;</span></span><br><span class="language-xquery"><span class="language-xquery">    <span class="hljs-number">0</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b5e00</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x0</span>, callout = PurpleEventSignalCallback (<span class="hljs-number">0x110820188</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    4 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0540</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x6000015b5080</span>, callout = __handleEventQueue (<span class="hljs-number">0x116270912</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    5 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b1f80</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = Yes, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x6000004b1680</span>, callout = FBSSerialQueueRunLoopSourceHandler (<span class="hljs-number">0x118c99f0b</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    6 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0480</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">2</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">0</span>, info = <span class="hljs-number">0x600002e81830</span>, callout = __handleHIDEventFetcherDrain (<span class="hljs-number">0x11627091e</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">&#125;</span><br><span class="language-xml">,</span><br><span class="language-xml">    sources1 = <span class="hljs-tag">&lt;<span class="hljs-name">CFBasicHash</span> <span class="hljs-attr">0x600002e81ec0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;type = mutable set,<span class="hljs-built_in"> count</span> = <span class="hljs-number">3</span>,</span></span><br><span class="language-xquery"><span class="language-xquery">entries =&gt;</span></span><br><span class="language-xquery"><span class="language-xquery">    <span class="hljs-number">0</span> : &lt;CFRunLoopSource <span class="hljs-number">0x6000015b0e40</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource MIG Server&gt; &#123;port = <span class="hljs-number">13583</span>, subsystem = <span class="hljs-number">0x116a53448</span>, <span class="hljs-keyword">context</span> = <span class="hljs-number">0x0</span>&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    1 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b4480</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource MIG Server&gt; &#123;port = <span class="hljs-number">42499</span>, subsystem = <span class="hljs-number">0x116a654b0</span>, <span class="hljs-keyword">context</span> = <span class="hljs-number">0x6000020acb80</span>&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">    2 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopSource</span> <span class="hljs-attr">0x6000015b0cc0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;signalled = No, valid = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">1</span>, <span class="hljs-keyword">context</span> = &lt;CFRunLoopSource <span class="hljs-keyword">context</span>&gt;&#123;version = <span class="hljs-number">1</span>, info = <span class="hljs-number">0x2f03</span>, callout = PurpleEventCallback (<span class="hljs-number">0x110820194</span>)&#125;</span></span><span class="language-xml">&#125;</span><br><span class="language-xml">&#125;</span><br><span class="language-xml">,</span><br><span class="language-xml">    observers = (</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0be0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0x1</span>, repeats = Yes, <span class="hljs-keyword">order</span> = -<span class="hljs-number">2147483647</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="hljs-number">0x11617f1b1</span>), <span class="hljs-keyword">context</span> = &lt;CFArray <span class="hljs-number">0x600002efc360</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable-small,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>, values = (\n\t<span class="hljs-number">0</span> : <span class="language-xml">&lt;0x7ffe6c009058&gt;\n)&#125;</span></span></span><span class="language-xml">&#125;&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b4640</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0x20</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">0</span>, callout = _UIGestureRecognizerUpdateObserver (<span class="hljs-number">0x115d51473</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x600000bb5a40</span>&gt;&#125;</span></span><span class="language-xml">&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0c80</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">1999000</span>, callout = _beforeCACommitHandler (<span class="hljs-number">0x1161aedfc</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x7ffe6b7018e0</span>&gt;&#125;</span></span><span class="language-xml">&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b05a0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2000000</span>, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (<span class="hljs-number">0x1117046ae</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x0</span>&gt;&#125;</span></span><span class="language-xml">&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0b40</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2001000</span>, callout = _afterCACommitHandler (<span class="hljs-number">0x1161aee75</span>), <span class="hljs-keyword">context</span> = &lt;CFRunLoopObserver <span class="hljs-keyword">context</span> <span class="hljs-number">0x7ffe6b7018e0</span>&gt;&#125;</span></span><span class="language-xml">&quot;,</span><br><span class="language-xml">    &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopObserver</span> <span class="hljs-attr">0x6000011b0aa0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;valid = Yes, activities = <span class="hljs-number">0xa0</span>, repeats = Yes, <span class="hljs-keyword">order</span> = <span class="hljs-number">2147483647</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="hljs-number">0x11617f1b1</span>), <span class="hljs-keyword">context</span> = &lt;CFArray <span class="hljs-number">0x600002efc360</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;type = mutable-small,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>, values = (\n\t<span class="hljs-number">0</span> : <span class="language-xml">&lt;0x7ffe6c009058&gt;\n)&#125;</span></span></span><span class="language-xml">&#125;&quot;</span><br><span class="language-xml">),</span><br><span class="language-xml">    timers = <span class="hljs-tag">&lt;<span class="hljs-name">CFArray</span> <span class="hljs-attr">0x6000004b7360</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery">&#123;type = mutable-small,<span class="hljs-built_in"> count</span> = <span class="hljs-number">1</span>, values = (</span></span><br><span class="language-xquery"><span class="language-xquery">    <span class="hljs-number">0</span> : &lt;CFRunLoopTimer <span class="hljs-number">0x6000015b5440</span> [<span class="hljs-number">0x10bee2b68</span>]&gt;&#123;valid = Yes, firing = No, interval = <span class="hljs-number">0</span>, tolerance = <span class="hljs-number">0</span>, <span class="hljs-keyword">next</span> fire date = <span class="hljs-number">563029756</span> (-<span class="hljs-number">36.444778</span> @ <span class="hljs-number">7866885955998</span>), callout = (Delayed Perform) UIApplication _accessibilitySetUpQuickSpeak (<span class="hljs-number">0x10ac9327d</span> / <span class="hljs-number">0x115810fb9</span>) (/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/PrivateFrameworks/UIKitCore.framework/UIKitCore), <span class="hljs-keyword">context</span> = &lt;CFRunLoopTimer <span class="hljs-keyword">context</span> <span class="hljs-number">0x6000035f3a40</span>&gt;&#125;</span></span><span class="language-xml"></span><br><span class="language-xml">)&#125;,</span><br><span class="language-xml">    currently 563029792 (7903327672130) / soft deadline in: 1.8446744e+10 sec (@ 7866885955998) / hard deadline in: 1.8446744e+10 sec (@ 7866885955998)</span><br><span class="language-xml">&#125;,</span><br><span class="language-xml"></span><br><span class="language-xml">    5 : <span class="hljs-tag">&lt;<span class="hljs-name">CFRunLoopMode</span> <span class="hljs-attr">0x600001bb08f0</span> [<span class="hljs-attr">0x10bee2b68</span>]&gt;</span></span><span class="language-xquery"><span class="language-xquery"><span class="hljs-built_in">&#123;name</span> = kCFRunLoopCommonModes, port set = <span class="hljs-number">0x3e0f</span>, queue = <span class="hljs-number">0x600000ebc400</span>, source = <span class="hljs-number">0x600000ebc500</span> <span class="hljs-built_in">(not</span> fired), timer port = <span class="hljs-number">0xa803</span>, </span></span><br><span class="language-xquery"><span class="language-xquery">    sources<span class="hljs-number">0</span> = (null),</span></span><br><span class="language-xquery"><span class="language-xquery">    sources1 = (null),</span></span><br><span class="language-xquery"><span class="language-xquery">    observers = (null),</span></span><br><span class="language-xquery"><span class="language-xquery">    timers = (null),</span></span><br><span class="language-xquery"><span class="language-xquery">    currently <span class="hljs-number">563029792</span> (<span class="hljs-number">7903329641921</span>) / soft deadline in: <span class="hljs-number">1.84467362</span>e+<span class="hljs-number">10</span> sec (@ -<span class="hljs-number">1</span>) / hard deadline in: <span class="hljs-number">1.84467362</span>e+<span class="hljs-number">10</span> sec (@ -<span class="hljs-number">1</span>)</span></span><br><span class="language-xquery"><span class="language-xquery">&#125;</span></span><span class="language-xml">,</span><br><span class="language-xml">&#125;</span><br><span class="language-xml">&#125;</span><br></code></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯æ‘˜è¦ï¼Œæ˜¾ç¤ºçš„æ˜¯å¯åŠ¨åç³»ç»Ÿåœ¨ä¸»çº¿ç¨‹çš„ Runloop ä¸­è‡ªåŠ¨æ·»åŠ çš„è§‚å¯Ÿè€…ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dns">observers = (<br>    &quot;&lt;CFRunLoopObserver <span class="hljs-number">0</span>x6000011b0be0 [<span class="hljs-number">0</span>x10bee2b68]&gt;&#123;valid = Yes, activities = <span class="hljs-number">0</span>x1, repeats = Yes, order = -<span class="hljs-number">2147483647</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="hljs-number">0</span>x<span class="hljs-number">11617f1b1</span>), context = &lt;CFArray <span class="hljs-number">0</span>x600002efc360 [<span class="hljs-number">0</span>x10bee2b68]&gt;&#123;type = mutable-small, count = <span class="hljs-number">1</span>, values = (\n\t0 : &lt;<span class="hljs-number">0</span>x7ffe<span class="hljs-number">6c009058</span>&gt;\n)&#125;&#125;&quot;,<br>    &quot;&lt;CFRunLoopObserver <span class="hljs-number">0</span>x60<span class="hljs-number">00011b4640</span> [<span class="hljs-number">0</span>x10bee2b68]&gt;&#123;valid = Yes, activities = <span class="hljs-number">0</span>x20, repeats = Yes, order = <span class="hljs-number">0</span>, callout = _UIGestureRecognizerUpdateObserver (<span class="hljs-number">0x115d51473</span>), context = &lt;CFRunLoopObserver context <span class="hljs-number">0</span>x600000bb5a40&gt;&#125;&quot;,<br>    &quot;&lt;CFRunLoopObserver <span class="hljs-number">0</span>x60<span class="hljs-number">00011b0c80</span> [<span class="hljs-number">0</span>x10bee2b68]&gt;&#123;valid = Yes, activities = <span class="hljs-number">0</span>xa0, repeats = Yes, order = <span class="hljs-number">1999000</span>, callout = _beforeCACommitHandler (<span class="hljs-number">0</span>x1161aedfc), context = &lt;CFRunLoopObserver context <span class="hljs-number">0</span>x7ffe<span class="hljs-number">6b7018e0</span>&gt;&#125;&quot;,<br>    &quot;&lt;CFRunLoopObserver <span class="hljs-number">0</span>x60<span class="hljs-number">00011b05a0</span> [<span class="hljs-number">0</span>x10bee2b68]&gt;&#123;valid = Yes, activities = <span class="hljs-number">0</span>xa0, repeats = Yes, order = <span class="hljs-number">2000000</span>, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (<span class="hljs-number">0</span>x1117046ae), context = &lt;CFRunLoopObserver context <span class="hljs-number">0</span>x0&gt;&#125;&quot;,<br>    &quot;&lt;CFRunLoopObserver <span class="hljs-number">0</span>x60<span class="hljs-number">00011b0b40</span> [<span class="hljs-number">0</span>x10bee2b68]&gt;&#123;valid = Yes, activities = <span class="hljs-number">0</span>xa0, repeats = Yes, order = <span class="hljs-number">2001000</span>, callout = _afterCACommitHandler (<span class="hljs-number">0</span>x1161aee75), context = &lt;CFRunLoopObserver context <span class="hljs-number">0</span>x7ffe<span class="hljs-number">6b7018e0</span>&gt;&#125;&quot;,<br>    &quot;&lt;CFRunLoopObserver <span class="hljs-number">0</span>x6000011b0aa0 [<span class="hljs-number">0</span>x10bee2b68]&gt;&#123;valid = Yes, activities = <span class="hljs-number">0</span>xa0, repeats = Yes, order = <span class="hljs-number">2147483647</span>, callout = _wrapRunLoopWithAutoreleasePoolHandler (<span class="hljs-number">0</span>x<span class="hljs-number">11617f1b1</span>), context = &lt;CFArray <span class="hljs-number">0</span>x600002efc360 [<span class="hljs-number">0</span>x10bee2b68]&gt;&#123;type = mutable-small, count = <span class="hljs-number">1</span>, values = (\n\t0 : &lt;<span class="hljs-number">0</span>x7ffe<span class="hljs-number">6c009058</span>&gt;\n)&#125;&#125;&quot;<br>),<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ç¬¬1å’Œç¬¬6ä¸ªè§‚å¯Ÿè€…ï¼Œä¸¤è€…çš„<code>activities</code>åˆ†åˆ«æ˜¯<code>0x1</code>å’Œ<code>0xa0</code>ã€‚<code>activities</code>è¡¨ç¤ºçš„æ˜¯å½“å‰ runloop æ‰€å¤„çš„çŠ¶æ€ï¼Œä¸‹é¢æ˜¯ CFRunloop.h ä¸­å®šä¹‰çš„ activities æšä¸¾å€¼ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/* Run Loop Observer Activities */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-built_in">CF_OPTIONS</span>(<span class="hljs-built_in">CFOptionFlags</span>, <span class="hljs-built_in">CFRunLoopActivity</span>) &#123;<br>    kCFRunLoopEntry = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">0</span>),<br>    kCFRunLoopBeforeTimers = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">1</span>),<br>    kCFRunLoopBeforeSources = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">2</span>),<br>    kCFRunLoopBeforeWaiting = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">5</span>),<br>    kCFRunLoopAfterWaiting = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">6</span>),<br>    kCFRunLoopExit = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">7</span>),<br>    kCFRunLoopAllActivities = <span class="hljs-number">0x0FFFFFFF</span>U<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>activities &#x3D; 0x1ï¼Œå¯¹åº”çš„å°±æ˜¯ kCFRunLoopEntryï¼›activities &#x3D; 0xa0ï¼Œå¯¹åº”çš„å°±æ˜¯ kCFRunLoopBeforeWaiting | kCFRunLoopExitã€‚</p></blockquote><p>è§£é‡Šä¸€ä¸‹ï¼Œ<code>kCFRunLoopEntry</code>è¡¨ç¤º runloop å·²å¯åŠ¨ï¼›<code>kCFRunLoopBeforeWaiting</code>è¡¨ç¤º runloop æ²¡äº‹åšäº†å³å°†ä¼‘çœ ï¼›<code>kCFRunLoopExit</code>è¡¨ç¤º runloop å·²ç»“æŸï¼›ä»ç¬¬1å’Œç¬¬6ä¸ªè§‚å¯Ÿè€…çš„ callout æè¿°å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä»¬çš„å›è°ƒéƒ½æ˜¯_wrapRunLoopWithAutoreleasePoolHandlerï¼Œå…³äºè¿™ä¸ªå›è°ƒï¼Œç›®å‰æˆ‘å°šæœªæŸ¥åˆ°å…¶æºç ï¼Œå®ƒå…·ä½“æ€ä¹ˆå®ç°è‡ªåŠ¨é‡Šæ”¾æ± çš„åˆ›å»ºå’Œé”€æ¯æš‚ä¸èƒ½ä¸€æ¢ç©¶ç«Ÿã€‚æŒ‰ç…§ç½‘ä¸Šå„å¤§åšä¸»çš„è¯´æ³•ï¼š</p><ul><li>åœ¨è¿›å…¥runloopæ—¶ï¼ˆkCFRunLoopEntryï¼‰ï¼Œè§‚å¯Ÿè€…å›è°ƒä¸­ä¼šè°ƒç”¨ _objc_autoreleasePoolPush() åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ order æ˜¯-2147483647ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚</li><li>åœ¨runloopå³å°†ä¼‘çœ æ—¶ï¼ˆkCFRunLoopBeforeWaitingï¼‰ï¼Œè§‚å¯Ÿè€…å›è°ƒä¸­ä¼šè°ƒç”¨ _objc_autoreleasePoolPop() å’Œ _objc_autoreleasePoolPush() é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›</li><li>åœ¨runloopé€€å‡ºæ—¶ï¼ˆkCFRunLoopExitï¼‰ï¼Œè§‚å¯Ÿè€…å›è°ƒä¸­ä¼šè°ƒç”¨ _objc_autoreleasePoolPop() æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ªè§‚å¯Ÿè€…çš„ order æ˜¯ 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚</li></ul><p>è™½ç„¶_wrapRunLoopWithAutoreleasePoolHandlerçš„æºç æˆ‘æš‚æ—¶ä¸å¾—è€ŒçŸ¥ï¼Œä½†_objc_autoreleasePoolPush()å’Œ_objc_autoreleasePoolPop()çš„æºç æ˜¯å¯è¿½è¸ªçš„ï¼Œåé¢çš„5.2å°èŠ‚ä¸­ä¼šå…·ä½“è®²è§£~<br><br/></p><p><strong>å°ç»“ï¼š</strong>ç³»ç»Ÿæä¾›çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå…¶åˆ›å»ºå‘ç”Ÿåœ¨ä¸¤ä¸ªæ—¶æœºï¼šrunloopå¯åŠ¨æ—¶ å’Œ runloopå³å°†ä¼‘çœ æ—¶ã€‚</p><h5 id="3-2-æ‰‹åŠ¨"><a href="#3-2-æ‰‹åŠ¨" class="headerlink" title="3.2.æ‰‹åŠ¨"></a>3.2.æ‰‹åŠ¨</h5><p>ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯è‡ªåŠ¨é‡Šæ”¾æ± ã€‚ä½†æ˜¯ï¼Œæ ¹æ® <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmAutoreleasePools.html#//apple_ref/doc/uid/20000047-SW5">å¼€å‘æ–‡æ¡£</a> çš„æè¿°ï¼Œä»¥ä¸‹åœºæ™¯ä¸‹æˆ‘ä»¬éœ€è¦è‡ªå·±åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼š</p><ul><li>If you are writing a program that is not based on a UI framework, such as a command-line tool.</li></ul><p>å¦‚æœä½ çš„é¡¹ç›®ä¸æ˜¯åŸºäºUI frameworkçš„ï¼Œæ¯”å¦‚å‘½ä»¤è¡Œå·¥å…·ï¼Œåˆ™ä½ éœ€è¦è‡ªå·±åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><ul><li>If you write a loop that creates many temporary objects.</li></ul><blockquote><p>You may use an autorelease pool block inside the loop to dispose of those objects before the next iteration. Using an autorelease pool block in the loop helps to reduce the maximum memory footprint of the application.</p></blockquote><p>å°±æ˜¯è¯´ï¼Œå½“ä½ çš„å¾ªç¯ä½“å†…åˆ›å»ºäº†å¤§é‡çš„ä¸´æ—¶å¯¹è±¡æ—¶ï¼Œä½ éœ€è¦åœ¨å¾ªç¯ä½“å†…åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œè¿™æ ·ä¸´æ—¶å¯¹è±¡ä¼šè¢«æ ‡è®°ä¸º autorelease å¹¶åœ¨ä¸‹æ¬¡å¾ªç¯ä¹‹å‰é”€æ¯ã€‚ åœ¨å¾ªç¯ä½“å†…ä½¿ç”¨è‡ªåŠ¨é‡Šæ”¾æ± å¯ä»¥é™ä½å†…å­˜å³°å€¼ã€‚<br><br/></p><p>#ç¤ºä¾‹2ï¼šåœ¨ä¸€ä¸ªæ¨¡æ€å¼¹å‡ºçš„ç•Œé¢çš„<code>viewDidLoad</code>æ–¹æ³•ä¸­æ¨¡æ‹Ÿä¸€ä¸ªå¾ªç¯ä½“å†…å¤§é‡åˆ›å»ºä¸´æ—¶å˜é‡çš„æƒ…å†µï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) &#123;<br>        <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>            <span class="hljs-built_in">NSString</span> *string = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;ADFAFDSFNKFNASFSKJFNSFSDAFAOSJDSAFASFJDSJFIOWJFIOKALNFJASFASLKFLSAJFSLAFK&quot;</span>];<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯<strong>ä¸ä½¿ç”¨</strong>è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œåå¤å¼¹å‡ºç•Œé¢æ—¶çš„å†…å­˜å³°å€¼çŠ¶å†µå›¾ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_WithoutPool.png" alt="ä¸ä½¿ç”¨é‡Šæ”¾æ± "></p><p>è¿™æ˜¯<strong>ä½¿ç”¨</strong>è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œåå¤å¼¹å‡ºç•Œé¢æ—¶çš„å†…å­˜å³°å€¼çŠ¶å†µå›¾ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_WithPool.png" alt="ä½¿ç”¨é‡Šæ”¾æ± "></p><p>é€šè¿‡å¯¹æ¯”ï¼Œå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œä½¿ç”¨è‡ªåŠ¨é‡Šæ”¾æ± æ—¶ï¼Œå³ä½¿åˆ›å»ºäº†å¤§é‡çš„ä¸´æ—¶å¯¹è±¡ï¼Œå¯¹è±¡éƒ½èƒ½åŠæ—¶é‡Šæ”¾ï¼Œå†…å­˜çš„å³°å€¼ä¹Ÿå‡ ä¹æ²¡å˜åŒ–~</p><ul><li>If you spawn a secondary thread.</li></ul><blockquote><p>You must create your own autorelease pool block as soon as the thread begins executing; otherwise, your application will leak objects.</p></blockquote><p>å½“ä½ åˆ›å»ºäº†ä¸€ä¸ªå­çº¿ç¨‹æ—¶ï¼Œä¹Ÿéœ€è¦åœ¨çº¿ç¨‹å¯åŠ¨æ—¶ä¸»åŠ¨åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¦åˆ™ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚<br><br/></p><p>#ç¤ºä¾‹3ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;Person.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>        <span class="hljs-built_in">NSThread</span> *thread = [[[<span class="hljs-built_in">NSThread</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(onHandleThread) object:<span class="hljs-literal">nil</span>] autorelease];<br>        [thread start];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br>- (<span class="hljs-type">void</span>)onHandleThread<br>&#123;<br>    <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>        Person *person = [[[Person alloc] init] autorelease];<br>        person.name = <span class="hljs-string">@&quot;IOI&quot;</span>;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å­çº¿ç¨‹:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Person.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Person</span></span><br>-(<span class="hljs-type">void</span>)dealloc&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++PERSON IS DEALLOCED~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œå…ˆå°† Build Settings-&gt;Objective-C Automotic Reference Counting é€‰é¡¹è®¾ç½®ä¸ºNOï¼Œç¦ç”¨ARCã€‚è¿è¡Œåï¼Œè¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">+++++å­çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0x600002bf8180</span>&gt;&#123;number = <span class="hljs-number">3</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++++PERSON <span class="hljs-keyword">IS</span> DEALLOCED~<br></code></pre></td></tr></table></figure><p>å¦‚æ—¥å¿—æ‰€ç¤ºï¼ŒMRCç¯å¢ƒä¸‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºå¯¹è±¡ä¹‹åï¼Œä½¿ç”¨ autorelease pool å¹¶å°†å¯¹è±¡æ ‡è®°ä¸º autoreleaseï¼Œä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åå¯¹è±¡èƒ½æ­£å¸¸é‡Šæ”¾ã€‚ä½ ä¹Ÿå¯ä»¥è¯•ç€å°† @autorelease{ } å—å’Œ autorelease å»æ‰ï¼Œè¿è¡Œä¹‹åå¯¹è±¡ä¸ä¼šé”€æ¯ã€‚<br><br/></p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong>ï¼Œå­çº¿ç¨‹ä¸­éœ€è¦è‡ªå·±åˆ›å»ºé‡Šæ”¾æ± çš„è¯´æ³•åªé’ˆå¯¹MRCçš„ç¯å¢ƒã€‚åœ¨ARCçš„ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºæ–°çš„å¯¹è±¡åï¼Œè¯¥å¯¹è±¡æ˜¯èƒ½è‡ªåŠ¨é‡Šæ”¾çš„ã€‚å¯ä»¥å°† Build Settings-&gt;Objective-C Automotic Reference Counting é€‰é¡¹è®¾ç½®ä¸º YESï¼Œå¯ç”¨ARCï¼Œä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSThread</span> *thread = [[<span class="hljs-built_in">NSThread</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(onHandleThread) object:<span class="hljs-literal">nil</span>];<br>    [thread start];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br>- (<span class="hljs-type">void</span>)onHandleThread<br>&#123;<br>    Person *person = [[Person alloc] init];<br>    person.name = <span class="hljs-string">@&quot;IOI&quot;</span>;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å­çº¿ç¨‹:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">+++++å­çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0x600003d3f040</span>&gt;&#123;number = <span class="hljs-number">3</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++++PERSON <span class="hljs-keyword">IS</span> DEALLOCED~<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒARCç¯å¢ƒä¸‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºäº† Person çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”æ²¡æœ‰ä¸»åŠ¨åœ¨å­çº¿ç¨‹ä¸­æ·»åŠ é‡Šæ”¾æ± ï¼Œä½† person å¯¹è±¡æœ€åç¡®å®é”€æ¯äº†ã€‚<br><br/></p><p>é‚£ä¹ˆä¸ºå•¥ ARC ç¯å¢ƒä¸‹å­çº¿ç¨‹ä¸­ä¸ä½¿ç”¨è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä¸´æ—¶å¯¹è±¡ä¹Ÿèƒ½é‡Šæ”¾å‘¢ï¼ŸStackOverflow çš„ <a href="https://stackoverflow.com/questions/24952549/does-nsthread-create-autoreleasepool-automatically-now">è¿™ç¯‡å¸–å­</a> ä¸­æœ‰ä¸€ç§è§£é‡Šï¼š</p><blockquote><p>The latest version of the runtime (646, which shipped with OS X 10.10 and iOS 8) does indeed add a pool if you perform an autorelease without a pool on the current thread. The previous version of the runtime (551.1, which came with OS X 10.9 and iOS 7), also did this.</p></blockquote><p>ä» OSX 10.9 å’Œ iOS7 å¼€å§‹ï¼Œå¦‚æœæˆ‘ä»¬åœ¨çº¿ç¨‹ä¸­æ²¡æœ‰ä½¿ç”¨ autorelease poolï¼Œé‚£ä¹ˆè‹¹æœä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª pool æ¥é‡Šæ”¾å¯¹è±¡ï¼Œé¿å…äº†å†…å­˜æ³„éœ²ã€‚æˆ‘ç„äº†ä¸€çœ¼è¿™ä»½<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/MemoryMgmt/RevisionHistory.html#//apple_ref/doc/uid/20001607-CJBGIAGF">å¼€å‘æ–‡æ¡£</a>çš„æ›´æ–°æ—¥å¿—ï¼Œä¸Šæ¬¡æ›´æ–°æ—¶é—´ç«Ÿè¿˜åœç•™åœ¨ 2012-07-17ï¼ä¸‹é¢æ˜¯æœ€æ–°çš„ <a href="https://opensource.apple.com/source/objc4/objc4-723/runtime/NSObject.mm.auto.html">NSObject.mm</a> ä¸­çš„æºç ï¼š</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-built_in">id</span> autorelease(<span class="hljs-built_in">id</span> obj)<br>    &#123;<br>        <span class="hljs-keyword">assert</span>(obj);<br>        <span class="hljs-keyword">assert</span>(<span class="hljs-operator">!</span>obj<span class="hljs-operator">-&gt;</span>isTaggedPointer());<br>        <span class="hljs-built_in">id</span> <span class="hljs-operator">*</span>dest __unused <span class="hljs-operator">=</span> autoreleaseFast(obj);<br>        <span class="hljs-keyword">assert</span>(<span class="hljs-operator">!</span>dest  <span class="hljs-operator">||</span>  dest <span class="hljs-operator">==</span> EMPTY_POOL_PLACEHOLDER  <span class="hljs-operator">||</span>  <span class="hljs-operator">*</span>dest <span class="hljs-operator">==</span> obj);<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ autorelease æ–¹æ³•åº•å±‚å®ç°çš„æºç ï¼Œåœ¨å­çº¿ç¨‹ä¸­ä¸åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œç›´æ¥å°†å¯¹è±¡æ ‡è®°ä¸º autorelease æ—¶ï¼Œä¼šè°ƒç”¨ autoreleaseFast()ï¼Œå‚æ•°ä¸ºå½“å‰ autorelease å¯¹è±¡ã€‚</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sas">static inline id <span class="hljs-comment">*autoreleaseFast(id obj)</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">        AutoreleasePoolPage *page = hotPage();</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">page</span> <span class="hljs-variable">&amp;&amp;</span> !<span class="hljs-keyword">page</span>-&gt;full()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">page</span>-&gt;<span class="hljs-keyword">add</span>(obj);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">page</span>) &#123;<br>            <span class="hljs-keyword">return</span> autoreleaseFullPage(obj, <span class="hljs-keyword">page</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> autoreleaseNoPage(obj);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºæ²¡æœ‰åˆ›å»ºé‡Šæ”¾æ± ï¼Œæ‰€ä»¥ autoreleaseFast() å†…ä¼šç›´æ¥è¿›å…¥æœ€åä¸€ä¸ªåˆ¤æ–­è¯­å¥ä¸­ï¼Œæ¥ç€è°ƒç”¨ autoreleaseNoPage()ï¼Œå‚æ•°ä¸º autorelease å¯¹è±¡ã€‚</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">static</span> __attribute__((noinline))<br>    id *autoreleaseNoPage(id obj)<br>    &#123;<br>        <span class="hljs-comment">// &quot;No page&quot; could mean no pool has been pushed</span><br>        <span class="hljs-comment">// or an empty placeholder pool has been pushed and has no contents yet</span><br>        <span class="hljs-keyword">assert</span>(!hotPage());<br><br>        bool pushExtraBoundary = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">if</span> (haveEmptyPoolPlaceholder()) &#123;<br>            <span class="hljs-comment">// We are pushing a second pool over the empty placeholder pool</span><br>            <span class="hljs-comment">// or pushing the first object into the empty placeholder pool.</span><br>            <span class="hljs-comment">// Before doing that, push a pool boundary on behalf of the pool </span><br>            <span class="hljs-comment">// that is currently represented by the empty placeholder.</span><br>            pushExtraBoundary = <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(obj != POOL_BOUNDARY  &amp;&amp;  DebugMissingPools)</span> </span>&#123;<br>            <span class="hljs-comment">// We are pushing an object with no pool in place, </span><br>            <span class="hljs-comment">// and no-pool debugging was requested by environment.</span><br>            _objc_inform(<span class="hljs-string">&quot;MISSING POOLS: (%p) Object %p of class %s &quot;</span><br>                         <span class="hljs-string">&quot;autoreleased with no pool in place - &quot;</span><br>                         <span class="hljs-string">&quot;just leaking - break on &quot;</span><br>                         <span class="hljs-string">&quot;objc_autoreleaseNoPool() to debug&quot;</span>, <br>                         pthread_self(), (<span class="hljs-keyword">void</span>*)obj, object_getClassName(obj));<br>            objc_autoreleaseNoPool(obj);<br>            <span class="hljs-keyword">return</span> nil;<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(obj == POOL_BOUNDARY  &amp;&amp;  !DebugPoolAllocation)</span> </span>&#123;<br>            <span class="hljs-comment">// We are pushing a pool with no pool in place,</span><br>            <span class="hljs-comment">// and alloc-per-pool debugging was not requested.</span><br>            <span class="hljs-comment">// Install and return the empty pool placeholder.</span><br>            <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">setEmptyPoolPlaceholder</span><span class="hljs-params">()</span></span>;<br>        &#125;<br><br>        <span class="hljs-comment">// We are pushing an object or a non-placeholder&#x27;d pool.</span><br><br>        <span class="hljs-comment">// Install the first page.åˆ›å»ºpage </span><br>        AutoreleasePoolPage *page = <span class="hljs-keyword">new</span> AutoreleasePoolPage(nil);<br>        setHotPage(page); <span class="hljs-comment">//è®¾ç½®ä¸ºå½“å‰æ­£åœ¨ä½¿ç”¨çš„ pool</span><br>        <br>        <span class="hljs-comment">// Push a boundary on behalf of the previously-placeholder&#x27;d pool.</span><br>        <span class="hljs-keyword">if</span> (pushExtraBoundary) &#123;<br>            page-&gt;add(POOL_BOUNDARY);<br>        &#125;<br>        <br>        <span class="hljs-comment">// Push the requested object or pool.</span><br>        <span class="hljs-keyword">return</span> page-&gt;add(obj);<br>    &#125;<br></code></pre></td></tr></table></figure><p>è¿›å…¥å‡½æ•°åï¼Œå› ä¸ºæ²¡è®¾ç½®é‡Šæ”¾æ± ï¼Œæ‰€ä»¥ haveEmptyPoolPlaceholder() è¿”å› falseï¼›åˆå› ä¸ºä¼ è¿›æ¥çš„ obj å‚æ•°æ˜¯ autorelease å¯¹è±¡è€Œé POOL_BOUNDARY(è¾¹ç•Œå¯¹è±¡)ï¼Œæ‰€ä»¥ä¼šç›´æ¥åˆ›å»º page å¹¶å°†å…¶è®¾ç½®ä¸ºå½“å‰æ­£åœ¨ä½¿ç”¨çš„ poolï¼›éšåå°† autorelease å¯¹è±¡åŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± çš„æ ˆé¡¶ï¼›åœ¨å½“å‰çº¿ç¨‹ç»“æŸå pool ä¼šå‡ºæ ˆï¼Œå…¶ä¸­çš„ autorelease å¯¹è±¡ä¹Ÿä¼šéšä¹‹é‡Šæ”¾ã€‚<br><br/></p><p>å¯è§ï¼Œ<strong>ARCç¯å¢ƒä¸‹è‹¹æœå·²ç»æ›´æ”¹äº†å®ç°ï¼Œå­çº¿ç¨‹ä¸­ä¼šå¸®æˆ‘ä»¬åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œåªæ˜¯æ–‡æ¡£æœªæ›´æ–°</strong>ã€‚</p><h4 id="4-poolçš„é”€æ¯"><a href="#4-poolçš„é”€æ¯" class="headerlink" title="4.poolçš„é”€æ¯"></a>4.poolçš„é”€æ¯</h4><p>åœ¨ 3.1 å°èŠ‚ä¸­è®²è¿‡ï¼Œè‡ªåŠ¨é‡Šæ”¾æ± çš„é”€æ¯æ—¶æœºä¸»è¦æœ‰ä¸¤ä¸ªï¼šrunloopå³å°†è¿›å…¥ä¼‘çœ æ—¶ å’Œ runloopé€€å‡ºæ—¶~</p><ul><li>AppKit ä¸è‡ªåŠ¨é‡Šæ”¾æ± </li></ul><blockquote><p>AppKit and UIKit frameworks process each event-loop iteration (such as a mouse down event or a tap) within an autorelease pool block. Therefore you typically do not have to create an autorelease pool block yourself, or even see the code that is used to create one.</p></blockquote><p>åœ¨äº‹ä»¶å¾ªç¯(event-loop)å¼€å§‹æ—¶ï¼ŒAppKit å’Œ UIKit ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºã€‚å½“äº‹ä»¶å¾ªç¯ç»“æŸæ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾æ± ä¼šæ‰§è¡Œ drain å¹¶é”€æ¯ã€‚</p><ul><li>çº¿ç¨‹ä¸è‡ªåŠ¨é‡Šæ”¾æ± </li></ul><p>æ¯ä¸ªçº¿ç¨‹(åŒ…æ‹¬ä¸»çº¿ç¨‹)éƒ½ç»´æŠ¤ç€è‡ªå·±çš„<code>è‡ªåŠ¨é‡Šæ”¾æ± æ ˆ</code>ï¼Œæ–°åˆ›å»ºçš„ pool ä¼šè¢« push åˆ°æ ˆé¡¶ï¼Œå½“ pool é”€æ¯æ—¶å®ƒä¼š pop å‡ºæ ˆã€‚å½“å‰çº¿ç¨‹ä¸­è¢«æ ‡è®°ä¸º autorelease çš„å¯¹è±¡ä¼šè¢«åŠ å…¥åˆ°æ ˆé¡¶çš„ pool å†…ã€‚å½“çº¿ç¨‹é”€æ¯æ—¶ï¼Œä¸å½“å‰çº¿ç¨‹ç›¸å…³çš„ pool ä¹Ÿéƒ½ä¼šé€šè¿‡ drain è‡ªåŠ¨é”€æ¯ã€‚</p><h4 id="5-ç»“æ„ä¸æºç "><a href="#5-ç»“æ„ä¸æºç " class="headerlink" title="5.ç»“æ„ä¸æºç "></a>5.ç»“æ„ä¸æºç </h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown">/<span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">   Autorelease pool implementation</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">   A thread&#x27;s autorelease pool is a stack of pointers. </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">   Each pointer is either an object to release, or POOL_BOUNDARY which is </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">     an autorelease pool boundary.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">   A pool token is a pointer to the POOL_BOUNDARY for that pool. When </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">     the pool is popped, every object hotter than the sentinel is released.</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">   The stack is divided into a doubly-linked list of pages. Pages are added </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">     and deleted as necessary. </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">   Thread-local storage points to the hot page, where newly autoreleased </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">     objects are stored. </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">*</span>**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*/</span></span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ <a href="https://opensource.apple.com/source/objc4/objc4-723/runtime/NSObject.mm.auto.html">NSObject.mm</a> æºç ä¸­å¯¹ autorelease pool çš„æè¿°ã€‚å®ƒæ˜ç¡®æŒ‡å‡ºï¼š</p><ul><li>autorelease pool æ˜¯ä¸€ä¸ªä¿å­˜ç€æŒ‡é’ˆçš„æ ˆï¼Œæ­¤æ ˆç”±ä¸€ä¸ªåŒå‘çš„ pages(AutoreleasePoolPage) é“¾è¡¨ç»„æˆï¼Œé“¾è¡¨ä¼šåœ¨éœ€è¦æ—¶è¢«æ·»åŠ å’Œåˆ é™¤ï¼›</li><li>æ ˆå†…æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯è¢«æ ‡è®°ä¸º autorelease è€Œå¾… release çš„å¯¹è±¡ï¼›å¦ä¸€ç§æ˜¯è¡¨ç¤º pool è¾¹ç•Œçš„å“¨å…µå¯¹è±¡(POOL_BOUNDARY)ï¼›</li><li>å½“ pool è¢«é”€æ¯è€Œå‡ºæ ˆæ—¶ï¼Œå“¨å…µå¯¹è±¡å‰é¢çš„æ‰€æœ‰ autorelease å¯¹è±¡éƒ½ä¼šæ”¶åˆ° release æ¶ˆæ¯è€Œé‡Šæ”¾ã€‚</li></ul><h5 id="5-1-æ ˆä¸é“¾è¡¨"><a href="#5-1-æ ˆä¸é“¾è¡¨" class="headerlink" title="5.1.æ ˆä¸é“¾è¡¨"></a>5.1.æ ˆä¸é“¾è¡¨</h5><p>è¿™é‡Œæˆ‘ä»¬å…ˆè®²ä¸€ä¸‹ä¸Šé¢æåˆ°çš„é“¾è¡¨ã€‚Autorelease pool å¹¶æ²¡æœ‰å•ç‹¬çš„ç»“æ„ä½“ï¼Œå®ƒç”±è‹¥å¹²ä¸ª<code>AutoreleasePoolPage</code>ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼ç»„åˆè€Œæˆã€‚<a href="https://opensource.apple.com/source/objc4/objc4-723/runtime/NSObject.mm.auto.html">NSObject.mm</a> ä¸­æœ‰å…³äº AutoreleasePoolPage çš„å®šä¹‰ï¼Œæˆå‘˜å˜é‡éƒ¨åˆ†æ‘˜è¦å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoreleasePoolPage</span> &#123;<br>    <span class="hljs-type">magic_t</span> <span class="hljs-type">const</span> magic;<br>    id *next;<br>    <span class="hljs-type">pthread_t</span> <span class="hljs-type">const</span> thread;<br>    AutoreleasePoolPage * <span class="hljs-type">const</span> parent;<br>    AutoreleasePoolPage *child;<br>    <span class="hljs-type">uint32_t</span> <span class="hljs-type">const</span> depth;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>threadï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„ poolï¼Œçº¿ç¨‹å¯åŠ¨æ—¶åˆ›å»ºpoolï¼Œçº¿ç¨‹é”€æ¯æ—¶ drain poolï¼›</li><li>id *nextï¼Œæ¸¸æ ‡ï¼ŒæŒ‡å‘æ ˆé¡¶æœ€æ–° add è¿›æ¥çš„ autorelease å¯¹è±¡çš„ä¸‹ä¸€ä¸ªä½ç½®ã€‚</li><li>parentï¼ŒæŒ‡å‘çˆ¶ pageï¼›</li><li>childï¼ŒæŒ‡å‘å­ pageï¼›</li></ul><p>æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± çš„æ ˆï¼Œæ ˆå†…å¯èƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª<code>AutoreleasePoolPage</code>å¯¹è±¡ï¼›å½“å°†å¯¹è±¡æ ‡è®°ä¸º<code>autorelease</code>æ—¶ï¼Œæ­¤å¯¹è±¡ä¼šè¢« add åˆ°æ ˆé¡¶çš„ page å†…ï¼›å¦‚æœæ­¤ page å·²æ»¡ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ page ä½œä¸º <code>child</code>ï¼Œæ–° page çš„<code>next</code>æŒ‡é’ˆè¢«åˆå§‹åŒ–åœ¨æ ˆåº•ï¼›æ ‡è®°ä¸º autorelease çš„å¯¹è±¡ä¼šè¢« add åˆ°è¿™ä¸ªæ–°å»ºçš„ page å†…ï¼›æ–‡å­—ä¸å¦‚å›¾è¡¨ï¼Œè¿™é‡Œå€Ÿç”¨åšä¸» <a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/">Â©sunnyxx</a> çš„ä¸€å¼ å›¾èƒ½æ›´æ¸…æ™°çš„çœ‹åˆ°æ·»åŠ  autorelease å¯¹è±¡å page çš„ç»“æ„ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_add_autoreleaseObj.jpg" alt="image"></p><h5 id="5-2-poolçš„åˆ›å»º"><a href="#5-2-poolçš„åˆ›å»º" class="headerlink" title="5.2.poolçš„åˆ›å»º"></a>5.2.poolçš„åˆ›å»º</h5><p>ä¸Šé¢å¯¹ autorelease pool çš„æ ˆç»“æ„åœ¨åŸç†ä¸Šæœ‰äº†ä¸€ä¸ªç®€å•çš„æè¿°ï¼Œé‚£ä¹ˆåœ¨ä»£ç å±‚ä¸Š pool æ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„å‘¢ï¼Ÿ<br><br/></p><p>#ç¤ºä¾‹4ï¼šä½¿ç”¨ @autoreleasepool{ } æ¥<code>æ‰‹åŠ¨</code>åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * argv[])</span> </span>&#123;<br>    @autoreleasepool &#123;<br>        <span class="hljs-type">int</span> count = <span class="hljs-number">10</span>;<br>        <span class="hljs-built_in">void</span> (^ blk)(<span class="hljs-type">void</span>) = ^()&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;varable in block:%d&quot;</span>,count);<br>        &#125;;<br>        <span class="hljs-built_in">blk</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨Clangç¼–è¯‘åå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼Œè¿™é‡Œåªæˆªå–å…³é”®éƒ¨åˆ†çš„ä»£ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">extern <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-constructor">__declspec(<span class="hljs-params">dllimport</span>)</span> void<span class="hljs-operator"> * </span>objc<span class="hljs-constructor">_autoreleasePoolPush(<span class="hljs-params">void</span>)</span>;<br>extern <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-constructor">__declspec(<span class="hljs-params">dllimport</span>)</span> void objc<span class="hljs-constructor">_autoreleasePoolPop(<span class="hljs-params">void</span> <span class="hljs-operator">*</span>)</span>;<br><br><span class="hljs-keyword">struct</span> __AtAutoreleasePool &#123;<br>  <span class="hljs-constructor">__AtAutoreleasePool()</span> &#123;atautoreleasepoolobj = objc<span class="hljs-constructor">_autoreleasePoolPush()</span>;&#125;<br>  ~<span class="hljs-constructor">__AtAutoreleasePool()</span> &#123;objc<span class="hljs-constructor">_autoreleasePoolPop(<span class="hljs-params">atautoreleasepoolobj</span>)</span>;&#125;<br>  void<span class="hljs-operator"> * </span>atautoreleasepoolobj;<br>&#125;;<br><br><span class="hljs-built_in">int</span> main(<span class="hljs-built_in">int</span> argc, const <span class="hljs-built_in">char</span><span class="hljs-operator"> * </span>argv<span class="hljs-literal">[]</span>) &#123;<br>    <span class="hljs-comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; <br>        <span class="hljs-built_in">int</span> count = <span class="hljs-number">10</span>;<br>        void (* blk)(void) = ((void (*)<span class="hljs-literal">()</span>)&amp;<span class="hljs-constructor">__main_block_impl_0((<span class="hljs-params">void</span> <span class="hljs-operator">*</span>)</span>__main_block_func_0, &amp;__main_block_desc_0_DATA, count));<br>        ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);<br>    &#125;<br>    return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å£°æ˜çš„ count å’Œ block å˜é‡åŠå…¶è°ƒç”¨ï¼Œåœ¨ç¼–è¯‘åçš„ç»“æœä¸­æ˜¯è¢« {__AtAutoreleasePoolâ€¦} åŒ…è£¹ç€çš„ã€‚æ‰€ä»¥å®é™…ä¸Šï¼Œ@autoreleasepool{ } å°±æ˜¯é€šè¿‡<code>__AtAutoreleasePool</code>æ¥å®ç°çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶å®šä¹‰ä¸­åŒ…å«äº†ï¼š</p><ul><li>æ„é€ å‡½æ•°ï¼Œè´Ÿè´£poolçš„åˆ›å»ºæˆ–å…¥æ ˆï¼›</li><li>ææ„å‡½æ•°ï¼Œè´Ÿè´£poolçš„å‡ºæ ˆã€é”€æ¯ï¼›</li><li>ä¸€ä¸ªé€šè¿‡ææ„å‡½æ•°åˆ›å»ºçš„ atautoreleasepoolobj å¯¹è±¡çš„æŒ‡é’ˆã€‚</li></ul><p>æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä¸­åˆ†åˆ«è°ƒç”¨äº†<code>objc_autoreleasePoolPush()</code>å’Œ<code>objc_autoreleasePoolPop()</code>ï¼Œå…³äºè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <a href="https://opensource.apple.com/source/objc4/objc4-723/runtime/NSObject.mm.auto.html">NSObject.mm</a> æºç ä¸­è¿½è¸ªåˆ°å…¶å…·ä½“çš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">void</span> *<span class="hljs-title function_">objc_autoreleasePoolPush</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">AutoreleasePoolPage</span>::<span class="hljs-title function_">push</span>();<br>&#125;<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">objc_autoreleasePoolPop</span>(<span class="hljs-params"><span class="hljs-keyword">void</span> *ctxt</span>)<br>&#123;<br>    <span class="hljs-title class_">AutoreleasePoolPage</span>::<span class="hljs-title function_">pop</span>(ctxt);<br>&#125;<br><span class="hljs-keyword">void</span> *<span class="hljs-title function_">_objc_autoreleasePoolPush</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">objc_autoreleasePoolPush</span>();<br>&#125;<br><span class="hljs-keyword">void</span> <span class="hljs-title function_">_objc_autoreleasePoolPop</span>(<span class="hljs-params"><span class="hljs-keyword">void</span> *ctxt</span>)<br>&#123;<br>    <span class="hljs-title function_">objc_autoreleasePoolPop</span>(ctxt);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„ï¼Œ_objc_autoreleasePoolPush å’Œ_objc_autoreleasePoolPop æ­£æ˜¯åœ¨3.2å°èŠ‚çš„æœ€åæåˆ°çš„é‚£ä¸¤ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰è¯´çš„ï¼Œä¸»çº¿ç¨‹ä¼šåœ¨ Runloop<code>å¯åŠ¨</code>å’Œ<code>å³å°†ä¼‘çœ </code>æ—¶é€šè¿‡å›è°ƒå‡½æ•°ä¸­è°ƒç”¨_objc_autoreleasePoolPush()åˆ›å»º poolï¼Œåœ¨<code>å³å°†ä¼‘çœ </code>å’Œ<code>é€€å‡ºloop</code>æ—¶è°ƒç”¨_objc_autoreleasePoolPop()é‡Šæ”¾ poolã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„å†…éƒ¨ä¹Ÿåªæ˜¯è°ƒç”¨äº† objc_autoreleasePoolPush å’Œ objc_autoreleasePoolPopï¼ˆæ³¨ï¼šå‡½æ•°åçš„å¼€å¤´ä¸å¸¦ä¸‹åˆ’çº¿ï¼‰ã€‚<br><br/></p><p>å› ä¸ºæœ¬å°èŠ‚æ˜¯ä»‹ç» pool å…¥æ ˆï¼Œæ‰€ä»¥å…ˆåªè®²è§£ objc_autoreleasePoolPush å‡½æ•°ã€‚å®ƒè·Ÿ pool çš„åˆ›å»ºå’Œå…¥æ ˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ<a href="http://clang.llvm.org/docs/AutomaticReferenceCounting.html#void-objc-autoreleasepoolpush-void">Clangæ–‡æ¡£</a> ä¸­æœ‰ä¸€æ®µå…³äºæ­¤å‡½æ•°çš„æè¿°ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">void</span> *objc_autoreleasePoolPush(<span class="hljs-type">void</span>);<br>Creates a <span class="hljs-built_in">new</span> autorelease pool that <span class="hljs-keyword">is</span> enclosed <span class="hljs-keyword">by</span> the <span class="hljs-keyword">current</span> pool, makes that the <span class="hljs-keyword">current</span> pool, <span class="hljs-keyword">and</span> <span class="hljs-keyword">returns</span> an <span class="hljs-type">opaque</span> â€œhandleâ€ <span class="hljs-keyword">to</span> it.<br></code></pre></td></tr></table></figure><p>å°±æ˜¯è¯´ï¼Œæ­¤å‡½æ•°å°±æ˜¯ç”¨æ¥åˆ›å»º autorelease pool å¹¶å°†å…¶è®¾ç½®ä¸ºå½“å‰ poolï¼Œå®ƒçš„å†…éƒ¨çš„è°ƒç”¨äº†<code>AutoreleasePoolPage::push()</code>å‡½æ•°ï¼š</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-operator">*</span>push() <br>    &#123;<br>        <span class="hljs-built_in">id</span> <span class="hljs-operator">*</span>dest;<br>        <span class="hljs-keyword">if</span> (DebugPoolAllocation) &#123;<span class="hljs-comment">//è°ƒè¯•æ¨¡å¼</span><br>            <span class="hljs-comment">// Each autorelease pool starts on a new pool page.</span><br>            dest <span class="hljs-operator">=</span> autoreleaseNewPage(POOL_BOUNDARY);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            dest <span class="hljs-operator">=</span> autoreleaseFast(POOL_BOUNDARY);<br>        &#125;<br>        <span class="hljs-keyword">assert</span>(dest <span class="hljs-operator">==</span> EMPTY_POOL_PLACEHOLDER <span class="hljs-operator">||</span> <span class="hljs-operator">*</span>dest <span class="hljs-operator">==</span> POOL_BOUNDARY);<br>        <span class="hljs-keyword">return</span> dest;<br>    &#125;<br></code></pre></td></tr></table></figure><p>if è¯­å¥ç¬¬ä¸€ä¸ªæ¡ä»¶æ˜¯é’ˆå¯¹è°ƒè¯•æ¨¡å¼ï¼Œè°ƒè¯•æ¨¡å¼ä¸‹æ¯æ¬¡è‡ªåŠ¨é‡Šæ”¾æ± éƒ½ä¼šè°ƒç”¨ autoreleaseNewPage() æ–¹æ³•ï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨æ‰€ä»¥æ²¡æœ‰pageï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ pageã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">id *autorelease<span class="hljs-constructor">NewPage(<span class="hljs-params">id</span> <span class="hljs-params">obj</span>)</span><br>    &#123;<br>        AutoreleasePoolPage *page = hot<span class="hljs-constructor">Page()</span>;<br>        <span class="hljs-keyword">if</span> (page) return autorelease<span class="hljs-constructor">FullPage(<span class="hljs-params">obj</span>, <span class="hljs-params">page</span>)</span>;<br>        <span class="hljs-keyword">else</span> return autorelease<span class="hljs-constructor">NoPage(<span class="hljs-params">obj</span>)</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯è°ƒè¯•æ¨¡å¼ä¸‹çš„å®ç°ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒå®ƒï¼Œæˆ‘ä»¬åªéœ€è¦çœ‹<code>autoreleaseFast()</code>å‡½æ•°ï¼Œå…¶å‚æ•°ä¸º<code>POOL_BOUNDARY</code>(æ³¨æ„è¿™ä¸ªå‚æ•°ï¼Œåé¢è®² autorelease å¯¹è±¡å…¥æ ˆæ—¶ï¼Œä¼šæœ‰å¯¹æ¯”)ã€‚</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xl">static inline id *autoreleaseFast(id obj)<br>    &#123;<br>        AutoreleasePoolPage *<span class="hljs-built_in">page</span> = hotPage();<span class="hljs-comment">//è·å–å½“å‰ pool æ ˆä¸­æ­£åœ¨ä½¿ç”¨çš„page</span><br>        <span class="hljs-function"><span class="hljs-title">if</span> (<span class="hljs-built_in">page</span> &amp;&amp; !<span class="hljs-built_in">page</span>-&gt;</span>full()) &#123;<span class="hljs-comment">//å¦‚æœå½“å‰æœ‰pageä¸”pageæ²¡æœ‰æ»¡ï¼Œåˆ™autoreleaseå¯¹è±¡å…¥æ ˆ</span><br>            <span class="hljs-function"><span class="hljs-title">return</span> <span class="hljs-built_in">page</span>-&gt;</span>add(obj);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">page</span>) &#123;<span class="hljs-comment">//å¦‚æœæ­¤pageå·²ç»æ»¡äº†ï¼Œåˆ™æ–°å»ºä¸€ä¸ªpageå¹¶å°†æ­¤autoreleaseå¯¹è±¡å‹å…¥æ ˆ</span><br>            return autoreleaseFullPage(obj, <span class="hljs-built_in">page</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//å¦‚æœæ²¡æœ‰pageï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªç©ºçš„å ä½æ± </span><br>            return autoreleaseNoPage(obj);<br>        &#125;<br>    &#125;<br>static inline AutoreleasePoolPage *hotPage() <br>    &#123;<br>        AutoreleasePoolPage *result = (AutoreleasePoolPage *)<br>            tls_get_direct(key);<span class="hljs-comment">//é€šè¿‡çº¿ç¨‹å±€éƒ¨å­˜å‚¨(Thread Local Storage)è·å–å½“å‰æ­£åœ¨ä½¿ç”¨çš„page</span><br>        <span class="hljs-keyword">if</span> ((id *)result == EMPTY_POOL_PLACEHOLDER) return <span class="hljs-literal">nil</span>;<br>        <span class="hljs-function"><span class="hljs-title">if</span> (result) result-&gt;</span>fastcheck();<br>        return result;<br>    &#125;<br></code></pre></td></tr></table></figure><p>autoreleaseFast() å‡½æ•°ä¸­ï¼ŒhotPage()ç”¨æ¥è·å–å½“å‰ pool æ ˆå†…æ­£åœ¨ä½¿ç”¨çš„ pageï¼Œé¦–æ¬¡è°ƒç”¨<code>push()</code>æ—¶æ²¡æœ‰ pageï¼Œæ‰€ä»¥ä¼šè¿›å…¥æœ€åä¸€ä¸ªåˆ¤æ–­ï¼Œè°ƒç”¨ autoreleaseNoPage()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ª<code>ç©ºçš„å ä½æ± </code>ã€‚</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">id *autoreleaseNoPage(id obj)<br>    &#123;<br>        <span class="hljs-comment">// &quot;No page&quot; could mean no pool has been pushed</span><br>        <span class="hljs-comment">// or an empty placeholder pool has been pushed and has no contents yet</span><br>        <span class="hljs-keyword">assert</span>(!hotPage());<br><br>        bool pushExtraBoundary = <span class="hljs-keyword">false</span>;<span class="hljs-comment">//æ˜¯å¦è¦ push è¾¹ç•Œå¯¹è±¡</span><br>        <span class="hljs-keyword">if</span> (haveEmptyPoolPlaceholder()) &#123;<span class="hljs-comment">//å¦‚æœæœ‰å ä½çš„ EMPTY_POOL_PLACEHOLDERï¼Œåˆ™è®¾ç½®éœ€&quot;pushExtraBoundary=TRUE&quot;</span><br>            <span class="hljs-comment">// We are pushing a second pool over the empty placeholder pool</span><br>            <span class="hljs-comment">// or pushing the first object into the empty placeholder pool.</span><br>            <span class="hljs-comment">// Before doing that, push a pool boundary on behalf of the pool </span><br>            <span class="hljs-comment">// that is currently represented by the empty placeholder.</span><br>            pushExtraBoundary = <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(obj != POOL_BOUNDARY  &amp;&amp;  DebugMissingPools)</span> </span>&#123;<br>            <span class="hljs-comment">// We are pushing an object with no pool in place, </span><br>            <span class="hljs-comment">// and no-pool debugging was requested by environment.</span><br>            _objc_inform(<span class="hljs-string">&quot;MISSING POOLS: (%p) Object %p of class %s &quot;</span><br>                         <span class="hljs-string">&quot;autoreleased with no pool in place - &quot;</span><br>                         <span class="hljs-string">&quot;just leaking - break on &quot;</span><br>                         <span class="hljs-string">&quot;objc_autoreleaseNoPool() to debug&quot;</span>, <br>                         pthread_self(), (<span class="hljs-keyword">void</span>*)obj, object_getClassName(obj));<br>            objc_autoreleaseNoPool(obj);<br>            <span class="hljs-keyword">return</span> nil;<br>        &#125;<br>        <span class="hljs-comment">//å¦‚æœä¸æ˜¯è°ƒè¯•æ¨¡å¼ï¼Œä¸”å¯¹è±¡æ˜¯è¾¹ç•Œå¯¹è±¡ï¼Œåˆ™å»è®¾ç½®ç©ºçš„å ä½æ± ï¼Œä¹Ÿå°±æ˜¯ EMPTY_POOL_PLACEHOLDER</span><br>        <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(obj == POOL_BOUNDARY  &amp;&amp;  !DebugPoolAllocation)</span> </span>&#123;<br>            <span class="hljs-comment">// We are pushing a pool with no pool in place,</span><br>            <span class="hljs-comment">// and alloc-per-pool debugging was not requested.</span><br>            <span class="hljs-comment">// Install and return the empty pool placeholder.</span><br>            <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">setEmptyPoolPlaceholder</span><span class="hljs-params">()</span></span>;<br>        &#125;<br><br>        <span class="hljs-comment">// We are pushing an object or a non-placeholder&#x27;d pool.</span><br><br>        <span class="hljs-comment">// Install the first page.åˆ›å»ºç¬¬ä¸€ä¸ªpage</span><br>        AutoreleasePoolPage *page = <span class="hljs-keyword">new</span> AutoreleasePoolPage(nil);<br>        setHotPage(page);<span class="hljs-comment">//è®¾ç½®æœ€æ–°çš„page</span><br>        <br>        <span class="hljs-comment">// Push a boundary on behalf of the previously-placeholder&#x27;d pool.</span><br>        <span class="hljs-keyword">if</span> (pushExtraBoundary) &#123;<br>            page-&gt;add(POOL_BOUNDARY);<br>        &#125;<br>        <br>        <span class="hljs-comment">// Push the requested object or pool.</span><br>        <span class="hljs-keyword">return</span> page-&gt;add(obj);<span class="hljs-comment">//æ·»åŠ ä¸€ä¸ªå¯¹è±¡</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡è¿›å…¥æ­¤å‡½æ•°æ—¶ï¼ŒhaveEmptyPoolPlaceholder()ä¼šè¿”å› falseï¼Œæ‰€ä»¥ä¼šè¿›å…¥æœ€åä¸€ä¸ªåˆ¤æ–­ï¼Œè°ƒç”¨ setEmptyPoolPlaceholder():</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static inline id* set<span class="hljs-constructor">EmptyPoolPlaceholder()</span><br>    &#123;<br>        <span class="hljs-keyword">assert</span>(tls<span class="hljs-constructor">_get_direct(<span class="hljs-params">key</span>)</span><span class="hljs-operator"> == </span>nil);<br>        tls<span class="hljs-constructor">_set_direct(<span class="hljs-params">key</span>, (<span class="hljs-params">void</span> <span class="hljs-operator">*</span>)</span>EMPTY_POOL_PLACEHOLDER);<br>        return EMPTY_POOL_PLACEHOLDER;<br>    &#125;<br></code></pre></td></tr></table></figure><p>setEmptyPoolPlaceholder() ä¼šé€šè¿‡ TLS è¿”å›ä¸€ä¸ª EMPTY_POOL_PLACEHOLDERï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// EMPTY_POOL_PLACEHOLDER is stored in TLS when exactly one pool is </span><br><span class="hljs-comment">// pushed and it has never contained any objects. This saves memory </span><br><span class="hljs-comment">// when the top level (i.e. libdispatch) pushes and pops pools but </span><br><span class="hljs-comment">// never uses them.</span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> EMPTY_POOL_PLACEHOLDER ((id*)1)</span><br></code></pre></td></tr></table></figure><p>EMPTY_POOL_PLACEHOLDER æ˜¯ä¸€ä¸ªç©ºçš„å ä½æ± ï¼Œå®ƒå­˜å‚¨åœ¨ TLS ä¸­ï¼Œä¸åŒ…å«ä»»ä½•å¯¹è±¡ã€‚<br><br/></p><p>è‡³æ­¤ï¼Œæ‰§è¡Œ @autorelease{ }ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ push() å‡½æ•°ï¼Œæœ€ç»ˆåˆ›å»ºäº†ä¸€ä¸ªç©ºçš„å ä½æ± ~</p><h5 id="5-3-å¯¹è±¡å…¥æ ˆ"><a href="#5-3-å¯¹è±¡å…¥æ ˆ" class="headerlink" title="5.3.å¯¹è±¡å…¥æ ˆ"></a>5.3.å¯¹è±¡å…¥æ ˆ</h5><p>å¦‚æœåœ¨ @autorelease block å†…åˆ›å»ºäº†å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™äº›å¯¹è±¡å°±ä¼šè¢«è‡ªåŠ¨æ ‡è®°ä¸º autoreleaseï¼Œå¹¶åŠ å…¥åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼š</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-built_in">id</span> autorelease(<span class="hljs-built_in">id</span> obj)<br>    &#123;<br>        <span class="hljs-keyword">assert</span>(obj);<br>        <span class="hljs-keyword">assert</span>(<span class="hljs-operator">!</span>obj<span class="hljs-operator">-&gt;</span>isTaggedPointer());<br>        <span class="hljs-built_in">id</span> <span class="hljs-operator">*</span>dest __unused <span class="hljs-operator">=</span> autoreleaseFast(obj);<br>        <span class="hljs-keyword">assert</span>(<span class="hljs-operator">!</span>dest  <span class="hljs-operator">||</span>  dest <span class="hljs-operator">==</span> EMPTY_POOL_PLACEHOLDER  <span class="hljs-operator">||</span>  <span class="hljs-operator">*</span>dest <span class="hljs-operator">==</span> obj);<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br></code></pre></td></tr></table></figure><p>ä»å‡½æ•°å®ç°çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¯¹è±¡è¢«æ ‡è®°ä¸º autorelease åï¼Œä¼šè°ƒç”¨ autoreleaseFast()ã€‚ä¸Šé¢åœ¨ä»‹ç» pool çš„åˆ›å»ºæ—¶ï¼Œå·²ç»ä»‹ç»è¿‡è¿™ä¸ªå‡½æ•°ï¼Œå½“æ—¶ autoreleaseFast çš„å‚æ•°æ˜¯ä¸€ä¸ªè¾¹ç•Œå¯¹è±¡(å“¨å…µ)ï¼Œè¿™é‡Œçš„å‚æ•°åˆ™æ˜¯è¢«æ ‡è®°ä¸º autorelease çš„å¯¹è±¡æœ¬èº«ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xl">static inline id *autoreleaseFast(id obj)<br>    &#123;<br>        AutoreleasePoolPage *<span class="hljs-built_in">page</span> = hotPage();<span class="hljs-comment">//è·å–å½“å‰ pool æ ˆä¸­æ­£åœ¨ä½¿ç”¨çš„page</span><br>        <span class="hljs-function"><span class="hljs-title">if</span> (<span class="hljs-built_in">page</span> &amp;&amp; !<span class="hljs-built_in">page</span>-&gt;</span>full()) &#123;<span class="hljs-comment">//å¦‚æœå½“å‰æœ‰pageä¸”pageæ²¡æœ‰æ»¡ï¼Œåˆ™autoreleaseå¯¹è±¡å…¥æ ˆ</span><br>            <span class="hljs-function"><span class="hljs-title">return</span> <span class="hljs-built_in">page</span>-&gt;</span>add(obj);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">page</span>) &#123;<span class="hljs-comment">//å¦‚æœæ­¤pageå·²ç»æ»¡äº†ï¼Œåˆ™æ–°å»ºä¸€ä¸ªpageå¹¶å°†æ­¤autoreleaseå¯¹è±¡å‹å…¥æ ˆ</span><br>            return autoreleaseFullPage(obj, <span class="hljs-built_in">page</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//å¦‚æœæ²¡æœ‰pageï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„pageå¹¶æ’å…¥è¾¹ç•Œå¯¹è±¡</span><br>            return autoreleaseNoPage(obj);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><ul><li>è¿›å…¥å‡½æ•°ä½“ä¹‹åï¼Œä¼šå…ˆè°ƒç”¨ hotPage() è·å–å½“å‰åœ¨ç”¨çš„pageï¼Œ</li></ul><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">static</span> <span class="hljs-variable">inline</span> <span class="hljs-variable">AutoreleasePoolPage</span> *<span class="hljs-function"><span class="hljs-title">hotPage</span>() </span><br><span class="hljs-function">    &#123;</span><br><span class="hljs-function">        <span class="hljs-variable">AutoreleasePoolPage</span> *<span class="hljs-variable"><span class="hljs-class">result</span></span> = (<span class="hljs-variable">AutoreleasePoolPage</span> *)</span><br>            <span class="hljs-function"><span class="hljs-title">tls_get_direct</span>(<span class="hljs-variable">key</span>);</span><br><span class="hljs-function">        <span class="hljs-variable"><span class="hljs-keyword">if</span></span> ((<span class="hljs-variable">id</span> *)<span class="hljs-variable"><span class="hljs-class">result</span></span> == <span class="hljs-variable">EMPTY_POOL_PLACEHOLDER</span>) <span class="hljs-variable">return</span> <span class="hljs-variable"><span class="hljs-literal">nil</span></span>;</span><br><span class="hljs-function">        <span class="hljs-variable"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-class">result</span></span>) <span class="hljs-variable"><span class="hljs-class">result</span></span>-&gt;<span class="hljs-title">fastcheck</span>();</span><br><span class="hljs-function">        <span class="hljs-variable">return</span> <span class="hljs-variable"><span class="hljs-class">result</span></span>;</span><br><span class="hljs-function">    &#125;</span><br></code></pre></td></tr></table></figure><p>å½“å‰æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ autoreleaseï¼Œæ ˆä¸­è¿˜æ²¡æœ‰åˆ›å»ºå¥½çš„pageï¼Œåªåœ¨5.2 å°èŠ‚ä¸­æ‰§è¡Œ @autorelease æ—¶åˆ›å»ºäº†ä¸€ä¸ª EMPTY_POOL_PLACEHOLDER(ç©ºçš„å ä½æ± )ï¼Œæ‰€ä»¥ hotPage() ä¼šè¿”å› nilã€‚å› æ­¤ autoreleaseFast()å‡½æ•°ä¼šç»§ç»­è°ƒç”¨ autoreleaseNoPage()ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">id *autorelease<span class="hljs-constructor">NoPage(<span class="hljs-params">id</span> <span class="hljs-params">obj</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">assert</span>(!hot<span class="hljs-constructor">Page()</span>);<br><br>        <span class="hljs-built_in">bool</span> pushExtraBoundary = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (have<span class="hljs-constructor">EmptyPoolPlaceholder()</span>) &#123;<br>            pushExtraBoundary = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj != POOL_BOUNDARY<span class="hljs-operator">  &amp;&amp;  </span>DebugMissingPools) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">            ...</span><br><span class="hljs-operator">            </span>return nil;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj<span class="hljs-operator"> == </span>POOL_BOUNDARY<span class="hljs-operator">  &amp;&amp;  </span>!DebugPoolAllocation) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">            ...</span><br><span class="hljs-operator">            </span>return set<span class="hljs-constructor">EmptyPoolPlaceholder()</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Install the first page.</span><br>        AutoreleasePoolPage *page = <span class="hljs-keyword">new</span> <span class="hljs-constructor">AutoreleasePoolPage(<span class="hljs-params">nil</span>)</span>;<br>        set<span class="hljs-constructor">HotPage(<span class="hljs-params">page</span>)</span>;<br>        <br>        <span class="hljs-comment">// Push a boundary on behalf of the previously-placeholder&#x27;d pool.</span><br>        <span class="hljs-keyword">if</span> (pushExtraBoundary) &#123;<br>            page-&gt;add(POOL_BOUNDARY);<br>        &#125;<br>        <br>        <span class="hljs-comment">// Push the requested object or pool.</span><br>        return page-&gt;add(obj);<br>    &#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºä¹‹å‰åœ¨åˆ›å»ºç©ºçš„å ä½æ± æ—¶ autoreleaseNoPage()å†…è°ƒç”¨äº† setEmptyPoolPlaceholder()ï¼Œæ‰€ä»¥è¿™æ¬¡ haveEmptyPoolPlaceholder() ä¼šè¿”å› trueï¼Œè¿›å…¥ç¬¬ä¸€ä¸ªæ¡ä»¶è¯­å¥ï¼ŒpushExtraBoundary è¢«ç½®ä¸º trueï¼Œæ‰€ä»¥æœ€ååˆ›å»ºäº†ä¸€ä¸ªæ–°çš„pageï¼Œæ’å…¥äº†è¾¹ç•Œå¯¹è±¡ï¼Œautorelease å¯¹è±¡å…¥æ ˆã€‚<br><br/></p><p>å°†å¯¹è±¡å‹å…¥æ ˆæ—¶ï¼Œä¼šè°ƒç”¨ add() å‡½æ•°ï¼Œé¦–å…ˆè§£é™¤ä¿æŠ¤ï¼›éšåå°†å¯¹è±¡æ’å…¥åˆ° page ä¸­ï¼Œå¹¶é‡æ–°è®¾ç½® next æŒ‡é’ˆï¼›æœ€åè®¾ç½®ä¿æŠ¤ï¼Œè¿”å›å€¼ä¸ºå½“å‰ autorelease å¯¹è±¡ä¸‹ä¸€ä½çš„ç´¢å¼•ã€‚æºç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">id</span> *add(<span class="hljs-built_in">id</span> obj)<br>    &#123;<br>        <span class="hljs-keyword">assert</span>(!full());<br>        unprotect();<br>        <span class="hljs-built_in">id</span> *ret = <span class="hljs-built_in">next</span>;  // faster than `<span class="hljs-keyword">return</span> <span class="hljs-built_in">next</span>-<span class="hljs-number">1</span>` because of aliasing<br>        *<span class="hljs-built_in">next</span>++ = obj;//å°†å¯¹è±¡å‹åˆ°æ ˆé¡¶ï¼Œå¹¶é‡æ–°å®šä½æ ˆé¡¶<br>        protect();<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<strong>ç¬¬ä¸€ä¸ª autorelease å¯¹è±¡å®Œæˆå…¥æ ˆ~</strong><br><br/></p><p>åé¢å†æœ‰å¯¹è±¡è¢«æ ‡è®°ä¸º autorelease æ—¶ï¼Œä¾ç„¶èµ° autoreleaseFast()ï¼Œä½†è¿™æ—¶ page å·²ç»å­˜åœ¨ï¼Œå¦‚æœ page æ²¡æ»¡ï¼Œåˆ™ç›´æ¥ page-&gt;add() è®©å¯¹è±¡å…¥æ ˆï¼›å¦‚æœpageå·²æ»¡ï¼Œåˆ™è°ƒç”¨ autoreleaseFullPage()æ–°å»ºpageï¼Œå†è®©å¯¹è±¡å…¥æ ˆï¼›</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xl">static __attribute__((noinline))<br>    id *autoreleaseFullPage(id obj, AutoreleasePoolPage *<span class="hljs-built_in">page</span>)<br>    &#123;<br>        <span class="hljs-comment">// The hot page is full. </span><br>        <span class="hljs-comment">// Step to the next non-full page, adding a new page if necessary.</span><br>        <span class="hljs-comment">// Then add the object to that page.</span><br>        assert(<span class="hljs-built_in">page</span> == hotPage());<br>        <span class="hljs-comment">//åˆ¤æ–­page-&gt;childæ˜¯å¦å­˜åœ¨</span><br>        <span class="hljs-function"><span class="hljs-title">assert</span>(<span class="hljs-built_in">page</span>-&gt;</span>full()  ||  DebugPoolAllocation);<br><br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-function"><span class="hljs-title">if</span> (<span class="hljs-built_in">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">child</span>) <span class="hljs-built_in">page</span> = <span class="hljs-built_in">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">child</span>;//å­˜åœ¨<span class="hljs-built_in">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">child</span>çš„è¯å°±å°† <span class="hljs-built_in">page</span>ç½®ä¸º<span class="hljs-built_in">page</span>-&gt;</span>child<br>            <span class="hljs-keyword">else</span> <span class="hljs-built_in">page</span> = new AutoreleasePoolPage(<span class="hljs-built_in">page</span>);<span class="hljs-comment">////å¦åˆ™å°±å»åˆ›å»ºæ–°çš„page</span><br>        &#125; <span class="hljs-function"><span class="hljs-title">while</span> (<span class="hljs-built_in">page</span>-&gt;</span>full());<br><br>        setHotPage(<span class="hljs-built_in">page</span>);<br>        <span class="hljs-function"><span class="hljs-title">return</span> <span class="hljs-built_in">page</span>-&gt;</span>add(obj);<br>    &#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯æ ˆå¼ç»“æ„ï¼Œæ‰€ä»¥å…ˆå…¥æ ˆçš„å¯¹è±¡ä¼šåœ¨æ ˆåº•ï¼Œåå…¥æ ˆçš„å¯¹è±¡åˆ™ä¾æ¬¡å¾€æ ˆé¡¶çš„æ–¹å‘æ·»åŠ ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ 5.1 å°èŠ‚ä¸­çš„ç¤ºæ„å›¾ã€‚</p><h5 id="5-4-å¯¹è±¡é‡Šæ”¾"><a href="#5-4-å¯¹è±¡é‡Šæ”¾" class="headerlink" title="5.4.å¯¹è±¡é‡Šæ”¾"></a>5.4.å¯¹è±¡é‡Šæ”¾</h5><p>å½“ Runloop å³å°†è¿›å…¥ä¼‘çœ  å’Œ Runloop é€€å‡ºæ—¶ï¼Œå¦‚çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡é”€æ¯æ—¶ï¼Œautorelease pool ä¼š drain å¹¶é”€æ¯ï¼Œé”€æ¯å‰å‘å…¶ä¸­ä¿å­˜ç€çš„ autorelease å¯¹è±¡ä¾æ¬¡å‘é€ release æ¶ˆæ¯ï¼Œä»è€Œé‡Šæ”¾å¯¹è±¡ã€‚é‚£ä¹ˆè‡ªåŠ¨é‡Šæ”¾æ± çš„åº•å±‚æ˜¯å¦‚ä½•é‡Šæ”¾å¯¹è±¡çš„å‘¢ï¼Ÿ</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs xl">void objc_autoreleasePoolPop(void *ctxt)<br>&#123;<br>    AutoreleasePoolPage::pop(ctxt);<br>&#125;<br><br>static inline void pop(void *token) <br>    &#123;<br>        AutoreleasePoolPage *<span class="hljs-built_in">page</span>;<br>        id *stop;<br><br>        <span class="hljs-comment">//å¦‚æœæ˜¯ç©ºçš„å ä½æ± </span><br>        <span class="hljs-keyword">if</span> (token == (void*)EMPTY_POOL_PLACEHOLDER) &#123;<br>            <span class="hljs-comment">// Popping the top-level placeholder pool.</span><br>            <span class="hljs-keyword">if</span> (hotPage()) &#123;<br>                <span class="hljs-comment">// Pool was used. Pop its contents normally.</span><br>                <span class="hljs-comment">// Pool pages remain allocated for re-use as usual.</span><br>                <span class="hljs-function"><span class="hljs-title">pop</span>(coldPage()-&gt;</span>begin());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// Pool was never used. Clear the placeholder.</span><br>                setHotPage(<span class="hljs-literal">nil</span>);<br>            &#125;<br>            return;<br>        &#125;<br><br>        <span class="hljs-built_in">page</span> = pageForPointer(token);<br>        stop = (id *)token;<br>        <span class="hljs-keyword">if</span> (*stop != POOL_BOUNDARY) &#123;<br>            <span class="hljs-comment">//ä¸æ˜¯è¾¹ç•Œå¯¹è±¡çš„æƒ…å†µï¼Œå¦‚MRCç¯å¢ƒä¸­ï¼Œåœ¨å­çº¿ç¨‹ä¸­æ²¡ä½¿ç”¨@autoreleaseï¼Œè€Œç›´æ¥è°ƒç”¨äº†autoreleaseï¼Œè¿™æ—¶æ·»åŠ åˆ°poolçš„å¯¹è±¡å°±ä¸æ˜¯ POOL_BOUNDARY</span><br>            <span class="hljs-function"><span class="hljs-title">if</span> (stop == <span class="hljs-built_in">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">begin</span>()  &amp;&amp;  !<span class="hljs-built_in">page</span>-&gt;</span>parent) &#123;<span class="hljs-comment">//æ ˆåº•ä¸æ˜¯å“¨å…µå¯¹è±¡</span><br>                <span class="hljs-comment">// Start of coldest page may correctly not be POOL_BOUNDARY:</span><br>                <span class="hljs-comment">// 1. top-level pool is popped, leaving the cold page in place</span><br>                <span class="hljs-comment">// 2. an object is autoreleased with no pool </span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// Error. For bincompat purposes this is not </span><br>                <span class="hljs-comment">// fatal in executables built with old SDKs.</span><br>                return badPop(token);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (PrintPoolHiwat) printHiwat();<br><br>        <span class="hljs-function"><span class="hljs-title">page</span>-&gt;</span>releaseUntil(stop);<span class="hljs-comment">//ä»æ ˆé¡¶å¼€å§‹å‘æ ˆä¸­çš„å¯¹è±¡å‘é€releaseæ¶ˆæ¯ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªè¾¹ç•Œå¯¹è±¡</span><br><br>        <span class="hljs-comment">// memory: delete empty children</span><br>        <span class="hljs-function"><span class="hljs-title">if</span> (DebugPoolAllocation  &amp;&amp;  <span class="hljs-built_in">page</span>-&gt;</span>empty()) &#123;<br>            <span class="hljs-comment">// special case: delete everything during page-per-pool debugging</span><br>            A<span class="hljs-function"><span class="hljs-title">utoreleasePoolPage</span> *parent = <span class="hljs-built_in">page</span>-&gt;</span>parent;<br>            <span class="hljs-function"><span class="hljs-title">page</span>-&gt;</span>kill();<br>            setHotPage(parent);<br>        &#125; <span class="hljs-function"><span class="hljs-title">else</span> <span class="hljs-keyword">if</span> (DebugMissingPools  &amp;&amp;  <span class="hljs-built_in">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">empty</span>()  &amp;&amp;  !<span class="hljs-built_in">page</span>-&gt;</span>parent) &#123;<br>            <span class="hljs-comment">// special case: delete everything for pop(top) </span><br>            <span class="hljs-comment">// when debugging missing autorelease pools</span><br>            <span class="hljs-function"><span class="hljs-title">page</span>-&gt;</span>kill();<br>            setHotPage(<span class="hljs-literal">nil</span>);<br>        &#125; <br>        <span class="hljs-function"><span class="hljs-title">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">page</span>-&gt;</span>child) &#123;<br>            <span class="hljs-comment">// hysteresis: keep one empty child if page is more than half full</span><br>            <span class="hljs-function"><span class="hljs-title">if</span> (<span class="hljs-built_in">page</span>-&gt;</span>lessThanHalfFull()) &#123;<br>                <span class="hljs-function"><span class="hljs-title">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">child</span>-&gt;</span>kill();<br>            &#125;<br>            <span class="hljs-function"><span class="hljs-title">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">child</span>-&gt;</span>child) &#123;<br>                <span class="hljs-function"><span class="hljs-title">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">child</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">child</span>-&gt;</span>kill();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>static AutoreleasePoolPage *pageForPointer(uintptr_t p) <br>    &#123;<br>        AutoreleasePoolPage *result;<br>        uintptr_t offset = p % SIZE;<br><br>        assert(offset &gt;= sizeof(AutoreleasePoolPage));<br><br>        result = (AutoreleasePoolPage *)(p - offset);<br>        <span class="hljs-function"><span class="hljs-title">result</span>-&gt;</span>fastcheck();<br><br>        return result;<br>    &#125;<br></code></pre></td></tr></table></figure><p>objc_autoreleasePoolPop()å³ Runloop é€€å‡ºï¼Œè‡ªåŠ¨é‡Šæ”¾æ± å‡ºæ ˆæ—¶è°ƒç”¨çš„å‡½æ•°ã€‚å‡½æ•°å†…ä¼šåˆ¤æ–­å½“å‰ token æ˜¯ EMPTY_POOL_PLACEHOLDER è¿˜æ˜¯ POOL_BOUNDARY æˆ–è€… autorelease å¯¹è±¡ã€‚å¦‚æœæ˜¯ç©ºçš„å ä½æ± ï¼Œåˆ™æ¸…ç©ºå ä½æ± ï¼›å¦‚æœæ ˆåº•ä¸æ˜¯è¾¹ç•Œå¯¹è±¡ï¼Œåˆ™ç›´æ¥æŠ¥é”™ï¼›å…¶ä»–æƒ…å†µï¼Œç›´æ¥è°ƒç”¨ releaseUntil()ï¼Œé‡Šæ”¾å¯¹è±¡ã€‚</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs xl">void releaseUntil(id *stop) <br>    &#123;<br>        <span class="hljs-comment">// Not recursive: we don&#x27;t want to blow out the stack </span><br>        <span class="hljs-comment">// if a thread accumulates a stupendous amount of garbage</span><br>        <br>        <span class="hljs-function"><span class="hljs-title">while</span> (this-&gt;</span>next != stop) &#123;<br>            <span class="hljs-comment">// Restart from hotPage() every time, in case -release </span><br>            <span class="hljs-comment">// autoreleased more objects</span><br>            AutoreleasePoolPage *<span class="hljs-built_in">page</span> = hotPage();<br><br>            <span class="hljs-comment">// fixme I think this `while` can be `if`, but I can&#x27;t prove it</span><br>            <span class="hljs-function"><span class="hljs-title">while</span> (<span class="hljs-built_in">page</span>-&gt;</span>empty()) &#123;<br>                <span class="hljs-function"><span class="hljs-title">page</span> = <span class="hljs-built_in">page</span>-&gt;</span>parent;<br>                setHotPage(<span class="hljs-built_in">page</span>);<br>            &#125;<br><br>            <span class="hljs-function"><span class="hljs-title">page</span>-&gt;</span>unprotect();<br>            <span class="hljs-function"><span class="hljs-title">id</span> obj = *--<span class="hljs-built_in">page</span>-&gt;</span>next;<br>            <span class="hljs-function"><span class="hljs-title">memset</span>((void*)<span class="hljs-built_in">page</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">next</span>, SCRIBBLE, sizeof(*<span class="hljs-built_in">page</span>-&gt;</span>next));<br>            <span class="hljs-function"><span class="hljs-title">page</span>-&gt;</span>protect();<br><br>            <span class="hljs-keyword">if</span> (obj != POOL_BOUNDARY) &#123;<br>                objc_release(obj);<br>            &#125;<br>        &#125;<br><br>        setHotPage(this);<br><br>#<span class="hljs-keyword">if</span> DEBUG<br>        <span class="hljs-comment">// we expect any children to be completely empty</span><br>        <span class="hljs-function"><span class="hljs-title">for</span> (AutoreleasePoolPage *<span class="hljs-built_in">page</span> = child; <span class="hljs-built_in">page</span>; <span class="hljs-built_in">page</span> = <span class="hljs-built_in">page</span>-&gt;</span>child) &#123;<br>            <span class="hljs-function"><span class="hljs-title">assert</span>(<span class="hljs-built_in">page</span>-&gt;</span>empty());<br>        &#125;<br>#endif<br>    &#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ç« èŠ‚ä¸­è®²åˆ°ï¼Œç¬¬ä¸€æ¬¡å°†å¯¹è±¡æ ‡è®°ä¸º autorelease æ—¶ï¼Œåœ¨å¯¹è±¡å…¥æ ˆå‰ä¼šå¾€æ ˆå†…æ’å…¥ä¸€ä¸ªè¾¹ç•Œå¯¹è±¡(å“¨å…µ)ï¼Œè¿™äº›è¾¹ç•Œå¯¹è±¡å¯ä»¥è§†ä¸ºä¸€ä¸ª pool çš„å¼€å§‹ã€‚å½“ pool éœ€è¦é‡Šæ”¾å¯¹è±¡æ—¶ï¼Œä¼šä»æ ˆé¡¶å¼€å§‹ï¼Œä¾æ¬¡å‘æ ˆåº•è¾¹ç•Œå¯¹è±¡çš„æ–¹å‘æ¸…ç†æ‰è¿™ä¸­é—´çš„æ‰€æœ‰ autorelease å¯¹è±¡ï¼Œå…·ä½“æµç¨‹ä¸ºï¼š</p><ol><li>æ ¹æ®ä¼ å…¥çš„å“¨å…µå¯¹è±¡åœ°å€æ‰¾åˆ°å“¨å…µå¯¹è±¡æ‰€å¤„çš„ pageï¼›</li><li>å‘å½“å‰ page ä¸­æ™šäºå“¨å…µå¯¹è±¡æ’å…¥çš„æ‰€æœ‰ autorelease å¯¹è±¡å‘é€ -release æ¶ˆæ¯ï¼›</li><li>å›å¤´ç§»åŠ¨ next æŒ‡é’ˆåˆ°æ­£ç¡®ä½ç½®ï¼›</li><li>ä»æœ€æ–°åŠ å…¥çš„å¯¹è±¡ä¸€ç›´å‘å‰æ¸…ç†ï¼Œå¯ä»¥å‘å‰è·¨è¶Šè‹¥å¹²ä¸ªpageï¼Œç›´åˆ°å“¨å…µæ‰€åœ¨çš„pageã€‚</li></ol><p>ä»¥ä¸Šï¼Œå°±æ˜¯ MRC ä¸­æœ‰å…³ retainï¼Œreleaseï¼Œautorelease å’Œè‡ªåŠ¨é‡Šæ”¾æ± ç›¸å…³çš„åŸç†å’Œå…·ä½“çš„å®ç°ã€‚</p><h3 id="ARC"><a href="#ARC" class="headerlink" title="ARC"></a>ARC</h3><h4 id="1-ä½œç”¨"><a href="#1-ä½œç”¨" class="headerlink" title="1.ä½œç”¨"></a>1.ä½œç”¨</h4><p>ARCï¼Œè‡ªåŠ¨å¼•ç”¨è®¡æ•°æ˜¯è‹¹æœåœ¨ iOS5 ä¹‹åæ¨å‡ºçš„æ–°æŠ€æœ¯ã€‚ä½¿ç”¨ARCæ—¶ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦æ‰‹åŠ¨æ·»åŠ <code>retain</code>ã€<code>release</code>ã€<code>autorelease</code>è¿™æ ·çš„å†…å­˜ç®¡ç†ä»£ç ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘ä»£ç æ—¶è‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ ã€‚æ¯”å¦‚ç³»ç»Ÿä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ Runloop ä¸­åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼ŒARCä¸‹è‡ªåŠ¨é‡Šæ”¾æ± å†…çš„å¯¹è±¡ä¼šè¢«è‡ªåŠ¨æ ‡è®°ä¸º autoreleaseï¼Œç­‰ Runloop é€€å‡ºæ—¶çº¿ç¨‹ç»“æŸï¼Œpoolè¢«é”€æ¯ï¼Œautorelease å¯¹è±¡å°±ä¼š releaseã€‚<br><br/></p><p>ARC ä¸ä»…å‡å°‘äº†å¼€å‘è€…çš„éº»çƒ¦ï¼Œè¿˜é¿å…äº†å› ä¸ºç–å¿½è€Œå¯¼è‡´çš„å†…å­˜æ³„éœ²æˆ–è€…è¿‡åº¦é‡Šæ”¾ç­‰é—®é¢˜ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äºè‡ªå·±çš„ä¸šåŠ¡ã€‚</p><blockquote><p>ARC differs from tracing garbage collection in that there is no background process that deallocates the objects asynchronously at runtime.[3] Unlike garbage collection, ARC does not handle reference cycles automatically. This means that as long as there are â€œstrongâ€ references to an object, it will not be deallocated. Strong cross-references can accordingly create deadlocks and memory leaks. It is up to the developer to break cycles by using weak references.</p></blockquote><h4 id="2-ARCä¸GC"><a href="#2-ARCä¸GC" class="headerlink" title="2.ARCä¸GC"></a>2.ARCä¸GC</h4><p><code>ARC</code> <strong>!&#x3D;</strong> <code>åƒåœ¾å›æ”¶æœºåˆ¶</code>ï¼<br><br/></p><p>ARC å‘ç”Ÿåœ¨<code>ç¼–è¯‘é˜¶æ®µ</code>ï¼Œå®ƒæ˜¯LLVM 3.0 ç¼–è¯‘å™¨ä¸­çš„æ–°ç‰¹æ€§ã€‚ARC ç¯å¢ƒä¸­ï¼Œç¼–è¯‘å™¨åœ¨ä»£ç <code>ç¼–è¯‘æ—¶</code>å¸®æˆ‘ä»¬å°†å¯¹è±¡æ ‡è®°ä¸º autoreleaseã€retainã€releaseï¼Œæˆ‘ä»¬æ— é¡»å†å†™è¿™äº›å†…å­˜ç®¡ç†çš„ä»£ç ï¼Œåªéœ€è¦ç”¨<code>strong</code>æˆ–è€…<code>weak</code>è¡¨ç¤ºä½ å¯¹å¯¹è±¡çš„æ‰€æœ‰æƒï¼Œæˆ–è€…æ³¨æ„åƒå¾ªç¯å¼ºå¼•ç”¨è¿™ç§é—®é¢˜å³å¯ã€‚<br><br/></p><p>JAVAä¸­çš„åƒåœ¾å›æ”¶æœºåˆ¶åˆ™æ˜¯åœ¨<code>è¿è¡Œæ—¶</code>æ£€æŸ¥å¯¹è±¡çš„ä¾èµ–ï¼Œå¦‚æœæ²¡æœ‰æŒ‡é’ˆæŒ‡å‘æŸä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯åƒåœ¾å¯¹è±¡ï¼Œåˆ°è¾¾ä¸€å®šé‡çº§åç³»ç»Ÿå°±ä¼šè‡ªåŠ¨æ¸…é™¤è¿™äº›åƒåœ¾å¯¹è±¡ï¼Œæˆ–è€…ç”±è°ƒç”¨è€…ä¸»åŠ¨è°ƒç”¨GCæ¸…ç†~<br><br/></p><p>ä½œä¸ºå¯¹æ¯”æ¥è¯´ï¼ŒOCä¸­çš„<code>å¼•ç”¨è®¡æ•°</code>æ›´é è¿‘åƒåœ¾å›æ”¶æœºåˆ¶ä¸€äº›ï¼Œå³å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°&#x3D;0æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹è±¡çš„<code>dealloc</code>å‡½æ•°è¿›è¡Œé”€æ¯ã€‚</p><h4 id="3-å˜é‡ä¿®é¥°ç¬¦"><a href="#3-å˜é‡ä¿®é¥°ç¬¦" class="headerlink" title="3.å˜é‡ä¿®é¥°ç¬¦"></a>3.å˜é‡ä¿®é¥°ç¬¦</h4><p>ARCä¸‹çš„å››ä¸ªå˜é‡ä¿®é¥°ç¬¦ï¼š</p><ul><li>__strong</li></ul><p>å¯¹åº”å±æ€§ä¿®é¥°ç¬¦ä¸­çš„<code>strong</code>ï¼Œå¼ºå¼•ç”¨ï¼Œè¡¨ç¤ºæŒ‡é’ˆæŒ‡å‘å¹¶æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼ˆå¼•ç”¨è®¡æ•°+1ï¼‰ã€‚è¿™æ˜¯å£°æ˜å¯¹è±¡æ—¶é»˜è®¤çš„ä¿®é¥°ç¬¦ï¼Œå¦‚æœæƒ³é‡Šæ”¾å¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œåˆ™å°†æŒ‡é’ˆç½®ä¸ºnilå³å¯ã€‚ARCä¸‹å½“æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå¼ºå¼•ç”¨æŒ‡å‘å¯¹è±¡æ—¶ï¼Œå¯¹è±¡æ‰ä¼šé”€æ¯ã€‚</p><ul><li>__weak</li></ul><p>å¯¹åº”å±æ€§ä¿®é¥°ç¬¦ä¸­çš„<code>weak</code>ï¼Œå¼±å¼•ç”¨ï¼Œè¡¨ç¤ºæŒ‡å‘ä½†ä¸æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼ˆå¼•ç”¨è®¡æ•°ä¸å˜ï¼‰ã€‚__weak ä¸ä¼šå½±å“å¯¹è±¡çš„é‡Šæ”¾ï¼Œå³åªè¦æ²¡æœ‰å¼ºå¼•ç”¨æŒ‡å‘å¯¹è±¡ï¼Œå³ä½¿æœ‰Nä¸ªå¼±å¼•ç”¨æŒ‡å‘æ­¤å¯¹è±¡ï¼Œé‚£ä¹ˆå¯¹è±¡è¿˜æ˜¯ä¼šé”€æ¯ã€‚å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œ__weak æŒ‡é’ˆä¼šè¢«è‡ªåŠ¨ç½®ä¸ºnilï¼Œä¸ä¼šå¼•å‘é‡æŒ‡é’ˆé—®é¢˜ã€‚</p><ul><li>__autoreleasing</li></ul><p>ç›¸å½“äºMRCä¸­çš„ autoreleaseï¼Œå±æ€§ä¸èƒ½ä½¿ç”¨æ­¤ä¿®é¥°ç¬¦ã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">//ARC</span><br><span class="hljs-type">NSDictionary</span> <span class="hljs-operator">*</span> __autoreleasing dic <span class="hljs-operator">=</span> [[<span class="hljs-type">NSDictionary</span> alloc] <span class="hljs-keyword">init</span>];<br><span class="hljs-comment">//MRC</span><br><span class="hljs-type">NSDictionary</span> <span class="hljs-operator">*</span>dic <span class="hljs-operator">=</span> [[[<span class="hljs-type">NSDictionary</span> alloc] <span class="hljs-keyword">init</span>] autorelease];<br></code></pre></td></tr></table></figure><ul><li>__unsafe_unretained</li></ul><p>å¯¹åº”å±æ€§ä¿®é¥°ç¬¦ä¸­çš„<code>unsafe_unretained</code>ï¼Œç›¸å½“äº MRC ä¸­çš„<code>assign</code>ï¼Œåªæ˜¯å°†æŒ‡é’ˆæŒ‡å‘æŸå¯¹è±¡ï¼Œä¸æ”¹å˜å…¶å¼•ç”¨è®¡æ•°ï¼Œä¸å½±å“å…¶é‡Šæ”¾ã€‚ä¹‹æ‰€ä»¥ä»¥<code>unsafe</code>å¼€å¤´ï¼Œæ˜¯å› ä¸ºå½“æ­¤å¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼ŒåŸæŒ‡é’ˆä»ä¼šæŒ‡å‘æ­¤å¯¹è±¡æ‰€åœ¨çš„å†…å­˜åŒºåŸŸï¼Œå†æ¬¡è°ƒç”¨æ­¤æŒ‡é’ˆæ—¶ä¼šå¼•å‘é‡æŒ‡é’ˆé—®é¢˜ï¼Œä¸å®‰å…¨ã€‚<br><br/></p><p>Clang<a href="http://clang.llvm.org/docs/AutomaticReferenceCounting.html">æ–‡æ¡£</a>ä¸­æœ‰è¿™æ ·ä¸€æ®µæè¿°ï¼š</p><blockquote><p>Methods in the alloc, copy, init, mutableCopy, and new families are implicitly marked <strong>attribute</strong>((ns_returns_retained)). This may be suppressed by explicitly marking the method <strong>attribute</strong>((ns_returns_not_retained)).</p></blockquote><p>ä¸MRCä¸€æ ·ï¼Œä»¥ <code>alloc</code>ã€<code>init</code>ã€<code>copy</code>ã€<code>mutableCopy</code>ã€<code>new</code>å¼€å¤´çš„æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œä¼šè¢«éšå¼çš„æ ‡è®°ä¸º<code>ns_returns_retained</code>ï¼Œå…¶ä»–æƒ…å†µä¸‹åˆ›å»ºçš„å¯¹è±¡åˆ™ä¼šè¢«æ ‡è®°ä¸º autorelease å¹¶åŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ã€‚</p><h4 id="4-æ³¨æ„äº‹é¡¹"><a href="#4-æ³¨æ„äº‹é¡¹" class="headerlink" title="4.æ³¨æ„äº‹é¡¹"></a>4.æ³¨æ„äº‹é¡¹</h4><ul><li>ä¸èƒ½å†æ‰‹åŠ¨å‘å¯¹è±¡å‘é€retain, release, autoreleaseã€retainCountã€deallocæ¶ˆæ¯ï¼›</li><li>å¯ä»¥é‡å†™ dealloc æ–¹æ³•ï¼Œä½†ä¸èƒ½åœ¨å…¶å†…éƒ¨è°ƒç”¨[super dealloc]ï¼›</li><li>ä¸èƒ½ä½¿ç”¨ NSAutoreleasePool å¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨ @autoreleasepool{}ï¼›</li><li>å±æ€§ä¿®é¥°ç¬¦ weak ç›¸å½“äºåŸæ¥çš„ assignï¼Œstrong ç›¸å½“äºåŸæ¥çš„ retainï¼›</li><li>æ³¨æ„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼›</li></ul><p>åœ¨æ•´ä¸ª XCode ä¸­ å¼€å…³ ARCï¼Œå¯ä»¥é€šè¿‡ Build Settings -&gt; Objective-C Automotic Reference Counting é€‰é¡¹æ¥è®¾ç½®ã€‚è®¾ç½®å•ç‹¬çš„æŸä¸ªæˆ–æŸå‡ ä¸ªæ–‡ä»¶å¼€å…³ ARC æ—¶ï¼Œå¯åˆ° Build Phases -&gt; Compile Sources ä¸­åŒå‡»å¯¹åº”çš„æ–‡ä»¶ï¼Œæ·»åŠ <code>-fobjc-arc</code>æˆ–<code>-fno-objc-arc</code>å³å¯~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://en.wikipedia.org/wiki/Automatic_Reference_Counting">Â©wiki-Automatic_Reference_Counting</a></p><p>#<a href="http://clang.llvm.org/docs/AutomaticReferenceCounting.html">Â©Clang llvm-ARC</a></p><p>#<a href="https://developer.apple.com/documentation/foundation/nsautoreleasepool?language=objc">Â©Apple-NSAutoreleasePool</a></p><p>#<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmAutoreleasePools.html#//apple_ref/doc/uid/20000047-SW5">Â©Apple-Autorelease Pool Blocks</a></p><p>#<a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/">Â©sunnyxx</a></p><p>#<a href="https://www.2cto.com/kf/201804/739679.html">Â©ZCMUCZX-è‡ªåŠ¨é‡Šæ”¾æ± </a></p><p>#<a href="http://www.cnblogs.com/flyFreeZn/p/4264220.html">Â©ä¸å¿˜åˆâ€œè¾›â€-ARCæŠ€æœ¯è¦ç‚¹</a></p><p>#<a href="http://www.cocoachina.com/bbs/read.php?tid=1729516">Â©CocoaChinaè®ºå›7æ¥¼-åƒåœ¾æ”¶é›†æœºåˆ¶ä¸ARC</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å†…å­˜ç®¡ç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cellé‡ç”¨ã€å¡é¡¿ã€ç¦»å±æ¸²æŸ“</title>
    <link href="/2018/01/20/reuse_cell.html"/>
    <url>/2018/01/20/reuse_cell.html</url>
    
    <content type="html"><![CDATA[<h3 id="1ã€Cell-çš„é‡ç”¨"><a href="#1ã€Cell-çš„é‡ç”¨" class="headerlink" title="1ã€Cell çš„é‡ç”¨"></a>1ã€Cell çš„é‡ç”¨</h3><p>#ç¤ºä¾‹1ï¼šå¸¸è§ç”¨æ³•</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-built_in">UITableViewCell</span> *)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView<br>cellForRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath <br>&#123;<br>  <span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> *CellIdentifier = <span class="hljs-string">@&quot;Cell&quot;</span>;<br>  <span class="hljs-built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier];<br>  <span class="hljs-keyword">if</span> (<span class="hljs-literal">nil</span> == cell) &#123;<br>    cell = [[<span class="hljs-built_in">UITableViewCell</span> alloc] initWithStyle:<br>    <span class="hljs-built_in">UITableViewCellStyleDefault</span> <br>    reuseIdentifier:CellIdentifier];<br>  &#125;<br>  <span class="hljs-keyword">return</span> cell;<br>&#125;<br></code></pre></td></tr></table></figure><p>[tableView dequeueReusableCellWithIdentifier:CellIdentifier]; å°±æ˜¯ cell é‡ç”¨çš„æ ‡å¿—æ€§è¯­å¥ã€‚ä¸Šé¢çš„ä»£ç é€»è¾‘æ˜¯ï¼šå½“éœ€è¦æ˜¾ç¤ºä¸€ä¸ª Cell æ—¶ï¼Œç³»ç»Ÿä¼šå…ˆå»é‡ç”¨é˜Ÿåˆ—ä¸­æŸ¥è¯¢æ˜¯å¦æœ‰å¯é‡ç”¨çš„ cellï¼Œå¦‚æœæœ‰åˆ™å¤ç”¨å®ƒï¼Œå¦‚æœæ²¡æœ‰åˆ™æ–°å»ºä¸€ä¸ª cellã€‚<br><br/></p><p>#ç¤ºä¾‹2ï¼šè¯»å– UITableView çš„å±æ€§</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">+ (void)ivarList<br>&#123;<br>    unsigned <span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;<br>    Ivar *ivars = <span class="hljs-keyword">class</span><span class="hljs-constructor">_copyIvarList([UITableView <span class="hljs-params">class</span>], &amp;<span class="hljs-params">count</span>)</span>;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i&lt;count; i++)&#123;<br>        Ivar ivar = ivars<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span>;<br>        const <span class="hljs-built_in">char</span> *charName = ivar<span class="hljs-constructor">_getName(<span class="hljs-params">ivar</span>)</span>;<br>        const <span class="hljs-built_in">char</span> *charType = ivar<span class="hljs-constructor">_getTypeEncoding(<span class="hljs-params">ivar</span>)</span>;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;Name:%s,Type:%s&quot;</span>,<span class="hljs-params">charName</span>,<span class="hljs-params">charType</span>)</span>;<br>    &#125;<br>    free(ivars);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢é€šè¿‡è¿è¡Œæ—¶å‡½æ•° <code>class_copyIvarList</code> æ¥è¯»å– UITableView ä¸­æ‰€æœ‰æˆå‘˜å˜é‡ã€‚ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-built_in">Name</span>:<span class="hljs-variable">_visibleCells</span>,<span class="hljs-built_in">Type</span>:@<span class="hljs-string">&quot;NSMutableArray&quot;</span><br><span class="hljs-built_in">Name</span>:<span class="hljs-variable">_reusableTableCells</span>,<span class="hljs-built_in">Type</span>:@<span class="hljs-string">&quot;NSMutableDictionary&quot;</span><br></code></pre></td></tr></table></figure><p>ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼ŒUITableView ä¸­åŒ…æ‹¬äº†ä»¥ä¸‹ä¸¤ä¸ªå±æ€§ï¼š</p><ul><li><strong>visibleCells</strong>ï¼šï¼ˆä¿å­˜å½“å‰å±å¹•èŒƒå›´å†…æ˜¾ç¤ºçš„ cellsï¼‰</li><li><strong>reusableTableCells</strong>ï¼šï¼ˆä¿å­˜å¯é‡ç”¨çš„ cellsï¼‰</li></ul><p><strong>Cellçš„é‡ç”¨é€»è¾‘ï¼š</strong><br><br/></p><p>ï¼ˆ1ï¼‰å‡å¦‚å½“å‰å±å¹•èƒ½æ˜¾ç¤º10ä¸ª Cellï¼Œåœ¨ UITableView å¼€å§‹æ¸²æŸ“æ—¶ï¼Œç³»ç»Ÿä¼šé€šè¿‡ <code>-initWithStyle:reuseIdentifier:</code> æ–¹æ³•åˆ›å»º10ä¸ªæ–°çš„ cell ï¼ˆæ ‡å¿—ç›¸åŒï¼‰ å¹¶æ˜¾ç¤ºï¼Œè¿™äº› cell ä¼šè¢«æ”¾å…¥ <code>visibleCells</code> è¿™ä¸ªæ•°ç»„ä¸­ã€‚</p><p>ï¼ˆ2ï¼‰å‘ä¸‹æ»‘åŠ¨ TableViewï¼Œå½“ <strong>cell1</strong> å®Œå…¨ç§»å‡ºå±å¹•ï¼Œå¹¶ä¸” <strong>cell11</strong> (å®ƒä¹Ÿæ˜¯allocå‡ºæ¥çš„ï¼ŒåŸå› åŒä¸Š)å®Œå…¨æ˜¾ç¤ºå‡ºæ¥æ—¶ï¼Œ<strong>cell11</strong> ä¼šè¢«åŠ å…¥åˆ° <code>visiableCells</code>ï¼Œè€Œ <strong>cell1</strong> åˆ™è¢«ç§»å‡º <code>visiableCells</code> å¹¶åŠ å…¥åˆ° <code>reusableTableCells</code> ä¸­ã€‚</p><p>ï¼ˆ3ï¼‰æ¥ç€å‘ä¸‹æ»‘åŠ¨ TableViewï¼Œå› ä¸º <strong>cell1</strong> å·²ç»åœ¨ <code>reusableTableCells</code> ä¸­ï¼Œæ‰€ä»¥ å³å°†æ˜¾ç¤ºçš„ç¬¬12ä¸ª cell ä¼šé‡ç”¨ <strong>cell1</strong>ã€‚å› æ­¤ <strong>cell1</strong> ä¼šè¢«ç§»å‡º <code>reusableTableCells</code> å¹¶åŠ å…¥åˆ° <code>visiableCells</code> ä¸­ï¼›åŒæ—¶ <strong>cell2</strong> ç§»å‡º <code>visiableCells</code> å¹¶åŠ å…¥åˆ° <code>reusableTableCells</code> ä¸­ã€‚</p><p>ï¼ˆ4ï¼‰æ¥ä¸‹æ¥çš„é‡ç”¨ä»¥æ­¤ç±»æ¨ã€‚ã€‚</p><br/><p><strong>æ³¨æ„ï¼š</strong> cell æ˜¯é‡ç”¨çš„ï¼Œæ‰€ä»¥åœ¨é…ç½® cell æ—¶ä¸€å®šè¦é‡æ–°è®¾ç½®é‡ç”¨çš„ cellï¼Œä¸è¦é—ç•™è€çš„æ•°æ®ã€‚</p><h3 id="2ã€å¡é¡¿ä¸ç¦»å±æ¸²æŸ“"><a href="#2ã€å¡é¡¿ä¸ç¦»å±æ¸²æŸ“" class="headerlink" title="2ã€å¡é¡¿ä¸ç¦»å±æ¸²æŸ“"></a>2ã€å¡é¡¿ä¸ç¦»å±æ¸²æŸ“</h3><p>Tableview ä½¿ç”¨ä¸­å¸¸ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°ç¦»å±æ¸²æŸ“ï¼Œä¸‹é¢è¿™äº›åšå®¢é‡Œä¼šæœ‰ä¸“ä¸šçš„åˆ†æï¼Œå¤šçœ‹çœ‹ï¼Œæ”¶ç›Šé¢‡ä¸°~</p><ul><li>#<a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/">Â©ibireme-ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</a></li><li>#<a href="https://blog.csdn.net/qq_29846663/article/details/68960512">Â©äºæµ·æ˜-ç¦»å±æ¸²æŸ“</a></li></ul><p>ä»¥ä¸‹æ˜¯ä»ä¸Šé¢åšå®¢æ‘˜å½•çš„éƒ¨åˆ†å†…å®¹ï¼š</p><h4 id="2-1-å¡é¡¿çš„åŸå› "><a href="#2-1-å¡é¡¿çš„åŸå› " class="headerlink" title="2.1 å¡é¡¿çš„åŸå› "></a>2.1 å¡é¡¿çš„åŸå› </h4><p>é€šå¸¸æ¥è¯´ï¼Œè®¡ç®—æœºç³»ç»Ÿä¸­ CPUã€GPUã€æ˜¾ç¤ºå™¨æ˜¯ååŒå·¥ä½œçš„ï¼š<code>CPU</code> è´Ÿè´£è®¡ç®—æ˜¾ç¤ºçš„å†…å®¹ï¼Œå¦‚è§†å›¾çš„åˆ›å»ºã€å¸ƒå±€è®¡ç®—ã€å›¾ç‰‡è§£ç ã€æ–‡æœ¬ç»˜åˆ¶ç­‰ï¼Œå®Œæˆåæäº¤åˆ° GPUï¼›<code>GPU</code> è´Ÿè´£å¯¹ CPU æäº¤çš„å†…å®¹è¿›è¡Œå˜æ¢ã€åˆæˆã€æ¸²æŸ“ï¼Œå®Œæˆåå°†æ¸²æŸ“ç»“æœæ”¾å…¥å¸§ç¼“å†²åŒºï¼›<code>è§†é¢‘æ§åˆ¶å™¨</code>ä¼šæŒ‰ç…§ VSync ä¿¡å·é€è¡Œè¯»å–å¸§ç¼“å†²åŒºçš„æ•°æ®ï¼Œç»è¿‡å¯èƒ½çš„æ•°æ¨¡è½¬æ¢ä¼ é€’ç»™æ˜¾ç¤ºå™¨æ˜¾ç¤ºã€‚<br><br/></p><p>å¦‚æœåœ¨ä¸€ä¸ª VSync æ—¶é—´å†…ï¼ŒCPU æˆ–è€… GPU æ²¡æœ‰å®Œæˆå†…å®¹æäº¤ï¼Œåˆ™é‚£ä¸€å¸§å°±ä¼šè¢«ä¸¢å¼ƒï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æœºä¼šå†æ˜¾ç¤ºï¼Œè€Œè¿™æ—¶æ˜¾ç¤ºå±ä¼šä¿ç•™ä¹‹å‰çš„å†…å®¹ä¸å˜ã€‚è¿™å°±æ˜¯ç•Œé¢å¡é¡¿çš„åŸå› ã€‚</p><h4 id="2-2-ç¦»å±æ¸²æŸ“"><a href="#2-2-ç¦»å±æ¸²æŸ“" class="headerlink" title="2.2.ç¦»å±æ¸²æŸ“"></a>2.2.ç¦»å±æ¸²æŸ“</h4><p><strong>#ç¦»å±æ¸²æŸ“ï¼š</strong> æŒ‡çš„æ˜¯GPUåœ¨å½“å‰å±å¹•ç¼“å†²åŒºä»¥å¤–å¼€è¾Ÿä¸€ä¸ªç¼“å†²åŒºè¿›è¡Œæ¸²æŸ“æ“ä½œï¼›<br><br/></p><p><strong>#å½“å‰å±å¹•æ¸²æŸ“ï¼š</strong> æ˜¯æŒ‡GPUçš„æ¸²æŸ“æ“ä½œæ˜¯åœ¨å½“å‰ç”¨äºæ˜¾ç¤ºçš„å±å¹•ç¼“å†²åŒºè¿›è¡Œã€‚<br><br/></p><p>ç¦»å±æ¸²æŸ“å¯¹æ€§èƒ½å½±å“å¾ˆå¤§ï¼Œä¸»è¦æ˜¯å› ä¸ºç¦»å±æ¸²æŸ“ä¼šåˆ›å»ºæ–°çš„ç¼“å†²åŒºï¼Œä¸”åœ¨ç¦»å±æ¸²æŸ“çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œéœ€è¦å¤šæ¬¡åˆ‡æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚è¿™äº›æ“ä½œçš„å¼€é”€å¾ˆå¤§ï¼ˆæ¶‰åŠåˆ° OpenGL çš„ pipelines å’Œ barrier ç­‰ï¼‰ï¼Œå°¤å…¶æ˜¯å½“æœ‰å¤§é‡ç¦»å±æ¸²æŸ“çš„æƒ…å†µæ—¶ã€‚<br><br/></p><p><strong>#ä¸ºä»€ä¹ˆä¼šæœ‰ç¦»å±æ¸²æŸ“æœºåˆ¶?</strong><br><br/></p><p>æœ‰äº›æ•ˆæœè¢«è®¤ä¸ºä¸èƒ½ç›´æ¥å‘ˆç°äºå±å¹•ï¼Œè€Œéœ€è¦åœ¨åˆ«çš„åœ°æ–¹åšé¢å¤–çš„å¤„ç†é¢„åˆæˆã€‚å›¾å±‚å±æ€§çš„æ··åˆä½“æ²¡æœ‰é¢„åˆæˆä¹‹å‰ä¸èƒ½ç›´æ¥åœ¨å±å¹•ä¸­ç»˜åˆ¶ï¼Œæ‰€ä»¥å°±éœ€è¦å±å¹•å¤–æ¸²æŸ“ã€‚å±å¹•å¤–æ¸²æŸ“å¹¶ä¸æ„å‘³ç€è½¯ä»¶ç»˜åˆ¶ï¼Œä½†æ˜¯å®ƒæ„å‘³ç€å›¾å±‚å¿…é¡»åœ¨è¢«æ˜¾ç¤ºä¹‹å‰åœ¨ä¸€ä¸ªå±å¹•å¤–ä¸Šä¸‹æ–‡ä¸­è¢«æ¸²æŸ“ï¼ˆä¸è®ºCPUè¿˜æ˜¯GPUï¼‰ã€‚<br><br/></p><p><strong>#ä¼šè§¦å‘ç¦»å±æ¸²æŸ“çš„åœºæ™¯ï¼š</strong></p><ul><li>ä¸ºå›¾å±‚è®¾ç½®é®ç½©ï¼ˆlayer.maskï¼‰ï¼›</li><li>å°†å›¾å±‚çš„ layer.masksToBounds æˆ– view.clipsToBounds è®¾ç½®ä¸ºYESï¼›</li><li>å°†å›¾å±‚ layer.allowsGroupOpacity è®¾ç½®ä¸ºYES ä¸” layer.opacityå°äº1.0ï¼›</li><li>ä¸ºå›¾å±‚è®¾ç½®é˜´å½±ï¼ˆlayer.[shadowRadius\shadowOffset\shadowOpacity]ï¼‰ï¼›</li><li>ä¸ºå›¾å±‚å¼€å¯<a href="https://blog.csdn.net/bravegogo/article/details/80494455">å…‰æ …åŒ–</a>ï¼šlayer.shouldRasterize &#x3D; YESï¼›</li><li>ä¸ºå›¾å±‚è®¾ç½®åœ†è§’ layer.cornerRadiusï¼›</li><li>ä¸ºå›¾å±‚è®¾ç½®æŠ—é”¯é½¿æ€§ï¼šlayer.allowsEdgeAntialiasing &#x3D; YESï¼›</li><li>æ–‡æœ¬ï¼ˆä»»ä½•ç§ç±»ï¼ŒåŒ…æ‹¬UILabelï¼ŒCATextLayerï¼ŒCore Textç­‰ï¼‰ï¼›</li><li>ä½¿ç”¨ CGContext åœ¨ drawRect :æ–¹æ³•ä¸­ç»˜åˆ¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“ï¼ˆä½¿ç”¨CPUæ¸²æŸ“ï¼‰ã€‚</li></ul><p><strong>#ä¼˜åŒ–æ–¹æ¡ˆï¼š</strong></p><ul><li>ä½¿ç”¨ä¸­é—´é€æ˜ï¼Œå››ä¸ªè§’æœ‰èƒŒæ™¯è‰²çš„å›¾ç‰‡ä»£æ›¿åœ†è§’æ•ˆæœï¼›</li><li>ä½¿ç”¨UIBezierPathç»™CAShapeLayerç”»åœ†è§’ï¼Œå†èµ‹å€¼ç»™è§†å›¾çš„layer.maskï¼›</li><li>ä½¿ç”¨ ShadowPath æå‰å‘Šè¯‰CoreAnimationå¾…æ¸²æŸ“å›¾å±‚çš„å½¢çŠ¶(layer.shadowPath &#x3D; [UIBezierPath bezierPathWithRect:layer.bounds])ï¼›</li><li>è®¾ç½® layer.opaque &#x3D; YESï¼Œå‡å°‘å¤æ‚å›¾å±‚åˆæˆï¼›</li><li>å°½é‡ä½¿ç”¨ä¸åŒ…å«é€æ˜ï¼ˆalphaï¼‰é€šé“çš„å›¾ç‰‡èµ„æºï¼›</li><li>å°½é‡è®¾ç½® layer çš„å¤§å°å€¼ä¸ºæ•´å‹å€¼ã€‚</li><li>ä½¿ç”¨å¼‚æ­¥è¿›è¡Œ layer æ¸²æŸ“ï¼ˆå¦‚ Facebookçš„AsyncDisplayKitæ¡†æ¶ï¼‰ï¼›</li></ul><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="http://blog.csdn.net/huifeidexin_1/article/details/7678986">Â©CSDN.huifeidexin_1-cellé‡ç”¨</a></p><p>#<a href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/">Â©ibireme-ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</a></p><p>#<a href="https://blog.csdn.net/qq_29846663/article/details/68960512">Â©äºæµ·æ˜-ç¦»å±æ¸²æŸ“</a></p><p>#<a href="https://blog.csdn.net/bravegogo/article/details/80494455">Â©CSDN.bravegogo-å…‰æ …åŒ–</a></p><p>#<a href="http://texturegroup.org/docs/corner-rounding.html">Â©Texture-Corner Rounding</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æœºåˆ¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¾ªç¯å¼•ç”¨é—®é¢˜</title>
    <link href="/2018/01/14/retain_circle.html"/>
    <url>/2018/01/14/retain_circle.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1.æ¦‚å¿µ"></a>1.æ¦‚å¿µ</h3><p>å¾ªç¯å¼•ç”¨å¯ä»¥ç®€å•ç†è§£ä¸º A å¼ºå¼•ç”¨ Bï¼ŒB åˆå¼ºå¼•ç”¨äº† Aï¼ŒåŒæ–¹åŒæ—¶ä¿æŒå¯¹æ–¹çš„ä¸€ä¸ªå¼•ç”¨ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°ä¸ä¸º0ï¼Œå§‹ç»ˆæ— æ³•é‡Šæ”¾ã€‚<br><br/></p><p><strong>å½±å“ï¼Ÿ</strong><br><br/></p><p>å¯¼è‡´å¯¹è±¡æ— æ³•é‡Šæ”¾ï¼Œé€ æˆå†…å­˜æ³„éœ²ã€‚å¦‚æœæ˜¯ ViewController å†…å‡ºç°å¾ªç¯å¼•ç”¨ï¼Œåœ¨åå¤ push &amp; pop åï¼ŒViewController é‡Šæ”¾ä¸æ‰ï¼Œå¯¼è‡´å†…å­˜æ¿€å¢ï¼Œç”šè‡³å¼•å‘crashã€‚</p><h3 id="2-åœºæ™¯"><a href="#2-åœºæ™¯" class="headerlink" title="2.åœºæ™¯"></a>2.åœºæ™¯</h3><h4 id="2-1-block"><a href="#2-1-block" class="headerlink" title="2.1.block"></a>2.1.block</h4><p>ä¸‹é¢æ˜¯ä¸€æ®µå…³äº block çš„æè¿°ï¼š</p><blockquote><p>When a block is copied, it creates strong references to object variables used within the block. If you use a block within the implementation of a method:</p></blockquote><blockquote><p>If you access an instance variable by reference, a strong reference is made to self;</p></blockquote><blockquote><p>If you access an instance variable by value, a strong reference is made to the variable.</p></blockquote><p>ä½¿ç”¨<code>copy</code>ä¿®é¥°çš„ block ä¼šè¢«æ”¾åˆ°å †ä¸­ã€‚block ä¼šå¼ºå¼•ç”¨ block å—ä¸­æ•è·åˆ°çš„å¯¹è±¡ã€‚</p><ul><li>å¦‚æœåœ¨ block ä¸­è®¿é—®äº†å±æ€§ï¼Œé‚£ä¹ˆ block å°±ä¼šå¼ºå¼•ç”¨ selfã€‚</li><li>å¦‚æœåœ¨ block ä¸­è®¿é—®äº†ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œé‚£ä¹ˆ block å°±ä¼šå¼ºå¼•ç”¨è¯¥å˜é‡ã€‚</li></ul><p>block çš„å¾ªç¯å¼•ç”¨ä¸€èˆ¬è¡¨ç°ä¸ºï¼Œblock ä½œä¸ºå±æ€§è¢«ç±»çš„å®ä¾‹(self)å¼ºå¼•ç”¨ï¼Œç„¶åå®ä¾‹åœ¨blockä¸­åˆå¼•ç”¨äº†å®ä¾‹æœ¬èº«ã€‚<code>self -&gt; block -&gt; self</code>ã€‚ç¼–å†™ä»£ç æ—¶ï¼Œè¿™ç§å¾ªç¯å¼•ç”¨ç¼–è¯‘å™¨èƒ½æ•æ‰åˆ°å¹¶ç»™å‡ºæé†’ï¼šâ€œCapturing â€˜selfâ€™ strongly in this block is likely to lead to a retain cycleâ€ã€‚</p><p>æ³¨æ„ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰blockéƒ½ä¼šé€ æˆå¾ªç¯å¼•ç”¨ã€‚åªæœ‰è¢«<code>å¼ºå¼•ç”¨äº†</code>çš„ block æ‰ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨ï¼Œä¸€äº›ç³»ç»Ÿå°è£…çš„blockå°±ä¸å­˜åœ¨å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œå¦‚ï¼š</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">dispatch_async(dispatch_get_main_queue(), ^</span><span class="hljs-template-variable">&#123;</span><br><span class="hljs-template-variable">&#125;</span><span class="language-xml">);</span><br><span class="language-xml"></span><br><span class="language-xml">[UIView animateWithDuration:1 animations:^</span><span class="hljs-template-variable">&#123;</span><br><span class="hljs-template-variable">&#125;</span><span class="language-xml">];</span><br></code></pre></td></tr></table></figure><h5 id="å¾ªç¯å¼•ç”¨ç¤ºä¾‹1"><a href="#å¾ªç¯å¼•ç”¨ç¤ºä¾‹1" class="headerlink" title="#å¾ªç¯å¼•ç”¨ç¤ºä¾‹1"></a>#å¾ªç¯å¼•ç”¨ç¤ºä¾‹1</h5><p>è‡ªå®šä¹‰çš„ä¸€ä¸ª<code>Student</code>ç±»ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//.hæ–‡ä»¶</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span>(^StudentBlock)();<br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Student</span> : <span class="hljs-title">NSObject</span></span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">copy</span> , <span class="hljs-keyword">nonatomic</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">copy</span> , <span class="hljs-keyword">nonatomic</span>) StudentBlock block;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//.mæ–‡ä»¶</span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Student</span></span><br><br>- (<span class="hljs-type">void</span>)dealloc&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++%@ dealloced~&quot;</span>,[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨æŸä¸ªVCä¸­è°ƒç”¨ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xl">- (void)viewDidLoad &#123;<br>    [super viewDidLoad];<br>    Student *student = [[Student alloc] init];<br>    student.<span class="hljs-keyword">name</span> = @<span class="hljs-string">&quot;D&quot;</span>;<br>    student.<span class="hljs-keyword">block</span> = ^&#123;<br>        NSLog(@<span class="hljs-string">&quot;Hello %@ ~&quot;</span>,student.<span class="hljs-keyword">name</span>);<br>    &#125;;<br>    student.<span class="hljs-keyword">block</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤ç¤ºä¾‹ä¸­ï¼Œ<code>student</code>ä¸­æœ‰ä¸ª<code>block</code>å±æ€§ï¼Œ<code>block</code>å†…å¼ºå¼•ç”¨äº†<code>student</code>å¯¹è±¡æœ¬èº«ï¼Œè¿™å°±é€ æˆå¾ªç¯å¼•ç”¨ï¼Œå¯¼è‡´<code>student</code>æ— æ³•é‡Šæ”¾ã€‚</p><ul><li><strong>è§£å†³åŠæ³•</strong></li></ul><p>åœ¨å¯¹è±¡çš„ block å†…è®¿é—®<code>__block</code> ä¿®é¥°çš„å˜é‡ä»£æ›¿åŸå¯¹è±¡ï¼Œå¹¶åœ¨è°ƒç”¨å®Œä¹‹åå°†<code>__block</code>å˜é‡æˆ– block æœ¬èº«ç½®ä¸º<code>nil</code>ã€‚</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xl">- (void)viewDidLoad &#123;<br>    [super viewDidLoad];<br>    Student *student = [[Student alloc] init];<br>    student.<span class="hljs-keyword">name</span> = @<span class="hljs-string">&quot;D&quot;</span>;<br>    <span class="hljs-comment">//åˆ›å»º__blockä¿®é¥°çš„å˜é‡</span><br>    __<span class="hljs-keyword">block</span> Student *st = student;<br>    student.<span class="hljs-keyword">block</span> = ^&#123;<br>        NSLog(@<span class="hljs-string">&quot;Hello %@ ~&quot;</span>,st.<span class="hljs-keyword">name</span>);<span class="hljs-comment">//è®¿é—®__blockå˜é‡</span><br>        <span class="hljs-comment">//case1ï¼šç½®ä¸ºnil</span><br>        st = <span class="hljs-literal">nil</span>;<br>    &#125;;<br>    student.<span class="hljs-keyword">block</span>();<br>    <span class="hljs-comment">//case2ï¼šstudent.block = nil;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§åŠæ³•çš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼šå¦‚æœä¸è°ƒç”¨æ­¤ block æˆ–æ²¡å°†å…¶ç½®ä¸º nilï¼Œé‚£ä¹ˆ<code>st</code>å°±ä¸è¢«ç½®ä¸º nilï¼Œä¾ç„¶å¼ºå¼•ç”¨<code>student</code>ï¼Œå¾ªç¯å¼•ç”¨ä¾ç„¶å­˜åœ¨ã€‚</p><h5 id="å¾ªç¯å¼•ç”¨ç¤ºä¾‹2"><a href="#å¾ªç¯å¼•ç”¨ç¤ºä¾‹2" class="headerlink" title="#å¾ªç¯å¼•ç”¨ç¤ºä¾‹2"></a>#å¾ªç¯å¼•ç”¨ç¤ºä¾‹2</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;AppDelegate.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^aBlock)(<span class="hljs-type">void</span>);<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *aName;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//æœ‰å¾ªç¯å¼•ç”¨é—®é¢˜</span><br>    <span class="hljs-keyword">self</span>.aBlock = ^&#123;<br>        <span class="hljs-keyword">self</span>.aName = <span class="hljs-string">@&quot;THIS IS A NAME&quot;</span>;<span class="hljs-comment">//æœ‰è­¦å‘Š</span><br>    &#125;;<br>    <span class="hljs-comment">//æ— å¾ªç¯å¼•ç”¨é—®é¢˜</span><br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>        <span class="hljs-keyword">self</span>.aName = <span class="hljs-string">@&quot;THIS IS A NAME 2&quot;</span>;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ul><li><strong>è§£å†³åŠæ³•1ï¼š</strong></li></ul><p>é€šè¿‡<code>__weak</code>ä¿®é¥°ç¬¦ï¼Œå…ˆå¼±å¼•ç”¨<code>self</code>ï¼Œå†é€šè¿‡<code>__strong</code>å¼ºå¼•ç”¨<code>weakSelf</code>ï¼Œç„¶ååœ¨ block é‡Œä½¿ç”¨<code>strongSelf</code>å³å¯ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++self.rfc:%ld&quot;</span>,(<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(<span class="hljs-keyword">self</span>)));<br>    __<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++self.rfc:%ld,weakSelf.rfc:%ld&quot;</span>,(<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(<span class="hljs-keyword">self</span>)),<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(weakSelf)));<br>    <span class="hljs-keyword">self</span>.aBlock = ^&#123;<br>        __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(weakSelf) strongSelf = weakSelf;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++weakself.rfc:%ld&quot;</span>,(<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(weakSelf)));<br>        strongSelf.aName = <span class="hljs-string">@&quot;THIS IS A NAME&quot;</span>;<br>    &#125;;<br>    <span class="hljs-keyword">self</span>.aBlock();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">self</span><span class="hljs-string">.</span><span class="hljs-comment">rfc:1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">self</span><span class="hljs-string">.</span><span class="hljs-comment">rfc:1</span><span class="hljs-string">,</span><span class="hljs-comment">weakSelf</span><span class="hljs-string">.</span><span class="hljs-comment">rfc:2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">æ‰§è¡Œblock</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">weakself</span><span class="hljs-string">.</span><span class="hljs-comment">rfc:3</span><br></code></pre></td></tr></table></figure><p>åŸç†ï¼š<code>__weak</code>ä¿®é¥°çš„<code>weakSelf</code>æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œå®ƒæŒ‡å‘<code>self</code>ä½†ä¸ä¼šå¢åŠ <code>self</code>çš„å¼•ç”¨è®¡æ•°ï¼Œä»è€Œæ‰“ç ´<code>self</code>ä¸<code>block</code>ä¹‹é—´çš„å¾ªç¯å¼•ç”¨ã€‚<br><br/></p><p><strong>psï¼š</strong> è¿™é‡Œä¹‹æ‰€ä»¥å†å¼ºå¼•ç”¨ä¸€ä¸‹ weakSelfï¼Œæ˜¯å› ä¸º<code>__weak</code>ä¿®é¥°çš„å¯¹è±¡éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œéšæ—¶å¯èƒ½ä¼šè¢«ç³»ç»Ÿé‡Šæ”¾ï¼Œé€ æˆåé¢è°ƒç”¨ weakSelf æ—¶ weakSelf å¯èƒ½å·²ç»æ˜¯niläº†ã€‚<code>__strong</code>ä¿®é¥°çš„<code>strongSelf</code>æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œä¿è¯äº†<code>weakSelf</code>åœ¨ block å£°æ˜å‘¨æœŸå†…ä¸ä¼šè¢«é”€æ¯ï¼Œè€Œä¸”<code>strongSelf</code>æ˜¯ä¸€ä¸ªè‡ªåŠ¨å˜é‡ï¼Œåœ¨ block æ‰§è¡Œå®Œæ¯•åä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚</p><ul><li><strong>è§£å†³åŠæ³•2ï¼š</strong></li></ul><p>å°†åœ¨ block å†…è¦ä½¿ç”¨åˆ°çš„å¯¹è±¡ï¼ˆä¸€èˆ¬ä¸ºselfå¯¹è±¡ï¼‰ï¼Œä»¥ block å‚æ•°çš„å½¢å¼ä¼ å…¥ï¼Œblock å°±ä¸ä¼šæ•è·è¯¥å¯¹è±¡ï¼Œè€Œæ˜¯å°†å…¶ä½œä¸ºå‚æ•°ä½¿ç”¨ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸç”±ç³»ç»Ÿçš„æ ˆè‡ªåŠ¨ç®¡ç†ï¼Œä¹Ÿä¸ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-type">void</span> (^aBlock)(AppDelegate *delSelf);<span class="hljs-comment">//å°†æœ¬ç±»ä½œä¸ºå‚æ•°</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *aName;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-keyword">self</span>.aBlock = ^(AppDelegate *delSelf)&#123;<br>        delSelf.aName = <span class="hljs-string">@&quot;THIS IS A NAME&quot;</span>;<br>    &#125;;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h4 id="2-2-NSTimer"><a href="#2-2-NSTimer" class="headerlink" title="2.2.NSTimer"></a>2.2.NSTimer</h4><p>ä¸€èˆ¬æ˜¯ NSTimer è¢«ä½œä¸ºç±»çš„æˆå‘˜å˜é‡ï¼Œåœ¨æœŸæœ›ç±»é”€æ¯æ—¶ï¼ŒNSTimer å°šå¤„äº validate çŠ¶æ€ã€‚æ­¤æ—¶ä¸ç®¡ NSTimer å¯¹è±¡æ˜¯å¦è¢«ç½®ä¸ºnilï¼Œç±»éƒ½æ— æ³•æ­£å¸¸é”€æ¯ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSTimer</span> *aTimer;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    _aTimer = [<span class="hljs-built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="hljs-number">2</span> target:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(action) userInfo:<span class="hljs-literal">nil</span> repeats:<span class="hljs-literal">YES</span>];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)dealloc&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;dealloced!!!&quot;</span>);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)viewWillDisappear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewWillDisappear:animated];<br>    _aTimer = <span class="hljs-literal">nil</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)action&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;a Timer action!&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ ViewController å‡ºç°åè¿‡æ®µæ—¶é—´é€€å‡ºï¼Œdealloc ä¸ä¼šæ‰§è¡Œã€‚è¿™æ˜¯å› ä¸º NSTimer åˆ›å»ºåè¢«åŠ å…¥åˆ° NSRunloop ä¸­ï¼Œå¤±æ•ˆä¹‹å‰ä¼šä¸€ç›´æŒæœ‰ self ä½œä¸º targetã€‚éœ€è¦åœ¨åˆé€‚çš„æ—¶æœºæ‰§è¡Œ invalidate æ¥æ‰“ç ´è¿™ä¸ªå¾ªç¯å¼•ç”¨å³å¯ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)viewWillDisappear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewWillDisappear:animated];<br>    [_aTimer invalidate];<span class="hljs-comment">//æ•²é»‘æ¿ åˆ’é‡ç‚¹!!</span><br>    _aTimer = <span class="hljs-literal">nil</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-3-delegate"><a href="#2-3-delegate" class="headerlink" title="2.3.delegate"></a>2.3.delegate</h4><p>ä¸€èˆ¬æ˜¯ A ç±»ä¸­å£°æ˜äº†ä¸€ä¸ª strong çš„ delegateï¼ŒB ç±»å¼ºå¼•ç”¨ A ç±»ï¼ŒåŒæ—¶æŠŠ A ç±»çš„ delegate æŒ‡å‘ B è‡ªå·±ã€‚B -&gt; A -&gt; delegate -&gt; Bã€‚è§£å†³åŠæ³•ï¼šå£°æ˜ delegate æ—¶ï¼Œä½¿ç”¨ weak ä¿®é¥°ç¬¦ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//ClassA</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">CustomDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span><br>- (<span class="hljs-type">void</span>)onDelegateCallback;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ClassA</span> : <span class="hljs-title">NSObject</span></span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">weak</span>) <span class="hljs-type">id</span> &lt;CustomDelegate&gt; delegate;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//ClassB</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ClassB</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) ClassA *classA;<br><span class="hljs-keyword">@end</span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ClassB</span></span><br>ï¼ (<span class="hljs-type">void</span>)viewDidLoad <br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad]; <br>    <span class="hljs-keyword">self</span>.classA = [[ClassA alloc] init];<br>    <span class="hljs-keyword">self</span>.classA.delegate = <span class="hljs-keyword">self</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å†…å­˜ç®¡ç†</tag>
      
      <tag>block</tag>
      
      <tag>å¾ªç¯å¼•ç”¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é™æ€åº“ &amp; åŠ¨æ€åº“ã€.a &amp; .frameworkã€åˆ¶ä½œåº“</title>
    <link href="/2018/01/09/framework.html"/>
    <url>/2018/01/09/framework.html</url>
    
    <content type="html"><![CDATA[<h3 id="åº“ï¼Ÿ"><a href="#åº“ï¼Ÿ" class="headerlink" title="åº“ï¼Ÿ"></a>åº“ï¼Ÿ</h3><p>åº“æ˜¯ä»£ç çš„é›†åˆã€å…±äº«ä»£ç çš„ä¸€ç§æ–¹å¼ã€‚åˆ†ä¸ºï¼š</p><ul><li>å¼€æºåº“ï¼šæºä»£ç å…¬å¼€ï¼Œèƒ½çœ‹åˆ°å…·ä½“çš„å®ç°ã€‚ï¼ˆå¦‚SDã€AFï¼‰</li><li>é—­æºåº“ï¼šæºç ä¸å…¬å¼€ï¼Œæ˜¯ç»è¿‡ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œçœ‹ä¸åˆ°å…·ä½“å®ç°ã€‚</li></ul><p>å…¶ä¸­ï¼Œé—­æºåº“æœ‰ä¸¤ç§å½¢å¼ï¼š</p><ul><li>é™æ€åº“ï¼š.a å’Œ .framework</li><li>åŠ¨æ€åº“ï¼š.dylib å’Œ .framework</li></ul><p>é—®ï¼šframework ä¸ºå•¥å³æ˜¯é™æ€åº“åˆæ˜¯åŠ¨æ€åº“å‘¢ï¼Ÿ</p><p>ç­”ï¼šç³»ç»Ÿçš„.framework æ˜¯åŠ¨æ€åº“ï¼Œæˆ‘ä»¬è‡ªå·±å»ºçš„.framework æ˜¯é™æ€åº“ã€‚</p><h4 id="1ã€é™æ€åº“-ä¸-åŠ¨æ€åº“çš„åŒºåˆ«ï¼Ÿ"><a href="#1ã€é™æ€åº“-ä¸-åŠ¨æ€åº“çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="1ã€é™æ€åº“ ä¸ åŠ¨æ€åº“çš„åŒºåˆ«ï¼Ÿ"></a>1ã€é™æ€åº“ ä¸ åŠ¨æ€åº“çš„åŒºåˆ«ï¼Ÿ</h4><ul><li>é™æ€åº“åœ¨ç¼–è¯‘é˜¶æ®µä¼šæˆä¸º App å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œä¼šå¢åŠ å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ã€‚å› ä¸º App å°ºå¯¸å˜å¤§ï¼Œå¯åŠ¨æ—¶éœ€è¦åŠ è½½çš„å†…å®¹å˜å¤šï¼Œæ‰€ä»¥å¯èƒ½å¯¼è‡´ App å¯åŠ¨å˜æ…¢ã€‚åŠ¨æ€åº“åˆ™â€œæ™ºèƒ½â€ä¸€äº›ï¼Œå®ƒä¸ä¼šæ”¹å˜å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ï¼Œåªæœ‰ App éœ€è¦ç”¨åˆ°è¿™ä¸ª dylib æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šæŠŠå®ƒåŠ è½½è¿›å†…å­˜ï¼Œæˆä¸ºè¿›ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚</li><li>é™æ€åº“åœ¨è¿æ¥æ—¶ä¼šè¢«å®Œæ•´çš„å¤åˆ¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œè¢«å¤šæ¬¡ä½¿ç”¨å°±æœ‰å¤šä»½å†—ä½™æ‹·è´ã€‚åŠ¨æ€åº“åˆ™ä¸å¤åˆ¶ï¼Œç”±ç³»ç»ŸåŠ¨æ€åŠ è½½ä¸”åªåŠ è½½ä¸€æ¬¡åˆ°å†…å­˜ï¼Œå¯ä¾›å¤šä¸ªç¨‹åºè°ƒç”¨ï¼ŒèŠ‚çœå†…å­˜ã€‚</li></ul><h4 id="2ã€-a-ä¸-framework-çš„åŒºåˆ«ï¼Ÿ"><a href="#2ã€-a-ä¸-framework-çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="2ã€.a ä¸.framework çš„åŒºåˆ«ï¼Ÿ"></a>2ã€.a ä¸.framework çš„åŒºåˆ«ï¼Ÿ</h4><ul><li>.aæ˜¯ä¸€ä¸ªçº¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ.framework ä¸­é™¤äº†æœ‰äºŒè¿›åˆ¶æ–‡ä»¶ä¹‹å¤–è¿˜æœ‰èµ„æºæ–‡ä»¶ã€‚</li><li>.aæ–‡ä»¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œè‡³å°‘è¦æœ‰.hæ–‡ä»¶é…åˆï¼Œ.framework æ–‡ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</li></ul><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">.a</span> + <span class="hljs-string">.h</span> + sourceFile = <span class="hljs-string">.framework</span><br></code></pre></td></tr></table></figure><h3 id="a-çš„åˆ¶ä½œï¼Ÿ"><a href="#a-çš„åˆ¶ä½œï¼Ÿ" class="headerlink" title=".a çš„åˆ¶ä½œï¼Ÿ"></a>.a çš„åˆ¶ä½œï¼Ÿ</h3><ul><li>æ–°å»º Cocoa Touch Static Library å·¥ç¨‹ï¼Œç¼–å†™é€»è¾‘ä»£ç ã€‚</li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">//.hæ–‡ä»¶</span><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">Aframe </span>: NSObject<br>- (void)mathAdd;<br><span class="hljs-variable">@end</span><br><br><span class="hljs-comment">//.mæ–‡ä»¶</span><br>#import <span class="hljs-string">&quot;Aframe.h&quot;</span><br><span class="hljs-variable">@implementation</span> Aframe<br>- (void)mathAdd&#123;<br>    <span class="hljs-selector-tag">NSLog</span>(@<span class="hljs-string">&quot;1 + 1 = 2&quot;</span>);<br>&#125;<br>@<span class="hljs-selector-tag">end</span><br></code></pre></td></tr></table></figure><ul><li>Targets-&gt;Build Settings å‚æ•°è®¾ç½®ï¼š</li></ul><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">&quot;Build Active Architecture Only&quot;</span> è®¾ç½®ä¸º<span class="hljs-string">&quot;NO&quot;</span><br></code></pre></td></tr></table></figure><ul><li>Targets-&gt;Build Phases å‚æ•°è®¾ç½®ï¼š</li></ul><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">&quot;Copy Files&quot;</span> ä¸­æ·»åŠ éœ€è¦æš´éœ²çš„<span class="hljs-string">.h</span> æ–‡ä»¶<br></code></pre></td></tr></table></figure><ul><li>Run ä¿®æ”¹ scheme</li></ul><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">é€‰æ‹©å·¦ä¸Šè§’é™æ€åº“-&gt;Run-&gt;<span class="hljs-keyword">Info</span>-&gt;Build Configuration è®¾ç½®ä¸ºRelease<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘ç”Ÿæˆé™æ€åº“.aæ–‡ä»¶ï¼š</li></ul><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">åˆ†åˆ«é€‰æ‹©çœŸæœºå’Œ <span class="hljs-variable">iPhone</span> æ¨¡æ‹Ÿå™¨è¿›è¡Œç¼–è¯‘ã€‚<br>æ‰¾åˆ°çœŸæœºå’Œæ¨¡æ‹Ÿå™¨ç¼–è¯‘æˆåŠŸç”Ÿæˆçš„<span class="hljs-operator">.</span><span class="hljs-variable">a</span>æ–‡ä»¶<span class="hljs-operator">,</span><span class="hljs-built_in">Show</span> <span class="hljs-built_in">In</span> <span class="hljs-variable">Finder</span>ï¼Œåˆ†åˆ«åœ¨ <span class="hljs-built_in">Release</span><span class="hljs-operator">-</span><span class="hljs-variable">iphoneos</span>ã€<span class="hljs-built_in">Release</span><span class="hljs-operator">-</span><span class="hljs-variable">iphonesimulator</span>ç›®å½•ä¸­ã€‚<br></code></pre></td></tr></table></figure><ul><li>åˆæˆé€šç”¨ç‰ˆçš„é™æ€åº“.aæ–‡ä»¶</li></ul><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">æ‰“å¼€ç»ˆç«¯è¾“å…¥ä»¥ä¸‹å‘½ä»¤è¡Œï¼š<br>lipo -<span class="hljs-built_in">create</span> /xx.<span class="hljs-keyword">a</span>(çœŸæœº.<span class="hljs-keyword">a</span>æ–‡ä»¶è·¯å¾„) /xx.<span class="hljs-keyword">a</span>(æ¨¡æ‹Ÿå™¨.<span class="hljs-keyword">a</span>æ–‡ä»¶è·¯å¾„) -output Desktop/xx.<span class="hljs-keyword">a</span><br></code></pre></td></tr></table></figure><ul><li>æµ‹è¯•è‡ªå·±åˆ¶ä½œçš„é™æ€åº“æ–‡ä»¶</li></ul><p>å°†.h ä»¥åŠä¸Šæ­¥å¯¼å‡ºçš„.aæ–‡ä»¶å¯¼å…¥è‡ªå·±çš„å·¥ç¨‹ä¸­ï¼Œè°ƒç”¨.h ä¸­çš„æ¥å£ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;AppDelegate.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Aframe.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">void</span>)testLibA&#123;<br>    Aframe *aframe = [Aframe new];<br>    [aframe mathAdd];<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    [<span class="hljs-keyword">self</span> testLibA];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h3 id="frameworkçš„åˆ¶ä½œï¼Ÿ"><a href="#frameworkçš„åˆ¶ä½œï¼Ÿ" class="headerlink" title=".frameworkçš„åˆ¶ä½œï¼Ÿ"></a>.frameworkçš„åˆ¶ä½œï¼Ÿ</h3><ul><li>æ–°å»º Cocoa Touch Framework å·¥ç¨‹ï¼Œç¼–å†™é€»è¾‘ä»£ç ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//.hæ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">MathTool</span> : <span class="hljs-title">NSObject</span></span><br>- (<span class="hljs-type">void</span>)mathAdd;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//.mæ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;MathTool.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">MathTool</span></span><br>- (<span class="hljs-type">void</span>)mathAdd&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;1 + 1 = 2&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ul><li>æ›´æ”¹å‚æ•°ï¼š</li></ul><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs coq">TARGETS-&gt;Build Settings-&gt;Dead Code Stripping è®¾ç½®ä¸ºNOã€‚<br>TARGETS-&gt;Build Settings-&gt;Link With Stantard <span class="hljs-keyword">Libraries</span> è®¾ç½®ä¸ºNOã€‚<br>Mach-O <span class="hljs-keyword">Type</span> è®¾ç½®ä¸º Static <span class="hljs-keyword">Library</span>ã€‚<br></code></pre></td></tr></table></figure><ul><li>è®¾ç½®éœ€è¦æš´éœ²çš„å¤´æ–‡ä»¶</li></ul><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs zephir">TARGETS-&gt;Build Phases-&gt;Headers çš„ <span class="hljs-keyword">public</span>é€‰é¡¹ä¸‹ æŠŠéœ€è¦æš´éœ²çš„å¤´æ–‡ä»¶æ‹–è¿›æ¥ã€‚<br></code></pre></td></tr></table></figure><ul><li>åœ¨æ–°å»ºé¡¹ç›®æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„xxx.hæ–‡ä»¶é‡Œå°†è¦æš´éœ²çš„å¤´æ–‡ä»¶ import è¿›æ¥ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><br><span class="hljs-comment">//! Project version number for Framework.</span><br>FOUNDATION_EXPORT <span class="hljs-type">double</span> FrameworkVersionNumber;<br><br><span class="hljs-comment">//! Project version string for Framework.</span><br>FOUNDATION_EXPORT <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> FrameworkVersionString[];<br><br><span class="hljs-comment">//import all the public headers of your framework</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Framework/MathTool.h&gt;</span></span><br></code></pre></td></tr></table></figure><ul><li>Edit Scheme</li></ul><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">å·¦ä¸Šè§’<span class="hljs-function"><span class="hljs-title">scheme</span>-&gt;</span>R<span class="hljs-function"><span class="hljs-title">un</span>-&gt;</span>I<span class="hljs-function"><span class="hljs-title">nfo</span>-&gt;</span>Build Configuration è®¾ç½®ä¸º Release<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘ framework</li></ul><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ada">åˆ†åˆ«é€‰ä¸­æ¨¡æ‹Ÿå™¨å’Œ<span class="hljs-keyword">Generic</span> iOS Device ç¼–è¯‘ã€‚<br>é€‰ä¸­ Products ä¸‹çš„xxx.frameworkï¼Œshow <span class="hljs-keyword">in</span> Finderã€‚<br></code></pre></td></tr></table></figure><ul><li>åˆæˆé€šç”¨ framework</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">lipo -create <span class="hljs-regexp">/xx.framework/</span>xx(çœŸæœº.frameworkæ–‡ä»¶è·¯å¾„) <br><span class="hljs-regexp">/xx.framework/</span>xx(æ¨¡æ‹Ÿå™¨.frameworkæ–‡ä»¶è·¯å¾„) <br>-output Desktop/xx<br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥å¯èƒ½ä¼šæŠ¥é”™ï¼Œä½†æ˜¯ä¾ç„¶ä¼šç”Ÿæˆä¸€ä¸ª xx.lipo æ–‡ä»¶ï¼Œå°†å…¶åç¼€å»æ‰å¹¶ å¤åˆ¶åˆ°&#x2F;xx.framework(çœŸæœº.frameworkæ–‡ä»¶è·¯å¾„) ä¸‹ï¼Œæ›¿æ¢ç›®å½•ä¸­åŸæœ‰çš„ frameworkã€‚</p><ul><li>æµ‹è¯• framework</li></ul><p>å°†ä¸Šä¸€æ­¥ä¸­æ›¿æ¢å®Œæˆçš„xx.framework å¤åˆ¶åˆ°æ–°çš„å·¥ç¨‹é‡Œï¼Œå¯¼å…¥å¤´æ–‡ä»¶ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;Framework/Framework.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">void</span>)testFramework&#123;<br>    MathTool *mathTool = [MathTool new];<br>    [mathTool mathAdd];<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application <br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    [<span class="hljs-keyword">self</span> testFramework];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>äº‹ä»¶å“åº”è€…é“¾ &amp; ä¼ é€’é“¾</title>
    <link href="/2018/01/07/uiresponder.html"/>
    <url>/2018/01/07/uiresponder.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-å“åº”è€…"><a href="#1-å“åº”è€…" class="headerlink" title="1.å“åº”è€…"></a>1.å“åº”è€…</h3><p>UIResponderï¼Œç”¨æ¥å“åº”ç”¨æˆ·çš„æ“ä½œå¹¶å¤„ç†å„ç§äº‹ä»¶ï¼š</p><ul><li>è§¦æ‘¸äº‹ä»¶</li><li>åŠ é€Ÿè®¡äº‹ä»¶</li><li>è¿œç¨‹æ§åˆ¶äº‹ä»¶</li></ul><p>ç»§æ‰¿è‡ª<code>UIResponder</code>çš„ç±»å¯¹è±¡ï¼Œå¦‚<code>UIView</code>ã€<code>UIViewController</code>ã€<code>UIApplication</code>ï¼Œæ‰èƒ½æ¥æ”¶å’Œå¤„ç†äº‹ä»¶ï¼Œå®ƒä»¬è¢«ç§°ä¸ºâ€œå“åº”è€…å¯¹è±¡â€ã€‚<code>UIResponder.h</code>ä¸­å®šä¹‰äº†å¦‚ä¸‹å¤„ç†æ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//å¤„ç†è§¦æ‘¸äº‹ä»¶</span><br>- (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>*)touches withEvent:(<span class="hljs-built_in">UIEvent</span>*)event;<br>- (<span class="hljs-type">void</span>)touchesMoved:(<span class="hljs-built_in">NSSet</span>*)touches withEvent:(<span class="hljs-built_in">UIEvent</span>*)event;<br>- (<span class="hljs-type">void</span>)touchesEnded:(<span class="hljs-built_in">NSSet</span>*)touches withEvent:(<span class="hljs-built_in">UIEvent</span>*)event;<br>- (<span class="hljs-type">void</span>)touchesCancelled:(<span class="hljs-built_in">NSSet</span>*)touches withEvent:(<span class="hljs-built_in">UIEvent</span>*)ev<br><br><span class="hljs-comment">//åŠ é€Ÿè®¡äº‹ä»¶</span><br>- (<span class="hljs-type">void</span>)motionBegan:(<span class="hljs-built_in">UIEventSubtype</span>)motion withEvent:(<span class="hljs-built_in">UIEvent</span>*)event;<br>- (<span class="hljs-type">void</span>)motionEnded:(<span class="hljs-built_in">UIEventSubtype</span>)motion withEvent:(<span class="hljs-built_in">UIEvent</span>*)event;<br>- (<span class="hljs-type">void</span>)motionCancelled:(<span class="hljs-built_in">UIEventSubtype</span>)motion withEvent:(<span class="hljs-built_in">UIEvent</span>*)event;<br><br><span class="hljs-comment">//è¿œç¨‹æ§åˆ¶äº‹ä»¶</span><br>- (<span class="hljs-type">void</span>)remoteControlReceivedWithEvent:(<span class="hljs-built_in">UIEvent</span>*)event;<br></code></pre></td></tr></table></figure><h3 id="2-å“åº”è€…é“¾"><a href="#2-å“åº”è€…é“¾" class="headerlink" title="2.å“åº”è€…é“¾"></a>2.å“åº”è€…é“¾</h3><p>ä¸‹é¢æ˜¯åœ¨è‡ªå®šä¹‰è§†å›¾<code>CustomView</code>çš„<code>-hitTest:withEvent:</code>æ–¹æ³•ä¸­æ–­ç‚¹åï¼Œéšæœºåœ¨ç•Œé¢ä¸­ç‚¹å‡»åå¾—åˆ°çš„å †æ ˆä¿¡æ¯ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_response_chain.png" alt="chain"></p><p>è°ƒç”¨é¡ºåºä¸ºåº•éƒ¨å…ˆé¡¶éƒ¨åï¼Œå¤§è‡´ç»è¿‡äº†<code>main</code>-&gt;<code>UIApplication</code>-&gt;<code>UIWindow</code>-&gt;<code>UIView</code>ã€‚</p><p>ç”¨æˆ·åœ¨å±å¹•ä¸Šåšç‚¹å‡»ã€ç¼©æ”¾ç­‰æ“ä½œæ—¶ä¼šè§¦å‘è§¦æ‘¸äº‹ä»¶ã€‚UIKitä¼šåˆ›å»ºä¸€ä¸ªUIEventäº‹ä»¶å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œåç»­ç”± UIApplication è´Ÿè´£äº‹ä»¶çš„åˆ†å‘å’Œä¼ é€’ï¼Œç›´åˆ°æ‰¾åˆ°å…¶æœ€ä½³çš„å“åº”è€…ã€‚</p><p>æŸ¥æ‰¾äº‹ä»¶å“åº”è€…çš„è¿‡ç¨‹å°±æ˜¯<code>Hit-Testing</code>çš„è¿‡ç¨‹ï¼Œè¢«æ£€æµ‹è€…éœ€è¦åšä¸¤ä¸ªåˆ¤æ–­ï¼š</p><ul><li>è‡ªå·±æ˜¯å¦èƒ½æ¥æ”¶äº‹ä»¶ï¼Ÿ</li><li>è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨è‡ªå·±èº«ä¸Šï¼Ÿ</li></ul><p>å…·ä½“æŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>UIApplication ä»äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶ï¼Œä¼ é€’ç»™<code>ä¸»çª—å£</code>ï¼ˆkeyWindowï¼‰ï¼›</li><li>ä¸»çª—å£æ£€æµ‹ï¼šâ‘ è‡ªå·±æ˜¯å¦èƒ½æ¥æ”¶äº‹ä»¶ï¼›â‘¡è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨è‡ªå·±èº«ä¸Šï¼›</li><li>è‹¥æ»¡è¶³æ­¤ä¸¤ä¸ªæ¡ä»¶ï¼Œå†å€’åºéå†ä¸»çª—å£çš„å­è§†å›¾æ•°ç»„ï¼Œå¯¹å­è§†å›¾é‡å¤ä»¥ä¸Šä¸¤ä¸ªåˆ¤æ–­ï¼›</li><li>è‹¥ä¸»çª—å£çš„å­è§†å›¾ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ï¼Œåˆ™ä¸»çª—å£æˆä¸ºè§¦æ‘¸äº‹ä»¶çš„æœ€ä½³æ¥æ”¶è€…ï¼›</li><li>è‹¥ä¸»çª—å£çš„å­è§†å›¾<code>A</code>ç¬¦åˆæ¡ä»¶ï¼Œåˆ™ç»§ç»­éå†<code>A</code>çš„å­è§†å›¾ï¼Œå¹¶é‡å¤ä¸Šé¢çš„ä¸¤ä¸ªåˆ¤æ–­ï¼›</li><li>è‹¥<code>A</code>çš„å­è§†å›¾ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ï¼Œåˆ™<code>A</code>æˆä¸ºæœ€ä½³æ¥æ”¶è§†å›¾ï¼›</li><li>è‹¥<code>A</code>çš„å­è§†å›¾ä¸­æœ‰ç¬¦åˆæ¡ä»¶çš„<code>X</code>ï¼Œåˆ™ç»§ç»­éå†Xçš„å­è§†å›¾ï¼Œç›´åˆ°æ‰¾åˆ°æœ€åˆé€‚çš„è§†å›¾ï¼›</li></ol><p><strong>ä¸èƒ½æ¥æ”¶äº‹ä»¶çš„æƒ…å†µ</strong></p><ul><li>userInteractionEnabled &#x3D; NO;</li><li>hidden &#x3D; YES; ï¼ˆæ³¨ï¼šçˆ¶è§†å›¾éšè—æ—¶ï¼Œå­è§†å›¾ä¹Ÿä¼šéšè—ï¼Œä¸èƒ½æ¥æ”¶äº‹ä»¶ï¼‰</li><li>alpha &lt; 0.01;</li></ul><p><strong>è§¦æ‘¸ç‚¹èŒƒå›´æ£€æµ‹</strong></p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(BOOL)</span>pointInside:<span class="hljs-params">(CGPoint)</span>point withEvent:<span class="hljs-params">(UIEvent *)</span>event;<br></code></pre></td></tr></table></figure><p>è¿”å›YESï¼Œåˆ™è§¦æ‘¸ç‚¹åœ¨å½“å‰ view ä¸Šã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-built_in">UIView</span> *)hitTest:(<span class="hljs-built_in">CGPoint</span>)point withEvent:(<span class="hljs-built_in">UIEvent</span> *)event<br>&#123;<br>    <span class="hljs-comment">// 1.åˆ¤æ–­ä¸‹çª—å£èƒ½å¦æ¥æ”¶äº‹ä»¶</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">self</span>.userInteractionEnabled ||<br>        <span class="hljs-keyword">self</span>.hidden == <span class="hljs-literal">YES</span> ||<br>        <span class="hljs-keyword">self</span>.alpha &lt;= <span class="hljs-number">0.01</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-comment">// 2.åˆ¤æ–­è§¦æ‘¸ç‚¹åœ¨ä¸åœ¨å½“å‰è§†å›¾ä¸Š</span><br>    <span class="hljs-keyword">if</span> (![<span class="hljs-keyword">self</span> pointInside:point withEvent:event])&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>; <span class="hljs-comment">//nilï¼Œè¡¨ç¤ºä¸åœ¨å½“å‰è§†å›¾ä¸Šï¼Œæ— æ³•å“åº”</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// 3.å¦‚æœè§¦æ‘¸ç‚¹åœ¨å½“å‰è§†å›¾èŒƒå›´å†…ï¼Œåˆ™ç»§ç»­ä»åå¾€å‰éå†å­è§†å›¾æ•°ç»„</span><br>    <span class="hljs-type">int</span> count = (<span class="hljs-type">int</span>)<span class="hljs-keyword">self</span>.subviews.count;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = count - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-comment">// è·å–å­è§†å›¾</span><br>        <span class="hljs-built_in">UIView</span> *childView = <span class="hljs-keyword">self</span>.subviews[i];<br>        <span class="hljs-comment">// åæ ‡ç³»çš„è½¬æ¢,æŠŠå½“å‰è§†å›¾ä¸Šçš„ç‚¹è½¬æ¢ä¸ºå­è§†å›¾ä¸Šçš„ç‚¹</span><br>        <span class="hljs-built_in">CGPoint</span> childP = [<span class="hljs-keyword">self</span> convertPoint:point toView:childView];<br>        <span class="hljs-built_in">UIView</span> *fitView = [childView hitTest:childP withEvent:event];<br>        <span class="hljs-keyword">if</span> (fitView) &#123; <span class="hljs-comment">//ä¸ä¸ºç©ºï¼Œè¯´æ˜è§¦æ‘¸ç‚¹åœ¨å­è§†å›¾ä¸Š</span><br>            <span class="hljs-keyword">return</span> fitView; <span class="hljs-comment">//è¿”å›å­è§†å›¾ï¼Œäº‹ä»¶äº¤ç”±å­è§†å›¾æ¥æ”¶</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 4.æ²¡æœ‰æ‰¾åˆ°æ›´åˆé€‚çš„viewï¼Œè¿”å›selfï¼Œäº‹ä»¶ç”±è‡ªå·±æ¥æ”¶</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§¦æ‘¸äº‹ä»¶ä¼ é€’ç»™è§†å›¾<code>A</code>åï¼Œä¼šè§¦å‘Açš„<code>hitTest:</code>æ–¹æ³•ã€‚</p><p>è‹¥æ­¤æ–¹æ³•è¿”å› nilï¼Œåˆ™<code>A</code>å’Œå…¶å­è§†å›¾éƒ½ä¸æ˜¯å“åº”è€…ï¼Œå“åº”ä¸º<code>A</code>çš„çˆ¶è§†å›¾ã€‚</p><p>å“åº”è€…é“¾æ˜¯<code>ä»çˆ¶è§†å›¾åˆ°å­è§†å›¾</code>ï¼Œè‹¥çˆ¶è§†å›¾ä¸èƒ½å“åº”äº‹ä»¶ï¼Œåˆ™å­è§†å›¾ä¹Ÿå°±ä¸èƒ½å“åº”ã€‚</p><p>æ‰¾åˆ°æœ€åˆé€‚çš„è§†å›¾åä¼šè§¦å‘è§†å›¾çš„<code>-touches</code>æ–¹æ³•ï¼Œå¼€å§‹å‘ä¸Š(ä»å­è§†å›¾åˆ°çˆ¶è§†å›¾)ä¼ é€’äº‹ä»¶ã€‚</p><h4 id="2-1-åº”ç”¨-äº‹ä»¶çš„æ‹¦æˆª"><a href="#2-1-åº”ç”¨-äº‹ä»¶çš„æ‹¦æˆª" class="headerlink" title="2.1.åº”ç”¨-äº‹ä»¶çš„æ‹¦æˆª"></a>2.1.åº”ç”¨-äº‹ä»¶çš„æ‹¦æˆª</h4><p>æ­£å› ä¸º<code>hitTest:</code>å¯ä»¥è¿”å›å“åº”è€…è§†å›¾ï¼Œæ‰€ä»¥æƒ³è®©è°æˆä¸ºå“åº”è€…å°±é‡å†™è°çˆ¶è§†å›¾çš„<code>hitTest:</code>æ–¹æ³•è¿”å›æŒ‡å®šçš„å­è§†å›¾ï¼›æˆ–è€…é‡å†™è‡ªå·±çš„<code>hitTest:</code>æ–¹æ³•å¹¶è¿”å›<code>self</code>ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå»ºè®®åœ¨çˆ¶è§†å›¾çš„<code>hitTest:</code>ä¸­è¿”å›å­è§†å›¾ä½œä¸ºæœ€ä½³å“åº”è€…ï¼</p><h5 id="æ¡ˆä¾‹1-æŒ‡å®šå“åº”è§†å›¾"><a href="#æ¡ˆä¾‹1-æŒ‡å®šå“åº”è§†å›¾" class="headerlink" title="æ¡ˆä¾‹1-æŒ‡å®šå“åº”è§†å›¾"></a>æ¡ˆä¾‹1-æŒ‡å®šå“åº”è§†å›¾</h5><p>é»˜è®¤æƒ…å†µä¸‹ label çš„<code>userInteractionEnabled</code>ä¸º NOï¼Œå³ label ä¸èƒ½æ¥æ”¶è§¦æ‘¸äº‹ä»¶ï¼Œæ¥ä¸‹æ¥çš„ç¤ºä¾‹è¿˜æ˜¯ä»¥3.2å°èŠ‚ä¸­çš„æ ‘å½¢ç»“æ„ä¸ºä¾‹ï¼Œè¦è®© label å“åº”è§¦æ‘¸äº‹ä»¶ã€‚å¯èƒ½ä½ ä¼šè§‰å¾—è¿™ä¸ªåŠŸèƒ½æœ‰ç‚¹é¸¡è‚‹ï¼Œå“ˆå“ˆï¼Œæ˜¯çš„ï¼Œè¿™é‡Œæˆ‘åªæ˜¯æƒ³æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•è®©æŒ‡å®šè§†å›¾å“åº”è§¦æ‘¸æˆ–ç‚¹å‡»äº‹ä»¶ã€‚</p><p><strong>æ€è·¯</strong>ï¼šè‡ªå®šä¹‰è“è‰²è§†å›¾å’Œlabelï¼Œé‡å†™è“è‰²è§†å›¾çš„<code>hitTest</code>æ–¹æ³•ï¼Œå½“è§¦æ‘¸ç‚¹åœ¨å…¶å­è§†å›¾ label çš„èŒƒå›´å†…æ—¶ï¼Œè¿”å›æ­¤ labelï¼Œè¿™æ ·è§¦æ‘¸äº‹ä»¶å°±è½¬å‘ç»™ label å¹¶è§¦å‘ label çš„<code>-touch:</code> ç³»åˆ—æ–¹æ³•ã€‚</p><ul><li>è“è‰²è§†å›¾ ASDFBlueView:</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;ASDFBlueView.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ASDFBlueView</span></span><br><br>- (<span class="hljs-built_in">UIView</span> *)hitTest:(<span class="hljs-built_in">CGPoint</span>)point withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    <span class="hljs-comment">// 1.åˆ¤æ–­ä¸‹çª—å£èƒ½å¦æ¥æ”¶äº‹ä»¶</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">self</span>.userInteractionEnabled ||<br>        <span class="hljs-keyword">self</span>.hidden == <span class="hljs-literal">YES</span> ||<br>        <span class="hljs-keyword">self</span>.alpha &lt;= <span class="hljs-number">0.01</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-comment">// 2.åˆ¤æ–­è§¦æ‘¸ç‚¹åœ¨ä¸åœ¨çª—å£ä¸Š</span><br>    <span class="hljs-keyword">if</span> (![<span class="hljs-keyword">self</span> pointInside:point withEvent:event])&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-comment">// 3.ä»åå¾€å‰éå†å­è§†å›¾æ•°ç»„</span><br>    <span class="hljs-type">int</span> count = (<span class="hljs-type">int</span>)<span class="hljs-keyword">self</span>.subviews.count;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = count - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-comment">// è·å–å­è§†å›¾</span><br>        <span class="hljs-built_in">UIView</span> *childView = <span class="hljs-keyword">self</span>.subviews[i];<br>        <span class="hljs-comment">// åæ ‡ç³»çš„è½¬æ¢,æŠŠçª—å£ä¸Šçš„ç‚¹è½¬æ¢ä¸ºå­è§†å›¾ä¸Šçš„ç‚¹</span><br>        <span class="hljs-comment">// æŠŠè‡ªå·±è§†å›¾ä¸Šçš„ç‚¹è½¬æ¢æˆå­è§†å›¾ä¸Šçš„ç‚¹</span><br>        <span class="hljs-built_in">CGPoint</span> childP = [<span class="hljs-keyword">self</span> convertPoint:point toView:childView];<br>        <br>        <span class="hljs-comment">//labelçš„interaction enableé»˜è®¤è¢«å…³é—­ï¼Œè¿™é‡Œè®©labelå“åº”è§¦æ‘¸äº‹ä»¶</span><br>        <span class="hljs-keyword">if</span> ([childView isKindOfClass:<span class="hljs-built_in">NSClassFromString</span>(<span class="hljs-string">@&quot;ASDFResponsibleLabel&quot;</span>)] &amp;&amp;<br>            [childView pointInside:childP withEvent:event]) &#123;<br>            <span class="hljs-keyword">return</span> childView;<br>        &#125;<br>        <span class="hljs-built_in">UIView</span> *fitView = [childView hitTest:childP withEvent:event];<br>        <span class="hljs-keyword">if</span> (fitView) &#123;<br>            <span class="hljs-keyword">return</span> fitView;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 4.æ²¡æœ‰æ‰¾åˆ°æ›´åˆé€‚çš„viewï¼Œè¿”å›è‡ªå·±</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Touched ASDFBlueView~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ul><li>è‡ªå®šä¹‰çš„ ASDFResponsibleLabel</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;ASDFBlueView.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ASDFBlueView</span></span><br><br>- (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Touched ASDFBlueView~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ul><li>ViewControllerä¸­é‡å†™touchæ–¹æ³•</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++Touch began in ViewController~&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœï¼š</p><ul><li>å¦‚æœåªç‚¹å‡»æ©™è‰²æˆ–ç™½è‰²åŒºåŸŸï¼Œåˆ™åªä¼šè§¦å‘<code>ViewController</code>ä¸­çš„<code>-touch:</code>æ–¹æ³•ï¼›</li><li>å¦‚æœç‚¹å‡» label ä»¥å¤–çš„è“è‰²åŒºåŸŸï¼Œåˆ™åªä¼šè§¦å‘<code>ASDFBlueView</code>ä¸­çš„<code>-touch:</code>æ–¹æ³•ï¼›</li><li>å¦‚æœç‚¹å‡» labelï¼Œåˆ™ label ä¼šå“åº”ç‚¹å‡»å¹¶è§¦å‘å…¶<code>-touch:</code>æ–¹æ³•ï¼›</li></ul><p><strong>å»¶ä¼¸</strong>ï¼š</p><p>1ã€æŒ‰ç…§ä¸Šé¢çš„æ€è·¯ï¼Œå¦‚æœç‚¹å‡»ä»»ä½•åœ°æ–¹éƒ½åªè®©å½“å‰<code>ViewController</code>å“åº”äº‹ä»¶ï¼Œåˆ™é‡å†™å…¶æ‰€æœ‰å­è§†å›¾çš„<code>-hitTest</code>æ–¹æ³•å¹¶éƒ½è¿”å›<code>nil</code>å³å¯ï¼›</p><p>2ã€å¦‚æœæ—¢æƒ³ label å“åº”äº‹ä»¶ï¼Œåˆæƒ³è“è‰²è§†å›¾å“åº”äº‹ä»¶ï¼Œåªéœ€åœ¨ label çš„<code>-touch:</code>æ–¹æ³•ä¸­è°ƒç”¨<code>[super touch..]</code>å³å¯ã€‚</p><h5 id="æ¡ˆä¾‹2-æŠ¢çº¢åŒ…"><a href="#æ¡ˆä¾‹2-æŠ¢çº¢åŒ…" class="headerlink" title="æ¡ˆä¾‹2-æŠ¢çº¢åŒ…"></a>æ¡ˆä¾‹2-æŠ¢çº¢åŒ…</h5><p>éœ€æ±‚ï¼šçº¢åŒ…æŒ‰ç…§æŸç§è½¨è¿¹é£˜è½ï¼Œç‚¹åˆ°é£˜è½ä¸­çš„çº¢åŒ…æ‰ç®—æŠ¢åˆ°ã€‚</p><p>æ€è·¯åˆ†æï¼š</p><ul><li>é£˜è½ä¸­çš„çº¢åŒ…å®åˆ™æ˜¯ä¸€ä¸ªæ‰§è¡Œäº†<code>position</code>åŠ¨ç”»çš„è§†å›¾ï¼›</li><li>å¯¹äºé™æ­¢çš„çº¢åŒ…ï¼Œåˆ¤æ–­ç‚¹å‡»æ˜¯å¦å‘½ä¸­æ—¶åªéœ€åœ¨å“åº”é“¾å°†äº‹ä»¶ä¼ é€’åˆ°çº¢åŒ…è§†å›¾æ—¶ï¼Œåˆ¤æ–­è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨è§†å›¾ä¸­å³å¯ï¼›</li><li>ä½†çº¢åŒ…è§†å›¾åœ¨æ‰§è¡Œä½ç§»åŠ¨ç”»ï¼Œå…¶å®é™…ä½ç½®åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­å¹¶æœªçœŸæ­£æ”¹å˜ï¼Œå¯¹åŠ¨ç”»ä¸­çš„çº¢åŒ…åˆ¤æ–­è§¦æ‘¸ç‚¹å¹¶ä¸å¯è¡Œï¼›</li><li>çº¢åŒ…è§†å›¾çš„å›¾å±‚æ ‘ä¸­ï¼Œ<code>presentationLayer</code>ä¿å­˜äº†åŠ¨ç”»æ—¶ layer çš„ä½ç½®ä¿¡æ¯ï¼Œåªéœ€åˆ¤æ–­è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨æ­¤å›¾å±‚ä¸­å³å¯~</li></ul><p>æ­¥éª¤1ï¼šè‡ªå®šä¹‰çº¢åŒ…è§†å›¾</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;AnimateClickedView.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AnimateClickedView</span></span><br><br>- (<span class="hljs-built_in">UIView</span> *)hitTest:(<span class="hljs-built_in">CGPoint</span>)point withEvent:(<span class="hljs-built_in">UIEvent</span> *)event<br>&#123;<br>    <span class="hljs-comment">//è½¬æ¢pointåˆ°presentationLayerçš„åæ ‡ç³»ä¸­</span><br>    <span class="hljs-built_in">CGPoint</span> convertedPoint = [<span class="hljs-keyword">self</span>.layer convertPoint:point toLayer:<span class="hljs-keyword">self</span>.layer.presentationLayer];<br>    <br>    <span class="hljs-comment">//åˆ¤æ–­ç‚¹å‡»æ˜¯å¦åœ¨è¿åŠ¨ä¸­çš„çº¢åŒ…èŒƒå›´å†…</span><br>    <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.layer.presentationLayer containsPoint:convertedPoint]) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++++æ­å–œæ‚¨ä¸­å¥–äº†ï¼&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;æ²¡ç‚¹ä¸­çº¢åŒ…ï¼Œç»§ç»­åŠ æ²¹å“¦~&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ­¥éª¤2ï¼šå°†çº¢åŒ…è§†å›¾æ·»åŠ åˆ°ç•Œé¢ä¸­å¹¶æ‰§è¡ŒåŠ¨ç”»</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;AnimateClickedView.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) AnimateClickedView *animateView;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br>- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];<br><br>    <span class="hljs-comment">//æ·»åŠ è§†å›¾</span><br>    _animateView = [[AnimateClickedView alloc] init];<br>    _animateView.backgroundColor = [<span class="hljs-built_in">UIColor</span> redColor];<br>    <span class="hljs-type">float</span> size = <span class="hljs-number">50</span>;<br>    uint32_t originX = arc4random() % (<span class="hljs-type">int</span>)(<span class="hljs-keyword">self</span>.view.frame.size.width - size);<span class="hljs-comment">//è§†å›¾xèµ·ç‚¹ä¸ºéšæœºæ•°</span><br>    _animateView.frame = <span class="hljs-built_in">CGRectMake</span>(originX, -size, size, size);<br>    [<span class="hljs-keyword">self</span>.view addSubview:_animateView];<br>&#125;<br><br><span class="hljs-comment">//æ¨¡æ‹Ÿå¼€å§‹åŠ¨ç”»</span><br>-(<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    <span class="hljs-keyword">if</span> (aInt != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    aInt +=<span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">//åˆ›å»ºè·¯å¾„</span><br>    <span class="hljs-built_in">UIBezierPath</span> *path = [<span class="hljs-built_in">UIBezierPath</span> bezierPath];<br>    [path moveToPoint:_animateView.center];<span class="hljs-comment">//åŠ¨ç”»è·¯å¾„çš„èµ·ç‚¹ä¸ºè§†å›¾ä¸­å¿ƒç‚¹</span><br>    <span class="hljs-comment">//è·¯å¾„ä¸­çš„æ§åˆ¶ç‚¹éšæœº</span><br>    <span class="hljs-built_in">CGFloat</span> height = <span class="hljs-built_in">CGRectGetHeight</span>(<span class="hljs-keyword">self</span>.view.frame);<br>    [path addCurveToPoint:<span class="hljs-built_in">CGPointMake</span>(_animateView.frame.origin.x, height)<br>            controlPoint1:<span class="hljs-built_in">CGPointMake</span>(<span class="hljs-number">0</span>, arc4random() % (<span class="hljs-type">int</span>)(height / <span class="hljs-number">4.0</span>))<br>            controlPoint2:<span class="hljs-built_in">CGPointMake</span>(<span class="hljs-built_in">CGRectGetWidth</span>(<span class="hljs-keyword">self</span>.view.frame), height - <span class="hljs-number">200</span>)];<br>    <span class="hljs-comment">//åˆ›å»ºåŠ¨ç”»</span><br>    <span class="hljs-built_in">CAKeyframeAnimation</span> *animation = [<span class="hljs-built_in">CAKeyframeAnimation</span> animationWithKeyPath:<span class="hljs-string">@&quot;position&quot;</span>];<br>    animation.path = path.CGPath;<br>    animation.duration = <span class="hljs-number">5</span>;<br>    animation.autoreverses = <span class="hljs-literal">NO</span>;<br>    animation.removedOnCompletion = <span class="hljs-literal">NO</span>;<br>    animation.fillMode = kCAFillModeForwards;<br>    <span class="hljs-comment">//æ‰§è¡ŒåŠ¨ç”»</span><br>    [_animateView.layer addAnimation:animation forKey:<span class="hljs-string">@&quot;HAPPY_NEW_YEAR_ANIMATION&quot;</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ­¥éª¤3ï¼šç‚¹å‡»ç•Œé¢ä¸­çš„çº¢åŒ…ï¼ŒæŸ¥çœ‹æ—¥å¿—ä¿¡æ¯~</p><h3 id="3-äº‹ä»¶çš„ä¼ é€’"><a href="#3-äº‹ä»¶çš„ä¼ é€’" class="headerlink" title="3.äº‹ä»¶çš„ä¼ é€’"></a>3.äº‹ä»¶çš„ä¼ é€’</h3><p>äº‹ä»¶çš„å“åº”è€…ç¡®å®šåï¼Œå…¶å†…éƒ¨çš„<code>-touches</code>ç³»åˆ—æ–¹æ³•ä¼šè‡ªåŠ¨è§¦å‘å¹¶å¼€å§‹å¤„ç†äº‹ä»¶ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span> *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event<br>&#123; <br>    <span class="hljs-comment">// é»˜è®¤ä¼šæŠŠäº‹ä»¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå“åº”è€…,ä¸‹ä¸€ä¸ªå“åº”è€…æ˜¯çˆ¶è§†å›¾,äº¤ç»™çˆ¶è§†å›¾å¤„ç†</span><br>    [<span class="hljs-variable language_">super</span> touchesBegan:touches withEvent:event]; <br>    <span class="hljs-comment">// æ³¨æ„ä¸æ˜¯è°ƒç”¨çˆ¶è§†å›¾çš„touchesæ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨çˆ¶ç±»çš„touchesæ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœè§†å›¾å®ç°äº†<code>touches</code>ç³»åˆ—æ–¹æ³•ï¼Œåˆ™äº‹ä»¶å°†ç”±è¯¥è§†å›¾æ¥å¤„ç†ï¼›</p><p>å¦‚æœè°ƒç”¨äº†<code>[super touchesâ€¦.]</code>ï¼Œåˆ™äº‹ä»¶è¿˜å°†ä¼ é€’ç»™å…¶ä¸‹ä¸€ä¸ªå“åº”è€…ï¼›</p><p>ä¸‹ä¸€ä¸ªå“åº”è€…è§¦å‘å…¶<code>touches</code>ç³»åˆ—æ–¹æ³•(è‡ªå·±å¤„ç†äº‹ä»¶æˆ–è€…æ¥ç€å‘ä¸Šä¼ é€’)ï¼›</p><p>å¦‚æ­¤å¾ªç¯ä¸‹å»å°±æ„æˆäº†äº‹ä»¶çš„<code>ä¼ é€’é“¾</code>ã€‚</p><h4 id="3-1-nextResponder"><a href="#3-1-nextResponder" class="headerlink" title="3.1. nextResponder"></a>3.1. nextResponder</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">nullable</span>) <span class="hljs-built_in">UIResponder</span> *nextResponder;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯<code>UIResponder</code>ä¸­çš„å±æ€§ï¼Œç”¨æ¥æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå“åº”è€…ã€‚äº‹ä»¶ä»ç¬¬ä¸€ä¸ªå“åº”è€…å¼€å§‹ä¼ é€’ï¼Œç›´åˆ°è¢«æŸä¸ªå“åº”è€…å¤„ç†æ—¶äº‹ä»¶æ‰ä¼šåœæ­¢ä¼ é€’ï¼›å¦‚æœäº‹ä»¶ä¼ åˆ°æœ€åéƒ½æ²¡æœ‰è¢«å“åº”ï¼Œåˆ™è¯¥äº‹ä»¶å°±è¢«ä¸¢å¼ƒã€‚</p><p>äº‹ä»¶ä¼ é€’çš„è¿‡ç¨‹:</p><ol><li>è‹¥å½“å‰<code>view</code>æ˜¯æ§åˆ¶å™¨çš„<code>self.view</code>ï¼Œåˆ™æ§åˆ¶å™¨å°±æ˜¯ä¸‹ä¸€ä¸ªå“åº”è€…ï¼Œäº‹ä»¶ä¼ é€’ç»™æ§åˆ¶å™¨å“åº”ï¼›</li><li>å¦‚æœå½“å‰<code>view</code>ä¸æ˜¯æ§åˆ¶å™¨çš„<code>self.view</code>ï¼Œåˆ™<code>view</code>çš„çˆ¶è§†å›¾å°±æ˜¯ä¸‹ä¸€ä¸ªå“åº”è€…ï¼Œäº‹ä»¶å°±ä¼ é€’ç»™å®ƒçš„çˆ¶è§†å›¾å“åº”ï¼›</li><li>åœ¨è§†å›¾å±‚æ¬¡ç»“æ„çš„æœ€é¡¶çº§è§†å›¾ï¼Œå¦‚æœä¹Ÿä¸èƒ½å¤„ç†è¯¥äº‹ä»¶ï¼Œåˆ™è¯¥äº‹ä»¶ä¼šè¢«ä¼ é€’ç»™<code>window</code>å¯¹è±¡ï¼›</li><li>è‹¥<code>window</code>å¯¹è±¡ä¹Ÿä¸å¤„ç†ï¼Œåˆ™äº‹ä»¶ä¼šä¼ é€’ç»™<code>UIApplication</code>å¯¹è±¡ï¼›</li><li>è‹¥<code>UIApplication</code>ä¹Ÿä¸èƒ½å¤„ç†è¯¥äº‹ä»¶ï¼Œåˆ™å°†å…¶ä¸¢å¼ƒï¼Œæœ¬æ¬¡ç‚¹å‡»æ¯«æ— ååº”ã€‚</li></ol><p>å°ç»“ï¼šäº‹ä»¶æ˜¯ä»å­è§†å›¾å¾€çˆ¶è§†å›¾ä¼ é€’ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><p>åœ¨<code>ViewController</code>çš„<code>self.view</code>(æ©™è‰²)ä¸­æœ‰ä¸ªç™½è‰²åœ†è§’çš„è§†å›¾(UIViewInspectable)ï¼Œåœ†è§’è§†å›¾å†…æœ‰ä¸ªè‡ªå®šä¹‰çš„è“è‰²è§†å›¾(ASDFBlueView)ï¼Œè“è‰²è§†å›¾ä¸­æœ‰ä¸ª<code>label</code>ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_responsiblelabel.png" alt="responsiblelabel"></p><p>ç»“æ„å›¾ï¼š</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs 1c">ViewController<br>    <span class="hljs-string">|--self.view</span><br>        <span class="hljs-string">|--åœ†è§’çš„è§†å›¾</span><br>            <span class="hljs-string">|--è“è‰²è§†å›¾</span><br>                <span class="hljs-string">|--label</span><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æ ¹æ®å“åº”è€…é“¾æŸ¥æ‰¾<code>Label</code>æ‰€å±<code>ViewController</code>çš„ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-built_in">UIViewController</span> *)findSuperControllerForView:(<span class="hljs-built_in">UIView</span> *)view<br>&#123;<br>    <span class="hljs-built_in">UIViewController</span> *resultController;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">UIView</span> *next = view; next; next = [next superview]) &#123;<br>        <span class="hljs-built_in">UIResponder</span> *responder = [next nextResponder];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++Class:%@&quot;</span>,[responder <span class="hljs-keyword">class</span>]);<br>        <span class="hljs-keyword">if</span> ([responder isKindOfClass:[<span class="hljs-built_in">UIViewController</span> <span class="hljs-keyword">class</span>]]) &#123;<br>            resultController = (<span class="hljs-built_in">UIViewController</span>*)responder;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++Equal Self?:%@&quot;</span>,[resultController isEqual:<span class="hljs-keyword">self</span>] ? <span class="hljs-string">@&quot;YES&quot;</span> : <span class="hljs-string">@&quot;NO&quot;</span>);<br>    <span class="hljs-keyword">return</span> resultController;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">Class:ASDFBlueView</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">Class:UIViewInspectable</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">Class:UIView</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">Class:ViewController</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">Class:UIApplication</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">Equal Self?:YES</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—å±•ç¤ºäº†å“åº”è€…çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œä»å­è§†å›¾ä¸€ç›´å‘çˆ¶è§†å›¾å’Œ<code>UIWindow</code>åŠ<code>UIApplication</code>æŸ¥æ‰¾ã€‚æœ€ç»ˆæ‰¾åˆ°<code>label</code>æ‰€å±çš„æ§åˆ¶å™¨ï¼Œå³å½“å‰<code>ViewController</code>ã€‚</p><h4 id="3-2-åº”ç”¨-æ‹–æ‹½è§†å›¾"><a href="#3-2-åº”ç”¨-æ‹–æ‹½è§†å›¾" class="headerlink" title="3.2.åº”ç”¨-æ‹–æ‹½è§†å›¾"></a>3.2.åº”ç”¨-æ‹–æ‹½è§†å›¾</h4><p>è‡ªå®šä¹‰ä¸€ä¸ªviewï¼Œå¹¶é‡å†™ä¸‹é¢æ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)touchesMoved:(<span class="hljs-built_in">NSSet</span> *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event<br>&#123;<br>    <span class="hljs-built_in">UITouch</span> *touch = [touches anyObject];<br>    <br>    <span class="hljs-built_in">CGPoint</span> curP = [touch locationInView:<span class="hljs-keyword">self</span>];<br>    <span class="hljs-built_in">CGPoint</span> preP = [touch previousLocationInView:<span class="hljs-keyword">self</span>];<br>    <span class="hljs-built_in">CGFloat</span> offsetX = curP.x - preP.x;<br>    <span class="hljs-built_in">CGFloat</span> offsetY = curP.y - preP.y;<br>    <br>    <span class="hljs-keyword">self</span>.transform = <span class="hljs-built_in">CGAffineTransformTranslate</span>(<span class="hljs-keyword">self</span>.transform, offsetX, offsetY);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-å°ç»“"><a href="#4-å°ç»“" class="headerlink" title="4.å°ç»“"></a>4.å°ç»“</h3><ul><li>äº‹ä»¶çš„å“åº”è€…é“¾æ˜¯ä»ä¸Šåˆ°ä¸‹ï¼ˆçˆ¶è§†å›¾åˆ°å­è§†å›¾ï¼Œå­è§†å›¾æ•°ç»„å†…ä»åå¾€å‰ï¼‰ã€‚</li><li>äº‹ä»¶çš„ä¼ é€’é“¾æ˜¯ä»ä¸‹åˆ°ä¸Šï¼ˆé¡ºç€å“åº”è€…é“¾æ¡å‘ä¸Šä¼ é€’ï¼šå­è§†å›¾åˆ°çˆ¶è§†å›¾ï¼‰ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æœºåˆ¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å›¾å±‚</title>
    <link href="/2017/12/29/draw.html"/>
    <url>/2017/12/29/draw.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-å›¾å±‚çš„ç»˜åˆ¶"><a href="#1-å›¾å±‚çš„ç»˜åˆ¶" class="headerlink" title="1.å›¾å±‚çš„ç»˜åˆ¶"></a>1.å›¾å±‚çš„ç»˜åˆ¶</h3><p>å›¾å±‚ï¼Œå³<code>CALayer</code>çš„ç»˜æœ‰ä¸¤ç§å®ç°æ–¹æ¡ˆï¼š</p><ol><li>è‡ªå·±ç»˜åˆ¶ï¼›</li><li>äº¤ç»™ä»£ç†å¯¹è±¡ç»˜åˆ¶ã€‚</li></ol><h4 id="1-1-è‡ªå·±ç»˜åˆ¶"><a href="#1-1-è‡ªå·±ç»˜åˆ¶" class="headerlink" title="1.1.è‡ªå·±ç»˜åˆ¶"></a>1.1.è‡ªå·±ç»˜åˆ¶</h4><p>å›¾å±‚è‡ªå·±ç»˜åˆ¶æ—¶ï¼Œéœ€è¦é‡å†™ -drawInContext æ–¹æ³•ï¼Œå…·ä½“æ­¥éª¤ä¸ºï¼š</p><ul><li>è°ƒç”¨ CALayer å¯¹è±¡çš„ setNeedsDisplay æ–¹æ³•è§¦å‘é‡ç»˜ï¼›</li><li>é‡å†™ drawInContext: æ–¹æ³•ç»˜åˆ¶æ–°å†…å®¹ã€‚</li></ul><p>#ç¤ºä¾‹1.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CustomLayer.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CustomLayer</span></span><br><br><span class="hljs-comment">//é‡å†™drawInContext</span><br>- (<span class="hljs-type">void</span>)drawInContext:(<span class="hljs-built_in">CGContextRef</span>)ctx<br>&#123;<br>    <span class="hljs-built_in">CGContextSetLineWidth</span>(ctx, <span class="hljs-number">2</span>);<br>    <span class="hljs-built_in">CGContextSetFillColorWithColor</span>(ctx, [<span class="hljs-built_in">UIColor</span> blueColor].CGColor);<br>    <span class="hljs-built_in">CGContextSetStrokeColorWithColor</span>(ctx, [<span class="hljs-built_in">UIColor</span> whiteColor].CGColor);<br>    <br>    <span class="hljs-comment">//è´å¡å°”æ›²çº¿ç”»ä¸‰è§’å½¢</span><br>    <span class="hljs-built_in">UIBezierPath</span> *aPath = [<span class="hljs-built_in">UIBezierPath</span> bezierPath];<br>    aPath.lineWidth = <span class="hljs-number">2.0</span>; <span class="hljs-comment">//è®¾ç½®çº¿å®½</span><br>    aPath.lineCapStyle = kCGLineCapRound; <span class="hljs-comment">//çº¿æ¡æ‹è§’</span><br>    aPath.lineJoinStyle = kCGLineCapRound; <span class="hljs-comment">//ç»ˆç‚¹å¤„ç†</span><br>    [aPath moveToPoint:<span class="hljs-built_in">CGPointMake</span>(<span class="hljs-number">100</span>, <span class="hljs-number">50</span>)];<br>    [aPath addLineToPoint:<span class="hljs-built_in">CGPointMake</span>(<span class="hljs-number">150</span>, <span class="hljs-number">100</span>)];<br>    [aPath addLineToPoint:<span class="hljs-built_in">CGPointMake</span>(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>)];<br>    [aPath closePath];<br><br>    <span class="hljs-built_in">CGContextAddPath</span>(ctx, aPath.CGPath);<br>    <span class="hljs-built_in">CGContextDrawPath</span>(ctx, kCGPathFillStroke);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å°†è‡ªå®šä¹‰ CustomLayer æ·»åŠ åˆ°è§†å›¾ä¸Šï¼Œè°ƒç”¨-setNeedsDisplayè§¦å‘é‡ç»˜ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CustomLayer.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];<br><br>    CustomLayer *layer = [[CustomLayer alloc] init];<br>    layer.backgroundColor = [<span class="hljs-built_in">UIColor</span> whiteColor].CGColor;<br>    layer.frame = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">100</span>, <span class="hljs-number">300</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br>    [<span class="hljs-keyword">self</span>.view.layer addSublayer:layer];<br>    [layer setNeedsDisplay];<span class="hljs-comment">//è°ƒç”¨æ­¤æ–¹æ³•è§¦å‘é‡ç»˜</span><br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h4 id="1-2-ä»£ç†ç»˜åˆ¶"><a href="#1-2-ä»£ç†ç»˜åˆ¶" class="headerlink" title="1.2.ä»£ç†ç»˜åˆ¶"></a>1.2.ä»£ç†ç»˜åˆ¶</h4><p>å›¾å±‚å†…éƒ¨æ²¡æœ‰å®ç°<code>-drawInContext</code>æ–¹æ³•æ—¶ï¼Œå°±éœ€è¦å°†ç»˜åˆ¶ä»»åŠ¡ä»£ç†ç»™åˆ«çš„å¯¹è±¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCALayerçš„ä»£ç†æ˜¯å…¶æ‰€å±çš„è§†å›¾ã€‚ä»£ç†ç»™åˆ«çš„å¯¹è±¡æ—¶ï¼Œæ­¤å¯¹è±¡éœ€è¦å®ç° CALayerDelegateã€‚</p><ul><li>è®¾ç½® CALayer çš„ CALayerDelegateï¼›</li><li>è°ƒç”¨ CALayer çš„-setNeedsDisplay è§¦å‘ç»˜åˆ¶ï¼›</li><li>åœ¨ä»£ç†æ–¹æ³•-drawLayer:inContext:çš„å®ç°ä¸­ç»˜åˆ¶å†…å®¹ã€‚</li></ul><p>#ç¤ºä¾‹1.2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CustomLayer.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CustomLayer</span></span><br><span class="hljs-comment">//è¿™é‡Œä¸é‡å†™-drawInContext:æ–¹æ³•</span><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å°†è‡ªå®šä¹‰CALayeræ·»åŠ åˆ°è§†å›¾ä¸Šï¼Œè®¾ç½®ä»£ç†å¹¶è°ƒç”¨-setNeedsDisplayè§¦å‘é‡ç»˜ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CustomLayer.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()&lt;<span class="hljs-title">CALayerDelegate</span>&gt;</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];<br><br>    CustomLayer *layer = [[CustomLayer alloc] init];<br>    layer.backgroundColor = [<span class="hljs-built_in">UIColor</span> whiteColor].CGColor;<br>    layer.frame = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">100</span>, <span class="hljs-number">300</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br>    layer.delegate = <span class="hljs-keyword">self</span>;<br>    [<span class="hljs-keyword">self</span>.view.layer addSublayer:layer];<br>    [layer setNeedsDisplay];<span class="hljs-comment">//è°ƒç”¨æ­¤æ–¹æ³•è§¦å‘é‡ç»˜</span><br>&#125;<br><br><span class="hljs-comment">//CALayerDelegate</span><br>-(<span class="hljs-type">void</span>)drawLayer:(<span class="hljs-built_in">CALayer</span> *)layer inContext:(<span class="hljs-built_in">CGContextRef</span>)ctx<br>&#123;<br>    <span class="hljs-built_in">CGContextAddEllipseInRect</span>(ctx, <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">50</span>));<br>    <span class="hljs-built_in">CGContextSetRGBFillColor</span>(ctx, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">CGContextDrawPath</span>(ctx, kCGPathFillStroke);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæ—¢é‡å†™äº† CustomLayer ä¸­çš„-drawInContext:ï¼Œåˆå®ç°äº† CALayerDelegateï¼Œé‚£ä¹ˆæœ€ç»ˆåªä¼šåœ¨-drawInContextä¸­è¿›è¡Œé‡ç»˜ã€‚</p><h3 id="2-è§†å›¾çš„ç»˜åˆ¶"><a href="#2-è§†å›¾çš„ç»˜åˆ¶" class="headerlink" title="2.è§†å›¾çš„ç»˜åˆ¶"></a>2.è§†å›¾çš„ç»˜åˆ¶</h3><h4 id="2-1-æ˜¾ç¤ºåŸç†"><a href="#2-1-æ˜¾ç¤ºåŸç†" class="headerlink" title="2.1.æ˜¾ç¤ºåŸç†"></a>2.1.æ˜¾ç¤ºåŸç†</h4><p>é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨UIViewç­‰æ§ä»¶æ¥è®¾ç½®éœ€è¦æ˜¾ç¤ºçš„å†…å®¹ï¼Œä½†å®é™…ä¸Šï¼Œè§†å›¾æœ¬èº«å¹¶ä¸è´Ÿè´£å†…å®¹çš„æ˜¾ç¤ºï¼Œç”šè‡³åŠ¨ç”»ä¹Ÿä¸æ˜¯åœ¨è§†å›¾ä¸Šæ‰§è¡Œçš„ã€‚ä»ç»§æ‰¿å…³ç³»ä¸Šæ¥çœ‹ï¼Œè§†å›¾éƒ½ç›´æ¥æˆ–é—´æ¥çš„ç»§æ‰¿è‡ª UIResponderï¼Œä»è®¾è®¡ç›®æ ‡ä¸Šæ¥çœ‹è§†å›¾çš„ä¸»è¦ä½œç”¨æ˜¯å¤„ç†ç”¨æˆ·äº¤äº’ã€‚é‚£ä¹ˆï¼Œæ˜¾ç¤ºå’ŒåŠ¨ç”»çš„å·¥ä½œç”±è°æ¥å¤„ç†å‘¢ï¼Ÿç­”æ¡ˆï¼šCALayerï¼</p><blockquote><p>CALayer<br>An object that manages image-based content and allows you to perform animations on that content.</p></blockquote><p>è§†å›¾å†…éƒ¨é»˜è®¤æœ‰ä¸ª.layerå±æ€§ï¼Œè¿™ä¸ª<code>CALayer</code>å¯¹è±¡æ­£æ˜¯è§†å›¾æ˜¾ç¤ºå’ŒåŠ¨ç”»çš„å¹•åä¸»è§’ï¼Œè§†å›¾çš„ç»˜åˆ¶æœ¬è´¨ä¸Šæ¥è¯´å°±æ˜¯å›¾å±‚çš„ç»˜åˆ¶ã€‚</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs applescript">/* An object providing <span class="hljs-keyword">the</span> <span class="hljs-built_in">contents</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> layer, typically a CGImageRef,<br> * <span class="hljs-keyword">but</span> may be something <span class="hljs-keyword">else</span>. (For example, NSImage objects are<br> * supported <span class="hljs-keyword">on</span> Mac OS X <span class="hljs-number">10.6</span> <span class="hljs-keyword">and</span> later.) Default value <span class="hljs-keyword">is</span> nil.<br> * Animatable. */<br><br>@<span class="hljs-keyword">property</span>(nullable, strong) <span class="hljs-built_in">id</span> <span class="hljs-built_in">contents</span>;<br></code></pre></td></tr></table></figure><p>CALayer ä¸­æœ‰ä¸ª<code>contents</code>å±æ€§ï¼Œå³å›¾å±‚çš„å†…å®¹ï¼Œæ˜¯ä¸€ä¸ªä½å›¾ï¼ˆCGImageRefï¼‰ï¼ŒæŒ‡å‘ä¸€ç‰‡å«åš backing store(åå¤‡å­˜å‚¨åŒº)çš„ç¼“å­˜åŒºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤å±æ€§çš„å€¼ä¸ºç©ºï¼Œå®ƒä¼šä»<code>åå¤‡å­˜å‚¨</code>ä¸­è¯»å–å†…å®¹å¹¶æ˜¾ç¤ºã€‚å½“æˆ‘ä»¬é€šè¿‡è§†å›¾å±•ç¤ºå†…å®¹æ—¶ï¼š</p><ul><li>ä½¿ç”¨è§†å›¾åŠå…¶å­æ§ä»¶ï¼Œè®¾ç½®å¥½å®½é«˜ã€èƒŒæ™¯è‰²ç­‰å†…å®¹ï¼›</li><li>runloopå³å°†ä¼‘çœ æˆ–é€€å‡ºæ—¶ï¼Œå¼€å§‹è§†å›¾çš„ç»˜åˆ¶ï¼Œè°ƒç”¨ drawRect æ–¹æ³•ï¼›</li><li>drawRect å†…é€šè¿‡ CoreGraphics åœ¨ CGContextRef ä¸­ç»˜åˆ¶å†…å®¹å¹¶ä¿å­˜ä¸ºä½å›¾ï¼›</li><li>ç»˜åˆ¶çš„ä½å›¾è¢«ä¿å­˜åˆ°ç”± CPU å¼€è¾Ÿçš„ä¸€ç‰‡å« backing store çš„ç¼“å­˜ä¸­ï¼›</li><li>å›¾å±‚çš„<code>contents</code>ä¼šä» backing store ä¸­è¯»å–å†…å®¹ï¼›</li><li>å›¾å±‚å°†<code>contents</code>ä¸­çš„ä½å›¾äº¤ç»™<code>GPU</code>è¿›è¡Œåˆæˆã€è½¬æ¢å’Œæ¸²æŸ“ï¼›</li><li>GPU å°†æ¸²æŸ“ç»“æœæ”¾å…¥<code>å¸§ç¼“å†²åŒº</code>ï¼›</li><li><code>è§†é¢‘æ§åˆ¶å™¨</code>ä¼šæŒ‰ç…§ VSync ä¿¡å·é€è¡Œè¯»å–å¸§ç¼“å†²åŒºçš„æ•°æ®ï¼Œç»è¿‡å¯èƒ½çš„æ•°æ¨¡è½¬æ¢ä¼ é€’ç»™<code>æ˜¾ç¤ºå™¨</code>å±•ç¤ºã€‚</li></ul><p>é™¤äº†è®¾ç½®è§†å›¾çš„å®½é«˜ã€èƒŒæ™¯è‰²æ¥å±•ç¤ºå†…å®¹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç»™ layer.contents èµ‹å€¼ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¾ç¤ºå†…å®¹æ—¶ä¸å†ä»<code>åå¤‡å­˜å‚¨</code>ä¸­è¯»å–å†…å®¹ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨<code>contents</code>ä¸­çš„ä½å›¾ã€‚</p><blockquote><p>If you are using the layer to display a static image, you can set this property to the CGImageRef containing the image you want to display. Assigning a value to this property causes the layer to use your image rather than create a separate backing store.</p></blockquote><h4 id="2-2-drawRect"><a href="#2-2-drawRect" class="headerlink" title="2.2.drawRect"></a>2.2.drawRect</h4><p>ä¸€èˆ¬åœ¨è‡ªå®šä¹‰ä¸€ä¸ªè§†å›¾çš„ç»˜åˆ¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™å…¶-drawRect:æ–¹æ³•ã€‚</p><p>#ç¤ºä¾‹2.2:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CustomView.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br>- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];<br>    <br>    CustomView *view = [[CustomView alloc] init];<br>    view.backgroundColor = [<span class="hljs-built_in">UIColor</span> whiteColor];<br>    view.frame = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">100</span>, <span class="hljs-number">300</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br>    [<span class="hljs-keyword">self</span>.view addSubview:view];<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;CustomView.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CustomView</span></span><br><span class="hljs-comment">//è‡ªå®šä¹‰è§†å›¾å¹¶é‡å†™drawRect</span><br>- (<span class="hljs-type">void</span>)drawRect:(<span class="hljs-built_in">CGRect</span>)rect<br>&#123;<br>    <span class="hljs-comment">//è¾¹å®½</span><br>    <span class="hljs-built_in">CGFloat</span> lineWidth = <span class="hljs-number">3.0</span>f;<br>    <span class="hljs-comment">//åŠå¾„</span><br>    <span class="hljs-built_in">CGFloat</span> radius = (<span class="hljs-built_in">CGRectGetWidth</span>(rect) - lineWidth * <span class="hljs-number">2</span>) / <span class="hljs-number">2.0</span>;<br>    <span class="hljs-comment">//åœ†å¿ƒ</span><br>    <span class="hljs-built_in">CGPoint</span> center = <span class="hljs-built_in">CGPointMake</span>(<span class="hljs-built_in">CGRectGetWidth</span>(rect)/<span class="hljs-number">2.0</span>, <span class="hljs-built_in">CGRectGetHeight</span>(rect) / <span class="hljs-number">2.0</span>);<br>    <span class="hljs-comment">//æ‰‡å½¢èµ·ç‚¹</span><br>    <span class="hljs-built_in">CGFloat</span> startAngle = - M_PI_2;<br>    <span class="hljs-comment">//æ ¹æ®è¿›åº¦è®¡ç®—æ‰‡å½¢ç»“æŸä½ç½®</span><br>    <span class="hljs-built_in">CGFloat</span> endAngle = startAngle + <span class="hljs-number">0.8</span> * M_PI * <span class="hljs-number">2</span>;<br>    <span class="hljs-comment">//æ ¹æ®èµ·å§‹ç‚¹ã€åŸç‚¹ã€åŠå¾„ç»˜åˆ¶å¼§çº¿</span><br>    <span class="hljs-built_in">UIBezierPath</span> *path = [<span class="hljs-built_in">UIBezierPath</span> bezierPathWithArcCenter:center radius:radius startAngle:startAngle endAngle:endAngle clockwise:<span class="hljs-literal">YES</span>];<br>    <br>    <span class="hljs-built_in">CGContextRef</span> ref = <span class="hljs-built_in">UIGraphicsGetCurrentContext</span>();<br>    <span class="hljs-built_in">CGContextSetLineWidth</span>(ref, lineWidth);<br>    <span class="hljs-built_in">CGContextSetFillColorWithColor</span>(ref, [<span class="hljs-built_in">UIColor</span> yellowColor].CGColor);<br>    <span class="hljs-built_in">CGContextSetStrokeColorWithColor</span>(ref, [<span class="hljs-built_in">UIColor</span> blueColor].CGColor);<br>    <span class="hljs-comment">//ä»å¼§çº¿ç»“æŸä¸ºæ­¢ç»˜åˆ¶ä¸€æ¡çº¿æ®µåˆ°åœ†å¿ƒã€‚è¿™æ ·ç³»ç»Ÿä¼šè‡ªåŠ¨é—­åˆå›¾å½¢ï¼Œç»˜åˆ¶ä¸€æ¡ä»åœ†å¿ƒåˆ°å¼§çº¿èµ·ç‚¹çš„çº¿æ®µã€‚</span><br>    [path addLineToPoint:center];<br>    <span class="hljs-built_in">CGContextAddPath</span>(ref, path.CGPath);<br>    <span class="hljs-built_in">CGContextDrawPath</span>(ref, kCGPathFillStroke);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h4 id="2-3-è°ƒç”¨å †æ ˆ"><a href="#2-3-è°ƒç”¨å †æ ˆ" class="headerlink" title="2.3.è°ƒç”¨å †æ ˆ"></a>2.3.è°ƒç”¨å †æ ˆ</h4><p><img src="https://davidlii.nos-eastchina1.126.net/pic_drawrect.png" alt="è§†å›¾é‡ç»˜"></p><p>è¿™æ˜¯è°ƒç”¨-drawRectæ—¶çš„å †æ ˆå›¾ã€‚å½“å‰ runloop å³å°†ä¼‘çœ æˆ–é€€å‡ºæ—¶ï¼Œè§‚å¯Ÿè€…å›è°ƒå‡½æ•°ä¸­è‡ªåŠ¨è°ƒç”¨è§†å›¾å¯¹è±¡ä¸­ CALayer çš„<code>-display</code>æ–¹æ³•ã€‚ä¸‹é¢æ˜¯ CALayer.h ä¸­å¯¹æ­¤æ–¹æ³•çš„æè¿°ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/* Reload the content of this layer. Calls the -drawInContext: method</span><br><span class="hljs-comment"> * then updates the `contents&#x27; property of the layer. Typically this is</span><br><span class="hljs-comment"> * not called directly. */</span><br><br>- (<span class="hljs-type">void</span>)display;<br></code></pre></td></tr></table></figure><p>å³<code>-display</code>ç”¨æ¥æ›´æ–°å›¾å±‚çš„å†…å®¹ï¼Œå…¶å†…éƒ¨ä¼šç»§ç»­è°ƒç”¨<code>-drawInContext:</code>å¹¶æ›´æ–°<code>contents</code>ä¸­çš„å†…å®¹ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/* Called via the -display method when the `contents&#x27; property is being</span><br><span class="hljs-comment"> * updated. Default implementation does nothing. The context may be</span><br><span class="hljs-comment"> * clipped to protect valid layer content. Subclasses that wish to find</span><br><span class="hljs-comment"> * the actual region to draw can call CGContextGetClipBoundingBox(). */</span><br><br>- (<span class="hljs-type">void</span>)drawInContext:(<span class="hljs-built_in">CGContextRef</span>)ctx;<br><br><span class="hljs-comment">/* If defined, called by the default implementation of -drawInContext: */</span><br><br>- (<span class="hljs-type">void</span>)drawLayer:(<span class="hljs-built_in">CALayer</span> *)layer inContext:(<span class="hljs-built_in">CGContextRef</span>)ctx;<br></code></pre></td></tr></table></figure><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">Draws the layerâ€™s content <span class="hljs-keyword">using</span> the specified graphics context.The <span class="hljs-keyword">default</span> <span class="hljs-keyword">implementation</span> <span class="hljs-keyword">of</span> this <span class="hljs-keyword">method</span> <span class="hljs-title function_">does</span> <span class="hljs-title function_">not</span> <span class="hljs-title function_">do</span> <span class="hljs-title function_">any</span> <span class="hljs-title function_">drawing</span> <span class="hljs-title function_">itself</span>. <span class="hljs-title function_">If</span> <span class="hljs-title function_">the</span> <span class="hljs-title function_">layer</span>â€™<span class="hljs-title function_">s</span> <span class="hljs-title function_">delegate</span> <span class="hljs-title function_">implements</span> <span class="hljs-title function_">the</span> <span class="hljs-title function_">drawLayer</span>:inContext: <span class="hljs-keyword">method</span>, <span class="hljs-title function_">that</span> <span class="hljs-title function_">method</span> <span class="hljs-title function_">is</span> <span class="hljs-title function_">called</span> <span class="hljs-title function_">to</span> <span class="hljs-title function_">do</span> <span class="hljs-title function_">the</span> <span class="hljs-title function_">actual</span> <span class="hljs-title function_">drawing</span>.<br><span class="hljs-title function_">Subclasses</span> <span class="hljs-title function_">can</span> <span class="hljs-title function_">override</span> <span class="hljs-title function_">this</span> <span class="hljs-title function_">method</span> <span class="hljs-title function_">and</span> <span class="hljs-title function_">use</span> <span class="hljs-title function_">it</span> <span class="hljs-title function_">to</span> <span class="hljs-title function_">draw</span> <span class="hljs-title function_">the</span> <span class="hljs-title function_">layer</span>â€™<span class="hljs-title function_">s</span> <span class="hljs-title function_">content</span>. <span class="hljs-title function_">When</span> <span class="hljs-title function_">drawing</span>, <span class="hljs-title function_">all</span> <span class="hljs-title function_">coordinates</span> <span class="hljs-title function_">should</span> <span class="hljs-title function_">be</span> <span class="hljs-title function_">specified</span> <span class="hljs-title function_">in</span> <span class="hljs-title function_">points</span> <span class="hljs-title function_">in</span> <span class="hljs-title function_">the</span> <span class="hljs-title function_">logical</span> <span class="hljs-title function_">coordinate</span> <span class="hljs-title function_">space</span>.<br></code></pre></td></tr></table></figure><p><code>-drawInContext:</code>æ˜¯å›¾å±‚å†…ç»˜åˆ¶å†…å®¹çš„åœ°æ–¹ã€‚é»˜è®¤æƒ…å†µä¸‹æ–¹æ³•ä½“ä¸­ä»€ä¹ˆéƒ½ä¸åšï¼Œå¦‚æœå›¾å±‚çš„ä»£ç†å®ç°äº† drawLayer:inContext: ä»£ç†æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ç”±è¿™ä¸ªæ–¹æ³•æ¥å®ç°çœŸæ­£çš„ç»˜åˆ¶ã€‚ç¤ºä¾‹3ä¸­æˆ‘ä»¬æ²¡æœ‰é‡å†™æ­¤æ–¹æ³•ï¼Œæ‰€ä»¥å›¾å±‚ä¼šå°†ç»˜åˆ¶ä»»åŠ¡ä»£ç†ç»™åˆ«äººã€‚</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">In iOS, <span class="hljs-keyword">if</span> <span class="hljs-keyword">the</span> layer is associated <span class="hljs-keyword">with</span> <span class="hljs-keyword">a</span> UIView object, this property must be <span class="hljs-built_in">set</span> <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> view that owns <span class="hljs-keyword">the</span> layer.<br></code></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè§†å›¾ä¸­æ ¹layerçš„ä»£ç†æ˜¯è§†å›¾å¯¹è±¡æœ¬èº«ï¼Œæ‰€ä»¥ç»˜åˆ¶ä»»åŠ¡ä¼šé€šè¿‡ä»£ç†è½¬äº¤ç»™layeræ‰€å±çš„è§†å›¾ã€‚ä»å †æ ˆå›¾æ¥çœ‹ï¼ŒdrawLayer:inContext:ä»£ç†æ–¹æ³•å†…è‡ªåŠ¨è°ƒç”¨äº†è§†å›¾çš„ drawRect æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ¬æ¥éœ€è¦ç”± CALayer æ¥å®Œæˆçš„ç»˜åˆ¶ä»»åŠ¡ï¼Œé€šè¿‡ä»£ç†è½¬äº¤ç»™äº†è§†å›¾çš„ drawRectï¼Œè¿™ä¹Ÿæ­£æ˜¯æˆ‘ä»¬é‡å†™è§†å›¾ drawRect æ–¹æ³•æ‰€è¦åšçš„äº‹æƒ…ã€‚</p><p>è°ƒç”¨æµç¨‹æ¢³ç†å¦‚ä¸‹ï¼š</p><ol><li>å°†è§†å›¾æ·»åŠ åˆ°ç•Œé¢æˆ–è€…è°ƒç”¨è§†å›¾å¯¹è±¡çš„-setNeedsDisplayæ–¹æ³•ï¼Œè§¦å‘é‡ç»˜ï¼›</li><li>è§†å›¾å°†ç»˜åˆ¶ä»»åŠ¡äº¤ç»™å†…éƒ¨çš„.layerå¤„ç†ï¼›</li><li>layer è°ƒç”¨ -display æ–¹æ³•ï¼›</li><li>-display ç»§ç»­è°ƒç”¨-drawInContextç»˜åˆ¶å†…å®¹ï¼›</li><li>å› ä¸ºæ²¡æœ‰é‡å†™-drawInContextï¼ŒCALayerå°†ç»˜åˆ¶ä»»åŠ¡é€šè¿‡ä»£ç†äº¤ç»™layeræ‰€å±çš„è§†å›¾ï¼›</li><li>è§†å›¾å®ç°-drawLayer:inContext:ä»£ç†æ–¹æ³•ï¼Œå¹¶è°ƒç”¨è‡ªå·±çš„-drarRect:ç»˜åˆ¶å†…å®¹ï¼›</li></ol><p>æœ‰ä¸ªå°çŸ¥è¯†ç‚¹ï¼Œ-drawLayer:inContext:ä»£ç†æ–¹æ³•æœ€åæœ‰ä¸ªå‚æ•°<code>ctx</code>ï¼Œå³ç»˜å›¾çš„ä¸Šä¸‹æ–‡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)drawLayer:(<span class="hljs-built_in">CALayer</span>*)layer inContext:(<span class="hljs-built_in">CGContextRef</span>)context &#123;<br>    <span class="hljs-built_in">UIGraphicsPushContext</span>(context);<br><br>    <span class="hljs-built_in">CGRect</span> bounds;<br>    bounds = <span class="hljs-built_in">CGContextGetClipBoundingBox</span>(context);<br>    [<span class="hljs-keyword">self</span> drawRect:bounds];<br><br>    <span class="hljs-built_in">UIGraphicsPopContext</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯åšä¸»thinkqçš„ä¸€ç¯‡ <a href="https://www.jianshu.com/p/c49833c04362">æ–‡ç« </a> ä¸­å¸–å‡ºæ¥çš„ drawLayer:inContext: çš„å®ç°ä»£ç ï¼Œæ–¹æ³•å†…å°†layerä¼ é€’è¿‡æ¥çš„ CGContextRef å‹å…¥ç»˜å›¾ä¸Šä¸‹æ–‡æ ˆé¡¶ã€‚æˆ‘ä»¬åœ¨è§†å›¾çš„ drawRect ä¸­é€šè¿‡ UIGraphicsGetCurrentContext() è·å–çš„æ­£æ˜¯æ­¤ä¸Šä¸‹æ–‡ï¼Œæœ€å drawRect ä¸­çš„ç»˜åˆ¶ä»»åŠ¡éƒ½ä¼šä¿å­˜åœ¨æ­¤<code>ctx</code>ä¸­ã€‚CGContextRef æ˜¯ <code>per-thread</code>çš„ï¼Œè¿›å…¥å­çº¿ç¨‹ä¸­é€šè¿‡ UIGraphicsGetCurrentContext() è·å–æ ˆé¡¶çš„ä¸Šä¸‹æ–‡ä¼šä¸ºç©ºã€‚è¿™æ—¶ï¼Œå°±éœ€è¦é€šè¿‡ UIGraphicsBeginImageContext() åˆ›å»ºä¸€ä¸ª<code>åŸºäºä½å›¾çš„</code>ä¸Šä¸‹æ–‡å¹¶å°†å…¶è®¾ä¸ºå½“å‰ä¸Šä¸‹æ–‡è¿›è¡Œç»˜å›¾ã€‚</p><p>å¦å¤–ï¼Œé€šè¿‡é‡å†™è§†å›¾çš„ drawRect æ–¹æ³•ï¼Œä½¿ç”¨ CoreGraphic æ¥ç»˜åˆ¶å†…å®¹ï¼Œè¿™ä¼šæ¶ˆè€—å¾ˆå¤§ä¸€éƒ¨åˆ†å†…å­˜ï¼Œå°¤å…¶æ˜¯å½“ä½ éœ€è¦ä¸æ–­é‡ç»˜æ—¶ã€‚æ‰€ä»¥ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>CAShapeLayer</code> æ¥ç»˜åˆ¶ã€‚CAShapeLayer é€šè¿‡çŸ¢é‡å›¾å½¢è€Œé bitmap æ¥ç»˜åˆ¶å›¾å±‚ï¼Œæ‰€ä»¥æ›´èŠ‚çœå†…å­˜ã€æ¸²æŸ“é€Ÿåº¦ä¹Ÿæ›´å¿«ã€‚</p><h4 id="2-3-ç»˜åˆ¶ä¸çº¿ç¨‹"><a href="#2-3-ç»˜åˆ¶ä¸çº¿ç¨‹" class="headerlink" title="2.3.ç»˜åˆ¶ä¸çº¿ç¨‹"></a>2.3.ç»˜åˆ¶ä¸çº¿ç¨‹</h4><p>è§†å›¾çš„æ˜¾ç¤ºæµç¨‹è¢«åˆ†ä¸º<code>ç»˜åˆ¶</code>å’Œ<code>æ¸²æŸ“</code>ä¸¤ä¸ªé˜¶æ®µã€‚ç»˜åˆ¶çš„å·¥ä½œæ˜¯ç”±<code>CPU</code>æ¥å¤„ç†çš„ï¼Œè§†å›¾çš„ drawRect æ–¹æ³•æˆ–è€…å›¾å±‚çš„ drawInContext æ–¹æ³•å†…ï¼Œç»˜åˆ¶ä»»åŠ¡é»˜è®¤éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå½“ä½¿ç”¨ CoreGraphicsç»˜å›¾æ—¶ï¼Œå¦‚æœå†…å®¹æ¯”è¾ƒå¤æ‚åˆ™ä¼šå¯¼è‡´CPUæ€§èƒ½ç“¶é¢ˆä»è€Œé€ æˆå¡é¡¿ç°è±¡ã€‚æ¸²æŸ“çš„å·¥ä½œæ˜¯ç”±<code>GPU</code>æ¥å®Œæˆçš„ï¼Œå½“éœ€è¦æ¸²æŸ“çš„å›¾ç‰‡è¿‡å¤§ã€æœ‰ç¦»å±æ¸²æŸ“ç­‰æƒ…å†µæ—¶ï¼Œæ¸²æŸ“ä¸èƒ½åŠæ—¶å®Œæˆï¼Œä¹Ÿä¼šé€ æˆå¡é¡¿ç°è±¡ã€‚æ‰€ä»¥æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œç»˜å›¾ä»»åŠ¡ï¼Œå†å›åˆ°ä¸»çº¿ç¨‹å°†ç»˜åˆ¶ç»“æœè¿”å›ç»™è§†å›¾æˆ–CALayerã€‚åœ¨ä½¿ç”¨ tableviewCell è¿™ç§æ§ä»¶æ—¶ï¼Œé¿å…ç¦»å±æ¸²æŸ“é—®é¢˜ã€‚</p><p>#ç¤ºä¾‹2.3ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (<span class="hljs-type">UIImage</span><span class="hljs-operator">*</span>)drawdrawAsynchronousInRect:(<span class="hljs-type">CGRect</span>)rect<br>&#123;<br>    <span class="hljs-type">CGFloat</span> scale <span class="hljs-operator">=</span> [[<span class="hljs-type">UIScreen</span> mainScreen] scale];<br>    <br>    rect.size.width <span class="hljs-operator">*=</span> scale;<br>    rect.size.height <span class="hljs-operator">*=</span> scale;<br>    <br>    <span class="hljs-type">UIGraphicsBeginImageContext</span>(rect.size);<br>    <br>    <span class="hljs-type">CGContextRef</span> context <span class="hljs-operator">=</span> <span class="hljs-type">UIGraphicsGetCurrentContext</span>();<br>    <span class="hljs-type">CGContextScaleCTM</span>(context, scale, scale);<br>    <br>    <span class="hljs-type">UIImage</span> <span class="hljs-operator">*</span>image <span class="hljs-operator">=</span> <span class="hljs-type">UIGraphicsGetImageFromCurrentImageContext</span>();<br>    <span class="hljs-type">UIGraphicsEndImageContext</span>();<br>    <span class="hljs-keyword">return</span> [<span class="hljs-type">UIImage</span> imageWithCGImage:image.<span class="hljs-type">CGImage</span> scale:scale orientation:<span class="hljs-type">UIImageOrientationUp</span>];<br>&#125;<br><br><span class="hljs-comment">//è°ƒç”¨ç¤ºä¾‹</span><br><span class="hljs-type">UIImageView</span> <span class="hljs-operator">*</span>imageView;<br>    <span class="hljs-type">NSOperationQueue</span> <span class="hljs-operator">*</span>drawQueue <span class="hljs-operator">=</span> [[<span class="hljs-type">NSOperationQueue</span> alloc] <span class="hljs-keyword">init</span>];<br>    [drawQueue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-comment">//å¼‚æ­¥é˜Ÿåˆ—ä¸­ç»˜å›¾</span><br>        <span class="hljs-type">UIImage</span> <span class="hljs-operator">*</span>image <span class="hljs-operator">=</span> [<span class="hljs-keyword">self</span> drawdrawAsynchronousInRect:rect];<br>        <span class="hljs-comment">//å›åˆ°ä¸»çº¿ç¨‹è®¾ç½®å›¾ç‰‡</span><br>        [[<span class="hljs-type">NSOperationQueue</span> mainQueue] addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>            [imageView setImage:image];<br>        &#125;];<br>    &#125;];<br></code></pre></td></tr></table></figure><h3 id="3-å›¾å±‚ä¸åŠ¨ç”»"><a href="#3-å›¾å±‚ä¸åŠ¨ç”»" class="headerlink" title="3.å›¾å±‚ä¸åŠ¨ç”»"></a>3.å›¾å±‚ä¸åŠ¨ç”»</h3><h4 id="3-1-éšå¼åŠ¨ç”»"><a href="#3-1-éšå¼åŠ¨ç”»" class="headerlink" title="3.1.éšå¼åŠ¨ç”»"></a>3.1.éšå¼åŠ¨ç”»</h4><p>å½“æˆ‘ä»¬ä¿®æ”¹äº†å›¾å±‚çš„å¯åŠ¨ç”»å±æ€§æ—¶ï¼Œå±æ€§å¹¶ä¸ä¼šç«‹åˆ»æ˜¾ç¤ºæœ€ç»ˆç»“æœï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªå¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœï¼ŒæŒç»­0.25ç§’ï¼Œè¿™å°±æ˜¯å›¾å±‚çš„<code>éšå¼åŠ¨ç”»</code>ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰æ˜ç¡®æŒ‡å®šåŠ¨ç”»çš„ç±»å‹ï¼Œä»…ä»…æ˜¯æ”¹å˜äº†æŸä¸ªå±æ€§ã€‚</p><p>#ç¤ºä¾‹3.1.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CustomLayer.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) CustomLayer *mSublayer;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br>- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];<br><br>    _mSublayer = [[CustomLayer alloc] init];<br>    _mSublayer.backgroundColor = [<span class="hljs-built_in">UIColor</span> whiteColor].CGColor;<br>    _mSublayer.frame = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">100</span>, <span class="hljs-number">300</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br>    [<span class="hljs-keyword">self</span>.view.layer addSublayer:_mSublayer];<br>&#125;<br><br>-(<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    <span class="hljs-built_in">CGAffineTransform</span> transform = _mSublayer.affineTransform;<br>    transform = <span class="hljs-built_in">CGAffineTransformRotate</span>(transform, M_PI_2);<br>    _mSublayer.affineTransform = transform;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­æˆ‘ä»¬åªæ˜¯å¯¹åˆšæ·»åŠ çš„å›¾å±‚çš„<code>affineTransform</code>å±æ€§å€¼åšäº†ä¿®æ”¹ï¼Œè¿è¡Œç‚¹å‡»ç•Œé¢åå›¾å±‚ä¼šæœ‰ä¸€ä¸ª0.25ç§’çš„æ—‹è½¬åŠ¨ç”»ã€‚</p><p>éšå¼åŠ¨ç”»çš„èƒŒåå…¶å®æ˜¯<code>Core Animation</code>åœ¨é»˜é»˜å¤„ç†åŠ¨ç”»äº‹åŠ¡ï¼šå½“æˆ‘ä»¬ä¿®æ”¹äº†å›¾å±‚çš„å¯åŠ¨ç”»å±æ€§æ—¶ï¼ŒCore Animation ä¼šé€šè¿‡äº‹åŠ¡å°†æˆ‘ä»¬çš„å±æ€§å˜åŒ–åŒ…è£¹èµ·æ¥ï¼Œå³åŒ…å«åœ¨<code>CATransaction</code>çš„<code>begin</code>ä¸<code>commit</code>ä¸­ï¼›äº‹åŠ¡è¢«ä¿å­˜åœ¨ä¸€ä¸ªæ ˆç»“æ„ä¸­ï¼Œå½“éšå¼åŠ¨ç”»è¢«æäº¤ä¹‹åï¼Œå®ƒå°±è¢«ä¿å­˜åœ¨æ ˆé¡¶çš„äº‹åŠ¡ä¸­ï¼›<code>runloop</code>çš„å¾ªç¯ä¸­ä¼šè‡ªåŠ¨å¼€å§‹æ ˆé¡¶çš„è¿™ä¸ªäº‹åŠ¡ï¼Œä»è€Œæ‰§è¡ŒåŠ¨ç”»è¿‡ç¨‹ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è¯•ç€å°†ä¸Šé¢æ‰§è¡ŒåŠ¨ç”»éƒ¨åˆ†çš„ä»£ç ç¨ä½œä¿®æ”¹ï¼ŒåŠ å…¥äº‹åŠ¡çš„è¯­å¥ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span>(void)touchesBegan:(<span class="hljs-type">NSSet</span>&lt;<span class="hljs-type">UITouch</span> *&gt; <span class="hljs-operator">*</span>)touches withEvent:(<span class="hljs-type">UIEvent</span> <span class="hljs-operator">*</span>)event&#123;<br>    <span class="hljs-comment">//åˆ›å»ºäº‹åŠ¡</span><br>    [<span class="hljs-type">CATransaction</span> begin];<br>    <span class="hljs-comment">//è‡ªå®šä¹‰åŠ¨ç”»æ—¶é•¿</span><br>    [<span class="hljs-type">CATransaction</span> setAnimationDuration:<span class="hljs-number">2</span>.0f];<br>    <span class="hljs-comment">//è‡ªå®šä¹‰åŠ¨ç”»ç»“æŸåçš„å¤„ç†é€»è¾‘</span><br>    [<span class="hljs-type">CATransaction</span> setCompletionBlock:<span class="hljs-operator">^</span>&#123;<br>        _mSublayer.backgroundColor <span class="hljs-operator">=</span> [<span class="hljs-type">UIColor</span> redColor].<span class="hljs-type">CGColor</span>;<br>    &#125;];<br>    <span class="hljs-type">CGAffineTransform</span> transform <span class="hljs-operator">=</span> _mSublayer.affineTransform;<br>    transform <span class="hljs-operator">=</span> <span class="hljs-type">CGAffineTransformRotate</span>(transform, <span class="hljs-type">M_PI_2</span>);<br>    _mSublayer.affineTransform <span class="hljs-operator">=</span> transform;<br>    <span class="hljs-comment">//[CATransaction commit];</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œåå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä¸<code>commit</code>ï¼ŒåŠ¨ç”»æ ¹æœ¬ä¸ä¼šæ‰§è¡Œ~å¦å¤–ï¼Œå¯ä»¥çœ‹åˆ°å¯å˜å±æ€§çš„åŠ¨ç”»æ—¶é•¿å’ŒåŠ¨ç”»åçš„å¤„ç†è¯­å¥éƒ½å¯ä»¥è‡ªå®šä¹‰ï¼Œè¿™è·Ÿä¸‹é¢ä¸¤ç§<code>UIView</code>çš„åŠ¨ç”»æ–¹å¼ç±»ä¼¼ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span><span class="hljs-number">1</span><br>[UIView beginAnimations:@<span class="hljs-string">&quot;x&quot;</span> context:nil];<br><span class="hljs-regexp">//</span>animation here<br>[UIView commitAnimations];<br><span class="hljs-regexp">//</span><span class="hljs-number">2</span><br>[UIView animateWithDuration:<span class="hljs-number">2.0</span>f animations:^&#123;<br>    <span class="hljs-regexp">//</span>animation here<br>&#125;];<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šè¿™ä¸¤ç§æ–¹å¼çš„å†…éƒ¨éƒ½æ˜¯é€šè¿‡<code>äº‹åŠ¡</code>æ¥å®ç°çš„ï¼ŒåŠ¨ç”»çš„åˆ›å»ºå’Œæäº¤åˆ†åˆ«è°ƒç”¨äº†<code>CATransaction</code>çš„<code>begin</code>ä¸<code>commit</code>ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>éšå¼åŠ¨ç”»åªåœ¨æˆ‘ä»¬ç›´æ¥åˆ›å»ºçš„å›¾å±‚ä¸Šæœ‰æ•ˆï¼Œ<code>UIView</code>ä¸­æ ¹å›¾çš„éšå¼åŠ¨ç”»é»˜è®¤æ˜¯å…³é—­çš„</strong>ï¼Œå¯¹<code>UIView</code>ä¸­æ ¹å›¾å±‚åšåŠ¨ç”»æ—¶ï¼Œä¸ä¼šæœ‰åŠ¨ç”»æ•ˆæœ:</p><p>#ç¤ºä¾‹3.1.2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">-(<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    [<span class="hljs-built_in">CATransaction</span> begin];<br>    [<span class="hljs-built_in">CATransaction</span> setAnimationDuration:<span class="hljs-number">2.0</span>f];<br>    <span class="hljs-built_in">CGAffineTransform</span> transform = <span class="hljs-keyword">self</span>.view.layer.affineTransform;<br>    transform = <span class="hljs-built_in">CGAffineTransformRotate</span>(transform, M_PI_2);<br>    <span class="hljs-comment">//ä¿®æ”¹ self.view ä¸­æ ¹å›¾å±‚çš„å¯å˜å±æ€§</span><br>    <span class="hljs-keyword">self</span>.view.layer.affineTransform = transform;<br>    [<span class="hljs-built_in">CATransaction</span> commit];<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­æˆ‘ä»¬å¯¹<code>self.view.layer.affineTransform</code>åšäº†ä¿®æ”¹ï¼Œå¹¶ä¸”é€šè¿‡äº‹åŠ¡è®¾ç½®äº†åŠ¨ç”»æ—¶é•¿ä¸º2ç§’ï¼Œä½†è¿è¡Œåå¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰åŠ¨ç”»æ•ˆæœï¼Œè€Œæ˜¯ç›´æ¥å˜åˆ°ç›®æ ‡å€¼ã€‚</p><p>é‚£ä¹ˆï¼ŒCALayer æ˜¯å¦‚ä½•ç¡®å®šè‡ªå·±æ˜¯å¦æ‰§è¡Œéšå¼åŠ¨ç”»çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯¹<code>#ç¤ºä¾‹3.1.1</code>ä¸­çš„ä»£ç ç¨ä½œä¿®æ”¹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;CustomLayer.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()&lt;<span class="hljs-title">CALayerDelegate</span>&gt;//ä¿®æ”¹1ï¼šå£°æ˜å›¾å±‚ä»£ç†</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) CustomLayer *mSublayer;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br>- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];<br><br>    _mSublayer = [[CustomLayer alloc] init];<br>    <span class="hljs-comment">//ä¿®æ”¹2ï¼šæŒ‡å®šå›¾å±‚çš„ä»£ç†ä¸ºå½“å‰VC</span><br>    _mSublayer.delegate = <span class="hljs-keyword">self</span>;<br>    _mSublayer.backgroundColor = [<span class="hljs-built_in">UIColor</span> whiteColor].CGColor;<br>    _mSublayer.frame = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">100</span>, <span class="hljs-number">300</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br>    [<span class="hljs-keyword">self</span>.view.layer addSublayer:_mSublayer];<br>&#125;<br><br>-(<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    <span class="hljs-built_in">CGAffineTransform</span> transform = _mSublayer.affineTransform;<br>    transform = <span class="hljs-built_in">CGAffineTransformRotate</span>(transform, M_PI_2);<br>    _mSublayer.affineTransform = transform;<br>&#125;<br><br><span class="hljs-comment">//ä¿®æ”¹3ï¼šå®ç°ä»£ç†</span><br>- (<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">CAAction</span>&gt;)actionForLayer:(<span class="hljs-built_in">CALayer</span> *)layer forKey:(<span class="hljs-built_in">NSString</span> *)event&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å±æ€§:%@&quot;</span>,event);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­æœ‰ä¸‰å¤„ä¿®æ”¹ï¼Œéƒ½æ˜¯å…³äº<code>CALayerDelegate</code>çš„ã€‚è¿è¡Œåç‚¹å‡»ç•Œé¢è§¦å‘éšå¼åŠ¨ç”»ï¼Œä¸‹é¢æ˜¯åŠ¨ç”»è§¦å‘æ—¶çš„å †æ ˆä¿¡æ¯ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_action_for_layer.png" alt="actionForLayer"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŠ¨ç”»æäº¤åï¼ŒCALayer è°ƒç”¨äº†å…¶<code>actionForKey</code>æ–¹æ³•ï¼Œè¯•å›¾è¿”å›ä¸€ä¸ªå®ç°äº†<code>CAAction</code>åè®®çš„å¯¹è±¡ï¼Œå‚æ•°<code>event</code>å¯¹åº”çš„æ­£æ˜¯æˆ‘ä»¬ä¿®æ”¹çš„å¯åŠ¨ç”»å±æ€§ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/** Action methods. **/</span><br><br><span class="hljs-comment">/* An &quot;action&quot; is an object that responds to an &quot;event&quot; via the</span><br><span class="hljs-comment"> * CAAction protocol (see below). Events are named using standard</span><br><span class="hljs-comment"> * dot-separated key paths. Each layer defines a mapping from event key</span><br><span class="hljs-comment"> * paths to action objects. Events are posted by looking up the action</span><br><span class="hljs-comment"> * object associated with the key path and sending it the method</span><br><span class="hljs-comment"> * defined by the CAAction protocol.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * When an action object is invoked it receives three parameters: the</span><br><span class="hljs-comment"> * key path naming the event, the object on which the event happened</span><br><span class="hljs-comment"> * (i.e. the layer), and optionally a dictionary of named arguments</span><br><span class="hljs-comment"> * specific to each event.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * To provide implicit animations for layer properties, an event with</span><br><span class="hljs-comment"> * the same name as each property is posted whenever the value of the</span><br><span class="hljs-comment"> * property is modified. A suitable CAAnimation object is associated by</span><br><span class="hljs-comment"> * default with each implicit event (CAAnimation implements the action</span><br><span class="hljs-comment"> * protocol).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The layer class also defines the following events that are not</span><br><span class="hljs-comment"> * linked directly to properties:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * onOrderIn</span><br><span class="hljs-comment"> *      Invoked when the layer is made visible, i.e. either its</span><br><span class="hljs-comment"> *      superlayer becomes visible, or it&#x27;s added as a sublayer of a</span><br><span class="hljs-comment"> *      visible layer</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * onOrderOut</span><br><span class="hljs-comment"> *      Invoked when the layer becomes non-visible. */</span><br><br><span class="hljs-comment">/* Returns the default action object associated with the event named by</span><br><span class="hljs-comment"> * the string &#x27;event&#x27;. The default implementation returns a suitable</span><br><span class="hljs-comment"> * animation object for events posted by animatable properties, nil</span><br><span class="hljs-comment"> * otherwise. */</span><br><br>+ (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;<span class="hljs-built_in">CAAction</span>&gt;)defaultActionForKey:(<span class="hljs-built_in">NSString</span> *)event;<br><br><span class="hljs-comment">/* Returns the action object associated with the event named by the</span><br><span class="hljs-comment"> * string &#x27;event&#x27;. The default implementation searches for an action</span><br><span class="hljs-comment"> * object in the following places:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 1. if defined, call the delegate method -actionForLayer:forKey:</span><br><span class="hljs-comment"> * 2. look in the layer&#x27;s `actions&#x27; dictionary</span><br><span class="hljs-comment"> * 3. look in any `actions&#x27; dictionaries in the `style&#x27; hierarchy</span><br><span class="hljs-comment"> * 4. call +defaultActionForKey: on the layer&#x27;s class</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If any of these steps results in a non-nil action object, the</span><br><span class="hljs-comment"> * following steps are ignored. If the final result is an instance of</span><br><span class="hljs-comment"> * NSNull, it is converted to `nil&#x27;. */</span><br><br>- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;<span class="hljs-built_in">CAAction</span>&gt;)actionForKey:(<span class="hljs-built_in">NSString</span> *)event;<br><br><span class="hljs-comment">/* A dictionary mapping keys to objects implementing the CAAction</span><br><span class="hljs-comment"> * protocol. Default value is nil. */</span><br><br><span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, <span class="hljs-type">id</span>&lt;<span class="hljs-built_in">CAAction</span>&gt;&gt; *actions;<br><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">CALayerDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span><br><span class="hljs-comment">//...ç•¥</span><br><br><span class="hljs-comment">/* If defined, called by the default implementation of the</span><br><span class="hljs-comment"> * -actionForKey: method. Should return an object implementing the</span><br><span class="hljs-comment"> * CAAction protocol. May return &#x27;nil&#x27; if the delegate doesn&#x27;t specify</span><br><span class="hljs-comment"> * a behavior for the current event. Returning the null object (i.e.</span><br><span class="hljs-comment"> * &#x27;[NSNull null]&#x27;) explicitly forces no further search. (I.e. the</span><br><span class="hljs-comment"> * +defaultActionForKey: method will not be called.) */</span><br><br>- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;<span class="hljs-built_in">CAAction</span>&gt;)actionForLayer:(<span class="hljs-built_in">CALayer</span> *)layer forKey:(<span class="hljs-built_in">NSString</span> *)event;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p><code>CAAction</code>å¯ä»¥è§†ä¸ºå›¾å±‚éšå¼åŠ¨ç”»çš„è¡Œä¸ºã€‚åŠ¨ç”»æäº¤åå›¾å±‚ä¼šé€šè¿‡<code>-actionForKey:</code>æ–¹æ³•å¯»æ‰¾ä¸€ä¸ª<code>CAAction</code>å¯¹è±¡ï¼Œå¯»æ‰¾çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å…ˆå°è¯•é€šè¿‡ CALayerDelegate çš„ -actionForLayer:forKey: ä»£ç†æ–¹æ³•è¿”å›ä¸€ä¸ª CAAction å¯¹è±¡ï¼›</li><li>å¦‚æœä»£ç†æ–¹æ³•è¿”å› nullï¼Œåˆ™åœæ­¢å¯»æ‰¾ï¼Œå±æ€§çš„ä¿®æ”¹ä¸æ‰§è¡Œä»»ä½•åŠ¨ç”»ï¼Œç›´æ¥æ›´æ–°åˆ°ç›®æ ‡å€¼ï¼›</li><li>å¦‚æœä»£ç†æ–¹æ³•è¿”å› nilï¼Œåˆ™ç»§ç»­ä» layer çš„ actions å­—å…¸ä¸­æŸ¥æ‰¾ CAAction å¯¹è±¡ï¼›</li><li>å¦‚æœ actions å­—å…¸ä¸­æ²¡æœ‰åŒ…å«å¯¹åº”çš„å±æ€§ï¼Œåˆ™å›¾å±‚ç»§ç»­åœ¨å®ƒçš„ style å­—å…¸ä¸­æœç´¢å±æ€§åï¼›</li><li>å¦‚æœåœ¨ style é‡Œä¹Ÿæ‰¾ä¸åˆ°ï¼Œåˆ™ä» +defaultActionForKey: æ–¹æ³•ä¸­è¿”å›å±æ€§å¯¹åº”çš„é»˜è®¤è¡Œä¸ºå¯¹è±¡ï¼›</li></ul><p>ä¸Šé¢çš„æœç´¢è¿‡ç¨‹ä¸­ï¼Œ<code>-actionForLayer:forKey:</code>å¦‚æœè¿”å›<code>null</code>å¯¹è±¡ï¼Œåˆ™ä¸æ‰§è¡ŒåŠ¨ç”»ï¼›å¦‚æœè¿”å›<code>nil</code>åˆ™ä¼šæ‰§è¡Œéšå¼åŠ¨ç”»ã€‚å¦‚æœè¿”å›<code>CAAction</code>åè®®å¯¹è±¡ï¼Œåˆ™ç”± Core Animation åˆ›å»ºå¯¹åº”çš„åŠ¨ç”»ã€‚</p><p>ä¸Šé¢æåˆ°çš„å¯¹è§†å›¾çš„æ ¹å›¾å±‚çš„å¯åŠ¨ç”»å±æ€§è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¹¶ä¸ä¼šè§¦å‘éšå¼åŠ¨ç”»ï¼Œå®é™…ä¸Šå°±æ˜¯å› ä¸ºè§†å›¾é»˜è®¤æ˜¯å…¶æ ¹å›¾å±‚çš„ä»£ç†ï¼Œ<code>-actionForLayer:forKey:</code>è¿”å›äº†ä¸€ä¸ª<code>null</code>å¯¹è±¡ã€‚ä½ å¯ä»¥å°è¯•è®©å½“å‰ VC å®ç°<code>self.view.layer</code>çš„ä»£ç†å¹¶è¿”å›<code>nil</code>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()&lt;<span class="hljs-title">CALayerDelegate</span>&gt;</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br>-(<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br>    <span class="hljs-comment">//è®¾ç½®ä»£ç†</span><br>    <span class="hljs-keyword">self</span>.view.layer.delegate = <span class="hljs-keyword">self</span>;<br>    [<span class="hljs-built_in">CATransaction</span> begin];<br>    [<span class="hljs-built_in">CATransaction</span> setAnimationDuration:<span class="hljs-number">2.0</span>f];<br>    <span class="hljs-built_in">CGAffineTransform</span> transform = <span class="hljs-keyword">self</span>.view.layer.affineTransform;<br>    transform = <span class="hljs-built_in">CGAffineTransformRotate</span>(transform, M_PI_2);<br>    <span class="hljs-comment">//ä¿®æ”¹ self.view ä¸­æ ¹å›¾å±‚çš„å¯å˜å±æ€§</span><br>    <span class="hljs-keyword">self</span>.view.layer.affineTransform = transform;<br>    [<span class="hljs-built_in">CATransaction</span> commit];<br>&#125;<br><br>- (<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">CAAction</span>&gt;)actionForLayer:(<span class="hljs-built_in">CALayer</span> *)layer forKey:(<span class="hljs-built_in">NSString</span> *)event&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å±æ€§:%@&quot;</span>,event);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å†è¿è¡Œå¹¶ç‚¹å‡»ç•Œé¢åå¯ä»¥çœ‹åˆ°ï¼Œ<code>self.view.layer</code>è¿™æ¬¡æ‰§è¡Œäº†éšå¼åŠ¨ç”»ï¼</p><h4 id="3-2-å›¾å±‚æ ‘"><a href="#3-2-å›¾å±‚æ ‘" class="headerlink" title="3.2.å›¾å±‚æ ‘"></a>3.2.å›¾å±‚æ ‘</h4><p>å’Œè§†å›¾ä¸€æ ·å›¾å±‚ä¹Ÿæœ‰æ ‘å½¢ç»“æ„ï¼Œç§°ä¸ºâ€œå›¾å±‚æ ‘â€ï¼Œå³<code>å±•ç¤ºæ ‘</code>å’Œ<code>æ¨¡å‹æ ‘</code>ã€‚</p><ul><li>å±•ç¤ºæ ‘</li></ul><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm">- (instance<span class="hljs-keyword">type</span>)presentationLayer;<br></code></pre></td></tr></table></figure><blockquote><p>Returns a copy of the presentation layer object that represents the state of the layer as it currently appears onscreen.</p></blockquote><blockquote><p>Discussion<br>The layer object returned by this method provides a close approximation of the layer that is currently being displayed onscreen. While an animation is in progress, you can retrieve this object and use it to get the current values for those animations.<br>The sublayers, mask, and superlayer properties of the returned layer return the corresponding objects from the presentation tree (not the model tree). This pattern also applies to any read-only layer methods. For example, the hitTest: method of the returned object queries the layer objects in the presentation tree.</p></blockquote><p>å½“ layer å¤„äºåŠ¨ç”»çŠ¶æ€æ—¶ï¼Œ<code>å±•ç¤ºæ ‘</code>ä¼šè¿”å›ä¸€ä¸ªå½“å‰æ­£åœ¨å±•ç¤ºä¸­çš„ layerï¼Œå…¶å±æ€§å€¼éƒ½æ˜¯å½“å‰è¿åŠ¨çŠ¶æ€ä¸­å¯¹åº”çš„å€¼ï¼ŒåŠ¨ç”»è¿‡ç¨‹ä¸­ä¼šä¸æ–­å˜åŒ–ã€‚</p><p>æ³¨æ„ï¼šå±•ç¤ºæ ‘åªæœ‰å½“å›¾å±‚å±•ç¤ºåœ¨ç•Œé¢ä¸Šä¹‹åæ‰ä¼šæœ‰å€¼ï¼Œåœ¨æ­¤ä¹‹å‰è°ƒç”¨æ­¤æ ‘ä¼šè¿”å›<code>nil</code>ã€‚</p><ul><li>æ¨¡å‹æ ‘</li></ul><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm">- (instance<span class="hljs-keyword">type</span>)modelLayer;<br></code></pre></td></tr></table></figure><blockquote><p>Returns the model layer object associated with the receiver, if any.</p></blockquote><blockquote><p>Discussion<br>Calling this method on a layer in the presentation tree returns the corresponding layer object in the model tree. This method returns a value only when a transaction involving changes to the presentation layer is in progress. If no transaction is in progress, the results of calling this method are undefined.</p></blockquote><p>åœ¨<code>å‘ˆç°å›¾å±‚</code>ä¸Šè°ƒç”¨<code>â€“modelLayer</code>å°†ä¼šè¿”å›å®ƒæ­£åœ¨å‘ˆç°æ‰€ä¾èµ–çš„ CALayerã€‚é€šå¸¸åœ¨ä¸€ä¸ªå›¾å±‚ä¸Šè°ƒç”¨<code>-modelLayer</code>ä¼šè¿”å›<code>self</code>ã€‚</p><p>å…³äºè¿™ä¸¤ä¸ªæ ‘çš„åº”ç”¨ï¼Œå¯ä»¥ç§»æ­¥åˆ°<code>äº‹ä»¶å“åº”è€…é“¾ &amp; ä¼ é€’é“¾</code>è¿™ç¯‡æ–‡ç« ä¸­çš„<code>æŠ¢çº¢åŒ…</code>çš„ç¤ºä¾‹~</p><h3 id="4-ä½ç½®ç›¸å…³å±æ€§"><a href="#4-ä½ç½®ç›¸å…³å±æ€§" class="headerlink" title="4.ä½ç½®ç›¸å…³å±æ€§"></a>4.ä½ç½®ç›¸å…³å±æ€§</h3><h4 id="4-1-frame"><a href="#4-1-frame" class="headerlink" title="4.1.frame"></a>4.1.frame</h4><blockquote><p>The frame rectangle, which describes the viewâ€™s location and size in its superviewâ€™s coordinate system.</p></blockquote><p><code>frame</code>ï¼Œè¡¨ç¤ºè§†å›¾åœ¨å…¶çˆ¶è§†å›¾åæ ‡ç³»ä¸­çš„ä½ç½®å’Œå¤§å°ã€‚è¿™é‡Œçš„ä½ç½®<code>frame.origin(x,y)</code>å³è§†å›¾çš„å·¦ä¸Šè§’ï¼Œå®ƒå‚ç…§çš„æ˜¯çˆ¶è§†å›¾çš„åæ ‡ç³»åŸç‚¹ã€‚æ”¹å˜frameçš„å€¼åªä¼šå½±å“åˆ°è§†å›¾æœ¬èº«ï¼Œå…¶å­è§†å›¾çš„ç›¸å¯¹ä½ç½®ä¸å˜ã€‚</p><h4 id="4-2-bounds"><a href="#4-2-bounds" class="headerlink" title="4.2.bounds"></a>4.2.bounds</h4><blockquote><p>The bounds rectangle, which describes the viewâ€™s location and size in its own coordinate system.</p></blockquote><p><code>bounds</code>ï¼Œè¡¨ç¤ºè§†å›¾åœ¨å…¶è‡ªèº«åæ ‡ç³»ä¸­çš„ä½ç½®å’Œå¤§å°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œbounds &#x3D; (0, 0, frame.size.width, frame.size.heigth)ï¼Œå³ï¼š</p><ul><li>bounds.originé»˜è®¤ä¸º (0, 0)ï¼›</li><li>bounds.size &#x3D; frame.sizeï¼›</li></ul><p>å…¶ä¸­<code>bounds.origin(x,y)</code>å‚ç…§çš„æ˜¯è§†å›¾è‡ªèº«çš„åæ ‡ç³»åŸç‚¹ï¼Œä¿®æ”¹<code>bounds.origin</code>ä¸ä¼šæ”¹å˜è§†å›¾æœ¬èº«çš„ä½ç½®ï¼Œè€Œæ˜¯æ”¹å˜å…¶è‡ªèº«çš„åæ ‡ç³»åŸç‚¹ï¼›å› ä¸ºå­è§†å›¾çš„ä½ç½®å‚ç…§çš„æ˜¯çˆ¶è§†å›¾åæ ‡ç³»çš„åŸç‚¹ï¼Œæ‰€ä»¥ä¿®æ”¹è§†å›¾çš„<code>bounds.origin</code>æœ€ç»ˆå½±å“çš„æ˜¯å…¶å­è§†å›¾çš„ä½ç½®ã€‚å…·ä½“è¡¨ç°æ˜¯ï¼š</p><ul><li><code>bounds.origin(x,y)</code>ç›¸å½“äºå½“å‰è§†å›¾çš„åæ ‡ç³»åŸç‚¹ä¸è§†å›¾å·¦ä¸Šè§’ä¹‹é—´å¸¦å‘é‡çš„é—´è·ï¼›</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè§†å›¾æœ¬èº«çš„åæ ‡ç³»åŸç‚¹ä¸è§†å›¾å·¦ä¸Šè§’é‡åˆï¼Œå³bounds.origin(x,y) &#x3D; (0, 0)ï¼›</li><li>å½“<code>origin.x</code>ä¸ºæ­£å€¼æ—¶ï¼Œé—´è·åœ¨xè½´ä¸Šæ‹‰å¤§ï¼Œå› ä¸ºä¿®æ”¹originä¸å½±å“è§†å›¾æœ¬èº«çš„ä½ç½®ï¼Œæ‰€ä»¥è§†å›¾å·¦ä¸Šè§’ä½ç½®ä¸å˜ï¼Œåªèƒ½è®©è§†å›¾åæ ‡ç³»åŸç‚¹å‘å·¦ç§»åŠ¨ï¼›æ­¤æ—¶å­è§†å›¾frameå’Œboundsçš„æ•°å€¼éƒ½æ²¡å˜ï¼Œä½†å—çˆ¶è§†å›¾åæ ‡ç³»åŸç‚¹å·¦ç§»çš„å½±å“ï¼Œå­è§†å›¾æœ¬èº«ä¹Ÿä¼šè·Ÿç€çˆ¶è§†å›¾çš„åŸç‚¹å·¦ç§»ï¼›</li><li>å½“<code>origin.y</code>ä¸ºæ­£å€¼æ—¶ï¼Œé—´è·åœ¨yè½´ä¸Šæ‹‰å¤§ï¼Œå› ä¸ºè§†å›¾å·¦ä¸Šè§’ä¸å˜ï¼Œæ‰€ä»¥è§†å›¾åæ ‡ç³»åŸç‚¹ä¼šå‘ä¸Šç§»åŠ¨ï¼›å­è§†å›¾frameå’Œboundséƒ½ä¸å˜ï¼Œä½†å®ƒçš„å®é™…ä½ç½®ä¼šè·Ÿç€çˆ¶è§†å›¾çš„åŸç‚¹å‘ä¸Šç§»ï¼›</li></ul><p>#ç¤ºä¾‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_frame_bounds.png" alt="bounds"></p><p>ä¸Šå›¾ä¸­ï¼Œè§†å›¾Aæ˜¯çˆ¶è§†å›¾ï¼Œè§†å›¾Bæ˜¯Açš„å­è§†å›¾ã€‚</p><ul><li>ç²‰è‰²èƒŒæ™¯ä¸­è§†å›¾A.bounds.origin &#x3D; (0,0)ï¼›è§†å›¾B.bounds.origin &#x3D; (0, 0)ï¼›</li><li>ç»¿è‰²èƒŒæ™¯ä¸­è§†å›¾A.bounds.originè¢«ä¿®æ”¹ä¸º(50,0)ï¼Œæ‰€ä»¥è§†å›¾Aè‡ªèº«çš„åæ ‡ç³»åŸç‚¹ä¼šå‘å·¦ç§»åŠ¨50ï¼›</li><li>è§†å›¾Bæ˜¯è§†å›¾Açš„å­è§†å›¾ï¼Œæ‰€ä»¥è§†å›¾Bä¼šè·Ÿç€è§†å›¾Açš„åæ ‡ç³»åŸç‚¹å‘å·¦ç§»åŠ¨50ï¼›</li></ul><p><strong>ç»“è®º</strong>ï¼šä¿®æ”¹bounds.originä¼šå½±å“åˆ°å­è§†å›¾å‚ç…§çš„åæ ‡ç³»åŸç‚¹ï¼›ä¿®æ”¹bounds.sizeä¼šå½±å“åˆ°è§†å›¾æœ¬èº«çš„å¤§å°ï¼›</p><h4 id="4-3-anchorPoint"><a href="#4-3-anchorPoint" class="headerlink" title="4.3.anchorPoint"></a>4.3.anchorPoint</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pf">/* Defines the <span class="hljs-built_in">anchor</span> point of the layer&#x27;s bounds rect, as a point <span class="hljs-keyword">in</span><br> * normalized layer coordinates - &#x27;(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)&#x27; is the bottom left corner of<br> * the bounds rect, &#x27;(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)&#x27; is the top right corner. Defaults <span class="hljs-keyword">to</span><br> * &#x27;(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)&#x27;, i.e. the center of the bounds rect. Animatable. */<br><br>@property CGPoint <span class="hljs-built_in">anchor</span>Point;<br><br></code></pre></td></tr></table></figure><p>ç¿»è¯‘è¿‡æ¥æ˜¯<code>é”šç‚¹</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª<code>CGPoint</code>ç±»å‹çš„å±æ€§ï¼Œå¯ä»¥ç†è§£ä¸ºåœ¨ layer <code>è‡ªèº«åæ ‡ç³»</code>ä¸­çš„ä¸€ä¸ªç‚¹ã€‚é”šç‚¹åœ¨<code>x</code>è½´å’Œ<code>y</code>è½´ä¸Šæ•°å€¼çš„å˜åŒ–èŒƒå›´å‡ä¸º[0~1]ï¼Œä¾‹å¦‚<code>(0,0)</code>è¡¨ç¤º layer çš„å·¦ä¸Šè§’ï¼Œ<code>(0.5,0.5)</code>è¡¨ç¤º layer çš„ä¸­å¿ƒç‚¹ï¼Œ<code>(1,1)</code>è¡¨ç¤º layer çš„å³ä¸‹è§’ã€‚é”šç‚¹çš„é»˜è®¤å€¼ä¸º<code>(0.5,0.5)</code>ï¼Œå³ layer çš„ä¸­å¿ƒç‚¹ã€‚ç›´æ¥ä¿®æ”¹é”šç‚¹çš„å€¼ä¼šè§¦å‘éšå¼åŠ¨ç”»ã€‚</p><h4 id="4-4-position"><a href="#4-4-position" class="headerlink" title="4.4.position"></a>4.4.position</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">/* The position in the superlayer that the anchor point of the layer&#x27;s</span><br><span class="hljs-comment"> * bounds rect is aligned to. Defaults to the zero point. Animatable. */</span><br><br><span class="hljs-variable">@property</span> CGPoint position;<br><br></code></pre></td></tr></table></figure><p>æ­¤å±æ€§ä¹Ÿæ˜¯<code>CGPoint</code>ç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªç‚¹ï¼Œå³ layer çš„<code>é”šç‚¹</code>åœ¨å…¶çˆ¶å›¾å±‚ä¸­å¯¹åº”çš„ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´<code>anchorPoint</code>ä¸<code>position</code>ä¸¤ä¸ªç‚¹æ˜¯é‡åˆçš„ï¼Œåªä¸è¿‡å‰è€…åœ¨è‡ªèº«åæ ‡ç³»ç»Ÿå†…ï¼Œåè€…åœ¨çˆ¶å›¾å±‚å†…ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œä½ å¯ä»¥å°† layer æƒ³è±¡æˆä¸€å¼ ä¾¿ç­¾çº¸ï¼Œ<code>anchorPoint</code>æ˜¯ç”¨æ¥å›ºå®šä¾¿ç­¾çº¸çš„ä¸€æšå›¾é’‰ï¼Œå›¾é’‰å¯ä»¥æ‰åœ¨ä¾¿ç­¾çº¸è‡ªèº«èŒƒå›´å†…çš„ä»»ä½•ä½ç½®ä¸Šï¼›<code>position</code>è¡¨ç¤ºé»‘æ¿ä¸Šçš„ä¸€ä¸ªç‚¹ï¼Œä¾¿ç­¾çº¸ä¼šè¢«å›¾é’‰é’‰åœ¨é»‘æ¿ä¸Šï¼Œè€Œé’‰åœ¨é»‘æ¿ä¸Šçš„è¿™ä¸ªç‚¹å°±æ˜¯<code>position</code>ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><p><code>bounds = (0, 0, 50, 50)</code>ï¼Œ<code>position = (0, 0)</code>ï¼Œ<code>anchorPoint = (0,0)</code>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_position_anchor1.png" alt="æ•ˆæœå›¾1"></p><p><code>bounds = (0, 0, 50, 50)</code>ï¼Œ<code>position = (0, 0)</code>ï¼Œ<code>anchorPoint = (0.5,0.5)</code>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_position_anchor2.png" alt="æ•ˆæœå›¾2"></p><p><code>bounds = (0, 0, 100, 100)</code>ï¼Œ<code>position = (0, 0)</code>ï¼Œ<code>anchorPoint = (0.5,0.5)</code>ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_position_anchor3.png" alt="æ•ˆæœå›¾3"></p><p><code>bounds = (0, 0, 50, 50)</code>ï¼Œ<code>position = (0, 0)</code>ï¼Œ<code>anchorPoint = (0,0)</code>ï¼Œ<code>affineTransform = (M_PI / 4.0);</code>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_position_anchor4.png" alt="æ•ˆæœå›¾4"></p><p><strong>ç»“è®ºï¼š</strong>CALayer åœ¨å…¶<code>superlayer</code>ä¸Šçš„<code>frame</code>æ˜¯ç”±å…¶è‡ªå·±çš„<code>bounds</code>ã€<code>position</code>å’Œ<code>anchorPoint</code>åŠ<code>affineTransform</code>ç­‰å±æ€§å…±åŒå†³å®šçš„ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/documentation/quartzcore/calayer?language=objc">Â©Apple-CALayer</a></p><p>#<a href="https://developer.apple.com/documentation/quartzcore/cashapelayer">Â©AppleDev-CAShapelayer</a></p><p>#<a href="https://www.jianshu.com/p/c49833c04362">Â©thinkq-å…³äºdrawRect</a></p><p>#<a href="https://blog.csdn.net/catsmen/article/details/46546897">Â©catsmen-éšå¼åŠ¨ç”»å’Œæ˜¾å¼åŠ¨ç”»</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>+load ä¸ +initialize</title>
    <link href="/2017/12/25/load-initialize.html"/>
    <url>/2017/12/25/load-initialize.html</url>
    
    <content type="html"><![CDATA[<p>æœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µï¼Œæˆ–è€…ç±»åˆå§‹åŒ–ä¹‹å‰å¤„ç†ä¸€äº›æŒ‡å®šçš„éœ€æ±‚ï¼Œè¿™æ—¶ä½ å¯èƒ½éœ€è¦è¿™ä¿©æ–¹æ³•ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">+ (<span class="hljs-type">void</span>)<span class="hljs-keyword">load</span>;<br>+ (<span class="hljs-type">void</span>)initialize;<br></code></pre></td></tr></table></figure><h3 id="1-load"><a href="#1-load" class="headerlink" title="1.load"></a>1.load</h3><blockquote><p>Invoked whenever a class or category is added to the Objective-C runtime; implement this method to perform class-specific behavior upon loading.</p></blockquote><h4 id="1-1-è§¦å‘æ—¶æœº"><a href="#1-1-è§¦å‘æ—¶æœº" class="headerlink" title="1.1.è§¦å‘æ—¶æœº"></a>1.1.è§¦å‘æ—¶æœº</h4><ol><li>dyld åŠ è½½é•œåƒæ–‡ä»¶ï¼›</li><li>åˆå§‹åŒ–runtimeï¼›</li><li>æ³¨å†ŒOCç±»ä¸åˆ†ç±»ï¼›</li><li><code>+load</code>ã€‚</li></ol><p><img src="https://davidlii.nos-eastchina1.126.net/pic_call_load.png" alt="+load"></p><p>æ‰€ä»¥ï¼Œ<code>+load</code>æ˜¯åœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µï¼Œå³åŠ è½½åº”ç”¨å¯æ‰§è¡Œæ–‡ä»¶æ—¶ã€è¿›å…¥ç¨‹åºä¸»å…¥å£å‰è§¦å‘çš„ã€‚</p><h4 id="1-2-è°ƒç”¨é¡ºåº"><a href="#1-2-è°ƒç”¨é¡ºåº" class="headerlink" title="1.2.è°ƒç”¨é¡ºåº"></a>1.2.è°ƒç”¨é¡ºåº</h4><p><code>çˆ¶ç±»</code>-&gt;<code>å­ç±»</code>-&gt;<code>åˆ†ç±»</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//çˆ¶ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Initializer</span></span><br>+ (<span class="hljs-type">void</span>)load&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ super loaded~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//å­ç±»1</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">SubInitializer</span> : <span class="hljs-title">Initializer</span></span><br><span class="hljs-keyword">@end</span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">SubInitializer</span></span><br>+(<span class="hljs-type">void</span>)load&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ SubInitializer loaded~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//å­ç±»2</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">SubInitializer2</span> : <span class="hljs-title">Initializer</span></span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">SubInitializer2</span></span><br>+(<span class="hljs-type">void</span>)load&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ SubInitializer2 loaded~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//åˆ†ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Initializer</span> (<span class="hljs-title">Category</span>)</span><br><span class="hljs-keyword">@end</span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Initializer</span> (<span class="hljs-title">Category</span>)</span><br>+(<span class="hljs-type">void</span>)load&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ category loaded~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span> <span class="hljs-comment">super loaded~</span><br><span class="hljs-literal">++++</span> <span class="hljs-comment">SubInitializer2 loaded~</span><br><span class="hljs-literal">+++</span> <span class="hljs-comment">SubInitializer loaded~</span><br><span class="hljs-literal">++++</span> <span class="hljs-comment">category loaded~</span><br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼š</p><ul><li>çˆ¶ç±»å’Œå­ç±»éƒ½é‡å†™æ­¤æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè§¦å‘ï¼Œä¸”å­ç±»æ™šäºçˆ¶ç±»è§¦å‘ï¼›</li><li>åŸç±»å’Œåˆ†ç±»éƒ½é‡å†™æ­¤æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè§¦å‘ï¼Œä¸”åˆ†ç±»æ™šäºåŸç±»è§¦å‘ï¼›</li><li>çˆ¶ç±»å­ç±»å’Œå®ƒä»¬çš„åˆ†ç±»éƒ½é‡å†™æ­¤æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šè§¦å‘ï¼Œé¡ºåºä¸ºï¼šçˆ¶ç±» &gt; å­ç±» &gt; å­ç±»åˆ†ç±» &gt; çˆ¶ç±»åˆ†ç±»ï¼›</li><li>ä¸åœ¨åŒä¸€ç»§æ‰¿æ ‘ä¸Šçš„ç±»ä¹‹é—´çš„è§¦å‘é¡ºåºä¸ç¡®å®šï¼›</li></ul><h4 id="1-3-ç¤ºä¾‹"><a href="#1-3-ç¤ºä¾‹" class="headerlink" title="1.3.ç¤ºä¾‹"></a>1.3.ç¤ºä¾‹</h4><p>æ£€æµ‹æ·»åŠ åˆ°æ•°ç»„ä¸­çš„å¯¹è±¡æ˜¯å¦ä¸º nilï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NSMutableArray</span> (<span class="hljs-title">Extension</span>)</span><br><br>+(<span class="hljs-type">void</span>)load&#123;<br>    [<span class="hljs-keyword">self</span> swizzle];<br>&#125;<br><br>+ (<span class="hljs-type">void</span>)swizzle<br>&#123;<br>    Method method1 = class_getInstanceMethod(objc_getClass(<span class="hljs-string">&quot;__NSArrayM&quot;</span>), <span class="hljs-keyword">@selector</span>(addObject:));<br>    Method method2 = class_getInstanceMethod(objc_getClass(<span class="hljs-string">&quot;__NSArrayM&quot;</span>), <span class="hljs-keyword">@selector</span>(s_ddObject:));<br>    <span class="hljs-comment">//äº¤æ¢æ–¹æ³•</span><br>    method_exchangeImplementations(method1, method2);<br>&#125;<br><br>-(<span class="hljs-type">void</span>)s_ddObject:(<span class="hljs-type">id</span>)anObject<br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">nil</span> == anObject)&#123;<br>        <span class="hljs-keyword">@try</span> &#123;<br>            [<span class="hljs-keyword">self</span> s_ddObject:anObject];<br>        &#125; <span class="hljs-keyword">@catch</span> (<span class="hljs-built_in">NSException</span> *exception) &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Crash reason:\n %@&quot;</span>, [exception callStackSymbols]);<br>        &#125; <span class="hljs-keyword">@finally</span> &#123;&#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        [<span class="hljs-keyword">self</span> s_ddObject:anObject];<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>äº¤æ¢æ–¹æ³•ä¹‹åï¼Œè°ƒç”¨<code>addObject:</code>å®é™…ä¸Šä¼šå»è°ƒç”¨<code>s_ddObject:</code>ï¼›è€Œ<code>s_ddObject:</code>å†…è°ƒç”¨<code>s_ddObject:</code>å®é™…ä¸Šæ˜¯è°ƒç”¨æ•°ç»„çš„<code>addObject:</code>æ–¹æ³•ï¼›æ‰€ä»¥<code>s_ddObject</code>å®é™…ä¸Šèµ·åˆ°äº†ä¸­é—´å±‚çš„ä½œç”¨ï¼Œç”¨æ¥åšå¼‚å¸¸çš„æ£€æµ‹å’Œå…¶ä»–ä»»åŠ¡ã€‚<br><br/></p><p>éšåé€šè¿‡<code>+load</code>å‡½æ•°åœ¨ç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œè¯¥æ›¿æ¢è¿‡ç¨‹ã€‚ä¸‹é¢æ˜¯è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;NSMutableArray+Extension.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSMutableArray</span> *mutArr = [<span class="hljs-built_in">NSMutableArray</span> array];<br>    [mutArr addObject:<span class="hljs-literal">nil</span>];<span class="hljs-comment">//æ·»åŠ nilä¹Ÿä¸ä¼šå´©äº†</span><br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·å†å¾€æ•°ç»„ä¸­æ·»åŠ  nil å¯¹è±¡æ—¶ï¼Œå°±ä¸å†ä¼šå´©æºƒï¼Œå¹¶ä¸”ä¸€æ—¦å‘ç° nil å¯¹è±¡å°±ä¼šå°†ä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚<br><br/></p><p>éœ€è¦æ³¨æ„ï¼Œä¸å®œåœ¨<code>+load</code>å†…å¤„ç†å¤æ‚ä»»åŠ¡ï¼Œè¿™ä¼šå‡æ…¢åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ã€‚ä¼˜åŒ–åº”ç”¨å¯åŠ¨æ—¶é—´æ—¶ï¼Œä¹Ÿå¯ä»è¿™é‡Œå…¥æ‰‹ã€‚</p><h3 id="2-initialize"><a href="#2-initialize" class="headerlink" title="2.initialize"></a>2.initialize</h3><blockquote><p>The runtime sends initialize to each class in a program just before the class, or any class that inherits from it, is sent its first message from within the program. Superclasses receive this message before their subclasses.</p></blockquote><h4 id="2-1-è§¦å‘æ—¶æœº"><a href="#2-1-è§¦å‘æ—¶æœº" class="headerlink" title="2.1.è§¦å‘æ—¶æœº"></a>2.1.è§¦å‘æ—¶æœº</h4><p>åœ¨ç±»æˆ–å…¶å­ç±»æ”¶åˆ°ç¬¬ä¸€ä¸ªæ¶ˆæ¯ä¹‹å‰è°ƒç”¨ï¼›å¦‚æœç±»ä¸€ç›´æ²¡è¢«è°ƒç”¨ï¼Œåˆ™<code>+initialize</code>ä¸€ç›´ä¸ä¼šè§¦å‘ï¼›</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_call_initialize.png" alt="+load"></p><h4 id="2-2-è°ƒç”¨é¡ºåº"><a href="#2-2-è°ƒç”¨é¡ºåº" class="headerlink" title="2.2.è°ƒç”¨é¡ºåº"></a>2.2.è°ƒç”¨é¡ºåº</h4><p><code>çˆ¶ç±»</code>-&gt;<code>å­ç±»</code>ï¼›åˆ†ç±»è¦†ç›–åŸç±»ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;Initializer.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Initializer</span></span><br><br>+(<span class="hljs-type">void</span>)initialize<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ super Initialized~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">SubInitializer</span> : <span class="hljs-title">Initializer</span></span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">SubInitializer</span></span><br>+(<span class="hljs-type">void</span>)initialize&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ SubInitializer Initialized~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//åˆ†ç±»</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Initializer</span> (<span class="hljs-title">Category</span>)</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Initializer</span> (<span class="hljs-title">Category</span>)</span><br>+(<span class="hljs-type">void</span>)initialize&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ category Initialized~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨åŠæ—¥å¿—ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>è°ƒç”¨<br>SubInitializer *subInitial = [[SubInitializer alloc] init];<br><span class="hljs-regexp">//</span>æ—¥å¿—<br>++++ category Initialized~<br>+++ SubInitializer Initialized~<br></code></pre></td></tr></table></figure><ul><li>åŸç±»å’Œåˆ†ç±»éƒ½é‡å†™æ­¤æ–¹æ³•æ—¶ï¼Œåªæœ‰åˆ†ç±»ä¸­çš„ä¼šè§¦å‘ï¼Œå› ä¸ºæŸ¥è¯¢æ–¹æ³•åˆ—è¡¨æ—¶å…ˆæŸ¥åˆ°çš„æ˜¯åˆ†ç±»ä¸­çš„ initializeï¼›</li><li>çˆ¶ç±»é‡å†™è€Œå­ç±»æœªé‡å†™æ­¤æ–¹æ³•æ—¶ï¼Œå¯¹äºæ¯ä¸ªå­ç±»ï¼Œç¬¬ä¸€æ¬¡å‘å…¶å‘é€æ¶ˆæ¯æ—¶ï¼Œéƒ½ä¼šè§¦å‘çˆ¶ç±»ä¸­çš„ initializeï¼Œæ‰€ä»¥çˆ¶ç±»çš„ initialize å¯èƒ½ä¼šè§¦å‘å¤šæ¬¡ï¼›</li><li>çˆ¶ç±»å’Œå­ç±»éƒ½é‡å†™æ­¤æ–¹æ³•ï¼Œé¦–æ¬¡å‘çˆ¶ç±»å‘é€æ¶ˆæ¯ï¼Œåˆ™åªä¼šè§¦å‘çˆ¶ç±»ä¸­çš„æ–¹æ³•ï¼›é¦–æ¬¡å‘å­ç±»å‘é€æ¶ˆæ¯ï¼Œåˆ™ä¸¤ä¸ªéƒ½ä¼šè§¦å‘ä¸”å­ç±»æ™šäºçˆ¶ç±»ï¼›å…ˆåå‘å­å’Œç±»çˆ¶ç±»å‘é€æ¶ˆæ¯ï¼Œåˆ™è°ƒç”¨åˆ°çˆ¶ç±»æ—¶åªè§¦å‘çˆ¶ç±»çš„ initializeï¼›è°ƒç”¨åˆ°å­ç±»æ—¶åªè§¦å‘å­ç±»çš„ initializeï¼ˆå› ä¸ºçˆ¶ç±»ä¸­çš„ initialize å·²ç»è§¦å‘è¿‡äº†ï¼‰ã€‚</li></ul><p>æ³¨æ„ï¼šçˆ¶ç±»ä¸­çš„<code>+initialize</code>å¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨ï¼Œè‹¥åœ¨çˆ¶ç±»çš„<code>+initialize</code>ä¸­å•ç‹¬å¤„ç†æŸäº›éœ€æ±‚ï¼Œè¦åšå¥½åˆ¤æ–­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Initializer</span></span><br><br>+(<span class="hljs-type">void</span>)initialize<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++class \&quot;%@\&quot; initialized~&quot;</span>,[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> == [Initializer <span class="hljs-keyword">self</span>]) &#123;<br>        <span class="hljs-comment">// ... do the initialization ...</span><br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å¦å¤–ï¼Œ<code>+initialize</code>æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ runtime åœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨æ­¤æ–¹æ³•åï¼Œå…¶ä»–çº¿ç¨‹ä¸­éœ€è¦å‘æ­¤ç±»å‘é€æ¶ˆæ¯æ—¶éƒ½ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°<code>+initialize</code>æ‰§è¡Œå®Œæ¯•ã€‚æ‰€ä»¥ï¼Œæ­¤æ–¹æ³•å†…ä¸é€‚åˆç”¨æ¥å¤„ç†å¤æ‚çš„ä»»åŠ¡ï¼Œå¯ç”¨æ¥åˆå§‹åŒ–å…¨å±€å˜é‡ã€‚</p><h4 id="2-3-ç¤ºä¾‹"><a href="#2-3-ç¤ºä¾‹" class="headerlink" title="2.3.ç¤ºä¾‹"></a>2.3.ç¤ºä¾‹</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//Initializer.h</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><br><span class="hljs-built_in">UIKIT_EXTERN</span> <span class="hljs-type">int</span> aGlobalInt;<br><span class="hljs-built_in">UIKIT_EXTERN</span> <span class="hljs-built_in">NSString</span> *className;<br><span class="hljs-built_in">UIKIT_EXTERN</span> <span class="hljs-built_in">NSMutableDictionary</span> *paramDic;<br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Initializer</span> : <span class="hljs-title">NSObject</span></span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//Initializer.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;Initializer.h&quot;</span></span><br><br><span class="hljs-type">int</span> aGlobalInt = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">NSString</span> *className = <span class="hljs-string">@&quot;defaultName&quot;</span>;<br><span class="hljs-built_in">NSMutableDictionary</span> *paramDic = <span class="hljs-literal">nil</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Initializer</span></span><br><br>+(<span class="hljs-type">void</span>)initialize<br>&#123;<br>    paramDic = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>    <br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> == [Initializer <span class="hljs-keyword">self</span>]) &#123;<br>        aGlobalInt = <span class="hljs-number">1</span>;<br>        className = <span class="hljs-string">@&quot;Initializer&quot;</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        aGlobalInt = <span class="hljs-number">2</span>;<br>        className = <span class="hljs-built_in">NSStringFromClass</span>([<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]);<br>    &#125;<br>    paramDic[<span class="hljs-string">@&quot;name&quot;</span>] = className;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨åŠæ—¥å¿—ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//è°ƒç”¨</span><br>Initializer *initial = <span class="hljs-literal">[[I<span class="hljs-identifier">nitializer</span> <span class="hljs-identifier">alloc</span>]</span> init];<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++Int:%d, String:%@, Dic:%@&quot;</span>,<span class="hljs-params">aGlobalInt</span>,<span class="hljs-params">className</span>,<span class="hljs-params">paramDic</span>)</span>;<br><span class="hljs-comment">//æ—¥å¿—</span><br>++++Int:<span class="hljs-number">1</span>, String:Initializer, Dic:&#123;<br>    name = Initializer;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-æ¯”è¾ƒ"><a href="#3-æ¯”è¾ƒ" class="headerlink" title="3.æ¯”è¾ƒ"></a>3.æ¯”è¾ƒ</h3><p>ä»è§¦å‘çš„æ—¶é—´åºåˆ—ä¸Šæ¥çœ‹ï¼š</p><ul><li><code>+load</code> å‘ç”Ÿåœ¨äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½é˜¶æ®µï¼Œåœ¨ UIApplicationMain è¿™ä¸ªç¨‹åºä¸»å…¥å£ä¹‹å‰ï¼›</li><li><code>+initialize</code> å‘ç”Ÿåœ¨ç¨‹åºå®Œå…¨å¯åŠ¨ä¹‹åï¼Œä¹Ÿå°±æ˜¯åœ¨ <code>+load</code> ä¹‹åã€‚</li></ul><p>ä»å„ç±»ä¸­æ–¹æ³•çš„åŠ è½½é¡ºåºæ¥çœ‹ï¼š</p><ul><li><code>load</code> å‘ç”Ÿåœ¨åŠ è½½é•œåƒæœŸé—´ï¼Œå„ç±»çš„ <code>load</code> æ–¹æ³•åŠ è½½é¡ºåºä¸ç¡®å®šï¼Œæ‰€ä»¥ä¸å»ºè®®åœ¨ä¸€ä¸ªç±»ä¸­è°ƒç”¨å¦ä¸€ä¸ªç±»ï¼›</li><li><code>initialize</code> åœ¨ç¨‹åºå¯åŠ¨ä¹‹åï¼Œç±»å‡å·²åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­åˆ›å»ºå’ŒåŠ è½½ï¼Œæ‰€ä»¥å¯ä»¥æ­£å¸¸è°ƒç”¨ã€‚</li></ul><p>ä»è§¦å‘æ¬¡æ•°ä¸Šæ¥çœ‹ï¼š</p><ul><li><code>load</code> åœ¨å¯åŠ¨é˜¶æ®µä¼šå…¨éƒ¨è§¦å‘ï¼Œä¸”æ¯ä¸ª<code>load</code>åªä¼šè§¦å‘ä¸€æ¬¡ï¼›</li><li><code>initialize</code> åªåœ¨è°ƒç”¨å½“å‰ç±»æ—¶æ‰ä¼šè§¦å‘ï¼Œä¸è°ƒç”¨åˆ™æ°¸è¿œä¸è§¦å‘ï¼›çˆ¶ç±»ä¸­çš„<code>initialize</code>å¯èƒ½ä¼šè§¦å‘å¤šæ¬¡ï¼›</li></ul><p>è°ƒç”¨é¡ºåºä¸Šï¼š</p><ul><li>ä¸¤ä¸ªæ–¹æ³•åœ¨çˆ¶ç±»ã€å­ç±»å’Œåˆ†ç±»ç­‰æƒ…å†µä¸‹çš„è°ƒç”¨é¡ºåºæœ‰æ‰€ä¸åŒï¼Œæ³¨æ„åŒºåˆ†~</li></ul><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/documentation/objectivec/nsobject/1418815-load?language=objc">Â©AppleDev-load</a></p><p>#<a href="https://developer.apple.com/documentation/objectivec/nsobject/1418639-initialize?language=objc">Â©AppleDev-initialize</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ„é€ å‡½æ•°</title>
    <link href="/2017/12/24/initializer.html"/>
    <url>/2017/12/24/initializer.html</url>
    
    <content type="html"><![CDATA[<h3 id="1ã€æŒ‡å®šæ„é€ å‡½æ•°ï¼ˆDesignated-Initializerï¼‰"><a href="#1ã€æŒ‡å®šæ„é€ å‡½æ•°ï¼ˆDesignated-Initializerï¼‰" class="headerlink" title="1ã€æŒ‡å®šæ„é€ å‡½æ•°ï¼ˆDesignated Initializerï¼‰"></a>1ã€æŒ‡å®šæ„é€ å‡½æ•°ï¼ˆDesignated Initializerï¼‰</h3><p>åœ¨ OC çš„å¾ˆå¤šå¤´æ–‡ä»¶ä¸­ï¼Œéƒ½ä¼šå‡ºç°<code>NS_DESIGNATED_INITIALIZER</code>è¿™ä¸ªå®ï¼Œå¦‚ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-keyword">instancetype</span>)initWithNibName:(<span class="hljs-built_in">NSString</span> *)nibNameOrNil<br>bundle:(<span class="hljs-built_in">NSBundle</span> *)nibBundleOrNil <span class="hljs-built_in">NS_DESIGNATED_INITIALIZER</span>;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå®å°±æ˜¯ â€œæŒ‡å®šæ„é€ å‡½æ•°â€ çš„æ ‡å¿—ï¼Œå®ƒç”¨æ¥å‘Šè¯‰è°ƒç”¨è€…ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥åˆå§‹åŒ–ç±»å¯¹è±¡ã€‚ä¸€ä¸ªç±»å¯ä»¥å®šä¹‰å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œä¸åŒçš„æ„é€ æ–¹æ³•å¯ä»¥ä¼ å…¥ä¸åŒçš„å‚æ•°ï¼Œæˆ–è€…é€šè¿‡ä¸åŒçš„æ–¹å¼æ¥åˆå§‹åŒ–ä¸€ä¸ªç±»å¯¹è±¡ï¼ŒæŒ‡å®šæ„é€ å‡½æ•°é€šå¸¸æ˜¯å‚æ•°æœ€å¤šçš„æ„é€ å‡½æ•°ã€‚ä¸€ä¸ªç±»å¿…é¡»æœ‰ä¸€ä¸ªæŒ‡å®šæ„é€ å™¨ï¼Œä½†å¹¶ä¸æ˜¯è¯´åªèƒ½æœ‰ä¸€ä¸ªã€‚å¦‚æœå¿…è¦ï¼Œä½ å¯ä»¥å£°æ˜å¤šä¸ªï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ä¸€ä¸ªå°±è¶³å¤Ÿäº†ã€‚<br><br/></p><p>æœ‰æ—¶å€™ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬æƒ³ä½¿ç”¨å°½é‡å°‘æˆ–è€…ä¸ç”¨å‚æ•°ï¼Œå°±èƒ½åˆ›å»ºä¸€ä¸ªç±»å¯¹è±¡ã€‚è¿™æ—¶å°±å¯ä»¥ä½¿ç”¨â€œä¾¿åˆ©æ„é€ å‡½æ•°â€æ¥è§£å†³ã€‚</p><h3 id="2ã€ä¾¿åˆ©æ„é€ å‡½æ•°ï¼ˆConvenience-Initializerï¼‰"><a href="#2ã€ä¾¿åˆ©æ„é€ å‡½æ•°ï¼ˆConvenience-Initializerï¼‰" class="headerlink" title="2ã€ä¾¿åˆ©æ„é€ å‡½æ•°ï¼ˆConvenience Initializerï¼‰"></a>2ã€ä¾¿åˆ©æ„é€ å‡½æ•°ï¼ˆConvenience Initializerï¼‰</h3><p>è¿™æ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒç”¨è€…å¿«é€Ÿåˆ›å»ºä¸€ä¸ªç±»å¯¹è±¡è€Œå®šä¹‰çš„ä¸€ç§æ„é€ å‡½æ•°ã€‚é€šå¸¸ä¼šåœ¨ä¾¿åˆ©æ„é€ å‡½æ•°ä¸­ç»™æˆå‘˜å˜é‡æä¾›ä¸€ä¸ªé»˜è®¤å€¼ã€‚<br><br/></p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Initializer</span> : <span class="hljs-title">NSObject</span></span><br>&#123;<br>    <span class="hljs-built_in">NSString</span> *aTitle;<br>    <span class="hljs-built_in">NSDate</span>   *aDate;<br>&#125;<br><br><span class="hljs-comment">//Designated Initializer</span><br>- (<span class="hljs-keyword">instancetype</span>)initWithTitle:(<span class="hljs-built_in">NSString</span> *)title<br>date:(<span class="hljs-built_in">NSDate</span>*)date <span class="hljs-built_in">NS_DESIGNATED_INITIALIZER</span>;<br><br><span class="hljs-comment">//Convenience Initializer</span><br>- (<span class="hljs-keyword">instancetype</span>)initWithTitle:(<span class="hljs-built_in">NSString</span> *)title;<br><br><span class="hljs-comment">//ä¸å¸Œæœ›è°ƒç”¨çˆ¶ç±»(NSObject)çš„è¿™ä¸ª Designated Initializer</span><br>- (<span class="hljs-keyword">instancetype</span>)init <span class="hljs-built_in">NS_UNAVAILABLE</span>;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;Initializer.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Initializer</span></span><br><br><span class="hljs-comment">//çˆ¶ç±»ï¼ˆNSObjectï¼‰çš„ Designated Initializer</span><br>- (<span class="hljs-keyword">instancetype</span>) init<br>&#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> initWithTitle:<span class="hljs-string">@&quot;defaultTitle&quot;</span>];<br>&#125;<br><br><span class="hljs-comment">//Convenience Initializer</span><br>- (<span class="hljs-keyword">instancetype</span>)initWithTitle:(<span class="hljs-built_in">NSString</span> *)title<br>&#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> initWithTitle:title date:[<span class="hljs-built_in">NSDate</span> date]];<br>&#125;<br><br><span class="hljs-comment">//Designated Initializer</span><br>- (<span class="hljs-keyword">instancetype</span>) initWithTitle:(<span class="hljs-built_in">NSString</span> *)title <br>date:(<span class="hljs-built_in">NSDate</span>*)date<br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) <span class="hljs-comment">//è°ƒç”¨çˆ¶ç±»çš„æŒ‡å®šæ„é€ å™¨</span><br>    &#123;<br>        aTitle = title;<br>        aDate  = date;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs prolog">//<span class="hljs-number">1</span><br><span class="hljs-symbol">Initializer</span> *ai1 = [[<span class="hljs-symbol">Initializer</span> alloc] init];<br>//<span class="hljs-number">2</span><br><span class="hljs-symbol">Initializer</span> *ai2 = [[<span class="hljs-symbol">Initializer</span> alloc] initWithTitle:@<span class="hljs-string">&quot;title2&quot;</span>];<br>//<span class="hljs-number">3</span><br><span class="hljs-symbol">Initializer</span> *ai3 = [[<span class="hljs-symbol">Initializer</span> alloc] initWithTitle:@<span class="hljs-string">&quot;title3&quot;</span> <br>date:[<span class="hljs-symbol">NSDate</span> date]];<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„è°ƒç”¨ç¤ºä¾‹ä¸­ï¼Œç¬¬ä¸€ç§åœ¨ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ã€‚å› ä¸ºä¸å¸Œæœ›è°ƒç”¨è€…ä½¿ç”¨æ­¤æ–¹æ³•æ¥åˆå§‹åŒ–è¿™ä¸ªç±»å¯¹è±¡ï¼Œæ‰€ä»¥å¤´æ–‡ä»¶ä¸­å·²æŠŠ<code>init</code>æ–¹æ³•å£°æ˜ä¸º<code>NS_UNAVAILABLE</code>ã€‚</p><h3 id="3ã€ä½¿ç”¨è§„èŒƒ"><a href="#3ã€ä½¿ç”¨è§„èŒƒ" class="headerlink" title="3ã€ä½¿ç”¨è§„èŒƒ"></a>3ã€ä½¿ç”¨è§„èŒƒ</h3><p>å¦‚æœå­ç±»æœ‰<code>Designated Initializer</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>Designated Initializer</code> ä¸­å¿…é¡»è°ƒç”¨å®ƒç›´æ¥çˆ¶ç±»çš„<code>Designated Initializer</code>ï¼Œå¹¶ä¸”éœ€è¦é‡å†™çˆ¶ç±»çš„<code>Designated Initializer</code>ã€‚<br><br/></p><p>å¦‚æœå­ç±»æœ‰<code>Designated Initializer</code>ï¼Œé‚£ä¹ˆ<code>Convenience Initializer</code>å¿…é¡»è°ƒç”¨è¿™ä¸ªå­ç±»ä¸­å…¶å®ƒåˆå§‹åŒ–å‡½æ•°(åŒ…æ‹¬<code>Designated Initializer</code>å’Œ å…¶ä»–<code>Convenience Initializer</code>)ï¼Œä¸èƒ½è°ƒç”¨ super çš„åˆå§‹åŒ–å‡½æ•°ã€‚<br><br/></p><p>ç”±ä¸Šå¯ä»¥æ¨ç†å‡ºï¼š</p><ul><li>Convenience Initializer åªèƒ½è°ƒç”¨è‡ªå·±ç±»ä¸­çš„å…¶ä»–åˆå§‹åŒ–æ–¹æ³•ã€‚</li><li>Designated Initializer æ‰æœ‰èµ„æ ¼è°ƒç”¨çˆ¶ç±»çš„ Designated Initializerã€‚</li><li>æ‰€æœ‰çš„ Convenience Initializer æœ€ç»ˆéƒ½ä¼šè°ƒåˆ°è¯¥ç±»çš„ Designated Initializerã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS æ–‡ä»¶ä¸‹è½½</title>
    <link href="/2017/12/22/download.html"/>
    <url>/2017/12/22/download.html</url>
    
    <content type="html"><![CDATA[<p>iOS ä¸­å®ç°æ–‡ä»¶ä¸‹è½½æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><h3 id="ä¸€-NSData"><a href="#ä¸€-NSData" class="headerlink" title="ä¸€.NSData"></a>ä¸€.NSData</h3><p>NSData æä¾›äº†ç±»æ–¹æ³•å®ç°æ–‡ä»¶ä¸‹è½½ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSURL</span>  *aUrl = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@&quot;https://example.jpg&quot;</span>];<br><span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfURL:aUrl];<br><span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> imageWithData:data];<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ç§æ–¹å¼ä¼šä¸€æ¬¡æ€§è¿”å›æ•´ä¸ªä¸‹è½½åˆ°çš„æ–‡ä»¶ï¼Œä¸”åœ¨å½“å‰çº¿ç¨‹ä¸­åŒæ­¥ä¸‹è½½æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­ä¸‹è½½æ—¶ï¼Œé‡åˆ°ç½‘ç»œçŠ¶å†µä¸ä½³çš„æƒ…å†µæ—¶ï¼Œä¼šå‡ºç°å¡é¡¿çš„ç°è±¡ã€‚</p><p>è§£å†³æ–¹æ¡ˆä¹‹ä¸€ï¼šæŠŠä¸‹è½½ä»»åŠ¡æ”¾åˆ°å¼‚æ­¥çº¿ç¨‹ä¸­è¿›è¡Œï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">dispatch_queue_t</span> downloadQueue = dispatch_queue_create(<br><span class="hljs-string">&quot;downloadQueue&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br><br><span class="hljs-built_in">dispatch_async</span>(downloadQueue, ^&#123;<br>    <span class="hljs-built_in">NSURL</span> *aUrl = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@&quot;https://example.jpg&quot;</span>];<br>    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfURL:aUrl];<br>    <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> imageWithData:data];<br>&#125;);<br></code></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•è™½ç„¶è§£å†³äº†å¡é¡¿çš„é—®é¢˜ï¼Œä½†è¿˜æœ‰å¦å¤–çš„é—®é¢˜ï¼šè¿”å›çš„ data æ˜¯åœ¨å†…å­˜ä¸­çš„ã€‚å½“ç›®æ ‡æ–‡ä»¶è¿‡å¤§æ—¶ï¼Œå†…å­˜ä¼šçˆ†æ‰ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰è¿™æ ·ä¸€ç§æ–¹æ¡ˆï¼š</p><ol><li>æ–‡ä»¶æ•°æ®èƒ½åˆ†æ‰¹è¿”å›ã€‚</li><li>è§£å†³ä¿å­˜è¿”å›çš„æ•°æ®æ—¶å†…å­˜å ç”¨è¿‡å¤§çš„æƒ…å†µã€‚</li></ol><p>å¯¹äºç¬¬1ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ NSURLConnectionã€NSURLSession ç±»æ¥è§£å†³ã€‚å®ƒä»¬éƒ½å¯ä»¥é€šè¿‡ä»£ç†æ¥ä¸æ–­æ¥æ”¶è¿”å›çš„æ•°æ®ã€‚</p><p>å¯¹äºç¬¬2ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¥æ”¶åˆ°çš„æ•°æ®ä¿å­˜åˆ°æ²™ç›’é‡Œã€‚å¾…å…¨éƒ¨æ•°æ®æ¥æ”¶å¹¶å¤„ç†å®Œæˆåï¼Œåˆ é™¤æ­¤æ²™ç›’æ–‡ä»¶å³å¯ã€‚</p><h3 id="äºŒ-NSURLConnection"><a href="#äºŒ-NSURLConnection" class="headerlink" title="äºŒ.NSURLConnection"></a>äºŒ.NSURLConnection</h3><p>é€šè¿‡ <strong>NSURLConnection</strong> å¯ä»¥å®ç°åˆ›å»ºè¿æ¥ã€è‡ªåŠ¨å‘é€è¯·æ±‚ã€é€šè¿‡ä»£ç†æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„æ•°æ®ã€‚åŒæ—¶ï¼Œå¯ä»¥å®ç°æš‚åœå’Œæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ã€‚</p><h4 id="2-1-ä¸‹è½½åŠŸèƒ½"><a href="#2-1-ä¸‹è½½åŠŸèƒ½" class="headerlink" title="2.1.ä¸‹è½½åŠŸèƒ½"></a>2.1.ä¸‹è½½åŠŸèƒ½</h4><ol><li>åˆ›å»ºä¸€ä¸ª NSURL å¯¹è±¡ï¼Œè®¾ç½®è¯·æ±‚åœ°å€ï¼›</li><li>åˆ›å»ºä¸€ä¸ª NSURLRequest å¯¹è±¡ï¼Œè®¾ç½®è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ï¼›</li><li>ä½¿ç”¨ NSURLConnection å‘é€è¯·æ±‚ï¼›</li><li>é€šè¿‡ä»£ç†æ–¹æ³•æ¥æ”¶æœåŠ¡å™¨çš„å“åº”å’Œæ•°æ®ï¼Œå†™å…¥æ²™ç›’ä¸­ï¼›</li></ol><h4 id="2-2-æš‚åœåŠŸèƒ½"><a href="#2-2-æš‚åœåŠŸèƒ½" class="headerlink" title="2.2.æš‚åœåŠŸèƒ½"></a>2.2.æš‚åœåŠŸèƒ½</h4><p>NSURLConnection æœ¬èº«å¹¶æ²¡æœ‰æš‚åœçš„ç›¸å…³å‡½æ•°ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæä¾›çš„ <code>cancel</code> æ–¹æ³•æ¥å®ç°æš‚åœåŠŸèƒ½ã€‚</p><h4 id="2-3-æ–­ç‚¹ç»­ä¼ åŠŸèƒ½"><a href="#2-3-æ–­ç‚¹ç»­ä¼ åŠŸèƒ½" class="headerlink" title="2.3.æ–­ç‚¹ç»­ä¼ åŠŸèƒ½"></a>2.3.æ–­ç‚¹ç»­ä¼ åŠŸèƒ½</h4><p>è¦å®ç°æ–­ç‚¹ç»­ä¼ ï¼Œå¯å€ŸåŠ© HTTP è¯·æ±‚å¤´çš„ <code>range</code> å­—æ®µã€‚å®ƒå¯ä»¥æŒ‡å®šæ¯æ¬¡ä»ç½‘ç»œä¸Šä¸‹è½½çš„æ•°æ®åŒ…çš„å¤§å°ã€‚<code>range</code> å­—æ®µçš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">bytes</span> = <span class="hljs-number">0</span>-<span class="hljs-number">100</span>ï¼Œ             ä»<span class="hljs-number">0</span>åˆ°<span class="hljs-number">100</span>çš„<span class="hljs-number">100</span>ä¸ªå­—èŠ‚ã€‚<br><span class="hljs-attribute">bytes</span> = <span class="hljs-number">200</span>-,               ä»<span class="hljs-number">200</span>å­—èŠ‚ä»¥åçš„æ‰€æœ‰å­—èŠ‚ã€‚<br><span class="hljs-attribute">bytes</span> = - <span class="hljs-number">500</span>,              æœ€å<span class="hljs-number">500</span>ä¸ªå­—èŠ‚ã€‚<br><span class="hljs-attribute">bytes</span> = <span class="hljs-number">200</span>-<span class="hljs-number">300</span>ï¼Œ<span class="hljs-number">500</span>-<span class="hljs-number">800</span>ï¼Œ  åŒæ—¶æŒ‡å®šå‡ ä¸ªèŒƒå›´ã€‚<br></code></pre></td></tr></table></figure><p>æ¯æ¬¡æš‚åœæ—¶ï¼Œåœ¨ <code>connection:didReceiveData:</code> å›è°ƒä¸­è®°å½•å·²ç»æ¥æ”¶åˆ°çš„æ•°æ®å¤§å°ï¼Œåœ¨æ¢å¤ä¸‹è½½æ—¶ï¼ŒæŠŠæ­¤å¤§å°å¯¹åº”çš„ <code>range</code> å­—æ®µè®¾ç½®åˆ°è¯·æ±‚å¤´ä¸­ï¼Œé‡æ–°åˆ›å»ºè¿æ¥å¹¶å‘é€è¯·æ±‚å³å¯ã€‚</p><p>å…·ä½“å¯å‚è€ƒä»¥ä¸‹ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//DataTaskTool.h</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">DataTaskTool</span>;</span><br><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">DataTaskToolDelegate</span></span><br><br>- (<span class="hljs-type">void</span>)dataTaskTool:(DataTaskTool*)tool <br>onDownloadProgress:(<span class="hljs-type">double</span>)progress;<br><br>- (<span class="hljs-type">void</span>)dataTaskTool:(DataTaskTool*)tool <br>onDownloadFinishedWithInfo:(<span class="hljs-type">id</span>)info;<br><br>- (<span class="hljs-type">void</span>)dataTaskTool:(DataTaskTool*)tool <br>onDownloadFailedWithError:(<span class="hljs-built_in">NSError</span>*)error;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DataTaskTool</span> : <span class="hljs-title">NSObject</span></span><br><br>- (<span class="hljs-keyword">instancetype</span>)initWithURL:(<span class="hljs-built_in">NSString</span>*)URL <br>delegate:(<span class="hljs-type">id</span>&lt;DataTaskToolDelegate&gt;)delegate;<br><br>- (<span class="hljs-type">void</span>)start;<br>- (<span class="hljs-type">void</span>)pause;<br>- (<span class="hljs-type">void</span>)resume;<br>- (<span class="hljs-type">void</span>)cancel;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//DataTaskTool.m</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DataTaskTool.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DataTaskTool</span> ()</span><br>&lt;<br><span class="hljs-built_in">NSURLConnectionDataDelegate</span><br>&gt;<br>&#123;<br>    <span class="hljs-built_in">NSMutableURLRequest</span> *mRequest; <span class="hljs-comment">//è¯·æ±‚å¯¹è±¡</span><br>    <span class="hljs-built_in">NSURLConnection</span> *mUrlConnection; <span class="hljs-comment">//è¿æ¥å¯¹è±¡</span><br>    <span class="hljs-built_in">NSFileHandle</span> *mFileHandle; <span class="hljs-comment">//æ–‡ä»¶ç®¡ç†</span><br>    <span class="hljs-built_in">NSString</span> *mFilePath; <span class="hljs-comment">//æ²™ç›’æ–‡ä»¶è·¯å¾„</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> mTotalContentLength; <span class="hljs-comment">//æ–‡ä»¶æ€»é•¿åº¦</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> mCurrentContentLength; <span class="hljs-comment">//å½“å‰æ¥æ”¶åˆ°çš„æ•°æ®æ€»é•¿åº¦</span><br>    <span class="hljs-type">double</span> mProgressValue; <span class="hljs-comment">//å½“å‰ä¸‹è½½è¿›åº¦å€¼</span><br>&#125;<br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">weak</span>) <span class="hljs-type">id</span> &lt;DataTaskToolDelegate&gt; delegate;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DataTaskTool</span></span><br><br>- (<span class="hljs-keyword">instancetype</span>)initWithURL:(<span class="hljs-built_in">NSString</span>*)URL <br>delegate:(<span class="hljs-type">id</span>&lt;DataTaskToolDelegate&gt;)delegate<br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init])<br>    &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == URL.length) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;<br>        _delegate = delegate;<br>        <br>        <span class="hljs-comment">//è®¾ç½®è¯·æ±‚</span><br>        mRequest = [[<span class="hljs-built_in">NSMutableURLRequest</span> alloc] <br>        initWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:URL]];<br>        <br>        mRequest.HTTPMethod = <span class="hljs-string">@&quot;GET&quot;</span>;<br>        mRequest.timeoutInterval = <span class="hljs-number">60</span>;<br>        <br>        <span class="hljs-comment">//åˆ›å»ºè¿æ¥å¯¹è±¡</span><br>        mUrlConnection = [[<span class="hljs-built_in">NSURLConnection</span> alloc] <br>        initWithRequest:mRequest <br>        delegate:<span class="hljs-keyword">self</span>];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -NSURLConnectionDataDelegate</span><br><span class="hljs-comment">//æ¥æ”¶åˆ°æœåŠ¡å™¨çš„å“åº”</span><br>-(<span class="hljs-type">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection <br>didReceiveResponse:(<span class="hljs-built_in">NSURLResponse</span> *)response<br>&#123;<br>    mTotalContentLength = response.expectedContentLength;<br>    <br>    <span class="hljs-comment">//è®¾ç½®æ–‡ä»¶è·¯å¾„</span><br>    <span class="hljs-built_in">NSString</span> *fileName = response.suggestedFilename;<br>    <span class="hljs-built_in">NSString</span>* caches = [<span class="hljs-built_in">NSSearchPathForDirectoriesInDomains</span>(<br>    <span class="hljs-built_in">NSCachesDirectory</span>, <span class="hljs-built_in">NSUserDomainMask</span>, <span class="hljs-literal">YES</span>) <br>    lastObject];<br>    <br>    mFilePath = [caches stringByAppendingPathComponent:fileName];<br>    <br>    <span class="hljs-keyword">if</span> (![[<span class="hljs-built_in">NSFileManager</span> defaultManager] fileExistsAtPath:mFilePath])<br>    &#123;<br>        [[<span class="hljs-built_in">NSFileManager</span> defaultManager] <br>        createFileAtPath:mFilePath <br>        contents:<span class="hljs-literal">nil</span> attributes:<span class="hljs-literal">nil</span>];<br>    &#125;<br>    <br>    mFileHandle = [<span class="hljs-built_in">NSFileHandle</span> fileHandleForWritingAtPath:mFilePath];<br>&#125;<br><br><span class="hljs-comment">//æ¥æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„æ•°æ®ï¼ˆæ­¤æ–¹æ³•å¯èƒ½ä¼šå›è°ƒå¤šæ¬¡ï¼‰</span><br>-(<span class="hljs-type">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection <br>didReceiveData:(<span class="hljs-built_in">NSData</span> *)data<br>&#123;<br>    <span class="hljs-comment">//ç§»åŠ¨åˆ°æ–‡ä»¶çš„ç»“å°¾</span><br>    [mFileHandle seekToEndOfFile];<br>    <span class="hljs-comment">//æ–°æ•°æ®è¿½åŠ åˆ°æ–‡ä»¶ä¸­</span><br>    [mFileHandle writeData:data];<br>    <br>    <span class="hljs-comment">//è®¡ç®—å½“å‰ä¸‹è½½è¿›åº¦</span><br>    mCurrentContentLength += data.length;<br>    mProgressValue = (<span class="hljs-type">double</span>)mCurrentContentLength / mTotalContentLength;<br>    <br>    <span class="hljs-comment">//å›è°ƒè¿›åº¦</span><br>    [_delegate dataTaskTool:<span class="hljs-keyword">self</span> onDownloadProgress:mProgressValue];<br>&#125;<br><br><span class="hljs-comment">//ä¸‹è½½å®Œæˆ</span><br>-(<span class="hljs-type">void</span>)connectionDidFinishLoading:(<span class="hljs-built_in">NSURLConnection</span> *)connection<br>&#123;<br>    <span class="hljs-comment">//ç»“æŸå†™å…¥</span><br>    [mFileHandle closeFile];<br>    <span class="hljs-built_in">NSError</span> *error = [<span class="hljs-built_in">NSError</span> new];<br>    [[<span class="hljs-built_in">NSFileManager</span> defaultManager] removeItemAtPath:mFilePath error:&amp;error];<br>    <br>    <span class="hljs-comment">//å®Œæˆå›è°ƒ</span><br>    [_delegate dataTaskTool:<span class="hljs-keyword">self</span> onDownloadFinishedWithInfo:<span class="hljs-literal">nil</span>];<br>&#125;<br><br>-(<span class="hljs-type">void</span>)connection:(<span class="hljs-built_in">NSURLConnection</span> *)connection <br>didFailWithError:(<span class="hljs-built_in">NSError</span> *)error<br>&#123;<br>    [_delegate dataTaskTool:<span class="hljs-keyword">self</span> onDownloadFailedWithError:error];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -BUSINESS API</span><br><span class="hljs-comment">//å¼€å§‹è¯·æ±‚</span><br>- (<span class="hljs-type">void</span>)start<br>&#123;<br>    [mUrlConnection start];<br>&#125;<br><br><span class="hljs-comment">//æš‚åœ</span><br>- (<span class="hljs-type">void</span>)pause<br>&#123;<br>    [mUrlConnection cancel];<br>    mUrlConnection = <span class="hljs-literal">nil</span>;<br>&#125;<br><br><span class="hljs-comment">//æ¢å¤</span><br>- (<span class="hljs-type">void</span>)resume<br>&#123;<br>    <span class="hljs-comment">//è®¾ç½®æ–­ç‚¹ä¸‹è½½çš„åŒºé—´</span><br>    <span class="hljs-built_in">NSString</span> *range = [<span class="hljs-built_in">NSString</span> stringWithFormat:<br>    <span class="hljs-string">@&quot;bytes=%lld-&quot;</span>, mCurrentContentLength];<br>    <br>    [mRequest setValue:range forHTTPHeaderField:<span class="hljs-string">@&quot;Range&quot;</span>];<br>    <br>    mUrlConnection = [[<span class="hljs-built_in">NSURLConnection</span> alloc] <br>    initWithRequest:mRequest delegate:<span class="hljs-keyword">self</span>];<br>    <br>    [mUrlConnection start];<br>&#125;<br><br><span class="hljs-comment">//å–æ¶ˆè¯·æ±‚</span><br>- (<span class="hljs-type">void</span>)cancel<br>&#123;<br>    [mUrlConnection cancel];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs excel">/*Windows10ä¸‹è½½åœ°å€<br>U<span class="hljs-symbol">RL:</span> htt<span class="hljs-symbol">ps:</span>//software-download.microsoft.com/<br><span class="hljs-built_in">db</span>/Win10_1709_Chinese(Simplified)_x32.iso?<br><span class="hljs-built_in">t</span>=e56bdb47-<span class="hljs-number">6973</span>-<span class="hljs-number">4</span>da2-<span class="hljs-number">9</span>e94-<span class="hljs-number">5</span>a6a458c9192&amp;e<br>=<span class="hljs-number">1513964531</span>&amp;h=d9ba28ed1645810206cd89e7c4675a5b<br>*/<br>DataTaskTool *tool = [[DataTaskTool alloc] <br>initWithU<span class="hljs-symbol">RL:ur</span>l delega<span class="hljs-symbol">te:se</span>lf];<br><br>[tool start];<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒiOS9ä¹‹åï¼ŒNSURLConnection å·²è¢«åºŸå¼ƒï¼Œè‹¹æœè½¬è€Œæ¨èä½¿ç”¨ NSURLSessionã€‚</p><h3 id="ä¸‰-NSURLSession"><a href="#ä¸‰-NSURLSession" class="headerlink" title="ä¸‰.NSURLSession"></a>ä¸‰.NSURLSession</h3><p>NSURLSession æ˜¯è‹¹æœåœ¨ iOS7 åä¸ºæ•°æ®ä¼ è¾“æä¾›çš„ä¸€ç³»åˆ—æ¥å£ï¼Œå®ƒæ¯” NSURLConnection æ›´å¼ºå¤§ã€‚</p><ul><li>ä»»åŠ¡éƒ½æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œæ²¡æœ‰åŒæ­¥æ‰§è¡Œçš„å•ç‹¬æ¥å£ï¼›</li><li>æ”¯æŒåå°æ•°æ®ä¸Šä¼ å’Œä¸‹è½½ï¼›</li><li>æœ‰å•ç‹¬æ¥å£æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼›</li><li>æ•°æ®ä¸‹è½½ä¼šä¿å­˜åˆ°ç¼“å­˜ç›®å½•ï¼Œè§£å†³äº†ä¸‹è½½æ—¶çš„å†…å­˜é—®é¢˜ï¼›</li><li>ä»»åŠ¡åˆ›å»ºåä¸ä¼šè‡ªåŠ¨å‘é€è¯·æ±‚ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼›</li></ul><h4 id="3-1-é…ç½®"><a href="#3-1-é…ç½®" class="headerlink" title="3.1.é…ç½®"></a>3.1.é…ç½®</h4><p>NSURLSessionConfigurationï¼Œè¿™æ˜¯ä¸€ä¸ªå®šä¹‰URLSessionçš„è¡Œä¸ºå’Œç­–ç•¥çš„é…ç½®ï¼Œæ˜¯å®ä¾‹åŒ–URLSessionå¯¹è±¡çš„å¿…å¤‡å‚æ•°ï¼›ä¸€æ—¦é…ç½®å®Œæˆåˆ™å½“å‰ä¼šè¯ä¼šä½¿ç”¨è¯¥é…ç½®çš„ä¸€ä¸ªå¤‡ä»½ï¼Œå¹¶å¿½ç•¥ä½ å¯¹åŸé…ç½®å¯¹è±¡çš„ä»»ä½•ä¿®æ”¹ï¼›å¦‚æœæƒ³ä¿®æ”¹é…ç½®ä¿¡æ¯ï¼Œä½ éœ€è¦æ›´æ–°å¯¹åº”çš„å­—æ®µå¹¶ä¸”ç”¨æ›´æ–°åçš„é…ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„URLSessionå¯¹è±¡ã€‚</p><br/><p>1ã€ä¼šè¯é…ç½®åˆ†ç±»ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">class</span>, <span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSURLSessionConfiguration</span> *defaultSessionConfiguration;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">class</span>, <span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSURLSessionConfiguration</span> *ephemeralSessionConfiguration;<br>+ (<span class="hljs-built_in">NSURLSessionConfiguration</span> *)backgroundSessionConfigurationWithIdentifier:(<span class="hljs-built_in">NSString</span> *)identifier;<br></code></pre></td></tr></table></figure><ul><li><strong>defaultSessionConfiguration</strong></li></ul><p>é»˜è®¤çš„ä¼šè¯é…ç½®ï¼Œå®ƒä¼šä½¿ç”¨ç¡¬ç›˜ç©ºé—´åšç¼“å­˜ï¼›ç”¨é’¥åŒ™ä¸²ä¿å­˜ç”¨æˆ·çš„æˆæƒä¿¡æ¯ï¼›ä¼šå°†cookieä¿å­˜åˆ°<code>shared cookie store</code>ä¸­ã€‚</p><ul><li><strong>ephemeralSessionConfiguration</strong></li></ul><p>ä¸´æ—¶ä¼šè¯é…ç½®ï¼Œä¸åšç¡¬ç›˜ç¼“å­˜ï¼Œè€Œæ˜¯ä¿å­˜åˆ°å†…å­˜RAMä¸­ï¼›ä¸ä¿å­˜ç”¨æˆ·çš„cookieå’Œè¯ä¹¦ï¼›invalidateåæ‰€æœ‰é…ç½®ä¿¡æ¯ä¼šè¢«æŠ¹å»ã€‚</p><ul><li><strong>backgroundSessionConfiguration</strong></li></ul><p>åå°ä¼šè¯é…ç½®ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªæ ‡è¯†ç¬¦ã€‚å®ƒå…è®¸åœ¨åå°æ‰§è¡Œæ•°æ®çš„ä¸Šä¼ æˆ–ä¸‹è½½ä»»åŠ¡ï¼Œä½¿ç”¨è¿™ä¸ªé…ç½®æ—¶sessionä¼šå°†æ•°æ®çš„ä¼ è¾“æ§åˆ¶æƒäº¤ç»™ç³»ç»Ÿï¼Œç³»ç»Ÿä¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä¸­å¤„ç†è¿™ä¸ªä»»åŠ¡ï¼Œå³ä½¿åº”ç”¨è¢«æŒ‚èµ·ç”šè‡³è¢«æ€æ‰æ—¶ï¼Œä»èƒ½ç»§ç»­æ•°æ®çš„ä¸Šä¼ æˆ–ä¸‹è½½ã€‚æ³¨æ„è¿™é‡Œçš„è¢«æ€æ‰æ˜¯æŒ‡è¢«ç³»ç»Ÿæ€æ‰ï¼Œå¦‚æœæ˜¯ç”¨æˆ·é€šè¿‡å¤šä»»åŠ¡ç•Œé¢ä¸»åŠ¨æ€æ‰äº†åº”ç”¨ï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç©ºå½“å‰sessionçš„æ‰€æœ‰åå°ä¼ è¾“ä»»åŠ¡ï¼Œä»»åŠ¡ä¼šæš‚åœã€‚ç”¨æˆ·éœ€è¦ä¸»åŠ¨é‡å¯åº”ç”¨ï¼Œä¹‹å‰çš„ä»»åŠ¡æ‰èƒ½ç»§ç»­ã€‚å¦‚æœåº”ç”¨æ˜¯è¢«ç³»ç»Ÿæ€æ‰å¹¶é‡å¯çš„ï¼Œé‚£ä¹ˆåº”ç”¨å†…å¯ä»¥ä½¿ç”¨ä¸ä¹‹å‰åå°ä¼šè¯é…ç½®ä¸­ç›¸åŒçš„<code>identifier</code>æ ‡è¯†ç¬¦é‡æ–°åˆ›å»ºé…ç½®å’ŒURLSessionå¯¹è±¡ï¼Œæ­¤sessionå¯¹è±¡å¯ä»¥è¿”å›åå°ä»»åŠ¡è¢«æ€æ‰æ—¶æ‰€å¤„çš„çŠ¶æ€ã€‚å…³äºåå°ä»»åŠ¡çš„å…·ä½“å®ç°ï¼Œåé¢ç« èŠ‚ä¸­ä¼šè¯¦ç»†ä»‹ç»~<br><br/></p><p>2ã€å¯é…ç½®å±æ€§</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/* identifier for the background session configuration */</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">readonly</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *identifier; <span class="hljs-comment">// åå°ä»»åŠ¡çš„æ ‡è¯†ç¬¦</span><br><br><span class="hljs-comment">/* default cache policy for requests */</span><br><span class="hljs-keyword">@property</span> <span class="hljs-built_in">NSURLRequestCachePolicy</span> requestCachePolicy; <span class="hljs-comment">// è¯·æ±‚çš„ç¼“å­˜ç­–ç•¥</span><br><br><span class="hljs-comment">/* default timeout for requests.  This will cause a timeout if no data is transmitted </span><br><span class="hljs-comment"> *for the given timeout value, and is reset whenever data is transmitted. */</span><br><span class="hljs-keyword">@property</span> <span class="hljs-built_in">NSTimeInterval</span> timeoutIntervalForRequest; <span class="hljs-comment">// è¶…æ—¶æ—¶é•¿</span><br><br><span class="hljs-comment">/* allow request to route over cellular. */</span><br><span class="hljs-keyword">@property</span> <span class="hljs-type">BOOL</span> allowsCellularAccess; <span class="hljs-comment">// æ˜¯å¦å…è®¸èœ‚çªç½‘è·¯</span><br><br><span class="hljs-comment">/* allows background tasks to be scheduled at the discretion of the system for optimal performance. */</span><br><span class="hljs-comment">// æ•°æ®é‡å¤§æ—¶ï¼Œè®©ç³»ç»Ÿè‡ªä¸»ä¼˜åŒ–åå°ä»»åŠ¡ï¼ˆæ¯”å¦‚è¿ä¸ŠWiFiå†å¼€å§‹ä¼ è¾“ï¼‰</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">getter</span>=isDiscretionary) <span class="hljs-type">BOOL</span> discretionary; <br><br><span class="hljs-comment">/* The maximum number of simultanous persistent connections per host */</span><br><span class="hljs-keyword">@property</span> <span class="hljs-built_in">NSInteger</span> HTTPMaximumConnectionsPerHost; <span class="hljs-comment">// å•ä¸ªä¸»æœºå…è®¸çš„æœ€å¤§åŒæ—¶å¹¶å‘è¿æ¥æ•°</span><br><br><span class="hljs-comment">/* The cookie storage object to use, or nil to indicate that no cookies should be handled */</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">retain</span>) <span class="hljs-built_in">NSHTTPCookieStorage</span> *HTTPCookieStorage;<br><br><span class="hljs-comment">/* The credential storage object, or nil to indicate that no credential storage is to be used */</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">retain</span>) <span class="hljs-built_in">NSURLCredentialStorage</span> *URLCredentialStorage;<br><br><span class="hljs-comment">/* The URL resource cache, or nil to indicate that no caching is to be performed */</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">retain</span>) <span class="hljs-built_in">NSURLCache</span> *URLCache;<br></code></pre></td></tr></table></figure><h4 id="3-2-åˆ›å»ºä¼šè¯"><a href="#3-2-åˆ›å»ºä¼šè¯" class="headerlink" title="3.2.åˆ›å»ºä¼šè¯"></a>3.2.åˆ›å»ºä¼šè¯</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-built_in">NSURLSession</span> *)sessionWithConfiguration:(<span class="hljs-built_in">NSURLSessionConfiguration</span> *)configuration;<br>+ (<span class="hljs-built_in">NSURLSession</span> *)sessionWithConfiguration:(<span class="hljs-built_in">NSURLSessionConfiguration</span> *)configuration <br>                                  delegate:(<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span> &lt;<span class="hljs-built_in">NSURLSessionDelegate</span>&gt;)delegate <br>                             delegateQueue:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSOperationQueue</span> *)queue;<br></code></pre></td></tr></table></figure><ul><li><strong>å‚æ•°1</strong>ï¼šconfiguration</li></ul><p>é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬cookieã€ç¼“å­˜ç­–ç•¥ã€ä»£ç†ã€è¶…æ—¶ã€è¯ä¹¦é…ç½®ç­‰ï¼›</p><ul><li><strong>å‚æ•°2</strong>ï¼šdelegate</li></ul><p>ä¼šè¯çš„ä»£ç†å¯¹è±¡ï¼Œå¤„ç†é‰´æƒã€ç¼“å­˜ç­–ç•¥ç­‰äº‹å®œï¼Œåœ¨AFNä¸­æ˜¯AFURLSessionManagerç±»ï¼›</p><blockquote><p>The session object keeps a strong reference to the delegate until your app exits or explicitly invalidates the session. If you do not invalidate the session by calling the invalidateAndCancel or finishTasksAndInvalidate method, your app leaks memory until it exits.</p></blockquote><p>æ³¨æ„ï¼šsessionä¼šå¼ºå¼•ç”¨ delegate å¯¹è±¡ç›´åˆ°é€šè¿‡<code>invalidateAndCancel</code>æˆ–<code>finishTasksAndInvalidate</code>å°†sessionç½®ä¸ºæ— æ•ˆï¼Œå¦‚æœä¸å°†sessionä½œåºŸå°±ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚</p><ul><li><strong>å‚æ•°3</strong>ï¼šqueue</li></ul><p>ä»£ç†æ‰€å¤„çš„é˜Ÿåˆ—ï¼Œå¯ä»¥æ˜¯ä¸»é˜Ÿåˆ—æˆ–æˆ‘ä»¬åˆ›å»ºçš„ç§æœ‰é˜Ÿåˆ—ã€‚</p><blockquote><p>An operation queue for scheduling the delegate calls and completion handlers. The queue should be a serial queue, in order to ensure the correct ordering of callbacks. If nil, the session creates a serial operation queue for performing all delegate method calls and completion handler calls.</p></blockquote><p>æ³¨æ„ï¼šqueueå‚æ•°å¿…é¡»æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯å›è°ƒçš„é¡ºåºã€‚å¦‚æœä¸ºnilåˆ™sessionä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æ‰§è¡Œä»£ç†ã€‚</p><h4 id="3-3-åˆ›å»ºä»»åŠ¡"><a href="#3-3-åˆ›å»ºä»»åŠ¡" class="headerlink" title="3.3.åˆ›å»ºä»»åŠ¡"></a>3.3.åˆ›å»ºä»»åŠ¡</h4><p>URLSessionæä¾›äº†æ•°æ®ä¸‹è½½å’Œä¸Šä¼ ç›¸å…³çš„APIï¼Œé€šè¿‡ä¸åŒæ¥å£å¯ä»¥åˆ›å»ºä¸åŒç±»å‹çš„ä»»åŠ¡ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// æ™®é€šä»»åŠ¡ï¼Œè¿”å›çš„æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸æ”¯æŒåå°ä»»åŠ¡</span><br>- (<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTaskWithURL:(<span class="hljs-built_in">NSURL</span> *)url;<br><br><span class="hljs-comment">// ä¸Šä¼ ä»»åŠ¡ï¼Œæ”¯æŒåå°ä¸Šä¼ </span><br>- (<span class="hljs-built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request fromData:(<span class="hljs-built_in">NSData</span> *)bodyData;<br><br><span class="hljs-comment">// ä¸‹è½½ä»»åŠ¡ï¼Œä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œæ”¯æŒåå°ä¸‹è½½</span><br>- (<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithURL:(<span class="hljs-built_in">NSURL</span> *)url;<br><br><span class="hljs-comment">// æ•°æ®æµä»»åŠ¡ï¼Œä»æŒ‡å®šçš„æœåŠ¡å™¨å’Œç«¯å£å»ºç«‹ä¸€ä¸ª TCP/IP è¿æ¥</span><br>- (<span class="hljs-built_in">NSURLSessionStreamTask</span> *)streamTaskWithHostName:(<span class="hljs-built_in">NSString</span> *)hostname port:(<span class="hljs-built_in">NSInteger</span>)port;<br></code></pre></td></tr></table></figure><p>æ¯ä¸ªNSURLSessionå¯¹è±¡å¯ä»¥åŒ…å«å¤šä¸ªä»»åŠ¡ï¼Œç±»ä¼¼äºæµè§ˆå™¨ä¸­å¤šä¸ªçª—å£å¯ä»¥åˆ†åˆ«å¤„ç†ç½‘é¡µæµè§ˆå’Œæ•°æ®ä¸‹è½½ç­‰ä»»åŠ¡ã€‚</p><h4 id="3-4-ä¼šè¯ä½œåºŸ"><a href="#3-4-ä¼šè¯ä½œåºŸ" class="headerlink" title="3.4.ä¼šè¯ä½œåºŸ"></a>3.4.ä¼šè¯ä½œåºŸ</h4><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">/* -finishTasksAndInvalidate returns immediately <span class="hljs-built_in">and</span> existing tasks will be allowed<br> * <span class="hljs-keyword">to</span> run <span class="hljs-keyword">to</span> completion.  <span class="hljs-built_in">New</span> tasks may <span class="hljs-built_in">not</span> be created.  The session<br> * will <span class="hljs-keyword">continue</span> <span class="hljs-keyword">to</span> make <span class="hljs-keyword">delegate</span> callbacks <span class="hljs-keyword">until</span> URLSession:didBecomeInvalidWithError:<br> * has been issued. <br> *<br> * -finishTasksAndInvalidate <span class="hljs-built_in">and</span> -invalidateAndCancel <span class="hljs-keyword">do</span> <span class="hljs-built_in">not</span><br> * have any effect <span class="hljs-keyword">on</span> the <span class="hljs-keyword">shared</span> session singleton.<br> *<br> * <span class="hljs-keyword">When</span> invalidating a background session, it <span class="hljs-built_in">is</span> <span class="hljs-built_in">not</span> safe <span class="hljs-keyword">to</span> create another background<br> * session <span class="hljs-keyword">with</span> the same identifier <span class="hljs-keyword">until</span> URLSession:didBecomeInvalidWithError: has<br> * been issued.<br> */<br>- (void)finishTasksAndInvalidate;<br></code></pre></td></tr></table></figure><p>ä½œç”¨ï¼šå°†sessionä½œåºŸï¼Œä½†å…è®¸æœªå®Œæˆçš„taskç»§ç»­æ‰§è¡Œå®Œã€‚<br><br/></p><p>æ­¤æ–¹æ³•ä¸ä¼šç­‰å¾…ä»»åŠ¡å®Œæˆè€Œç«‹åˆ»è¿”å›ï¼ŒURLSessionä¼šè¯å¯¹è±¡è°ƒç”¨æ­¤æ–¹æ³•åå°†ä¸èƒ½å†é‡ç”¨ï¼Œä¹Ÿä¸å†æ¥æ”¶æ–°çš„taskï¼Œå·²å­˜åœ¨æˆ–åœ¨æ‰§è¡Œçš„taskåˆ™ä¼šç»§ç»­æ‰§è¡Œç›´åˆ°å…¨éƒ¨å®Œæˆã€‚</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-comment">/* -invalidateAndCancel acts as -finishTasksAndInvalidate, but issues</span><br><span class="hljs-comment"> * -cancel to all outstanding tasks for this session.  Note task </span><br><span class="hljs-comment"> * cancellation is subject to the state of the task, and some tasks may</span><br><span class="hljs-comment"> * have already have completed at the time they are sent -cancel. </span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-keyword">void</span>)invalidateAndCancel;<br></code></pre></td></tr></table></figure><p>ä½œç”¨ï¼šå°†æœªå®Œæˆçš„taskå–æ¶ˆï¼ŒåŒæ—¶å°†sessionä½œåºŸã€‚<br><br/></p><p>ä¸ç¬¬ä¸€ä¸ªæ–¹æ³•çš„åŒºåˆ«åœ¨äºï¼Œæœ¬æ–¹æ³•ä¼šå–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡ã€‚æ³¨æ„ï¼ŒäºŒè€…å¯¹äº<code>NSURLSession.sharedSession</code>ä¼šè¯æ— æ•ˆã€‚</p><h4 id="3-5-ä¼šè¯åè®®"><a href="#3-5-ä¼šè¯åè®®" class="headerlink" title="3.5.ä¼šè¯åè®®"></a>3.5.ä¼šè¯åè®®</h4><p>NSURLSessionDelegateï¼Œç”¨æ¥å¤„ç†session-leveläº‹ä»¶çš„åè®®ï¼Œæ¯”å¦‚ session ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">NSURLSessionDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span><br><span class="hljs-keyword">@optional</span><br><br><span class="hljs-comment">/* The last message a session receives.  A session will only become</span><br><span class="hljs-comment"> * invalid because of a systemic error or when it has been</span><br><span class="hljs-comment"> * explicitly invalidated, in which case the error parameter will be nil.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session didBecomeInvalidWithError:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSError</span> *)error;<br><br><span class="hljs-comment">/* If implemented, when a connection level authentication challenge</span><br><span class="hljs-comment"> * has occurred, this delegate will be given the opportunity to</span><br><span class="hljs-comment"> * provide authentication credentials to the underlying</span><br><span class="hljs-comment"> * connection. Some types of authentication will apply to more than</span><br><span class="hljs-comment"> * one request on a given connection to a server (SSL Server Trust</span><br><span class="hljs-comment"> * challenges).  If this delegate message is not implemented, the </span><br><span class="hljs-comment"> * behavior will be to use the default handling, which may involve user</span><br><span class="hljs-comment"> * interaction. </span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session didReceiveChallenge:(<span class="hljs-built_in">NSURLAuthenticationChallenge</span> *)challenge<br>completionHandler:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSURLSessionAuthChallengeDisposition</span> disposition, <br><span class="hljs-built_in">NSURLCredential</span> *credential))completionHandler;<br><br><span class="hljs-comment">/* If an application has received an</span><br><span class="hljs-comment"> * -application:handleEventsForBackgroundURLSession:completionHandler:</span><br><span class="hljs-comment"> * message, the session delegate will receive this message to indicate</span><br><span class="hljs-comment"> * that all messages previously enqueued for this session have been</span><br><span class="hljs-comment"> * delivered.  At this time it is safe to invoke the previously stored</span><br><span class="hljs-comment"> * completion handler, or to begin any internal updates that will</span><br><span class="hljs-comment"> * result in invoking the completion handler.</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// åå°ä»»åŠ¡å®Œæˆæ—¶ è§¦å‘æ­¤å›è°ƒ</span><br>- (<span class="hljs-type">void</span>)URLSessionDidFinishEventsForBackgroundURLSession:(<span class="hljs-built_in">NSURLSession</span> *)session;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h4 id="3-6-Task"><a href="#3-6-Task" class="headerlink" title="3.6.Task"></a>3.6.Task</h4><p>æ•°æ®è¯·æ±‚å¯æŠ½è±¡ä¸ºä»»åŠ¡ï¼Œå³NSURLSessionTaskï¼Œè¿™æ˜¯ç½‘ç»œä»»åŠ¡çš„åŸºç±»ï¼Œä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨æ­¤ç±»ï¼Œåˆ›å»ºæ•°æ®ä»»åŠ¡å¯ä½¿ç”¨å…¶å­ç±»ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSObject</span><br>â””â”€â”€ <span class="hljs-built_in">NSURLSessionTask</span><br>    â”œâ”€â”€ <span class="hljs-built_in">NSURLSessionDataTask</span><br>    â”‚Â Â  â””â”€â”€ <span class="hljs-built_in">NSURLSessionUploadTask</span><br>    â”œâ”€â”€ <span class="hljs-built_in">NSURLSessionDownloadTask</span><br>    â””â”€â”€ <span class="hljs-built_in">NSURLSessionStreamTask</span><br></code></pre></td></tr></table></figure><p>æ¯ä¸ªç±»çš„å…·ä½“ä½œç”¨ä¸‹é¢ç« èŠ‚ä¸­ä¼šç»§ç»­ä»‹ç»~æ­¤åŸºç±»æä¾›äº†ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦ç›¸å…³çš„å±æ€§ï¼Œä»¥åŠå¼€å§‹ã€æš‚åœã€å–æ¶ˆç­‰æ¥å£ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@interface</span> <span class="hljs-attribute">NSURLSessionTask </span>: NSObject &lt;NSCopying, NSProgressReporting&gt;<br><br><span class="hljs-variable">@property</span> (readonly)                 NSUInteger    taskIdentifier;    <span class="hljs-comment">/* an identifier for this task, assigned by and unique to the owning session */</span><br><span class="hljs-variable">@property</span> (nullable, readonly, copy) NSURLRequest  *originalRequest;  <span class="hljs-comment">/* may be nil if this is a stream task */</span><br><span class="hljs-variable">@property</span> (nullable, readonly, copy) NSURLRequest  *currentRequest;   <span class="hljs-comment">/* may differ from originalRequest due to http server redirection */</span><br><span class="hljs-variable">@property</span> (nullable, readonly, copy) NSURLResponse *response;         <span class="hljs-comment">/* may be nil if no response has been received */</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * NSProgress object which represents the task progress.</span><br><span class="hljs-comment"> * It can be used for task progress tracking.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">@property</span> (readonly, strong) NSProgress *progress <span class="hljs-built_in">API_AVAILABLE</span>(<span class="hljs-built_in">macos</span>(<span class="hljs-number">10.13</span>), <span class="hljs-built_in">ios</span>(<span class="hljs-number">11.0</span>), <span class="hljs-built_in">watchos</span>(<span class="hljs-number">4.0</span>), <span class="hljs-built_in">tvos</span>(<span class="hljs-number">11.0</span>));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Start the network load for this task no earlier than the specified date. If</span><br><span class="hljs-comment"> * not specified, no start delay is used.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Only applies to tasks created from background NSURLSession instances; has no</span><br><span class="hljs-comment"> * effect for tasks created from other session types.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">@property</span> (nullable, copy) NSDate *earliestBeginDate <span class="hljs-built_in">API_AVAILABLE</span>(<span class="hljs-built_in">macos</span>(<span class="hljs-number">10.13</span>), <span class="hljs-built_in">ios</span>(<span class="hljs-number">11.0</span>), <span class="hljs-built_in">watchos</span>(<span class="hljs-number">4.0</span>), <span class="hljs-built_in">tvos</span>(<span class="hljs-number">11.0</span>));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The number of bytes that the client expects (a best-guess upper-bound) will</span><br><span class="hljs-comment"> * be sent and received by this task. These values are used by system scheduling</span><br><span class="hljs-comment"> * policy. If unspecified, NSURLSessionTransferSizeUnknown is used.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">@property</span> int64_t countOfBytesClientExpectsToSend <span class="hljs-built_in">API_AVAILABLE</span>(<span class="hljs-built_in">macos</span>(<span class="hljs-number">10.13</span>), <span class="hljs-built_in">ios</span>(<span class="hljs-number">11.0</span>), <span class="hljs-built_in">watchos</span>(<span class="hljs-number">4.0</span>), <span class="hljs-built_in">tvos</span>(<span class="hljs-number">11.0</span>));<br><span class="hljs-variable">@property</span> int64_t countOfBytesClientExpectsToReceive <span class="hljs-built_in">API_AVAILABLE</span>(<span class="hljs-built_in">macos</span>(<span class="hljs-number">10.13</span>), <span class="hljs-built_in">ios</span>(<span class="hljs-number">11.0</span>), <span class="hljs-built_in">watchos</span>(<span class="hljs-number">4.0</span>), <span class="hljs-built_in">tvos</span>(<span class="hljs-number">11.0</span>));<br><br><br><span class="hljs-comment">/* Byte count properties may be zero if no body is expected, </span><br><span class="hljs-comment"> * or NSURLSessionTransferSizeUnknown if it is not possible </span><br><span class="hljs-comment"> * to know how many bytes will be transferred.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/* number of body bytes already received */</span><br><span class="hljs-variable">@property</span> (readonly) int64_t countOfBytesReceived;<br><br><span class="hljs-comment">/* number of body bytes already sent */</span><br><span class="hljs-variable">@property</span> (readonly) int64_t countOfBytesSent;<br><br><span class="hljs-comment">/* number of body bytes we expect to send, derived from the Content-Length of the HTTP request */</span><br><span class="hljs-variable">@property</span> (readonly) int64_t countOfBytesExpectedToSend;<br><br><span class="hljs-comment">/* number of byte bytes we expect to receive, usually derived from the Content-Length header of an HTTP response. */</span><br><span class="hljs-variable">@property</span> (readonly) int64_t countOfBytesExpectedToReceive;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The taskDescription property is available for the developer to</span><br><span class="hljs-comment"> * provide a descriptive label for the task.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">@property</span> (nullable, copy) NSString *taskDescription;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The current state of the task within the session.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">@property</span> (readonly) NSURLSessionTaskState state;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The error, if any, delivered via -URLSession:task:didCompleteWithError:</span><br><span class="hljs-comment"> * This property will be nil in the event that no error occured.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-variable">@property</span> (nullable, readonly, copy) NSError *error;<br><br><span class="hljs-comment">/* -cancel returns immediately, but marks a task as being canceled.</span><br><span class="hljs-comment"> * The task will signal -URLSession:task:didCompleteWithError: with an</span><br><span class="hljs-comment"> * error value of &#123; NSURLErrorDomain, NSURLErrorCancelled &#125;.  In some </span><br><span class="hljs-comment"> * cases, the task may signal other work before it acknowledges the </span><br><span class="hljs-comment"> * cancelation.  -cancel may be sent to a task that has been suspended.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">cancel</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Suspending a task will prevent the NSURLSession from continuing to</span><br><span class="hljs-comment"> * load data.  There may still be delegate calls made on behalf of</span><br><span class="hljs-comment"> * this task (for instance, to report data received while suspending)</span><br><span class="hljs-comment"> * but no further transmissions will be made on behalf of the task</span><br><span class="hljs-comment"> * until -resume is sent.  The timeout timer associated with the task</span><br><span class="hljs-comment"> * will be disabled while a task is suspended. -suspend and -resume are</span><br><span class="hljs-comment"> * nestable. </span><br><span class="hljs-comment"> */</span><br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">suspend</span>;<br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">resume</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Sets a scaling factor for the priority of the task. The scaling factor is a</span><br><span class="hljs-comment"> * value between 0.0 and 1.0 (inclusive), where 0.0 is considered the lowest</span><br><span class="hljs-comment"> * priority and 1.0 is considered the highest.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The priority is a hint and not a hard requirement of task performance. The</span><br><span class="hljs-comment"> * priority of a task may be changed using this API at any time, but not all</span><br><span class="hljs-comment"> * protocols support this; in these cases, the last priority that took effect</span><br><span class="hljs-comment"> * will be used.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If no priority is specified, the task will operate with the default priority</span><br><span class="hljs-comment"> * as defined by the constant NSURLSessionTaskPriorityDefault. Two additional</span><br><span class="hljs-comment"> * priority levels are provided: NSURLSessionTaskPriorityLow and</span><br><span class="hljs-comment"> * NSURLSessionTaskPriorityHigh, but use is not restricted to these.</span><br><span class="hljs-comment"> */</span><br>@<span class="hljs-selector-tag">property</span> <span class="hljs-selector-tag">float</span> <span class="hljs-selector-tag">priority</span> <span class="hljs-selector-tag">API_AVAILABLE</span>(<span class="hljs-built_in">macos</span>(<span class="hljs-number">10.10</span>), <span class="hljs-built_in">ios</span>(<span class="hljs-number">8.0</span>), <span class="hljs-built_in">watchos</span>(<span class="hljs-number">2.0</span>), <span class="hljs-built_in">tvos</span>(<span class="hljs-number">9.0</span>));<br><br>@<span class="hljs-selector-tag">end</span><br></code></pre></td></tr></table></figure><ul><li>NSURLSessionTaskDelegate</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Messages related to the operation of a specific task.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">NSURLSessionTaskDelegate</span> &lt;<span class="hljs-title">NSURLSessionDelegate</span>&gt;</span><br><span class="hljs-keyword">@optional</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Sent when the system is ready to begin work for a task with a delayed start</span><br><span class="hljs-comment"> * time set (using the earliestBeginDate property). The completionHandler must</span><br><span class="hljs-comment"> * be invoked in order for loading to proceed. The disposition provided to the</span><br><span class="hljs-comment"> * completion handler continues the load with the original request provided to</span><br><span class="hljs-comment"> * the task, replaces the request with the specified task, or cancels the task.</span><br><span class="hljs-comment"> * If this delegate is not implemented, loading will proceed with the original</span><br><span class="hljs-comment"> * request.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Recommendation: only implement this delegate if tasks that have the</span><br><span class="hljs-comment"> * earliestBeginDate property set may become stale and require alteration prior</span><br><span class="hljs-comment"> * to starting the network load.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If a new request is specified, the allowsCellularAccess property from the</span><br><span class="hljs-comment"> * new request will not be used; the allowsCellularAccess property from the</span><br><span class="hljs-comment"> * original request will continue to be used.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Canceling the task is equivalent to calling the task&#x27;s cancel method; the</span><br><span class="hljs-comment"> * URLSession:task:didCompleteWithError: task delegate will be called with error</span><br><span class="hljs-comment"> * NSURLErrorCancelled.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>                        willBeginDelayedRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request<br>                              completionHandler:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSURLSessionDelayedRequestDisposition</span> disposition, <span class="hljs-built_in">NSURLRequest</span> * _Nullable newRequest))completionHandler<br>    API_AVAILABLE(macos(<span class="hljs-number">10.13</span>), ios(<span class="hljs-number">11.0</span>), watchos(<span class="hljs-number">4.0</span>), tvos(<span class="hljs-number">11.0</span>));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Sent when a task cannot start the network loading process because the current</span><br><span class="hljs-comment"> * network connectivity is not available or sufficient for the task&#x27;s request.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This delegate will be called at most one time per task, and is only called if</span><br><span class="hljs-comment"> * the waitsForConnectivity property in the NSURLSessionConfiguration has been</span><br><span class="hljs-comment"> * set to YES.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This delegate callback will never be called for background sessions, because</span><br><span class="hljs-comment"> * the waitForConnectivity property is ignored by those sessions.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session taskIsWaitingForConnectivity:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>    API_AVAILABLE(macos(<span class="hljs-number">10.13</span>), ios(<span class="hljs-number">11.0</span>), watchos(<span class="hljs-number">4.0</span>), tvos(<span class="hljs-number">11.0</span>));<br><br><span class="hljs-comment">/* An HTTP request is attempting to perform a redirection to a different</span><br><span class="hljs-comment"> * URL. You must invoke the completion routine to allow the</span><br><span class="hljs-comment"> * redirection, allow the redirection with a modified request, or</span><br><span class="hljs-comment"> * pass nil to the completionHandler to cause the body of the redirection </span><br><span class="hljs-comment"> * response to be delivered as the payload of this request. The default</span><br><span class="hljs-comment"> * is to follow redirections. </span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * For tasks in background sessions, redirections will always be followed and this method will not be called.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>                     willPerformHTTPRedirection:(<span class="hljs-built_in">NSHTTPURLResponse</span> *)response<br>                                     newRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request<br>                              completionHandler:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSURLRequest</span> * _Nullable))completionHandler;<br><br><span class="hljs-comment">/* The task has received a request specific authentication challenge.</span><br><span class="hljs-comment"> * If this delegate is not implemented, the session specific authentication challenge</span><br><span class="hljs-comment"> * will *NOT* be called and the behavior will be the same as using the default handling</span><br><span class="hljs-comment"> * disposition. </span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>                            didReceiveChallenge:(<span class="hljs-built_in">NSURLAuthenticationChallenge</span> *)challenge <br>                              completionHandler:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSURLSessionAuthChallengeDisposition</span> disposition, <span class="hljs-built_in">NSURLCredential</span> * _Nullable credential))completionHandler;<br><br><span class="hljs-comment">/* Sent if a task requires a new, unopened body stream.  This may be</span><br><span class="hljs-comment"> * necessary when authentication has failed for any request that</span><br><span class="hljs-comment"> * involves a body stream. </span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>                              needNewBodyStream:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSInputStream</span> * _Nullable bodyStream))completionHandler;<br><br><span class="hljs-comment">/* Sent periodically to notify the delegate of upload progress.  This</span><br><span class="hljs-comment"> * information is also available as properties of the task.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>                                didSendBodyData:(int64_t)bytesSent<br>                                 totalBytesSent:(int64_t)totalBytesSent<br>                       totalBytesExpectedToSend:(int64_t)totalBytesExpectedToSend;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Sent when complete statistics information has been collected for the task.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task didFinishCollectingMetrics:(<span class="hljs-built_in">NSURLSessionTaskMetrics</span> *)metrics API_AVAILABLE(macosx(<span class="hljs-number">10.12</span>), ios(<span class="hljs-number">10.0</span>), watchos(<span class="hljs-number">3.0</span>), tvos(<span class="hljs-number">10.0</span>));<br><br><span class="hljs-comment">/* Sent as the last message related to a specific task.  Error may be</span><br><span class="hljs-comment"> * nil, which implies that no error occurred and this task is complete. </span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>                           didCompleteWithError:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSError</span> *)error;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h4 id="3-7-DataTask"><a href="#3-7-DataTask" class="headerlink" title="3.7.DataTask"></a>3.7.DataTask</h4><p>NSURLSessionDataTaskï¼Œä¸Šä¼ æ•°æ®å¹¶æ¥æ”¶è¿”å›çš„æ•°æ®ï¼Œè¿”å›çš„æ•°æ®è¢«ä¿å­˜åˆ°å†…å­˜ä¸­ã€‚<br><br/></p><p>#GETè¯·æ±‚ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sharedSession];<br><span class="hljs-built_in">NSURLSessionDataTask</span> *dataTask =[session dataTaskWithURL:<br>                                 [<span class="hljs-built_in">NSURL</span> URLWithString:url]<br>                                       completionHandler:^(<span class="hljs-built_in">NSData</span> *data,<br>                                                           <span class="hljs-built_in">NSURLResponse</span> *response, <span class="hljs-built_in">NSError</span> *error)<br>&#123;<br>    <span class="hljs-comment">//dataä¸ºæœåŠ¡å™¨è¿”å›çš„æ•°æ®</span><br>    <span class="hljs-keyword">if</span> (!error) &#123;<br>        <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> imageWithData:data];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++æ–‡ä»¶å¤§å°ï¼š%lld&quot;</span>,response.expectedContentLength);<br>    &#125;<br>&#125;];<br><span class="hljs-comment">//å¯åŠ¨ä»»åŠ¡</span><br>[dataTask resume];<br></code></pre></td></tr></table></figure><p>dataTaskä¹Ÿå¯ä»¥èƒœä»» downloadTask å’Œ uploadTask çš„å·¥ä½œã€‚åŒºåˆ«åœ¨äºdataTask ä¸æ”¯æŒåå°ä¸‹è½½ã€‚<br><br/></p><p>ä¾‹å¦‚ï¼ŒdataTaskä¸€èˆ¬ç”¨æ¥ä¸Šä¼ è¡¨å•æ•°æ®ï¼Œæ¯”å¦‚å°†ç”¨æˆ·åã€å¯†ç ç­‰ä¿¡æ¯ä»¥GETçš„æ–¹å¼è¿½åŠ åˆ°è¯·æ±‚çš„RUL.queryéƒ¨åˆ†ï¼›å½“ç„¶ä¹Ÿå¯ä»¥å°†æ•°æ®ä»¥POSTè¯·æ±‚çš„æ–¹å¼è¿½åŠ åˆ°http.bodyä¸­ï¼›è¿™æ—¶ datatask çš„åŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼ uploadTaskã€‚<br><br/></p><p>è€ŒæœåŠ¡å™¨æ”¶åˆ°datataskä¸Šä¼ çš„ä¿¡æ¯åï¼Œä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€ç å’Œå¯¹åº”çš„jsonæ•°æ®ï¼Œè¿™æ—¶ dataTask çš„åŠŸèƒ½åˆæœ‰ç‚¹åƒ downloadTaskï¼›<br><br/></p><p>å°½ç®¡dataTaskå¯ä»¥åšè¿™äº›äº‹ï¼ŒURLSessionè¿˜æ˜¯å¯¹è¯·æ±‚è¿›è¡Œäº†è¯¦ç»†åˆ†ç±»ï¼Œæä¾›äº†ä¸“é—¨çš„ç±»å•ç‹¬è´Ÿè´£ä¸Šä¼ ã€ä¸‹è½½åŠæ•°æ®æµä»»åŠ¡ã€‚</p><ul><li>NSURLSessionDataDelegate</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Messages related to the operation of a task that delivers data</span><br><span class="hljs-comment"> * directly to the delegate.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">NSURLSessionDataDelegate</span> &lt;<span class="hljs-title">NSURLSessionTaskDelegate</span>&gt;</span><br><span class="hljs-keyword">@optional</span><br><span class="hljs-comment">/* The task has received a response and no further messages will be</span><br><span class="hljs-comment"> * received until the completion block is called. The disposition</span><br><span class="hljs-comment"> * allows you to cancel a request or to turn a data task into a</span><br><span class="hljs-comment"> * download task. This delegate message is optional - if you do not</span><br><span class="hljs-comment"> * implement it, you can get the response as a property of the task.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This method will not be called for background upload tasks (which cannot be converted to download tasks).</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask<br>                                 didReceiveResponse:(<span class="hljs-built_in">NSURLResponse</span> *)response<br>                                  completionHandler:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSURLSessionResponseDisposition</span> disposition))completionHandler;<br><br><span class="hljs-comment">/* Notification that a data task has become a download task.  No</span><br><span class="hljs-comment"> * future messages will be sent to the data task.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask<br>                              didBecomeDownloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Notification that a data task has become a bidirectional stream</span><br><span class="hljs-comment"> * task.  No future messages will be sent to the data task.  The newly</span><br><span class="hljs-comment"> * created streamTask will carry the original request and response as</span><br><span class="hljs-comment"> * properties.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * For requests that were pipelined, the stream object will only allow</span><br><span class="hljs-comment"> * reading, and the object will immediately issue a</span><br><span class="hljs-comment"> * -URLSession:writeClosedForStream:.  Pipelining can be disabled for</span><br><span class="hljs-comment"> * all requests in a session, or by the NSURLRequest</span><br><span class="hljs-comment"> * HTTPShouldUsePipelining property.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The underlying connection is no longer considered part of the HTTP</span><br><span class="hljs-comment"> * connection cache and won&#x27;t count against the total number of</span><br><span class="hljs-comment"> * connections per host.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask<br>                                didBecomeStreamTask:(<span class="hljs-built_in">NSURLSessionStreamTask</span> *)streamTask;<br><br><span class="hljs-comment">/* Sent when data is available for the delegate to consume.  It is</span><br><span class="hljs-comment"> * assumed that the delegate will retain and not copy the data.  As</span><br><span class="hljs-comment"> * the data may be discontiguous, you should use </span><br><span class="hljs-comment"> * [NSData enumerateByteRangesUsingBlock:] to access it.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask<br>                                     didReceiveData:(<span class="hljs-built_in">NSData</span> *)data;<br><br><span class="hljs-comment">/* Invoke the completion routine with a valid NSCachedURLResponse to</span><br><span class="hljs-comment"> * allow the resulting data to be cached, or pass nil to prevent</span><br><span class="hljs-comment"> * caching. Note that there is no guarantee that caching will be</span><br><span class="hljs-comment"> * attempted for a given resource, and you should not rely on this</span><br><span class="hljs-comment"> * message to receive the resource data.</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in">NSURLSessionDataTask</span> *)dataTask<br>                                  willCacheResponse:(<span class="hljs-built_in">NSCachedURLResponse</span> *)proposedResponse <br>                                  completionHandler:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSCachedURLResponse</span> * _Nullable cachedResponse))completionHandler;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæ—¢è®¾ç½®äº†<code>completionHandler</code>ï¼Œåˆå®ç°äº†<code>NSURLSessionTaskDelegate</code>æˆ–å…¶å­ç±»çš„åè®®æ–¹æ³•ï¼Œåˆ™ä¼˜å…ˆæ‰§è¡Œ blockï¼Œä»£ç†æ–¹æ³•ä¸å†æ‰§è¡Œã€‚</p><h4 id="3-8-DownloadTask"><a href="#3-8-DownloadTask" class="headerlink" title="3.8.DownloadTask"></a>3.8.DownloadTask</h4><p>NSURLSessionDownloadTaskï¼Œå°†æ•°æ®ä¸‹è½½å¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œä¸”ä¸‹è½½æ–‡ä»¶æ—¶ä¸éœ€è¦è€ƒè™‘è¾¹ä¸‹è½½è¾¹å†™å…¥æ²™ç›’çš„é—®é¢˜ï¼Œè‹¹æœéƒ½å¸®æˆ‘ä»¬åšå¥½äº†ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sharedSession];<br><span class="hljs-built_in">NSURLSessionDownloadTask</span> *dataTask = [session downloadTaskWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:url]<br>                                                completionHandler:^(<span class="hljs-built_in">NSURL</span> *location, <span class="hljs-built_in">NSURLResponse</span> *response, <span class="hljs-built_in">NSError</span> *error) &#123;<br>                                                    <span class="hljs-keyword">if</span> (!error) &#123;<br>                                                        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ–‡ä»¶ä½ç½®ï¼š%@ \næ–‡ä»¶å¤§å°ï¼š%lld&quot;</span>,<br>                                                              location,response.expectedContentLength);<br>                                                        <br>                                                        <span class="hljs-built_in">NSString</span> *caches = [<span class="hljs-built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="hljs-built_in">NSCachesDirectory</span>, <span class="hljs-built_in">NSUserDomainMask</span>, <span class="hljs-literal">YES</span>) lastObject];<br>                                                        <span class="hljs-built_in">NSString</span> *filePath = [caches stringByAppendingPathComponent:<br>                                                                              response.suggestedFilename];<br>                                                        <span class="hljs-comment">//ç§»åŠ¨æ–‡ä»¶</span><br>                                                        [[<span class="hljs-built_in">NSFileManager</span> defaultManager] moveItemAtPath:location.path<br>                                                                                                toPath:filePath error:<span class="hljs-literal">nil</span>];<br>                                                    &#125;<br>                                                &#125;];<br><span class="hljs-comment">//å¼€å§‹ä»»åŠ¡</span><br>[dataTask resume];<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">++++æ–‡ä»¶ä½ç½®ï¼šUsers<span class="hljs-regexp">/xxx/</span>Library<span class="hljs-regexp">/Developer/</span>CoreSimulator/<br>Devices<span class="hljs-regexp">/2EDED966-0D34-4965-A946-F547BBCE33DA/</span>data/<br>Containers<span class="hljs-regexp">/Data/</span>Application/<span class="hljs-number">5</span>A2FAF81-<span class="hljs-number">62</span>D5-<span class="hljs-number">485</span>A-B059-<span class="hljs-number">22</span>AD6DECA518<br><span class="hljs-regexp">/tmp/</span>CFNetworkDownload_JVNOrU.tmp <br>æ–‡ä»¶å¤§å°ï¼š<span class="hljs-number">100626</span><br></code></pre></td></tr></table></figure><p>ä»å›è°ƒçš„å‚æ•°å¯ä»¥çœ‹åˆ°ï¼Œå¹¶æ²¡æœ‰ NSData å­—æ®µä¼ å›æ¥ã€‚å›è°ƒä¸­åŒ…æ‹¬äº†ä¸€ä¸ª <code>location</code> å‚æ•°ï¼Œå®ƒå°±æ˜¯ä¸‹è½½å¥½çš„æ–‡ä»¶åœ¨æ²™ç›’ä¸­çš„åœ°å€ã€‚ä¸‹è½½å¥½çš„æ–‡ä»¶è¢«æ”¾åˆ°<code>tmp</code>ç›®å½•ä¸‹ã€‚ç”±äº<code>tmp</code>ç›®å½•ä¸‹çš„æ–‡ä»¶éšæ—¶å¯èƒ½è¢«ç³»ç»Ÿè‡ªåŠ¨åˆ é™¤ï¼Œæˆ‘ä»¬åœ¨å›è°ƒä¸­æŠŠæ–‡ä»¶ç§»åŠ¨æŒ‡å®šçš„ç›®å½•ä¸‹å³å¯ã€‚</p><ul><li>NSURLSessionDownloadDelegate</li></ul><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼ŒNSURLSession é€šè¿‡ block çš„æ–¹å¼è¿”å›æ•°æ®ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸ªä¸å¥½çš„åœ°æ–¹æ˜¯æ— æ³•ç›‘å¬ä¸‹è½½è¿›åº¦ã€‚å¦‚æœæƒ³è¦åœ¨æ¥æ”¶æ•°æ®è¿‡ç¨‹ä¸­åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå¯ä»¥é€šè¿‡ <code>NSURLSessionDownloadDelegate</code> åè®®æ¥å®ç°ã€‚(æ›´æ–°ï¼šiOS11åå¯ä»¥ä½¿ç”¨æ–°å¢çš„ <code>NSProgress * progress</code> å±æ€§æ¥ç›‘å¬è¿›åº¦äº†)</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)sendRequest<br>&#123;<br>    <span class="hljs-built_in">NSURLSessionConfiguration</span> *config = [<span class="hljs-built_in">NSURLSessionConfiguration</span><br>    defaultSessionConfiguration];<br>    <br>    config.timeoutIntervalForRequest = <span class="hljs-number">60</span>;<br>    config.allowsCellularAccess = <span class="hljs-literal">YES</span>;<br>    <br>    <span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sessionWithConfiguration:config<br>    delegate:<span class="hljs-keyword">self</span> delegateQueue:<span class="hljs-literal">nil</span>];<br>    <br>    <span class="hljs-built_in">NSURLSessionDownloadTask</span> *dataTask = [session downloadTaskWithURL:<br>    [<span class="hljs-built_in">NSURL</span> URLWithString:url]];<br>    <br>    <span class="hljs-comment">//å¼€å§‹ä»»åŠ¡</span><br>    [dataTask resume];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -NSURLSessionDownloadDelegate</span><br><br><span class="hljs-comment">//ä¸‹è½½å®Œæˆ</span><br>-(<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>     downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask<br>didFinishDownloadingToURL:(<span class="hljs-built_in">NSURL</span> *)location<br>&#123;<br>&#125;<br><br><span class="hljs-comment">//æ¯æ¬¡å†™å…¥æ²™ç›’å®Œæˆå</span><br>-(<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>     downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask<br>     didWriteData:(int64_t)bytesWritten<br>totalBytesWritten:(int64_t)totalBytesWritten<br>totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ä¸‹è½½è¿›åº¦ï¼š%f&quot;</span>,(<span class="hljs-type">double</span>)totalBytesWritten/totalBytesExpectedToWrite);<br>&#125;<br><br><span class="hljs-comment">//æ¢å¤ä¸‹è½½å</span><br>-(<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>     downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask<br>didResumeAtOffset:(int64_t)fileOffset<br>expectedTotalBytes:(int64_t)expectedTotalBytes<br>&#123;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-9-åå°ä»»åŠ¡"><a href="#3-9-åå°ä»»åŠ¡" class="headerlink" title="3.9.åå°ä»»åŠ¡"></a>3.9.åå°ä»»åŠ¡</h4><p>å¯¹äºä¸€äº›è€—æ—¶æˆ–è€…ä¼˜å…ˆçº§ä¸é«˜çš„æ•°æ®ä¼ è¾“ä»»åŠ¡ï¼Œå¯ä»¥åœ¨åå°åˆ›å»ºä¸€ä¸ªä»»åŠ¡è¿›è¡Œä¼ è¾“ã€‚URLSessionä¸­æ”¯æŒåå°ä¼ è¾“ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åº”ç”¨è¿›å…¥åå°æˆ–è€…è¢«ç³»ç»Ÿæ€æ‰åï¼Œç»§ç»­æ‰§è¡Œä¼ è¾“ä»»åŠ¡ã€‚</p><ul><li>åˆ›å»ºåå°ä¼šè¯ã€å‘èµ·ä»»åŠ¡</li></ul><p>è¿™é‡Œéœ€è¦ç»™ConfigurationæŒ‡å®šä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œæ–¹ä¾¿åå°ä»»åŠ¡å®Œæˆåå›è°ƒå‡½æ•°ä¸­ç»§ç»­ä½¿ç”¨æ­¤æ ‡è¯†ç¬¦å¤„ç†ä»»åŠ¡ã€‚åŒæ—¶å»ºè®®æ‰“å¼€å…¶ä¸­ä¸¤ä¸ªé€‰é¡¹ï¼Œä»¥ä¾¿ç³»ç»Ÿå¯¹ä»»åŠ¡è¿›è¡Œä¼˜åŒ–ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//HelNetHelper.m</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;HelNetHelper.h&quot;</span></span><br><br><span class="hljs-built_in">NSString</span> * <span class="hljs-keyword">const</span> k_BackSessionID = <span class="hljs-string">@&quot;k_URLSession_001&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">HelNetHelper</span></span><br><br>+ (<span class="hljs-keyword">instancetype</span>)shareInstance&#123;<br>    <span class="hljs-keyword">static</span> HelNetHelper *instance;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> token;<br>    _<span class="hljs-built_in">dispatch_once</span>(&amp;token, ^&#123;<br>        instance = [[HelNetHelper alloc] init];<br>    &#125;);<br>    <span class="hljs-keyword">return</span> instance;<br>&#125;<br><br>- (<span class="hljs-built_in">NSURLSession</span> *)backgroundSession &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">NSURLSession</span> *session = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br>        <span class="hljs-comment">// 1.é…ç½®åå°sessionï¼ŒæŒ‡å®šå”¯ä¸€æ ‡è¯†ç¬¦ã€‚</span><br>        <span class="hljs-built_in">NSURLSessionConfiguration</span>* config = [<span class="hljs-built_in">NSURLSessionConfiguration</span> backgroundSessionConfigurationWithIdentifier:k_BackSessionID];<br>        config.discretionary = <span class="hljs-literal">YES</span>; <span class="hljs-comment">//å…è®¸ç³»ç»Ÿé‡‡å–æœ€ä¼˜æ—¶æœºæ‰§è¡Œä¼ è¾“ä»»åŠ¡</span><br>        config.sessionSendsLaunchEvents = <span class="hljs-literal">YES</span>; <span class="hljs-comment">// å½“sessionä¸­æœ‰ä»»åŠ¡å®Œæˆæ—¶å…è®¸åº”ç”¨æ¢å¤æˆ–å¯åŠ¨</span><br>        <span class="hljs-comment">// 2.åˆ›å»ºsession è®¾ç½®ä»£ç†å’Œä»£ç†æ‰€åœ¨é˜Ÿåˆ—</span><br>        session = [<span class="hljs-built_in">NSURLSession</span> sessionWithConfiguration:config delegate:<span class="hljs-keyword">self</span> delegateQueue:<span class="hljs-literal">nil</span>];<br>    &#125;);<br>    <span class="hljs-keyword">return</span> session;<br>&#125;<br><br><span class="hljs-comment">// å‘èµ·åå°ä¸‹è½½ä»»åŠ¡</span><br>- (<span class="hljs-type">void</span>)startBackgroundTask&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++start session~&quot;</span>);<br>    <span class="hljs-built_in">NSURLSession</span> *session = [[HelNetHelper shareInstance] backgroundSession];<br>    <span class="hljs-built_in">NSURLSessionDownloadTask</span> * task = [session downloadTaskWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@&quot;https://dl.360safe.com/pclianmeng/n/1__6000322__00__7777772e68616f373339392e636f6d__079b.exe&quot;</span>]];<br>    [task resume];<br>&#125;<br><br><span class="hljs-comment">// å–æ¶ˆä»»åŠ¡</span><br>- (<span class="hljs-type">void</span>)stop&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++task canceled~&quot;</span>);<br>    [[[HelNetHelper shareInstance] backgroundSession] invalidateAndCancel];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -URLSession Delegate</span><br><br><span class="hljs-comment">// sessionä¸­æ‰€æœ‰taskéƒ½å·²å®Œæˆæ—¶ å›è°ƒæ­¤æ–¹æ³•</span><br>-  (<span class="hljs-type">void</span>)URLSessionDidFinishEventsForBackgroundURLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++thread on finishEvent:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>        <span class="hljs-keyword">self</span>.completeBlock();<br>    &#125;);<br>&#125;<br><br><span class="hljs-comment">// æ–‡ä»¶ä¸‹è½½å®Œæˆ</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>      downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask<br>didFinishDownloadingToURL:(<span class="hljs-built_in">NSURL</span> *)location&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++downloadtask finished, file in :%@~&quot;</span>,location.path);<br>    <span class="hljs-comment">//ç§»åŠ¨æ–‡ä»¶</span><br>    <span class="hljs-comment">//[[NSFileManager defaultManager] moveItemAtURL:location toURL:targetPath error:nil];</span><br>    <span class="hljs-comment">//åˆ é™¤æ–‡ä»¶</span><br>    <span class="hljs-built_in">NSError</span> *error = <span class="hljs-literal">nil</span>;<br>    [[<span class="hljs-built_in">NSFileManager</span> defaultManager] removeItemAtURL:location error:&amp;error];<br>&#125;<br><br><span class="hljs-comment">//ä¸‹è½½è¿›è¡Œä¸­ è·Ÿè¸ªè¿›åº¦</span><br>-(<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>     downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask<br>     didWriteData:(int64_t)bytesWritten<br>totalBytesWritten:(int64_t)totalBytesWritten<br>totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ä¸‹è½½è¿›åº¦ï¼š%f&quot;</span>,(<span class="hljs-type">double</span>)totalBytesWritten/totalBytesExpectedToWrite);<br>&#125;<br><br><span class="hljs-comment">// ä¸‹è½½æˆåŠŸæˆ–å¤±è´¥ éƒ½ä¼šå›è°ƒæ­¤æ–¹æ³•ï¼Œåªæ˜¯å¤±è´¥æ—¶errorä¸ä¸ºç©ºï¼Œå¯å¤„ç†é”™è¯¯ä¿¡æ¯</span><br>- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>              task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>didCompleteWithError:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSError</span> *)error<br>&#123;<br>    <span class="hljs-keyword">if</span> (error) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++download failed:%@&quot;</span>,error.description);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++download succeed~&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ul><li>AppDelegateæ”¶åˆ°ä¸‹è½½å®Œæˆå›è°ƒ</li></ul><p>åœ¨AppDelegate.mä¸­å°†å›è°ƒä¸­çš„<code>completionHandler</code>ä¿å­˜èµ·æ¥ï¼Œä»¥ä¾¿åé¢ç»§ç»­ä½¿ç”¨ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// AppDelegate.m</span><br><br>- (<span class="hljs-type">void</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>handleEventsForBackgroundURLSession:(<span class="hljs-built_in">NSString</span> *)identifier<br>  completionHandler:(<span class="hljs-type">void</span> (^)(<span class="hljs-type">void</span>))completionHandler<br>&#123;<br>    <span class="hljs-comment">// ä½¿ç”¨ä¸æŒ‚èµ·å‰åå°ä»»åŠ¡ç›¸åŒçš„æ ‡è¯†ç¬¦ é‡æ–°åˆ›å»ºsessionå¹¶è®¾ç½®ä»£ç†ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ä¹‹å‰çš„ä»»åŠ¡ä¸å½“å‰sessionå…³è”èµ·æ¥</span><br>    [[HelNetHelper shareInstance] backgroundSession];<br>    <br>    [HelNetHelper shareInstance].completeBlock = completionHandler;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++handleEventsForBackgroundURLSession:%@~&quot;</span>,identifier);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>HelNetHelperä¸­å›è°ƒcompleteBlock</li></ul><p>ä¸Šé¢AppDelegateæ”¶åˆ°å›è°ƒåï¼Œç³»ç»Ÿä¼šåœ¨ HelNetHelper ä¸­å›è°ƒ NSURLSessionDelegate åè®®çš„ä»¥ä¸‹æ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//HelNetHelper.m</span><br><br><span class="hljs-comment">/* If an application has received an</span><br><span class="hljs-comment"> * -application:handleEventsForBackgroundURLSession:completionHandler:</span><br><span class="hljs-comment"> * message, the session delegate will receive this message to indicate</span><br><span class="hljs-comment"> * that all messages previously enqueued for this session have been</span><br><span class="hljs-comment"> * delivered.  At this time it is safe to invoke the previously stored</span><br><span class="hljs-comment"> * completion handler, or to begin any internal updates that will</span><br><span class="hljs-comment"> * result in invoking the completion handler.</span><br><span class="hljs-comment"> */</span><br>-  (<span class="hljs-type">void</span>)URLSessionDidFinishEventsForBackgroundURLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++thread on finishEvent:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    <span class="hljs-comment">// å½“å‰å›è°ƒå¯èƒ½åœ¨ç§æœ‰é˜Ÿåˆ—ä¸­ éœ€è¦å›åˆ°ä¸»çº¿ç¨‹</span><br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>        <span class="hljs-keyword">self</span>.completeBlock();<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>å›è°ƒä¸­æˆ‘ä»¬è°ƒç”¨ä¹‹å‰ä¿å­˜èµ·æ¥çš„<code>completeBlock()</code>å³å¯ã€‚<br><br/></p><p>æ³¨æ„ï¼Œæˆ‘ä»¬åˆ›å»ºsessionæ—¶<code>delegateQueue</code>å‚æ•°ä¼ çš„æ˜¯nilï¼Œæ‰€ä»¥ä»»åŠ¡çš„å›è°ƒ NSURLSessionDelegate ä¼šåœ¨ä¸€ä¸ªç§æœ‰ä¸²è¡Œé˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œè‹¹æœè¦æ±‚æˆ‘ä»¬åœ¨æ‰§è¡Œ<code>completeBlock()</code>å›è°ƒæ—¶å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸­ã€‚</p><blockquote><p>The URL session API itself is fully thread-safe. You can freely create sessions and tasks in any thread context. When your delegate methods call the provided completion handlers, the work is automatically scheduled on the correct delegate queue.</p></blockquote><blockquote><p>The system may call the URLSessionDidFinishEventsForBackgroundURLSession: session delegate method on a secondary thread. However, in iOS, your implementation of that method may need to call a completion handler provided to you in your application:handleEventsForBackgroundURLSession:completionHandler: app delegate method. You must call that completion handler on the main thread.</p></blockquote><ul><li>å¤„ç†ä¸‹è½½çš„æ–‡ä»¶</li></ul><p>å½“åº”ç”¨å›è°ƒå®Œ<code>completeBlock()</code>åï¼Œä¸‹è½½ä»»åŠ¡å°±è‡ªåŠ¨å®Œæˆï¼Œéšåå›è°ƒï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session<br>      downloadTask:(<span class="hljs-built_in">NSURLSessionDownloadTask</span> *)downloadTask<br>didFinishDownloadingToURL:(<span class="hljs-built_in">NSURL</span> *)location<br>&#123;<br>    <span class="hljs-comment">//ç§»åŠ¨æ–‡ä»¶</span><br>    [[<span class="hljs-built_in">NSFileManager</span> defaultManager] moveItemAtURL:location toURL:targetPath error:<span class="hljs-literal">nil</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†ä¸‹è½½çš„æ–‡ä»¶ä»ç¼“å­˜ç›®å½•ä¸­ç§»åˆ°ä½ æŒ‡å®šçš„ç›®å½•ä¸­å³å¯ã€‚</p><ul><li>åº”ç”¨æŒ‚èµ·æ—¶è¢«ç³»ç»Ÿæ€æ‰æƒ…å†µä¸‹ä»»åŠ¡çš„æ¢å¤</li></ul><p>åº”ç”¨è¢«æŒ‚èµ·æ—¶æœ‰å¯èƒ½è¢«ç³»ç»Ÿæ€æ‰ï¼Œåå°ä»»åŠ¡åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­ç»§ç»­æ‰§è¡Œï¼Œå½“ä»»åŠ¡å®Œæˆæ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨åå°é‡å¯ä½ çš„åº”ç”¨ã€‚åº”ç”¨å¯åŠ¨é˜¶æ®µä½ å¯ä»¥ä½¿ç”¨ä¸ä¹‹å‰çš„åå°ä»»åŠ¡ç›¸åŒçš„æ ‡è¯†ç¬¦é‡æ–°åˆ›å»ºURLSessionä¼šè¯ï¼Œ<code>ç³»ç»Ÿä¼šè‡ªåŠ¨å°†åŸæ¥çš„åå°ä»»åŠ¡ä¸ä½ çš„æ–°sessionå…³è”èµ·æ¥</code>ã€‚è¿™æ ·ä¸è®ºåº”ç”¨æ˜¯ç”±ç”¨æˆ·å¯åŠ¨è¿˜æ˜¯ç”±ç³»ç»Ÿå¯åŠ¨ï¼Œåå°ä»»åŠ¡éƒ½ä¼šç»§ç»­å›è°ƒå„ç§äº‹ä»¶ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">// é‡ç”¨åå°ä»»åŠ¡æ ‡è¯†ç¬¦ é‡å»ºsession è®¾ç½®å›è°ƒä»£ç†</span><br>    [[HelNetHelper shareInstance] backgroundSession];<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æµ‹è¯•</li></ul><p>åœ¨ViewControllerä¸­ ç‚¹å‡»æŒ‰é’®å¼€å§‹ä¸‹è½½ä»»åŠ¡ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">- (IBAction)onClick:(id)sender &#123;<br>    <span class="hljs-selector-attr">[[HelNetHelper shareInstance]</span> backgroundTask];<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ¨¡æ‹Ÿå™¨ä¸­è°ƒè¯•ï¼Œæ§åˆ¶å°ä¼šä¸æ–­æ‰“å°å½“å‰ä¸‹è½½çš„è¿›åº¦ã€‚æ­¤æ—¶å¯å…ˆç›´æ¥<code>command + .</code>åœæ­¢æ¨¡æ‹Ÿå™¨å¹¶è®°ä½æ§åˆ¶å°ä¸­æœ€åä¸€æ¡è¿›åº¦çš„æ•°å€¼ï¼›</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">start session~</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä¸‹è½½è¿›åº¦ï¼š0</span><span class="hljs-string">.</span><span class="hljs-comment">000021</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä¸‹è½½è¿›åº¦ï¼š0</span><span class="hljs-string">.</span><span class="hljs-comment">000025</span><br><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä¸‹è½½è¿›åº¦ï¼š0</span><span class="hljs-string">.</span><span class="hljs-comment">012226</span><br></code></pre></td></tr></table></figure><p>éšåé‡æ–°è¿è¡Œæ¨¡æ‹Ÿå™¨ï¼Œå¯ä»¥çœ‹åˆ°æ—¥å¿—ç»§ç»­æ‰“å°ï¼Œå¹¶ä¸”è¿›åº¦å¹¶ä¸æ˜¯ä»0å¼€å§‹ï¼Œè€Œæ˜¯ä»¥æ¯”ä¹‹å‰æ•°å€¼æ›´å¤§çš„è¿›åº¦ç»§ç»­è¿›è¡Œã€‚</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">ä¸‹è½½è¿›åº¦ï¼š0</span><span class="hljs-string">.</span><span class="hljs-comment">089701</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä¸‹è½½è¿›åº¦ï¼š0</span><span class="hljs-string">.</span><span class="hljs-comment">089829</span><br><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br></code></pre></td></tr></table></figure><p>è¿™è¯´æ˜è™½ç„¶åº”ç”¨é€€å‡ºä½†æ˜¯åå°ä»»åŠ¡ä»åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œï¼Œé‡æ–°å¯åŠ¨åº”ç”¨åä»»åŠ¡ç»§ç»­å¹¶æ‰§è¡Œå›è°ƒã€‚</p><br/><p>å¦‚æœå¼€å§‹ä¸‹è½½åï¼Œç›´æ¥è¿›å…¥åå°ï¼Œç›´åˆ°æ–‡ä»¶ä¸‹è½½å®Œæˆï¼Œåˆ™å®Œæ•´çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs elixir">+++start session~<br>+++ä¸‹è½½è¿›åº¦ï¼š<span class="hljs-number">0.000381</span><br>+++ä¸‹è½½è¿›åº¦ï¼š<span class="hljs-number">0.000573</span><br>+++ä¸‹è½½è¿›åº¦ï¼š<span class="hljs-number">0.000765</span><br>+++ä¸‹è½½è¿›åº¦ï¼š<span class="hljs-number">0.001149</span><br>++++<span class="hljs-symbol">handleEventsForBackgroundURLSession:</span>k_URLSession_001~<br>+++downloadtask finished, file <span class="hljs-keyword">in</span> <span class="hljs-symbol">:/Users/xxx/Library/Developer/CoreSimulator/Devices/xxx/Library/Caches/com</span>.apple.nsurlsessiond/<span class="hljs-title class_">Downloads</span>/<span class="hljs-title class_">Helko</span>/<span class="hljs-title class_">CFNetworkDownload_MaGyNe</span>.tmp~<br>+++download succeed~<br>++++thread on <span class="hljs-symbol">finishEvent:</span>&lt;<span class="hljs-symbol">NSThread:</span> <span class="hljs-number">0x6000020a56c0</span>&gt;&#123;number = <span class="hljs-number">3</span>, name = (null)&#125;<br></code></pre></td></tr></table></figure><p>å³ä»»åŠ¡ä¼šåœ¨åå°è‡ªåŠ¨è¿›è¡Œï¼Œç›´åˆ°æœ€ç»ˆå®Œæˆã€‚ä»»åŠ¡å®Œæˆåï¼Œè‡ªåŠ¨è°ƒç”¨AppDelegateå’Œæˆ‘ä»¬å·¥å…·ç±»ä¸­çš„URLSessionå„é¡¹å›è°ƒã€‚</p><ul><li>åå°ä»»åŠ¡çš„é™åˆ¶æ¡ä»¶</li></ul><p>åå°sessionä¸­çš„æ•°æ®ä¼ è¾“ä»»åŠ¡æ˜¯<code>åœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä¸­æ‰§è¡Œ</code>çš„ï¼Œé‡å¯åº”ç”¨æ˜¯æ¯”è¾ƒæ˜‚è´µçš„æ“ä½œï¼Œæ‰€ä»¥åå°sessionä¼šæœ‰ä¸€äº›é™åˆ¶æ¡ä»¶ï¼š</p><ol><li>åå°sessionå¿…é¡»æä¾›ä¸€ä¸ªdelegateå¤„ç†äº‹ä»¶ï¼›</li><li>åªæ”¯æŒ HTTP å’Œ HTTPS åè®®ï¼Œä¸æ”¯æŒç§æœ‰åè®®ï¼›</li><li>å…è®¸é‡å®šå‘ä¸”ä¼šç›´æ¥æ‰§è¡Œï¼Œä¸ä¼šå›è°ƒ URLSession:task:willPerformHTTPRedirection:newRequest:completionHandler:æ–¹æ³•ï¼›</li><li>åªæ”¯æŒä¸Šä¼ å’Œä¸‹è½½ï¼Œä¸æ”¯æŒdataTaskï¼›ä¸”ä¸Šä¼ çš„æ–‡ä»¶å¿…é¡»åœ¨æ–‡ä»¶å¤¹ä¸­ï¼Œä¸Šä¼ å†…å­˜ä¸­çš„æ•°æ®æˆ–è€…æ•°æ®æµåœ¨åº”ç”¨é€€å‡ºæ—¶ä¼šå¤±è´¥ã€‚</li></ol><h4 id="3-10-æ–­ç‚¹ä¸‹è½½"><a href="#3-10-æ–­ç‚¹ä¸‹è½½" class="headerlink" title="3.10.æ–­ç‚¹ä¸‹è½½"></a>3.10.æ–­ç‚¹ä¸‹è½½</h4><p>NSURLSessionDownloadTask æä¾›äº†æ–­ç‚¹ä¸‹è½½çš„ç›¸å…³æ–¹æ³•ã€‚</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs wren">[<span class="hljs-variable">dataTask</span> <span class="hljs-variable">cancelByProducingResumeData</span>:<span class="hljs-title function_">^</span>(<span class="hljs-params">NSData</span> * _<span class="hljs-params">Nullable</span> <span class="hljs-params">resumeData</span>) &#123;<br>    <span class="hljs-variable">_mResumeData</span> <span class="hljs-operator">=</span> <span class="hljs-variable">resumeData</span>;<br>&#125;];<br></code></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•ç”¨æ¥å–æ¶ˆä¸‹è½½ä»»åŠ¡ï¼Œå–æ¶ˆä¸‹è½½åçš„å›è°ƒä¸­ï¼Œå‚æ•° <code>resumeData</code> åŒ…å«äº†ç»§ç»­ä¸‹è½½æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ã€‚<code>resumeData</code> åªåŒ…å«äº†urlå’Œå·²ç»ä¸‹è½½äº†å¤šå°‘æ•°æ®ï¼Œä¸ä¼šå¾ˆå¤§ï¼Œä¸ç”¨æ‹…å¿ƒå†…å­˜é—®é¢˜ã€‚<br><br/></p><p>æ¢å¤ä¸‹è½½æ—¶ï¼Œå¯ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">mDataTask</span> = [mURLSession downloadTaskWithResumeData:_mResumeData]<span class="hljs-comment">;</span><br><span class="hljs-section">[mDataTask resume]</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>å¦å¤–ï¼Œç”±äºä¸‹è½½å¤±è´¥å¯¼è‡´çš„ä¸‹è½½ä¸­æ–­ä¼šè¿›å…¥æ­¤åè®®æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å¾—åˆ°ç”¨æ¥æ¢å¤çš„æ•°æ®ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)URLSession:(<span class="hljs-built_in">NSURLSession</span> *)session <br>task:(<span class="hljs-built_in">NSURLSessionTask</span> *)task<br>didCompleteWithError:(<span class="hljs-built_in">NSError</span> *)error<br>&#123;<br>    <span class="hljs-comment">// ä¿å­˜æ¢å¤æ•°æ®</span><br>    _mResumeData = error.userInfo[<span class="hljs-built_in">NSURLSessionDownloadTaskResumeData</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œç»“ï¼Œæ’’èŠ±~</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOSå¼‚å¸¸æ•è·</title>
    <link href="/2017/11/28/crash.html"/>
    <url>/2017/11/28/crash.html</url>
    
    <content type="html"><![CDATA[<h3 id="çº¿ä¸ŠAPPè·å–å´©æºƒä¿¡æ¯çš„æ–¹å¼ï¼š"><a href="#çº¿ä¸ŠAPPè·å–å´©æºƒä¿¡æ¯çš„æ–¹å¼ï¼š" class="headerlink" title="çº¿ä¸ŠAPPè·å–å´©æºƒä¿¡æ¯çš„æ–¹å¼ï¼š"></a>çº¿ä¸ŠAPPè·å–å´©æºƒä¿¡æ¯çš„æ–¹å¼ï¼š</h3><ul><li>ä½¿ç”¨ç³»ç»Ÿ API æ”¶é›†å´©æºƒä¿¡æ¯å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚</li><li>ä½¿ç”¨å‹ç›Ÿã€Bugly ç­‰ç¬¬ä¸‰æ–¹æ”¶é›†åˆ†æSDKã€‚</li><li>ä½¿ç”¨ iTunes Connect ä¸Šçš„å´©æºƒæ”¶é›†æœåŠ¡ã€‚</li></ul><p>è¿™é‡Œæš‚æ—¶åªè®²ç¬¬ä¸€ç§ã€‚iOSæä¾›äº†å¼‚å¸¸å‘ç”Ÿæ—¶çš„å¤„ç†APIï¼Œåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™å¯ä»¥æ·»åŠ è¿™æ ·çš„Handlerï¼Œè¿™æ ·ç¨‹åºå‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™å°±å¯ä»¥å¯¹å¼‚å¸¸è¿›è¡Œå¿…è¦çš„å¤„ç†ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-type">void</span> <span class="hljs-built_in">NSSetUncaughtExceptionHandler</span>(<span class="hljs-built_in">NSUncaughtExceptionHandler</span> * _Nullable);<br></code></pre></td></tr></table></figure><p>ä¸‹é¢çš„ç±»å°±åˆ©ç”¨äº†ç³»ç»Ÿæä¾›çš„APIæ¥æ•è·å‡ºç°çš„å´©æºƒï¼Œå¹¶å°†å¼‚å¸¸ä¿¡æ¯å­˜å‚¨åˆ°å›ºå®šç›®å½•ä¸‹çš„æ–‡ä»¶ä¸­ï¼Œ</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//.hæ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ExceptionHandler</span> : <span class="hljs-title">NSObject</span></span><br><br>+ (<span class="hljs-type">void</span>)setDefaultHandler;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//.mæ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ExceptionHandler.h&quot;</span></span><br><br><span class="hljs-keyword">volatile</span> int32_t UncaughtExceptionCount = <span class="hljs-number">0</span>;   <span class="hljs-comment">//å½“å‰å¤„ç†çš„å¼‚å¸¸ä¸ªæ•°</span><br><span class="hljs-keyword">volatile</span> int32_t UncaughtExceptionMaximum = <span class="hljs-number">10</span>;<span class="hljs-comment">//æœ€å¤§èƒ½å¤Ÿå¤„ç†çš„å¼‚å¸¸ä¸ªæ•°</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -æ–‡ä»¶ç›®å½•</span><br><span class="hljs-built_in">NSString</span> *exceptionFilePath()<br>&#123;<br><span class="hljs-keyword">return</span> [<span class="hljs-built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="hljs-built_in">NSDocumentDirectory</span>,<span class="hljs-built_in">NSUserDomainMask</span>, <span class="hljs-literal">YES</span>) lastObject];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -æ”¶åˆ°å¼‚å¸¸é€šçŸ¥æ—¶çš„å›è°ƒå‡½æ•°</span><br><span class="hljs-type">void</span> UncaughtExceptionHandler(<span class="hljs-built_in">NSException</span> *exception)<br>&#123;<br><span class="hljs-built_in">NSArray</span> *arr = [exception callStackSymbols];<br><span class="hljs-built_in">NSString</span> *reason = [exception reason];<br><span class="hljs-built_in">NSString</span> *name = [exception name];<br><br><span class="hljs-built_in">NSString</span> *info = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;+å¼‚å¸¸å´©æºƒæŠ¥å‘Š+\nname:\n%@\nreason:\n%@\ncallStackSymbols:\n%@&quot;</span>,name,reason,[arr componentsJoinedByString:<span class="hljs-string">@&quot;\n&quot;</span>]];<br><br><span class="hljs-built_in">NSString</span> *path = [exceptionFilePath() stringByAppendingPathComponent:<span class="hljs-string">@&quot;Exception.txt&quot;</span>];<br><br>[info writeToFile:path atomically:<span class="hljs-literal">YES</span> encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span> error:<span class="hljs-literal">nil</span>];<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ExceptionHandler</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -å¼€å§‹ç›‘å¬å¼‚å¸¸</span><br>+ (<span class="hljs-type">void</span>)setDefaultHandler<br>&#123;<br><span class="hljs-built_in">NSSetUncaughtExceptionHandler</span> (&amp;UncaughtExceptionHandler);<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>[ExceptionHandler setDefaultHandler];<br><span class="hljs-built_in">NSArray</span> *anArr = @[@(<span class="hljs-number">0</span>)];<br>anArr[<span class="hljs-number">5</span>];<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å´©æºƒåå¾—åˆ°æ—¥å¿—ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">+å¼‚å¸¸å´©æºƒæŠ¥å‘Š+<br><span class="hljs-symbol">name:</span><br>NSRangeException<br><span class="hljs-symbol">reason:</span><br>*** -[__NSSingleObjectArrayI objectAtIndex:]: index <span class="hljs-number">5</span> beyond bounds [<span class="hljs-number">0</span> .. <span class="hljs-number">0</span>]<br><span class="hljs-symbol">callStackSymbols:</span><br><span class="hljs-number">0</span>   CoreFoundation      <span class="hljs-number">0x00000001070dd1ab</span> __exceptionPreprocess + <span class="hljs-number">171</span><br><span class="hljs-number">1</span>   libobjc<span class="hljs-number">.</span>A<span class="hljs-number">.</span>dylib     <span class="hljs-number">0x0000000106772f41</span> objc_exception_throw + <span class="hljs-number">48</span><br><span class="hljs-number">2</span>   CoreFoundation      <span class="hljs-number">0x000000010711d2df</span> -[__NSSingleObjectArrayI objectAtIndex:] + <span class="hljs-number">111</span><br><span class="hljs-number">3</span>   ASDF                <span class="hljs-number">0x0000000105e5a8b2</span> -[AppDelegate application:didFinishLaunchingWithOptions:] + <span class="hljs-number">242</span><br>...<br><span class="hljs-number">28</span>  CoreFoundation      <span class="hljs-number">0x0000000107064b49</span> __CFRunLoopDoSources0 + <span class="hljs-number">185</span><br><span class="hljs-number">29</span>  CoreFoundation      <span class="hljs-number">0x000000010706412f</span> __CFRunLoopRun + <span class="hljs-number">1279</span><br><span class="hljs-number">30</span>  CoreFoundation      <span class="hljs-number">0x00000001070639b9</span> CFRunLoopRunSpecific + <span class="hljs-number">409</span><br><span class="hljs-number">31</span>  GraphicsServices    <span class="hljs-number">0x000000010c0ad9c6</span> GSEventRunModal + <span class="hljs-number">62</span><br><span class="hljs-number">32</span>  UIKit               <span class="hljs-number">0x00000001075585e8</span> UIApplicationMain + <span class="hljs-number">159</span><br><span class="hljs-number">33</span>  ASDF                <span class="hljs-number">0x0000000105e5bf4f</span> main + <span class="hljs-number">111</span><br><span class="hljs-number">34</span>  libdyld<span class="hljs-number">.</span>dylib       <span class="hljs-number">0x000000010aa71d81</span> start + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¨‹åºå´©æºƒéƒ½æ˜¯ç”±äºå‘ç”Ÿå¯ä»¥æ•æ‰çš„å¼‚å¸¸çš„ï¼Œæœ‰äº›æ—¶å€™å¼•èµ·å´©æºƒçš„åŸå› å¯èƒ½æ˜¯ï¼šå†…å­˜è®¿é—®é”™è¯¯ã€é‡å¤é‡Šæ”¾ç­‰ã€‚ä¸Šé¢çš„APIå¯¹è¿™äº›é”™è¯¯å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œå› ä¸ºè¿™ç§é”™è¯¯å®ƒæŠ›å‡ºçš„æ˜¯Signalï¼Œæ‰€ä»¥å¿…é¡»è¦ä¸“é—¨åšSignalå¤„ç†ã€‚<br><br/></p><p>æ­¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°æ¥æ³¨å†Œsignalå¼‚å¸¸æ—¶çš„å›è°ƒå‡½æ•°ï¼š</p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs qml"><span class="hljs-keyword">signal</span><span class="hljs-string"></span>(SIGABRT, signalExceptionHandler);<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå½“åº”ç”¨å‘ç”Ÿé”™è¯¯è€Œäº§ç”Ÿä¸Šè¿°signalåï¼Œå°±ä¼šè¿›å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„å›è°ƒå‡½æ•°signalExceptionHandlerä¸­ã€‚ä¸ºäº†å¾—åˆ°å´©æºƒæ—¶çš„ç°åœºä¿¡æ¯ï¼Œè¿˜å¯ä»¥åŠ å…¥ä¸€äº›è·å–CallTraceçš„æ–¹æ³•ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ExceptionHandler</span> : <span class="hljs-title">NSObject</span></span><br><br>+ (<span class="hljs-keyword">instancetype</span>)shareInstance;<br>+ (<span class="hljs-built_in">NSArray</span> *)backtrace;<br>+ (<span class="hljs-type">void</span>)installExceptionHandler;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;ExceptionHandler.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;libkern/OSAtomic.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;execinfo.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/signal.h&gt;</span></span><br><br><span class="hljs-comment">//å½“å‰å¤„ç†çš„å¼‚å¸¸ä¸ªæ•°</span><br><span class="hljs-keyword">volatile</span> int32_t UncaughtExceptionCount = <span class="hljs-number">0</span>;<br><span class="hljs-comment">//æœ€å¤§èƒ½å¤Ÿå¤„ç†çš„å¼‚å¸¸ä¸ªæ•°</span><br><span class="hljs-keyword">volatile</span> int32_t UncaughtExceptionMaximum = <span class="hljs-number">10</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-built_in">NSInteger</span> ExceptionHandlerSkipAddressCount = <span class="hljs-number">5</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-built_in">NSInteger</span> ExceptionHandlerReportAddressCount = <span class="hljs-number">10</span>;<br><br><span class="hljs-keyword">static</span> ExceptionHandler *mExceptionHandler =  <span class="hljs-literal">nil</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -æ•è·ä¿¡å·åçš„å›è°ƒå‡½æ•°</span><br><span class="hljs-type">void</span> signalExceptionHandler(<span class="hljs-type">int</span> signo)<br>&#123;<br>int32_t exceptionCount = OSAtomicIncrement32(&amp;UncaughtExceptionCount);<br><span class="hljs-keyword">if</span> (exceptionCount &gt; UncaughtExceptionMaximum)&#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-built_in">NSArray</span> *callStack = [ExceptionHandler backtrace];<br><br><span class="hljs-built_in">NSMutableDictionary</span> *userInfo = [<span class="hljs-built_in">NSMutableDictionary</span> dictionaryWithObject:<br>[<span class="hljs-built_in">NSNumber</span> numberWithInt:signo] forKey:<span class="hljs-string">@&quot;signal&quot;</span>];<br>[userInfo setValue:callStack forKey:<span class="hljs-string">@&quot;callStack&quot;</span>];<br><br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªOCå¼‚å¸¸å¯¹è±¡</span><br><span class="hljs-built_in">NSException</span> *ex = [<span class="hljs-built_in">NSException</span> exceptionWithName:<span class="hljs-string">@&quot;Name&quot;</span> reason:<span class="hljs-literal">nil</span> userInfo:userInfo];<br><br><span class="hljs-comment">//å¤„ç†å¼‚å¸¸æ¶ˆæ¯</span><br>[[ExceptionHandler shareInstance] performSelectorOnMainThread:<span class="hljs-keyword">@selector</span>(onHandleSignalException:) withObject:ex waitUntilDone:<span class="hljs-literal">YES</span>];<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ExceptionHandler</span></span><br><br>+ (<span class="hljs-keyword">instancetype</span>)shareInstance<br>&#123;<br><span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;<br><span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br><span class="hljs-keyword">if</span> (mExceptionHandler == <span class="hljs-literal">nil</span>) &#123;<br>mExceptionHandler  =  [[ExceptionHandler alloc] init];<br>&#125;<br>&#125;);<br><span class="hljs-keyword">return</span> mExceptionHandler;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -æ³¨å†Œå¼‚å¸¸å¤„ç†å›è°ƒ</span><br>+ (<span class="hljs-type">void</span>)installExceptionHandler<br>&#123;<br><span class="hljs-comment">//æ³¨å†Œç¨‹åºç”±äºabort()å‡½æ•°è°ƒç”¨å‘ç”Ÿçš„ç¨‹åºä¸­æ­¢ä¿¡å·</span><br>signal(SIGABRT, signalExceptionHandler);<br><br><span class="hljs-comment">//æ³¨å†Œç¨‹åºç”±äºéæ³•æŒ‡ä»¤äº§ç”Ÿçš„ç¨‹åºä¸­æ­¢ä¿¡å·</span><br>signal(SIGILL, signalExceptionHandler);<br><br><span class="hljs-comment">//æ³¨å†Œç¨‹åºç”±äºæ— æ•ˆå†…å­˜çš„å¼•ç”¨å¯¼è‡´çš„ç¨‹åºä¸­æ­¢ä¿¡å·</span><br>signal(SIGSEGV, signalExceptionHandler);<br><br><span class="hljs-comment">//æ³¨å†Œç¨‹åºç”±äºæµ®ç‚¹æ•°å¼‚å¸¸å¯¼è‡´çš„ç¨‹åºä¸­æ­¢ä¿¡å·</span><br>signal(SIGFPE, signalExceptionHandler);<br><br><span class="hljs-comment">//æ³¨å†Œç¨‹åºç”±äºå†…å­˜åœ°å€æœªå¯¹é½å¯¼è‡´çš„ç¨‹åºä¸­æ­¢ä¿¡å·</span><br>signal(SIGBUS, signalExceptionHandler);<br><br><span class="hljs-comment">//ç¨‹åºé€šè¿‡ç«¯å£å‘é€æ¶ˆæ¯å¤±è´¥å¯¼è‡´çš„ç¨‹åºä¸­æ­¢ä¿¡å·</span><br>signal(SIGPIPE, signalExceptionHandler);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -å¤„ç†å¼‚å¸¸ç”¨åˆ°çš„æ–¹æ³•</span><br>- (<span class="hljs-type">void</span>)onHandleSignalException:(<span class="hljs-built_in">NSException</span> *)exception<br>&#123;<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å‡ºç°å´©æºƒ:\n%@&quot;</span>,exception.userInfo);<br><br><span class="hljs-built_in">NSSetUncaughtExceptionHandler</span>(<span class="hljs-literal">NULL</span>);<br><br>signal(SIGABRT, SIG_DFL);<br>signal(SIGILL, SIG_DFL);<br>signal(SIGSEGV, SIG_DFL);<br>signal(SIGFPE, SIG_DFL);<br>signal(SIGBUS, SIG_DFL);<br>signal(SIGPIPE, SIG_DFL);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -è·å–è°ƒç”¨å †æ ˆ</span><br>+ (<span class="hljs-built_in">NSArray</span> *)backtrace<br>&#123;<br><span class="hljs-type">void</span>* callstack[<span class="hljs-number">128</span>];<br><br><span class="hljs-comment">//è¯¥å‡½æ•°ç”¨äºè·å–å½“å‰çº¿ç¨‹çš„è°ƒç”¨å †æ ˆ</span><br><span class="hljs-type">int</span> frames = backtrace(callstack, <span class="hljs-number">128</span>);<br><br><span class="hljs-comment">//å°†ä»backtraceå‡½æ•°è·å–çš„ä¿¡æ¯è½¬åŒ–ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„</span><br><span class="hljs-type">char</span> **strs = backtrace_symbols(callstack, frames);<br><br><span class="hljs-type">int</span> i;<br><br><span class="hljs-built_in">NSMutableArray</span> *backtrace = [<span class="hljs-built_in">NSMutableArray</span> arrayWithCapacity:frames];<br><br><span class="hljs-keyword">for</span> (i = ExceptionHandlerSkipAddressCount;<br>i &lt; ExceptionHandlerSkipAddressCount + ExceptionHandlerReportAddressCount; i++)<br>&#123;<br>[backtrace addObject:[<span class="hljs-built_in">NSString</span> stringWithUTF8String:strs[i]]];<br>&#125;<br>free(strs);<br><span class="hljs-keyword">return</span> backtrace;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>[ExceptionHandler installExceptionHandler];<br><span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰å´©æºƒéƒ½èƒ½æ•è·äº†ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¼‚å¸¸</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å†…å­˜é”™è¯¯è°ƒè¯•</title>
    <link href="/2017/11/27/bad_access.html"/>
    <url>/2017/11/27/bad_access.html</url>
    
    <content type="html"><![CDATA[<h3 id="1ã€å†…å­˜é”™è¯¯æ˜¯å•¥"><a href="#1ã€å†…å­˜é”™è¯¯æ˜¯å•¥" class="headerlink" title="1ã€å†…å­˜é”™è¯¯æ˜¯å•¥"></a>1ã€å†…å­˜é”™è¯¯æ˜¯å•¥</h3><p>åœ¨Cå’ŒOCä¸­ï¼Œä½ ä¸€ç›´åœ¨å¤„ç†æŒ‡é’ˆã€‚æŒ‡é’ˆæ˜¯å­˜å‚¨å¦ä¸€ä¸ªå˜é‡çš„å†…å­˜åœ°å€çš„å˜é‡ã€‚å½“å‘ä¸€ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆå°†ä¼šè¢«å¼•ç”¨ã€‚è¿™æ„å‘³ç€ï¼Œä½ è·å–äº†æŒ‡é’ˆæ‰€æŒ‡çš„å†…å­˜åœ°å€ï¼Œå¹¶è®¿é—®è¯¥å­˜å‚¨åŒºåŸŸçš„å€¼ã€‚</p><p>å½“è¯¥å­˜å‚¨å™¨åŒºåŸŸä¸å†æ˜ å°„åˆ°ä½ çš„åº”ç”¨æ—¶ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œè¯¥å†…å­˜åŒºåŸŸåœ¨ä½ è®¤ä¸ºä½¿ç”¨çš„æ—¶å€™å´æ²¡æœ‰ä½¿ç”¨ï¼Œè¯¥å†…å­˜åŒºåŸŸæ˜¯æ— æ³•è®¿é—®çš„ã€‚ è¿™æ—¶å†…æ ¸ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼ˆ EXC ï¼‰ï¼Œè¡¨æ˜ä½ çš„åº”ç”¨ç¨‹åºä¸èƒ½è®¿é—®è¯¥å­˜å‚¨å™¨åŒºåŸŸï¼ˆBAD ACCESSï¼‰ ã€‚</p><p>æ€»ä¹‹ï¼Œå½“ä½ ç¢°åˆ° EXC_BAD_ACCESS ï¼Œè¿™æ„å‘³ç€ä½ è¯•å›¾å‘é€æ¶ˆæ¯åˆ°çš„å†…å­˜å—ï¼Œä½†å†…å­˜å—æ— æ³•æ‰§è¡Œè¯¥æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ EXC_BAD_ACCESS æ˜¯ç”±è¢«æŸåçš„æŒ‡é’ˆå¼•èµ·çš„ã€‚æ¯å½“ä½ çš„åº”ç”¨ç¨‹åºå°è¯•å¼•ç”¨æŸåçš„æŒ‡é’ˆï¼Œä¸€ä¸ªå¼‚å¸¸å°±ä¼šè¢«å†…æ ¸æŠ›å‡ºã€‚</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs smali">static NSMutableArray *array;<br> <br>- (void)viewDidLoad<br>&#123;<br>    [super viewDid<span class="hljs-class">Load];</span><br>   <span class="hljs-built_in"> array </span>= [[NSMutableArray alloc] initWithCapacity:5];<br>    [array release];<br>&#125;<br> <br>- (void) viewWillAppear:(BOOL)animated <br>&#123;<br>    [array addObject:@<span class="hljs-string">&quot;Hello&quot;</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å°±ä¼šå‡ºç° EXC_BAD_ACCESS é”™è¯¯ï¼Œé”™è¯¯æ—¥å¿—ä¸ºï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smali">-[CALayerArray addObject:]: unrecognized selector sent to<span class="hljs-built_in"> instance </span>0x604000443480<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ 0x604000443480 å°±æ˜¯ array å˜é‡çš„åœ°å€ã€‚</p><p><strong>psï¼š</strong> Xcode7.0 ä¹‹åçš„ç‰ˆæœ¬åœ¨ç¼–è¯‘ä¸Šé¢çš„ä»£ç æ—¶ï¼Œä¼šåœ¨â€œ[array release];â€å¤„æŠ¥é”™ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">release <span class="hljs-keyword">is</span> unavailable <span class="hljs-keyword">in</span> <span class="hljs-built_in">auto</span>matic <span class="hljs-built_in">ref</span>erence counting mode<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œä¸ºäº†æ¨¡æ‹Ÿä¸Šé¢çš„ EXC_BAD_ACCESS é”™è¯¯ï¼Œéœ€è¦å¯¹ç¼–è¯‘ç¯å¢ƒè¿›è¡Œè®¾ç½®ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">B<span class="hljs-function"><span class="hljs-title">uild</span> Settings -&gt;</span> O<span class="hljs-function"><span class="hljs-title">bjective</span>-C Automatic Reference Counting -&gt;</span> NOã€‚<br></code></pre></td></tr></table></figure><hr><h3 id="2ã€å’‹è°ƒè¯•ï¼Ÿï¼ˆZombie-æ¨¡å¼ï¼‰"><a href="#2ã€å’‹è°ƒè¯•ï¼Ÿï¼ˆZombie-æ¨¡å¼ï¼‰" class="headerlink" title="2ã€å’‹è°ƒè¯•ï¼Ÿï¼ˆZombie æ¨¡å¼ï¼‰"></a>2ã€å’‹è°ƒè¯•ï¼Ÿï¼ˆZombie æ¨¡å¼ï¼‰</h3><p>EXC_BAD_ACCESS éš¾ä»¥è°ƒè¯•çš„åŸå› æ˜¯ï¼Œä½ ä¸çŸ¥é“ä½ çš„åº”ç”¨ç¨‹åºè¯•å›¾è®¿é—®å“ªä¸ªå¯¹è±¡æ—¶å‡ºäº†é—®é¢˜ã€‚åœ¨ Xcode ä¸­ï¼Œå¯ç”¨åƒµå°¸å¯¹è±¡æ„å‘³ç€è¢«é‡Šæ”¾çš„å¯¹è±¡å°†ä¼šä»¥åƒµå°¸çš„å½¢å¼è¢«ä¿ç•™ã€‚å¦‚æœå‘åƒµå°¸å¯¹è±¡å‘é€æ¶ˆæ¯ï¼Œåº”ç”¨ç¨‹åºå°†ä¼šç”±äº EXC_BAD_ACCESS è€Œå´©æºƒï¼Œæ­¤æ—¶ Xcode å°±å¯ä»¥å‘Šè¯‰ä½ ä½ è¯•å›¾è®¿é—®çš„æ˜¯å“ªä¸ªåƒµå°¸å¯¹è±¡ã€‚</p><p>ä¸‹é¢æ˜¯åœ¨ Xcode9.2 ä¸­å¼€å¯åƒµå°¸è°ƒè¯•æ¨¡å¼çš„æ­¥éª¤ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">å·¦ä¸Šè§’E<span class="hljs-function"><span class="hljs-title">dit</span> Scheme -&gt;</span> R<span class="hljs-function"><span class="hljs-title">un</span> -&gt;</span> D<span class="hljs-function"><span class="hljs-title">iagnostics</span> -&gt;</span> å‹¾é€‰Zombie Objects<br></code></pre></td></tr></table></figure><p>è®¾ç½®å®Œä¹‹åè¿˜æ˜¯ä¸Šé¢çš„ä»£ç ï¼Œå†æ¬¡è¿è¡Œä¹‹åï¼Œä¼šæ‰“å°å¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali">Thread 1: EXC_BAD_INSTRUCTION (code=EXC_I386_INVOP, subcode=0x0)<br>*** -[__NSArrayM addObject:]: message sent to deallocated<span class="hljs-built_in"> instance </span>0x60400045d1c0<br></code></pre></td></tr></table></figure><p>æ‰¾åˆ°é—®é¢˜åè®°å¾—è¿˜åŸ schemeä¸­çš„ Zombie è®¾ç½®ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¼‚å¸¸</tag>
      
      <tag>å†…å­˜ç®¡ç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>weak çš„å®ç°åŸç†</title>
    <link href="/2017/11/27/weak.html"/>
    <url>/2017/11/27/weak.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>weak è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œä¸ä¼šå¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå¹¶ä¸”åœ¨æ‰€æŒ‡å‘çš„å¯¹è±¡è¢«é‡Šæ”¾ä¹‹åï¼Œweak æŒ‡é’ˆä¼šè¢«ç½®ä¸ºnilã€‚weak å¼•ç”¨é€šå¸¸æ˜¯ç”¨äºå¤„ç†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚</p></blockquote><h2 id="å®ç°åŸç†ï¼š"><a href="#å®ç°åŸç†ï¼š" class="headerlink" title="å®ç°åŸç†ï¼š"></a>å®ç°åŸç†ï¼š</h2><ul><li>åˆå§‹åŒ–ï¼š</li></ul><p>runtime è°ƒç”¨ <code>objc_initWeak</code> å‡½æ•°ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ <code>weak</code> æŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€ã€‚</p><ul><li>æ·»åŠ å¼•ç”¨ï¼š</li></ul><p><code>objc_initWeak</code> è°ƒç”¨ <code>objc_storeWeak</code> æ¥æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚</p><ul><li>é‡Šæ”¾ï¼š</li></ul><p>è°ƒç”¨ <code>clearDeallocating</code> å‡½æ•°ï¼Œå…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰ weak æŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼›å†éå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®ç½®ä¸º nilï¼›ç„¶åæŠŠè¿™ä¸ª entry ä» weak è¡¨ä¸­åˆ é™¤ï¼›æœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚</p><h3 id="1-åˆå§‹åŒ–"><a href="#1-åˆå§‹åŒ–" class="headerlink" title="1.åˆå§‹åŒ–"></a>1.åˆå§‹åŒ–</h3><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">NSObject *newObj <span class="hljs-operator">=</span> [[NSObject alloc] init]<span class="hljs-comment">;</span><br>id __weak weakObj <span class="hljs-operator">=</span> newObj<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ– weak å˜é‡æ—¶ï¼ŒRuntime ä¼šè°ƒç”¨ <a href="https://opensource.apple.com//source/objc4/objc4-680/runtime/NSObject.mm">NSObject.mm</a> ä¸­çš„ objc_initWeak å‡½æ•°ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * Initialize a fresh weak pointer to some object location. </span><br><span class="hljs-comment"> * It would be used for code like: </span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * (The nil case) </span><br><span class="hljs-comment"> * __weak id weakPtr;</span><br><span class="hljs-comment"> * (The non-nil case) </span><br><span class="hljs-comment"> * NSObject *o = ...;</span><br><span class="hljs-comment"> * __weak id weakPtr = o;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @param location Address of __weak ptr. </span><br><span class="hljs-comment"> * @param newObj Object ptr. </span><br><span class="hljs-comment"> */</span><br> <br>id objc_initWeak(id *location, id <span class="hljs-keyword">new</span><span class="hljs-type">Obj</span>) &#123;<br><span class="hljs-comment">// æŸ¥çœ‹å¯¹è±¡å®ä¾‹æ˜¯å¦æœ‰æ•ˆ</span><br><span class="hljs-comment">// æ— æ•ˆå¯¹è±¡ç›´æ¥å¯¼è‡´æŒ‡é’ˆé‡Šæ”¾</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">new</span><span class="hljs-type">Obj</span>) &#123;<br>        *location = nil;<br>        <span class="hljs-keyword">return</span> nil;<br>    &#125;<br>    <span class="hljs-keyword">return</span> storeWeak(location, (objc_object*)<span class="hljs-keyword">new</span><span class="hljs-type">Obj</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">id weakObj;<br>objc<span class="hljs-constructor">_initWeak(&amp;<span class="hljs-params">weakObj</span>, <span class="hljs-params">newObj</span>)</span>;<br></code></pre></td></tr></table></figure><p>å³<code>objc_initWeak</code>å°†<code>weakObj</code>å¯¹è±¡çš„æŒ‡é’ˆåŠ<code>newObj</code>å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæœ€ç»ˆè°ƒç”¨<code>storeWeak</code>æ–¹æ³•ã€‚</p><h3 id="2-æ·»åŠ å¼•ç”¨"><a href="#2-æ·»åŠ å¼•ç”¨" class="headerlink" title="2.æ·»åŠ å¼•ç”¨"></a>2.æ·»åŠ å¼•ç”¨</h3><p><code>objc_storeWeak()</code> çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨ï¼Œè¯¦ç»†å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">id objc<span class="hljs-constructor">_storeWeak(<span class="hljs-params">id</span> <span class="hljs-operator">*</span><span class="hljs-params">location</span>, <span class="hljs-params">id</span> <span class="hljs-params">newObj</span>)</span><br>&#123;<br>    id oldObj;<br>    SideTable *oldTable;<br>    SideTable *newTable;<br>    ......<br>    <span class="hljs-comment">// Acquire locks for old and new values.</span><br>    <span class="hljs-comment">// Order by lock address to prevent lock ordering problems. </span><br>    <span class="hljs-comment">// Retry if the old value changes underneath us.</span><br> retry:<br>    oldObj = *location;<br>    oldTable = SideTable::table<span class="hljs-constructor">ForPointer(<span class="hljs-params">oldObj</span>)</span>;<br>    newTable = SideTable::table<span class="hljs-constructor">ForPointer(<span class="hljs-params">newObj</span>)</span>;<br>    ......<br>    <span class="hljs-keyword">if</span> (*location != oldObj) &#123;<br>        <span class="hljs-constructor">OSSpinLockUnlock(<span class="hljs-params">lock1</span>)</span>;<br>#<span class="hljs-keyword">if</span> SIDE_TABLE_STRIPE &gt; <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> (lock1 != lock2) <span class="hljs-constructor">OSSpinLockUnlock(<span class="hljs-params">lock2</span>)</span>;<br>#endif<br>        goto retry;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (oldObj) &#123;<br>        weak<span class="hljs-constructor">_unregister_no_lock(&amp;<span class="hljs-params">oldTable</span>-&gt;<span class="hljs-params">weak_table</span>, <span class="hljs-params">oldObj</span>, <span class="hljs-params">location</span>)</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (newObj) &#123;<br>        newObj = weak<span class="hljs-constructor">_register_no_lock(&amp;<span class="hljs-params">newTable</span>-&gt;<span class="hljs-params">weak_table</span>, <span class="hljs-params">newObj</span>,<span class="hljs-params">location</span>)</span>;<br>        <span class="hljs-comment">// weak_register_no_lock returns NULL if weak store should be rejected</span><br>    &#125;<br>    <span class="hljs-comment">// Do not set *location anywhere else. That would introduce a race.</span><br>    *location = newObj;<br>    ......<br>    return newObj;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆæ˜¯æ ¹æ® weak æŒ‡é’ˆæ‰¾åˆ°å…¶æŒ‡å‘çš„è€å¯¹è±¡ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">oldObj</span> <span class="hljs-operator">=</span> *location<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>ç„¶åè·å–åˆ°ä¸æ–°æ—§å¯¹è±¡ç›¸å…³çš„ <code>SideTable</code> å¯¹è±¡ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">oldTable</span> = SideTable::tableForPointer(oldObj)<span class="hljs-comment">;</span><br><span class="hljs-attr">newTable</span> = SideTable::tableForPointer(newObj)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨è€å¯¹è±¡çš„ <code>å¼±å¼•ç”¨è¡¨</code> ä¸­ç§»é™¤æŒ‡å‘ä¿¡æ¯ï¼Œè€Œåœ¨æ–°å¯¹è±¡çš„ <code>å¼±å¼•ç”¨è¡¨</code> ä¸­å»ºç«‹å…³è”ä¿¡æ¯ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">if</span> (oldObj) &#123;<br>    weak<span class="hljs-constructor">_unregister_no_lock(&amp;<span class="hljs-params">oldTable</span>-&gt;<span class="hljs-params">weak_table</span>, <span class="hljs-params">oldObj</span>, <span class="hljs-params">location</span>)</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (newObj) &#123;<br>    newObj = weak<span class="hljs-constructor">_register_no_lock(&amp;<span class="hljs-params">newTable</span>-&gt;<span class="hljs-params">weak_table</span>, <span class="hljs-params">newObj</span>,<span class="hljs-params">location</span>)</span>;<br>    <span class="hljs-comment">// weak_register_no_lock returns NULL if weak store should be rejected</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°†å¼±å¼•ç”¨æŒ‡é’ˆæŒ‡å‘æ–°çš„å¯¹è±¡ï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">*<span class="hljs-keyword">location</span> <span class="hljs-title">= newObj</span>;<br></code></pre></td></tr></table></figure><p>æœ€åè¿”å›è¿™ä¸ªæ–°å¯¹è±¡ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span><span class="hljs-type">Obj</span>;<br></code></pre></td></tr></table></figure><p>å°ç»“ï¼š<code>objc_storeWeak</code>æœ€ç»ˆå°†<code>weakObj</code>çš„æŒ‡é’ˆæŒ‡å‘<code>newObj</code>ï¼ŒåŒæ—¶å°†äºŒè€…ä¿å­˜åˆ°<code>SideTable</code>ä¸­ã€‚</p><hr><h4 id="2-1-SideTable"><a href="#2-1-SideTable" class="headerlink" title="2.1.SideTable"></a>2.1.SideTable</h4><p>ä¸ºäº†ç®¡ç†æ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œ <code>weak</code> æŒ‡é’ˆï¼Œç³»ç»Ÿåˆ›å»ºäº†ä¸€ä¸ªå…¨å±€çš„ <code>SideTables</code>ã€‚å®ƒæ˜¯ä¸€ä¸ªå…¨å±€çš„ <code>hash</code> è¡¨ï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯ <code>SideTable</code> ç»“æ„ä½“ã€‚<code>SideTables</code> ä½¿ç”¨å¯¹è±¡çš„å†…å­˜åœ°å€ä½œä¸º <code>key</code>ï¼Œé€šè¿‡ <code>SideTables[key]</code> æ¥å¾—åˆ° <code>SideTable</code>ã€‚è¿™ä¸ª <code>SideTable</code> çš„æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SideTable</span> &#123;<br>    <span class="hljs-comment">// ä¿è¯åŸå­æ“ä½œçš„è‡ªæ—‹é”</span><br>    <span class="hljs-type">spinlock_t</span> slock;<br>    <span class="hljs-comment">// å¼•ç”¨è®¡æ•°çš„ hash è¡¨</span><br>    RefcountMap refcnts;<br>    <span class="hljs-comment">// å…¨å±€çš„å¼±å¼•ç”¨ hash è¡¨</span><br>    <span class="hljs-type">weak_table_t</span> weak_table;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-å¼±å¼•ç”¨è¡¨"><a href="#2-2-å¼±å¼•ç”¨è¡¨" class="headerlink" title="2.2.å¼±å¼•ç”¨è¡¨"></a>2.2.å¼±å¼•ç”¨è¡¨</h4><p>runtime ç»´æŠ¤äº†ä¸€ä¸ª<code>å¼±å¼•ç”¨è¡¨</code>ï¼Œå³ä¸Šé¢ <code>SideTable</code> ç»“æ„ä½“ä¸­æœ€åä¸€ä¸ªå‚æ•° <code>weak_table_t</code>ã€‚å®ƒå­˜å‚¨äº†æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨ä¿¡æ¯ï¼Œå…¶æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">weak_table_t</span> &#123;<br>    <span class="hljs-comment">// ä¿å­˜äº†æ‰€æœ‰æŒ‡å‘æŒ‡å®šå¯¹è±¡çš„ weak æŒ‡é’ˆ</span><br>    <span class="hljs-type">weak_entry_t</span> *weak_entries;<br>    <span class="hljs-comment">// å­˜å‚¨ç©ºé—´</span><br>    <span class="hljs-type">size_t</span>    num_entries;<br>    <span class="hljs-comment">// å‚ä¸åˆ¤æ–­å¼•ç”¨è®¡æ•°è¾…åŠ©é‡</span><br>    <span class="hljs-type">uintptr_t</span> mask;<br>    <span class="hljs-comment">// hash key æœ€å¤§åç§»å€¼</span><br>    <span class="hljs-type">uintptr_t</span> max_hash_displacement;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>weak_entry_t</code> æ˜¯å­˜å‚¨åœ¨å¼±å¼•ç”¨è¡¨ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç»“æ„ä½“ï¼Œå®ƒè´Ÿè´£ç»´æŠ¤å’Œå­˜å‚¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨ hash è¡¨ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> objc_object ** <span class="hljs-type">weak_referrer_t</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">weak_entry_t</span> &#123;<br>    DisguisedPtrobjc_object&gt; referent;<br>    <span class="hljs-keyword">union</span> &#123;<br>        <span class="hljs-keyword">struct</span> &#123;<br>            <span class="hljs-type">weak_referrer_t</span> *referrers;<br>            <span class="hljs-type">uintptr_t</span>        out_of_line : <span class="hljs-number">1</span>;<br>            <span class="hljs-type">uintptr_t</span>        num_refs : PTR_MINUS_1;<br>            <span class="hljs-type">uintptr_t</span>        mask;<br>            <span class="hljs-type">uintptr_t</span>        max_hash_displacement;<br>        &#125;;<br>        <span class="hljs-keyword">struct</span> &#123;<br>            <span class="hljs-comment">// out_of_line=0 is LSB of one of these (don&#x27;t care which)</span><br>            <span class="hljs-type">weak_referrer_t</span>  inline_referrers[WEAK_INLINE_COUNT];<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>referent</code> æ˜¯è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œå³ç¤ºä¾‹ä»£ç ä¸­çš„ <code>newObj</code> å¯¹è±¡ã€‚ä¸‹é¢çš„ <code>union</code> å³å­˜å‚¨äº†æ‰€æœ‰æŒ‡å‘è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨ã€‚ç”±æ³¨é‡Šå¯ä»¥çœ‹åˆ°ï¼Œå½“<code>out_of_line</code>ç­‰äº0æ—¶ï¼Œhashè¡¨è¢«ä¸€ä¸ªæ•°ç»„æ‰€ä»£æ›¿ã€‚å¦å¤–ï¼Œæ‰€æœ‰çš„å¼±å¼•ç”¨å¯¹è±¡çš„åœ°å€éƒ½æ˜¯å­˜å‚¨åœ¨<code>weak_referrer_t</code>æŒ‡é’ˆçš„åœ°å€ä¸­ã€‚</p><h3 id="3-é‡Šæ”¾"><a href="#3-é‡Šæ”¾" class="headerlink" title="3.é‡Šæ”¾"></a>3.é‡Šæ”¾</h3><p>å½“ <code>weak</code> æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡çš„å¼•ç”¨è®¡æ•°&#x3D;0æ—¶ï¼Œè§¦å‘å¯¹è±¡çš„ <code>dealloc</code> å‡½æ•°ï¼Œææ„çš„è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>3.1.<code>è°ƒç”¨_objc_rootDealloc</code> å‡½æ•°ï¼š</li></ul><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs scss">- (void)dealloc &#123;<br>    <span class="hljs-built_in">_objc_rootDealloc</span>(self);<br>&#125;<br><br>void <span class="hljs-built_in">_objc_rootDealloc</span>(id obj)<br>&#123;<br>    <span class="hljs-built_in">assert</span>(obj);<br>    obj-&gt;<span class="hljs-built_in">rootDealloc</span>();<br>&#125;<br><br>inline void objc_object::<span class="hljs-built_in">rootDealloc</span>()<br>&#123;<br>    if (isTaggedPointer()) return; <br><br>    if (fastpath(isa.nonpointer  &amp;&amp;  <br>                 !isa.weakly_referenced  &amp;&amp;  <br>                 !isa.has_assoc  &amp;&amp;  <br>                 !isa.has_cxx_dtor  &amp;&amp;  <br>                 !isa.has_sidetable_rc))<br>    &#123;<br>        <span class="hljs-built_in">assert</span>(!sidetable_present());<br>        <span class="hljs-built_in">free</span>(this);<br>    &#125; <br>    else &#123;<br>        <span class="hljs-built_in">object_dispose</span>((id)this);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>rootDealloc</code>ä¸­ä¼šåˆ¤æ–­æ˜¯å¦æœ‰å¼±å¼•ç”¨è¡¨å’Œ <code>SideTable</code> ç­‰ï¼Œæ²¡æœ‰å°±é€šè¿‡<code>free</code>å‡½æ•°æ¸…é™¤å¯¹è±¡å†…å­˜ï¼›æœ‰å°±ç»§ç»­è°ƒç”¨ <code>object_dispose</code> å‡½æ•°ï¼š</p><ul><li>3.2.è°ƒç”¨ <code>objc_destructInstance</code> å‡½æ•°å¹¶æœ€ç»ˆé‡Šæ”¾å¯¹è±¡å†…å­˜ï¼š</li></ul><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">id <span class="hljs-keyword">object</span><span class="hljs-constructor">_dispose(<span class="hljs-params">id</span> <span class="hljs-params">obj</span>)</span> <br>&#123;<br>    <span class="hljs-keyword">if</span> (!obj) return nil;<br><br>    objc<span class="hljs-constructor">_destructInstance(<span class="hljs-params">obj</span>)</span>;    <br>    free(obj);<br>    return nil;<br>&#125;<br><br>void *objc<span class="hljs-constructor">_destructInstance(<span class="hljs-params">id</span> <span class="hljs-params">obj</span>)</span> <br>&#123;<br>    <span class="hljs-keyword">if</span> (obj) &#123;<br>        <span class="hljs-comment">// Read all of the flags at once for performance.</span><br>        <span class="hljs-built_in">bool</span> cxx = obj-&gt;has<span class="hljs-constructor">CxxDtor()</span>;<br>        <span class="hljs-built_in">bool</span> assoc = obj-&gt;has<span class="hljs-constructor">AssociatedObjects()</span>;<br><br>        <span class="hljs-comment">// This order is important.</span><br>        <span class="hljs-keyword">if</span> (cxx) <span class="hljs-keyword">object</span><span class="hljs-constructor">_cxxDestruct(<span class="hljs-params">obj</span>)</span>;<br>        <span class="hljs-keyword">if</span> (assoc) <span class="hljs-constructor">_object_remove_assocations(<span class="hljs-params">obj</span>)</span>;<br>        obj-&gt;clear<span class="hljs-constructor">Deallocating()</span>;<br>    &#125;<br>    return obj;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œ<code>object_cxxDestruct</code> æ˜¯ç”¨æ¥é‡Šæ”¾å¯¹è±¡çš„å®ä¾‹å˜é‡ï¼›<code>_object_remove_assocations</code>ç”¨æ¥ç§»é™¤æ‰€æœ‰å…³è”çš„å±æ€§ï¼›</p><ul><li>3.3.è°ƒç”¨ <code>objc_clear_deallocating</code> å‡½æ•°ï¼š</li></ul><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">void objc<span class="hljs-constructor">_clear_deallocating(<span class="hljs-params">id</span> <span class="hljs-params">obj</span>)</span> <br>&#123;<br>    ......<br>    SideTable *table = SideTable::table<span class="hljs-constructor">ForPointer(<span class="hljs-params">obj</span>)</span>;<br>    <span class="hljs-comment">// clear any weak table items</span><br>    <span class="hljs-comment">// clear extra retain count and deallocating bit</span><br>    <span class="hljs-comment">// (fixme warn or abort if extra retain count == 0 ?)</span><br>    <span class="hljs-constructor">OSSpinLockLock(&amp;<span class="hljs-params">table</span>-&gt;<span class="hljs-params">slock</span>)</span>;<br>    <span class="hljs-keyword">if</span> (seen_weak_refs) &#123;<br>        arr<span class="hljs-constructor">_clear_deallocating(&amp;<span class="hljs-params">table</span>-&gt;<span class="hljs-params">weak_table</span>, <span class="hljs-params">obj</span>)</span>;<br>    &#125;<br>    ......<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆå–å‡ºå¯¹è±¡å¯¹åº”çš„ <code>SideTable</code> å®ä¾‹ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡æœ‰å…³è”çš„å¼±å¼•ç”¨ï¼Œåˆ™è°ƒç”¨ arr_clear_deallocating æ¥æ¸…é™¤å¯¹è±¡çš„å¼±å¼•ç”¨ä¿¡æ¯ã€‚</p><ul><li>3.4.è°ƒç”¨ <code>arr_clear_deallocating</code> å‡½æ•°ï¼š</li></ul><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">PRIVATE_EXTERN <span class="hljs-built_in">void</span> arr_clear_deallocating(weak_table_t *weak_table, id <span class="hljs-built_in">ref</span>erent) &#123;<br>    &#123;<br>        weak_entry_t *entry = weak_entry_for_referent(weak_table, <span class="hljs-built_in">ref</span>erent);<br>        <span class="hljs-keyword">if</span> (entry == NULL) &#123;<br>            ......<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// zero out references</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; entry-&gt;<span class="hljs-built_in">ref</span>errers.num_allocated; ++i) &#123;<br>            id *<span class="hljs-built_in">ref</span>errer = entry-&gt;<span class="hljs-built_in">ref</span>errers.<span class="hljs-built_in">ref</span>s[i].<span class="hljs-built_in">ref</span>errer;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ref</span>errer) &#123;<br>                <span class="hljs-keyword">if</span> (*<span class="hljs-built_in">ref</span>errer == <span class="hljs-built_in">ref</span>erent) &#123;<br>                    *<span class="hljs-built_in">ref</span>errer = nil;<br>                &#125;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*<span class="hljs-built_in">ref</span>errer) &#123;<br>                    _objc_inform(<span class="hljs-string">&quot;__weak variable @ %p holds %p instead of %p\n&quot;</span>, <br>                    <span class="hljs-built_in">ref</span>errer, *<span class="hljs-built_in">ref</span>errer, <span class="hljs-built_in">ref</span>erent);<br>                &#125;<br>            &#125;<br>        &#125;<br>        weak_entry_remove_no_lock(weak_table, entry);<br>        weak_table-&gt;num_weak_refs--;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ‰¾å‡ºå¯¹è±¡å¯¹åº”çš„ <code>weak_entry_t</code> é“¾è¡¨ï¼Œç„¶åæŒ¨ä¸ªå°†å¼±å¼•ç”¨ç½®ä¸º nilï¼Œæœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•ã€‚</p><h3 id="4-åè®°"><a href="#4-åè®°" class="headerlink" title="4.åè®°"></a>4.åè®°</h3><p>ä¸€ä¸ª weak å¼•ç”¨çš„å¤„ç†æ¶‰åŠå„ç§æŸ¥è¡¨ã€æ·»åŠ ä¸åˆ é™¤æ“ä½œï¼Œè¿˜æ˜¯æœ‰ä¸€å®šæ¶ˆè€—çš„ã€‚æ‰€ä»¥å¦‚æœå¤§é‡ä½¿ç”¨ weak å˜é‡çš„è¯ï¼Œä¼šå¯¹æ€§èƒ½é€ æˆä¸€å®šçš„å½±å“ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™å»ä½¿ç”¨ weak å‘¢ï¼Ÿã€ŠObjective-Cé«˜çº§ç¼–ç¨‹ã€‹ç»™æˆ‘ä»¬çš„å»ºè®®æ˜¯åªåœ¨é¿å…å¾ªç¯å¼•ç”¨çš„æ—¶å€™ä½¿ç”¨ <code>__weak</code> ä¿®é¥°ç¬¦ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="http://www.cocoachina.com/ios/20150605/11990.html">Â©CocoaChina</a><br>#<a href="https://www.jianshu.com/p/1be2526f5879">Â©åˆå¿ƒä¸¶å¯æ›¾è®°-dealloc</a></p>]]></content>
    
    
    <categories>
      
      <category>è¯¾å¤–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æœºåˆ¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ²™ç›’ &amp; æœ¬åœ°æŒä¹…åŒ–æ–¹æ¡ˆ</title>
    <link href="/2017/11/25/sandbox.html"/>
    <url>/2017/11/25/sandbox.html</url>
    
    <content type="html"><![CDATA[<h3 id="1ã€æ²™ç›’"><a href="#1ã€æ²™ç›’" class="headerlink" title="1ã€æ²™ç›’"></a>1ã€æ²™ç›’</h3><blockquote><p>iOSç¨‹åºé»˜è®¤æƒ…å†µä¸‹åªèƒ½è®¿é—®ç¨‹åºè‡ªå·±çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•è¢«ç§°ä¸ºâ€œæ²™ç›’â€ã€‚</p></blockquote><p>æ²™ç›’çš„ç›®å½•ç»“æ„ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">&quot;åº”ç”¨ç¨‹åºåŒ…&quot;<br><span class="hljs-bullet">-</span> Documents<br><span class="hljs-bullet">-</span> Library<br>  <span class="hljs-emphasis">*Caches</span><br><span class="hljs-emphasis">  *</span>Preferences<br><span class="hljs-bullet">-</span> tmp<br></code></pre></td></tr></table></figure><h4 id="1-1-â€åº”ç”¨ç¨‹åºåŒ…â€"><a href="#1-1-â€åº”ç”¨ç¨‹åºåŒ…â€" class="headerlink" title="1.1.â€åº”ç”¨ç¨‹åºåŒ…â€:"></a>1.1.â€åº”ç”¨ç¨‹åºåŒ…â€:</h4><p>è¿™é‡Œå­˜æ”¾çš„æ˜¯åº”ç”¨ç¨‹åºçš„æºæ–‡ä»¶ï¼ŒåŒ…æ‹¬èµ„æºæ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">String *path = [[<span class="hljs-built_in">NSBundle</span> mainBundle] bundlePath];<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, path);<br></code></pre></td></tr></table></figure><h4 id="1-2-Documents"><a href="#1-2-Documents" class="headerlink" title="1.2.Documents:"></a>1.2.Documents:</h4><p>æœ€å¸¸ç”¨çš„ç›®å½•ï¼ŒiTunesåŒæ­¥è¯¥åº”ç”¨æ—¶ä¼šåŒæ­¥æ­¤æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ï¼Œé€‚åˆå­˜å‚¨é‡è¦æ•°æ®ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *path = <span class="hljs-built_in">NSSearchPathForDirectoriesInDomains</span>(<br><span class="hljs-built_in">NSDocumentDirectory</span>,<br><span class="hljs-built_in">NSUserDomainMask</span>,<br><span class="hljs-literal">YES</span>).firstObject;<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>,path);<br></code></pre></td></tr></table></figure><h4 id="1-3-Library-x2F-Caches"><a href="#1-3-Library-x2F-Caches" class="headerlink" title="1.3.Library&#x2F;Caches:"></a>1.3.Library&#x2F;Caches:</h4><p>iTunesä¸ä¼šåŒæ­¥æ­¤æ–‡ä»¶å¤¹ï¼Œé€‚åˆå­˜å‚¨ä½“ç§¯å¤§ï¼Œä¸éœ€è¦å¤‡ä»½çš„éé‡è¦æ•°æ®ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *path = <span class="hljs-built_in">NSSearchPathForDirectoriesInDomains</span>(<br><span class="hljs-built_in">NSCachesDirectory</span>,<br><span class="hljs-built_in">NSUserDomainMask</span>, <span class="hljs-literal">YES</span>).firstObject;<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>,path);<br></code></pre></td></tr></table></figure><h4 id="1-4-Library-x2F-Preferences"><a href="#1-4-Library-x2F-Preferences" class="headerlink" title="1.4.Library&#x2F;Preferences:"></a>1.4.Library&#x2F;Preferences:</h4><p>iTunesåŒæ­¥è¯¥åº”ç”¨æ—¶ä¼šåŒæ­¥æ­¤æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ï¼Œé€šå¸¸ä¿å­˜åº”ç”¨çš„è®¾ç½®ä¿¡æ¯ã€‚</p><h4 id="1-5-tmp"><a href="#1-5-tmp" class="headerlink" title="1.5.tmp:"></a>1.5.tmp:</h4><p>iTunesä¸ä¼šåŒæ­¥æ­¤æ–‡ä»¶å¤¹ï¼Œç³»ç»Ÿå¯èƒ½åœ¨åº”ç”¨æ²¡è¿è¡Œæ—¶å°±åˆ é™¤è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œæ‰€ä»¥æ­¤ç›®å½•é€‚åˆä¿å­˜åº”ç”¨ä¸­çš„ä¸€äº›ä¸´æ—¶æ–‡ä»¶ï¼Œç”¨å®Œå°±åˆ é™¤ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *path = <span class="hljs-built_in">NSTemporaryDirectory</span>();<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, path);<br></code></pre></td></tr></table></figure><hr><h3 id="2ã€æœ¬åœ°æŒä¹…åŒ–æ–¹æ¡ˆ"><a href="#2ã€æœ¬åœ°æŒä¹…åŒ–æ–¹æ¡ˆ" class="headerlink" title="2ã€æœ¬åœ°æŒä¹…åŒ–æ–¹æ¡ˆ"></a>2ã€æœ¬åœ°æŒä¹…åŒ–æ–¹æ¡ˆ</h3><h4 id="2-1-plistæ–‡ä»¶"><a href="#2-1-plistæ–‡ä»¶" class="headerlink" title="2.1.plistæ–‡ä»¶"></a>2.1.plistæ–‡ä»¶</h4><p>é€šè¿‡XMLæ–‡ä»¶çš„æ–¹å¼ä¿å­˜æ•°æ®ï¼Œæ”¯æŒä¿å­˜çš„æ•°æ®ç±»å‹æœ‰ï¼š</p><ol><li>NSArray;</li><li>NSMutableArray;</li><li>NSDictionary;</li><li>NSMutableDictionary;</li><li>NSData;</li><li>NSMutableData;</li><li>NSString;</li><li>NSMutableString;</li><li>NSNumber;</li><li>NSDate;</li></ol><p>plistè¯»å†™æ•°æ®ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *path = <span class="hljs-built_in">NSSearchPathForDirectoriesInDomains</span>(<br><span class="hljs-built_in">NSDocumentDirectory</span>,<span class="hljs-built_in">NSUserDomainMask</span>,<span class="hljs-literal">YES</span>).firstObject;<br><br><span class="hljs-built_in">NSString</span> *fileName = [path stringByAppendingPathComponent:<span class="hljs-string">@&quot;nameXX.plist&quot;</span>];<br><br><span class="hljs-built_in">NSArray</span> *array = @[<span class="hljs-string">@&quot;1&quot;</span>, <span class="hljs-string">@&quot;2&quot;</span>, <span class="hljs-string">@&quot;3&quot;</span>];<br>[array writeToFile:fileName atomically:<span class="hljs-literal">YES</span>];<br><br><span class="hljs-built_in">NSArray</span> *result = [<span class="hljs-built_in">NSArray</span> arrayWithContentsOfFile:fileName];<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, result);<br></code></pre></td></tr></table></figure><h4 id="2-2-KeyChain-é’¥åŒ™ä¸²"><a href="#2-2-KeyChain-é’¥åŒ™ä¸²" class="headerlink" title="2.2.KeyChain é’¥åŒ™ä¸²"></a>2.2.KeyChain é’¥åŒ™ä¸²</h4><p>ä¿¡æ¯å­˜å‚¨åˆ°é’¥åŒ™ä¸²ä¸­ä¹‹åï¼Œåœ¨åº”ç”¨åˆ é™¤é‡æ–°å®‰è£…æ—¶ï¼Œä»ç„¶èƒ½å–å‡ºä¹‹å‰ä¿å­˜çš„å€¼ã€‚å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“UICKeyChainStoreå®ç°é’¥åŒ™ä¸²å­˜å‚¨æ“ä½œï¼ˆ<a href="https://github.com/kishikawakatsumi/UICKeyChainStore">Githubåœ°å€</a>ï¼‰ã€‚</p><h4 id="2-3-preferenceï¼ˆåå¥½è®¾ç½®ï¼‰"><a href="#2-3-preferenceï¼ˆåå¥½è®¾ç½®ï¼‰" class="headerlink" title="2.3.preferenceï¼ˆåå¥½è®¾ç½®ï¼‰"></a>2.3.preferenceï¼ˆåå¥½è®¾ç½®ï¼‰</h4><p>ç”¨æ¥ä¿å­˜åº”ç”¨ç¨‹åºçš„é…ç½®ä¿¡æ¯çš„ã€‚å¦‚æœéœ€è¦ç«‹å³å†™å…¥æ–‡ä»¶çš„å°±å¿…é¡»è°ƒç”¨synchronizeæ–¹æ³•ï¼Œå¦åˆ™ç³»ç»Ÿä¼šæ ¹æ®I&#x2F;Oæƒ…å†µä¸å®šæ—¶åˆ»åœ°ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span><span class="hljs-number">1</span>.è·å¾—NSUserDefaultsæ–‡ä»¶<br>NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];<br><span class="hljs-regexp">//</span><span class="hljs-number">2</span>.å‘æ–‡ä»¶ä¸­å†™å…¥å†…å®¹<br>[userDefaults setObject:@<span class="hljs-string">&quot;AAA&quot;</span> forKey:@<span class="hljs-string">&quot;a&quot;</span>];<br><span class="hljs-regexp">//</span><span class="hljs-number">2.1</span>ç«‹å³åŒæ­¥<br>[userDefaults synchronize];<br><br><span class="hljs-regexp">//</span><span class="hljs-number">3</span>.è¯»å–æ–‡ä»¶<br>NSString *name = [userDefaults objectForKey:@<span class="hljs-string">&quot;a&quot;</span>];<br>NSLog(@<span class="hljs-string">&quot;%@&quot;</span>, name);<br></code></pre></td></tr></table></figure><h4 id="2-4-NSKeyedArchiverï¼ˆå½’æ¡£ï¼‰"><a href="#2-4-NSKeyedArchiverï¼ˆå½’æ¡£ï¼‰" class="headerlink" title="2.4.NSKeyedArchiverï¼ˆå½’æ¡£ï¼‰"></a>2.4.NSKeyedArchiverï¼ˆå½’æ¡£ï¼‰</h4><p>å½’æ¡£ï¼Œåªè¦éµå¾ªäº† NSCoding åè®®çš„å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡å®ƒå®ç°åºåˆ—åŒ–ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Person</span> : <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">NSCoding</span>&gt;</span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">NSInteger</span> age;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Person</span></span><br><span class="hljs-comment">//è§£æ¡£</span><br>- (<span class="hljs-keyword">instancetype</span>)initWithCoder:(<span class="hljs-built_in">NSCoder</span> *)aDecoder<br>&#123;<br><span class="hljs-keyword">if</span> ([<span class="hljs-variable language_">super</span> init]) &#123;<br><span class="hljs-keyword">self</span>.name = [aDecoder decodeObjectForKey:<span class="hljs-string">@&quot;name&quot;</span>];<br><span class="hljs-keyword">self</span>.age = [aDecoder decodeIntegerForKey:<span class="hljs-string">@&quot;age&quot;</span>];<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><span class="hljs-comment">//å½’æ¡£</span><br>- (<span class="hljs-type">void</span>)encodeWithCoder:(<span class="hljs-built_in">NSCoder</span> *)aCoder<br>&#123;<br>[aCoder encodeObject:<span class="hljs-keyword">self</span>.name forKey:<span class="hljs-string">@&quot;name&quot;</span>];<br>[aCoder encodeInteger:<span class="hljs-keyword">self</span>.age forKey:<span class="hljs-string">@&quot;age&quot;</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å­˜å–ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSString</span> *file = [<span class="hljs-built_in">NSSearchPathForDirectoriesInDomains</span>(<br><span class="hljs-built_in">NSDocumentDirectory</span>, <span class="hljs-built_in">NSUserDomainMask</span>, <span class="hljs-literal">YES</span>).firstObject<br>stringByAppendingPathComponent:<span class="hljs-string">@&quot;person.data&quot;</span>];<br><span class="hljs-comment">//å­˜</span><br>Person *person = [[Person alloc] init];<br>person.name = <span class="hljs-string">@&quot;III&quot;</span>;<br>person.age = <span class="hljs-number">20</span>;<br>[<span class="hljs-built_in">NSKeyedArchiver</span> archiveRootObject:person toFile:file];<br><span class="hljs-comment">//å–</span><br>Person *newPerson = [<span class="hljs-built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:file];<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++%@&quot;</span>,newPerson.name);<br></code></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦å½’æ¡£çš„ç±»æ˜¯æŸä¸ªè‡ªå®šä¹‰ç±»çš„å­ç±»æ—¶ï¼Œå°±éœ€è¦åœ¨å½’æ¡£å’Œè§£æ¡£ä¹‹å‰å…ˆå®ç°çˆ¶ç±»çš„å½’æ¡£å’Œè§£æ¡£æ–¹æ³•ã€‚å³ [super encodeWithCoder:aCoder] å’Œ [super initWithCoder:aDecoder] æ–¹æ³•;</p><h4 id="2-5-CoreData"><a href="#2-5-CoreData" class="headerlink" title="2.5.CoreData"></a>2.5.CoreData</h4><p>æœªå®Œå¾…ç»­ã€‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS è®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦</title>
    <link href="/2017/11/25/udid_idfa.html"/>
    <url>/2017/11/25/udid_idfa.html</url>
    
    <content type="html"><![CDATA[<h4 id="1ã€UDID"><a href="#1ã€UDID" class="headerlink" title="1ã€UDID"></a>1ã€UDID</h4><p>UDIDï¼ˆUnique Device Identifierï¼‰ï¼ŒiOS è®¾å¤‡çš„å”¯ä¸€è¯†åˆ«ç ï¼Œæ˜¯ä¸€ä¸ª40ä½åå…­è¿›åˆ¶åºåˆ—ã€‚</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs inform7"><span class="hljs-comment">[<span class="hljs-comment">[UIDevice cuurrent]</span> uniqueIdenfier]</span>;<br></code></pre></td></tr></table></figure><p>ç§»åŠ¨å¹¿å‘Šå•†ç­‰å¾€å¾€éœ€è¦é€šè¿‡UDIDç”¨æ¥è¯†åˆ«ç©å®¶ç”¨æˆ·ï¼Œå¹¶å¯¹ç”¨æˆ·æ´»åŠ¨è¿›è¡Œè·Ÿè¸ªã€‚è¿™ä¼šæ³„éœ²ç”¨æˆ·çš„éšç§ä¿¡æ¯ï¼Œæ‰€ä»¥iOS5.0ä¹‹åï¼Œè‹¹æœå·²è¢«åºŸé™¤æ­¤æ–¹æ³•ï¼Œå¹¶ä¸”ç¦æ­¢ä½¿ç”¨UDIDä¿¡æ¯çš„APPä¸Šæ¶ã€‚</p><h4 id="2ã€UUID"><a href="#2ã€UUID" class="headerlink" title="2ã€UUID"></a>2ã€UUID</h4><p>UUIDï¼ˆUniversally Unique Identifierï¼‰ï¼Œé€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ˜¯ä¸€ä¸ª32ä½çš„åå…­è¿›åˆ¶åºåˆ—ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++%@&quot;</span>,[<span class="hljs-built_in">NSUUID</span> UUID]);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs subunit">++CA34E048-C879<span class="hljs-string">-4</span>BCA<span class="hljs-string">-8105</span><span class="hljs-string">-8</span>E6F3DA137C4<br>+<span class="hljs-string">+4</span>C808BD6-C7EE<span class="hljs-string">-4</span>E35-BEB5-B319F37BEA30<br>++C9B7AA3E<span class="hljs-string">-71</span>AD<span class="hljs-string">-462</span>B-BAC1<span class="hljs-string">-36</span>B9433B987F<br>++A8847816<span class="hljs-string">-7194</span><span class="hljs-string">-4</span>ECF<span class="hljs-string">-8</span>FA4<span class="hljs-string">-75</span>C566D68B21<br>+<span class="hljs-string">+6</span>C9FCC03-BCF7<span class="hljs-string">-4</span>B68<span class="hljs-string">-9</span>A98<span class="hljs-string">-8209</span>BF83690E<br></code></pre></td></tr></table></figure><p>å¾ªç¯5æ¬¡ï¼Œæ¯æ¬¡å–åˆ°çš„å€¼éƒ½ä¸ä¸€æ ·ã€‚æ‰€ä»¥å½“ç”¨æˆ·é‡æ–°å¯åŠ¨äº†åº”ç”¨æˆ–è€…åˆ é™¤åº”ç”¨é‡è£…åï¼ŒUUIDéƒ½ä¼šè¢«é‡ç½®ã€‚å› æ­¤ä½ éœ€è¦åœ¨åº”ç”¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶å°±å°†å…¶UUIDä¿å­˜åˆ°é’¥åŒ™ä¸²ä¸­ï¼Œä¹‹åä»é’¥åŒ™ä¸²ä¸­å–å€¼ã€‚<br><br/></p><p>å› ä¸ºæ¯æ¬¡ä½¿ç”¨ç³»ç»Ÿæ–¹æ³•è·å–åˆ°çš„UUIDéƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æ¯ä¸ªåº”ç”¨éƒ½ä¼šäº§ç”Ÿä¸ä¹‹å¯¹åº”çš„UUIDã€‚åƒæ·˜å®å’Œæ”¯ä»˜å®è´¦å·äº’é€šçš„è¿™ç§ç³»åˆ—åº”ç”¨ï¼Œå¦‚æœä»æ·˜å®åˆ‡åˆ°æ”¯ä»˜å®ï¼Œå› ä¸ºUUIDä¸ä¸€æ ·äº†å°±æç¤ºæ¢äº†è®¾å¤‡ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆå®é™…æƒ…å†µã€‚</p><h4 id="3ã€IDFV"><a href="#3ã€IDFV" class="headerlink" title="3ã€IDFV"></a>3ã€IDFV</h4><p>iOS6.0ä¹‹åï¼Œè‹¹æœæä¾›çš„æ–°æ–¹æ³•ã€‚å®ƒæ˜¯é€šè¿‡ bundleID çš„åè½¬çš„å‰ä¸¤éƒ¨åˆ†è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœå†…å®¹ç›¸åŒåˆ™è®¤ä¸ºæ˜¯åŒä¸€ä¸ªVendorï¼ˆä¾›åº”å•†ï¼‰ï¼Œä¾‹å¦‚å¯¹äº<code>com.example.app1</code>å’Œ<code>com.example.app2</code>è¿™ä¸¤ä¸ª bundleIDï¼Œå®ƒä»¬å°±å±äºåŒä¸€ä¸ª Vendorï¼Œå…±äº«åŒä¸€ä¸ª<code>IDFV</code>ã€‚è¿™æ ·å°±è§£å†³äº†ä¸Šé¢æåˆ°çš„è´¦å·äº’é€šç±»åº”ç”¨åˆ‡æ¢ç™»å½•æ—¶çš„é—®é¢˜ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">UIDevice *device <span class="hljs-operator">=</span> [UIDevice currentDevice]<span class="hljs-comment">;</span><br>NSUUID * uuid <span class="hljs-operator">=</span> [device identifierForVendor]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><strong>vendor</strong>ï¼ˆè¿è¥å•†ï¼‰çš„å€¼æ˜¯æ ¹æ®å·²ç»ä¸Šæ¶åˆ° Appstore çš„ App æ¥å†³å®šçš„ã€‚å¦‚æœåº”ç”¨ä¸æ˜¯é€šè¿‡ Appstore å®‰è£…çš„ï¼ˆå¦‚ä¼ä¸šç‰ˆæˆ–å¼€å‘è°ƒè¯•é˜¶æ®µï¼‰ï¼Œé‚£ä¹ˆä¼šæ ¹æ®<code>bundle ID</code>åˆ¤æ–­ã€‚<br><br/></p><p>iOS6.xä¸­ï¼Œä¼šå– bundleID çš„å‰ä¸¤ä¸ªéƒ¨åˆ†ç”Ÿæˆ <code>vendor ID</code>ï¼ˆ##com.example##.app.app1ï¼‰ã€‚<br><br/></p><p>iOS7.xä¹‹åï¼Œé™¤äº†æœ€åä¸€éƒ¨åˆ†å¤–ï¼Œå…¶ä»–éƒ¨åˆ†çš„ bundleID éƒ½ä¼šç”¨æ¥ç”Ÿæˆ<code>vendor ID</code>ï¼ˆ##com.example.app##.app1ï¼‰ã€‚<br><br/></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”¨æˆ·åˆ é™¤äº†æŸ APP é‡è£…åï¼ŒAPP é‡Œå†è·å– <code>IDFV</code> æ—¶ï¼Œå€¼å’Œä¹‹å‰çš„å°±ä¸åŒäº†ã€‚</p><h4 id="4ã€IDFA"><a href="#4ã€IDFA" class="headerlink" title="4ã€IDFA"></a>4ã€IDFA</h4><p>IDFA - identifierForIdentifierï¼ˆå¹¿å‘Šæ ‡ç¤ºç¬¦ï¼‰ï¼Œæ¯ä¸ªè®¾å¤‡åªæœ‰ä¸€ä¸ªIDFAï¼Œåœ¨åŒä¸€ä¸ªè®¾å¤‡ä¸Šçš„æ‰€æœ‰ APP éƒ½ä¼šå–åˆ°ç›¸åŒçš„å€¼ï¼Œæ˜¯iOS6 è‹¹æœä¸“é—¨ç»™å„å¹¿å‘Šæä¾›å•†ç”¨æ¥è¿½è¸ªç”¨æˆ·è€Œè®¾å®šçš„ã€‚è™½ç„¶ iPhone é»˜è®¤æ˜¯å…è®¸è¿½è¸ªçš„ï¼Œè€Œä¸”ä¸€èˆ¬ç”¨æˆ·éƒ½ä¸çŸ¥é“æœ‰è¿™ä¹ˆä¸ªè®¾ç½®ï¼Œä½†æ˜¯ç”¨æˆ·å¯ä»¥åœ¨ è®¾ç½® - éšç§ - å¹¿å‘Šè¿½è¸ª é‡Œé‡ç½®æ­¤ ID çš„å€¼ï¼Œæˆ–è€…é™åˆ¶æ­¤ ID çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šå–ä¸åˆ°å€¼ã€‚</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-comment">//ä¾èµ–åº“ï¼šAdSupport.framework</span><br>#<span class="hljs-keyword">import</span> &lt;AdSupport/AdSupport.h&gt;<br><span class="hljs-string">[[[ASIdentifierManager sharedManager]</span> advertisingIdentifier] UUIDString];<br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šApp Store ç¦æ­¢ä¸ä½¿ç”¨å¹¿å‘Šè€Œåªé‡‡é›† IDFA çš„ APP ä¸Šæ¶ã€‚</p><h4 id="5ã€OpenUDID"><a href="#5ã€OpenUDID" class="headerlink" title="5ã€OpenUDID"></a>5ã€OpenUDID</h4><p>UDID è¢«å¼ƒç”¨åï¼Œå¹¿å¤§å¼€å‘è€…éœ€è¦å¯»æ‰¾ä¸€ä¸ªå¯ä»¥æ›¿ä»£çš„ UDIDï¼Œå¹¶ä¸”ä¸å—è‹¹æœæ§åˆ¶çš„æ–¹æ¡ˆï¼Œç”±æ­¤ï¼ŒOpenUDID æˆä¸ºäº†å½“æ—¶ä½¿ç”¨æœ€å¹¿æ³›çš„å¼€æº UDID ä»£æ›¿æ–¹æ¡ˆã€‚OpenUDID åˆ©ç”¨ä¸€ä¸ªéå¸¸å·§å¦™çš„æ–¹æ³•åœ¨ä¸åŒç¨‹åºé—´å­˜å‚¨æ ‡ç¤ºç¬¦ï¼šåœ¨ç²˜è´´æ¿ä¸­ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„åç§°æ¥å­˜å‚¨æ ‡ç¤ºç¬¦ï¼Œé€šè¿‡è¿™ç§æ–¹æ³•ï¼Œå…¶ä»–åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥è·å–ã€‚<br><br/></p><p>æ¯å°iOSè®¾å¤‡çš„ OpenUDID æ˜¯é€šè¿‡ç¬¬ä¸€ä¸ªå¸¦æœ‰ OpenUDID SDKåŒ…çš„ App ç”Ÿæˆï¼Œå¦‚æœä½ å®Œå…¨åˆ é™¤å…¨éƒ¨å¸¦æœ‰ OpenUDID SDKåŒ…çš„Appï¼ˆæ¯”å¦‚æ¢å¤ç³»ç»Ÿç­‰ï¼‰ï¼Œé‚£ä¹ˆOpenUDIDä¼šé‡æ–°ç”Ÿæˆï¼Œè€Œä¸”å’Œä¹‹å‰çš„å€¼ä¼šä¸åŒï¼Œç›¸å½“äºæ–°è®¾å¤‡ã€‚<br><br/></p><p>å¦å¤–ï¼Œè‹¹æœåœ¨ iOS 7 ä¹‹åå¯¹ç²˜è´´æ¿åšäº†é™åˆ¶ï¼Œå¯¼è‡´åŒä¸€ä¸ªè®¾å¤‡ä¸Šçš„åº”ç”¨é—´ï¼Œæ— æ³•å†å…±äº«ä¸€ä¸ª OpenUDIDã€‚</p><h4 id="6ã€MAC"><a href="#6ã€MAC" class="headerlink" title="6ã€MAC"></a>6ã€MAC</h4><p>MAC åœ°å€åœ¨ç½‘ç»œä¸Šç”¨æ¥åŒºåˆ†è®¾å¤‡çš„å”¯ä¸€æ€§ï¼Œæ¥å…¥ç½‘ç»œçš„è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªMACåœ°å€ï¼Œä»–ä»¬è‚¯å®šéƒ½æ˜¯å”¯ä¸€çš„ã€‚ä¸€éƒ¨ iPhone ä¸Šå¯èƒ½æœ‰å¤šä¸ª MAC åœ°å€ï¼ŒåŒ…æ‹¬ WIFI çš„ã€SIM çš„ç­‰ï¼Œä½†æ˜¯ iTouch å’Œ iPad ä¸Šå°±æœ‰ä¸€ä¸ª WIFI çš„ï¼Œå› æ­¤åªéœ€è·å– WIFI çš„ MAC åœ°å€å°±å¥½äº†ã€‚ä¸€èˆ¬ä¼šé‡‡å– MD5ï¼ˆMAC åœ°å€ + bundleIDï¼‰è·å–å”¯ä¸€æ ‡è¯†ã€‚<br><br/></p><p>ä½†æ˜¯ MAC åœ°å€å’Œ UDID ä¸€æ ·ï¼Œå­˜åœ¨éšç§é—®é¢˜ï¼Œ iOS 7 ä¹‹åï¼Œæ‰€æœ‰è®¾å¤‡è¯·æ±‚ MAC åœ°å€ä¼šè¿”å›ä¸€ä¸ªå›ºå®šå€¼ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿä¸æ”»è‡ªç ´äº†ã€‚</p><h4 id="7ã€IDFV-keychain"><a href="#7ã€IDFV-keychain" class="headerlink" title="7ã€IDFV + keychain"></a>7ã€IDFV + keychain</h4><p>é€šè¿‡ä»¥ä¸Šå‡ ç§å‚¨å­˜å”¯ä¸€æ ‡è¯†çš„æ–¹æ³•çš„åˆ†æï¼Œæ€»ç»“ä¸€ä¸‹å„æœ‰ä¼˜åŠ£ã€‚å¾ˆå¤šæ–¹æ³•è¢«è‹¹æœç¦æ­¢æˆ–è€…æ¼æ´å¤ªå¤šï¼Œè¶Šæ¥è¶Šä¸è¢«å¼€å‘è€…ä½¿ç”¨ï¼Œç°åœ¨è‹¹æœä¸»æ¨ IDFA å’Œ IDFV è¿™ä¸¤ç§æ–¹æ³•ï¼Œä½†æ˜¯ IDFV åœ¨ APP é‡æ–°å®‰è£…æ—¶ä¼šå˜åŒ–ï¼Œæ‰€ä»¥å¯ä»¥å°†IDFVå­˜å‚¨åˆ°é’¥åŒ™ä¸²ä¸­ï¼Œä»¥åæ¯æ¬¡æƒ³è·å–æ ‡è¯†ç¬¦æ—¶éƒ½ä»é’¥åŒ™ä¸²ä¸­å–ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FQA-å¸¸è§é—®é¢˜</title>
    <link href="/2017/11/24/faq.html"/>
    <url>/2017/11/24/faq.html</url>
    
    <content type="html"><![CDATA[<h3 id="1ã€VCçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#1ã€VCçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="1ã€VCçš„ç”Ÿå‘½å‘¨æœŸ"></a>1ã€VCçš„ç”Ÿå‘½å‘¨æœŸ</h3><ul><li>-initWithCoder: &#x2F;&#x2F;VCåˆå§‹åŒ–</li><li>-initWithNibName:bundle:</li><li>-loadView &#x2F;&#x2F;ä»nibè½½å…¥è§†å›¾æˆ–è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰è§†å›¾</li><li>-viewDidLoad &#x2F;&#x2F;è§†å›¾è½½å…¥å®Œæˆå¹¶å¼€å§‹è¿›ä¸€æ­¥çš„è®¾ç½®</li><li>-viewWillAppear: &#x2F;&#x2F;è§†å›¾å³å°†å‡ºç°åœ¨å±å¹•ä¸Š</li><li>-updateViewConstraints &#x2F;&#x2F;æ›´æ–°çº¦æŸ</li><li>-viewWillLayoutSubviews &#x2F;&#x2F;è§†å›¾å¸ƒå±€</li><li>-viewDidLayoutSubviews</li><li>-viewDidAppear: &#x2F;&#x2F;è§†å›¾å·²å±•ç¤ºåœ¨å±å¹•ä¸Š</li><li>-viewWillDisappear:&#x2F;&#x2F;è§†å›¾ä»å±å¹•ä¸Šç§»é™¤</li><li>-viewDidDisappear:</li><li>-dealloc</li></ul><p>é€šè¿‡<code>addChildViewController</code>å°†å­VCæ·»åŠ åˆ°çˆ¶VCå®¹å™¨ä¸­åï¼Œå­VCä¸çˆ¶VCçš„ç”Ÿå‘½å‘¨æœŸä¼šåŒæ­¥è¿›è¡Œï¼Œå¦‚ï¼šçˆ¶VCçš„<code>-viewDidAppear</code>ç­‰è§¦å‘æ—¶å­VCçš„ä¹Ÿä¼šè§¦å‘ã€‚<br><br/></p><p>VCçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ ¹æ®å…¶<code>self.view</code>æ‰€å¤„çš„çŠ¶æ€è€Œå®šçš„ï¼šåœ¨çˆ¶VCä¸­ç¬¬ä¸€æ¬¡è®¿é—®å­VCçš„<code>.view</code>å±æ€§æ—¶ä¼šå…ˆè°ƒç”¨å­VCä¸­çš„<code>-loadView</code>ï¼Œéšåå­VCä¸­çš„<code>-viewDidLoad</code>ä¹Ÿä¼šè§¦å‘ï¼Œä»¥ä¾¿åšè¿›ä¸€æ­¥çš„è®¾ç½®ï¼›å¦‚æœ<code>.view</code>å±æ€§æ²¡è¢«æ·»åŠ åˆ°ä¸€ä¸ªå·²ç»å±•ç¤ºçš„è§†å›¾ä¸Šï¼Œåˆ™å…¶æ‰€å±VCçš„<code>-viewWillAppear</code>ä¸ä¼šè°ƒç”¨ã€‚</p><h3 id="2ã€VCè·³è½¬æ—¶ç”Ÿå‘½å‘¨æœŸè°ƒç”¨é¡ºåº"><a href="#2ã€VCè·³è½¬æ—¶ç”Ÿå‘½å‘¨æœŸè°ƒç”¨é¡ºåº" class="headerlink" title="2ã€VCè·³è½¬æ—¶ç”Ÿå‘½å‘¨æœŸè°ƒç”¨é¡ºåº"></a>2ã€VCè·³è½¬æ—¶ç”Ÿå‘½å‘¨æœŸè°ƒç”¨é¡ºåº</h3><ul><li>æƒ…å½¢1ï¼šç”± A push åˆ° B æ—¶ï¼š</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">-<span class="hljs-selector-attr">[B viewDidLoad]</span><br>-<span class="hljs-selector-attr">[A viewWillDisappear:]</span><br>-<span class="hljs-selector-attr">[B viewWillAppear:]</span><br>-<span class="hljs-selector-attr">[A viewDidDisappear:]</span><br>-<span class="hljs-selector-attr">[B viewDidAppear:]</span><br></code></pre></td></tr></table></figure><ul><li>æƒ…å½¢2ï¼šç”± A present åˆ° B æ—¶ï¼š</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">-<span class="hljs-selector-attr">[B viewDidLoad]</span><br>-<span class="hljs-selector-attr">[A viewWillDisappear:]</span><br>-<span class="hljs-selector-attr">[B viewWillAppear:]</span><br>-<span class="hljs-selector-attr">[B viewDidAppear:]</span><br>-<span class="hljs-selector-attr">[A viewDidDisappear:]</span><br></code></pre></td></tr></table></figure><h3 id="3ã€å®å®šä¹‰ä½¿ç”¨é”™è¯¯æ¡ˆä¾‹"><a href="#3ã€å®å®šä¹‰ä½¿ç”¨é”™è¯¯æ¡ˆä¾‹" class="headerlink" title="3ã€å®å®šä¹‰ä½¿ç”¨é”™è¯¯æ¡ˆä¾‹"></a>3ã€å®å®šä¹‰ä½¿ç”¨é”™è¯¯æ¡ˆä¾‹</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MATH_MAX(a,b) a &gt; b ? a : b</span><br><br>- (<span class="hljs-type">void</span>)defineExmple<br>&#123;<br>    <span class="hljs-comment">//case1</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;result: %d\n&quot;</span>,<span class="hljs-built_in">MATH_MAX</span>(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>) + <span class="hljs-number">1</span>);<span class="hljs-comment">//ç»“æœï¼šresult: 2</span><br>    <span class="hljs-comment">//case2</span><br>    <span class="hljs-type">int</span> i = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;largest: %d\n&quot;</span>, <span class="hljs-built_in">MATH_MAX</span>(i++,<span class="hljs-number">0</span>));<span class="hljs-comment">//ç»“æœï¼šlargest: 2</span><br>    <span class="hljs-comment">//case3</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;now i value = %d\n&quot;</span>, i);<span class="hljs-comment">//ç»“æœï¼šnow i value = 3</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœéƒ½ä¸æ˜¯è®¾æƒ³çš„å€¼ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°ç¼–è¯‘å™¨å¯¹â€œ#â€å¼€å¤´çš„è¡Œã€è‡ªå®šä¹‰å®ç­‰å®çš„å¤„ç†é€»è¾‘ã€‚<br><br/></p><p>å®å®šä¹‰æ˜¯åœ¨é¢„ç¼–è¯‘é˜¶æ®µæŠŠå®çš„å†…å®¹æ‹·è´çš„æºä»£ç çš„ç›¸åº”ä½ç½®ï¼Œæ‰€ä»¥case1ä¸­<code>MATH_MAX(a,b)+1</code>å°±å±•å¼€ä¸º<code>a&gt;b?a:b+1</code>ï¼Œå†’å·åé¢å˜æˆäº†<code>b+1</code>ã€‚ã€‚è¿™å°±è·Ÿè®¾è®¡ä¹‹åˆçš„æ„¿æœ›ç›¸è¿èƒŒäº†~<br><br/></p><p>åŒç†ï¼Œcase2å’Œcase3åœ¨ç¼–è¯‘æ—¶ï¼Œä¼šå˜æˆï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">printf</span>(<span class="hljs-string">&quot;largest: %d\n&quot;</span>, i++ &gt; <span class="hljs-number">0</span> ? i++ : <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œiåšäº†ä¸¤æ¬¡++è¿ç®—ï¼Œæ˜¾ç„¶ä¹Ÿä¸æ˜¯è®¾æƒ³ä¹‹åˆçš„ç»“æœã€‚<br><br/></p><p>#ä¿®æ”¹case1ï¼š</p><p>å®å®šä¹‰éƒ¨åˆ†åº”è¯¥åŠ ä¸Šæ‹¬å·ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-id">#define</span> MATH_MAX(<span class="hljs-selector-tag">a</span>,<span class="hljs-selector-tag">b</span>) (<span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-tag">b</span> ? <span class="hljs-selector-tag">a</span> : b)<br></code></pre></td></tr></table></figure><p>#ä¿®æ”¹case2å’Œcase3ï¼š</p><p>ä¸è¦åœ¨éœ€è¦é¢„å¤„ç†çš„ä»£ç ä¸­åŠ å…¥å†…è”ä»£ç é€»è¾‘ã€‚</p><h3 id="4ã€æŒ‡é’ˆ-åœ°å€"><a href="#4ã€æŒ‡é’ˆ-åœ°å€" class="headerlink" title="4ã€æŒ‡é’ˆ\åœ°å€"></a>4ã€æŒ‡é’ˆ\åœ°å€</h3><p><code>ä¸€èˆ¬å˜é‡</code>å­˜æ”¾çš„æ˜¯æ•°æ®æœ¬èº«ï¼›<br><code>æŒ‡é’ˆå˜é‡</code>å­˜æ”¾çš„æ˜¯æ•°æ®çš„åœ°å€ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> a = <span class="hljs-number">68</span>;<br>long *p = NULL;<br>p = &amp;a;<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++açš„å€¼:%d \n++&amp;a:%p \n++pä¿å­˜çš„æŒ‡é’ˆ:%p \n++*pçš„å€¼:%d \n++å˜é‡pçš„åœ°å€:%p&quot;</span>,<span class="hljs-params">a</span>,&amp;<span class="hljs-params">a</span>,<span class="hljs-params">p</span>,<span class="hljs-operator">*</span><span class="hljs-params">p</span>,&amp;<span class="hljs-params">p</span>)</span>;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++</span><span class="hljs-comment">açš„å€¼:68</span> <br><span class="hljs-literal">++</span><span class="hljs-comment">&amp;a:0x7ffee43cec64</span> <br><span class="hljs-literal">++</span><span class="hljs-comment">pä¿å­˜çš„æŒ‡é’ˆ:0x7ffee43cec64</span> <br><span class="hljs-literal">++</span><span class="hljs-comment">*pçš„å€¼:68</span> <br><span class="hljs-literal">++</span><span class="hljs-comment">å˜é‡pçš„åœ°å€:0x7ffee43cec58</span><br></code></pre></td></tr></table></figure><p><code>*</code>æ˜¯æŒ‡é’ˆçš„æ ‡è¯†ï¼Œè¡¨ç¤ºæ¥ä¸‹æ¥çš„å˜é‡æ˜¯ä¸€ä¸ª<code>æŒ‡é’ˆå˜é‡</code>ï¼›<code>&amp;</code>ç”¨æ¥å–å˜é‡çš„åœ°å€ã€‚<br><br/></p><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ<code>a</code>æ˜¯ä¸€èˆ¬å˜é‡ï¼Œä¿å­˜æ•°å€¼<code>68</code>ï¼›è€Œ<code>a</code>ä½œä¸ºå˜é‡ï¼Œç³»ç»Ÿä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªåœ°å€<code>0x7ffee43cec64</code>ï¼›<code>p</code>æ˜¯åˆå§‹å€¼ä¸ºç©ºçš„æŒ‡é’ˆå˜é‡ï¼ŒéšåæŒ‡å‘<code>&amp;a</code>ï¼Œå³å˜é‡<code>p</code>ä¿å­˜çš„æ˜¯å˜é‡<code>a</code>çš„åœ°å€ï¼ˆ<code>0x7ffee43cec64</code>ï¼‰ï¼›<code>p</code>ä½œä¸ºæŒ‡é’ˆå˜é‡ï¼Œå…¶ä¿å­˜çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼ä¸º 68ï¼Œå˜é‡<code>p</code>è‡ªå·±çš„å†…å­˜åœ°å€ä¸º<code>0x7ffee43cec58</code>ã€‚</p><h3 id="5ã€NULLã€nilã€Nilã€NSNull"><a href="#5ã€NULLã€nilã€Nilã€NSNull" class="headerlink" title="5ã€NULLã€nilã€Nilã€NSNull"></a>5ã€NULLã€nilã€Nilã€NSNull</h3><p>1ã€å‰ä¸‰è€…<code>NULL</code>ã€<code>nil</code>ã€<code>Nil</code>ä»æœ¬è´¨ä¸Šæ¥è®²éƒ½æ˜¯<code>(void *)0</code>ï¼š</p><ul><li>NULLï¼Œè¡¨ç¤ºCç±»å‹çš„æŒ‡é’ˆä¸ºç©ºï¼›</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">long *p <span class="hljs-operator">=</span> NULL<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><ul><li>nilï¼Œè¡¨ç¤ºOCä¸­å¯¹è±¡çš„æŒ‡é’ˆä¸ºç©ºï¼›</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">NSObject *obj <span class="hljs-operator">=</span> nil<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><ul><li>Nilï¼Œè¡¨ç¤ºOCä¸­ç±»ç±»å‹å˜é‡çš„å€¼ä¸ºç©ºï¼›</li></ul><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi"><span class="hljs-keyword">Class</span> <span class="hljs-keyword">class</span> = <span class="hljs-keyword">Nil</span>;<br></code></pre></td></tr></table></figure><p>2ã€<code>NSNull</code>ä¸ä»¥ä¸Šä¸‰è€…ä¸åŒï¼Œå®ƒæ˜¯ä¸€ä¸ªOCç±»ï¼Œç”¨äºåˆ›å»ºç©ºå¯¹è±¡ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSNull</span> *nsnullObj = [<span class="hljs-built_in">NSNull</span> null]; <span class="hljs-comment">// 1</span><br><span class="hljs-built_in">NSArray</span> *aArr = @[@(<span class="hljs-number">1</span>),nsnullObj];<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSObject</span> *item <span class="hljs-keyword">in</span> aArr) &#123;<br>    <span class="hljs-keyword">if</span> ([item isEqual:[<span class="hljs-built_in">NSNull</span> null]]) &#123; <span class="hljs-comment">// 2</span><br>        nsnullObj = <span class="hljs-literal">nil</span>; <span class="hljs-comment">// 3</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­1å¤„å³ä¸ºåˆšåˆ›å»ºçš„ç©ºå¯¹è±¡<code>nsnullObj</code>,å®ƒçš„å†…å­˜åœ°å€å¦‚ä¸‹ï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_nsnullObj.png" alt="nsnullObj"></p><p>ç¤ºä¾‹ä¸­3å¤„å°†ç©ºå¯¹è±¡ç½®ä¸ºnilåï¼Œå…¶å†…å­˜åœ°å€å¦‚ä¸‹ï¼š<br><img src="https://davidlii.nos-eastchina1.126.net/pic_po_nsnullObj_nil.png" alt="pic_nsnullObj_nil"></p><p>æ‰€ä»¥å¯ä»¥çœ‹å‡º<code>NSNull</code>ä»ç„¶æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåªæ˜¯æ­¤å¯¹è±¡ä¸­ä»€ä¹ˆéƒ½æ²¡æœ‰è€Œå·²~</p><h3 id="6ã€å¯¹è±¡çš„æ¯”è¾ƒ-x3D-x3D-ä¸isEqual"><a href="#6ã€å¯¹è±¡çš„æ¯”è¾ƒ-x3D-x3D-ä¸isEqual" class="headerlink" title="6ã€å¯¹è±¡çš„æ¯”è¾ƒ&#x3D;&#x3D;ä¸isEqual"></a>6ã€å¯¹è±¡çš„æ¯”è¾ƒ&#x3D;&#x3D;ä¸isEqual</h3><ul><li>&#x3D;&#x3D;</li></ul><p>æ¯”è¾ƒçš„æ˜¯<code>å€¼</code>ã€‚<br><br/></p><p><code>åŸºæœ¬æ•°æ®ç±»å‹</code>æ¯”è¾ƒæ•°å€¼ï¼Œæ•°å€¼ç›¸ç­‰å³ä¸ºçœŸï¼›<br><code>æŒ‡é’ˆå˜é‡</code>æ¯”è¾ƒå˜é‡å†…ä¿å­˜çš„<code>åœ°å€</code>ï¼Œåœ°å€ç›¸åŒï¼Œå³æŒ‡å‘åŒä¸€ä¸ªæ•°æ®å¯¹è±¡ï¼Œè¿”å›çœŸã€‚<br><br/></p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)test&#123;<br>    <span class="hljs-built_in">NSString</span> *A = <span class="hljs-string">@&quot;Hello&quot;</span>; <span class="hljs-comment">//å¸¸é‡åŒº</span><br>    <span class="hljs-built_in">NSString</span> *B = <span class="hljs-string">@&quot;Hello&quot;</span>; <span class="hljs-comment">//å¸¸é‡åŒº</span><br>    <span class="hljs-built_in">NSString</span> *C = [[<span class="hljs-built_in">NSString</span> alloc] initWithString:<span class="hljs-string">@&quot;Hello&quot;</span>]; <span class="hljs-comment">//å¸¸é‡åŒº</span><br>    <span class="hljs-built_in">NSString</span> *D = [[<span class="hljs-built_in">NSString</span> alloc] initWithString:<span class="hljs-string">@&quot;Hello&quot;</span>]; <span class="hljs-comment">//å¸¸é‡åŒº</span><br>    <span class="hljs-built_in">NSString</span> *E = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;Hello&quot;</span>]; <span class="hljs-comment">//å †åŒº</span><br>    <span class="hljs-built_in">NSString</span> *F = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;Hello&quot;</span>]; <span class="hljs-comment">//å †åŒº</span><br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;A:%p&quot;</span>,A); <span class="hljs-comment">//æ‰“å°Aå¯¹è±¡ä¿å­˜çš„æŒ‡é’ˆ</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;B:%p&quot;</span>,B);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;C:%p&quot;</span>,C);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;D:%p&quot;</span>,D);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;E:%p&quot;</span>,E);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;F:%p&quot;</span>,F);<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;A==B:%d&quot;</span>,A==B); <span class="hljs-comment">// æ£€æµ‹ABå˜é‡å†…ä¿å­˜çš„åœ°å€æ˜¯å¦ç›¸åŒ</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;C==D:%d&quot;</span>,C==D);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;E==F:%d&quot;</span>,E==F);<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;A==C:%d&quot;</span>,A==C);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;A==E:%d&quot;</span>,A==E);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;C==E:%d&quot;</span>,C==E);<br><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;A isEqual: B : %d&quot;</span>,[A isEqual:B]);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;A isEqual: C : %d&quot;</span>,[A isEqual:C]);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;A isEqual: E : %d&quot;</span>,[A isEqual:E]);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">A</span>:<span class="hljs-number">0</span>x1015870e8<br><span class="hljs-attribute">B</span>:<span class="hljs-number">0</span>x1015870e8<br><span class="hljs-attribute">C</span>:<span class="hljs-number">0</span>x1015870e8<br><span class="hljs-attribute">D</span>:<span class="hljs-number">0</span>x1015870e8 // ABCDéƒ½æŒ‡å‘å¸¸é‡åŒºçš„åŒä¸€ä¸ªå¯¹è±¡@<span class="hljs-string">&quot;Hello&quot;</span><br><span class="hljs-attribute">E</span>:<span class="hljs-number">0</span>xf538015112db6b7d<br><span class="hljs-attribute">F</span>:<span class="hljs-number">0</span>xf538015112db6b7d<br><span class="hljs-attribute">A</span>==B:<span class="hljs-number">1</span> //æŒ‡é’ˆç›¸ç­‰è¿”å›çœŸ<br><span class="hljs-attribute">C</span>==D:<span class="hljs-number">1</span><br><span class="hljs-attribute">E</span>==F:<span class="hljs-number">1</span><br><span class="hljs-attribute">A</span>==C:<span class="hljs-number">1</span><br><span class="hljs-attribute">A</span>==E:<span class="hljs-number">0</span> //æŒ‡é’ˆä¸åŒè¿”å›å‡<br><span class="hljs-attribute">C</span>==E:<span class="hljs-number">0</span><br><span class="hljs-attribute">A</span> isEqual: B : <span class="hljs-number">1</span><br><span class="hljs-attribute">A</span> isEqual: C : <span class="hljs-number">1</span><br><span class="hljs-attribute">A</span> isEqual: E : <span class="hljs-number">1</span> //é‡å†™äº†isEqualæ–¹æ³•ï¼ŒæŒ‡é’ˆä¸åŒå­—ç¬¦ä¸²ç›¸åŒå³è¿”å›çœŸ<br></code></pre></td></tr></table></figure><ul><li>isEqual:</li></ul><blockquote><p>This method defines what it means for instances to be equal. </p></blockquote><p><code>isEqual:</code>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•ˆæœä¸<code>==</code>ä¸€æ ·ï¼Œä¸¤ä¸ªå¯¹è±¡æŒ‡å‘çš„<code>åœ°å€</code>ç›¸åŒæ—¶æ‰è¿”å›çœŸã€‚<br><br/></p><p>æœ‰æ—¶åœ¨åˆ›å»ºå­ç±»æ—¶ï¼Œéœ€è¦ä½ è‡ªå·±é‡å†™æ­¤æ–¹æ³•çš„å®ç°ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)isEqual:(<span class="hljs-type">id</span>)obj &#123;<br>    <span class="hljs-keyword">if</span> (obj == <span class="hljs-keyword">self</span>)&#123; <span class="hljs-comment">//å…ˆæ¯”è¾ƒæŒ‡é’ˆ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!obj || ![obj isKindOfClass:[<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>]])&#123; <span class="hljs-comment">//å†æ¯”è¾ƒç±»å‹</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> isEqualToUser:obj]; <span class="hljs-comment">//å†æ¯”è¾ƒè‡ªå®šä¹‰çš„å±æ€§</span><br>&#125;<br> <br>- (<span class="hljs-type">BOOL</span>)isEqualToUser:(User *)aUser &#123;<br> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> == aUser)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br> &#125;<br> <span class="hljs-keyword">if</span> (![(<span class="hljs-type">id</span>)[<span class="hljs-keyword">self</span> name] isEqual:[aUser name]])&#123; <span class="hljs-comment">//æ¯”è¾ƒå±æ€§</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<br> &#125;<br> <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125; <br></code></pre></td></tr></table></figure><p>å®é™…ä¸Š<code>NSString</code>å°±é‡å†™äº†æ­¤æ–¹æ³•çš„å®ç°ï¼Œåªè¦ä¸¤ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ä¸­çš„å€¼ç›¸åŒå³è¿”å›çœŸï¼Œå‚è€ƒ<code>ç¤ºä¾‹1</code>ã€‚</p><blockquote><p>If two objects are equal, they must have the same hash value. This last point is particularly important if you define isEqual: in a subclass and intend to put instances of that subclass into a collection. Make sure you also define hash in your subclass.</p></blockquote><p>ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰æ—¶ï¼Œå®ƒä»¬çš„<code>hash</code>å€¼ä¸€å®šç›¸ç­‰ï¼Œæ‰€ä»¥ä½ å¾€å¾€ä¹Ÿéœ€è¦é‡å†™<code>hash</code>æ–¹æ³•~</p><h3 id="7ã€é›†åˆä¸å¯¹è±¡çš„å¼•ç”¨å…³ç³»"><a href="#7ã€é›†åˆä¸å¯¹è±¡çš„å¼•ç”¨å…³ç³»" class="headerlink" title="7ã€é›†åˆä¸å¯¹è±¡çš„å¼•ç”¨å…³ç³»"></a>7ã€é›†åˆä¸å¯¹è±¡çš„å¼•ç”¨å…³ç³»</h3><p>å¸¸ç”¨çš„é›†åˆå®¹å™¨<code>NSArray</code>ã€<code>NSDictionary</code>ã€<code>NSSet</code>éƒ½æ˜¯<code>å¼ºå¼•ç”¨å®¹å™¨</code>ï¼Œè¿™äº›å®¹å™¨ä¼šå¼ºå¼•ç”¨å…¶å†…éƒ¨çš„å¯¹è±¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//Xcodeä¸­ç¦ç”¨ARCä»¥ä¾¿ä½¿ç”¨å¼•ç”¨è®¡æ•°</span><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>        <span class="hljs-built_in">NSObject</span> *obj = [[[<span class="hljs-built_in">NSObject</span> alloc] init] autorelease];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++1.obj:%p ++&amp;obj:%p ++obj.rc:%lu&quot;</span>,obj,&amp;obj,obj.retainCount);<br>        <br>        <span class="hljs-built_in">NSMutableArray</span> *array = [<span class="hljs-built_in">NSMutableArray</span> arrayWithCapacity:<span class="hljs-number">1</span>];<br>        [array addObject:obj];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++2.obj.rc:%lu&quot;</span>,obj.retainCount);<br>        <br>        [array removeAllObjects];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++3.obj.rc:%lu&quot;</span>,obj.retainCount);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">++<span class="hljs-number">1</span><span class="hljs-selector-class">.obj</span>:<span class="hljs-number">0</span>x600002449230 ++&amp;obj:<span class="hljs-number">0</span>x7ffee57fac60 ++obj<span class="hljs-selector-class">.rc</span>:<span class="hljs-number">1</span><br>++++<span class="hljs-number">2</span><span class="hljs-selector-class">.obj</span><span class="hljs-selector-class">.rc</span>:<span class="hljs-number">2</span><br>++++<span class="hljs-number">3</span><span class="hljs-selector-class">.obj</span><span class="hljs-selector-class">.rc</span>:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>å½“å¯¹è±¡è¢«æ·»åŠ åˆ°é›†åˆä¸­æ—¶ï¼Œå…¶å¼•ç”¨è®¡æ•°ä¼š +1ï¼›å¯¹è±¡è¢«ç§»å‡ºé›†åˆæ—¶ï¼Œå…¶å¼•ç”¨è®¡æ•° -1ã€‚æ‰€ä»¥ï¼Œå®è·µä¸­æˆ‘ä»¬éœ€è¦æ³¨æ„è¿™ç§å¼ºå¼•ç”¨å…³ç³»åŠå…¶å¯èƒ½å¼•èµ·çš„å¯¹è±¡é‡Šæ”¾é—®é¢˜~<br><br/></p><p>é‚£ä¹ˆï¼Œæ€ä¹ˆå®ç°å¼±å¼•ç”¨å®¹å™¨å‘¢ï¼Ÿ</p><ul><li>æ–¹æ¡ˆ1ï¼šä½¿ç”¨ NSValue æä¾›çš„ä¸¤ä¸ªç±»æ–¹æ³•ç±»å­˜å–å¯¹è±¡ï¼š</li></ul><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-comment">//ä¿å­˜å¯¹è±¡æ—¶</span><br>NSValue *value = [NSValue valueWithNonretainedObject:myObj];<br><span class="hljs-string">[array addObject:value]</span>;<br><br><span class="hljs-comment">//è¯»å–å¯¹è±¡æ—¶</span><br>value = [<span class="hljs-built_in">array</span> objectAtIndex:x];<br>myObj = [value pointerValue];<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//Person.m</span><br>@implementation Person<br>-(void)dealloc&#123;<br>    <span class="hljs-literal">[<span class="hljs-identifier">super</span> <span class="hljs-identifier">dealloc</span>]</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++PERSON IS DEALLOCED~&quot;</span>)</span>;<br>&#125;<br>@<span class="hljs-keyword">end</span><br><br><span class="hljs-comment">//è°ƒç”¨</span><br>- (BOOL)application:(UIApplication *)application<br>didFinishLaunchingWithOptions:(NSDictionary *)launchOptions<br>&#123;<br>    @autoreleasepool &#123;<br>        Person *obj = <span class="hljs-literal">[[[P<span class="hljs-identifier">erson</span> <span class="hljs-identifier">alloc</span>]</span> init] autorelease];<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++1.obj:%p ++&amp;obj:%p ++obj.rc:%lu&quot;</span>,<span class="hljs-params">obj</span>,&amp;<span class="hljs-params">obj</span>,<span class="hljs-params">obj</span>.<span class="hljs-params">retainCount</span>)</span>;<br>        <br>        NSMutableArray *<span class="hljs-built_in">array</span> = <span class="hljs-literal">[NSM<span class="hljs-identifier">utableArray</span> <span class="hljs-identifier">arrayWithCapacity</span>:<span class="hljs-number">1</span>]</span>;<br>        NSValue *value = <span class="hljs-literal">[NSV<span class="hljs-identifier">alue</span> <span class="hljs-identifier">valueWithNonretainedObject</span>:<span class="hljs-identifier">obj</span>]</span>;<br>        <span class="hljs-literal">[<span class="hljs-identifier">array</span> <span class="hljs-identifier">addObject</span>:<span class="hljs-identifier">value</span>]</span>;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++2.obj.rc:%lu&quot;</span>,<span class="hljs-params">obj</span>.<span class="hljs-params">retainCount</span>)</span>;<br>        <br>        <span class="hljs-keyword">for</span> (NSValue *valueN <span class="hljs-keyword">in</span> <span class="hljs-built_in">array</span>) &#123;<br>            Person<span class="hljs-operator"> * </span>objN = <span class="hljs-literal">[<span class="hljs-identifier">valueN</span> <span class="hljs-identifier">pointerValue</span>]</span>;<br>            <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++3.objN:%p ++&amp;objN:%p ++objN.rc:%lu&quot;</span>,<span class="hljs-params">objN</span>,&amp;<span class="hljs-params">objN</span>,<span class="hljs-params">objN</span>.<span class="hljs-params">retainCount</span>)</span>;<br>        &#125;<br>        <br>        obj = nil;<br>        <br>        <span class="hljs-keyword">for</span> (NSValue *valueN <span class="hljs-keyword">in</span> <span class="hljs-built_in">array</span>) &#123;<br>            Person<span class="hljs-operator"> * </span>objN = <span class="hljs-literal">[<span class="hljs-identifier">valueN</span> <span class="hljs-identifier">pointerValue</span>]</span>;<br>            <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++4.objN:%p ++&amp;objN:%p ++objN.rc:%lu&quot;</span>,<span class="hljs-params">objN</span>,&amp;<span class="hljs-params">objN</span>,<span class="hljs-params">objN</span>.<span class="hljs-params">retainCount</span>)</span>;<br>        &#125;<br>        <span class="hljs-literal">[<span class="hljs-identifier">array</span> <span class="hljs-identifier">removeAllObjects</span>]</span>;<br>        <br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++5.obj:%@ ++&amp;obj:%p ++obj.rc:%lu&quot;</span>,<span class="hljs-params">obj</span>,&amp;<span class="hljs-params">obj</span>,<span class="hljs-params">obj</span>.<span class="hljs-params">retainCount</span>)</span>;<br>    &#125;<br>    <br>    return YES;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++</span><span class="hljs-comment">1</span><span class="hljs-string">.</span><span class="hljs-comment">obj:0x60000323c9c0</span> <span class="hljs-literal">++</span><span class="hljs-comment">&amp;obj:0x7ffeeb5fec60</span> <span class="hljs-literal">++</span><span class="hljs-comment">obj</span><span class="hljs-string">.</span><span class="hljs-comment">rc:1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">2</span><span class="hljs-string">.</span><span class="hljs-comment">obj</span><span class="hljs-string">.</span><span class="hljs-comment">rc:1</span><br><span class="hljs-literal">++</span><span class="hljs-comment">3</span><span class="hljs-string">.</span><span class="hljs-comment">objN:0x60000323c9c0</span> <span class="hljs-literal">++</span><span class="hljs-comment">&amp;objN:0x7ffeeb5fec00</span> <span class="hljs-literal">++</span><span class="hljs-comment">objN</span><span class="hljs-string">.</span><span class="hljs-comment">rc:1</span><br><span class="hljs-literal">++</span><span class="hljs-comment">4</span><span class="hljs-string">.</span><span class="hljs-comment">objN:0x60000323c9c0</span> <span class="hljs-literal">++</span><span class="hljs-comment">&amp;objN:0x7ffeeb5febb0</span> <span class="hljs-literal">++</span><span class="hljs-comment">objN</span><span class="hljs-string">.</span><span class="hljs-comment">rc:1</span><br><span class="hljs-literal">++</span><span class="hljs-comment">5</span><span class="hljs-string">.</span><span class="hljs-comment">obj:(null)</span> <span class="hljs-literal">++</span><span class="hljs-comment">&amp;obj:0x7ffeeb5fec60</span> <span class="hljs-literal">++</span><span class="hljs-comment">obj</span><span class="hljs-string">.</span><span class="hljs-comment">rc:0</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">PERSON IS DEALLOCED~</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡<code>NSValue</code>åŒ…è£…<code>obj</code>ä¹‹åï¼Œå³ä½¿æ·»åŠ åˆ°æ•°ç»„ï¼Œ<code>obj</code>çš„å¼•ç”¨è®¡æ•°ä¹Ÿä¸ä¼šå¢åŠ ï¼Œä¸”å½“åœ¨æ•°ç»„å¤–éƒ¨å°†<code>obj</code>ç½®ä¸º nil ä¹‹åï¼Œ<code>obj</code>å¯¹è±¡ä¼šè‡ªåŠ¨é”€æ¯ã€‚</p><h3 id="8ã€é™æ€å˜é‡ã€é™æ€å¸¸é‡"><a href="#8ã€é™æ€å˜é‡ã€é™æ€å¸¸é‡" class="headerlink" title="8ã€é™æ€å˜é‡ã€é™æ€å¸¸é‡"></a>8ã€é™æ€å˜é‡ã€é™æ€å¸¸é‡</h3><ul><li><strong>static</strong></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> *aStaticString;<br></code></pre></td></tr></table></figure><p>ä¿®é¥°<code>å±€éƒ¨å˜é‡</code>æ—¶ï¼Œé™æ€å±€éƒ¨å˜é‡çš„ä½œç”¨èŒƒå›´ä¸ºè¯¥å‡½æ•°ä½“ã€‚å®ƒçš„å€¼åœ¨ç¼–è¯‘æœŸå°±ä¼šç¡®å®šä¸‹æ¥ï¼Œå¹¶è¢«å­˜å‚¨åˆ°å…¨å±€å˜é‡åŒºã€‚å› æ­¤é™æ€å±€éƒ¨å˜é‡åªä¼šç”Ÿæˆä¸€ä»½å†…å­˜ã€åªä¼šåˆå§‹åŒ–ä¸€æ¬¡å¹¶ä¾›æ‰€æœ‰å¯¹è±¡ä½¿ç”¨ï¼›é™æ€å±€éƒ¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸå’Œç¨‹åºç›¸åŒï¼Œç›´åˆ°ç¨‹åºç»“æŸè¿™ä¸ªå±€éƒ¨å˜é‡æ‰ä¼šé”€æ¯ã€‚<br><br/></p><p>ä¿®é¥°<code>å…¨å±€å˜é‡</code>æ—¶ï¼Œé™æ€å…¨å±€å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå½“å‰æ–‡ä»¶ï¼ˆ.mï¼‰ï¼Œå®ƒä¹Ÿæ˜¯è¢«å­˜å‚¨åˆ°å…¨å±€å˜é‡åŒºï¼Œç”Ÿå‘½å‘¨æœŸä¸ç¨‹åºç›¸åŒï¼Œç¨‹åºç»“æŸæ—¶æ‰ä¼šé”€æ¯ã€‚ä½¿ç”¨é™æ€å…¨å±€å˜é‡èƒ½é¿å…åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­é‡å¤å®šä¹‰å…¨å±€å˜é‡ã€‚<br><br/></p><p>static å¼ºè°ƒçš„æ˜¯é™æ€ï¼Œå˜é‡åªåˆ›å»ºä¸€æ¬¡ï¼Œç›´åˆ°ç¨‹åºç»“æŸæ‰é”€æ¯ã€‚é™æ€å˜é‡çš„å€¼æ˜¯å¯ä»¥æ›´æ–°çš„ï¼Œå¹¶ä¸”åªè¦æŸä¸ªå¯¹è±¡å¯¹é™æ€å˜é‡åšäº†ä¿®æ”¹ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½èƒ½è®¿é—®æ›´æ–°åçš„å€¼ã€‚</p><ul><li><strong>const</strong></li></ul><p><code>const</code>ä¿®é¥°çš„æ˜¯å¸¸é‡ï¼Œå¼ºè°ƒçš„æ˜¯å˜é‡çš„å€¼ä¸å¯å˜ã€‚å¸¸é‡åœ¨ç¬¬ä¸€æ¬¡èµ‹å€¼ä¹‹åä¸èƒ½å†ä¿®æ”¹ã€‚<br><br/></p><p>åœ¨ OC ä¸­ä¸€èˆ¬æ˜¯ç»“åˆ<code>static</code>ä½¿ç”¨ï¼Œç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//ç”¨æ³•1</span><br><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> * <span class="hljs-keyword">const</span> s1;<br><span class="hljs-comment">//ç”¨æ³•2</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">NSString</span> * s2;<br><span class="hljs-comment">//ç”¨æ³•3</span><br><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> <span class="hljs-keyword">const</span> * s3;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    s1 = <span class="hljs-string">@&quot;A&quot;</span>;<span class="hljs-comment">//ç¼–è¯‘æ—¶ä¼šæŠ¥é”™</span><br>    s2 = <span class="hljs-string">@&quot;B&quot;</span>;<span class="hljs-comment">//ç¼–è¯‘æ­£å¸¸</span><br>    s3 = <span class="hljs-string">@&quot;C&quot;</span>;<span class="hljs-comment">//ç¼–è¯‘æ­£å¸¸</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­ï¼Œ<code>ç”¨æ³•2</code>å’Œ<code>3</code>å®è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚<code>ç”¨æ³•1</code>å’Œ<code>2</code>çš„åŒºåˆ«ï¼Œç”¨è‹±è¯­è¡¨è¾¾ä¼šæ›´ç›´è§‚ä¸€äº›ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> * <span class="hljs-keyword">const</span> s1;<br></code></pre></td></tr></table></figure><p><code>æŒ‡é’ˆå¸¸é‡</code>ï¼ŒA constant pointer (not modifiable) to an NSString object (its value can be modified)ã€‚è¿™é‡Œçš„<code>s1</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡çš„æŒ‡é’ˆï¼Œå› æ­¤ const ä¿®é¥°çš„æ˜¯æŒ‡é’ˆï¼Œå³æŒ‡é’ˆä¸ºå¸¸é‡ä¸èƒ½ä¿®æ”¹ï¼Œä½†æŒ‡é’ˆæŒ‡å‘çš„å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">NSString</span> * s2;<br></code></pre></td></tr></table></figure><p><code>å¸¸é‡æŒ‡é’ˆ</code>ï¼ŒA modifiable pointer to a constant NSString object (its value canâ€™t be modified)ã€‚è¿™é‡Œ<code>s2</code>å’Œ<code>s3</code>æ˜¯æŒ‡é’ˆï¼Œ<code>*s2</code>å’Œ<code>*s3</code>æ˜¯æŒ‡é’ˆæŒ‡å‘çš„å€¼ï¼Œconst ä¿®é¥°çš„æ˜¯å€¼ï¼Œå³å€¼ä¸å¯å˜ï¼Œä½†å­—ç¬¦ä¸²å¯¹è±¡å¯ä»¥ä¿®æ”¹å…¶æŒ‡é’ˆï¼Œé‡æ–°å–åˆ«çš„å€¼ã€‚</p><h3 id="9ã€åˆ†ç±»ä¸æ‰©å±•"><a href="#9ã€åˆ†ç±»ä¸æ‰©å±•" class="headerlink" title="9ã€åˆ†ç±»ä¸æ‰©å±•"></a>9ã€åˆ†ç±»ä¸æ‰©å±•</h3><p><strong>ä»£ç ç»„ç»‡å½¢å¼ä¸Š</strong>ï¼š<br><br/></p><p>æ‰©å±•é€šå¸¸æ˜¯å®šä¹‰åœ¨åŸç±»çš„<code>m</code>æ–‡ä»¶ä¸­ï¼›è€Œåˆ†ç±»æ—¢å¯ä»¥å®šä¹‰åœ¨åŸç±»çš„<code>h</code>å’Œ<code>m</code>æ–‡ä»¶ä¸­ï¼Œåˆå¯ä»¥å­˜åœ¨äºå•ç‹¬çš„<code>h</code>å’Œ<code>m</code>æ–‡ä»¶ä¸­ï¼Œåˆ†ç±»ç»„ç»‡çš„æ–¹å¼ä¸åŒå¯¼å…¥çš„æ–¹å¼ä¹Ÿä¼šä¸åŒã€‚ä»å‘½åä¸Šæ¥çœ‹ï¼Œæ‰©å±•ç›¸å½“äºæœªå‘½åçš„åˆ†ç±»ã€‚<br><br/></p><p><strong>æ–¹æ³•å®šä¹‰ä¸Š</strong>ï¼š<br><br/></p><p>åˆ†ç±»å’Œæ‰©å±•ä¸­éƒ½å¯ä»¥å®šä¹‰æ–¹æ³•ä»¥è¾¾åˆ°æ‰©å±•ç°æœ‰ç±»çš„æ–¹æ³•åˆ—è¡¨ä¹‹ç›®çš„ï¼Œä¸åŒçš„æ˜¯æ‰©å±•ä¸­å®šä¹‰çš„æ–¹æ³•å¿…é¡»åœ¨åŸç±»çš„<code>m</code>æ–‡ä»¶ä¸­æä¾›å®ç°ï¼›åˆ†ç±»ä¸­å®šä¹‰çš„æ–¹æ³•åˆ™ä¸ä¾èµ–äºåŸç±»çš„å®ç°æ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨è‡ªå·±çš„<code>@implementation</code>ä¸­æä¾›å®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ†ç±»å¯ä»¥åœ¨ä¸çŸ¥é“åŸç±»å…·ä½“å®ç°çš„æƒ…å†µä¸‹å¯¹åŸç±»è¿›è¡Œæ‰©å±•ã€‚å¦å¤–ï¼Œåˆ†ç±»ä¸­å¯ä»¥é‡å†™åŸç±»çš„æ–¹æ³•ï¼Œé‡å†™åå®ä¾‹å°±ä¸èƒ½è®¿é—®åŸæ¥çš„æ–¹æ³•äº†ã€‚<br><br/></p><p><strong>æˆå‘˜å˜é‡å®šä¹‰ä¸Š</strong>ï¼š<br><br/></p><p>æ‰©å±•ä¸­å¯ä»¥å®šä¹‰æˆå‘˜å˜é‡ï¼Œå¹¶ä¸”è¿™äº›å˜é‡åªå¯¹æœ¬ç±»å¯è§ï¼›åˆ†ç±»ä¸­åˆ™ä¸èƒ½å®šä¹‰æˆå‘˜å˜é‡ï¼Œå› ä¸ºåˆ†ç±»ä¸åŸç±»çš„å†…å­˜ç©ºé—´ç›¸äº’ç‹¬ç«‹ï¼ŒåŸç±»åˆå§‹åŒ–åå®ä¾‹å¤§å°å·²ç¡®å®šï¼Œä¸èƒ½å†æ·»åŠ æˆå‘˜å˜é‡ã€‚<br><br/></p><p><strong>å±æ€§å®šä¹‰ä¸Š</strong>ï¼š<br><br/></p><p>åˆ†ç±»å’Œæ‰©å±•éƒ½å¯ä»¥å®šä¹‰å±æ€§ï¼Œä¸åŒçš„æ˜¯æ‰©å±•ä¸­çš„å±æ€§ä¼šç”±ç¼–è¯‘å™¨è‡ªåŠ¨æä¾›å­˜å–å™¨ï¼›è€Œåˆ†ç±»ä¸­è™½ç„¶å®šä¹‰äº†å±æ€§ï¼Œç¼–è¯‘å™¨å´ä¸ä¼šä¸ºå…¶æä¾›å­˜å–å™¨ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±é€šè¿‡<code>å¯¹è±¡ç»‘å®šæœºåˆ¶</code>ä¸»åŠ¨å®ç°ã€‚</p><h3 id="10ã€URLç¼“å­˜ç­–ç•¥"><a href="#10ã€URLç¼“å­˜ç­–ç•¥" class="headerlink" title="10ã€URLç¼“å­˜ç­–ç•¥"></a>10ã€URLç¼“å­˜ç­–ç•¥</h3><p>NSURLRequestCachePolicy ç”¨æ¥æŒ‡å®šç½‘ç»œè¯·æ±‚çš„ç¼“å­˜ç­–ç•¥ï¼Œå…·ä½“çš„æšä¸¾å’Œä½œç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">NSURLRequestUseProtocolCachePolicy</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>é»˜è®¤ç¼“å­˜ç­–ç•¥ï¼Œå½“å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ç¼“å­˜(NSCachedURLResponse)ã€‚å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™ç›´æ¥ä»æœåŠ¡å™¨å¤„è·å–ï¼›å¦‚æœæœ‰ç¼“å­˜ï¼Œåˆ™ç»§ç»­æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆé€šè¿‡Cache-Control:max-ageæˆ–è€…Expiresï¼‰ã€‚å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼›å¦‚æœç¼“å­˜è¿‡æœŸäº†ï¼Œåˆ™å‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¼šå¯¹æ¯”å®ƒä¿å­˜çš„èµ„æºçš„ Last-Modified æˆ–è€… Etags å­—æ®µ(äºŒè€…éƒ½å­˜åœ¨çš„æƒ…å†µä¸‹ä¸‹å¦‚æœæœ‰ä¸€ä¸ªä¸åŒåˆ™è®¤ä¸ºç¼“å­˜å·²è¿‡æœŸ)ï¼Œå¦‚æœä¸åŒåˆ™è¿”å›æ–°æ•°æ®ï¼Œå¦åˆ™è¿”å› 304 Not Modified å¹¶ç»§ç»­ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆå®¢æˆ·ç«¯å¯ä»¥å†ä½¿ç”¨â€max-ageâ€ç§’ç¼“å­˜æ•°æ®ï¼‰ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">NSURLRequestReloadIgnoringLocalCacheData</span> <span class="hljs-operator">=</span> NSURLRequestReloadIgnoringCacheData <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>ä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥ä»æœåŠ¡å™¨è¯·æ±‚åŸå§‹æ•°æ®ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">NSURLRequestReturnCacheDataElseLoad</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>æ— è®ºç¼“å­˜æ˜¯å¦è¿‡æœŸï¼Œæœ‰ç¼“å­˜åˆ™ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™é‡æ–°è¯·æ±‚åŸå§‹æ•°æ®ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">NSURLRequestReturnCacheDataDontLoad</span> = <span class="hljs-number">3</span>, <br></code></pre></td></tr></table></figure><p>æœ‰ç¼“å­˜åˆ™ä½¿ç”¨ç¼“å­˜ï¼Œæ— è®ºç¼“å­˜æ˜¯å¦è¿‡æœŸï¼›æ— ç¼“å­˜åˆ™è§†ä¸ºå¤±è´¥ï¼Œä¸ä¼šé‡æ–°è¯·æ±‚åŸå§‹æ•°æ®ï¼Œç±»ä¼¼äºç¦»çº¿æ¨¡å¼ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">NSURLRequestReloadIgnoringLocalAndRemoteCacheData</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span> //Unimplemented<br></code></pre></td></tr></table></figure><p>æœ¬åœ°ç¼“å­˜ã€ä»£ç†å’Œå…¶ä»–ä¸­ä»‹éƒ½è¦å¿½è§†ä»–ä»¬çš„ç¼“å­˜ï¼Œç›´æ¥åŠ è½½æºæ•°æ®ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">NSURLRequestReloadRevalidatingCacheData</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span> //Unimplemented<br></code></pre></td></tr></table></figure><p>å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå¦‚æœæœåŠ¡å™¨ç¡®è®¤ç¼“å­˜æœ‰æ•ˆï¼Œåˆ™ç»§ç»­ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™ä»æºæ®µåŠ è½½æ•°æ®ã€‚<br><br/></p><p>ä½¿ç”¨ç¼“å­˜çš„ç›®çš„æ˜¯ä¸ºäº†é™ä½å¯¹ç½‘ç»œè¿æ¥çš„ä¾èµ–ï¼Œå‡å°‘å¯¹ç›¸åŒ URL çš„å¤šæ¬¡è¯·æ±‚ï¼Œæé«˜åº”ç”¨çš„å“åº”é€Ÿåº¦ã€‚è¿™é‡Œæ‰€è¯´çš„ç¼“å­˜æ˜¯æŒ‡å¯¹ URL è¯·æ±‚å“åº”ä½“(NSCachedURLResponse)çš„ç¼“å­˜ã€‚iOS ä¸­å“åº”çš„ç¼“å­˜æ˜¯é€šè¿‡ <a href="https://developer.apple.com/documentation/foundation/urlcache">NSURLCache</a> æ¥å®ç°çš„ï¼Œå®ƒä¼šå°†<code>NSURLRequest</code>ä¸<code>NSCachedURLResponse</code>è¿›è¡Œæ˜ å°„ï¼Œå¹¶ä¿å­˜åœ¨å†…å­˜å’Œç£ç›˜ä¸­ã€‚ä½ ç”šè‡³å¯ä»¥æŒ‡å®šä¸¤ç‰‡ç¼“å­˜çš„å®¹é‡å¤§å°å’Œå­˜å‚¨è·¯å¾„ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://stackoverflow.com/questions/22953091/difference-between-nsstring-const-and-const-nsstring">Â©Stack Overflow</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è™šæ‹Ÿå†…å­˜åˆ†é…</title>
    <link href="/2017/11/24/memory.html"/>
    <url>/2017/11/24/memory.html</url>
    
    <content type="html"><![CDATA[<h3 id="åˆ†åŒºåŠèŒè´£"><a href="#åˆ†åŒºåŠèŒè´£" class="headerlink" title="åˆ†åŒºåŠèŒè´£"></a>åˆ†åŒºåŠèŒè´£</h3><ol><li><p>æ ˆåŒº(stack)ï¼šå­˜æ”¾å±€éƒ¨å˜é‡å’Œæ–¹æ³•å®å‚ã€‚</p></li><li><p>å †åŒº(heap)ï¼šå­˜æ”¾OCä¸­ä½¿ç”¨newç­‰æ–¹æ³•åˆ›å»ºçš„å¯¹è±¡ã€‚</p></li><li><p>å…¨å±€ï¼ˆé™æ€ï¼‰åŒºï¼šåŒ…æ‹¬ä»¥ä¸‹ä¸¤ä¸ªåˆ†åŒºï¼š</p></li></ol><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">3</span>.<span class="hljs-number">1</span>. æ•°æ®æ®µï¼ˆData segmentï¼‰ï¼šåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚<br><span class="hljs-attribute">3</span>.<span class="hljs-number">2</span>. BSSæ®µï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚<br></code></pre></td></tr></table></figure><ol start="4"><li><p>å¸¸é‡åŒº(æ•°æ®æ®µ)ï¼šconstã€@â€xâ€å¸¸é‡å­—ç¬¦ä¸²</p></li><li><p>ä»£ç æ®µ(Text segment)ï¼šç¨‹åºçš„ä»£ç ï¼ˆELFï¼‰ã€‚</p></li></ol><h3 id="åˆ†é…-amp-é‡Šæ”¾ï¼Ÿ"><a href="#åˆ†é…-amp-é‡Šæ”¾ï¼Ÿ" class="headerlink" title="åˆ†é…&amp;é‡Šæ”¾ï¼Ÿ"></a>åˆ†é…&amp;é‡Šæ”¾ï¼Ÿ</h3><ul><li>æ ˆåŒºï¼šç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾ã€‚</li><li>å †åŒºï¼šç”±ç¨‹åºå‘˜ç”³è¯·å’Œé‡Šæ”¾ï¼Œä¸é‡Šæ”¾ä¼šæ³„æ¼ã€‚</li><li>BSSæ®µ\æ•°æ®æ®µ\å¸¸é‡åŒº\ä»£ç æ®µï¼šç¨‹åºç»“æŸåç”±ç³»ç»Ÿé‡Šæ”¾ã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-type">int</span> age = <span class="hljs-number">24</span>;  <span class="hljs-comment">//å…¨å±€åˆå§‹åŒ–åŒºï¼ˆæ•°æ®æ®µï¼‰</span><br><span class="hljs-built_in">NSString</span> *name;<span class="hljs-comment">//å…¨å±€æœªåˆå§‹åŒ–åŒºï¼ˆBSSæ®µï¼‰</span><br><span class="hljs-keyword">static</span> <span class="hljs-built_in">NSString</span> *sName = <span class="hljs-string">@&quot;Dav&quot;</span>;<span class="hljs-comment">//å…¨å±€ï¼ˆé™æ€åˆå§‹åŒ–ï¼‰åŒº</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>-(<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>willFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-type">int</span> aInt;<span class="hljs-comment">//æ ˆ</span><br>    <span class="hljs-built_in">NSString</span> *aName = <span class="hljs-string">@&quot;Dav&quot;</span>; <span class="hljs-comment">//Davåœ¨å¸¸é‡åŒºï¼Œå¯¹è±¡aNameçš„æŒ‡é’ˆå­˜å‚¨åœ¨æ ˆåŒºã€‚</span><br>    <span class="hljs-comment">//å¯¹è±¡aArrçš„æŒ‡é’ˆåœ¨æ ˆåŒºï¼Œåˆ†é…è€Œæ¥çš„8å­—èŠ‚çš„åŒºåŸŸåœ¨å †åŒºï¼ŒaArrçš„æŒ‡é’ˆæŒ‡å‘å †åŒºçš„åœ°å€ã€‚</span><br>    <span class="hljs-built_in">NSMutableArray</span> *aArr = [<span class="hljs-built_in">NSMutableArray</span> arrayWithCapacity:<span class="hljs-number">1</span>]; <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-built_in">NSInteger</span>)mathAddParam1:(<span class="hljs-built_in">NSInteger</span>)num1 Param2:(<span class="hljs-built_in">NSInteger</span>)num2<br>&#123;<br>    <span class="hljs-keyword">return</span> num1 + num2; <span class="hljs-comment">//num1å’Œnum2 åœ¨æ ˆåŒº</span><br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://blog.csdn.net/wangxiaolong_china/article/details/6844325">Â©elite-åœ°å€ç©ºé—´åˆ†å¸ƒ</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å†…å­˜ç®¡ç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>atomicä¸€å®šçº¿ç¨‹å®‰å…¨å—ï¼Ÿ</title>
    <link href="/2017/11/24/atomic.html"/>
    <url>/2017/11/24/atomic.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Ÿ" class="headerlink" title="1.ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Ÿ"></a>1.ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Ÿ</h3><blockquote><p>çº¿ç¨‹å®‰å…¨ï¼Œæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶çš„è®¡ç®—æœºç¨‹åºä»£ç ä¸­çš„ä¸€ä¸ªæ¦‚å¿µã€‚åœ¨æ‹¥æœ‰å…±äº«æ•°æ®çš„å¤šæ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œçš„ç¨‹åºä¸­ï¼Œçº¿ç¨‹å®‰å…¨çš„ä»£ç ä¼šé€šè¿‡åŒæ­¥æœºåˆ¶ä¿è¯å„ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ­£å¸¸ä¸”æ­£ç¡®çš„æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°æ•°æ®æ±¡æŸ“ç­‰æ„å¤–æƒ…å†µã€‚</p></blockquote><h3 id="2-atomicä¸nonatomicçš„åŒºåˆ«"><a href="#2-atomicä¸nonatomicçš„åŒºåˆ«" class="headerlink" title="2.atomicä¸nonatomicçš„åŒºåˆ«"></a>2.atomicä¸nonatomicçš„åŒºåˆ«</h3><p>atomic ä¸ nonatomic çš„æœ¬è´¨åŒºåˆ«åœ¨äº<code>getter</code>ã€<code>setter</code>æ–¹æ³•å®ç°ä¸Šçš„ä¸åŒï¼š<br><br/></p><p>#ç¤ºä¾‹1ï¼šnonatomicå±æ€§çš„å®ç°</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">//@property(nonatomic, retain) NSMutableArray *mutArr;</span><br>- (NSMutableArray *)mutArr <br>&#123;<br>    <span class="hljs-keyword">return</span> _mutArr;<br>&#125;<br><br>- (void)setMutArr:<span class="hljs-type"></span>(NSMutableArray *)<span class="hljs-keyword">new</span><span class="hljs-type">Arr</span> <br>&#123;<br>    [<span class="hljs-keyword">new</span><span class="hljs-type">Arr</span> retain];<br>    [_mutArr release];<br>    _mutArr = <span class="hljs-keyword">new</span><span class="hljs-type">Arr</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹2ï¼šatomicå±æ€§çš„å®ç°</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//@property(retain) NSMutableArray *mutArr;</span><br>- (<span class="hljs-built_in">NSMutableArray</span> *)mutArr <br>&#123;<br>    <span class="hljs-keyword">@synchronized</span>(<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">return</span> _mutArr;<br>    &#125;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)setMutArr:(<span class="hljs-built_in">NSMutableArray</span> *)newArr<br>&#123;<br>    <span class="hljs-keyword">@synchronized</span>(<span class="hljs-keyword">self</span>) &#123;<br>      [_mutArr release];<br>      _mutArr = [newArr <span class="hljs-keyword">retain</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œnonatomic ä¿®é¥°çš„å¯¹è±¡ä¸ä¿è¯<code>setter</code>å’Œ<code>getter</code>çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥å¤šä¸ªçº¿ç¨‹å¯¹å®ƒè¿›è¡Œè®¿é—®ï¼Œå®ƒå¯èƒ½ä¼šè¿”å›æœªåˆå§‹åŒ–çš„å¯¹è±¡ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œå®ƒæ¯” atomic å¿«ï¼Œä½†å®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚<br><br/></p><p>atomic ä¿®é¥°çš„å¯¹è±¡ä¼šä¿è¯<code>setter</code>å’Œ<code>getter</code>çš„å®Œæ•´æ€§ï¼Œä»»ä½•çº¿ç¨‹å¯¹å…¶è®¿é—®éƒ½å¯ä»¥å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„åˆå§‹åŒ–åçš„å¯¹è±¡ã€‚ä¾‹å¦‚æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨<code>setter</code>ï¼Œä¸ä¼šå‡ºç°æŸä¸ªçº¿ç¨‹æ‰§è¡Œå®Œ<code>setter</code>å…¨éƒ¨è¯­å¥ä¹‹å‰ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œ<code>setter</code>æƒ…å†µï¼Œç›¸å½“äºå‡½æ•°å¤´å°¾åŠ äº†é”ä¸€æ ·ã€‚</p><h3 id="3-atomicä¸çœŸæ­£çš„çº¿ç¨‹å®‰å…¨"><a href="#3-atomicä¸çœŸæ­£çš„çº¿ç¨‹å®‰å…¨" class="headerlink" title="3.atomicä¸çœŸæ­£çš„çº¿ç¨‹å®‰å…¨"></a>3.atomicä¸çœŸæ­£çš„çº¿ç¨‹å®‰å…¨</h3><p>atomic åªä¿è¯äº†å±æ€§çš„å­˜å–æ–¹æ³•æ˜¯å®Œæ•´çš„ï¼Œä½†å¹¶ä¸ä¿è¯æ•´ä¸ªå±æ€§â€å¯¹è±¡â€æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºåˆ«çš„çº¿ç¨‹è¿˜èƒ½è¿›è¡Œå…¶ä»–æ“ä½œã€‚æ¯”å¦‚ï¼Œ<code>çº¿ç¨‹A</code>æ‰§è¡Œ <code>[self.mutArr addObject:obj];</code>ï¼ŒåŒä¸€æ—¶é—´<code>çº¿ç¨‹B</code>æ‰§è¡Œ<code>self.mutArr[index]</code>å°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨<code>setter</code>å’Œ<code>getter</code>æ—¶è·å¾—çš„å¯¹è±¡å€¼å¯èƒ½ä¼šä¸ä¸€æ ·ï¼Œç”šè‡³å‘ç”Ÿå´©æºƒã€‚æƒ³è¦ç»å¯¹çš„çº¿ç¨‹å®‰å…¨å°±è¦ç”¨åˆ°çº¿ç¨‹çš„åŒæ­¥æœºåˆ¶ï¼Œæ¯”å¦‚ä½¿ç”¨<code>NSLock</code>ã€<code>@synchronized</code>ç­‰åŠ é”ã€‚</p><br/><p>#ç¤ºä¾‹3ï¼šæ•°æ®åŒæ­¥ï¼ˆåŠ é”ï¼‰</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (atomic, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSMutableArray</span> *mArr;<br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-keyword">self</span>.mArr = [<span class="hljs-built_in">NSMutableArray</span> arrayWithObjects:<span class="hljs-string">@&quot;1&quot;</span>,<span class="hljs-string">@&quot;2&quot;</span>,<span class="hljs-string">@&quot;3&quot;</span>,<span class="hljs-string">@&quot;4&quot;</span>, <span class="hljs-literal">nil</span>];<br>    <br>    <span class="hljs-built_in">NSOperationQueue</span> * queue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    queue.maxConcurrentOperationCount = <span class="hljs-number">2</span>;<br>    <br>    <span class="hljs-comment">//NSLock *aLock = [[NSLock alloc] init];</span><br>    <br>    __<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;<br>    <span class="hljs-built_in">NSBlockOperation</span> * operation1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(weakSelf) strongSelf = weakSelf;<br>        <span class="hljs-comment">//[aLock lock];</span><br>        <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-built_in">NSString</span> * str <span class="hljs-keyword">in</span> strongSelf.mArr)&#123;<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;1è¯»æ•°æ®:%@&quot;</span>,str);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//[aLock unlock];</span><br>    &#125;];<br>    <br>    <span class="hljs-built_in">NSBlockOperation</span> * operation2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(weakSelf) strongSelf = weakSelf;<br>        <span class="hljs-comment">//[aLock lock];</span><br>        <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>)&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSInteger</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                <span class="hljs-built_in">NSString</span> *str = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;%@%ld&quot;</span>,<span class="hljs-string">@&quot;å­—ç¬¦ä¸²&quot;</span>,i];<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++2å†™æ•°æ®:%@&quot;</span>,str);<br>                [strongSelf.mArr addObject:str];<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//[aLock unlock];</span><br>    &#125;];<br><br>    <span class="hljs-built_in">NSBlockOperation</span> * operation3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(weakSelf) strongSelf = weakSelf;<br>        <span class="hljs-comment">//[aLock lock];</span><br>        <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-built_in">NSString</span> * str <span class="hljs-keyword">in</span> strongSelf.mArr)&#123;<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;3è¯»æ•°æ®:%@&quot;</span>,str);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//[aLock unlock];</span><br>    &#125;];<br>    <br>    [queue addOperation:operation1];<br>    [queue addOperation:operation2];<br>    [queue addOperation:operation3];<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­ï¼Œæ•°ç»„è¢«å®šä¹‰ä¸º atomic çš„å±æ€§ï¼Œä½†æ˜¯åœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°å´©æºƒï¼ŒæŠ¥é”™â€œCollection &lt;__NSArrayM: 0x60000024a8f0&gt; was mutated while being enumerated.â€ï¼Œè¯´æ˜ atomic å¯¹è±¡å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ç¤ºä¾‹ä¸­æä¾›äº†ä¸¤ç§æ•°æ®åŒæ­¥çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯ä½¿ç”¨<code>NSLock</code>è¿›è¡ŒåŠ é”ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨<code>@synchronized</code>åŠ é”ï¼Œä¸¤ç§éƒ½å¯ä»¥ä¿è¯æ•°ç»„å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨ã€‚<br><br/></p><p>ç»¼ä¸Šï¼Œåœ¨æ— éœ€è€ƒè™‘å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ä½¿ç”¨ nonatomicï¼Œå®ƒèƒ½è®©ç¼–è¯‘å™¨å°‘ç”Ÿæˆä¸€äº›åŠ é”çš„ä»£ç ï¼Œæé«˜è¯»å†™æ•ˆç‡ã€‚åœ¨æ¶‰åŠåˆ°å¤šçº¿ç¨‹çš„æ—¶å€™ä½¿ç”¨ atomicï¼ŒåŒæ—¶é…åˆåŠ é”ï¼Œé˜²æ­¢äº§ç”Ÿè¯¥å˜é‡è¯»å†™ç­‰æ“ä½œçš„åŒæ­¥é—®é¢˜ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¤šçº¿ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å±æ€§çš„ä¿®é¥°ç¬¦</title>
    <link href="/2017/11/24/property.html"/>
    <url>/2017/11/24/property.html</url>
    
    <content type="html"><![CDATA[<h3 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h3><h4 id="1-retainï¼š"><a href="#1-retainï¼š" class="headerlink" title="1.retainï¼š"></a>1.retainï¼š</h4><p>ç±»ä¼¼äºARCä¸‹çš„ <code>strong</code>ï¼Œè¡¨ç¤ºå¼ºå¼•ç”¨å’ŒæŒæœ‰çš„å…³ç³»ï¼šå°†å±æ€§æˆå‘˜å˜é‡çš„æŒ‡é’ˆæŒ‡å‘æºå¯¹è±¡ï¼ŒåŒæ—¶æŒæœ‰æºå¯¹è±¡ï¼ˆæ­¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¼šåŠ 1ï¼‰ã€‚</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">//retain</span><br>-(void)setName:<span class="hljs-type"></span>(NSString *)<span class="hljs-keyword">new</span><span class="hljs-type">Name</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (_name != <span class="hljs-keyword">new</span><span class="hljs-type">Name</span>) &#123;<br>        [<span class="hljs-keyword">new</span><span class="hljs-type">Name</span> retain];<br>        [_name release];<br>        _name = <span class="hljs-keyword">new</span><span class="hljs-type">Name</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-assignï¼š"><a href="#2-assignï¼š" class="headerlink" title="2.assignï¼š"></a>2.assignï¼š</h4><p>ç±»ä¼¼äºARCä¸‹çš„ <code>weak</code>ï¼Œè¡¨ç¤ºå¼±å¼•ç”¨å’Œä¸æŒæœ‰çš„å…³ç³»ï¼šå°†å±æ€§æˆå‘˜å˜é‡çš„æŒ‡é’ˆæŒ‡å‘æºå¯¹è±¡ï¼Œä½†ä¸æŒæœ‰æºå¯¹è±¡ï¼Œä¸æ›´æ”¹å…¶å¼•ç”¨è®¡æ•°ï¼Œä¸€èˆ¬ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹(<code>NSInteger</code>ï¼Œ<code>CGFloat</code>)å’ŒCç±»å‹ã€<code>int,float,double,bool</code>ç­‰ï¼Œè¿™äº›æ•°å€¼ä¸»è¦å­˜åœ¨äºæ ˆä¸Š)ã€‚</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">//assign</span><br>-(void)setName:<span class="hljs-type"></span>(NSString *)<span class="hljs-keyword">new</span><span class="hljs-type">Name</span><br>&#123;<br>    _name = <span class="hljs-keyword">new</span><span class="hljs-type">Name</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>weak ä¸ assign çš„åŒºåˆ«ï¼š</strong><br><br/></p><p>1ã€ä¿®é¥°çš„å¯¹è±¡</p><p><strong>assign</strong> å¯ä¿®é¥°å¯¹è±¡ç±»å‹å’ŒåŸºæœ¬ç±»å‹ï¼Œä¸€èˆ¬ç”¨äºä¿®é¥°åŸºæœ¬ç±»å‹ã€‚<strong>weak</strong> åªå¯ä»¥ä¿®é¥°å¯¹è±¡ç±»å‹ï¼Œä¿®é¥°åŸºæœ¬æ•°æ®ç±»å‹æ—¶ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚<br><br/></p><p>2ã€ä¿®é¥°å¯¹è±¡ç±»å‹æ—¶æ˜¯å¦äº§ç”Ÿé‡æŒ‡é’ˆ</p><p><strong>weak</strong> ä¸ä¼šäº§ç”Ÿé‡æŒ‡é’ˆé—®é¢˜ï¼šweak ä¿®é¥°çš„å¯¹è±¡é‡Šæ”¾åæŒ‡é’ˆä¼šè‡ªåŠ¨è¢«ç½®nilï¼Œä¹‹åå†å‘è¯¥å¯¹è±¡å‘æ¶ˆæ¯ä¹Ÿä¸ä¼šå´©æºƒã€‚<strong>assign</strong> ä¿®é¥°å¯¹è±¡ç±»å‹æ—¶å¯èƒ½ä¼šäº§ç”Ÿé‡æŒ‡é’ˆé—®é¢˜ï¼šassign ä¿®é¥°çš„è±¡è¢«é‡Šæ”¾åæŒ‡é’ˆä¸ä¼šè‡ªåŠ¨è¢«ç½®ç©ºï¼Œæ­¤æ—¶å‘å¯¹è±¡å‘æ¶ˆæ¯ä¼šå´©æºƒã€‚<br>å¦å¤–ï¼Œå¦‚æœassignåªæ˜¯ä¿®é¥°åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ™æ˜¯å®‰å…¨çš„ã€‚<br><br/></p><p>3ã€å°ç»“ï¼š<br>å€¼ç±»å‹ä¼šè¢«æ”¾å…¥æ ˆä¸­ï¼Œéµå¾ªå…ˆè¿›åå‡ºåŸåˆ™ï¼Œç”±ç³»ç»Ÿè´Ÿè´£ç®¡ç†æ ˆå†…å­˜ã€‚è€Œå¼•ç”¨ç±»å‹ä¼šè¢«æ”¾å…¥å †ä¸­ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨ç®¡ç†å†…å­˜æˆ–é€šè¿‡ARCç®¡ç†ã€‚<strong>weak</strong> é€‚ç”¨äº delegate å’Œ block ç­‰å¼•ç”¨ç±»å‹ï¼Œä¸ä¼šå¯¼è‡´é‡æŒ‡é’ˆé—®é¢˜ï¼Œå¯ç”¨äºè§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œæ˜¯å®‰å…¨çš„ã€‚<strong>assign</strong> é€‚ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¸é€‚ç”¨äºå¼•ç”¨ç±»å‹ã€‚</p><h4 id="3-copyï¼š"><a href="#3-copyï¼š" class="headerlink" title="3.copyï¼š"></a>3.copyï¼š</h4><p>è¡¨ç¤ºæ‹·è´å’ŒæŒæœ‰ï¼šä¼šåœ¨å†…å­˜ä¸­æ‹·è´ä¸€ä»½æºå¯¹è±¡ï¼Œå¹¶å°†å±æ€§å¯¹åº”çš„æˆå‘˜å˜é‡çš„æŒ‡é’ˆæŒ‡å‘æ­¤æ‹·è´å‡ºçš„æ–°å¯¹è±¡ï¼Œæ–°å¯¹è±¡çš„å¼•ç”¨è®¡æ•° &#x3D; 1ã€‚</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs haxe">-(void)setName:<span class="hljs-type"></span>(NSString *)<span class="hljs-keyword">new</span><span class="hljs-type">Name</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (_name != <span class="hljs-keyword">new</span><span class="hljs-type">Name</span>) &#123;<br>        [_name release];<br>        _name = [<span class="hljs-keyword">new</span><span class="hljs-type">Name</span> copy];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ strong çš„åŒºåˆ«åœ¨äºï¼š<code>strong</code> ä¿®é¥°çš„å˜é‡ä¸åŸå¯¹è±¡æŒ‡å‘åŒä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œå¯¹å˜é‡çš„ä¿®æ”¹ä¼šå½±å“åˆ°æºå¯¹è±¡ã€‚è€Œ<code>copy</code> ä¿®é¥°çš„å¯¹è±¡ä¸æºå¯¹è±¡æŒ‡å‘ä¸¤ç‰‡ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œå˜é‡ä¸åŸå¯¹è±¡ä¸¤è€…äº’ä¸å½±å“ã€‚</p><h4 id="4-readwriteï¼š"><a href="#4-readwriteï¼š" class="headerlink" title="4.readwriteï¼š"></a>4.readwriteï¼š</h4><p>ç¼–è¯‘å™¨è‡ªåŠ¨ä¸ºå±æ€§åˆ›å»º setter&#x2F;getter æ–¹æ³•ã€‚</p><h4 id="5-readonlyï¼š"><a href="#5-readonlyï¼š" class="headerlink" title="5.readonlyï¼š"></a>5.readonlyï¼š</h4><p>ç¼–è¯‘å™¨åªä¸ºå±æ€§åˆ›å»º getter æ–¹æ³•ã€‚<br><br/></p><p>å±æ€§è¢«å£°æ˜ä¸ºåªè¯»æ—¶ï¼Œå¯ä»¥åŒæ—¶é‡å†™å±æ€§çš„<code>getter</code>ä¸<code>setter</code> ä½¿å…¶å˜ä¸º readwriteã€‚</p><h4 id="6-nonatomicï¼š"><a href="#6-nonatomicï¼š" class="headerlink" title="6.nonatomicï¼š"></a>6.nonatomicï¼š</h4><p>nonatomic ä¿®é¥°çš„å¯¹è±¡ä¸ä¿è¯<code>setter</code>å’Œ<code>getter</code>çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥å¤šä¸ªçº¿ç¨‹å¯¹å®ƒè¿›è¡Œè®¿é—®ï¼Œå®ƒå¯èƒ½ä¼šè¿”å›æœªåˆå§‹åŒ–çš„å¯¹è±¡ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œå®ƒæ¯” atomic å¿«ï¼Œä½†å®ƒä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// @property(nonatomic, <span class="hljs-keyword">copy</span>) NSString *<span class="hljs-type">name</span>;<br>- (NSString *)<span class="hljs-type">name</span> <br>&#123;<br>    <span class="hljs-keyword">return</span> _name;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)setName:(NSString *)newName <br>&#123;<br>    [_name <span class="hljs-keyword">release</span>];<br>    _name = [newName <span class="hljs-keyword">copy</span>];<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="7-atomicï¼š"><a href="#7-atomicï¼š" class="headerlink" title="7.atomicï¼š"></a>7.atomicï¼š</h4><p>atomic ä¿®é¥°çš„å¯¹è±¡ä¼šä¿è¯<code>setter</code>å’Œ<code>getter</code>çš„å®Œæ•´æ€§ï¼Œä»»ä½•çº¿ç¨‹å¯¹å…¶è®¿é—®éƒ½å¯ä»¥å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„åˆå§‹åŒ–åçš„å¯¹è±¡ã€‚ä¾‹å¦‚æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨<code>setter</code>ï¼Œä¸ä¼šå‡ºç°æŸä¸ªçº¿ç¨‹æ‰§è¡Œå®Œ<code>setter</code>å…¨éƒ¨è¯­å¥ä¹‹å‰ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œ<code>setter</code>æƒ…å†µï¼Œç›¸å½“äºå‡½æ•°å¤´å°¾åŠ äº†é”ä¸€æ ·ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// @property(atomic, copy) NSString *name;</span><br>- (<span class="hljs-built_in">NSString</span> *)name <br>&#123;<br>    <span class="hljs-keyword">@synchronized</span>(<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">return</span> _name;<br>    &#125;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)setName:(<span class="hljs-built_in">NSString</span> *)newName <br>&#123;<br>    <span class="hljs-keyword">@synchronized</span>(<span class="hljs-keyword">self</span>) &#123;<br>      [_name release];<br>      _name = [newName <span class="hljs-keyword">copy</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºè¦ä¿è¯æ“ä½œå®Œæˆï¼Œæ‰€ä»¥é€Ÿåº¦æ…¢ã€‚å®ƒæ¯”<code>nonatomic</code>å®‰å…¨ï¼Œä½†ä¹Ÿå¹¶ä¸æ˜¯ç»å¯¹çš„çº¿ç¨‹å®‰å…¨ï¼Œä¾‹å¦‚å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨<code>set</code>å’Œ<code>get</code>å°±ä¼šå¯¼è‡´è·å¾—çš„å¯¹è±¡å€¼ä¸ä¸€æ ·ç”šè‡³å‘ç”Ÿå´©æºƒã€‚ç»å¯¹çš„çº¿ç¨‹å®‰å…¨å°±è¦ç”¨åˆ°çº¿ç¨‹çš„åŒæ­¥æœºåˆ¶ï¼Œæ¯”å¦‚ä½¿ç”¨<code>NSLock</code>ã€<code>@synchronized</code>ç­‰åŠ é”ã€‚</p><h4 id="8-é»˜è®¤å€¼"><a href="#8-é»˜è®¤å€¼" class="headerlink" title="8.é»˜è®¤å€¼"></a>8.é»˜è®¤å€¼</h4><p>åŸºæœ¬æ•°æ®ç±»å‹çš„é»˜è®¤å…³é”®å­—æ˜¯ï¼š<code>atomic</code>ã€<code>readwrite</code>ã€<code>assign</code>ï¼›<br><br/></p><p>å±æ€§çš„é»˜è®¤å…³é”®å­—æ˜¯ï¼š<code>atomic</code>ã€<code>readwrite</code>ã€<code>strong</code>ã€‚</p><h3 id="Getterä¸Setter"><a href="#Getterä¸Setter" class="headerlink" title="Getterä¸Setter"></a>Getterä¸Setter</h3><h4 id="dynamic"><a href="#dynamic" class="headerlink" title="@dynamic"></a>@dynamic</h4><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">@<span class="hljs-keyword">dynamic</span> <span class="hljs-keyword">var</span>;<br></code></pre></td></tr></table></figure><p>@dynamicï¼šå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œå±æ€§çš„<code>getter</code>å’Œ<code>setter</code>ç”±æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œä¸éœ€è¦ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆã€‚å¦‚æœæˆ‘ä»¬å°†å±æ€§æ ‡è®°ä¸º<code>@dynamic var;</code>è€Œåˆæ²¡æœ‰æä¾›å¯¹åº”çš„<code>getter</code>ä¸<code>setter</code>æ—¶ï¼Œç¼–è¯‘æœŸæ˜¯ä¸ä¼šæŠ¥é”™ï¼Œä½†åœ¨è¿è¡ŒæœŸå¦‚æœè®¿é—®å±æ€§æˆ–è€…ç»™å±æ€§èµ‹å€¼æ—¶åˆ™ä¼šæŠ¥é”™å¹¶å´©æºƒï¼Œå› ä¸ºè¿è¡Œæ—¶æ‰¾ä¸åˆ°å¯¹åº”çš„<code>getter</code>å’Œ<code>setter</code>å»å®Œæˆè¿™ä¸¤ä¸ªæ“ä½œã€‚</p><h4 id="synthesize"><a href="#synthesize" class="headerlink" title="@synthesize"></a>@synthesize</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-meta">@syntheszie</span> <span class="hljs-keyword">var</span>;<br></code></pre></td></tr></table></figure><p>@synthesizeï¼šå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œåœ¨ç¼–è¯‘æœŸç”¨æˆ‘æŒ‡å®šçš„æˆå‘˜å˜é‡å®ç°å±æ€§çš„<code>getter</code>å’Œ<code>setter</code>ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSArray</span> *anArr;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><span class="hljs-comment">//@dynamic anArr;</span><br><span class="hljs-keyword">@synthesize</span> anArr;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-keyword">self</span>.anArr = @[<span class="hljs-string">@&quot;Hello&quot;</span>];<br>    <span class="hljs-built_in">NSString</span> *str = <span class="hljs-keyword">self</span>.anArr[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢è®¿é—®å±æ€§æ—¶ä½¿ç”¨çš„éƒ½æ˜¯<code>self.anArr</code>ï¼Œè¿™æ—¶å¦‚æœä½¿ç”¨<code>_anArr</code>ä¼šæŠ¥é”™ï¼Œå› ä¸º<code>@synthesize anArr;</code>åªåˆ›å»ºäº†æˆå‘˜å˜é‡<code>anArr</code>å¹¶ç»‘å®šåˆ°å±æ€§<code>anArr</code>ä¸Šã€‚æ‰€ä»¥éœ€è¦æˆ‘ä»¬ä½¿ç”¨<code>@synthesize anArr = _anArr</code>æ¥è®©ç¼–è¯‘å™¨å¸®æˆ‘ä»¬åˆ›å»ºæˆå‘˜å˜é‡<code>_anArr</code>å¹¶å°†å…¶ç»‘å®šåˆ°å±æ€§ä¸Šã€‚</p><h4 id="é»˜è®¤å€¼"><a href="#é»˜è®¤å€¼" class="headerlink" title="é»˜è®¤å€¼"></a>é»˜è®¤å€¼</h4><p>iOS5ä¹‹åï¼Œå¦‚æœ<code>@synthesize</code>å’Œ<code>@dynamic</code>éƒ½æ²¡å†™ï¼Œé‚£ä¹ˆå±æ€§é»˜è®¤æ˜¯<code>@syntheszie var = _var</code>;</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://xiaozhuanlan.com/topic/3908156472">Â©æ•…èƒ¤é“é•¿</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>js-Nativeäº¤äº’</title>
    <link href="/2017/11/23/js-native.html"/>
    <url>/2017/11/23/js-native.html</url>
    
    <content type="html"><![CDATA[<p>ç§»åŠ¨å¼€å‘ä¸­ç»å¸¸ä¼šç”¨åˆ°ç½‘é¡µï¼Œä¾‹å¦‚æ´»åŠ¨ä¿¡æ¯å±•ç¤ºå¹¶å“åº”ç½‘é¡µä¸­çš„Clickäº‹ä»¶ã€‚è¿™ä¸ªäº¤äº’çš„è¿‡ç¨‹å°±æ¶‰åŠåˆ°jsä¸OCæˆ–Swiftçš„ç›¸äº’è°ƒç”¨ï¼Œè¿™é‡ŒOCæˆ–Swiftå°±ç»Ÿç§°ä¸ºNativeï¼Œå³åŸç”Ÿåº”ç”¨ã€‚æœ¬æ–‡æ€»ç»“äº†ä¸‰ç§æœ€å¸¸è§çš„js-Nativeäº¤äº’å®ç°æ–¹æ¡ˆå¹¶é™„ä¸Šä»£ç ã€‚</p><p>åœºæ™¯ï¼šç‚¹å‡»ç½‘é¡µæŒ‰é’®ï¼Œè·³è½¬åˆ°Nativeæ”¯ä»˜é¡µé¢ï¼Œåœ¨ç½‘é¡µä¸­æ˜¾ç¤ºæ”¯ä»˜ç»“æœã€‚</p><h3 id="ä¸€-æ‹¦æˆªURL"><a href="#ä¸€-æ‹¦æˆªURL" class="headerlink" title="ä¸€.æ‹¦æˆªURL"></a>ä¸€.æ‹¦æˆªURL</h3><h4 id="1-Native-gt-js"><a href="#1-Native-gt-js" class="headerlink" title="1.Native-&gt;js"></a>1.Native-&gt;js</h4><p>Nativeè°ƒç”¨jsä¸»è¦æ˜¯é€šè¿‡<code>stringByEvaluatingJavaScriptFromString</code>æ–¹æ³•ã€‚</p><ul><li>ä»£ç ï¼š</li></ul><p>æ¥çœ‹æœ¬åœ°<code>pay.html</code>ç½‘é¡µä»£ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--æ˜¾ç¤ºnativeè°ƒç”¨jsåçš„ç»“æœ--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;result&quot;</span>&gt;</span>pay result: <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br> <br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//jsæ–¹æ³•ï¼Œä¾›nativeè°ƒ    native-&gt;h5</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">payResult</span>(<span class="hljs-params">result</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;result&quot;</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&#x27;pay result: &#x27;</span> + result;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Nativeä¸­åŠ è½½HTMLå¹¶è°ƒç”¨å…¶å®šä¹‰çš„jsæ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DKUIWebViewController</span> ()&lt;<span class="hljs-title">UIWebViewDelegate</span>&gt;</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UIWebView</span> *mUIWebview;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DKUIWebViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    <span class="hljs-comment">//åŠ è½½æœ¬åœ°ç½‘é¡µ</span><br>    <span class="hljs-built_in">NSString</span> *path = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string">@&quot;pay&quot;</span> ofType:<span class="hljs-string">@&quot;html&quot;</span>];<br>    <span class="hljs-built_in">NSURLRequest</span> *request = [<span class="hljs-built_in">NSURLRequest</span> requestWithURL:<br>                             [<span class="hljs-built_in">NSURL</span> fileURLWithPath:path]];<br>    [_mUIWebview loadRequest:request];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark UIWebviewDelegate</span><br>-(<span class="hljs-type">void</span>)webViewDidFinishLoad:(<span class="hljs-built_in">UIWebView</span> *)webView&#123;<br>    <span class="hljs-comment">//nativeè°ƒç”¨js æ˜¾ç¤ºæ”¯ä»˜ç»“æœ</span><br>    [_mUIWebview stringByEvaluatingJavaScriptFromString:<span class="hljs-string">@&quot;payResult(&#x27;succeed&#x27;)&quot;</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h4 id="2-js-gt-Native"><a href="#2-js-gt-Native" class="headerlink" title="2.js-&gt;Native"></a>2.js-&gt;Native</h4><p>åœ¨<code>shouldStartLoadWithRequest:</code>å›è°ƒä¸­ç›‘å¬<code>a</code>æ ‡ç­¾è·³è½¬äº‹ä»¶ã€‚</p><ul><li>ä»£ç ï¼š</li></ul><p>ä¿®æ”¹æœ¬åœ°<code>pay.html</code>ä»£ç ï¼ŒåŠ å…¥<code>a</code>æ ‡ç­¾è·³è½¬ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--å®šä¹‰aæ ‡ç­¾ï¼Œè·³è½¬ç‰¹æ®Šurlä¾›nativeç›‘å¬ --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;router://pay&quot;</span>&gt;</span>pay<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-comment">&lt;!--æ˜¾ç¤ºnativeè°ƒç”¨jsåçš„ç»“æœ--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;result&quot;</span>&gt;</span>pay result: <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br> <br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//jsæ–¹æ³•ï¼Œä¾›nativeè°ƒ    native-&gt;h5</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">payResult</span>(<span class="hljs-params">result</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;result&quot;</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&#x27;pay result: &#x27;</span> + result;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Nativeç½‘é¡µä¸­ç›‘å¬<code>a</code>æ ‡ç­¾äº‹ä»¶ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark UIWebviewDelegate</span><br>- (<span class="hljs-type">BOOL</span>)webView:(<span class="hljs-built_in">UIWebView</span> *)webView<br>shouldStartLoadWithRequest:(<span class="hljs-built_in">NSURLRequest</span> *)request<br> navigationType:(<span class="hljs-built_in">UIWebViewNavigationType</span>)navigationType<br>&#123;<br>    <span class="hljs-comment">//æ‹¦æˆªè¯·æ±‚</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">UIWebViewNavigationTypeLinkClicked</span> == navigationType) &#123;<br>        <span class="hljs-keyword">if</span> ([request.URL.absoluteString rangeOfString:<span class="hljs-string">@&quot;router://pay&quot;</span>].location != <span class="hljs-built_in">NSNotFound</span>) &#123;<br>            <span class="hljs-comment">//nativeå¤„ç†é€»è¾‘</span><br><br>            DKPayController *controller = [[DKPayController alloc] init];<br>            [<span class="hljs-keyword">self</span>.navigationController pushViewController:controller animated:<span class="hljs-literal">YES</span>];<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç‚¹å‡»ç½‘é¡µä¸­<code>a</code>æ ‡ç­¾ï¼ŒNativeä¸­ç›‘å¬åˆ°<code>router://pay</code>è·³è½¬è¯·æ±‚åï¼Œæœ¬åœ°è·³è½¬åˆ°æ”¯ä»˜é¡µé¢ã€‚</p><h3 id="äºŒ-JavaScriptCore"><a href="#äºŒ-JavaScriptCore" class="headerlink" title="äºŒ.JavaScriptCore"></a>äºŒ.JavaScriptCore</h3><p>å¾€ç½‘é¡µä¸­ä¼ å…¥ä¸€ä¸ª<code>javaScriptContext</code>å¯¹è±¡ï¼Œåˆ©ç”¨å®ƒä½œä¸º<code>bridge</code>ä¸­ä»‹å®ç°jsä¸Nativeçš„äº¤äº’ã€‚æ³¨æ„ï¼šè¿™åªé€‚ç”¨äº<code>UIWebView</code>ã€‚</p><h4 id="1-JSExport"><a href="#1-JSExport" class="headerlink" title="1.JSExport"></a>1.JSExport</h4><p><code>JSExport</code>æ˜¯<code>JavaScriptCore</code>åº“æä¾›çš„ä¸€ä¸ªåè®®ï¼Œæ­¤åè®®ä¸­å¯å®šä¹‰ä¸€äº›æ¥å£ï¼Œä¾›jsè°ƒç”¨ã€‚</p><h4 id="2-js-gt-Native-1"><a href="#2-js-gt-Native-1" class="headerlink" title="2.js-&gt;Native"></a>2.js-&gt;Native</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;JavaScriptCore/JavaScriptCore.h&gt;</span></span><br><br><span class="hljs-comment">//å£°æ˜ä¸€ä¸ªåè®®ï¼Œç»§æ‰¿å¹¶æ‰©å±•JSExportåè®®</span><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">JSOCExportProtocol</span> &lt;<span class="hljs-title">JSExport</span>&gt;</span><br><span class="hljs-comment">//å£°æ˜å±æ€§</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-comment">//å£°æ˜ä¾›jså›è°ƒçš„OCæ–¹æ³•</span><br>- (<span class="hljs-type">void</span>)pay;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//å®ç°JSExportåè®®ï¼Œè¿™å°±æ˜¯æ³¨å†ŒJSContextæ—¶ä¼ é€’çš„å¯¹è±¡</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">JSOCHelper</span> : <span class="hljs-title">NSObject</span>&lt;<span class="hljs-title">JSOCExportProtocol</span>&gt;</span><br>- (<span class="hljs-keyword">instancetype</span>)initWithSource:(<span class="hljs-built_in">UIViewController</span>*)viewController;<br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;JSOCHelper.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">JSOCHelper</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">weak</span>) <span class="hljs-built_in">UIViewController</span> *viewController;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">JSOCHelper</span></span><br><br>- (<span class="hljs-keyword">instancetype</span>)initWithSource:(<span class="hljs-built_in">UIViewController</span> *)viewController<br>&#123;<br>    <span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">self</span>.viewController = viewController;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -JSExport Delegate methods</span><br>- (<span class="hljs-type">void</span>)pay&#123;<br>    <span class="hljs-comment">//è°ƒç”¨self.viewControllerçš„åè®®æ–¹æ³•</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++JS call OC: Go to Pay !&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯è‡ªå®šä¹‰çš„JSOCHelperç±»ï¼Œå…¶ä¸­çš„<code>JSOCExportProtocol</code>åè®®å®ç°äº†<code>JSExport</code>åè®®ï¼Œåœ¨è¿™é‡Œå®šä¹‰äº†ä¸€äº›ä¾›jsè°ƒç”¨çš„æ¥å£å¹¶æä¾›å¯¹åº”çš„å®ç°ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;JSOCHelper.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DKUIWebViewController</span> ()&lt;<span class="hljs-title">UIWebViewDelegate</span>&gt;</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UIWebView</span> *mUIWebview;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) JSContext *jsContext;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DKUIWebViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    <span class="hljs-comment">//åŠ è½½æœ¬åœ°ç½‘é¡µ</span><br>    <span class="hljs-built_in">NSString</span> *path = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string">@&quot;pay&quot;</span> ofType:<span class="hljs-string">@&quot;html&quot;</span>];<br>    <span class="hljs-built_in">NSURLRequest</span> *request = [<span class="hljs-built_in">NSURLRequest</span> requestWithURL:<br>                             [<span class="hljs-built_in">NSURL</span> fileURLWithPath:path]];<br>    [_mUIWebview loadRequest:request];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark UIWebviewDelegate</span><br>-(<span class="hljs-type">void</span>)webViewDidFinishLoad:(<span class="hljs-built_in">UIWebView</span> *)webView<br>&#123;<br>    <span class="hljs-comment">//è·å–JavaScriptContextå¯¹è±¡</span><br>    _jsContext = [webView valueForKeyPath:<span class="hljs-string">@&quot;documentView.webView.mainFrame.javaScriptContext&quot;</span>];<br>    <span class="hljs-comment">//ä¸ºJavaScriptContextæ³¨å…¥Bridgeå¯¹è±¡</span><br>    _jsContext[<span class="hljs-string">@&quot;jsbridge&quot;</span>] = [[JSOCHelper alloc] initWithSource:<span class="hljs-keyword">self</span>];<br>    <br>    <span class="hljs-comment">//å¾€jsä¸­æ³¨å…¥æ–°çš„loginå‡½æ•°ï¼Œblockä¸ºå…¶å¯¹åº”çš„OCå›è°ƒ</span><br>    _jsContext[<span class="hljs-string">@&quot;login&quot;</span>] = ^(<span class="hljs-type">id</span> data,<span class="hljs-built_in">NSString</span> *error)&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++++js call jsContext block, data:%@,error:%@&quot;</span>,data,error);<br>    &#125;;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯Nativeéƒ¨åˆ†çš„ä»£ç ï¼Œä¸»è¦æ˜¯åœ¨åˆé€‚çš„æ—¶æœºå¾€webä¸­æ³¨å…¥ä¸€ä¸ª<code>jsbridge</code>å¯¹è±¡ï¼Œåé¢ç‚¹å‡»ç½‘é¡µä¸­çš„æŒ‰é’®æ—¶ï¼Œjså¯é€šè¿‡è¿™ä¸ªå¯¹è±¡ç›´æ¥è°ƒç”¨Nativeå‡½æ•°ã€‚</p><p>ä½ ä¹Ÿå¯ä»¥å¾€è¿™ä¸ª<code>jsbridge</code>ä¸­ç»‘å®šæ–°çš„<code>jsæ–¹æ³•</code>å’Œä¸å…¶å¯¹åº”çš„Native<code>å›è°ƒ</code>ï¼Œåé¢Nativeè°ƒç”¨æ­¤jsæ–¹æ³•æ—¶ä¼šè‡ªåŠ¨è§¦å‘ä¸å…¶ç»‘å®šçš„å›è°ƒã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--æ”¯ä»˜æŒ‰é’®--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;pay&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;pay()&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-comment">&lt;!--æ˜¾ç¤ºnativeè°ƒç”¨jsåçš„ç»“æœ--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;result&quot;</span>&gt;</span>pay result: <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br> <br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//è°ƒç”¨Nativeçš„æ–¹æ³•   js-&gt;native</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        jsbridge.<span class="hljs-title function_">pay</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    <span class="hljs-comment">//jsæ–¹æ³•ï¼Œä¾›nativeè°ƒ    native-&gt;js</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">payResult</span>(<span class="hljs-params">result</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;result&quot;</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&#x27;pay result: &#x27;</span> + result;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æ–°çš„<code>pay.html</code>ç½‘é¡µï¼Œå¢åŠ äº†ä¸€ä¸ªæŒ‰é’®ï¼Œç”¨æ¥è°ƒç”¨Nativeçš„æ–¹æ³•ã€‚</p><p>ç‚¹å‡»ç½‘é¡µä¸­çš„<code>pay</code>æŒ‰é’®ï¼Œjså³ä¼šé€šè¿‡æˆ‘ä»¬åœ¨<code>webViewDidFinishLoad</code>ä¸­æ—©å…ˆä¼ å…¥çš„jsbridgeå¯¹è±¡ï¼Œç›´æ¥è°ƒç”¨Nativeçš„<code>pay</code>æ–¹æ³•ï¼Œå³JSOCHelperä¸­å®šä¹‰å¥½çš„åè®®æ–¹æ³•ã€‚</p><h4 id="3-Native-gt-js"><a href="#3-Native-gt-js" class="headerlink" title="3.Native-&gt;js"></a>3.Native-&gt;js</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DKUIWebViewController</span> ()&lt;<span class="hljs-title">UIWebViewDelegate</span>&gt;</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">UIWebView</span> *mUIWebview;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) JSContext *jsContext;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DKUIWebViewController</span></span><br><br>...<br><br>- (<span class="hljs-type">void</span>)nativeCallJS&#123;<br>    <span class="hljs-comment">//nativeè°ƒç”¨js</span><br>    <span class="hljs-comment">//æ–¹æ³•1</span><br>    JSValue *jsFunc = _jsContext[<span class="hljs-string">@&quot;login&quot;</span>];<span class="hljs-comment">//è°ƒç”¨ä¸Šé¢æ³¨å†Œçš„block</span><br>    [jsFunc callWithArguments:@[<span class="hljs-string">@&quot;data&quot;</span>,<span class="hljs-string">@&quot;call by JSValue Error info&quot;</span>]];<br>    <span class="hljs-comment">//æ–¹æ³•2</span><br>    [_jsContext evaluateScript:<span class="hljs-string">@&quot;login(&#x27;data&#x27;,&#x27;call by [jsContext evaluateScript:] Error info&#x27;)&quot;</span>];<span class="hljs-comment">//nativeè°ƒç”¨JSä¸­å®šä¹‰çš„ç™»å½•æ–¹æ³•</span><br>    <span class="hljs-comment">//æ–¹æ³•3</span><br>    <span class="hljs-built_in">NSString</span> *jsFuncScript = <span class="hljs-string">@&quot;login(&#x27;data&#x27;,&#x27;Error info~&#x27;)&quot;</span>;<br>    [_mUIWebview stringByEvaluatingJavaScriptFromString:jsFuncScript];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å‰ä¸¤ä¸ªæ˜¯<code>JavaScriptCore</code>æä¾›çš„æ¥å£ï¼Œ<code>æ–¹æ³•3</code>æ˜¯æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„webviewè°ƒç”¨jsçš„æ–¹æ³•ã€‚</p><h3 id="ä¸‰-WKWebView"><a href="#ä¸‰-WKWebView" class="headerlink" title="ä¸‰.WKWebView"></a>ä¸‰.WKWebView</h3><h4 id="1-WKScriptMessageHandler"><a href="#1-WKScriptMessageHandler" class="headerlink" title="1.WKScriptMessageHandler"></a>1.WKScriptMessageHandler</h4><p>è¿™æ˜¯<code>WKWebView</code>ä¸­ç”¨æ¥è¿›è¡Œjsä¸Nativeäº¤äº’çš„ä¸»è¦åª’ä»‹ï¼Œæˆ‘ä»¬éœ€è¦å¾€webä¸­æ³¨å…¥ä¸€ä¸ªæˆ–å¤šä¸ª<code>MessageHandler</code>å¯¹è±¡å¤„ç†ä¸åŒçš„æ¥è‡ªjså¯¹Nativeçš„è°ƒç”¨ã€‚</p><p>å®ƒæ˜¯ä¸€ä¸ªåè®®å¹¶ä¸”åªæœ‰ä¸€ä¸ªä»£ç†æ–¹æ³•ã€‚æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªç±»å®ç°æ­¤åè®®åŠå…¶ä»£ç†å‡½æ•°ï¼Œé€šè¿‡åŒºåˆ†æ¯ä¸ª<code>handler</code>çš„åå­—æ¥è°ƒç”¨ä¸ä¹‹å¯¹åº”çš„Nativeå‡½æ•°ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//.hæ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;WebKit/WebKit.h&gt;</span></span><br><br><span class="hljs-comment">//å®å®šä¹‰WKScriptMessageå¯¹è±¡çš„åå­—</span><br><span class="hljs-built_in">UIKIT_EXTERN</span> <span class="hljs-built_in">NSString</span> * <span class="hljs-keyword">const</span> <span class="hljs-built_in">WK_MethodName</span>;<br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DKWKScriptMessageHandler</span> : <span class="hljs-title">NSObject</span>&lt;<span class="hljs-title">WKScriptMessageHandler</span>&gt;</span><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//.mæ–‡ä»¶</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DKWKScriptMessageHandler.h&quot;</span></span><br><span class="hljs-built_in">NSString</span> *<span class="hljs-keyword">const</span> <span class="hljs-built_in">WK_MethodName</span> = <span class="hljs-string">@&quot;pay&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DKWKScriptMessageHandler</span></span><br><br><span class="hljs-comment">//å®ç°ä»£ç†ï¼Œjsè°ƒç”¨nativeæ—¶ä¼šå›è°ƒåˆ°è¿™é‡Œ</span><br>- (<span class="hljs-type">void</span>)userContentController:(<span class="hljs-built_in">WKUserContentController</span> *)userContentController<br>      didReceiveScriptMessage:(<span class="hljs-built_in">WKScriptMessage</span> *)message &#123;<br><br>    <span class="hljs-comment">//å¯ä»¥å®šä¹‰å¤šä¸ªmessage handlerå¤„ç†æ¥è‡ªjsçš„ä¸åŒä»»åŠ¡ï¼Œè¿™é‡Œéœ€è¦åŒºåˆ†å…¶åå­—</span><br>    <span class="hljs-keyword">if</span> ([message.name isEqualToString:<span class="hljs-built_in">WK_MethodName</span>]) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++WK Script message:%@&quot;</span>,message.body);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h4 id="2-js-gt-Native-2"><a href="#2-js-gt-Native-2" class="headerlink" title="2.js-&gt;Native"></a>2.js-&gt;Native</h4><p>å…ˆçœ‹ç½‘é¡µç«¯çš„ä»£ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--æ”¯ä»˜æŒ‰é’®--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;pay&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;pay()&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-comment">&lt;!--æ˜¾ç¤ºnativeè°ƒç”¨jsåçš„ç»“æœ--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;result&quot;</span>&gt;</span>pay result: <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br> <br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//è°ƒç”¨Nativeçš„æ–¹æ³•   js-&gt;native</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span>.<span class="hljs-property">messageHandlers</span>.<span class="hljs-property">pay</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&#x27;ï¿¥100&#x27;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    <span class="hljs-comment">//jsæ–¹æ³•ï¼Œä¾›nativeè°ƒ    native-&gt;js</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">payResult</span>(<span class="hljs-params">result</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;result&quot;</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&#x27;pay result: &#x27;</span> + result;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>ç¬¬10è¡Œï¼Œjsé€šè¿‡<code>window.webkit.messageHandlers</code>è·å–å¤„ç†äº¤äº’çš„åª’ä»‹ï¼š<code>messageHandlers</code>ã€‚ä»å…¶é‡‡ç”¨å¤æ•°å½¢å¼å¯çŸ¥ï¼ŒNativeåœ¨ä¸jsäº¤äº’æ—¶å¯èƒ½ä¼šæ³¨å†Œå¤šä¸ª<code>messageHandler</code>ï¼›</p><p><code>.pay</code>æ˜¯æŒ‡å®šå…·ä½“çš„<code>messageHandler</code>ï¼š</p><p><code>postMessage(&#39;ï¿¥100&#39;)</code>æ˜¯å‘<code>handler</code>å‘é€æ¶ˆæ¯å’Œä¼ é€’å‚æ•°ï¼›</p><p>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p><p>å†æ¥çœ‹Nativeç«¯çš„ä»£ç ï¼Œå¾€webä¸­æ³¨å…¥å¤šä¸ª<code>MessageHandler</code>å¯¹è±¡æ¥å¤„ç†ä¸åŒä»»åŠ¡ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;WebKit/WebKit.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DKWKScriptMessageHandler.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">DKWKWebViewController</span> ()&lt;<span class="hljs-title">WKNavigationDelegate</span>,<span class="hljs-title">WKUIDelegate</span>&gt;</span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">weak</span>, <span class="hljs-keyword">nonatomic</span>) <span class="hljs-keyword">IBOutlet</span> <span class="hljs-built_in">WKWebView</span> *mWKWebview;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) DKWKScriptMessageHandler *mScriptMessHandler;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DKWKWebViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    _mWKWebview.navigationDelegate = <span class="hljs-keyword">self</span>;<br>    _mWKWebview.UIDelegate = <span class="hljs-keyword">self</span>;<br>    <br>    <span class="hljs-comment">//å‘webviewæ³¨å…¥MessHandlerï¼ˆå¯ä»¥æ³¨å†Œå¤šä¸ªMessHandlerï¼‰</span><br>    _mScriptMessHandler = [DKWKScriptMessageHandler new];<br>    [_mWKWebview.configuration.userContentController addScriptMessageHandler:_mScriptMessHandler name:<span class="hljs-built_in">WK_MethodName</span>];<br>    <span class="hljs-comment">//åŠ è½½æœ¬åœ°ç½‘é¡µ</span><br>    <span class="hljs-built_in">NSString</span> *path = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string">@&quot;jsbridge_pay&quot;</span> ofType:<span class="hljs-string">@&quot;html&quot;</span>];<br>    <span class="hljs-built_in">NSURLRequest</span> *request = [<span class="hljs-built_in">NSURLRequest</span> requestWithURL:<br>                             [<span class="hljs-built_in">NSURL</span> fileURLWithPath:path]];<br>    [_mWKWebview loadRequest:request];<br>&#125;<br><br>-(<span class="hljs-type">void</span>)viewDidDisappear:(<span class="hljs-type">BOOL</span>)animated&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidDisappear:animated];<br>    [<span class="hljs-keyword">self</span> removeMessageHandler];<br>&#125;<br><br>-(<span class="hljs-type">void</span>)dealloc&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++DKWKWebViewController dealloced~&quot;</span>);<br>    [_mWKWebview.configuration.userContentController removeScriptMessageHandlerForName:<span class="hljs-built_in">WK_MethodName</span>];<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark BUSINESS</span><br>- (<span class="hljs-type">void</span>)removeMessageHandler &#123;<br>    <span class="hljs-comment">//ç¦»å¼€æ—¶è°ƒç”¨ å¦åˆ™ä¼šé€ æˆå†…å­˜æ³„æ¼</span><br>    _mScriptMessHandler = <span class="hljs-literal">nil</span>;<br>    [_mWKWebview.configuration.userContentController removeScriptMessageHandlerForName:<span class="hljs-built_in">WK_MethodName</span>];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ­¤æ—¶ç‚¹å‡»ç½‘é¡µä¸Šçš„<code>pay</code>æŒ‰é’®ï¼Œå³ä¼šè§¦å‘jsæ–¹æ³•<code>pay()</code>å¹¶è°ƒç”¨å…¶ä¸­çš„<code>window.webkit.messageHandlers.pay.postMessage(&#39;ï¿¥100&#39;);</code>ï¼Œæ¥ç€<code>DKWKScriptMessageHandler</code>çš„ä»£ç†å‡½æ•°è¢«è§¦å‘ï¼Œé€šè¿‡åŒºåˆ†ä¸åŒ<code>handler</code>çš„åå­—æ¥è°ƒç”¨ä¸åŒçš„Nativeå‡½æ•°å¤„ç†æœ¬åœ°ä¸šåŠ¡é€»è¾‘ã€‚</p><h4 id="3-Native-gt-js-1"><a href="#3-Native-gt-js-1" class="headerlink" title="3.Native-&gt;js"></a>3.Native-&gt;js</h4><p>WKä¸­Nativeè°ƒjså¾ˆç®€å•ï¼Œä¸UIWebviewç±»ä¼¼ï¼Œåªä¸è¿‡å¤šäº†å›è°ƒblockï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DKWKWebViewController</span></span><br>...<br><br>- (<span class="hljs-type">void</span>)nativeCallJs&#123;<br>    <span class="hljs-comment">//nativeè°ƒç”¨jsä¸­å®šä¹‰çš„å‡½æ•°</span><br>    <span class="hljs-built_in">NSString</span> *jsFuncScript = <span class="hljs-string">@&quot;payResult(&#x27;Succeed&#x27;)&quot;</span>;<br>    [_mWKWebview evaluateJavaScript:jsFuncScript completionHandler:^(<span class="hljs-type">id</span> _Nullable data, <span class="hljs-built_in">NSError</span> * _Nullable error) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++WKWebviewæ‰§è¡Œjsï¼š%@&quot;</span>,jsFuncScript);<br>    &#125;];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h3 id="å››-ç»“å°¾"><a href="#å››-ç»“å°¾" class="headerlink" title="å››.ç»“å°¾"></a>å››.ç»“å°¾</h3><p>ä»¥ä¸Šä¸‰è€…æ˜¯ç›´æ¥åˆ©ç”¨ç³»ç»Ÿæä¾›çš„APIæ¥å®ç°jsä¸Nativeçš„äº¤äº’ï¼Œæ¯ç§æ–¹æ³•éƒ½æœ‰è‡ªå·±çš„å±€é™ï¼š</p><p>æ‹¦æˆªURLçš„åšæ³•æœ€ç¬¨ï¼Œåªé€‚åˆå°‘é‡<code>a</code>æ ‡ç­¾æˆ–é‡å®šå‘è·³è½¬åœºæ™¯ï¼›</p><p>JavaScriptCoreåªé€‚ç”¨äºUIWebViewï¼Œè€ŒWKScriptMessageHandleråˆåªé€‚ç”¨äºWKWebViewï¼›</p><p>æ‰€ä»¥çœ‹èµ·æ¥æ€¥éœ€ä¸€ç§æ•´åˆæ–¹æ¡ˆï¼ŒGithubä¸Šæœ‰ç±»ä¼¼ WebViewJavascriptBridge è¿™ç§å¼€æºåº“ï¼Œå¾…æˆ‘åç»­ç ”ç©¶ç ”ç©¶~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://davidlii.cn/">Â©</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œçŸ¥è¯†ç‚¹ç¬”è®°</title>
    <link href="/2017/11/22/http.html"/>
    <url>/2017/11/22/http.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-ç½‘ç»œåˆ†å±‚"><a href="#1-ç½‘ç»œåˆ†å±‚" class="headerlink" title="#1.ç½‘ç»œåˆ†å±‚"></a>#1.ç½‘ç»œåˆ†å±‚</h3><ul><li>åº”ç”¨å±‚</li><li>è¡¨ç¤ºå±‚</li><li>ä¼šè¯å±‚</li><li>ä¼ è¾“å±‚</li><li>ç½‘ç»œå±‚</li><li>æ•°æ®é“¾è·¯å±‚</li><li>ç‰©ç†å±‚</li></ul><h3 id="2-æœ¯è¯­"><a href="#2-æœ¯è¯­" class="headerlink" title="#2.æœ¯è¯­"></a>#2.æœ¯è¯­</h3><h4 id="2-1-TCP"><a href="#2-1-TCP" class="headerlink" title="2.1.TCP"></a>2.1.TCP</h4><ul><li>ä¼ è¾“æ§åˆ¶åè®®ï¼šä¼ è¾“å±‚åè®®ä¹‹ä¸€ï¼›</li><li>é¢å‘è¿æ¥ï¼šä¼ è¾“æ•°æ®å‰éœ€è¦ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼›</li><li>ç¨³å®šå¯é ï¼šä¼ è¾“æ•°æ®æ—¶æœ‰å“åº”ã€é‡å‘ã€æ‹¥å µæ§åˆ¶æœºåˆ¶ï¼›</li><li>æ—¶æ•ˆæ€§ä½ï¼šæ¡æ‰‹ã€å“åº”ã€é‡å‘ç­‰æœºåˆ¶ä¼šæ¶ˆè€—å¤§é‡æ—¶é—´ï¼Œå ç”¨å¤§é‡ç³»ç»Ÿèµ„æºã€‚</li></ul><p>ä¸»è¦ç”¨åœ¨éœ€è¦å¯é ä¼ è¾“æ•°æ®çš„åœ°æ–¹ï¼Œå¦‚æ–‡ä»¶ä¼ è¾“åè®®ï¼šHTTPã€HTTPSã€FTPï¼›é‚®ä»¶ä¼ è¾“åè®®ï¼šPOPã€SMTPã€‚</p><h4 id="2-2-UDP"><a href="#2-2-UDP" class="headerlink" title="2.2.UDP"></a>2.2.UDP</h4><ul><li>ç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼šä¹Ÿæ˜¯ä¼ è¾“å±‚åè®®ä¹‹ä¸€ï¼›</li><li>æ— è¿æ¥ï¼šä¼ è¾“æ•°æ®å‰ä¸éœ€äº‹å…ˆå»ºç«‹è¿æ¥ï¼Œç›´æ¥å‘ç›®æ ‡ä¸»æœºå‘é€æŠ¥æ–‡ï¼›</li><li>ä¸å¯é ï¼šä¸ä¿è¯æ•°æ®èƒ½æ”¶åˆ°æˆ–å®Œæ•´æ”¶åˆ°ï¼ŒåªåšæŠ¥æ–‡å®Œæ•´æ€§æ ¡éªŒï¼Œä¸å®Œæ•´åˆ™ä¸¢å¼ƒï¼›</li><li>é€Ÿåº¦å¿«ï¼šæ²¡æœ‰TCPé‚£ä¹ˆå¤æ‚çš„æœºåˆ¶ï¼Œç®€å•é«˜æ•ˆé€Ÿåº¦å¿«ï¼›</li></ul><p>ä¸»è¦ç”¨åœ¨è¿½æ±‚é€šä¿¡é€Ÿåº¦ä½†å¯¹é€šä¿¡è´¨é‡è¦æ±‚ä¸é«˜çš„åœ°æ–¹ï¼Œå¦‚è¯­éŸ³è§†é¢‘ã€æ¸¸æˆç”»é¢å’Œè¯­éŸ³ã€‚</p><h4 id="2-3-HTTP"><a href="#2-3-HTTP" class="headerlink" title="2.3.HTTP"></a>2.3.HTTP</h4><p>è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œå±äºåº”ç”¨å±‚åè®®ï¼ŒåŸºäº<code>TCP</code>åè®®å’Œ<code>è¯·æ±‚/å“åº”</code>æ¨¡å‹ï¼Œç”¨äºåœ¨webæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯æµè§ˆå™¨ä¹‹é—´ä¼ è¾“ä¿¡æ¯ã€‚å®¢æˆ·ç«¯å‘é€è¯·æ±‚åéœ€è¦æœåŠ¡å™¨å“åº”ï¼Œè¯·æ±‚ç»“æŸåä¼šä¸»åŠ¨é‡Šæ”¾è¿æ¥ï¼Œå› æ­¤å®ƒå±äºçŸ­è¿æ¥ã€‚</p><h4 id="2-4-SOCKET"><a href="#2-4-SOCKET" class="headerlink" title="2.4.SOCKET"></a>2.4.SOCKET</h4><p>æ˜¯ä½äº<code>åº”ç”¨å±‚</code>å’Œ<code>TCP/IPåè®®</code>æ—ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´æŠ½è±¡å±‚ï¼Œå®ƒæœ¬èº«å¹¶ä¸æ˜¯åè®®ï¼Œè€Œæ˜¯å¯¹TCP&#x2F;IPåè®®çš„å°è£…ï¼Œå¹¶å¯¹å¤–æä¾›ä¸€å¥—æ¥å£ä»¥ä¾¿å¼€å‘è€…ä½¿ç”¨TCP&#x2F;IPåè®®ã€‚</p><blockquote><p>åº”ç”¨å±‚é€šè¿‡ä¼ è¾“å±‚è¿›è¡Œæ•°æ®é€šä¿¡æ—¶ï¼ŒTCPä¼šé‡åˆ°åŒæ—¶ä¸ºå¤šä¸ªåº”ç”¨ç¨‹åºæä¾›å¹¶å‘æœåŠ¡çš„é—®é¢˜ï¼Œå¤šä¸ªTCPè¿æ¥å¤šä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹å¯èƒ½éœ€è¦é€šè¿‡åŒä¸€ä¸ªTCPåè®®ç«¯å£ä¼ è¾“æ•°æ®ï¼Œä¸ºäº†åŒºåˆ«ä¸åŒçš„åº”ç”¨ç¨‹åºè¿›ç¨‹å’Œè¿æ¥ï¼Œè®¸å¤šè®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸ºåº”ç”¨ç¨‹åºä¸TCP&#x2F;IPåè®®äº¤äº’æä¾›äº†å¥—æ¥å­—ï¼ˆsocketï¼‰æ¥å£ï¼Œåº”ç”¨å±‚å¯ä»¥å’Œä¼ è¾“å±‚é€šè¿‡socketæ¥å£åŒºåˆ†æ¥è‡ªäºä¸åŒåº”ç”¨è¿›ç¨‹æˆ–ç½‘ç»œè¿æ¥çš„é€šä¿¡ï¼Œå®ç°æ•°æ®ä¼ è¾“çš„å¹¶å‘æœåŠ¡ã€‚</p></blockquote><p>SOCKET é€šä¿¡éœ€è¦ä¸¤ä¸ªç«¯ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ã€‚</p><ul><li>æœåŠ¡ç«¯ï¼šç›‘å¬ç½‘ç»œçŠ¶æ€ï¼Œç­‰å¾…æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼›</li><li>å®¢æˆ·ç«¯ï¼šæŒ‡å®š ip ä¸ç«¯å£ï¼Œå‘æœåŠ¡å™¨è¯·æ±‚è¿æ¥ï¼›</li><li>æœåŠ¡å™¨ï¼šå“åº”å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå»ºç«‹ä¸€ä¸ªæ–°çº¿ç¨‹ï¼ŒæŠŠæœåŠ¡ç«¯å¥—æ¥å­—çš„æè¿°å‘ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ç¡®è®¤æ­¤æè¿°ååŒæ–¹æ­£å¼å»ºç«‹è¿æ¥ã€‚</li></ul><p>ç†è®ºä¸Š SOCKET æ˜¯ä¸€ç§é•¿è¿æ¥ï¼Œå³å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥å»ºç«‹ä¹‹åï¼Œä¸€èˆ¬ä¸ä¼šä¸»åŠ¨æ–­æ‰ã€‚å¦‚æœé•¿æ—¶é—´æ²¡æœ‰é€šä¿¡åˆ™é˜²ç«å¢™å¯èƒ½ä¼šæ–­å¼€æ­¤è¿æ¥ä»¥é‡Šæ”¾èµ„æºï¼Œæ‰€ä»¥ä¸€èˆ¬ SOCKET åœ¨æ²¡æœ‰æ•°æ®ä¼ è¾“æ—¶éœ€è¦å‘é€å¿ƒè·³åŒ…ä»¥ä¿æŒè¿æ¥ã€‚</p><h4 id="2-5-IPåè®®"><a href="#2-5-IPåè®®" class="headerlink" title="2.5.IPåè®®"></a>2.5.IPåè®®</h4><p>ç½‘ç»œå±‚åè®®ï¼Œè§£å†³ç½‘ç»œè·¯ç”±å’Œå¯»å€é—®é¢˜ã€‚</p><h4 id="2-6-TCP-x2F-IP"><a href="#2-6-TCP-x2F-IP" class="headerlink" title="2.6.TCP&#x2F;IP"></a>2.6.TCP&#x2F;IP</h4><p>ä¼ è¾“æ§åˆ¶åè®®&#x2F;ç½‘é™…åè®®ï¼ŒæŒ‡çš„æ˜¯ä¸€ç³»åˆ—åè®®ã€‚</p><h3 id="3-ä¸‰æ¬¡æ¡æ‰‹"><a href="#3-ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="#3.ä¸‰æ¬¡æ¡æ‰‹"></a>#3.ä¸‰æ¬¡æ¡æ‰‹</h3><p>TCPè¯·æ±‚åœ¨å‘é€æ•°æ®ä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ï¼Œä»¥æ­£å¼å»ºç«‹è¿æ¥ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_tcp_connect.jpeg" alt="æ¡æ‰‹"></p><p><strong>ç¬¬1æ¬¡</strong>ï¼š<code>ä¸»æœºA</code> å‘é€<code>SYNåŒ…</code>åˆ° <code>ä¸»æœºB</code>ï¼Œå¹¶è¿›å…¥<code>SYN_SEND</code>çŠ¶æ€ï¼Œç­‰å¾… <code>ä¸»æœºB</code> ç¡®è®¤ï¼›<br><br/></p><p><strong>ç¬¬2æ¬¡</strong>ï¼š<code>ä¸»æœºB</code> æ”¶åˆ°<code>SYNåŒ…</code>ï¼Œå¿…é¡»ç¡®è®¤ <code>ä¸»æœºA</code> çš„<code>SYN</code>ï¼ŒåŒæ—¶è‡ªå·±ä¹Ÿå‘é€ä¸€ä¸ª<code>SYNåŒ…</code>ï¼Œå³<code>SYN+ACKåŒ…</code>ï¼Œæ­¤æ—¶ <code>ä¸»æœºB</code> è¿›å…¥<code>SYN_RECVçŠ¶æ€</code>ï¼›<br><br/></p><p><strong>ç¬¬3æ¬¡</strong>ï¼š<code>ä¸»æœºA</code> æ”¶åˆ° <code>ä¸»æœºB</code> çš„<code>SYNï¼‹ACK</code>åŒ…ï¼Œå‘ <code>ä¸»æœºB</code> å‘é€ç¡®è®¤åŒ…<code>ACK</code>ï¼›<br><br/></p><p>ç¬¬ä¸‰ä¸ªåŒ…å‘é€å®Œæ¯•å <code>ä¸»æœºA</code> å’Œ <code>ä¸»æœºB</code> è¿›å…¥<code>ESTABLISHED</code>çŠ¶æ€ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ã€‚</p><h3 id="4-å››æ¬¡æŒ¥æ‰‹"><a href="#4-å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="#4.å››æ¬¡æŒ¥æ‰‹"></a>#4.å››æ¬¡æŒ¥æ‰‹</h3><p>TCPè¿æ¥åœ¨æ–­å¼€æ—¶éœ€è¦å››ä¸ªæ­¥éª¤ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_tcp_disconnect.jpeg" alt="æŒ¥æ‰‹"></p><p><strong>ç¬¬1æ¬¡</strong>ï¼š<code>ä¸»æœºA</code> ç¡®è®¤å‘é€å®Œæ•°æ®ä¸”çŸ¥é“ <code>ä¸»æœºB</code> å·²ç»æ¥å—å®Œäº†ï¼Œæƒ³è¦å…³é—­å‘é€æ•°æ®å£ï¼Œå°±ä¼šå‘ <code>FIN</code> ç»™ <code>ä¸»æœºB</code>ï¼›<br><br/></p><p><strong>ç¬¬2æ¬¡</strong>ï¼š<code>ä¸»æœºB</code> æ”¶åˆ° <code>ä¸»æœºA</code> å‘é€çš„<code>FIN</code>ï¼Œè¡¨ç¤ºæ”¶åˆ°äº†ï¼Œå°±ä¼šå‘é€ <code>ACK</code> å›å¤ï¼›<br><br/></p><p><strong>ç¬¬3æ¬¡</strong>ï¼šä½†è¿™æ—¶ <code>ä¸»æœºB</code> å¯èƒ½è¿˜åœ¨å‘é€æ•°æ®ï¼Œä¸æƒ³å…³é—­æ•°æ®å£ï¼Œæ‰€ä»¥åœ¨å‘å®Œ<code>ACK</code>åç»§ç»­æŠŠæ•°æ®å‘é€å®Œäº†å†å‘é€<code>FIN</code>ç»™ <code>ä¸»æœºA</code>ã€‚<br><br/></p><p><strong>ç¬¬4æ¬¡</strong>ï¼š<code>ä¸»æœºA</code> æ”¶åˆ° <code>ä¸»æœºB</code> å‘æ¥çš„<code>FIN</code>ï¼ŒçŸ¥é“ <code>ä¸»æœºB</code> çš„æ•°æ®ä¹Ÿå‘é€å®Œäº†ï¼Œå›å¤ACKã€‚<code>ä¸»æœºA</code> ç­‰å¾… 2MSLï¼ˆ2å€æŠ¥æ–‡æœ€é•¿å­˜æ´»æ—¶é—´ï¼‰åæ²¡æœ‰æ”¶åˆ° <code>ä¸»æœºB</code> ä¼ æ¥çš„ä»»ä½•æ¶ˆæ¯ï¼ŒçŸ¥é“ <code>ä¸»æœºB</code> å·²ç»æ”¶åˆ°è‡ªå·±çš„ACKäº†ï¼Œ<code>ä¸»æœºA</code> å°±å…³é—­è¿æ¥ï¼Œ<code>ä¸»æœºB</code> ä¹Ÿå…³é—­è¿æ¥äº†ã€‚<br><br/></p><p><strong>Aä¸ºä»€ä¹ˆç­‰å¾…2MSL?</strong><br><br/></p><p>åœ¨<code>A</code>å‘é€å‡ºæœ€åçš„ ACK å›å¤åï¼Œè¯¥ ACK å¯èƒ½ä¸¢å¤±ã€‚<code>B</code>å¦‚æœæ²¡æœ‰æ”¶åˆ° ACKï¼Œå°†ä¸æ–­é‡å‘ FINã€‚æ‰€ä»¥<code>A</code>ä¸èƒ½ç«‹å³å…³é—­ï¼Œå¿…é¡»ç¡®è®¤<code>B</code>æ”¶åˆ°äº†è¯¥ ACKã€‚<code>A</code>ä¼šåœ¨å‘é€å‡º ACK åè¿›å…¥<code>TIME_WAIT</code>çŠ¶æ€å¹¶è®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œç­‰å¾… 2MSL çš„æ—¶é—´ã€‚å¦‚æœåœ¨è¯¥æ—¶é—´å†…å†æ¬¡æ”¶åˆ° FINï¼Œé‚£ä¹ˆ<code>A</code>ä¼šé‡å‘ ACK å¹¶å†æ¬¡ç­‰å¾… 2MSLã€‚å¦‚æœç›´åˆ° 2MSL<code>A</code>éƒ½æ²¡æœ‰å†æ¬¡æ”¶åˆ° FINï¼Œé‚£ä¹ˆ<code>A</code>æ¨æ–­ B å·²ç»æˆåŠŸæ¥æ”¶è‡ªå·±çš„ ACKï¼Œåˆ™ç»“æŸ TCP è¿æ¥ã€‚</p><h3 id="5-æ— çŠ¶æ€"><a href="#5-æ— çŠ¶æ€" class="headerlink" title="#5.æ— çŠ¶æ€"></a>#5.æ— çŠ¶æ€</h3><p>HTTPåè®®æ˜¯æ— çŠ¶æ€çš„ï¼ŒæŒ‡çš„æ˜¯åè®®å¯¹äºäº‹åŠ¡å¤„ç†æ²¡æœ‰è®°å¿†èƒ½åŠ›ï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“å®¢æˆ·ç«¯æ˜¯ä»€ä¹ˆçŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰“å¼€ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µå’Œä½ ä¹‹å‰æ‰“å¼€è¿™ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µä¹‹é—´æ²¡æœ‰ä»»ä½•è”ç³»ã€‚</p><h3 id="6-çŸ­-x2F-é•¿è¿æ¥"><a href="#6-çŸ­-x2F-é•¿è¿æ¥" class="headerlink" title="#6.çŸ­&#x2F;é•¿è¿æ¥"></a>#6.çŸ­&#x2F;é•¿è¿æ¥</h3><p>Http æ˜¯åº”ç”¨å±‚åè®®ï¼ŒåŸºäº TCP è¿™ä¸€ä¼ è¾“å±‚åè®®ã€‚TCP è¿æ¥åœ¨ IPå±‚ä¸Šå®‰å…¨ã€é¢å‘è¿æ¥åœ°ä¼ é€’æ•°æ®åŒ…ã€‚åœ¨HTTP&#x2F;1.0ä¸­ï¼ŒHttp é»˜è®¤ä½¿ç”¨çš„æ˜¯çŸ­è¿æ¥ã€‚æµè§ˆå™¨å’ŒæœåŠ¡å™¨æ¯è¿›è¡Œä¸€æ¬¡HTTPæ“ä½œï¼Œå°±å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œä»»åŠ¡ç»“æŸå°±ä¸­æ–­è¿æ¥ã€‚å¦‚æœå®¢æˆ·ç«¯æµè§ˆå™¨è®¿é—®çš„æŸä¸ªHTMLé¡µé¢ä¸­åŒ…å«æœ‰å…¶ä»–çš„Webèµ„æºï¼Œå¦‚Jsã€å›¾åƒã€CSSæ–‡ä»¶ç­‰ï¼Œé‚£ä¹ˆæµè§ˆå™¨æ¯é‡åˆ°ä¸€ä¸ªWebèµ„æºå°±ä¼šå»ºç«‹ä¸€æ¬¡ä¼šè¯ã€‚ä» HTTP&#x2F;1.1 èµ·ï¼Œæµè§ˆå™¨å¼€å§‹é»˜è®¤ä½¿ç”¨é•¿è¿æ¥ï¼Œç”¨ä»¥ä¿æŒè¿æ¥ç‰¹æ€§ã€‚ä½¿ç”¨é•¿è¿æ¥çš„HTTPåè®®ï¼Œä¼šåœ¨å“åº”å¤´æœ‰åŠ å…¥è¿™è¡Œä»£ç ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">Connection:</span><span class="hljs-meta">keep</span>-alive<br></code></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨é•¿è¿æ¥çš„æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç½‘é¡µæ‰“å¼€å®Œæˆåï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ TCP è¿æ¥ä¸ä¼šå…³é—­ï¼Œå¦‚æœå®¢æˆ·ç«¯å†æ¬¡è®¿é—®è¿™ä¸ªæœåŠ¡å™¨ä¸Šçš„ç½‘é¡µï¼Œä¼šç»§ç»­ä½¿ç”¨å·²ç»å»ºç«‹çš„è¿æ¥ã€‚Keep-Alive ä¸ä¼šæ°¸ä¹…ä¿æŒè¿æ¥ï¼Œå®ƒæœ‰ä¸€ä¸ªä¿æŒæ—¶é—´ï¼Œå¯ä»¥åœ¨ä¸åŒçš„æœåŠ¡å™¨è½¯ä»¶ï¼ˆå¦‚Apacheï¼‰ä¸­è®¾å®šè¿™ä¸ªæ—¶é—´ã€‚å®ç°é•¿è¿æ¥è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æ”¯æŒé•¿è¿æ¥ï¼Œç°åœ¨å„ä¸ªæµè§ˆå™¨çš„é«˜ç‰ˆæœ¬åŸºæœ¬éƒ½æ˜¯æ”¯æŒé•¿è¿æ¥ã€‚</p><h4 id="ä¼˜ç‚¹å’Œç¼ºç‚¹"><a href="#ä¼˜ç‚¹å’Œç¼ºç‚¹" class="headerlink" title="ä¼˜ç‚¹å’Œç¼ºç‚¹"></a>ä¼˜ç‚¹å’Œç¼ºç‚¹</h4><p>çŸ­è¿æ¥ï¼šå¯¹äºæœåŠ¡å™¨æ¥è¯´ç®¡ç†è¾ƒä¸ºç®€å•ï¼Œå­˜åœ¨çš„è¿æ¥éƒ½æ˜¯æœ‰ç”¨çš„è¿æ¥ï¼Œä¸éœ€è¦é¢å¤–çš„æ§åˆ¶æ‰‹æ®µã€‚ä½†å¦‚æœå®¢æˆ·è¯·æ±‚é¢‘ç¹ï¼Œå°†åœ¨TCPçš„å»ºç«‹å’Œå…³é—­æ“ä½œä¸Šæµªè´¹æ—¶é—´å’Œå¸¦å®½ã€‚<br><br/></p><p>é•¿è¿æ¥ï¼šå¯ä»¥çœå»è¾ƒå¤šçš„TCPå»ºç«‹å’Œå…³é—­çš„æ“ä½œï¼Œå‡å°‘æµªè´¹ï¼ŒèŠ‚çº¦æ—¶é—´ã€‚å¯¹äºé¢‘ç¹è¯·æ±‚èµ„æºçš„å®¢æˆ·æ¥è¯´ï¼Œè¾ƒé€‚ç”¨é•¿è¿æ¥ã€‚ä½†è¿æ¥ä¸€ç›´ä¸å…³é—­çš„è¯ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œéšç€å®¢æˆ·ç«¯è¿æ¥è¶Šæ¥è¶Šå¤šï¼ŒæœåŠ¡ç«¯å¯èƒ½ä¼šæ‰›ä¸ä½ã€‚</p><h4 id="æ•°æ®å‘é€å®Œæˆï¼Ÿ"><a href="#æ•°æ®å‘é€å®Œæˆï¼Ÿ" class="headerlink" title="æ•°æ®å‘é€å®Œæˆï¼Ÿ"></a>æ•°æ®å‘é€å®Œæˆï¼Ÿ</h4><p>çŸ­è¿æ¥æ¨¡å¼ä¸‹ï¼ŒæœåŠ¡å™¨é€šå¸¸åœ¨å‘é€å›æ‰€è¯·æ±‚çš„æ•°æ®ä¹‹åå°±å…³é—­è¿æ¥ã€‚è¿™æ ·å®¢æˆ·ç«¯è¯»æ•°æ®æ—¶ä¼šè¿”å›<code>EOF(-1)</code>ï¼Œå°±çŸ¥é“æ•°æ®å·²ç»æ¥æ”¶å®Œå…¨äº†ã€‚ä½†æ˜¯é•¿è¿æ¥æ¨¡å¼å‘é€å®Œæ•°æ®åæœåŠ¡å™¨ä¸ä¼šè‡ªåŠ¨æ–­å¼€è¿æ¥ï¼Œæ‰€ä»¥ä¸èƒ½å†ä½¿ç”¨è¿”å›<code>EOF(-1)</code>æ¥åˆ¤æ–­ã€‚</p><ul><li><strong>Conent-Length</strong></li></ul><p>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥å¾ˆæ¸…æ¥šçš„çŸ¥é“å†…å®¹å¤§å°ï¼Œå®ƒé€šè¿‡æ¶ˆæ¯é¦–éƒ¨ä¸­çš„<code>Content-length</code>å­—æ®µå‘Šè¯‰å®¢æˆ·ç«¯æ€»å…±éœ€è¦æ¥æ”¶å¤šå°‘æ•°æ®ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®è¿™ä¸ªå€¼å’Œå·²æ¥æ”¶çš„å€¼æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦æ¥æ”¶å®Œæˆã€‚</p><ul><li><strong>Transfer-Encoding</strong></li></ul><p>å¦‚æœæ˜¯åŠ¨æ€é¡µé¢ï¼Œæ¯”å¦‚ä¸€è¾¹äº§ç”Ÿæ•°æ®ï¼Œä¸€è¾¹å‘ç»™å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±éœ€è¦ä½¿ç”¨ â€Transfer-Encoding:chunkedâ€ çš„æ–¹å¼æ¥ä»£æ›¿ Content-Lengthã€‚<br><br/></p><p>chunkç¼–ç å°†æ•°æ®åˆ†æˆä¸€å—ä¸€å—çš„å‘é€ã€‚Chunkedç¼–ç å°†ä½¿ç”¨è‹¥å¹²ä¸ªChunkä¸²è¿è€Œæˆï¼Œç”±ä¸€ä¸ªæ ‡æ˜é•¿åº¦ä¸º0çš„chunkæ ‡ç¤ºç»“æŸã€‚æ¯ä¸ªChunkåˆ†ä¸ºå¤´éƒ¨å’Œæ­£æ–‡ä¸¤éƒ¨åˆ†ï¼Œå¤´éƒ¨å†…å®¹æŒ‡å®šæ­£æ–‡çš„å­—ç¬¦æ€»æ•°ï¼ˆåå…­è¿›åˆ¶çš„æ•°å­—ï¼‰å’Œæ•°é‡å•ä½ï¼ˆä¸€èˆ¬ä¸å†™ï¼‰ï¼Œæ­£æ–‡éƒ¨åˆ†å°±æ˜¯æŒ‡å®šé•¿åº¦çš„å®é™…å†…å®¹ï¼Œä¸¤éƒ¨åˆ†ä¹‹é—´ç”¨å›è½¦æ¢è¡Œ(CRLF)éš”å¼€ã€‚åœ¨æœ€åä¸€ä¸ªé•¿åº¦ä¸º0çš„Chunkä¸­çš„å†…å®¹æ˜¯ç§°ä¸ºfooterçš„å†…å®¹ï¼Œæ˜¯ä¸€äº›é™„åŠ çš„Headerä¿¡æ¯ï¼ˆé€šå¸¸å¯ä»¥ç›´æ¥å¿½ç•¥ï¼‰ã€‚<br><br/></p><p>Chunkç¼–ç çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Chunked-Body = *chunk<br><span class="hljs-string">&quot;0&quot;</span> <span class="hljs-literal">CRLF</span><br>footer<br><span class="hljs-literal">CRLF</span><br>chunk = chunk-size [ chunk-ext ] <span class="hljs-literal">CRLF</span><br>chunk-data <span class="hljs-literal">CRLF</span><br><br>hex-no-<span class="hljs-literal">zero</span> = &lt;HEX excluding <span class="hljs-string">&quot;0&quot;</span>&gt;<br><br>chunk-size = hex-no-<span class="hljs-literal">zero</span> *HEX<br>chunk-ext = *( <span class="hljs-string">&quot;;&quot;</span> chunk-ext-name [ <span class="hljs-string">&quot;=&quot;</span> chunk-ext-<span class="hljs-built_in">value</span> ] )<br>chunk-ext-name = <span class="hljs-keyword">token</span><br>chunk-ext-val = <span class="hljs-keyword">token</span> | quoted-<span class="hljs-keyword">string</span><br>chunk-data = chunk-size(OCTET)<br><br>footer = *entity-header<br></code></pre></td></tr></table></figure><ul><li><strong>æ¶ˆæ¯é•¿åº¦çš„æ€»ç»“</strong></li></ul><ol><li>ä¸ºäº†å…¼å®¹HTTP&#x2F;1.0åº”ç”¨ç¨‹åºï¼ŒHTTP&#x2F;1.1çš„è¯·æ±‚æ¶ˆæ¯ä½“ä¸­å¿…é¡»åŒ…å«ä¸€ä¸ªåˆæ³•çš„Content-Lengthå¤´å­—æ®µï¼Œé™¤éçŸ¥é“æœåŠ¡å™¨å…¼å®¹HTTP&#x2F;1.1ã€‚</li><li>åœ¨åŒ…å«æ¶ˆæ¯å†…å®¹çš„Headerä¸­ï¼Œå¦‚æœæœ‰content-lengthå­—æ®µï¼Œè¯¥å­—æ®µå¯¹åº”çš„å€¼å¿…é¡»å®Œå…¨å’Œæ¶ˆæ¯ä¸»ä½“é‡Œé¢çš„é•¿åº¦åŒ¹é…ã€‚</li><li>å¦‚æœåŒæ—¶æ”¶åˆ°äº† Transfer-Encoding å’Œ Content-Length å­—æ®µï¼Œå¿…é¡»å¿½ç•¥ Content-Length å­—æ®µã€‚</li><li>å¦‚æœé‡‡ç”¨çŸ­è¿æ¥ï¼Œåˆ™ç›´æ¥å¯ä»¥é€šè¿‡æœåŠ¡å™¨å…³é—­è¿æ¥æ¥ç¡®å®šæ¶ˆæ¯çš„ä¼ è¾“é•¿åº¦ã€‚</li></ol><h3 id="7-HTTPå¤´éƒ¨"><a href="#7-HTTPå¤´éƒ¨" class="headerlink" title="#7.HTTPå¤´éƒ¨"></a>#7.HTTPå¤´éƒ¨</h3><p>HTTPåè®®é‡‡ç”¨äº†<code>è¯·æ±‚/å“åº”æ¨¡å‹</code>ã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚å¤´åŒ…å«ï¼šè¯·æ±‚çš„æ–¹æ³•ã€URIã€åè®®ç‰ˆæœ¬ã€ä»¥åŠåŒ…å«è¯·æ±‚ä¿®é¥°ç¬¦ã€å®¢æˆ·ä¿¡æ¯å’Œå†…å®¹çš„ç±»ä¼¼äºMIMEçš„æ¶ˆæ¯ç»“æ„ã€‚æœåŠ¡å™¨ä»¥ä¸€ä¸ªçŠ¶æ€è¡Œä½œä¸ºå“åº”ï¼Œå“åº”çš„å†…å®¹åŒ…æ‹¬ï¼šæ¶ˆæ¯åè®®çš„ç‰ˆæœ¬ï¼ŒæˆåŠŸæˆ–è€…é”™è¯¯ç¼–ç åŠ ä¸ŠåŒ…å«æœåŠ¡å™¨ä¿¡æ¯ã€å®ä½“å…ƒä¿¡æ¯ä»¥åŠå¯èƒ½çš„å®ä½“å†…å®¹ã€‚<br><br/></p><p>é€šå¸¸HTTPæ¶ˆæ¯åŒ…æ‹¬å®¢æˆ·ç«¯å‘æœåŠ¡å™¨çš„è¯·æ±‚æ¶ˆæ¯å’ŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯çš„å“åº”æ¶ˆæ¯ã€‚è¿™ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯ç”±ä¸€ä¸ªèµ·å§‹è¡Œï¼Œä¸€ä¸ªæˆ–è€…å¤šä¸ªå¤´åŸŸï¼Œä¸€ä¸ªåªæ˜¯å¤´åŸŸç»“æŸçš„ç©ºè¡Œå’Œå¯é€‰çš„æ¶ˆæ¯ä½“ç»„æˆã€‚HTTPçš„å¤´åŸŸåŒ…æ‹¬é€šç”¨å¤´ï¼Œè¯·æ±‚å¤´ï¼Œå“åº”å¤´å’Œå®ä½“å¤´å››ä¸ªéƒ¨åˆ†ã€‚æ¯ä¸ªå¤´åŸŸç”±ä¸€ä¸ªåŸŸåï¼Œå†’å·ï¼ˆ:ï¼‰å’ŒåŸŸå€¼ä¸‰éƒ¨åˆ†ç»„æˆã€‚åŸŸåæ˜¯å¤§å°å†™æ— å…³çš„ï¼ŒåŸŸå€¼å‰å¯ä»¥æ·»åŠ ä»»ä½•æ•°é‡çš„ç©ºæ ¼ç¬¦ï¼Œå¤´åŸŸå¯ä»¥è¢«æ‰©å±•ä¸ºå¤šè¡Œï¼Œåœ¨æ¯è¡Œå¼€å§‹å¤„ï¼Œä½¿ç”¨è‡³å°‘ä¸€ä¸ªç©ºæ ¼æˆ–åˆ¶è¡¨ç¬¦ã€‚</p><h4 id="è¯·æ±‚æ¶ˆæ¯å¤´"><a href="#è¯·æ±‚æ¶ˆæ¯å¤´" class="headerlink" title="è¯·æ±‚æ¶ˆæ¯å¤´"></a>è¯·æ±‚æ¶ˆæ¯å¤´</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Host</span>ï¼šrss.sina.com.cn<br><span class="hljs-attribute">User</span>-Agentï¼šMozilla/<span class="hljs-number">5</span>ã€<span class="hljs-number">0</span> (Windows; U; Windows NT <span class="hljs-number">5</span>ã€<span class="hljs-number">1</span>; zh-CN; <br><span class="hljs-attribute">rv</span>:<span class="hljs-number">1</span>ã€<span class="hljs-number">8</span>ã€<span class="hljs-number">1</span>ã€<span class="hljs-number">14</span>) Gecko/<span class="hljs-number">20080404</span> Firefox/<span class="hljs-number">2</span>ã€<span class="hljs-number">0</span>ã€<span class="hljs-number">0</span>ã€<span class="hljs-number">14</span><br><span class="hljs-attribute">Accept</span>ï¼štext/xml,application/xml,application/xhtml+xml,text/html;<br><span class="hljs-attribute">q</span>=<span class="hljs-number">0</span>ã€<span class="hljs-number">9</span>,text/plain;q=<span class="hljs-number">0</span>ã€<span class="hljs-number">8</span>,image/png,*/*;q=<span class="hljs-number">0</span>ã€<span class="hljs-number">5</span><br><span class="hljs-attribute">Accept</span>-Languageï¼šzh-cn,zh;q=<span class="hljs-number">0</span>ã€<span class="hljs-number">5</span><br><span class="hljs-attribute">Accept</span>-Encodingï¼šgzip,deflate<br><span class="hljs-attribute">Accept</span>-Charsetï¼šgb2312,utf-<span class="hljs-number">8</span>;q=<span class="hljs-number">0</span>ã€<span class="hljs-number">7</span>,*;q=<span class="hljs-number">0</span>ã€<span class="hljs-number">7</span><br><span class="hljs-attribute">Keep</span>-Aliveï¼š<span class="hljs-number">300</span><br><span class="hljs-attribute">Connection</span>ï¼škeep-alive<br><span class="hljs-attribute">Cookie</span>ï¼šuserId=C5bYpXrimdmsiQmsBPnE1Vn8ZQmdWSm3WRlEB3vRwTnRtW &amp;lt;-- Cookie<br><span class="hljs-attribute">If</span>-Modified-Sinceï¼šSun, <span class="hljs-number">01</span> Jun <span class="hljs-number">2008</span> <span class="hljs-number">12</span>:<span class="hljs-number">05</span>:<span class="hljs-number">30</span> GMT<br><span class="hljs-attribute">Cache</span>-Controlï¼šmax-age=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h4 id="å“åº”æ¶ˆæ¯å¤´"><a href="#å“åº”æ¶ˆæ¯å¤´" class="headerlink" title="å“åº”æ¶ˆæ¯å¤´"></a>å“åº”æ¶ˆæ¯å¤´</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Statusï¼šOK - <span class="hljs-number">200</span> &amp;lt;<span class="hljs-comment">-- å“åº”çŠ¶æ€ç ï¼Œè¡¨ç¤º web æœåŠ¡å™¨å¤„ç†çš„ç»“æœã€‚</span><br><span class="hljs-type">Date</span>ï¼šSun, <span class="hljs-number">01</span> Jun <span class="hljs-number">2008</span> <span class="hljs-number">12</span>:<span class="hljs-number">35</span>:<span class="hljs-number">47</span> GMT<br><span class="hljs-keyword">Server</span>ï¼šApache/<span class="hljs-number">2</span>ã€<span class="hljs-number">0</span>ã€<span class="hljs-number">61</span> (Unix)<br>Last-Modifiedï¼šSun, <span class="hljs-number">01</span> Jun <span class="hljs-number">2008</span> <span class="hljs-number">12</span>:<span class="hljs-number">35</span>:<span class="hljs-number">30</span> GMT<br>Accept-Rangesï¼šbytes<br>Content-Lengthï¼š<span class="hljs-number">18616</span><br><span class="hljs-keyword">Cache</span>-Controlï¼šmax-age=<span class="hljs-number">120</span><br>Expiresï¼šSun, <span class="hljs-number">01</span> Jun <span class="hljs-number">2008</span> <span class="hljs-number">12</span>:<span class="hljs-number">37</span>:<span class="hljs-number">47</span> GMT<br>Content-<span class="hljs-keyword">Type</span>ï¼šapplication/<span class="hljs-type">xml</span><br>Ageï¼š<span class="hljs-number">2</span><br>X-<span class="hljs-keyword">Cache</span>ï¼šHIT from <span class="hljs-number">236</span><span class="hljs-number">-41</span>ã€D07071951ã€sinaã€comã€cn &amp;lt;<br><span class="hljs-comment">-- åå‘ä»£ç†æœåŠ¡å™¨ä½¿ç”¨çš„ HTTP å¤´éƒ¨</span><br>Viaï¼š<span class="hljs-number">1.0</span> <span class="hljs-number">236</span><span class="hljs-number">-41.</span>D07071951.sina.com.cn:<span class="hljs-number">80</span> (squid/<span class="hljs-number">2.6</span>.STABLE13)<br><span class="hljs-keyword">Connection</span>ï¼š<span class="hljs-keyword">close</span><br></code></pre></td></tr></table></figure><h4 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h4><p>ç”¨äºæŒ‡å®šè¯·æ±‚å’Œå“åº”çš„HTTPå†…å®¹çš„ç±»å‹ã€‚å¦‚æœæœªæŒ‡å®šé»˜è®¤ä¸ºtext&#x2F;htmlã€‚</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">ç±»å‹æ ¼å¼ï¼š<span class="hljs-keyword">type</span>/<span class="hljs-keyword">subtype</span>(;<span class="hljs-keyword">parameter</span>)? <span class="hljs-keyword">type</span><br><span class="hljs-keyword">type</span>ï¼Œä¸»ç±»å‹ï¼Œä»»æ„çš„å­—ç¬¦ä¸²ï¼Œå¦‚<span class="hljs-literal">text</span>ï¼Œ*ä»£è¡¨æ‰€æœ‰ï¼›<br><span class="hljs-keyword">subtype</span>ï¼Œå­ç±»å‹ï¼Œä»»æ„çš„å­—ç¬¦ä¸²ï¼Œå¦‚htmlï¼Œ*ä»£è¡¨æ‰€æœ‰ï¼›<br><span class="hljs-keyword">parameter</span>ï¼Œå¯é€‰ï¼Œä¸€äº›å‚æ•°ï¼Œå¦‚Acceptè¯·æ±‚å¤´çš„qå‚æ•°ï¼Œ Content-<span class="hljs-keyword">Type</span>çš„ charsetå‚æ•°ã€‚<br></code></pre></td></tr></table></figure><p>å¸¸è§çš„åª’ä½“æ ¼å¼ç±»å‹å¦‚ä¸‹ï¼š</p><ul><li>text&#x2F;html ï¼š HTMLæ ¼å¼</li><li>text&#x2F;plain ï¼šçº¯æ–‡æœ¬æ ¼å¼</li><li>text&#x2F;xml ï¼š  XMLæ ¼å¼</li><li>image&#x2F;gif ï¼šgifå›¾ç‰‡æ ¼å¼</li><li>image&#x2F;jpeg ï¼šjpgå›¾ç‰‡æ ¼å¼</li><li>image&#x2F;pngï¼špngå›¾ç‰‡æ ¼å¼</li></ul><p>ä»¥applicationå¼€å¤´çš„åª’ä½“æ ¼å¼ç±»å‹ï¼š</p><ul><li>application&#x2F;xhtml+xml ï¼šXHTMLæ ¼å¼</li><li>application&#x2F;xml     ï¼š XMLæ•°æ®æ ¼å¼</li><li>application&#x2F;atom+xml  ï¼šAtom XMLèšåˆæ ¼å¼</li><li>application&#x2F;json    ï¼š JSONæ•°æ®æ ¼å¼</li><li>application&#x2F;pdf       ï¼špdfæ ¼å¼</li><li>application&#x2F;msword  ï¼š Wordæ–‡æ¡£æ ¼å¼</li><li>application&#x2F;<font color=#0000FF><strong>x-www-form-urlencoded</strong></font> ï¼šè¡¨å•é»˜è®¤çš„æäº¤æ•°æ®çš„æ ¼å¼ï¼ˆè¡¨å•é”®å€¼å¯¹ï¼‰</li><li>application&#x2F;<font color=#0000FF><strong>octet-stream</strong></font> ï¼šä¸Šä¼ äºŒè¿›åˆ¶æ•°æ®ï¼ˆåªèƒ½æäº¤ä¸€ä¸ªæ–‡ä»¶ï¼‰</li><li><font color=#0000FF><strong>multipart&#x2F;form-data</strong></font> ï¼šæ—¢å¯ä»¥ä¸Šä¼ è¡¨å•é”®å€¼å¯¹ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¯ä¼ å¤šä¸ªæ–‡ä»¶ï¼‰</li></ul><h3 id="8-GET-ä¸-POST"><a href="#8-GET-ä¸-POST" class="headerlink" title="#8.GET ä¸ POST"></a>#8.GET ä¸ POST</h3><p>Httpå®šä¹‰äº†ä¸æœåŠ¡å™¨äº¤äº’çš„ä¸åŒæ–¹æ³•ï¼Œæœ€åŸºæœ¬çš„æ–¹æ³•æœ‰4ç§ï¼šGETï¼šæŸ¥è¯¢èµ„æºçš„ä¿¡æ¯ï¼›POSTï¼šå‘æœåŠ¡å™¨æäº¤æ•°æ®ï¼Œé€šå¸¸æ˜¯ä»¥è¡¨å•çš„å½¢å¼ï¼›PUTï¼šå‘æœåŠ¡å™¨å†™å…¥æ–‡æ¡£ï¼›DELETEï¼šåˆ é™¤èµ„æºã€‚<br><br/></p><p>æœ€å¸¸ç”¨çš„ä¸¤ä¸ªå°±æ˜¯ GET å’Œ POSTï¼š</p><h4 id="ç”¨é€”ï¼š"><a href="#ç”¨é€”ï¼š" class="headerlink" title="ç”¨é€”ï¼š"></a>ç”¨é€”ï¼š</h4><ul><li>GETä¸€èˆ¬ç”¨äºæŸ¥è¯¢èµ„æºä¿¡æ¯ï¼ŒPOSTä¸€èˆ¬ç”¨äºæäº¤æ•°æ®ã€æ›´æ–°èµ„æºä¿¡æ¯ã€‚</li></ul><h4 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h4><ul><li>GET è¯·æ±‚çš„æ•°æ®ä¼šé™„åœ¨ URL ä¹‹åï¼Œä»¥?åˆ†å‰² URL å’Œä¼ è¾“æ•°æ®ï¼›</li><li>POST è¯·æ±‚çš„æ•°æ®è¢«æ”¾åœ¨ HTTP åŒ…çš„ body ä¸­ï¼›</li><li>GET æ¯” POST æ›´ä¸å®‰å…¨ï¼Œå› ä¸ºå‚æ•°ç›´æ¥æš´éœ²åœ¨ URL ä¸Šï¼Œä¸èƒ½ç”¨æ¥ä¼ é€’æ•æ„Ÿä¿¡æ¯ï¼›</li><li>GET è¯·æ±‚çš„URLå¯ä»¥è®¾ç½®æˆä¹¦ç­¾ï¼ŒPOSTä¸å¯ä»¥ï¼›</li><li>GET è¯·æ±‚çš„å‚æ•°ä¼šè¢«å®Œæ•´çš„ä¿ç•™åœ¨æµè§ˆå†å²è®°å½•ä¸­ï¼ŒPOST è¯·æ±‚ä¸ä¼šï¼›</li><li>GET è¯·æ±‚ URL ä¸­çš„å‚æ•°æœ‰é•¿åº¦é™åˆ¶ï¼ŒPOST æ²¡æœ‰ï¼›</li></ul><h4 id="æ•°æ®åŒ…"><a href="#æ•°æ®åŒ…" class="headerlink" title="æ•°æ®åŒ…"></a>æ•°æ®åŒ…</h4><ul><li>GET è¯·æ±‚åªäº§ç”Ÿä¸€ä¸ª TCP æ•°æ®åŒ…ï¼Œæµè§ˆå™¨ä¼šæŠŠ Header å’Œ data ä¸€å¹¶å‘é€å‡ºå»ï¼ŒæœåŠ¡å™¨å“åº”200ï¼›</li><li>POST è¯·æ±‚äº§ç”Ÿä¸¤ä¸ª TCP æ•°æ®åŒ…ï¼Œæµè§ˆå™¨å…ˆå‘é€ Headerï¼ŒæœåŠ¡å™¨å“åº” 100 continueï¼›æµè§ˆå™¨å†å‘é€dataï¼ŒæœåŠ¡å™¨å“åº” 200ã€‚</li></ul><p><strong>æ³¨ï¼š</strong> ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒGET ä¸ POST éƒ½æ˜¯ Http åè®®ä¸­å‘é€è¯·æ±‚çš„æ–¹æ³•ï¼Œåº•å±‚éƒ½æ˜¯åŸºäº TCP çš„é“¾æ¥ã€‚æŠ€æœ¯ä¸Šæ¥è®²å¦‚æœä½ æƒ³ï¼Œä½ å¯ä»¥ç»™ GET è¯·æ±‚åŠ ä¸Š request bodyï¼Œä¹Ÿå¯ä»¥ç»™ POST è¯·æ±‚çš„URLåŠ ä¸Šå‚æ•°ã€‚ä½†ä¸€èˆ¬æˆ‘ä»¬ä¸ä¼šè¿™æ ·åšï¼Œå› ä¸ºä¸Šé¢æ‰€è¯´çš„è¿™äº›éƒ½æ˜¯ Http åè®®å·²ç»çº¦å®šä¿—æˆçš„è§„åˆ™ã€‚</p><h3 id="9-Http-ä¸-Https"><a href="#9-Http-ä¸-Https" class="headerlink" title="#9.Http ä¸ Https"></a>#9.Http ä¸ Https</h3><p>Httpçš„ç¼ºç‚¹ï¼š</p><ul><li>é€šä¿¡ä½¿ç”¨æ˜æ–‡ï¼ˆä¸åŠ å¯†ï¼‰ï¼Œå†…å®¹å¯èƒ½ä¼šè¢«çªƒå¬ã€‚</li><li>ä¸éªŒè¯é€šä¿¡æ–¹çš„èº«ä»½ï¼Œå› æ­¤æœ‰å¯èƒ½é­é‡ä¼ªè£…ã€‚</li><li>æ— æ³•è¯æ˜æŠ¥æ–‡çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥æœ‰å¯èƒ½å·²é­ç¯¡æ”¹ã€‚</li></ul><p>Httpçš„ä¼˜ç‚¹ï¼š</p><ul><li>ä¼ è¾“é€Ÿåº¦å¿«</li></ul><p><code>Https</code>å¹¶éæ˜¯åº”ç”¨å±‚çš„ä¸€ç§æ–°åè®®ï¼Œå®ƒåªæ˜¯<code>Http</code>é€šä¿¡æ¥å£éƒ¨åˆ†ç”¨<code>SSL</code>æˆ–<code>TLS</code>ä»£æ›¿è€Œå·²ï¼Œå³æ·»åŠ äº†åŠ å¯†åŠè®¤è¯æœºåˆ¶ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">Https</span> = Http + åŠ å¯† + è®¤è¯ + å®Œæ•´æ€§ä¿æŠ¤<br></code></pre></td></tr></table></figure><h4 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h4><p>å…¨ç§° Secure Socket Layerï¼Œå³å®‰å…¨å¥—æ¥å±‚ï¼Œæ˜¯ç½‘æ™¯å…¬å¸å¼€å‘çš„ä¸€ç§å®‰å…¨åè®®ï¼Œç”¨ä»¥ä¸ºç½‘ç»œé€šä¿¡æä¾›<code>å®‰å…¨</code>åŠ<code>æ•°æ®å®Œæ•´æ€§</code>ã€‚å½“å‰ç‰ˆæœ¬ä¸º3.0ï¼Œè¢«å¹¿æ³›åœ°ç”¨äºWebæµè§ˆå™¨ä¸æœåŠ¡å™¨ä¹‹é—´çš„<code>èº«ä»½è®¤è¯</code>å’Œ<code>åŠ å¯†æ•°æ®ä¼ è¾“</code>ã€‚SSL åè®®ä½äº TCP&#x2F;IP åè®®ä¸å„ç§åº”ç”¨å±‚åè®®ä¹‹é—´ï¼Œä¸ºæ•°æ®é€šè®¯æä¾›å®‰å…¨æ”¯æŒã€‚</p><h4 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h4><p>å…¨ç§° Transport Layer Securityï¼Œå³å®‰å…¨ä¼ è¾“å±‚åè®®ï¼Œæ˜¯ SSL çš„ç»§ä»»è€…ï¼Œå®ƒæ˜¯ IETF å°† SSL è¿›è¡Œæ ‡å‡†åŒ–çš„æˆæœã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼ŒTLS 1.0ä¸ SSL 3.0çš„å·®å¼‚éå¸¸å¾®å°ï¼Œå…·ä½“å†…å®¹å¯å‚è€ƒ <a href="https://baike.baidu.com/item/TLS/2979545?fr=aladdin">è¿™é‡Œ</a>~</p><h4 id="å¯†é’¥åŠ å¯†"><a href="#å¯†é’¥åŠ å¯†" class="headerlink" title="å¯†é’¥åŠ å¯†"></a>å¯†é’¥åŠ å¯†</h4><p>å…¬å¼€å¯†é’¥åŠ å¯†ä½¿ç”¨ä¸€å¯¹éå¯¹ç§°çš„å¯†é’¥ï¼šç§é’¥å’Œå…¬é’¥ã€‚ç§é’¥ä¸èƒ½è®©å…¶ä»–ä»»ä½•äººçŸ¥é“ï¼Œè€Œå…¬é’¥åˆ™å¯ä»¥éšæ„å‘å¸ƒï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—ã€‚ä½¿ç”¨å…¬é’¥åŠ å¯†æ–¹å¼æ—¶ï¼Œå‘é€å¯†æ–‡çš„ä¸€æ–¹ä½¿ç”¨å¯¹æ–¹çš„å…¬é’¥è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œå¯¹æ–¹æ”¶åˆ°è¢«åŠ å¯†çš„ä¿¡æ¯åï¼Œå†ä½¿ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†ã€‚è¿™ç§æ–¹å¼ç›¸å¯¹æ¯”è¾ƒå®‰å…¨ï¼Œå› ä¸ºä¸éœ€è¦å‘é€ç”¨æ¥è§£å¯†çš„ç§é’¥ï¼Œä¹Ÿä¸å¿…æ‹…å¿ƒå¯†é’¥è¢«æ”»å‡»è€…çªƒå¬è€Œç›—èµ°ã€‚</p><h4 id="Httpsè¯·æ±‚æµç¨‹"><a href="#Httpsè¯·æ±‚æµç¨‹" class="headerlink" title="Httpsè¯·æ±‚æµç¨‹"></a>Httpsè¯·æ±‚æµç¨‹</h4><ol><li>DNS Lookup</li><li>TCP Handshake</li><li>TLSæˆ–SSL Handshake</li><li>TCP&#x2F;HTTP Request&#x2F;Response</li></ol><p>Https åœ¨ä¼ è¾“æ•°æ®ä¹‹å‰éœ€è¦å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ä¸æœåŠ¡ç«¯ï¼ˆç½‘ç«™ï¼‰ä¹‹é—´è¿›è¡Œ SSL æ¡æ‰‹ï¼Œæ¡æ‰‹è¿‡ç¨‹ä¸­å°†ç¡®ç«‹åŒæ–¹åŠ å¯†ä¼ è¾“æ•°æ®çš„å¯†ç ä¿¡æ¯ï¼Œè¿‡ç¨‹æè¿°å¦‚ä¸‹ï¼š<br><br/></p><p>1.æµè§ˆå™¨å°†è‡ªå·±æ”¯æŒçš„ä¸€å¥—åŠ å¯†è§„åˆ™å‘é€ç»™ç½‘ç«™ã€‚<br><br/></p><p>2.ç½‘ç«™ä»ä¸­é€‰å‡ºä¸€ç»„åŠ å¯†ç®—æ³•ï¼Œå¹¶å°†è‡ªå·±çš„èº«ä»½ä¿¡æ¯ä»¥è¯ä¹¦çš„å½¢å¼å‘å›ç»™æµè§ˆå™¨ã€‚è¯ä¹¦é‡Œé¢åŒ…å«äº†ç½‘ç«™åœ°å€ã€åŠ å¯†å…¬é’¥ã€è¯ä¹¦é¢å‘æœºæ„ç­‰ä¿¡æ¯ã€‚<br><br/></p><p>3.è·å¾—ç½‘ç«™è¯ä¹¦ä¹‹åæµè§ˆå™¨è¦åšä»¥ä¸‹å·¥ä½œï¼š</p><ul><li>éªŒè¯è¯ä¹¦çš„åˆæ³•æ€§ï¼ˆé¢å‘è¯ä¹¦çš„æœºæ„æ˜¯å¦åˆæ³•ï¼Œè¯ä¹¦ä¸­åŒ…å«çš„ç½‘ç«™åœ°å€æ˜¯å¦ä¸æ­£åœ¨è®¿é—®çš„åœ°å€ä¸€è‡´ç­‰ï¼‰ï¼Œå¦‚æœè¯ä¹¦å—ä¿¡ä»»ï¼Œåˆ™æµè§ˆå™¨æ é‡Œé¢ä¼šæ˜¾ç¤ºä¸€ä¸ªå°é”å¤´ï¼Œå¦åˆ™ä¼šç»™å‡ºè¯ä¹¦ä¸å—ä¿¡çš„æç¤ºã€‚</li><li>å¦‚æœè¯ä¹¦å—ä¿¡ä»»ï¼Œæˆ–è€…æ˜¯ç”¨æˆ·æ¥å—äº†ä¸å—ä¿¡çš„è¯ä¹¦ï¼Œæµè§ˆå™¨ä¼šç”Ÿæˆä¸€ä¸²éšæœºæ•°çš„å¯†ç ï¼Œå¹¶ç”¨è¯ä¹¦ä¸­æä¾›çš„å…¬é’¥åŠ å¯†ã€‚</li><li>ä½¿ç”¨çº¦å®šå¥½çš„HASHè®¡ç®—æ¡æ‰‹æ¶ˆæ¯ï¼Œå¹¶ä½¿ç”¨ç”Ÿæˆçš„éšæœºæ•°å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼Œæœ€åå°†ä¹‹å‰ç”Ÿæˆçš„æ‰€æœ‰ä¿¡æ¯å‘é€ç»™ç½‘ç«™ã€‚</li></ul><p>4.ç½‘ç«™æ¥æ”¶æµè§ˆå™¨å‘æ¥çš„æ•°æ®ä¹‹åè¦åšä»¥ä¸‹çš„æ“ä½œï¼š</p><ul><li>ä½¿ç”¨è‡ªå·±çš„ç§é’¥å°†ä¿¡æ¯è§£å¯†å–å‡ºå¯†ç ï¼Œä½¿ç”¨å¯†ç è§£å¯†æµè§ˆå™¨å‘æ¥çš„æ¡æ‰‹æ¶ˆæ¯ï¼Œå¹¶éªŒè¯HASHæ˜¯å¦ä¸æµè§ˆå™¨å‘æ¥çš„ä¸€è‡´ã€‚</li><li>ä½¿ç”¨å¯†ç åŠ å¯†ä¸€æ®µæ¡æ‰‹æ¶ˆæ¯ï¼Œå‘é€ç»™æµè§ˆå™¨ã€‚</li></ul><p>5.æµè§ˆå™¨è§£å¯†å¹¶è®¡ç®—æ¡æ‰‹æ¶ˆæ¯çš„HASHï¼Œå¦‚æœä¸æœåŠ¡ç«¯å‘æ¥çš„HASHä¸€è‡´ï¼Œæ­¤æ—¶æ¡æ‰‹è¿‡ç¨‹ç»“æŸï¼Œä¹‹åæ‰€æœ‰çš„é€šä¿¡æ•°æ®å°†ç”±ä¹‹å‰æµè§ˆå™¨ç”Ÿæˆçš„éšæœºå¯†ç å¹¶åˆ©ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ã€‚</p><h3 id="10-ç½‘ç»œä¼˜åŒ–"><a href="#10-ç½‘ç»œä¼˜åŒ–" class="headerlink" title="#10.ç½‘ç»œä¼˜åŒ–"></a>#10.ç½‘ç»œä¼˜åŒ–</h3><h4 id="10-1-ç½‘ç»œæ£€æµ‹"><a href="#10-1-ç½‘ç»œæ£€æµ‹" class="headerlink" title="10.1.ç½‘ç»œæ£€æµ‹"></a>10.1.ç½‘ç»œæ£€æµ‹</h4><p>æ£€æµ‹ç”¨æˆ·æ‰€å¤„çš„ç½‘ç»œç¯å¢ƒï¼Œ2G&#x2F;3G&#x2F;4G&#x2F;Wi-Fiä»¥åŠå½“å‰ç½‘é€Ÿï¼ŒåŠ¨æ€åº”å¯¹ï¼š</p><ol><li>åŠ¨æ€è°ƒæ•´ç½‘ç»œè¯·æ±‚çš„å¹¶å‘æ•°</li></ol><p>ç½‘ç»œå·®æ—¶å°†ä»»åŠ¡çš„å¹¶å‘æ•°ç½®ä¸ºæ›´å°å€¼ï¼Œæˆ–è€…ä¸²è¡Œï¼›æ³¨æ„å¹¶å‘æ•°ä¸å®œè¿‡å¤§æˆ–è€…è¿‡å°ï¼Œå¹¶å‘æ•°è¿‡å¤§åœ¨ç½‘ç»œå·®æ—¶ä¼šé€ æˆæ›´å¤§çš„æ‹¥å µå’Œæ•´ä½“å»¶æ—¶ï¼›å¹¶å‘æ•°è¿‡å°åœ¨ç½‘ç»œå·®æ—¶ä¼šé€ æˆæ€¥åˆ‡è¯·æ±‚ç­‰æ™®é€šè¯·æ±‚çš„æƒ…å†µã€‚<br><br/></p><p>æ§åˆ¶å¹¶å‘æ•°å¯ä»¥ä»ä¸¤ä¸ªå±‚é¢å…¥æ‰‹ï¼Œä¸€ä¸ªæ˜¯åœ¨å‘èµ·æ—¶æ§åˆ¶è¯·æ±‚çš„æ‰§è¡Œæ•°é‡ï¼›ä¸€ä¸ªæ˜¯è®¾ç½®ç½‘ç»œè¿æ¥æœ¬èº«çš„æœ€å¤§å¹¶å‘æ•°ï¼›</p><ul><li>æ§åˆ¶ä»»åŠ¡è¯·æ±‚çš„å¹¶å‘æ•°</li></ul><p>åŸºäºä¿¡å·é‡ã€NSOperationæˆ–è€…GCDï¼Œæ§åˆ¶ä»»åŠ¡çš„å¹¶å‘æ•°é‡ï¼Œæ¯”å¦‚AFNæ—©æœŸç‰ˆæœ¬ä¸­çš„<code>AFHTTPRequestOperation</code>ï¼›</p><ul><li>HTTPMaximumConnectionsPerHost</li></ul><blockquote><p>The maximum number of simultaneous connections to make to a given host.</p></blockquote><p>This property determines the maximum number of simultaneous connections made to each host by tasks within sessions based on this configuration. This limit is per session, so if you use multiple sessions, your app as a whole may exceed this limit. Additionally, depending on your connection to the Internet, a session may use a lower limit than the one you specify. The default value is 6 in macOS, or 4 in iOS.</p><br/><p>è¿™æ˜¯NSURLSessionConfigurationçš„ä¸€ä¸ªå±æ€§ï¼Œè¡¨ç¤ºåŒä¸€ä¸ªæœåŠ¡å™¨åŒæ—¶æ¥å—çš„æœ€å¤§è¿æ¥å¹¶å‘æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹iOSæ”¯æŒæœ€å¤š4ä¸ªå¹¶å‘ï¼›æ¯ä¸ªsessionå¯¹åº”ç€ä¸€ä¸ªè®¾ç½®ï¼Œå¦‚æœé…ç½®Nä¸ªsessionåˆ™ä¸»æœºåŒæ—¶å¯æ¥å—çš„æœ€å¤§å¹¶å‘æ•°å¯èƒ½ä¼šè¶…è¿‡ä½ ç»™å•ä¸ªsessionè®¾ç½®çš„é™åˆ¶ã€‚</p><ol start="2"><li>åŠ¨æ€è®¾ç½®è¶…æ—¶æ—¶é—´</li></ol><p>ç½‘ç»œå·®æ—¶ï¼Œå°†è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ç½®ä¸ºæ›´çŸ­ï¼ŒèŠ‚çœåé¢è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ï¼›</p><ol start="3"><li>å‡å°‘æ•°æ®ä¼ è¾“é‡</li></ol><p>å°†å¾…ä¼ è¾“çš„æ•°æ®è¿›è¡Œåˆ†å‰²ï¼Œåˆ†æ‰¹æˆ–è€…å‹ç¼©å†ä¼ è¾“ï¼›åŒæ—¶é…åˆ<code>AFN</code>åº“ä¸­æä¾›çš„ throttle æ–¹æ³•:</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs applescript">/**<br> Throttles request bandwidth <span class="hljs-keyword">by</span> limiting <span class="hljs-keyword">the</span> packet size <br> <span class="hljs-keyword">and</span> adding a <span class="hljs-built_in">delay</span> <span class="hljs-keyword">for</span> each chunk <span class="hljs-built_in">read</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> upload stream.<br><br> When uploading <span class="hljs-keyword">over</span> a <span class="hljs-number">3</span>G <span class="hljs-keyword">or</span> EDGE connection, requests may fail <span class="hljs-keyword">with</span> <span class="hljs-string">&quot;request body stream exhausted&quot;</span>. <br> Setting a maximum packet size <span class="hljs-keyword">and</span> <span class="hljs-built_in">delay</span> according <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> recommended values (`kAFUploadStream3GSuggestedPacketSize` <br> <span class="hljs-keyword">and</span> `kAFUploadStream3GSuggestedDelay`) lowers <span class="hljs-keyword">the</span> risk <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> input stream exceeding <span class="hljs-keyword">its</span> allocated bandwidth. <br> Unfortunately, there <span class="hljs-keyword">is</span> no definite way <span class="hljs-keyword">to</span> distinguish <span class="hljs-keyword">between</span> a <span class="hljs-number">3</span>G, EDGE, <span class="hljs-keyword">or</span> LTE connection <span class="hljs-keyword">over</span> `NSURLConnection`. <br> As such, <span class="hljs-keyword">it</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> recommended <span class="hljs-keyword">that</span> you throttle bandwidth based solely <span class="hljs-keyword">on</span> network reachability. <br> Instead, you should consider checking <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> <span class="hljs-string">&quot;request body stream exhausted&quot;</span> <span class="hljs-keyword">in</span> a failure block, <br> <span class="hljs-keyword">and</span> <span class="hljs-keyword">then</span> retrying <span class="hljs-keyword">the</span> request <span class="hljs-keyword">with</span> throttled bandwidth.<br><br> @param numberOfBytes Maximum packet size, <span class="hljs-keyword">in</span> <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> bytes. The default packet size <span class="hljs-keyword">for</span> an input stream <span class="hljs-keyword">is</span> <span class="hljs-number">16</span>kb.<br> @param <span class="hljs-built_in">delay</span> Duration <span class="hljs-keyword">of</span> <span class="hljs-built_in">delay</span> each <span class="hljs-built_in">time</span> a packet <span class="hljs-keyword">is</span> <span class="hljs-built_in">read</span>. By default, no <span class="hljs-built_in">delay</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">set</span>.<br> */<br>- (void)throttleBandwidthWithPacketSize:(NSUInteger)numberOfBytes<br>                                  <span class="hljs-built_in">delay</span>:(NSTimeInterval)<span class="hljs-built_in">delay</span>;<br></code></pre></td></tr></table></figure><ol start="4"><li>æä¾›é‡å‘æœºåˆ¶</li></ol><p>é­é‡è¯·æ±‚å¤±è´¥æˆ–è¶…æ—¶ç­‰é”™è¯¯æ—¶ï¼Œå¯è‡ªåŠ¨å°è¯•æŒ‡å®šæ¬¡æ•°çš„é‡å‘ã€‚</p><ol start="5"><li>ä½¿ç”¨HTTPç¼“å­˜</li></ol><p>ç»“åˆå®é™…æƒ…å†µï¼Œåˆç†è®¾ç½®<code>NSURLRequestCachePolicy</code>ç¼“å­˜ç­–ç•¥ã€‚</p><h4 id="10-2-DNSè§£æ"><a href="#10-2-DNSè§£æ" class="headerlink" title="10.2.DNSè§£æ"></a>10.2.DNSè§£æ</h4><p>åº”ç”¨å†…ç½®æœåŠ¡å™¨çš„IPåˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å¯ä»¥åœ¨åº”ç”¨å¯åŠ¨æœåŠ¡ä¸­ä¸‹å‘æ›´æ–°ã€‚</p><h4 id="10-3-HTTPç‰ˆæœ¬"><a href="#10-3-HTTPç‰ˆæœ¬" class="headerlink" title="10.3.HTTPç‰ˆæœ¬"></a>10.3.HTTPç‰ˆæœ¬</h4><p>ä½¿ç”¨HTTP1.1åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œè‡ªåŠ¨å¼€å¯<code>Connection: Keep-Alive</code>ï¼Œçœå»TCPé¢‘ç¹ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶é—´ï¼›<br><br/></p><p>æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡ <a href="http://www.php230.com/weixin1457310207.html">æ–‡ç« </a>ï¼Œé‡Œé¢è®²åˆ°äº† HTTP 2.0ï¼Œè€Œä¸” iOS 9 å¼€å§‹å·²ç»æ”¯æŒ HTTP 2.0ï¼Œåªæ˜¯ç›®å‰ä¸»æµçš„è¿˜æ˜¯ HTTP 1.1ï¼›å¦å¤–ï¼Œæœ€è¿‘åœ¨ Github ä¸Šçœ‹åˆ°å¾®ä¿¡æœ‰ä¸€ä¸ªç½‘ç»œåŸºç¡€ç»„ä»¶å¼€æºåº“ <a href="https://github.com/Tencent/mars">Mars</a>ï¼Œè¿™ä¸¤ä¸ªç‚¹åé¢æŠ½æ—¶é—´å†ç»§ç»­ç ”ç©¶ä¸€ä¸‹~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://www.cnblogs.com/Yfling/p/6670495.html">Â©Yfling-HTTPSåŠ å¯†åŸç†</a></p><p>#<a href="https://www.jianshu.com/p/1d468ec8162f">Â©è½¯ä»¶iOSå¼€å‘-iOSç½‘ç»œå±‚è¯¦è§£å’Œä¼˜åŒ–</a></p><p>#<a href="http://www.php230.com/weixin1457310207.html">Â©å·å¸ˆé¥¿äº†ä¹ˆ:æ€æ ·ç”¨HTTP&#x2F;2ä¼˜åŒ–iOS APPç½‘ç»œå±‚æ¬¡æ¶æ„</a></p><p>#<a href="https://www.cnblogs.com/huhuuu/p/3572485.html">Â©ç½‘ç»œTCPå»ºç«‹è¿æ¥ä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹è€Œç»“æŸè¦å››æ¬¡</a></p><p>#<a href="http://www.techweb.com.cn/network/system/2016-10-11/2407736.shtml">Â©51cto-GETä¸POSTçš„åŒºåˆ«</a></p><p>#<a href="https://blog.csdn.net/weixin_41648325/article/details/79412158">Â©Socketå’ŒHttpä¹‹é—´çš„åŒºåˆ«å’Œæ¦‚è¿°</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOSä¸­çš„å…«å¤§é”</title>
    <link href="/2017/11/21/lock.html"/>
    <url>/2017/11/21/lock.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-é”"><a href="#1-é”" class="headerlink" title="1.é”"></a>1.é”</h3><p>é˜²æ­¢åœ¨å¤šçº¿ç¨‹(å¤šä»»åŠ¡)çš„æƒ…å†µä¸‹å¯¹å…±äº«èµ„æº(ä¸´ç•Œèµ„æº)çš„è„è¯»æˆ–è€…è„å†™ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼šæ‰§è¡Œå¤šçº¿ç¨‹æ—¶ç”¨äºå¼ºè¡Œé™åˆ¶èµ„æºè®¿é—®çš„åŒæ­¥æœºåˆ¶ï¼Œå³å¹¶å‘æ§åˆ¶ä¸­ä¿è¯äº’æ–¥çš„è¦æ±‚ã€‚</p><h4 id="1-1-åˆ†ç±»"><a href="#1-1-åˆ†ç±»" class="headerlink" title="1.1.åˆ†ç±»"></a>1.1.åˆ†ç±»</h4><ul><li>Mutex äº’æ–¥é”</li><li>Spin lock è‡ªæ—‹é”</li><li>Condition Variable æ¡ä»¶å˜é‡</li><li>Read&#x2F;Write lock è¯»å†™é”</li></ul><h4 id="1-2-äº’æ–¥é”"><a href="#1-2-äº’æ–¥é”" class="headerlink" title="1.2.äº’æ–¥é”"></a>1.2.äº’æ–¥é”</h4><p>å±äºsleep-waitingç±»å‹çš„é”ï¼Œåœ¨ç”³è¯·ä¸Šé”æ—¶å¦‚æœé”å·²ç»è¢«åˆ«çš„å•å…ƒæŒæœ‰ï¼Œåˆ™ä¼šè®©è¯¥çº¿ç¨‹ç¡çœ ï¼Œç­‰å¾…é”é‡Šæ”¾æ—¶è¢«å”¤é†’ã€‚ä½†çº¿ç¨‹çš„ä¼‘çœ å’Œå”¤é†’éƒ½æ˜¯ç›¸å½“æ˜‚è´µçš„æ“ä½œï¼Œéœ€è¦å¤§é‡çš„CPUæŒ‡ä»¤ï¼Œå› æ­¤éœ€è¦èŠ±è´¹ä¸€äº›æ—¶é—´ã€‚</p><h4 id="1-3-è‡ªæ—‹é”"><a href="#1-3-è‡ªæ—‹é”" class="headerlink" title="1.3.è‡ªæ—‹é”"></a>1.3.è‡ªæ—‹é”</h4><p>å±äºbusy-waitingç±»å‹çš„é”ï¼Œåœ¨ç”³è¯·ä¸Šé”æ—¶å¦‚æœé”å·²ç»è¢«åˆ«çš„å•å…ƒä¿æŒï¼Œå¹¶ä¸æ˜¯ç¡çœ ç­‰å¾…å”¤é†’ï¼Œè€Œæ˜¯å¾ªç¯æ£€æµ‹ä¿æŒè€…æ˜¯å¦é‡Šæ”¾äº†é”ã€‚å› ä¸ºè‡ªæ—‹é”ä¸ä¼šå¼•èµ·è°ƒç”¨è€…ç¡çœ ï¼Œæ‰€ä»¥è‡ªæ—‹é”çš„æ•ˆç‡è¿œé«˜äºäº’æ–¥é”ã€‚ç›¸å¯¹çš„ï¼Œç”±äºè‡ªæ—‹é”ä¸€ç›´å ç”¨CPUï¼Œæ‰€ä»¥å¦‚æœé•¿æ—¶é—´ä¸èƒ½è·å¾—é”ï¼Œåˆ™ä¼šé™ä½CPUçš„ä½¿ç”¨æ•ˆç‡ã€‚æ­¤é”æ¯”è¾ƒé€‚ç”¨äºé”çš„æŒæœ‰è€…ä¿å­˜æ—¶é—´è¾ƒçŸ­çš„æƒ…å†µä¸‹ã€‚</p><h4 id="1-4-è¯»å†™é”"><a href="#1-4-è¯»å†™é”" class="headerlink" title="1.4.è¯»å†™é”"></a>1.4.è¯»å†™é”</h4><p>é«˜çº§åˆ«é”ï¼ŒåŒºåˆ†è¯»å’Œå†™ï¼š</p><ul><li>ä¸€ä¸ªè¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»æŸå…±äº«èµ„æºï¼›</li><li>å†™æ“ä½œå…·æœ‰æ’ä»–æ€§ï¼Œå†™å…¥æ•°æ®æ—¶ä¸å…è®¸å…¶ä»–çº¿ç¨‹å¯¹å…±äº«èµ„æºè¿›è¡Œè¯»æˆ–å†™ã€‚</li></ul><p>è¯»å†™é”é€‚ç”¨äºå¤§é‡è¯»å°‘é‡å†™çš„ç¯å¢ƒï¼Œå…¶æ•ˆç‡ç›¸å¯¹æ™®é€šçš„äº’æ–¥é”å’Œè‡ªæ—‹é”è¦æ…¢ä¸€ä¸ªæ•°é‡çº§ã€‚</p><hr><p>å…³äºäº’æ–¥é”ä¸è‡ªæ—‹é”çš„åœºæ™¯ä¸¾ä¾‹ï¼š<br><br/></p><p>åœ¨ä¸€ä¸ªåŒæ ¸çš„æœºå™¨ä¸Šæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼ˆçº¿ç¨‹Aå’Œçº¿ç¨‹Bï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«è¿è¡Œåœ¨<code>Core0</code>å’Œ<code>Core1</code>ä¸Šã€‚å‡è®¾çº¿ç¨‹Aæƒ³è¦é€šè¿‡<code>pthread_mutex_lock</code>æ“ä½œå»å¾—åˆ°ä¸€ä¸ªä¸´ç•ŒåŒºçš„é”ï¼Œè€Œæ­¤æ—¶è¿™ä¸ªé”æ­£è¢«çº¿ç¨‹Bæ‰€æŒæœ‰ï¼Œé‚£ä¹ˆçº¿ç¨‹Aå°±ä¼šè¢«é˜»å¡ï¼Œ<code>Core0</code>ä¼šåœ¨æ­¤æ—¶è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°†çº¿ç¨‹Aç½®äºç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶<code>Core0</code>å°±å¯ä»¥è¿è¡Œå…¶ä»–çš„ä»»åŠ¡ï¼ˆä¾‹å¦‚å¦ä¸€ä¸ªçº¿ç¨‹Cï¼‰ï¼Œè€Œä¸å¿…è¿›è¡Œå¿™ç­‰å¾…ã€‚<br><br/></p><p>å¦‚æœçº¿ç¨‹Aæ˜¯ä½¿ç”¨<code>pthread_spin_lock</code>æ“ä½œå»è¯·æ±‚é”ï¼Œé‚£ä¹ˆçº¿ç¨‹Aå°±ä¼šä¸€ç›´åœ¨<code>Core0</code>ä¸Šè¿›è¡Œå¿™ç­‰å¾…å¹¶ä¸åœçš„è¿›è¡Œé”è¯·æ±‚ï¼Œç›´åˆ°å¾—åˆ°è¿™ä¸ªé”ä¸ºæ­¢ã€‚</p><h3 id="2-å…«å¤§é”"><a href="#2-å…«å¤§é”" class="headerlink" title="2.å…«å¤§é”"></a>2.å…«å¤§é”</h3><p>æŒ‰ç…§æ€§èƒ½æ’åºï¼Œä»é«˜åˆ°ä½ï¼š</p><ol><li>OSSpinLock</li><li>dispatch_semaphore</li><li>pthread_mutex</li><li>NSLock</li><li>NSCondition</li><li>NSRecursiveLock</li><li>NSConditionLock</li><li>@synchronized</li></ol><h3 id="3-è‡ªæ—‹é”"><a href="#3-è‡ªæ—‹é”" class="headerlink" title="3.è‡ªæ—‹é”"></a>3.è‡ªæ—‹é”</h3><h4 id="3-1-OSSpinLock"><a href="#3-1-OSSpinLock" class="headerlink" title="3.1.OSSpinLock"></a>3.1.OSSpinLock</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//éœ€è¦å¯¼å…¥ï¼š#import &lt;libkern/OSAtomic.h&gt;</span><br><span class="hljs-comment">//OSSpinLock è‡ªæ—‹é”</span><br>- (void)OSSpinLock<br>&#123;<br>    __block OSSpinLock oslock = OS_SPINLOCK_INIT;<br>    <span class="hljs-comment">//çº¿ç¨‹1</span><br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">dispatch_get_global_queue</span>(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0)</span>, ^&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++çº¿ç¨‹1 ä¸Šé”&quot;</span>)</span>;<br>        <span class="hljs-constructor">OSSpinLockLock(&amp;<span class="hljs-params">oslock</span>)</span>;<br>        sleep(<span class="hljs-number">4</span>);<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++çº¿ç¨‹1æ‰§è¡Œä»»åŠ¡....&quot;</span>)</span>;<br>        <span class="hljs-constructor">OSSpinLockUnlock(&amp;<span class="hljs-params">oslock</span>)</span>;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++çº¿ç¨‹1 è§£é”&quot;</span>)</span>;<br>    &#125;);<br>    <br>    <span class="hljs-comment">//çº¿ç¨‹2</span><br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">dispatch_get_global_queue</span>(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0)</span>, ^&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++çº¿ç¨‹2 ä¸Šé”&quot;</span>)</span>;<br>        <span class="hljs-constructor">OSSpinLockLock(&amp;<span class="hljs-params">oslock</span>)</span>;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++çº¿ç¨‹2æ‰§è¡Œä»»åŠ¡....&quot;</span>)</span>;<br>        <span class="hljs-constructor">OSSpinLockUnlock(&amp;<span class="hljs-params">oslock</span>)</span>;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++çº¿ç¨‹2 è§£é”&quot;</span>)</span>;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1 ä¸Šé”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹2 ä¸Šé”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹2æ‰§è¡Œä»»åŠ¡</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹2 è§£é”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1æ‰§è¡Œä»»åŠ¡</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1 è§£é”</span><br></code></pre></td></tr></table></figure><p><strong>psï¼š</strong>æ­¤è‡ªæ—‹é”å­˜åœ¨ä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼ŒiOS10 ä¹‹åè‹¹æœæ¨å‡ºäº†<code>os_unfair_lock</code>æ¥æ›¿ä»£å®ƒã€‚<br><br/></p><p>å…³äºä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼Œ<a href="https://baike.baidu.com/item/%E4%BC%98%E5%85%88%E7%BA%A7%E7%BF%BB%E8%BD%AC/4945202">ç™¾åº¦ç™¾ç§‘</a> æœ‰æ›´è¯¦ç»†çš„ä»‹ç»ï¼š</p><blockquote><p>ä¼˜å…ˆçº§ç¿»è½¬æ˜¯å½“ä¸€ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡é€šè¿‡ä¿¡å·é‡æœºåˆ¶è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œè¯¥ä¿¡å·é‡å·²è¢«ä¸€ä½ä¼˜å…ˆçº§ä»»åŠ¡å æœ‰ï¼Œå› æ­¤é€ æˆé«˜ä¼˜å…ˆçº§ä»»åŠ¡è¢«è®¸å¤šå…·æœ‰è¾ƒä½ä¼˜å…ˆçº§ä»»åŠ¡é˜»å¡ï¼Œå®æ—¶æ€§éš¾ä»¥å¾—åˆ°ä¿è¯ã€‚</p></blockquote><blockquote><p>ä¾‹å¦‚ï¼šæœ‰ä¼˜å…ˆçº§ä¸ºAã€Bå’ŒCä¸‰ä¸ªä»»åŠ¡ï¼Œä¼˜å…ˆçº§A&gt;B&gt;Cï¼Œä»»åŠ¡Aï¼ŒBå¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œç­‰å¾…æŸä¸€äº‹ä»¶å‘ç”Ÿï¼Œä»»åŠ¡Cæ­£åœ¨è¿è¡Œï¼Œæ­¤æ—¶ä»»åŠ¡Cå¼€å§‹ä½¿ç”¨æŸä¸€å…±äº«èµ„æºSã€‚åœ¨ä½¿ç”¨ä¸­ï¼Œä»»åŠ¡Aç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼Œä»»åŠ¡Aè½¬ä¸ºå°±ç»ªæ€ï¼Œå› ä¸ºå®ƒæ¯”ä»»åŠ¡Cä¼˜å…ˆçº§é«˜ï¼Œæ‰€ä»¥ç«‹å³æ‰§è¡Œã€‚å½“ä»»åŠ¡Aè¦ä½¿ç”¨å…±äº«èµ„æºSæ—¶ï¼Œç”±äºå…¶æ­£åœ¨è¢«ä»»åŠ¡Cä½¿ç”¨ï¼Œå› æ­¤ä»»åŠ¡Aè¢«æŒ‚èµ·ï¼Œä»»åŠ¡Cå¼€å§‹è¿è¡Œã€‚å¦‚æœæ­¤æ—¶ä»»åŠ¡Bç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼Œåˆ™ä»»åŠ¡Bè½¬ä¸ºå°±ç»ªæ€ã€‚ç”±äºä»»åŠ¡Bä¼˜å…ˆçº§æ¯”ä»»åŠ¡Cé«˜ï¼Œå› æ­¤ä»»åŠ¡Bå¼€å§‹è¿è¡Œï¼Œç›´åˆ°å…¶è¿è¡Œå®Œæ¯•ï¼Œä»»åŠ¡Cæ‰å¼€å§‹è¿è¡Œã€‚ç›´åˆ°ä»»åŠ¡Cé‡Šæ”¾å…±äº«èµ„æºSåï¼Œä»»åŠ¡Aæ‰å¾—ä»¥æ‰§è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§å‘ç”Ÿäº†ç¿»è½¬ï¼Œä»»åŠ¡Bå…ˆäºä»»åŠ¡Aè¿è¡Œã€‚</p></blockquote><h4 id="3-2-os-unfair-lock"><a href="#3-2-os-unfair-lock" class="headerlink" title="3.2.os_unfair_lock"></a>3.2.os_unfair_lock</h4><p><code>OSSpinLock</code>è‡ªæ—‹é”å­˜åœ¨ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ï¼ŒiOS10.0ä¹‹åè¢«åºŸå¼ƒï¼Œç”±os_unfair_lockï¼ˆä¸å…¬å¹³çš„é”ï¼‰ä»£æ›¿ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">os_unfair_lock_t unfairLock;<br>unfairLock = &amp;(OS_UNFAIR_LOCK_INIT);<br>os<span class="hljs-constructor">_unfair_lock_lock(<span class="hljs-params">unfairLock</span>)</span>;<br>os<span class="hljs-constructor">_unfair_lock_unlock(<span class="hljs-params">unfairLock</span>)</span>;<br></code></pre></td></tr></table></figure><h3 id="4-äº’æ–¥é”"><a href="#4-äº’æ–¥é”" class="headerlink" title="4.äº’æ–¥é”"></a>4.äº’æ–¥é”</h3><h4 id="4-1-pthread-mutex"><a href="#4-1-pthread-mutex" class="headerlink" title="4.1.pthread_mutex"></a>4.1.pthread_mutex</h4><p>pthread_mutex æ˜¯ C è¯­è¨€ä¸‹å¤šçº¿ç¨‹åŠ äº’æ–¥é”çš„æ–¹å¼ï¼Œéœ€è¦ <code>#import &lt;pthread.h&gt;</code></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs scss">- (void)pthread_mutex_Test<br>&#123;<br>    static pthread_mutex_t pLock;<br>    <span class="hljs-built_in">pthread_mutex_init</span>(&amp;pLock, NULL);<br>    <span class="hljs-comment">//çº¿ç¨‹1</span><br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(@&quot;++++çº¿ç¨‹<span class="hljs-number">1</span> ä¸Šé”&quot;);<br>        <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;pLock);<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">3</span>);<br>        <span class="hljs-built_in">NSLog</span>(@&quot;++++çº¿ç¨‹<span class="hljs-number">1</span> æ‰§è¡Œä»»åŠ¡....&quot;);<br>        <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;pLock);<br>        <span class="hljs-built_in">NSLog</span>(@&quot;++++çº¿ç¨‹<span class="hljs-number">1</span> è§£é”&quot;);<br>    &#125;);<br>    <br>    <span class="hljs-comment">//çº¿ç¨‹2</span><br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(@&quot;++++çº¿ç¨‹<span class="hljs-number">2</span> ä¸Šé”&quot;);<br>        <span class="hljs-built_in">pthread_mutex_lock</span>(&amp;pLock);<br>        <span class="hljs-built_in">NSLog</span>(@&quot;++++çº¿ç¨‹<span class="hljs-number">2</span> æ‰§è¡Œä»»åŠ¡....&quot;);<br>        <span class="hljs-built_in">pthread_mutex_unlock</span>(&amp;pLock);<br>        <span class="hljs-built_in">NSLog</span>(@&quot;++++çº¿ç¨‹<span class="hljs-number">2</span> è§£é”&quot;);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1 ä¸Šé”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹2 ä¸Šé”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1 æ‰§è¡Œä»»åŠ¡</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1 è§£é”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹2 æ‰§è¡Œä»»åŠ¡</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹2 è§£é”</span><br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨æ¡ˆä¾‹ï¼šå¼€æºå›¾ç‰‡ä¸‹è½½å’Œç¼“å­˜æ¡†æ¶PINRemoteImage</strong>ã€‚</p><h4 id="4-2-NSLock"><a href="#4-2-NSLock" class="headerlink" title="4.2.NSLock"></a>4.2.NSLock</h4><p>NSLock éµå¾ª NSLocking åè®®çš„äº’æ–¥é”ï¼Œé€šè¿‡<code>lock</code>ä¸<code>unlock</code>é…åˆä½¿ç”¨ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSLock</span> : <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">NSLocking</span>&gt;</span><br>&#123;<br><span class="hljs-keyword">@private</span><br><span class="hljs-type">void</span> *_priv;<br>&#125;<br>- (<span class="hljs-type">BOOL</span>)tryLock;<br>- (<span class="hljs-type">BOOL</span>)lockBeforeDate:(<span class="hljs-built_in">NSDate</span> *)limit;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>äº’æ–¥é”ä¼šä½¿å¾—çº¿ç¨‹é˜»å¡ï¼Œé˜»å¡çš„è¿‡ç¨‹åˆåˆ†ä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µæ˜¯ä¼šå…ˆç©ºè½¬ï¼Œå¯ä»¥ç†è§£æˆè·‘ä¸€ä¸ª while å¾ªç¯ï¼Œä¸æ–­åœ°å»ç”³è¯·åŠ é”ï¼Œåœ¨ç©ºè½¬ä¸€å®šæ—¶é—´ä¹‹åï¼Œçº¿ç¨‹ä¼šè¿›å…¥ <code>waiting</code> çŠ¶æ€ï¼Œæ­¤æ—¶çº¿ç¨‹å°±ä¸å ç”¨CPUèµ„æºäº†ï¼Œç­‰é”å¯ç”¨çš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šç«‹å³è¢«å”¤é†’ã€‚<br><br/></p><p><code>tryLock</code> åˆ™ä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œå¦‚æœè·å–é”æˆåŠŸåˆ™è¿”å›YESï¼Œè·å–å¤±è´¥åˆ™è¿”å›NOã€‚è¿™ä¸ªæ–¹æ³•æ— è®ºå¦‚ä½•éƒ½ä¼šç«‹å³è¿”å›ï¼Œåœ¨æ‹¿ä¸åˆ°é”æ—¶ä¸ä¼šä¸€ç›´åœ¨é‚£ç­‰å¾…ã€‚<br><br/></p><p><code>lockBeforeDate:</code> æ–¹æ³•ä¼šåœ¨æ‰€æŒ‡å®š Date ä¹‹å‰å°è¯•åŠ é”ï¼Œä¼šé˜»å¡çº¿ç¨‹ã€‚<br><br/></p><p><strong>ps:</strong> å¦‚æœä½¿ç”¨ NSLock è¿ç»­é”å®šä¸¤æ¬¡ï¼Œåˆ™ä¼šé€ æˆæ­»é”ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)nslockTest<br>&#123;<br>    <span class="hljs-built_in">NSLock</span> *nslock = [<span class="hljs-built_in">NSLock</span> new];<br>    <span class="hljs-comment">//çº¿ç¨‹1</span><br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹1 ä¸Šé”&quot;</span>);<br>        [nslock lock];<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹1æ‰§è¡Œä»»åŠ¡....&quot;</span>);<br>        [nslock unlock];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹1 è§£é”&quot;</span>);<br>    &#125;);<br>    <br>    <span class="hljs-comment">//çº¿ç¨‹2</span><br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹2 ä¸Šé”&quot;</span>);<br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">BOOL</span> succed = [nslock tryLock];<br>        <span class="hljs-keyword">if</span> (succed) &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹2ä¸Šé”æˆåŠŸ&quot;</span>);<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹2æ‰§è¡Œä»»åŠ¡....&quot;</span>);<br>            [nslock unlock];<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹2 è§£é”&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹2ä¸Šé”å¤±è´¥&quot;</span>);<br>        &#125;<br>    &#125;);<br>    <br>    <span class="hljs-comment">//çº¿ç¨‹3</span><br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹3 ä¸Šé”&quot;</span>);<br>        sleep(<span class="hljs-number">1</span>);<br>        [nslock lock];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹3æ‰§è¡Œä»»åŠ¡....&quot;</span>);<br>        [nslock unlock];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++çº¿ç¨‹3 è§£é”&quot;</span>);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹2 ä¸Šé”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹3 ä¸Šé”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1 ä¸Šé”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹2ä¸Šé”å¤±è´¥</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1æ‰§è¡Œä»»åŠ¡</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹1 è§£é”</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹3æ‰§è¡Œä»»åŠ¡</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹3 è§£é”</span><br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨æ¡ˆä¾‹ï¼šAFNetworking</strong>ã€‚</p><h4 id="4-3-NSRecursiveLock"><a href="#4-3-NSRecursiveLock" class="headerlink" title="4.3.NSRecursiveLock"></a>4.3.NSRecursiveLock</h4><p>ä¸NSLockä¸åŒï¼Œé€’å½’é”å¯ä»¥è¢«ä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œè€Œä¸ä¼šå¼•èµ·æ­»é”ã€‚å®ƒè®°å½•äº†æˆåŠŸè·å¾—é”çš„æ¬¡æ•°ï¼Œæ¯ä¸€æ¬¡æˆåŠŸçš„è·å¾—é”ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªé…å¥—çš„é‡Šæ”¾é”å’Œå…¶å¯¹åº”ï¼Œè¿™æ ·æ‰ä¸ä¼šå¼•èµ·æ­»é”ã€‚åªæœ‰å½“æ‰€æœ‰çš„é”è¢«é‡Šæ”¾ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹æ‰å¯ä»¥è·å¾—é”ã€‚</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">- (<span class="hljs-type">void</span>)recursivelock<br>&#123;<br>    NSLock *<span class="hljs-keyword">lock</span> = [NSLock <span class="hljs-built_in">new</span>];<br>    //NSRecursiveLock *<span class="hljs-keyword">lock</span> = [NSRecursiveLock <span class="hljs-built_in">new</span>];<br>    <br>    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <br>       static <span class="hljs-type">void</span> (^RecursiveBlock)(<span class="hljs-type">int</span>);<br>       <br>       RecursiveBlock = ^(<span class="hljs-type">int</span> <span class="hljs-keyword">value</span>) &#123;<br>           [<span class="hljs-keyword">lock</span> <span class="hljs-keyword">lock</span>];<br>           <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> &gt; <span class="hljs-number">0</span>) &#123;<br>               NSLog(@&quot;++++å¾ªç¯ï¼š%d&quot;, <span class="hljs-keyword">value</span>);<br>               sleep(<span class="hljs-number">1</span>);<br>               RecursiveBlock(<span class="hljs-keyword">value</span> - <span class="hljs-number">1</span>);<br>           &#125;<br>           [<span class="hljs-keyword">lock</span> unlock];<br>       &#125;;<br>       RecursiveBlock(<span class="hljs-number">5</span>);<br>   &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯ä¸€ä¸ªæ­»é”çš„æƒ…å†µï¼ŒRecursiveBlockè¢«é€’å½’çš„è°ƒç”¨ï¼Œä»ç¬¬äºŒæ¬¡å¼€å§‹ï¼Œç”±äºé”å·²ç»è¢«ä½¿ç”¨ä¸”æ²¡æœ‰è¢«è§£é”ï¼Œæ‰€ä»¥éœ€è¦ç­‰å¾…è§£é”ï¼Œé€ æˆæ­»é”ã€‚è¿è¡Œåçš„æ—¥å¿—å°±å¯ä»¥çœ‹å‡ºï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">å¾ªç¯ï¼š5</span><br></code></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæŠŠä¸Šç‰‡ä»£ç ç¬¬äºŒè¡Œæ³¨é‡Šå–æ¶ˆï¼ŒæŠŠNSLockæ›¿æ¢ä¸ºNSRecursiveLockï¼Œä½¿ç”¨é€’å½’é”ï¼Œåˆ™ä¸ä¼šå‡ºç°æ­»é”ã€‚</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">å¾ªç¯ï¼š5</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">å¾ªç¯ï¼š4</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">å¾ªç¯ï¼š3</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">å¾ªç¯ï¼š2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">å¾ªç¯ï¼š1</span><br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨æ¡ˆä¾‹ï¼šPINRemoteImage</strong>ã€‚</p><h4 id="4-4-synchronized"><a href="#4-4-synchronized" class="headerlink" title="4.4.@synchronized"></a>4.4.@synchronized</h4><p><code>@synchronized(obj)</code>çš„ä½œç”¨æ˜¯æ ¹æ®ç»™å®šå¯¹è±¡ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªäº’æ–¥é”ï¼Œå—ä¸­çš„ä»£ç æ‰§è¡Œå®Œåæ‰ä¼šé‡Šæ”¾é”ã€‚ç›¸æ¯”äºä½¿ç”¨<code>NSLock</code>ç­‰åˆ›å»ºé”å¯¹è±¡ã€åŠ é”å’Œè§£é”æ¥è¯´ï¼Œ@synchronized ç”¨ç€æ›´æ–¹ä¾¿ã€‚ä½†å®ƒä¹Ÿæ˜¯è¿™å‡ ä¸ªé”é‡Œæ•ˆç‡æœ€ä½çš„ï¼Œå› ä¸ºä¸€èˆ¬æˆ‘ä»¬ä¼šå°†<code>self</code>ç­‰ä½œä¸ºä»£ç å—çš„åŠ é”å¯¹è±¡ï¼Œè¿™ä¼šé€ æˆå…¶ä»–å…±ç”¨æ­¤é”çš„åŒæ­¥å—çš„é˜»å¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSMutableArray</span> *mArr;<br><span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSMutableDictionary</span> *mDic;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br><span class="hljs-keyword">@synthesize</span> mArr = _mArr;<br><span class="hljs-keyword">@synthesize</span> mDic = _mDic;<br><br>- (<span class="hljs-built_in">NSMutableArray</span> *)mArr&#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!_mArr) &#123;<br>            _mArr = [<span class="hljs-built_in">NSMutableArray</span> array];<br>        &#125;<br>        <span class="hljs-keyword">return</span> _mArr;<br>    &#125;<br>&#125;<br>- (<span class="hljs-type">void</span>)setMArr:(<span class="hljs-built_in">NSMutableArray</span> *)mArr&#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        _mArr = mArr;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++mArr updated~&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<span class="hljs-comment">//æ¨¡æ‹Ÿå»¶æ—¶</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++mArr block released~&quot;</span>);<br>    &#125;<br>&#125;<br>-(<span class="hljs-built_in">NSMutableDictionary</span> *)mDic&#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!_mDic) &#123;<br>            _mDic = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>        &#125;<br>        <span class="hljs-keyword">return</span> _mDic;<br>    &#125;<br>&#125;<br>-(<span class="hljs-type">void</span>)setMDic:(<span class="hljs-built_in">NSMutableDictionary</span> *)mDic&#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        _mDic = mDic;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++mDic updated~&quot;</span>);<br>    &#125;<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++111&quot;</span>);<br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++222&quot;</span>);<br>        <span class="hljs-keyword">self</span>.mArr = [<span class="hljs-built_in">NSMutableArray</span> arrayWithObject:@(<span class="hljs-number">0</span>)];<br>        <span class="hljs-keyword">self</span>.mDic = [<span class="hljs-built_in">NSMutableDictionary</span> dictionaryWithObject:<span class="hljs-string">@&quot;v1&quot;</span> forKey:<span class="hljs-string">@&quot;k&quot;</span>];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++333&quot;</span>);<br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">111</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">222</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">mArr updated~</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">mArr block released~</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">mDic updated~</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">333</span><br></code></pre></td></tr></table></figure><p>æœ¬ç¤ºä¾‹ä¸­ï¼Œæ•°ç»„å±æ€§<code>mArr</code>çš„å­˜å–å™¨ä¸­éƒ½ä½¿ç”¨äº†<code>@synchronized(self)</code>æ¥åŠ é”ï¼Œä¿è¯äº†æ•°ç»„è¯»å†™çš„åŸå­æ€§ï¼Œä½†å­—å…¸å±æ€§<code>mDic</code>çš„å­˜å–å‡½æ•°ä¸­ä¹Ÿä½¿ç”¨äº†<code>@synchronized(self)</code>ï¼Œä¸”åŠ é”å¯¹è±¡ä¹Ÿæ˜¯<code>self</code>ï¼Œè¿™å°±ä¼šå¯¼è‡´åœ¨è®¿é—®<code>mArr</code>çš„åŒæ—¶è®¿é—®<code>mDic</code>æ—¶åè€…ä¼šè¢«é˜»å¡ï¼Œé€ æˆæ²¡å¿…è¦çš„ç­‰å¾…ã€‚å®é™…ä¸Šï¼Œè¿™ç§æ–¹å¼çš„æ•ˆæœä¸å±æ€§ä¿®é¥°ç¬¦<code>atomic</code>ä¸€æ ·ï¼Œéƒ½å­˜åœ¨æ•ˆç‡çš„é—®é¢˜~</p><h3 id="5-æ¡ä»¶é”"><a href="#5-æ¡ä»¶é”" class="headerlink" title="5.æ¡ä»¶é”"></a>5.æ¡ä»¶é”</h3><h4 id="5-1-NSCondition"><a href="#5-1-NSCondition" class="headerlink" title="5.1.NSCondition"></a>5.1.NSCondition</h4><p>NSCondition æ‰®æ¼”ç€ä¸¤ä¸ªè§’è‰²ï¼š</p><blockquote><p>A condition object acts as both a lock and a checkpoint in a given thread. The lock protects your code while it tests the condition and performs the task triggered by the condition. The checkpoint behavior requires that the condition be true before the thread proceeds with its task. While the condition is not true, the thread blocks. It remains blocked until another thread signals the condition object.</p></blockquote><p><strong>1.é”</strong></p><p>NSCondition å®ç°äº†<code>NSLocking</code>åè®®ï¼Œä¸<code>NSLock</code>ä¸€æ ·å¯ç”¨æ¥å¤„ç†çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚<br><br/></p><p><strong>2.æ£€æŸ¥ç‚¹</strong></p><p>æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦æ»¡è¶³æŸä¸ªæ¡ä»¶ï¼šæ¡ä»¶ä¸æ»¡è¶³æ—¶çº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å‘è¯¥æ¡ä»¶å‘é€é€šçŸ¥ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSCondition</span> : <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">NSLocking</span>&gt; </span>&#123;<br><br>- (<span class="hljs-type">void</span>)wait;<br>- (<span class="hljs-type">BOOL</span>)waitUntilDate:(<span class="hljs-built_in">NSDate</span> *)limit;<br>- (<span class="hljs-type">void</span>)signal;<br>- (<span class="hljs-type">void</span>)broadcast;<br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>NSCondition æä¾›äº† wait å’Œ signal æ¥å£ï¼Œæ¥å£å‘½åä¸ä¿¡å·é‡ç±»ä¼¼ã€‚<br><br/></p><p>åœºæ™¯ï¼šå¼€å¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹Aä¸‹è½½å›¾ç‰‡ï¼Œçº¿ç¨‹Bå¯¹å›¾ç‰‡åšè§£ç æ“ä½œã€‚</p><ul><li>çº¿ç¨‹Bçš„è¦æ±‚æ˜¯ï¼šå¦‚æœæ²¡æœ‰å›¾ç‰‡åˆ™è‡ªåŠ¨é˜»å¡ï¼›</li><li>å½“çº¿ç¨‹Aä¸‹è½½å®Œæˆåï¼Œåˆ™æ»¡è¶³äº†çº¿ç¨‹Bçš„éœ€æ±‚ï¼Œå‘é€ä¿¡å·ç»™Bçº¿ç¨‹è®©å…¶ç»§ç»­å¤„ç†å›¾ç‰‡ã€‚</li></ul><p>è¿™æ ·çš„åœºæ™¯å°±æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼ˆæ”¶å‘åŒæ­¥é—®é¢˜ï¼‰ã€‚<br><br/></p><p>åŸç†ï¼š</p><ul><li>æ¶ˆè´¹è€…å–å¾—é”ï¼Œå–äº§å“ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™waitï¼Œç›´åˆ°æœ‰çº¿ç¨‹å”¤é†’å®ƒå»æ¶ˆè´¹äº§å“ï¼›</li><li>ç”Ÿäº§è€…åˆ¶é€ äº§å“ï¼Œé¦–å…ˆä¹Ÿè¦å–å¾—é”ï¼Œç„¶åç”Ÿäº§ï¼Œå†å‘signalï¼Œå”¤é†’waitçš„æ¶ˆè´¹è€…ã€‚</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs csharp">- (<span class="hljs-keyword">void</span>)nsConditonTest<br>&#123;<br>    NSCondition *condition = [[NSCondition alloc] <span class="hljs-keyword">init</span>];<br>    NSMutableArray *products = [NSMutableArray array];<br>    <span class="hljs-comment">// çº¿ç¨‹1ï¼Œæ¶ˆè´¹è€…</span><br>    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>            [<span class="hljs-meta">condition lock</span>];<br>            <span class="hljs-keyword">if</span> ([products count] == <span class="hljs-number">0</span>) &#123;<br>                NSLog(<span class="hljs-string">@&quot;+++ç­‰å¾…å•†å“..&quot;</span>);<br>                [<span class="hljs-meta">condition wait</span>]; <span class="hljs-comment">//ä¸æ»¡è¶³æ¡ä»¶ é˜»å¡çº¿ç¨‹</span><br>            &#125;<br>            [<span class="hljs-meta">products removeObjectAtIndex:0</span>];<br>            NSLog(<span class="hljs-string">@&quot;+++æˆåŠŸæ¶ˆè´¹1ä¸ªå•†å“&quot;</span>);<br>            [<span class="hljs-meta">condition unlock</span>];<br>        &#125;<br>    &#125;);<br>    <span class="hljs-comment">// çº¿ç¨‹2ï¼Œç”Ÿäº§è€…</span><br>    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>            [<span class="hljs-meta">condition lock</span>];<br>            [<span class="hljs-meta">products addObject:[[NSObject alloc</span>] <span class="hljs-keyword">init</span>]];<br>            NSLog(<span class="hljs-string">@&quot;+++ç”Ÿäº§ä¸€ä¸ªå•†å“ï¼Œç°æ€»é‡:%zi&quot;</span>,products.count);<br>            [<span class="hljs-meta">condition signal</span>]; <span class="hljs-comment">//æ»¡è¶³æ¡ä»¶ï¼Œé€šçŸ¥å…¶ä»–çº¿ç¨‹</span><br>            [<span class="hljs-meta">condition unlock</span>];<br>            sleep(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">ç­‰å¾…å•†å“</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ç”Ÿäº§ä¸€ä¸ªå•†å“ï¼Œç°æ€»é‡:1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">æˆåŠŸæ¶ˆè´¹1ä¸ªå•†å“</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ç­‰å¾…å•†å“</span><span class="hljs-string">.</span><span class="hljs-string">.</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ç”Ÿäº§ä¸€ä¸ªå•†å“ï¼Œç°æ€»é‡:1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">æˆåŠŸæ¶ˆè´¹1ä¸ªå•†å“</span><br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨æ¡ˆä¾‹ï¼šPINRemoteImage</strong>ã€‚</p><h4 id="5-2-NSConditionLock"><a href="#5-2-NSConditionLock" class="headerlink" title="5.2.NSConditionLock"></a>5.2.NSConditionLock</h4><p>ç›¸æ¯”äº NSLock å¤šäº†ä¸ª condition å‚æ•°ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ¡ä»¶æ ‡è¯†ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)conditionlock&#123;<br><span class="hljs-comment">//åˆå§‹é”å¯¹è±¡ æ¡ä»¶=0</span><br><span class="hljs-built_in">NSConditionLock</span> *contidionlock = [[<span class="hljs-built_in">NSConditionLock</span> alloc] initWithCondition:<span class="hljs-number">0</span>];<br><span class="hljs-comment">//çº¿ç¨‹1</span><br><span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>    <span class="hljs-keyword">if</span>([contidionlock tryLockWhenCondition:<span class="hljs-number">0</span>])&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œçº¿ç¨‹1&quot;</span>);<br>        [contidionlock unlockWithCondition:<span class="hljs-number">1</span>];<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä¸Šé”å¤±è´¥&quot;</span>);<br>    &#125;<br>&#125;);<br><br><span class="hljs-comment">//çº¿ç¨‹2</span><br><span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>    [contidionlock lockWhenCondition:<span class="hljs-number">3</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œçº¿ç¨‹2&quot;</span>);<br>    [contidionlock unlockWithCondition:<span class="hljs-number">2</span>];<br>&#125;);<br><br><span class="hljs-comment">//çº¿ç¨‹3</span><br><span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>    [contidionlock lockWhenCondition:<span class="hljs-number">1</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œçº¿ç¨‹3&quot;</span>);<br>    [contidionlock unlockWithCondition:<span class="hljs-number">3</span>];<br>&#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œçº¿ç¨‹1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œçº¿ç¨‹3</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œçº¿ç¨‹2</span><br></code></pre></td></tr></table></figure><p>ä¸Šç‰‡ä»£ç ä¸­ï¼Œåˆå§‹åŒ– NSConditionLock å¯¹è±¡æ—¶ï¼Œæ ‡è¯†è®¾ç½®ä¸º0ï¼›è¿è¡Œåï¼š</p><ul><li>çº¿ç¨‹1æ‰§è¡Œ <code>tryLockWhenCondition:</code>æ—¶ï¼Œä¼ å…¥æ ‡è¯†â€œ0â€ï¼Œæ‰€ä»¥ çº¿ç¨‹1 åŠ é”æˆåŠŸã€‚</li><li>çº¿ç¨‹1æ‰§è¡Œ <code>unlockWithCondition:</code>æ—¶ï¼Œ<code>condition</code>ç”± 0 è¢«ä¿®æ”¹ä¸º 1ã€‚</li><li>å› ä¸º<code>condition</code>ä¿®æ”¹ä¸ºäº† 1ï¼Œçº¿ç¨‹3 ç¬¦åˆæ¡ä»¶å¹¶æˆåŠŸä¸Šé”ï¼Œä¹‹åçº¿ç¨‹3å°†<code>condition</code> ä¿®æ”¹ä¸º3ã€‚</li><li>æœ€åçº¿ç¨‹2æ‰§è¡Œã€‚</li></ul><p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥å‘ç°ï¼ŒNSConditionLock è¿˜å¯ä»¥å®ç°ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–ã€‚<br><br/></p><p><strong>ä½¿ç”¨æ¡ˆä¾‹ï¼šPINRemoteImage</strong>ã€‚</p><h4 id="5-3-dispatch-semaphore"><a href="#5-3-dispatch-semaphore" class="headerlink" title="5.3.dispatch_semaphore"></a>5.3.dispatch_semaphore</h4><p>ä¿¡å·é‡ï¼šå°±æ˜¯ä¸€ç§å¯ç”¨æ¥æ§åˆ¶è®¿é—®èµ„æºçš„æ•°é‡çš„æ ‡è¯†ã€‚å½“ä¸€ä¸ªçº¿ç¨‹åœ¨è¿›å…¥ä¸€æ®µå…³é”®ä»£ç ä¹‹å‰ï¼Œçº¿ç¨‹å¿…é¡»è·å–ä¸€ä¸ªä¿¡å·é‡ï¼Œä¸€æ—¦è¯¥å…³é”®ä»£ç æ®µå®Œæˆäº†ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å¿…é¡»é‡Šæ”¾ä¿¡å·é‡ã€‚å…¶å®ƒæƒ³è¿›å…¥è¯¥å…³é”®ä»£ç æ®µçš„çº¿ç¨‹å¿…é¡»ç­‰å¾…å‰é¢çš„çº¿ç¨‹é‡Šæ”¾ä¿¡å·é‡ã€‚<br><br/></p><p>ç½‘ä¸Šæœ‰ä¸€ä¸ªç»å…¸çš„åœè½¦åœºçš„ä¾‹å­ï¼šä¿¡å·é‡çš„å€¼å°±ç›¸å½“äºå‰©ä½™è½¦ä½çš„æ•°ç›®ï¼Œ<code>dispatch_semaphore_wait</code>å°±ç›¸å½“äºæ¥äº†ä¸€è¾†è½¦ï¼Œ<code>dispatch_semaphore_signal</code>å°±ç›¸å½“äºèµ°äº†ä¸€è¾†è½¦ã€‚åœè½¦ä½çš„å‰©ä½™æ•°ç›®åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±å·²ç»æŒ‡æ˜äº†ï¼ˆ<code>dispatch_semaphore_create(value:Int)ï¼‰</code>ï¼‰ï¼Œè°ƒç”¨ä¸€æ¬¡<code>dispatch_semaphore_signal</code>ï¼Œå‰©ä½™çš„è½¦ä½å°±å¢åŠ ä¸€ä¸ªï¼›è°ƒç”¨ä¸€æ¬¡<code>dispatch_semaphore_wait</code>å‰©ä½™è½¦ä½å°±å‡å°‘ä¸€ä¸ªï¼›å½“å‰©ä½™è½¦ä½ä¸º0æ—¶ï¼Œå†æ¥è½¦ï¼ˆå³è°ƒç”¨<code>dispatch_semaphore_wait</code>ï¼‰å°±åªèƒ½ç­‰å¾…ã€‚æœ‰è€å¿ƒçš„è½¦ä¸»ä¼šä¸€ç›´ç­‰ä¸‹å»ï¼Œæ²¡è€å¿ƒçš„è½¦ä¸»åœ¨ç­‰å¾…â€œä¸€æ®µæ—¶é—´â€ä¹‹åå°±ä¼šç¦»å¼€ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>åˆ›å»ºä¿¡å·é‡ï¼Œå‚æ•°ï¼šä¿¡å·é‡çš„åˆå€¼ï¼Œå¦‚æœå°äº<span class="hljs-number">0</span>åˆ™ä¼šè¿”å›NULL<br>dispatch_semaphore_createï¼ˆä¿¡å·é‡å€¼ï¼‰<br><br><span class="hljs-regexp">//</span>å‡å°‘ä¿¡å·é‡ï¼Œæ—¶é—´ï¼šDISPATCH_TIME_NOWã€DISPATCH_TIME_FOREVER<br>dispatch_semaphore_waitï¼ˆä¿¡å·é‡ï¼Œç­‰å¾…æ—¶é—´ï¼‰<br><br><span class="hljs-regexp">//</span>é‡Šæ”¾ä¿¡å·é‡<br>dispatch_semaphore_signal(ä¿¡å·é‡)<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)Segmaphore<br>&#123;<br>    <span class="hljs-comment">//åˆå§‹ä¿¡å·é‡</span><br>    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">dispatch_queue_t</span> quene = dispatch_queue_create(<span class="hljs-string">&quot;com.M.D&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br>    <br>    <span class="hljs-comment">//ä»»åŠ¡1</span><br>    <span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;<br>        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ä»»åŠ¡1&quot;</span>);<br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++å®Œæˆä»»åŠ¡1&quot;</span>);<br>        dispatch_semaphore_signal(semaphore);<br>    &#125;);<br>    <br>    <span class="hljs-comment">//ä»»åŠ¡2</span><br>    <span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;<br>        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ä»»åŠ¡2&quot;</span>);<br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++å®Œæˆä»»åŠ¡2&quot;</span>);<br>        dispatch_semaphore_signal(semaphore);<br>    &#125;);<br>    <br>    <span class="hljs-comment">//ä»»åŠ¡3</span><br>    <span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;<br>        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ä»»åŠ¡3&quot;</span>);<br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++å®Œæˆä»»åŠ¡3&quot;</span>);<br>        dispatch_semaphore_signal(semaphore);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡3</span><br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨æ¡ˆä¾‹ï¼šAFNã€GPUImage</strong>ã€‚</p><h3 id="6-è¯»å†™é”"><a href="#6-è¯»å†™é”" class="headerlink" title="6.è¯»å†™é”"></a>6.è¯»å†™é”</h3><p>ä¸€ä¸ªè¯»å†™é”å…¶è¯»æ˜¯å¯å¹¶å‘çš„ï¼Œå†™æ˜¯æ’ä»–çš„ï¼Œå› æ­¤å®ç°è¯»å†™é”å¯ä»¥ä½¿ç”¨å…·æœ‰ç±»ä¼¼ç‰¹æ€§çš„GCD<code>æ …æ </code>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ASDLockTool</span> ()</span><br><span class="hljs-comment">// è¯»å†™é”ç¤ºèŒƒ</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">dispatch_queue_t</span> mQueue;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ASDLockTool</span></span><br><br><span class="hljs-keyword">@synthesize</span> name = _name;<br><br>- (<span class="hljs-keyword">instancetype</span>)init &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) &#123;<br>        _mQueue = dispatch_queue_create(<span class="hljs-string">&quot;mQueue&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br><span class="hljs-comment">// getter éœ€è¦åŒæ­¥ï¼Œå› ä¸ºè¦ç«‹åˆ»è¿”å›å±æ€§çš„å€¼</span><br>- (<span class="hljs-built_in">NSString</span> *)name&#123;<br>    __block <span class="hljs-built_in">NSString</span> *bName;<br>    <span class="hljs-built_in">dispatch_sync</span>(_mQueue, ^&#123;<br>        bName = _name;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> bName;<br>&#125;<br><br><span class="hljs-comment">// setter éœ€è¦æ’ä»–æ€§ï¼Œå†™æ—¶ä¸å…è®¸å…¶ä»–å†™æ“ä½œæˆ–è€…è¯»æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨æ …æ </span><br>- (<span class="hljs-type">void</span>)setName:(<span class="hljs-built_in">NSString</span> *)name&#123;<br>    dispatch_barrier_async(_mQueue, ^&#123;<br>        _name = name;<br>    &#125;);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å› ä¸ºgetteréœ€è¦ç«‹åˆ»è¿”å›å½“å‰å±æ€§çš„å€¼ï¼Œæ‰€ä»¥å¯¹äºå±æ€§çš„è¯»æ“ä½œä½¿ç”¨äº†â€œåŒæ­¥+å¹¶å‘é˜Ÿåˆ—â€ï¼›è€Œå†™æ“ä½œæ˜¯æ’ä»–çš„ï¼Œæ‰€ä»¥ä½¿ç”¨äº†â€œå¼‚æ­¥æ …æ +å¹¶å‘é˜Ÿåˆ—â€ï¼Œè¿™æ ·å°±èƒ½ä¿è¯å†™å…¥æ—¶å…¶ä»–æ“ä½œéƒ½è‡ªåŠ¨ç­‰å¾…ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://blog.csdn.net/deft_mkjing/article/details/79513500">Â©Deft_MKJingå®“ç‚ç’Ÿ-è‡ªæ—‹å’Œäº’æ–¥é”</a></p><p>#<a href="https://baike.baidu.com/item/%E4%BC%98%E5%85%88%E7%BA%A7%E7%BF%BB%E8%BD%AC/4945202">Â©ç™¾åº¦ç™¾ç§‘-ä¼˜å…ˆçº§åè½¬</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¤šçº¿ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤šçº¿ç¨‹ï¼šNSOperation</title>
    <link href="/2017/11/17/nsoperation.html"/>
    <url>/2017/11/17/nsoperation.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>iOS2 æ—¶ OS X ä¸ iOS çš„ç¨‹åºéƒ½æ™®éé‡‡ç”¨ NSOperation æ¥ç¼–å†™çº¿ç¨‹ä»£ç ï¼Œè€Œä¹‹åå‡ºç°çš„ GCD æŠ€æœ¯å¤§ä½“æ˜¯ä¾ç…§å‰è€…çš„åŸåˆ™æ¥å®ç°çš„ã€‚éšç€ GCD çš„æ™®åŠï¼Œåœ¨iOS4 ä¸ OS X 10.6 ä»¥åï¼ŒOperationQueue çš„åº•å±‚éƒ½æ˜¯ç”¨ GCD æ¥å®ç°çš„ã€‚</p></blockquote><h3 id="1-ä¸-GCD-çš„å¯¹æ¯”"><a href="#1-ä¸-GCD-çš„å¯¹æ¯”" class="headerlink" title="1.ä¸ GCD çš„å¯¹æ¯”"></a>1.ä¸ GCD çš„å¯¹æ¯”</h3><h4 id="1-1-GCD-çš„ç‰¹ç‚¹ï¼š"><a href="#1-1-GCD-çš„ç‰¹ç‚¹ï¼š" class="headerlink" title="1.1.GCD çš„ç‰¹ç‚¹ï¼š"></a>1.1.GCD çš„ç‰¹ç‚¹ï¼š</h4><p>GCD æ˜¯é¢å‘è¿‡ç¨‹çš„ï¼Œå®ƒæ˜¯ç”± C è¯­è¨€æ„æˆçš„ APIï¼Œä¸€èˆ¬ä¸ block ç»“åˆä½¿ç”¨ï¼Œç®€æ´é«˜æ•ˆï¼›</p><h4 id="1-2-NSOperationçš„ç‰¹ç‚¹ï¼š"><a href="#1-2-NSOperationçš„ç‰¹ç‚¹ï¼š" class="headerlink" title="1.2.NSOperationçš„ç‰¹ç‚¹ï¼š"></a>1.2.NSOperationçš„ç‰¹ç‚¹ï¼š</h4><p><strong>å¤ç”¨ç‡ï¼š</strong> NSOperation æ˜¯é¢å‘å¯¹è±¡çš„ï¼Œæ‹¥æœ‰æ›´å¤šçš„å‡½æ•°å¯ç”¨ï¼›åŒæ—¶å®ƒèƒ½è¢«ç»§æ‰¿ï¼Œè¿™ä¸€æ–¹é¢æ–¹ä¾¿äº†æˆ‘ä»¬é‡å†™å…¶éƒ¨åˆ†æ–¹æ³•ä»¥å®ç°ç‰¹æ®ŠåŠŸèƒ½ï¼›å¦ä¸€æ–¹é¢ä¹Ÿè®©æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€æ±‚å®šä¹‰ä¸åŒçš„å­ç±»ï¼Œä»è€Œæé«˜ä»£ç çš„å¤ç”¨ç‡ï¼›<br><br/></p><p><strong>ä¾èµ–å…³ç³»ï¼š</strong> NSOperation èƒ½å¤Ÿæ–¹ä¾¿åœ°è®¾ç½®ä¾èµ–å…³ç³»ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿çš„è®©å¤„äºåŒä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—ä¸­çš„ä¸¤ä¸ªä»»åŠ¡æŒ‰ç…§æˆ‘ä»¬æŒ‡å®šçš„å…ˆåé¡ºåºæ‰§è¡Œï¼›<br><br/></p><p><strong>å±æ€§ç›‘æµ‹ï¼š</strong> NSOperation æä¾›äº†éƒ¨åˆ†å±æ€§ï¼Œæˆ‘ä»¬å¯é€šè¿‡ KVO ç›‘å¬ä¸€ä¸ªä»»åŠ¡æ˜¯å¦å®Œæˆæˆ–å–æ¶ˆã€‚è¿™è®©æˆ‘ä»¬èƒ½æ¯” GCD æ›´åŠ æœ‰æ•ˆåœ°æŒä»»åŠ¡çš„è¿›åº¦å’ŒçŠ¶æ€ï¼›<br><br/></p><p><strong>ä¼˜å…ˆçº§è®¾ç½®ï¼š</strong> NSOperation ä¸­èƒ½è®¾ç½®ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œä½¿åŒä¸€ä¸ªå¹¶è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åŒºåˆ†å…ˆååœ°æ‰§è¡Œã€‚GCD ä¸­åªèƒ½åŒºåˆ†ä¸åŒä»»åŠ¡é˜Ÿåˆ—çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœè¦åŒºåˆ† block å†…ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œéœ€è¦å¤æ‚çš„ä»£ç ï¼›</p><h3 id="2-NSOperation"><a href="#2-NSOperation" class="headerlink" title="2.NSOperation"></a>2.NSOperation</h3><p>NSOperation æ˜¯ä¸€ä¸ªåŸºç±»ï¼Œä¸èƒ½ç›´æ¥ä½¿ã€‚ç³»ç»Ÿç»™æˆ‘ä»¬æä¾›äº†å®ƒçš„ä¸¤ä¸ªå¯ä»¥ç›´æ¥ä½¿ç”¨çš„å­ç±»ï¼šNSInvocationOperation å’Œ NSBlockOperationã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåŸºäº NSOperation çš„å­ç±»ã€‚</p><h4 id="2-1-å­ç±»"><a href="#2-1-å­ç±»" class="headerlink" title="2.1.å­ç±»"></a>2.1.å­ç±»</h4><p>#ç¤ºä¾‹1ï¼ˆNSInvocationOperationï¼‰</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)operationGo<br>&#123;<br>    <span class="hljs-comment">//invocation Operation</span><br>    <span class="hljs-type">NSInvocationOperation</span> <span class="hljs-operator">*</span>invocOperation <span class="hljs-operator">=</span> [[<span class="hljs-type">NSInvocationOperation</span> alloc] <br>    initWithTarget:<span class="hljs-keyword">self</span> <br>    selector:<span class="hljs-meta">@selector</span>(operationAction) <br>    object:<span class="hljs-literal">nil</span>];<br>    <br>    <span class="hljs-comment">//æ‰§è¡Œç»“æŸåè°ƒç”¨çš„Block</span><br>    [invocOperation setCompletionBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++invocation Finished&quot;</span>);<br>    &#125;];<br>    [invocOperation start];<br>&#125;<br><br><span class="hljs-operator">-</span> (void)operationAction<br>&#123;<br>    <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++execute invocationï¼Œ</span><br><span class="hljs-string">    <span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>,[<span class="hljs-type">NSThread</span> currentThread]);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">execute invocationï¼Œ</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">çº¿ç¨‹:</span>&lt;<span class="hljs-comment">NSThread: 0x600000065f80</span>&gt;<span class="hljs-comment">&#123;number = 1</span><span class="hljs-string">,</span> <span class="hljs-comment">name = main&#125;</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">invocation Finished</span><br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹2ï¼ˆNSBlockOperationï¼‰</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)blockOperationGo<br>&#123;<br>    <span class="hljs-comment">//block Operation</span><br>    <span class="hljs-type">NSBlockOperation</span> <span class="hljs-operator">*</span>blockOperation <span class="hljs-operator">=</span> [<span class="hljs-type">NSBlockOperation</span> blockOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++execute blockï¼Œ<span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>,[<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    [blockOperation addExecutionBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++added block, <span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>,[<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    [blockOperation setCompletionBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++block Finished&quot;</span>);<br>    &#125;];<br>    [blockOperation start];<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran">++++added <span class="hljs-keyword">block</span>,<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x60400027c4c0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++execute <span class="hljs-keyword">block</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x604000078080&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">1</span>, <span class="hljs-keyword">name</span> = main&#125;<br>++++<span class="hljs-keyword">block</span> Finished<br></code></pre></td></tr></table></figure><p>ä»ä¸Šè¿°ç¤ºä¾‹åŠå…¶è¾“å‡ºç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼š<br><br/></p><p>NSOperation çš„ä¿©å­ç±»åœ¨å•ç‹¬ä½¿ç”¨æ—¶éƒ½æ²¡æœ‰å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä»»åŠ¡ä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œã€‚<br><br/></p><p>NSBlockOperation ä½¿ç”¨ addExecutionBlock æ·»åŠ é¢å¤–ä»»åŠ¡æ—¶ï¼Œè¿™äº›ä»»åŠ¡ä¼šåœ¨ä¸åŒçº¿ç¨‹ä¸­å¹¶å‘æ‰§è¡Œã€‚</p><h4 id="2-2-çŠ¶æ€"><a href="#2-2-çŠ¶æ€" class="headerlink" title="2.2.çŠ¶æ€"></a>2.2.çŠ¶æ€</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">BOOL executing<span class="hljs-comment">;</span><br>BOOL finished<span class="hljs-comment">;</span><br>BOOL asynchronous<span class="hljs-comment">;</span><br>BOOL ready<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><ul><li>isReady</li></ul><p>è¡¨ç¤ºè¿™ä¸ª operation æ˜¯å¦å·²åšå¥½å‡†å¤‡å»æ‰§è¡Œã€‚&#x3D;NO è¡¨ç¤ºå®ƒä¾èµ–çš„ç›¸å…³ operation å°šæœªå®Œæˆã€‚</p><ul><li>isExecuting</li></ul><p>è¡¨ç¤ºå½“å‰ operation ä¸­çš„ä»»åŠ¡æ˜¯å¦æ­£åœ¨æ‰§è¡Œã€‚</p><ul><li>isFinished</li></ul><p>&#x3D; YES æ—¶è¡¨ç¤ºå½“ä»»åŠ¡å·²å®Œæˆæˆ–è€…å·²è¢«å–æ¶ˆã€‚åªæœ‰æ­¤å±æ€§ä¸ºYESæ—¶ operation æ‰ä¼šä»é˜Ÿåˆ—ä¸­å‡ºåˆ—ã€‚</p><ul><li>isCancelled</li></ul><p>å½“å‰ operation æ˜¯å¦è¢«å–æ¶ˆäº†ã€‚åœ¨è‡ªå®šä¹‰å­ç±»çš„ä»»åŠ¡å¼€å§‹å‰ï¼Œéœ€è¦åœ¨ start æ–¹æ³•ä¸­æ£€æŸ¥æ­¤å±æ€§ã€‚å½“ &#x3D; YES æ—¶åº”è¯¥ç«‹åˆ»é€€å‡ºï¼ŒåŒæ—¶å°† finishedå±æ€§è®¾ç½®ä¸ºYESï¼Œexecuting å±æ€§è®¾ç½®ä¸º NOã€‚</p><ul><li>isAsynchronous</li></ul><p>è¡¨ç¤º operation åœ¨å½“å‰çº¿ç¨‹æ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥æ‰§è¡Œï¼Œé»˜è®¤å€¼ä¸ºNOã€‚æ‰§è¡Œå¼‚æ­¥ operation æ—¶å¿…é¡»é‡å†™æ­¤å±æ€§å¹¶è¿”å› YESã€‚<br><br/></p><p>æ³¨æ„ï¼šNSOperationQueue æ˜¯é€šè¿‡ KVO è§‚å¯Ÿå†…éƒ¨çš„ NSOperation çŠ¶æ€çš„å˜åŒ–ï¼Œæ¥è‡ªåŠ¨ç®¡ç† NSOperation çš„æ‰§è¡Œçš„ã€‚é‡å†™ start æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è‡ªå·±ç»´æŠ¤ isExecutingã€isFinished çš„å€¼å¹¶æ­£ç¡®çš„å‘é€ç›¸å…³ KVO é€šçŸ¥ã€‚</p><h4 id="2-3-ä¼˜å…ˆçº§"><a href="#2-3-ä¼˜å…ˆçº§" class="headerlink" title="2.3.ä¼˜å…ˆçº§"></a>2.3.ä¼˜å…ˆçº§</h4><p>NSOperationçš„ä¼˜å…ˆçº§å¯ä»¥ç”±å…¶å±æ€§<code>queuePriority</code>æŒ‡å®šï¼š</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elm">typedef <span class="hljs-type">NS_ENUM</span>(<span class="hljs-type">NSInteger</span>, <span class="hljs-type">NSOperationQueuePriority</span>) &#123;<br>    <span class="hljs-type">NSOperationQueuePriorityVeryLow</span> = -8L,<br>    <span class="hljs-type">NSOperationQueuePriorityLow</span> = -4L,<br>    <span class="hljs-type">NSOperationQueuePriorityNormal</span> = 0,<br>    <span class="hljs-type">NSOperationQueuePriorityHigh</span> = 4,<br>    <span class="hljs-type">NSOperationQueuePriorityVeryHigh</span> = 8<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä»åå­—æ¥çœ‹ä¼¼ä¹æ˜¯å’ŒGCDä¸€æ ·çš„<code>é˜Ÿåˆ—</code>çš„ä¼˜å…ˆçº§ï¼Œå®é™…ä¸Šè¿™ä¸ªå±æ€§å´æ˜¯operationå³<code>ä»»åŠ¡</code>çš„ä¼˜å…ˆçº§ï¼š</p><blockquote><p>The execution priority of the operation in an operation queue.</p></blockquote><p>ä»è¿™ä¸€ç‚¹æ¥è¯´ï¼ŒOperationå°±æ¯”GCDçš„åŠŸèƒ½æ›´ä¸°å¯Œï¼Œå› ä¸ºGCDåªèƒ½ç»™é˜Ÿåˆ—è®¾ç½®ä¼˜å…ˆçº§ï¼Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¹‹é—´æ²¡æ³•å•ç‹¬è®¾ç½®ä¼˜å…ˆçº§ã€‚å¹¶ä¸”GCDåªèƒ½ç»™<code>GlobalQueue</code>è®¾ç½®ä¼˜å…ˆçº§ï¼Œå…¶ä»–é˜Ÿåˆ—æƒ³è¦è®¾ç½®ä¼˜å…ˆçº§ï¼Œéœ€è¦é€šè¿‡ä¸‹é¢è¿™ç§æ–¹å¼è¿›è¡Œï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">dispatch_queue_t serialQueue = dispatch<span class="hljs-constructor">_queue_create(<span class="hljs-string">&quot;com.xx.xx&quot;</span>,DISPATCH_QUEUE_SERIAL)</span>;<br><br>dispatch_queue_t globalQueue = dispatch<span class="hljs-constructor">_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND,0)</span>;<br><br><span class="hljs-comment">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡é˜Ÿåˆ—ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‚è€ƒé˜Ÿåˆ—ï¼ˆå…¨å±€é˜Ÿåˆ—ï¼‰ï¼›</span><br>dispatch<span class="hljs-constructor">_set_target_queue(<span class="hljs-params">serialQueue</span>, <span class="hljs-params">globalQueue</span>)</span>;<br></code></pre></td></tr></table></figure><p>å¯¹äº<code>queuePriority</code>æœ‰ä¸‰ç‚¹éœ€è¦è¯´æ˜ï¼š</p><ul><li>ä¼˜å…ˆçº§å†³å®šäº†å„ operation ä¹‹é—´çš„å¼€å§‹é¡ºåºï¼›</li><li>è¿™ç§ä¼˜å…ˆçº§åªé’ˆå¯¹åŒä¸€ OperationQueue ä¸­çš„ operationï¼Œä¸åŒé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¹‹é—´æ¯”è¾ƒä¼˜å…ˆçº§æ— æ„ä¹‰ï¼›</li><li>è¿™ç§ä¼˜å…ˆçº§æ˜¯é’ˆå¯¹å¹¶å‘é˜Ÿåˆ—ï¼Œå¯¹äºå¹¶å‘æ•°ä¸º 1 çš„ä¸²è¡Œé˜Ÿåˆ—æ¥è¯´æ— æ„ä¹‰ï¼Œå®ƒä»¬è¿˜æ˜¯æŒ‰å…¥é˜Ÿåˆ—çš„é¡ºåºæ‰§è¡Œã€‚</li></ul><p><strong>ps</strong>ï¼šç†è®ºä¸Šæ¥è¯´ä¼˜å…ˆçº§é«˜çš„å…ˆæ‰§è¡Œï¼Œä½†å®é™…ä½¿ç”¨ä¸­å‘ç°é€šè¿‡è¿™ä¸ªå±æ€§æ ‡è®°çš„ä»»åŠ¡ï¼Œå…¶å¼€å§‹çš„é¡ºåºå¹¶ä¸ä¸€å®šæŒ‰ç…§æˆ‘ä»¬æŒ‡å®šçš„ä¼˜å…ˆçº§æ¥ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)operationPriority&#123;<br>    <span class="hljs-built_in">NSBlockOperation</span> *op1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++1&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++2&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++3&quot;</span>);<br>    &#125;];<br>    <br>    op1.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityNormal</span>;<br>    op2.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityVeryHigh</span>;<br>    op3.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityVeryLow</span>;<br>    <br>    <span class="hljs-built_in">NSOperationQueue</span> *aQueue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    [aQueue addOperations:@[op1,op2,op3] waitUntilFinished:<span class="hljs-literal">NO</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">2</span><br></code></pre></td></tr></table></figure><p>ä¸‰ä¸ªä»»åŠ¡å®é™…æ‰§è¡Œæ—¶å¹¶æœªæŒ‰ç…§æˆ‘ä»¬æŒ‡å®šçš„<code>2-&gt;1-&gt;3</code>çš„é¡ºåºæ¥ã€‚<br><br/></p><p>æœ‰ç§è¯´æ³•æ˜¯å†³å®šä»»åŠ¡å¼€å§‹é¡ºåºçš„ä¸ä»…æ˜¯ä¼˜å…ˆçº§ï¼Œè¿˜è¦çœ‹ä»»åŠ¡æ˜¯å¦å¤„åœ¨<code>isReady</code>çŠ¶æ€ã€‚</p><blockquote><p>The readiness of operations is determined by their dependencies on other operations and potentially by custom conditions that you define. The NSOperation class manages dependencies on other operations and reports the readiness of the receiver based on those dependencies.</p></blockquote><blockquote><p>By default, an operation object that has dependencies is not considered ready until all of its dependent operation objects have finished executing. Once the last dependent operation finishes, however, the operation object becomes ready and able to execute.</p></blockquote><p><a href="https://developer.apple.com/documentation/foundation/nsoperation/1412992-ready?language=objc">å®˜æ–‡</a>ä¸­è¯´<code>ready</code>æ˜¯æ ¹æ®å½“å‰ä»»åŠ¡â€œæ˜¯å¦æœ‰ä¾èµ–ä»»åŠ¡åŠè¯¥ä»»åŠ¡æ˜¯å¦å·²å®Œæˆâ€è€Œå®šçš„ã€‚ç¤ºä¾‹ä¸­çš„ä¸‰ä¸ªä»»åŠ¡ä¹‹é—´æ˜¯å¹¶å‘ä¸”æ²¡æœ‰ä¾èµ–å…³ç³»çš„ï¼Œæ‰€ä»¥æŒ‰ç†å®ƒä»¬è¢«åŠ å…¥é˜Ÿåˆ—åï¼Œæ˜¯å¦å¤„åœ¨å°±ç»ªçŠ¶æ€æ˜¯ç”±é˜Ÿåˆ—æˆ–çº¿ç¨‹æ± çŠ¶å†µæ¥å†³å®šçš„ï¼Œè‡³äºæœ€ç»ˆè®¾ç½®äº†ä¼˜å…ˆçº§ä½†å¤±æ•ˆäº†çš„é—®é¢˜ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬èƒ½æ§åˆ¶çš„äº†ã€‚</p><br/><p>é‰´äºæ­¤ï¼Œä¸ºäº†æ›´ç²¾ç¡®æ§åˆ¶ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨æ¥ä¸‹æ¥ä»‹ç»çš„<code>qualityOfService</code>æœåŠ¡è´¨é‡å±æ€§æ¥æŒ‡å®šä»»åŠ¡ä¼˜å…ˆçº§ã€‚è¿™é‡Œåªæ˜¯è¯´æ›´ç²¾ç¡®çš„æ§åˆ¶ï¼Œä¸æ˜¯è¯´æœåŠ¡è´¨é‡èƒ½å®Œå…¨ä¿è¯ä»»åŠ¡æŒ‰æŒ‡å®šé¡ºåºæ‰§è¡Œï¼Œä¸‹é¢ä¼šå…·ä½“ä»‹ç»ã€‚</p><h4 id="2-4-æœåŠ¡è´¨é‡"><a href="#2-4-æœåŠ¡è´¨é‡" class="headerlink" title="2.4.æœåŠ¡è´¨é‡"></a>2.4.æœåŠ¡è´¨é‡</h4><p><code>qualityOfService</code>ï¼Œè¿™æ˜¯åœ¨iOS 8åæ¨å‡ºçš„æ–°å±æ€§ï¼Œé€šè¿‡è®¾ç½®æœåŠ¡è´¨é‡æ¥å†³å®šä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­çš„ä¼˜å…ˆçº§ï¼ŒNSOperationå’ŒNSOperationQueueéƒ½æœ‰è¿™ä¸ªå±æ€§ã€‚</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elm">typedef <span class="hljs-type">NS_ENUM</span>(<span class="hljs-type">NSInteger</span>, <span class="hljs-type">NSQualityOfService</span>) &#123;<br>    <span class="hljs-type">NSQualityOfServiceUserInteractive</span> = 0x21,<br>    <span class="hljs-type">NSQualityOfServiceUserInitiated</span> = 0x19,<br>    <span class="hljs-type">NSQualityOfServiceUtility</span> = 0x11,<br>    <span class="hljs-type">NSQualityOfServiceBackground</span> = 0x09,<br>    <span class="hljs-type">NSQualityOfServiceDefault</span> = -1<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><strong>UserInteractive</strong></li></ul><blockquote><p>Used for work directly involved in providing an interactive UI. For example, processing control events or drawing to the screen.</p></blockquote><p>ç”¨äºæ¶‰åŠåˆ°UIäº¤äº’çš„åœºæ™¯ï¼Œä¾‹å¦‚å¤„ç†ç‚¹å‡»äº‹ä»¶æˆ–ç»˜åˆ¶å›¾ç‰‡åˆ°å±å¹•ä¸Šã€‚</p><ul><li><strong>UserInitiated</strong></li></ul><blockquote><p>Used for performing work that has been explicitly requested by the user, and for which results must be immediately presented in order to allow for further user interaction. For example, loading an email after a user has selected it in a message list.</p></blockquote><p>ç”¨äºç”¨æˆ·è§¦å‘çš„ã€éœ€è¦ç«‹åˆ»è¿”å›ç»“æœçš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç”¨æˆ·ç‚¹å‡»é‚®ä»¶åˆ—è¡¨åç«‹åˆ»åŠ è½½é‚®ä»¶å†…å®¹ã€‚</p><ul><li><strong>Default</strong></li></ul><blockquote><p>Indicates no explicit quality of service information. Whenever possible, an appropriate quality of service is determined from available sources. Otherwise, some quality of service level between NSQualityOfServiceUserInteractive and NSQualityOfServiceUtility is used.</p></blockquote><p>é»˜è®¤å€¼ï¼Œè¡¨ç¤ºæœªæŒ‡æ˜æœåŠ¡è´¨é‡ï¼Œç³»ç»Ÿä¼šæ ¹æ®å½“å‰å¯ç”¨èµ„æºçš„çŠ¶å†µï¼Œä½¿ç”¨ä»‹äº<code>UserInteractive</code>å’Œ<code>Utility</code>ä¹‹é—´çš„æŸä¸ªä¼˜å…ˆçº§ã€‚</p><ul><li><strong>Utility</strong></li></ul><blockquote><p>Used for performing work which the user is unlikely to be immediately waiting for the results. This work may have been requested by the user or initiated automatically, and often operates at user-visible timescales using a non-modal progress indicator. For example, periodic content updates or bulk file operations, such as media import.</p></blockquote><p>ç”¨äºä¸éœ€è¦ç«‹åˆ»è¿”å›ç»“æœçš„ä»»åŠ¡ï¼Œæ¯”å¦‚å‘¨æœŸæ€§çš„æ›´æ–°å†…å®¹ï¼Œæˆ–è€…å¯¼å…¥åª’ä½“æ–‡ä»¶ã€‚</p><ul><li><strong>Background</strong></li></ul><blockquote><p>Used for work that is not user initiated or visible. In general, a user is unaware that this work is even happening. For example, pre-fetching content, search indexing, backups, or syncing of data with external systems.</p></blockquote><p>åå°ä»»åŠ¡ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œç”¨äºéç”¨æˆ·è§¦å‘çš„ã€ä¸å¯è§çš„ä»»åŠ¡ï¼Œæ¯”å¦‚å‘èµ·çš„ç½‘ç»œè¯·æ±‚ã€æ£€ç´¢ç»“æœã€åŒæ­¥æ•°æ®ã€‚</p><br/><p><strong>ä¸€èˆ¬æ¥è¯´</strong>ï¼ŒæœåŠ¡è´¨é‡å¯¹åº”çš„ä¼˜å…ˆçº§æ’åºæ˜¯ï¼šUserInteractive &gt; UserInitiated &gt; Default &gt; Utility &gt; Backgroundã€‚<br><br/></p><p>#ç¤ºä¾‹ï¼šæœåŠ¡è´¨é‡å†³å®šä¼˜å…ˆçº§</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    [<span class="hljs-keyword">self</span> operationServiceQuality];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)operationServiceQuality&#123;<br>    <span class="hljs-built_in">NSBlockOperation</span> *op1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++1&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++2&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++3&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op4 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++4&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op5 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++5&quot;</span>);<br>    &#125;];<br>    <br>    op1.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceUserInitiated</span>;<br>    op2.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceDefault</span>;<br>    op3.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceUserInteractive</span>;<br>    op4.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceUtility</span>;<br>    op5.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceBackground</span>;<br>    <br>    <span class="hljs-built_in">NSOperationQueue</span> *aQueue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    [aQueue addOperations:@[op1,op2,op3,op4,op5] waitUntilFinished:<span class="hljs-literal">NO</span>];<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">4</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">5</span><br></code></pre></td></tr></table></figure><p><strong>ä½†æ˜¯</strong>ï¼Œå¤šæ¬¡è¿è¡ŒåŒæ ·ä¸€æ®µä»£ç ä¹‹åï¼Œä¼šå¾—åˆ°è¿™æ ·çš„æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">4</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">5</span><br></code></pre></td></tr></table></figure><p>å’Œè¿™æ ·çš„æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">5</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">4</span><br></code></pre></td></tr></table></figure><p><strong>ç»“è®ºï¼š</strong>æœåŠ¡è´¨é‡ä¹Ÿä¸èƒ½ä¿è¯ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºã€‚</p><br/><p>é‚£å’‹åŠå‘¢ï¼Ÿä¸ºäº†ç²¾ç¡®æ§åˆ¶ä»»åŠ¡çš„é¡ºåºï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨ä¾èµ–å…³ç³»ï¼Œæˆ–è€…å°†ä»»åŠ¡æ”¾åˆ°æœ€å¤§å¹¶å‘æ•°&#x3D;1çš„ä¸²è¡Œé˜Ÿåˆ—ä¸­ã€‚</p><h3 id="3-NSOperationQueue"><a href="#3-NSOperationQueue" class="headerlink" title="3.NSOperationQueue"></a>3.NSOperationQueue</h3><p>NSOperation å•ç‹¬ä½¿ç”¨æ—¶ï¼Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œåªæœ‰é…åˆ NSOperationQueue æ‰èƒ½å¦è¾Ÿæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚é…åˆä½¿ç”¨æ—¶ï¼ŒNSOperation ç›¸å½“äºGCDä¸­çš„ä»»åŠ¡ï¼Œè€Œ NSOperationQueue åˆ™ç›¸å½“äºGCDä¸­çš„é˜Ÿåˆ—ã€‚å°†ä»»åŠ¡åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°† NSOperationQueue ä¸­çš„ NSOperation å–å‡ºæ¥ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œæ“ä½œï¼Œä¸éœ€è¦å†æ‰‹åŠ¨è°ƒç”¨startã€‚</p><h4 id="3-1-ä¸¤ç§é˜Ÿåˆ—"><a href="#3-1-ä¸¤ç§é˜Ÿåˆ—" class="headerlink" title="3.1.ä¸¤ç§é˜Ÿåˆ—"></a>3.1.ä¸¤ç§é˜Ÿåˆ—</h4><ul><li>ä¸»é˜Ÿåˆ—ï¼šï¼ˆä»»åŠ¡ä¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼‰</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">NSOperationQueue *mainQueue <span class="hljs-operator">=</span> [NSOperationQueue mainQueue]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><ul><li>å…¶ä»–é˜Ÿåˆ—ï¼šï¼ˆä»»åŠ¡ä¼šæ”¾åˆ°å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰ã€‚</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">NSOperationQueue</span> <span class="hljs-operator">*</span>queue <span class="hljs-operator">=</span> [[<span class="hljs-type">NSOperationQueue</span> alloc] <span class="hljs-keyword">init</span>];<br></code></pre></td></tr></table></figure><h4 id="3-2-æ·»åŠ ä»»åŠ¡"><a href="#3-2-æ·»åŠ ä»»åŠ¡" class="headerlink" title="3.2.æ·»åŠ ä»»åŠ¡"></a>3.2.æ·»åŠ ä»»åŠ¡</h4><p>#ç¤ºä¾‹3ï¼š-addOperation:(NSOperation *)op;</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)addOperation<br>&#123;<br>    <span class="hljs-type">NSOperationQueue</span> <span class="hljs-operator">*</span>queue <span class="hljs-operator">=</span> [[<span class="hljs-type">NSOperationQueue</span> alloc] <span class="hljs-keyword">init</span>];<br>    <br>    <span class="hljs-type">NSInvocationOperation</span> <span class="hljs-operator">*</span>op1 <span class="hljs-operator">=</span> [[<span class="hljs-type">NSInvocationOperation</span> alloc] <br>    initWithTarget:<span class="hljs-keyword">self</span> <br>    selector:<span class="hljs-meta">@selector</span>(run) <br>    object:<span class="hljs-literal">nil</span>];<br>    <br>    <span class="hljs-type">NSBlockOperation</span> <span class="hljs-operator">*</span>op2 <span class="hljs-operator">=</span> [<span class="hljs-type">NSBlockOperation</span> <br>    blockOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++æ‰§è¡Œblockä»»åŠ¡ï¼Œ</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>, <br>        [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    [queue addOperation:op1];<br>    [queue addOperation:op2];<br>&#125;<br><br><span class="hljs-operator">-</span> (void)run<br>&#123;<br>    <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++æ‰§è¡Œinvocation operationä»»åŠ¡ï¼Œ</span><br><span class="hljs-string">    <span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»çº¿ç¨‹è°ƒç”¨ä¹‹åï¼Œè¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fortran">++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x604000268cc0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++æ‰§è¡Œinvocation operationä»»åŠ¡ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x604000268c80&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">4</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹4ï¼š-addOperationWithBlock:(void (^)(void))block;</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)addBlockOperation<br>&#123;<br>    <span class="hljs-type">NSOperationQueue</span> <span class="hljs-operator">*</span>queue <span class="hljs-operator">=</span> [[<span class="hljs-type">NSOperationQueue</span> alloc] <span class="hljs-keyword">init</span>];<br>    <span class="hljs-comment">//æœ€å¤§å¹¶å‘æ•°</span><br>    <span class="hljs-comment">//queue.maxConcurrentOperationCount = 1;</span><br>    <span class="hljs-comment">//queue.maxConcurrentOperationCount = 2;</span><br>    <br>    [queue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++æ‰§è¡Œblockä»»åŠ¡1ï¼Œ</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    [queue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++æ‰§è¡Œblockä»»åŠ¡2ï¼Œ</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    [queue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++æ‰§è¡Œblockä»»åŠ¡3ï¼Œ</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    [queue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++æ‰§è¡Œblockä»»åŠ¡4ï¼Œ</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++çº¿ç¨‹:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»çº¿ç¨‹è°ƒç”¨ä¹‹åï¼Œè¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs fortran">++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡<span class="hljs-number">3</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x60000046c180&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡<span class="hljs-number">4</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x60000046c1c0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">5</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡<span class="hljs-number">1</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x60400026a000&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">4</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡<span class="hljs-number">2</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x60400026a280&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">6</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br></code></pre></td></tr></table></figure><p>ç»“åˆ NSOperationQueue åï¼Œä»»åŠ¡éƒ½åœ¨ä¸åŒçº¿ç¨‹é‡Œå¹¶å‘æ‰§è¡Œï¼Œå…·å¤‡äº†å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</p><h4 id="3-3-å¹¶å‘æ•°"><a href="#3-3-å¹¶å‘æ•°" class="headerlink" title="3.3.å¹¶å‘æ•°"></a>3.3.å¹¶å‘æ•°</h4><ul><li>-1ï¼Œé»˜è®¤å€¼ï¼Œè¡¨ç¤ºä¸è¿›è¡Œé™åˆ¶ï¼Œé»˜è®¤ä¸ºå¹¶å‘æ‰§è¡Œï¼›</li><li>&#x3D;0ï¼Œé˜»å¡ã€éƒ½ä¸æ‰§è¡Œï¼›</li><li>&#x3D;1ï¼Œä¸²è¡Œï¼›</li><li>&gt;1ï¼Œå¹¶å‘ï¼›</li></ul><p>ä¸Šé¢#ç¤ºä¾‹4ä¸­ï¼Œå¦‚æœè®© maxConcurrentOperationCount &#x3D; 1ï¼Œåˆ™é˜Ÿåˆ—ä¸ºä¸²è¡Œï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs fortran">++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡<span class="hljs-number">1</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x604000272240&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡<span class="hljs-number">2</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x604000272240&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡<span class="hljs-number">3</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x604000272240&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++æ‰§è¡Œ<span class="hljs-keyword">block</span>ä»»åŠ¡<span class="hljs-number">4</span>ï¼Œ<br>++++çº¿ç¨‹:&lt;NSThread: <span class="hljs-number">0</span>x604000272240&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æŒ‰ç…§ä¸²è¡Œçš„æ–¹å¼åœ¨æ‰§è¡Œã€‚ä¸è®¾ç½®æˆ–è€…&#x3D;2æ—¶ï¼Œä»»åŠ¡ä¼šå¹¶å‘æ‰§è¡Œï¼Œå¼€å¯çº¿ç¨‹æ•°é‡æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„ï¼Œä¸éœ€è¦æˆ‘ä»¬æ¥ç®¡ç†ã€‚</p><h4 id="3-4-ä¾èµ–å…³ç³»"><a href="#3-4-ä¾èµ–å…³ç³»" class="headerlink" title="3.4.ä¾èµ–å…³ç³»"></a>3.4.ä¾èµ–å…³ç³»</h4><p>#ç¤ºä¾‹5ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)dependenceGo<br>&#123;<br>    <span class="hljs-built_in">NSOperationQueue</span> *queue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop1&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop2&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop3&quot;</span>);<br>    &#125;];<br>    <br>    [op1 addDependency:op2];<br>    [op2 addDependency:op3];<br>    <br>    [queue addOperation:op1];<br>    [queue addOperation:op2];<br>    [queue addOperation:op3];<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œop3</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œop2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œop1</span><br></code></pre></td></tr></table></figure><p>å¦‚æœä¸æ·»åŠ ä¾èµ–ï¼Œåˆ™3ä¸ªä»»åŠ¡ä¼šå¹¶å‘æ‰§è¡Œï¼Œå…ˆåé¡ºåºä¸å®šã€‚æ·»åŠ ä¾èµ–åï¼Œ3ä¸ªä»»åŠ¡åˆ™æŒ‰ç…§è®¾å®šå€’åºæ‰§è¡Œã€‚</p><h4 id="3-5-å–æ¶ˆä»»åŠ¡"><a href="#3-5-å–æ¶ˆä»»åŠ¡" class="headerlink" title="3.5.å–æ¶ˆä»»åŠ¡"></a>3.5.å–æ¶ˆä»»åŠ¡</h4><ul><li>å–æ¶ˆå•ä¸ªä»»åŠ¡</li></ul><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">- (<span class="hljs-keyword">void</span>)cancel;<span class="hljs-comment">//NSOperationçš„æ–¹æ³• å–æ¶ˆå•ä¸ªä»»åŠ¡ã€‚</span><br></code></pre></td></tr></table></figure><p>ä½œç”¨ï¼š<code>å»ºè®®</code>operationå¯¹è±¡åœæ­¢æ‰§è¡Œå®ƒåŒ…å«ç€çš„ä»»åŠ¡ã€‚</p><blockquote><p>Advises the operation object that it should stop executing its task.</p></blockquote><p>æ³¨æ„è¿™ä¸ªæ–¹æ³•å¹¶ä¸ä¼šå¼ºåˆ¶ä½ çš„operationå¯¹è±¡åœæ­¢æ‰§è¡Œï¼Œå®ƒåªæ˜¯æ›´æ–°å¯¹è±¡ä¸­çš„æ ‡è®°ä½æ¥åæ˜ ä»»åŠ¡çŠ¶æ€çš„å˜åŒ–ã€‚å¦‚æœä»»åŠ¡å·²ç»å®Œæˆï¼Œåˆ™å–æ¶ˆå¯¹å®ƒæ²¡æœ‰å½±å“ï¼›å¦‚æœæ˜¯åœ¨æŸä¸ªé˜Ÿåˆ—ä¸­ä½†å°šæœªå¼€å§‹çš„ä»»åŠ¡ï¼Œåˆ™æ‰§è¡Œå–æ¶ˆæ“ä½œæ—¶ä»»åŠ¡ä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</p><blockquote><p>This method does not force your operation code to stop. Instead, it updates the objectâ€™s internal flags to reflect the change in state. If the operation has already finished executing, this method has no effect. Canceling an operation that is currently in an operation queue, but not yet executing, makes it possible to remove the operation from the queue sooner than usual.<br>In macOS 10.6 and later, if an operation is in a queue but waiting on unfinished dependent operations, those operations are subsequently ignored. Because it is already cancelled, this behavior allows the operation queue to call the operationâ€™s start method sooner and clear the object out of the queue. If you cancel an operation that is not in a queue, this method immediately marks the object as finished. In each case, marking the object as ready or finished results in the generation of the appropriate KVO notifications.<br>In versions of macOS prior to 10.6, an operation object remains in the queue until all of its dependencies are removed through the normal processes. Thus, the operation must wait until all of its dependent operations finish executing or are themselves cancelled and have their start method called.<br>For more information on what you must do in your operation objects to support cancellation, see Responding to the Cancel Command.</p></blockquote><p>Xcode æ–¹æ³•è¯¦æƒ…é¢æ¿ä¸­æåˆ°ä¸€ç‚¹ï¼Œåœ¨macOS10.6ä¹‹å‰æ­¤å–æ¶ˆæ–¹æ³•å¹¶ä¸ä¼šç«‹åˆ»å°†å½“å‰operationç§»å‡ºé˜Ÿåˆ—ï¼Œè€Œæ˜¯è¦å¾…åˆ°å®ƒæ‰€ä¾èµ–çš„å…¶ä»–operationå…¨éƒ¨æ‰§è¡Œå®Œï¼Œæˆ–è€…æ˜¯éƒ½è¢«å–æ¶ˆå¹¶ä¸”æ‰§è¡Œå®Œå®ƒä»¬çš„startæ–¹æ³•ã€‚è€Œåœ¨macOS10.6ä¹‹åï¼Œå–æ¶ˆä¸€ä¸ªoperationæ—¶ä¼šè‡ªåŠ¨å¿½ç•¥å®ƒæ‰€ä¾èµ–çš„å…¶ä»–operationï¼Œå¹¶ä¸”é˜Ÿåˆ—ä¼šæå‰è°ƒç”¨å½“å‰operationçš„startæ–¹æ³•ï¼Œéšåå°†å…¶ç§»å‡ºé˜Ÿåˆ—ã€‚å¦‚æœä½ å–æ¶ˆäº†ä¸€ä¸ªå°šæœªåŠ å…¥é˜Ÿåˆ—ä¸­çš„operationï¼Œåˆ™operationä¼šç«‹åˆ»è¢«æ ‡è®°ä¸ºfinishedã€‚</p><br/><p>ä¸Šé¢è¿™æ®µè¯æç¤ºæˆ‘ä»¬ï¼Œ<strong>å³ä½¿operationè¢«å–æ¶ˆäº†ï¼Œoperationä¸­çš„startæ–¹æ³•ä»ä¼šè¢«è°ƒç”¨</strong>ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨é‡å†™operationçš„startæ–¹æ³•æ—¶ï¼Œè¦æ³¨æ„æ£€æµ‹å½“å‰ä»»åŠ¡çš„<code>isCancelled</code>å±æ€§ï¼Œå¦‚æœä»»åŠ¡å·²ç»è¢«å–æ¶ˆåˆ™åº”ç«‹åˆ»è¿”å›ï¼Œä¸å†ç»§ç»­åç»­æ“ä½œã€‚</p><ul><li>å–æ¶ˆæ‰€æœ‰ä»»åŠ¡</li></ul><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">- (<span class="hljs-keyword">void</span>)cancelAllOperations;<span class="hljs-comment">//NSOperationQueueçš„æ–¹æ³•ï¼Œå–æ¶ˆé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚</span><br></code></pre></td></tr></table></figure><p>ä½œç”¨ï¼šå–æ¶ˆé˜Ÿåˆ—ä¸­æ‰€æœ‰çš„operationï¼ŒåŒ…æ‹¬å°šæœªæ‰§è¡Œå’Œå·²æ‰§è¡Œçš„operationã€‚</p><blockquote><p>This method calls the cancel method on all operations currently in the queue.<br>Canceling the operations does not automatically remove them from the queue or stop those that are currently executing. For operations that are queued and waiting execution, the queue must still attempt to execute the operation before recognizing that it is canceled and moving it to the finished state. For operations that are already executing, the operation object itself must check for cancellation and stop what it is doing so that it can move to the finished state. In both cases, a finished (or canceled) operation is still given a chance to execute its completion block before it is removed from the queue.</p></blockquote><p>æ­¤æ–¹æ³•ä¼šè°ƒç”¨é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰operationçš„cancelæ–¹æ³•ï¼Œä½†ä¸ä¼šç«‹åˆ»å°†è¿™äº›operationç§»å‡ºé˜Ÿåˆ—ï¼Œä¹Ÿä¸ä¼šç«‹åˆ»åœæ­¢æ­£åœ¨æ‰§è¡Œçš„operationã€‚å¯¹äºå°šæœªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œé˜Ÿåˆ—ä»ç„¶ä¼šå»å°è¯•æ‰§è¡Œå®ƒä»¬ï¼Œå³å‰é¢æåˆ°çš„ç»§ç»­æ‰§è¡Œstartæ–¹æ³•ï¼Œç›´åˆ°æ£€æµ‹åˆ°ä»»åŠ¡è¢«å–æ¶ˆå¹¶ä¸”å…¶çŠ¶æ€ä¸ºfinishedã€‚å¯¹äºæ­£åœ¨æ‰§è¡Œä¸­çš„operationï¼Œå…¶å†…éƒ¨å¿…é¡»æ£€æŸ¥<code>isCancelled</code>å±æ€§æ˜¯å¦ä¸ºYESï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦ç«‹åˆ»åœæ­¢åç»­æ“ä½œã€‚è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œè¢«å–æ¶ˆæˆ–çŠ¶æ€ä¸ºfinishedçš„operationæ²¡æœ‰è¢«ç«‹åˆ»åœæ­¢å’Œç§»å‡ºé˜Ÿåˆ—ï¼Œä»è€Œè®©å®ƒä»¬è¿˜æœ‰æœºä¼šæ‰§è¡Œè‡ªå·±çš„å®Œæˆå›è°ƒã€‚</p><h4 id="3-6-æš‚åœ-x2F-æ¢å¤"><a href="#3-6-æš‚åœ-x2F-æ¢å¤" class="headerlink" title="3.6.æš‚åœ&#x2F;æ¢å¤"></a>3.6.æš‚åœ&#x2F;æ¢å¤</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)setSuspended:(<span class="hljs-type">BOOL</span>)b; <span class="hljs-comment">// NSOperationQueueä¸­çš„æ–¹æ³•</span><br></code></pre></td></tr></table></figure><p>ä½œç”¨ï¼šæš‚åœæˆ–æ¢å¤å½“å‰é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„operationsã€‚</p><blockquote><p>When the value of this property is NO, the queue actively starts operations that are in the queue and ready to execute. Setting this property to YES prevents the queue from starting any queued operations, but already executing operations continue to execute. You may continue to add operations to a queue that is suspended but those operations are not scheduled for execution until you change this property to NO.<br>Operations are removed from the queue only when they finish executing. However, in order to finish executing, an operation must first be started. Because a suspended queue does not start any new operations, it does not remove any operations (including cancelled operations) that are currently queued and not executing.<br>You may monitor changes to the value of this property using Key-value observing. Configure an observer to monitor the suspended key path of the operation queue.<br>The default value of this property is NO.</p></blockquote><p>è¯¥å­—æ®µæ˜¯é˜Ÿåˆ—çš„ä¸€ä¸ªå±æ€§ï¼Œå½“å€¼ä¸ºNOæ—¶ï¼Œé˜Ÿåˆ—ä¼šstarté˜Ÿåˆ—ä¸­å·²å‡†å¤‡å°±ç»ªçš„ä»»åŠ¡ï¼›å€¼ä¸ºYESæ—¶ï¼Œé˜Ÿåˆ—ä¼šæš‚æ—¶åœæ­¢starté˜Ÿåˆ—ä¸­å°šæœªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå·²ç»åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œã€‚å·²ç»è¢«æš‚åœçš„é˜Ÿåˆ—å†å¾€å…¶ä¸­æ·»åŠ ä»»åŠ¡æ—¶ï¼Œè¿™äº›ä»»åŠ¡ä¹Ÿä¼šè¢«æš‚åœï¼Œç›´åˆ°æš‚åœçŠ¶æ€è§£é™¤ã€‚<br><br/></p><p>operationåªæœ‰åœ¨finishedçŠ¶æ€æ—¶æ‰ä¼šä»é˜Ÿåˆ—ä¸­å‡ºåˆ—ï¼Œè¦æƒ³è®©ä¸€ä¸ªä»»åŠ¡finishedï¼Œä½ å¿…é¡»å…ˆstartæ­¤ä»»åŠ¡ï¼›è€Œæš‚åœçŠ¶æ€çš„é˜Ÿåˆ—å¹¶ä¸ä¼šstartä»»ä½•æ–°çš„ä»»åŠ¡ï¼Œæ‰€ä»¥é˜Ÿåˆ—ä¹Ÿå°±ä¸ä¼šç§»é™¤ä»»ä½•ä»»åŠ¡ï¼ŒåŒ…æ‹¬å·²ç»è¢«cancelçš„ä»»åŠ¡ã€‚<br><br/></p><p>è¿™å¥è¯éšå«çš„åœºæ™¯æ˜¯ï¼šä¸€ä¸ªå·²ç»è¢«æš‚åœçš„é˜Ÿåˆ—ä¸­æœ‰Nä¸ªä»»åŠ¡ï¼Œå…¶ä¸­ä»»åŠ¡Aè¿˜åœ¨æ’é˜Ÿä¸­å°šæœªå¼€å§‹æ‰§è¡Œï¼Œæ­¤æ—¶å¯¹ä»»åŠ¡Aæ‰§è¡Œcancelæ–¹æ³•ï¼Œåˆ™ä»»åŠ¡Aä¸ä¼šå‡ºåˆ—ã€‚è¿™æ˜¯å› ä¸ºæ­¤æ—¶é˜Ÿåˆ—åœ¨æš‚åœçŠ¶æ€ï¼Œä»»åŠ¡Aåˆæ²¡å¼€å§‹æ‰§è¡Œï¼Œæ‰€ä»¥å…¶startæ–¹æ³•ä¹Ÿå°±ä¸ä¼šè¢«è°ƒç”¨ï¼ŒisFinishedçŠ¶æ€ä¹Ÿå°±è¿˜ä¸æ˜¯YESï¼Œå› æ­¤ä¹Ÿå°±ä¸ä¼šå‡ºåˆ—~</p><br/><p><strong>å°ç»“</strong>ï¼šå¯¹äºä¸Šé¢ä¸‰ä¸ªæ–¹æ³•ï¼Œå¯ä»¥è¿™ä¹ˆç®€å•çš„ç†è§£ï¼Œoperationå¿…é¡»è·‘èµ·æ¥æ‰èƒ½æ›´æ–°å’Œæ£€æµ‹è‡ªå·±çš„isCanceledåŠisFinishedçŠ¶æ€ï¼Œä»è€Œå†³å®šè‡ªå·±æ˜¯ä¸æ˜¯è¯¥å–æ¶ˆå’Œå‡ºåˆ—ã€‚</p><h3 id="4-å®ç°Groupä»»åŠ¡"><a href="#4-å®ç°Groupä»»åŠ¡" class="headerlink" title="4.å®ç°Groupä»»åŠ¡"></a>4.å®ç°Groupä»»åŠ¡</h3><p>GCDä¸­æä¾›äº†<code>dispatch_group</code>ä»¥ä¾¿å°†å¤šä¸ªä»»åŠ¡ç»„åˆåœ¨ä¸€èµ·ï¼ŒåŒæ—¶å¯ä»¥åœ¨è¿™äº›ä»»åŠ¡æ‰§è¡Œå®Œæˆåé€šè¿‡<code>dispatch_group_notify</code>çš„blockæ‰§è¡ŒæŸäº›ç‰¹æ®Šä»»åŠ¡ã€‚NSOperationå¹¶æ²¡æœ‰<code>Group</code>ç›¸å…³å­—çœ¼çš„æ¥å£ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥åœ¨NSOperationå·²æœ‰æ¥å£çš„åŸºç¡€ä¸Šå˜ç›¸å®ç°æ­¤åŠŸèƒ½ã€‚</p><h4 id="4-1-é€šè¿‡ä¾èµ–å…³ç³»"><a href="#4-1-é€šè¿‡ä¾èµ–å…³ç³»" class="headerlink" title="4.1.é€šè¿‡ä¾èµ–å…³ç³»"></a>4.1.é€šè¿‡ä¾èµ–å…³ç³»</h4><p>æ€è·¯ï¼šç»™å°è£…äº†æœ€åä»»åŠ¡çš„ Operation è®¾ç½®ä¾èµ–å…³ç³»ï¼Œä½¿å…¶ä¾èµ–äºå‰é¢çš„æ‰€æœ‰ä»»åŠ¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)monitorGroupTasks<br>&#123;<br>    <span class="hljs-built_in">NSOperationQueue</span> *queue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop1&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop2&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop3&quot;</span>);<br>    &#125;];<br>    <br>    <span class="hljs-comment">//æœ€åéœ€è¦æ‰§è¡Œçš„UIä»»åŠ¡</span><br>    <span class="hljs-built_in">NSBlockOperation</span> *finOp = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æœ€åæ‰§è¡ŒUIä»»åŠ¡~&quot;</span>);<br>        &#125;);<br>    &#125;];<br>    <br>    <span class="hljs-comment">//æ·»åŠ ä¾èµ–ï¼Œè®©finOpä¾èµ–äºGropä¸­çš„æ‰€æœ‰ä»»åŠ¡</span><br>    [finOp addDependency:op1];<br>    [finOp addDependency:op2];<br>    [finOp addDependency:op3];<br>    <br>    [queue addOperations:@[finOp,op3,op2,op1] waitUntilFinished:<span class="hljs-literal">NO</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œop2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œop1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">æ‰§è¡Œop3</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">æœ€åæ‰§è¡ŒUIä»»åŠ¡~</span><br></code></pre></td></tr></table></figure><h4 id="4-2-é€šè¿‡completionBlock"><a href="#4-2-é€šè¿‡completionBlock" class="headerlink" title="4.2.é€šè¿‡completionBlock"></a>4.2.é€šè¿‡completionBlock</h4><p>æ€è·¯ï¼šNSBlockOperationä¸­çš„<code>addExecutionBlock</code>æ¥å£å¯ä»¥ç»™<code>operation</code>æ·»åŠ é¢å¤–ä»»åŠ¡å¹¶åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ‰§è¡Œã€‚åŒæ—¶NSOperationæä¾›äº†<code>completionBlock</code>å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥åœ¨æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰§è¡ŒæŸä¸ªç‰¹æ®Šä»»åŠ¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)monitorGroupTasks<br>&#123;<br>    <span class="hljs-built_in">NSBlockOperation</span> *blockOpration = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop1ï¼Œçº¿ç¨‹:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    &#125;];<br>    [blockOpration addExecutionBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop2ï¼Œçº¿ç¨‹:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    &#125;];<br>    [blockOpration addExecutionBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œop3ï¼Œçº¿ç¨‹:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    <span class="hljs-comment">//æœ€åéœ€è¦æ‰§è¡Œçš„UIä»»åŠ¡</span><br>    [blockOpration setCompletionBlock:^&#123;<br>        <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æœ€åæ‰§è¡ŒUIä»»åŠ¡~ï¼Œçº¿ç¨‹:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>        &#125;);<br>    &#125;];<br><br>    <span class="hljs-comment">//å¼€å¯ä»»åŠ¡</span><br>    <span class="hljs-built_in">NSOperationQueue</span> *queue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    [queue addOperation:blockOpration];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">++++æ‰§è¡Œop1ï¼Œçº¿ç¨‹:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003594d40</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 3, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++æ‰§è¡Œop3ï¼Œçº¿ç¨‹:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x6000035d9c80</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 5, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++æ‰§è¡Œop2ï¼Œçº¿ç¨‹:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x6000035eeb40</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 4, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++æœ€åæ‰§è¡ŒUIä»»åŠ¡~ï¼Œçº¿ç¨‹:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x6000035f5dc0</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><br></code></pre></td></tr></table></figure><h3 id="5-è‡ªå®šä¹‰NSOperation"><a href="#5-è‡ªå®šä¹‰NSOperation" class="headerlink" title="5.è‡ªå®šä¹‰NSOperation"></a>5.è‡ªå®šä¹‰NSOperation</h3><p>è‡ªå®šä¹‰æ—¶ï¼Œéœ€è¦é‡å†™ NSOperation çš„<code>start</code>æˆ–<code>main</code>æ–¹æ³•ã€‚</p><h4 id="5-1-é‡å†™main"><a href="#5-1-é‡å†™main" class="headerlink" title="5.1.é‡å†™main"></a>5.1.é‡å†™main</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (void)main<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><a href="https://developer.apple.com/documentation/foundation/nsoperation/1407732-main?language=objc">Performs the receiverâ€™s non-concurrent task</a>ï¼Œæ‰§è¡Œéå¹¶å‘ä»»åŠ¡æ—¶é‡å†™æ­¤å‡½æ•°ã€‚<br><br/></p><p>NSOperation é»˜è®¤æ˜¯éå¹¶å‘çš„ï¼Œåœ¨ä¸åŠ å…¥ Queue çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡è°ƒç”¨ <code>-(void)start</code> å¯¹è±¡æ–¹æ³•åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œ ä¼šä¸€ç›´é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚<code>-(void)main</code>æ–¹æ³•é»˜è®¤æƒ…å†µä¸‹ä¸åšä»»ä½•äº‹ï¼Œæ‰§è¡Œå®Œæˆåå±æ€§<code>isExecuting</code>ä¼šè¢«ç½®ä¸º NOï¼Œ å±æ€§<code>isFinished</code>è¢«ç½®ä¸º YESã€‚æˆ‘ä»¬å¯ä»¥é‡å†™æ­¤æ–¹æ³•ä»¥å®ç°è‡ªå®šä¹‰çš„ä»»åŠ¡ã€‚é‡å†™æ—¶ä¸èƒ½è°ƒç”¨<code>super</code>ï¼Œä¹Ÿä¸éœ€è¦æ‰‹åŠ¨åˆ›å»º autorelease poolï¼Œå› ä¸ºç³»ç»Ÿå·²è‡ªåŠ¨å¸®ä½ å®ç°ã€‚<br><br/></p><p>#ç¤ºä¾‹6ï¼šè‡ªå®šä¹‰éå¹¶å‘ NSOperation</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lua">- (void)main<br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.isCancelled) <span class="hljs-keyword">return</span>;<br>    NSData *imageData = <span class="hljs-string">[[NSData alloc] initWithContentsOfURL:</span><br><span class="hljs-string">    [NSURL URLWithString:_mUrlStr]]</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.isCancelled) &#123;<br>        imageData = <span class="hljs-literal">nil</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.isCancelled) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:@selector(downloadFinishedWithData:)]) &#123;<br>        [_delegate downloadFinishedWithData:imageData];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-é‡å†™start"><a href="#5-2-é‡å†™start" class="headerlink" title="5.2.é‡å†™start"></a>5.2.é‡å†™start</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">- (<span class="hljs-type">void</span>)<span class="hljs-keyword">start</span>;<br></code></pre></td></tr></table></figure><p><a href="https://developer.apple.com/documentation/foundation/nsoperation/1416837-start?language=objc">Begins the execution of the operation</a>ï¼ŒIf you are implementing a concurrent operation, you must override this method and use it to initiate your operationã€‚<br><br/></p><p>æ‰§è¡Œå¹¶å‘ä»»åŠ¡æ—¶â€œå¿…é¡»â€é‡å†™æ­¤æ–¹æ³•ã€‚<br><br/></p><p>åœ¨æ²¡æœ‰è¢«é‡å†™æ—¶ï¼Œ<code>start</code>æ–¹æ³•çš„é»˜è®¤å®ç°é‡Œä¼šæ›´æ–°å½“å‰ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œä¹‹åæ‰§è¡Œ<code>-main</code>å‡½æ•°ã€‚æ­¤æ–¹æ³•ä¹Ÿä¼šåšä¸€äº›æ£€æŸ¥ï¼Œä»¥ç¡®ä¿å½“å‰ä»»åŠ¡èƒ½æ­£å¸¸æ‰§è¡Œï¼šå¦‚æœä»»åŠ¡å·²è¢«å–æ¶ˆæˆ–å·²å®Œæˆï¼Œåˆ™<code>-start</code>æ–¹æ³•ç›´æ¥è¿”å›å¹¶ä¸”ä¸ä¼šå†è°ƒç”¨<code>-main</code>æ–¹æ³•ï¼›å¦‚æœä»»åŠ¡æ­£åœ¨æ‰§è¡Œæˆ–è€…å°šæœªå‡†å¤‡å°±ç»ªï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼›</p><blockquote><p>An operation is not considered ready to execute if it is still dependent on other operations that have not yet finished.</p></blockquote><p>é‡å†™<code>start</code>æ–¹æ³•æ—¶ä¹Ÿä¸èƒ½è°ƒç”¨<code>super</code>å‡½æ•°ï¼Œå¦å¤–éœ€è¦åŠæ—¶æ›´æ–° isExecuting å’Œ isFinished å±æ€§ï¼Œå¹¶å‘å‡ºå¯¹åº”çš„ KVO é€šçŸ¥ï¼Œå› ä¸ºåœ¨å¹¶å‘æƒ…å†µä¸‹ç³»ç»Ÿä¸çŸ¥é“ä»»åŠ¡ä»€ä¹ˆæ—¶å€™å®Œæˆã€‚è‡ªå®šä¹‰æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå°†ä»»åŠ¡å®šä¹‰ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´<code>start</code>å‡½æ•°è¿”å›äº†ä»»åŠ¡ä¸ä¸€å®šå°±æ˜¯å®Œæˆäº†ã€‚ è¿™ä¸ªè¦ä½ è‡ªå·±æ¥æ§åˆ¶ï¼Œåªæœ‰å°† isFinished ç½®ä¸º YES æ—¶ï¼Œoperation æ‰ç®—å®Œæˆï¼Œæ‰èƒ½å‡ºåˆ—å’Œé”€æ¯ã€‚</p><h4 id="5-3-è‡ªå®šä¹‰ç¤ºä¾‹"><a href="#5-3-è‡ªå®šä¹‰ç¤ºä¾‹" class="headerlink" title="5.3.è‡ªå®šä¹‰ç¤ºä¾‹"></a>5.3.è‡ªå®šä¹‰ç¤ºä¾‹</h4><p>#ç¤ºä¾‹7ï¼šè‡ªå®šä¹‰NSOperationå­ç±»</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//NetOperation.h</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">NetOperation</span>;</span><br><span class="hljs-comment">//ä»£ç†åè®®</span><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">NetOperationDelegate</span>&lt;<span class="hljs-title">NSObject</span>&gt;</span><br>- (<span class="hljs-type">void</span>)downloadFinishedWithData:(<span class="hljs-type">id</span>)data;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NetOperation</span> : <span class="hljs-title">NSOperation</span></span><br>- (<span class="hljs-keyword">instancetype</span>)initWithUrl:(<span class="hljs-built_in">NSString</span> *)url <br>delegate:(<span class="hljs-type">id</span>&lt;NetOperationDelegate&gt;)delegate;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//NetOperation.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;NetOperation.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NetOperation</span>()</span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *mUrlStr;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">weak</span>) <span class="hljs-type">id</span>&lt;NetOperationDelegate&gt;delegate;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSURLSessionDownloadTask</span> *dataTask;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NetOperation</span></span><br><span class="hljs-comment">//å› ä¸ºçˆ¶ç±»çš„å±æ€§æ˜¯readonlyçš„ï¼Œé‡è½½æ—¶å¦‚æœéœ€è¦setterçš„è¯åˆ™éœ€è¦æ‰‹åŠ¨åˆæˆã€‚</span><br><span class="hljs-keyword">@synthesize</span> finished = _finished, executing = _executing;<br><br><span class="hljs-comment">// è¿™é‡Œéœ€è¦å®ç°KVOç›¸å…³çš„æ–¹æ³•ï¼ŒNSOperationQueueæ˜¯é€šè¿‡KVOæ¥åˆ¤æ–­ä»»åŠ¡çŠ¶æ€çš„</span><br><br>- (<span class="hljs-type">void</span>)setFinished:(<span class="hljs-type">BOOL</span>)finished &#123;<br>    [<span class="hljs-keyword">self</span> willChangeValueForKey:<span class="hljs-string">@&quot;isFinished&quot;</span>];<br>    _finished = finished;<br>    [<span class="hljs-keyword">self</span> didChangeValueForKey:<span class="hljs-string">@&quot;isFinished&quot;</span>];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)setExecuting:(<span class="hljs-type">BOOL</span>)executing &#123;<br>    [<span class="hljs-keyword">self</span> willChangeValueForKey:<span class="hljs-string">@&quot;isExecuting&quot;</span>];<br>    _executing = executing;<br>    [<span class="hljs-keyword">self</span> didChangeValueForKey:<span class="hljs-string">@&quot;isExecuting&quot;</span>];<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)isAsynchronous&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-keyword">instancetype</span>)initWithUrl:(<span class="hljs-built_in">NSString</span> *)url<br>delegate:(<span class="hljs-type">id</span>&lt;NetOperationDelegate&gt;)delegate&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) &#123;<br>        _delegate = delegate;<br>        _mUrlStr = url;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)dealloc&#123;<br>    _delegate = <span class="hljs-literal">nil</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -é‡è½½startæ–¹æ³• å®ç°ä¸šåŠ¡éœ€æ±‚</span><br>- (<span class="hljs-type">void</span>)start &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.isCancelled) &#123;<br>            <span class="hljs-keyword">self</span>.finished = <span class="hljs-literal">YES</span>;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        [<span class="hljs-keyword">self</span> main];<br>        <span class="hljs-keyword">self</span>.executing = <span class="hljs-literal">YES</span>;<br>    &#125;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)cancel &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        [<span class="hljs-variable language_">super</span> cancel];<br>        <span class="hljs-comment">// å¦‚æœæ­£åœ¨æ‰§è¡Œä¸­åˆ™è¡¨ç¤ºå·²ç»startè¿‡ï¼Œå¯ä»¥å°†isFinishedè®¾ä¸ºyes</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.isExecuting) &#123;<br>            <span class="hljs-keyword">self</span>.finished = <span class="hljs-literal">YES</span>;<br>            <span class="hljs-keyword">self</span>.executing = <span class="hljs-literal">NO</span>;<br>        &#125;<br>        [_dataTask cancel];<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -BUSINESS</span><br>-(<span class="hljs-type">void</span>)main&#123;<br>    <span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sharedSession];<br>    __<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;<br>    _dataTask = [session downloadTaskWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:_mUrlStr]<br>    completionHandler:^(<span class="hljs-built_in">NSURL</span> *location,<span class="hljs-built_in">NSURLResponse</span> *response, <span class="hljs-built_in">NSError</span> *error) &#123;<br>        <span class="hljs-keyword">if</span> (!error) &#123;<br>            __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(weakSelf) strongSelf = weakSelf;<br>            <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfFile:location.path];<br>            strongSelf.finished = <span class="hljs-literal">YES</span>;<br>            strongSelf.executing = <span class="hljs-literal">NO</span>;<br>            <span class="hljs-keyword">if</span> ([strongSelf.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(downloadFinishedWithData:)]) &#123;<br>                [strongSelf.delegate downloadFinishedWithData:data];<br>            &#125;<br>        &#125;<br>    &#125;];<br>    <span class="hljs-comment">//å¼€å§‹ä»»åŠ¡</span><br>    [_dataTask resume];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>å¯¼å…¥å¤´æ–‡ä»¶ï¼Œåˆ›å»ºå¹¶æ‰§è¡Œä»»åŠ¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">-(<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application <br>willFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSOperationQueue</span> *aQueue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    NetOperation *anOperation = [[NetOperation alloc] initWithUrl:<span class="hljs-string">@&quot;xxx&quot;</span> delegate:<span class="hljs-keyword">self</span>];<br>    [aQueue addOperation:anOperation];<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)downloadFinishedWithData:(<span class="hljs-type">id</span>)data<br>&#123;<br>    <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> imageWithData:data];<br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++++Reqest Finished!&quot;</span>);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ¬ç¤ºä¾‹åªæ˜¯æœ€ç®€å•çš„è‡ªå®šä¹‰ï¼Œæ›´å¤æ‚çš„å¯ä»¥å‚è€ƒAFNå’ŒSDä¸­Operationç›¸å…³çš„ç±»~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW9">Â©Apple-Operation Queues</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¤šçº¿ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤šçº¿ç¨‹ï¼šGCD</title>
    <link href="/2017/11/08/gcd.html"/>
    <url>/2017/11/08/gcd.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1.ç®€ä»‹"></a>1.ç®€ä»‹</h3><p><code>GCD</code>æ˜¯è‹¹æœå…¬å¸åœ¨<code>çº¿ç¨‹æ± æ¨¡å¼</code>åŸºç¡€ä¸Šå¼€å‘çš„ä¸€å¥—å¤šæ ¸ç¼–ç¨‹çš„è¾ƒæ–°çš„è§£å†³æ–¹æ¡ˆã€‚å®ƒçš„ä¼˜ç‚¹æœ‰ï¼š</p><ul><li>åº•å±‚æ˜¯ç”±Cè¯­è¨€å®ç°ï¼ŒAPIä½¿ç”¨æ—¶ç®€æ´æ˜äº†ï¼›</li><li>ä¸ºå¤šæ ¸å¤„ç†å™¨è€Œè®¾è®¡ï¼Œä¼šè‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„CPUå†…æ ¸è¿›è¡Œè¿ç®—ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ï¼›</li><li>ä¼šè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸éœ€è¦æˆ‘ä»¬å†™ä»»ä½•çº¿ç¨‹ç®¡ç†çš„ä»£ç ï¼Œåªéœ€å‘Šè¯‰å®ƒæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li></ul><h3 id="2-åŒæ­¥ä¸å¼‚æ­¥"><a href="#2-åŒæ­¥ä¸å¼‚æ­¥" class="headerlink" title="2.åŒæ­¥ä¸å¼‚æ­¥"></a>2.åŒæ­¥ä¸å¼‚æ­¥</h3><p>GCDä¸­åŒæ­¥å’Œå¼‚æ­¥æ˜¯å°†ä»»åŠ¡ä»¥ block çš„å½¢å¼æäº¤åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­æ—¶ä½¿ç”¨çš„ä¸¤ç§æ–¹å¼ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">dispatch<span class="hljs-constructor">_sync(<span class="hljs-params">dispatch_queue_t</span> <span class="hljs-params">queue</span>, <span class="hljs-params">dispatch_block_t</span> <span class="hljs-params">block</span>)</span>;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>dispatch_sync</code>å‡½æ•°æ¥åŒæ­¥åœ°æ‰§è¡Œä»»åŠ¡ã€‚å‡½æ•°ä¼šä¸€ç›´ç­‰åˆ° blcok æ‰§è¡Œå®Œæ‰è¿”å›ï¼Œè¿™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">dispatch<span class="hljs-constructor">_async(<span class="hljs-params">dispatch_queue_t</span> <span class="hljs-params">queue</span>, <span class="hljs-params">dispatch_block_t</span> <span class="hljs-params">block</span>)</span>;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>dispatch_async</code>å‡½æ•°å¼‚æ­¥åœ°æ‰§è¡Œä»»åŠ¡ã€‚å‡½æ•°åœ¨æäº¤å®Œä»»åŠ¡åä¸ç­‰å¾… block æ‰§è¡Œå®Œå°±ç«‹åˆ»è¿”å›äº†ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚</p><h3 id="3-é˜Ÿåˆ—"><a href="#3-é˜Ÿåˆ—" class="headerlink" title="3.é˜Ÿåˆ—"></a>3.é˜Ÿåˆ—</h3><h4 id="1-ä¸²è¡Œä¸å¹¶å‘é˜Ÿåˆ—"><a href="#1-ä¸²è¡Œä¸å¹¶å‘é˜Ÿåˆ—" class="headerlink" title="1.ä¸²è¡Œä¸å¹¶å‘é˜Ÿåˆ—"></a>1.ä¸²è¡Œä¸å¹¶å‘é˜Ÿåˆ—</h4><p>å½“æœ‰å¤šä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å°†å®ƒä»¬æ”¾åœ¨é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œé˜Ÿåˆ—åˆ†ä¸ºä¸²è¡Œå’Œå¹¶å‘ä¸¤ç§ï¼š</p><p><strong>ä¸²è¡Œé˜Ÿåˆ—</strong>ï¼šä»»åŠ¡æ˜¯æŒ‰ç…§FIFOçš„é¡ºåºæ‰§è¡Œçš„ï¼Œå…ˆæäº¤çš„ä»»åŠ¡å…ˆæ‰§è¡Œï¼Œåæäº¤çš„ä»»åŠ¡é¡»ç­‰å‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆæ‰èƒ½å¼€å§‹ã€‚å¯¹äºä¸åŒçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œç³»ç»Ÿä¼šä¸ºå®ƒä»¬åˆ›å»ºä¸åŒçš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><p><strong>å¹¶å‘é˜Ÿåˆ—</strong>ï¼šä»»åŠ¡ä¹Ÿæ˜¯æŒ‰ç…§FIFOçš„é¡ºåºæ‰§è¡Œï¼Œä¸åŒçš„æ˜¯ï¼Œä»»åŠ¡ä¸æ˜¯å¿…é¡»ç­‰åˆ°å‰ä¸€ä¸ªæ‰§è¡Œå®Œæ‰å¼€å§‹ï¼ŒåŒä¸€æ—¶é—´å¯èƒ½ä¼šæœ‰å¤šä¸ªä»»åŠ¡åœ¨æ‰§è¡Œã€‚GCD ä¼šåŠ¨æ€åˆ†é…å¤šæ¡çº¿ç¨‹æ¥æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼Œå…·ä½“å‡ æ¡çº¿ç¨‹å–å†³äºå½“å‰å†…å­˜çŠ¶å†µå’Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°ç­‰å› ç´ ã€‚</p><p>#<strong>ç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ï¼š</strong> main_queue</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>ä¸»é˜Ÿåˆ—æœ¬èº«æ˜¯ç³»ç»Ÿæä¾›çš„ä¸€ç§ç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—<br><span class="hljs-regexp">//</span>æ”¾åœ¨ä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ<br>dispatch_queue_t mainQueue   = dispatch_get_main_queue();<br></code></pre></td></tr></table></figure><p>#<strong>ç‰¹æ®Šçš„å¹¶å‘é˜Ÿåˆ—ï¼š</strong> global_queue</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>å…¨å±€é˜Ÿåˆ—æ˜¯ç³»ç»Ÿæä¾›çš„ä¸€ç§ç‰¹æ®Šå¹¶å‘é˜Ÿåˆ—<br><span class="hljs-regexp">//</span>ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šqueueçš„ä¼˜å…ˆçº§,åˆ†ä¸ºHIGH\DEFAULT\LOW\BACKGROUNDå››ç§;<br><span class="hljs-regexp">//</span>ç¬¬äºŒä¸ªå‚æ•°ï¼Œç›®å‰åªèƒ½ä¸º<span class="hljs-number">0</span>æˆ–NULL;<br>dispatch_queue_t globalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_ PRIORITY_DEFAULT,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h4 id="2-ä»»åŠ¡-é˜Ÿåˆ—-çš„ç»„åˆ"><a href="#2-ä»»åŠ¡-é˜Ÿåˆ—-çš„ç»„åˆ" class="headerlink" title="2.ä»»åŠ¡+é˜Ÿåˆ— çš„ç»„åˆ"></a>2.ä»»åŠ¡+é˜Ÿåˆ— çš„ç»„åˆ</h4><table><thead><tr><th>.</th><th>å¹¶å‘é˜Ÿåˆ—</th><th>ä¸²è¡Œé˜Ÿåˆ—</th><th>ä¸»é˜Ÿåˆ—</th></tr></thead><tbody><tr><td>åŒæ­¥</td><td>ä¸èƒ½å¼€å¯æ–°çº¿ç¨‹,ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td>ä¸èƒ½å¼€å¯æ–°çº¿ç¨‹,ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td>ä¸èƒ½å¼€å¯æ–°çº¿ç¨‹,ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td></tr><tr><td>å¼‚æ­¥</td><td>å¯ä»¥å¼€å¯æ–°çº¿ç¨‹,å¹¶å‘æ‰§è¡Œä»»åŠ¡</td><td>å¯ä»¥å¼€å¯æ–°çº¿ç¨‹,ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td>ä¸èƒ½å¼€å¯æ–°çº¿ç¨‹,ä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td></tr></tbody></table><p>æ³¨æ„ï¼šä¸èƒ½å¼€å¯æ–°çº¿ç¨‹ï¼Œå°±è¦ç»§ç»­è¿è¡Œåœ¨å½“å‰çº¿ç¨‹ä¸­ã€‚</p><p>#ç¤ºä¾‹3.2.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="hljs-string">&quot;concurrent&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br>    <span class="hljs-built_in">dispatch_sync</span>(concurrentQueue, ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++Thread:%@,main?:%d&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread],[<span class="hljs-built_in">NSThread</span> isMainThread]);<br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨åè¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">+++Thread:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x6000000dca40</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml">,main?:1</span><br></code></pre></td></tr></table></figure><p>åˆ†æï¼šç¤ºä¾‹ä¸­å‘å¹¶å‘é˜Ÿåˆ—<code>concurrentQueue</code>ä¸­åŒæ­¥çš„æäº¤äº†ä¸€ä¸ªæ‰“å°æ—¥å¿—çš„ä»»åŠ¡ï¼Œè™½ç„¶å¹¶å‘é˜Ÿåˆ—å…·æœ‰å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä½†æ˜¯ç»“åˆä¸Š<code>dispatch_sync</code>ä¹‹åï¼Œå°±ä¸è¡Œäº†ï¼Œä»»åŠ¡ä¼šç»§ç»­è¿è¡Œåœ¨å½“å‰çš„ä¸»çº¿ç¨‹ä¸Šã€‚è¾“å‡ºç»“æœä¸­â€œname &#x3D; mainâ€ ä¸” â€œmain?:1â€ä¹Ÿå°è¯äº†è¿™ä¸€ç‚¹ã€‚</p><p>å†æ³¨æ„ï¼šå¯ä»¥å¼€å¯æ–°çº¿ç¨‹ï¼Œä¹Ÿä¸ä¸€å®šå°±çœŸçš„ä¼šå¼€è¾Ÿæ–°çº¿ç¨‹æ‰§è¡Œæ–°çš„ä»»åŠ¡ï¼Œç³»ç»Ÿè¦æ ¹æ®çº¿ç¨‹æ± ä¸­çš„çŠ¶å†µæ¥å†³å®šæ˜¯å¼€è¾Ÿæ–°çº¿ç¨‹ï¼Œè¿˜æ˜¯ç»§ç»­åœ¨å½“å‰ç©ºé—²çš„çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚</p><p>#ç¤ºä¾‹3.2.2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="hljs-string">&quot;concurrent&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br>    <span class="hljs-comment">//step.1</span><br>    <span class="hljs-built_in">dispatch_async</span>(concurrentQueue, ^&#123;<span class="hljs-comment">//å…·æœ‰å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++Thread1:%@,main?:%d&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread],[<span class="hljs-built_in">NSThread</span> isMainThread]);<br>        <span class="hljs-comment">//step.2</span><br>        <span class="hljs-built_in">dispatch_async</span>(concurrentQueue, ^&#123;<span class="hljs-comment">//å…·æœ‰å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›</span><br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++Thread2:%@,main?:%d&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread],[<span class="hljs-built_in">NSThread</span> isMainThread]);<br>            <span class="hljs-comment">//step.3</span><br>            <span class="hljs-built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++Thread3:%@,main?:%d&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread],[<span class="hljs-built_in">NSThread</span> isMainThread]);<br>            &#125;);<br>        &#125;);<br>        <span class="hljs-comment">//step.4</span><br><span class="hljs-comment">//        for (int i = 0; i&lt; 0xffffffff; i++)&#123;//forå¾ªç¯å¾ˆå¤šæ¬¡ï¼Œæ¨¡æ‹Ÿå¤§é‡è¿ç®—</span><br><span class="hljs-comment">//        &#125;</span><br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œåæ—¥å¿—ä¸ºï¼š</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">+++Thread1:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003bd5500</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 3, name = (null)&#125;</span><span class="language-xml">,main?:0</span><br><span class="language-xml">+++Thread2:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003bd5500</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 3, name = (null)&#125;</span><span class="language-xml">,main?:0</span><br><span class="language-xml">+++Thread3:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003bb1900</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml">,main?:1</span><br></code></pre></td></tr></table></figure><p><code>step1</code>å¤„ï¼Œå¼‚æ­¥+å¹¶å‘ï¼Œå·²å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä»æ—¥å¿—æ¥çœ‹ Thread1 â€œmain?:0â€ï¼Œå·²ç»ä¸åœ¨ä¸»çº¿ç¨‹ï¼Œå¼€å¯äº†æ–°çº¿ç¨‹ï¼›</p><p><code>step2</code>å¤„ï¼Œå¼‚æ­¥+å¹¶å‘ï¼Œä¹Ÿå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä»æ—¥å¿—æ¥çœ‹çº¿ç¨‹ Thread2 çš„åœ°å€â€œ0x600003bd5500â€ä¸ step1 æ—¶ä¸€æ ·ï¼Œè¯´æ˜ç»§ç»­è¿è¡Œåœ¨å½“å‰çº¿ç¨‹ä¸Šï¼Œå¹¶æ²¡æœ‰å¼€è¾Ÿæ–°çº¿ç¨‹~</p><p>ä¸è¿‡ï¼Œå¦‚æœæŠŠ<code>step4</code>å¤„çš„æ³¨é‡Šå»æ‰ï¼Œæ¨¡æ‹Ÿä¸€æ¬¡å¤æ‚è¿ç®—ï¼Œåˆ™è¾“å‡ºç»“æœå°±ä¸ä¸€æ ·äº†ï¼š</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">+++Thread1:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600000c98ec0</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 3, name = (null)&#125;</span><span class="language-xml">,main?:0</span><br><span class="language-xml">+++Thread2:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600000cab140</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 4, name = (null)&#125;</span><span class="language-xml">,main?:0</span><br><span class="language-xml">+++Thread3:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600000cfd900</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml">,main?:1</span><br></code></pre></td></tr></table></figure><p><code>Thread2</code>ä¸<code>Thread1</code>çš„åœ°å€å·²ç»ä¸ä¸€æ ·äº†ã€‚è¿™æ˜¯å› ä¸º<code>Thread1</code>ä¸­æœ‰å¤§é‡è¿ç®—ï¼Œ<code>Thread2</code>è¦å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚</p><p>æ‰€ä»¥ï¼ŒåŒ&#x2F;å¼‚æ­¥ + ä¸²&#x2F;å¹¶è¡Œçš„ç»„åˆï¼Œåªæ˜¯è¯´æ˜äº†ä»»åŠ¡æ‰€åœ¨é˜Ÿåˆ—ï¼Œä»»åŠ¡çš„æäº¤æ–¹å¼å’Œæ˜¯å¦å…·å¤‡å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚<strong>å½“å…·å¤‡å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›æ—¶ï¼Œæ˜¯å¦çœŸçš„å¼€è¾Ÿæ–°çº¿ç¨‹è¦ç”±çº¿ç¨‹æ± çš„çŠ¶å†µæ¥ç¡®å®š</strong>ã€‚</p><h4 id="3-æ­»é”é—®é¢˜"><a href="#3-æ­»é”é—®é¢˜" class="headerlink" title="3.æ­»é”é—®é¢˜"></a>3.æ­»é”é—®é¢˜</h4><p>ä¸èƒ½åœ¨ä¸»é˜Ÿåˆ—ä¸­ä½¿ç”¨â€œåŒæ­¥+ä¸»é˜Ÿåˆ—â€çš„ç»„åˆï¼Œä¸‹é¢å°±æ˜¯å…¸å‹çš„æ­»é”</p><p>#ç¤ºä¾‹3.3.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];<br>    <span class="hljs-comment">//step.1</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡å¼€å§‹&quot;</span>);<br>    <span class="hljs-built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();<br>    <br>    <span class="hljs-built_in">dispatch_sync</span>(mainQueue, ^&#123;<span class="hljs-comment">//step.2</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å¤„ç†ä»»åŠ¡A&quot;</span>);<br>    <span class="hljs-comment">//do something</span><br>    &#125;);<br><br>    <span class="hljs-comment">//step.3</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡ç»“æŸ&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç è¡Œåï¼Œåªä¼šè¾“å‡ºâ€œ++++ä»»åŠ¡å¼€å§‹â€ï¼Œå¹¶å¡æ­»åœ¨<code>dispatch_sync</code>è¿™ä¸€è¡Œã€‚è¿™æ˜¯å› ä¸ºï¼š<code>viewDidAppear</code>é»˜è®¤æ˜¯åœ¨ä¸»é˜Ÿåˆ—ä¸­ï¼Œå½“ä¸»é˜Ÿåˆ—æ‰§è¡Œåˆ° step2 æ—¶ï¼Œ<code>dispatch_sync</code>å‡½æ•°å‘ä¸»é˜Ÿåˆ—ä¸­æäº¤äº†ä¸€ä¸ªä»»åŠ¡(ä»»åŠ¡A)ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸»é˜Ÿåˆ—æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œä¸”æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œå®ƒé‡Œé¢çš„ä»»åŠ¡æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œï¼›<code>dispatch_sync</code>æäº¤ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¹¶ç«‹åˆ»å¼€å§‹æ‰§è¡Œå…¶ä¸­çš„ä»»åŠ¡ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸»çº¿ç¨‹æœ¬æ¥è¦æŒ‰é¡ºåºæ‰§è¡Œstep1ã€2ã€3ï¼Œç»“æœæ‰§è¡Œåˆ°<code>dispatch_sync</code>å‡½æ•°æ—¶è¢«å¼ºè¡Œé˜»å¡ï¼Œå¹¶è¢«è¦æ±‚ç«‹åˆ»å»æ‰§è¡Œä»»åŠ¡Aã€‚è€Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºä¸»é˜Ÿåˆ—ä¸­çš„åç»­ä»»åŠ¡step3å°šæœªå®Œæˆï¼Œä¸èƒ½å…ˆæ‰§è¡ŒååŠ å…¥è¿›æ¥çš„ä»»åŠ¡Aã€‚æ‰€ä»¥å½¢æˆä¸€ç§å±€é¢ï¼šä¸»é˜Ÿåˆ—åœ¨ç­‰å¾…ä»»åŠ¡Aå®Œæˆï¼Œä»»åŠ¡Aåˆåœ¨ç­‰å¾…ä¸»é˜Ÿåˆ—å®Œæˆåç»­ä»»åŠ¡stp3ï¼Œä»è€Œå½¢æˆäº†æ­»é”é—®é¢˜ã€‚</p><p>#ç¤ºä¾‹3.3.2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//å½“å‰åœ¨ä¸»çº¿ç¨‹</span><br><span class="hljs-built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="hljs-string">&quot;seria&quot;</span>, DISPATCH_QUEUE_SERIAL);<br><span class="hljs-built_in">dispatch_async</span>(serialQueue, ^&#123;<span class="hljs-comment">//block1</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;1&quot;</span>);<br>    <span class="hljs-built_in">dispatch_sync</span>(serialQueue, ^&#123;<span class="hljs-comment">// block2</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;2&quot;</span>);<br>    &#125;);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;3&quot;</span>);<br>&#125;);<br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;4&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ç¤ºä¾‹ä¸­ä¼šå…ˆæ‰“å°æ—¥å¿—â€œ4â€ï¼Œåæ‰“å°â€œ1â€ï¼Œä¹‹ååœ¨ <code>dispatch_sync</code> è¿™ä¸€è¡Œå¡æ­»ã€‚è¿™å…¶å®ä¸ç¤ºä¾‹1 ç±»ä¼¼ï¼šå› ä¸º block1 æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæ‰€ä»¥å‡½æ•°ç«‹åˆ»è¿”å›å¹¶æ‰“å°â€œ4â€ï¼›ä½†æ˜¯ block1 å†…ä»»åŠ¡æ˜¯åœ¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä¸­ï¼Œæ‰§è¡Œåˆ°<code>dispatch_sync</code>å¤„æ—¶çº¿ç¨‹è¢«é˜»å¡ï¼Œå¹¶è¢«è¦æ±‚ç«‹åˆ»åœ¨å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­å†æ‰§è¡Œä¸€ä¸ªæ–°ä»»åŠ¡ block2ã€‚è¿™å½“ç„¶ä¹Ÿè¡Œä¸é€šï¼Œå› ä¸ºå½“å‰çº¿ç¨‹å·²è¢«block2é˜»å¡ï¼Œblock2åˆåœ¨ç­‰å¾…é˜Ÿåˆ—å®Œæˆåç»­ä»»åŠ¡ã€‚è¿™æ ·ä¹Ÿé€ æˆäº†ç›¸äº’ç­‰å¾…çš„æƒ…å†µï¼Œå½¢æˆäº†æ­»é”ã€‚</p><p>å°ç»“ï¼š<strong>åœ¨å½“å‰ä¸²è¡Œé˜Ÿåˆ—Aä¸­å†åŒæ­¥åœ°æäº¤ä¸€ä¸ªæ–°ä»»åŠ¡åˆ°é˜Ÿåˆ—Aä¼šé€ æˆæ­»é”</strong>ï¼</p><h4 id="4-çº¿ç¨‹é—´çš„é€šä¿¡"><a href="#4-çº¿ç¨‹é—´çš„é€šä¿¡" class="headerlink" title="4.çº¿ç¨‹é—´çš„é€šä¿¡"></a>4.çº¿ç¨‹é—´çš„é€šä¿¡</h4><p>é€šå¸¸ä¸ºäº†é¿å…UIé˜»å¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­åšä¸€äº›è€—æ—¶çš„ä»»åŠ¡ï¼Œå®Œæˆåå›åˆ°ä¸»çº¿ç¨‹ä¸­æ›´æ–°UIã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;<br>    <span class="hljs-comment">//å›¾ç‰‡çš„ç½‘ç»œè·¯å¾„</span><br>    <span class="hljs-built_in">NSURL</span> *url = [<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@&quot;xxx.jpg&quot;</span>];<br>    <span class="hljs-comment">//åŠ è½½å›¾ç‰‡</span><br>    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfURL:url];<br>    <span class="hljs-comment">//ç”Ÿæˆå›¾ç‰‡</span><br>    <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> imageWithData:data];<br><br>    <span class="hljs-comment">//å›åˆ°ä¸»çº¿ç¨‹ï¼Œåˆ·æ–°UIï¼Œæ˜¾ç¤ºå›¾ç‰‡ã€‚</span><br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>        [<span class="hljs-keyword">self</span>.imageView setImage:image];<br>    &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p>ä¾‹å­åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ï¼Œdispatch_asyncé…åˆå…¨å±€å¹¶å‘é˜Ÿåˆ—ï¼Œå¼€è¾Ÿäº†ä¸€ä¸ªæ–°çº¿ç¨‹ç”¨æ¥åŠ è½½å›¾ç‰‡èµ„æºï¼›åŠ è½½å®Œæˆåå†é€šè¿‡dispatch_get_main_queueè¿”å›åˆ°ä¸»é˜Ÿåˆ—ä¸­æ›´æ–°è§†å›¾ã€‚å› ä¸ºä¸»é˜Ÿåˆ—é»˜è®¤åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥æ›´æ–°è§†å›¾çš„ä»»åŠ¡ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œã€‚</p><h4 id="5-çº¿ç¨‹ä¸é˜Ÿåˆ—"><a href="#5-çº¿ç¨‹ä¸é˜Ÿåˆ—" class="headerlink" title="5.çº¿ç¨‹ä¸é˜Ÿåˆ—"></a>5.çº¿ç¨‹ä¸é˜Ÿåˆ—</h4><p><code>çº¿ç¨‹</code>å’Œ<code>é˜Ÿåˆ—</code>æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µ~</p><p><code>é˜Ÿåˆ—</code>æ˜¯åœ¨çº¿ç¨‹æ± æ¨¡å¼åŸºç¡€ä¸Šçš„ä¸€ç§ä»»åŠ¡ç»„ç»‡æ–¹å¼ï¼Œä»»åŠ¡è¢«ä»¥ block çš„å½¢å¼æäº¤åˆ°<code>é˜Ÿåˆ—</code>ä¸­ï¼Œå¹¶æœ€ç»ˆåœ¨æŸä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå…·ä½“åœ¨å“ªä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œæ˜¯ç”±<code>é˜Ÿåˆ—ç±»å‹</code>å’Œ<code>æäº¤ä»»åŠ¡æ—¶çš„æ–¹å¼</code>å†³å®šçš„ã€‚å¦‚#3.2å°èŠ‚ä¸­åˆ—å‡ºçš„é‚£æ ·ï¼Œå¦‚æœæ˜¯<code>åŒæ­¥</code>çš„æ–¹å¼æäº¤ä»»åŠ¡ï¼Œåˆ™ä»»åŠ¡ä¼šç»§ç»­åœ¨å½“å‰çº¿ç¨‹ä¸Šæ‰§è¡Œï¼›å¦‚æœæ˜¯<code>å¼‚æ­¥+å¹¶å‘é˜Ÿåˆ—</code>çš„æ–¹å¼æäº¤çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šæ ¹æ®ç³»ç»Ÿèµ„æºåˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><p><code>çº¿ç¨‹</code>æ˜¯ CPU è°ƒåº¦å’Œåˆ†æ´¾ä»»åŠ¡çš„åŸºæœ¬å•ä½ï¼Œä¸€ä¸ª<code>çº¿ç¨‹</code>ä¸­å¯ä»¥æ‰§è¡Œå¤šä¸ª<code>é˜Ÿåˆ—</code>ä¸­çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ˜¯å¯ä»¥é‡å¤åˆ©ç”¨çš„ï¼Œè¿™ç”±çº¿ç¨‹æ± å’Œç³»ç»Ÿèµ„æºçŠ¶å†µæ¥å†³å®šã€‚</p><p><code>ä¸»çº¿ç¨‹</code>ä¸ç­‰äº<code>ä¸»é˜Ÿåˆ—</code>ã€‚ä¸»çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œä¸»çº¿ç¨‹ä¸Šæ—¢å¯ä»¥æ‰§è¡Œ<code>ä¸»é˜Ÿåˆ—</code>ä¸­çš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œ<code>å…¨å±€å¹¶å‘é˜Ÿåˆ—</code>æˆ–ä½ <code>è‡ªå®šä¹‰é˜Ÿåˆ—</code>ä¸­çš„ä»»åŠ¡ã€‚</p><p>#ç¤ºä¾‹ï¼šä¸»çº¿ç¨‹æ‰§è¡Œéä¸»é˜Ÿåˆ—çš„ä»»åŠ¡</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++1.ä¸»çº¿ç¨‹ï¼Ÿ:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> isMainThread] ? <span class="hljs-string">@&quot;YES&quot;</span> : <span class="hljs-string">@&quot;NO&quot;</span> );<span class="hljs-comment">//YES</span><br>    <br>    <span class="hljs-built_in">dispatch_sync</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;<span class="hljs-comment">//åŒæ­¥çš„æäº¤ä»»åŠ¡ï¼Œæ¨¡æ‹Ÿä»»åŠ¡è¿˜åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œ</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++2.ä¸»çº¿ç¨‹ï¼Ÿ:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> isMainThread] ? <span class="hljs-string">@&quot;YES&quot;</span> : <span class="hljs-string">@&quot;NO&quot;</span> );<span class="hljs-comment">//YES</span><br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åè¿‡æ¥ï¼Œ<code>ä¸»é˜Ÿåˆ—</code>çš„ä»»åŠ¡ä¸€å®šæ˜¯åœ¨<code>ä¸»çº¿ç¨‹</code>ä¸­æ‰§è¡Œçš„ï¼Œå…¨å±€å¹¶å‘é˜Ÿåˆ—æˆ–è‡ªå®šä¹‰é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åˆ™ä¹Ÿå¯ä»¥åœ¨<code>å­çº¿ç¨‹</code>ä¸­æ‰§è¡Œã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++1.ä¸»çº¿ç¨‹ï¼Ÿ:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> isMainThread] ? <span class="hljs-string">@&quot;YES&quot;</span> : <span class="hljs-string">@&quot;NO&quot;</span> );<span class="hljs-comment">//YES</span><br>    <br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<span class="hljs-comment">//è™½ç„¶å¼‚æ­¥æäº¤ä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä½†ä»»åŠ¡è¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++2.ä¸»çº¿ç¨‹ï¼Ÿ:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> isMainThread] ? <span class="hljs-string">@&quot;YES&quot;</span> : <span class="hljs-string">@&quot;NO&quot;</span> );<span class="hljs-comment">//YES</span><br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†è€…ï¼Œæˆ‘ä»¬å¾ˆå¤šè·Ÿ UI ç›¸å…³çš„æ“ä½œï¼Œä¸€èˆ¬éƒ½ä¼šæ”¾åˆ°<code>main_queue</code>ä¸»é˜Ÿåˆ—ä¸­è¿›è¡Œï¼Œæ¯”å¦‚å¸¸è§çš„<code>AFN</code>ä»å­çº¿ç¨‹å›åˆ°ä¸»é˜Ÿåˆ—æ›´æ–°å›¾ç‰‡ã€‚è¿™æ˜¯å› ä¸º<code>UIKit</code>æœ¬èº«ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™äº›æ“ä½œéœ€è¦åœ¨ç³»ç»Ÿæä¾›çš„<code>ä¸»é˜Ÿåˆ—</code>è¿™ä¹ˆä¸€ä¸ª<code>ä¸²è¡Œé˜Ÿåˆ—</code>ä¸­è¿›è¡Œï¼Œä¿è¯æ“ä½œçš„é¡ºåºå’Œå®Œæ•´æ€§ã€‚</p><h3 id="4-æ …æ "><a href="#4-æ …æ " class="headerlink" title="4.æ …æ "></a>4.æ …æ </h3><h4 id="1-dispatch-barrier-async"><a href="#1-dispatch-barrier-async" class="headerlink" title="1.dispatch_barrier_async"></a>1.dispatch_barrier_async</h4><p><strong>ä½œç”¨ï¼š</strong>è®©é˜Ÿåˆ—ä¸­æ’åœ¨å®ƒå‰é¢ä»»åŠ¡å…ˆæ‰§è¡Œå®Œæ¯•ï¼Œå†æ‰§è¡Œè‡ªå·±ï¼Œæœ€åå†æ‰§è¡Œåç»­ä»»åŠ¡ã€‚</p><p><strong>åœºæ™¯ï¼š</strong>å‘å¹¶å‘é˜Ÿåˆ—ä¸­åŠ å…¥5ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼š1ã€2ã€3ã€4ã€5ã€‚ç”±äºæ˜¯å¼‚æ­¥+å¹¶å‘ï¼Œæ‰€ä»¥ä»»åŠ¡å®é™…æ‰§è¡Œæ—¶å¹¶ä¸ä¸€å®šæŒ‰ç…§ 12345 çš„é¡ºåºæ¥ã€‚å¦‚æœæˆ‘ä»¬è¦æ±‚æ‰§è¡Œå®Œä»»åŠ¡ 3 ä¹‹åæ‰èƒ½æ‰§è¡Œä»»åŠ¡ 4 å’Œ 5ï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨<code>æ …æ </code>è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>#ç¤ºä¾‹4.1ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">- (void)barrier&#123;<br>    <span class="hljs-comment">//è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—</span><br>    dispatch_queue_t cQueue = dispatch<span class="hljs-constructor">_queue_create(<span class="hljs-string">&quot;Name1&quot;</span>,DISPATCH_QUEUE_CONCURRENT)</span>;<br>    <br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡1:%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡2:%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>    dispatch<span class="hljs-constructor">_barrier_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡3æ …æ :%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++1&quot;</span>)</span>;<br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡4:%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++2&quot;</span>)</span>;<br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡5:%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arcade">++++<span class="hljs-number">1</span><br>++++<span class="hljs-number">2</span><br>++++ä»»åŠ¡<span class="hljs-number">2</span>:&lt;NSThread: <span class="hljs-number">0x600003453f00</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">4</span>, name = (<span class="hljs-literal">null</span>)&#125;<br>++++ä»»åŠ¡<span class="hljs-number">1</span>:&lt;NSThread: <span class="hljs-number">0x600003455f00</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>, name = (<span class="hljs-literal">null</span>)&#125;<br>++++ä»»åŠ¡<span class="hljs-number">3</span>æ …æ :&lt;NSThread: <span class="hljs-number">0x600003455f00</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>, name = (<span class="hljs-literal">null</span>)&#125;<br>++++ä»»åŠ¡<span class="hljs-number">4</span>:&lt;NSThread: <span class="hljs-number">0x600003455f00</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>, name = (<span class="hljs-literal">null</span>)&#125;<br>++++ä»»åŠ¡<span class="hljs-number">5</span>:&lt;NSThread: <span class="hljs-number">0x600003453f00</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">4</span>, name = (<span class="hljs-literal">null</span>)&#125;<br></code></pre></td></tr></table></figure><p>ä»æ—¥å¿—æ¥çœ‹ï¼Œä»»åŠ¡çš„æ‰§è¡Œé¡ºåºæ­£å¸¸ï¼š</p><ul><li>æ …æ ä¹‹å‰çš„ä»»åŠ¡1å’Œ2å…ˆæ‰§è¡Œ;</li><li>éšåæ˜¯æ …æ æœ¬èº«çš„ä»»åŠ¡3;</li><li>æœ€åæ˜¯æ …æ ä¹‹åçš„ä»»åŠ¡4å’Œ5ã€‚</li></ul><p>æ³¨æ„ï¼šæ …æ åªæ˜¯ç”¨æ¥æ§åˆ¶åŒä¸€å¹¶å‘é˜Ÿåˆ—ä¸­æ …æ å‰åä»»åŠ¡çš„æ•´ä½“æ‰§è¡Œé¡ºåºï¼›è‡³äºæ …æ å‰é¢çš„ä»»åŠ¡ä¸åé¢çš„ä»»åŠ¡å®ƒä»¬å…·ä½“åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œè¿™ä¸æ˜¯æ …æ èƒ½å†³å®šçš„ã€‚</p><p>ç»“åˆæ—¥å¿—ä¸­ä»»åŠ¡æ‰€åœ¨çº¿ç¨‹çš„å†…å­˜åœ°å€æ¥çœ‹ï¼š</p><ul><li>æ …æ ä¹‹å‰çš„<code>ä»»åŠ¡1</code>å’Œ<code>ä»»åŠ¡2</code>å¹¶æ²¡åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼›</li><li>æ …æ ä¹‹åçš„<code>ä»»åŠ¡4</code>å’Œ<code>ä»»åŠ¡5</code>ä¹Ÿæ²¡æœ‰åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼›</li><li>ç”šè‡³æ …æ å‰çš„<code>ä»»åŠ¡1</code>å’Œæ …æ <code>ä»»åŠ¡3</code>åŠæ …æ ä¹‹åçš„<code>ä»»åŠ¡4</code>ä½¿ç”¨äº†åŒä¸€ä¸ªçº¿ç¨‹ï¼›</li></ul><p>æ‰€ä»¥ï¼Œæ …æ åçš„ä»»åŠ¡å…·ä½“æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œè¿˜æ˜¯è¦çœ‹è¿™äº›ä»»åŠ¡çš„æäº¤æ–¹å¼å’Œé˜Ÿåˆ—ç±»å‹ï¼Œä¹‹åäº¤ç»™çº¿ç¨‹æ± æ¥å†³å®šã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœä»»åŠ¡éƒ½æ˜¯é€šè¿‡æ …æ æäº¤çš„ï¼Œé‚£ä¹ˆæ …æ å°±èƒ½ä¿è¯å®ƒä»¬æŒ‰ç…§æ¥æ—¶çš„é¡ºåºå…ˆåæ‰§è¡Œï¼Œä¸”æ˜¯åœ¨åŒä¸€çº¿ç¨‹ä¸Šï¼š</p><p>#ç¤ºä¾‹4.2ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">- (void)barrier2&#123;<br>    <span class="hljs-comment">//è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—</span><br>    dispatch_queue_t cQueue = dispatch<span class="hljs-constructor">_queue_create(<span class="hljs-string">&quot;Name1&quot;</span>,DISPATCH_QUEUE_CONCURRENT)</span>;<br>    <br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡1:%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡2:%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>    dispatch<span class="hljs-constructor">_barrier_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡3æ …æ :%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++1&quot;</span>)</span>;<br>    dispatch<span class="hljs-constructor">_barrier_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123; <span class="hljs-comment">//æ³¨æ„ï¼Œè¿™é‡Œæ¢æˆäº†æ …æ ï¼Œä¸ä»…ä»…æ˜¯å¼‚æ­¥äº†</span><br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡4:%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++2&quot;</span>)</span>;<br>    dispatch<span class="hljs-constructor">_barrier_async(<span class="hljs-params">cQueue</span>, ^()</span>&#123; <span class="hljs-comment">// è¿™é‡Œä¹Ÿæ˜¯</span><br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ä»»åŠ¡5:%@&quot;</span>,[NSThread <span class="hljs-params">currentThread</span>])</span>;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arcade">++++<span class="hljs-number">1</span><br>++++<span class="hljs-number">2</span><br>++++ä»»åŠ¡<span class="hljs-number">1</span>:&lt;NSThread: <span class="hljs-number">0x60000132cb80</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>, name = (<span class="hljs-literal">null</span>)&#125;<br>++++ä»»åŠ¡<span class="hljs-number">2</span>:&lt;NSThread: <span class="hljs-number">0x60000132a840</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">6</span>, name = (<span class="hljs-literal">null</span>)&#125;<br>++++ä»»åŠ¡<span class="hljs-number">3</span>æ …æ :&lt;NSThread: <span class="hljs-number">0x60000132a840</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">6</span>, name = (<span class="hljs-literal">null</span>)&#125;<br>++++ä»»åŠ¡<span class="hljs-number">4</span>:&lt;NSThread: <span class="hljs-number">0x60000132a840</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">6</span>, name = (<span class="hljs-literal">null</span>)&#125;<br>++++ä»»åŠ¡<span class="hljs-number">5</span>:&lt;NSThread: <span class="hljs-number">0x60000132a840</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">6</span>, name = (<span class="hljs-literal">null</span>)&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæäº¤åˆ°æ …æ ä¸­çš„ä»»åŠ¡3ã€4ã€5æ˜¯æŒ‰ç…§æäº¤æ—¶çš„é¡ºåºæ‰§è¡Œçš„ï¼Œä¸”åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚</p><p>å¦å¤–ï¼Œè¯¥å‡½æ•°éœ€è¦åŒ<code>dispatch_queue_create()</code>ç”Ÿæˆçš„å¹¶å‘é˜Ÿåˆ—ä¸€èµ·ç”¨ã€‚å¦‚æœç¤ºä¾‹4.1ä¸­æ¢æˆå…¨å±€é˜Ÿåˆ—åˆ™æ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡3æ …æ </span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡4</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡5</span><br></code></pre></td></tr></table></figure><p>ä»»åŠ¡1ã€2åœ¨æ …æ 3ä¹‹åæ‰§è¡Œäº†ï¼Œ<strong>æ …æ å¹¶æœªèµ·æ•ˆï¼ï¼ï¼</strong>ï¼Œæ‰€ä»¥å®é™…ä¸­é¡»æ³¨æ„è¿™ä¸€ç‚¹~</p><h4 id="2-dispatch-barrier-sync"><a href="#2-dispatch-barrier-sync" class="headerlink" title="2.dispatch_barrier_sync"></a>2.dispatch_barrier_sync</h4><p>å°†ç¤ºä¾‹4.1ä¸­æ …æ æ›¿æ¢ä¸º<code>dispatch_barrier_sync</code>åï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡3æ …æ </span><br><span class="hljs-literal">++++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡4</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡5</span><br></code></pre></td></tr></table></figure><p>å¯¹æ¯”æ—¥å¿—ï¼Œä¸¤ç§æƒ…å†µä¸‹ï¼š</p><p>1ã€ä»»åŠ¡éƒ½æ˜¯æŒ‰ç…§æ …æ 3ä¹‹å‰çš„å…ˆæ‰§è¡Œï¼Œå†æ˜¯3æœ¬èº«ï¼Œæœ€åæ˜¯45ï¼›</p><p>2ã€â€œ++++æ•°å­—â€æ—¥å¿—éƒ½æ˜¯æŒ‰ç…§12çš„é¡ºåºæ‰§è¡Œï¼Œåªæ˜¯åœ¨å¼‚æ­¥æ …æ ä¸­â€œ++++æ•°å­—â€ ä¸ â€œ++++ä»»åŠ¡xâ€çš„æ‰“å°äº†é¡ºåºä¸åŒã€‚</p><p><strong>ä¸¤è€…çš„åŒºåˆ«ï¼š</strong></p><p>1ã€åŒæ­¥æ …æ ï¼šå°†æ …æ ä»»åŠ¡æ’å…¥é˜Ÿåˆ—æ—¶ï¼Œéœ€ç­‰å¾…æ …æ ä»»åŠ¡ç»“æŸåï¼Œæ‰ä¼šç»§ç»­æ’å…¥å¹¶æ‰§è¡Œè¢«å†™åœ¨å®ƒåé¢çš„ä»»åŠ¡ï¼›</p><p>2ã€å¼‚æ­¥æ …æ ï¼šå°†æ …æ ä»»åŠ¡æ’å…¥é˜Ÿåˆ—åï¼Œä¸ä¼šç­‰å¾…æ …æ ä»»åŠ¡ç»“æŸï¼Œè€Œæ˜¯ç»§ç»­æŠŠåç»­ä»»åŠ¡æ’å…¥é˜Ÿåˆ—ä¸­ï¼Œæ …æ ä»»åŠ¡ç»“æŸåæ‰æ‰§è¡Œåé¢çš„ä»»åŠ¡ï¼›</p><p>3ã€æ …æ æœ¬èº«ä¸è®ºå¼‚æ­¥è¿˜æ˜¯åŒæ­¥ï¼Œéƒ½åªä¼šç»™è‡ªå·±å¹¶å‘é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è®¾ç½®æ …æ ï¼Œä¸ä¼šé˜»ç¢ä¸»çº¿ç¨‹çš„ä»£ç ã€‚</p><h3 id="5-å»¶æ—¶ï¼šdispatch-after"><a href="#5-å»¶æ—¶ï¼šdispatch-after" class="headerlink" title="5.å»¶æ—¶ï¼šdispatch_after"></a>5.å»¶æ—¶ï¼šdispatch_after</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">dispatch_after</span>(<br>dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number">2.0</span> * NSEC_PER_SEC)),<br><span class="hljs-built_in">dispatch_get_main_queue</span>(), ^&#123;<br>    <span class="hljs-comment">//2ç§’åçš„å»¶æ—¶ä»»åŠ¡ do something</span><br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="6-dispatch-once"><a href="#6-dispatch-once" class="headerlink" title="6.dispatch_once"></a>6.dispatch_once</h3><p><strong>ä½œç”¨ï¼š</strong>å¹¿æ³›ä½¿ç”¨åœ¨å•ä¾‹ä¸­ï¼Œç”¨ä»¥ä¿è¯åˆå§‹åŒ–æ–¹æ³•ä¸­çš„ä»»åŠ¡åªæ‰§è¡Œä¸€æ¬¡ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">static</span> ASDFSingleton *mSingleton = <span class="hljs-literal">nil</span>;<br><br><span class="hljs-comment">// å£°æ˜å•ä¾‹çš„æ–¹å¼1ï¼š</span><br>+ (<span class="hljs-keyword">instancetype</span>)shareInstance<br>&#123;<br>    <span class="hljs-keyword">return</span> [[<span class="hljs-keyword">self</span> alloc] init];<br>&#125;<br><br><span class="hljs-comment">//é˜²æ­¢å¤–éƒ¨é€šè¿‡allocæˆ–newçš„æ–¹å¼é”™è¯¯çš„åˆ›å»ºäº†å®ä¾‹å¯¹è±¡</span><br>+ (<span class="hljs-keyword">instancetype</span>)allocWithZone:(<span class="hljs-keyword">struct</span> _NSZone *)zone&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br>        mSingleton = [<span class="hljs-variable language_">super</span> allocWithZone:zone];<br>    &#125;);<br>    <span class="hljs-keyword">return</span> mSingleton;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-dispatch-apply"><a href="#7-dispatch-apply" class="headerlink" title="7.dispatch_apply"></a>7.dispatch_apply</h3><p>ä½œç”¨ï¼šæŒ‰æŒ‡å®šçš„æ¬¡æ•°å°†ä»»åŠ¡è¿½åŠ åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç­‰åˆ°å…¨éƒ¨çš„å¤„ç†æ‰§è¡Œç»“æŸã€‚</p><p>#ç¤ºä¾‹7.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// å¹¶å‘é˜Ÿåˆ—</span><br><span class="hljs-built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="hljs-string">&quot;Name&quot;</span>,DISPATCH_QUEUE_CONCURRENT);<br><span class="hljs-built_in">NSArray</span> *array = @[<span class="hljs-string">@&quot;a&quot;</span>, <span class="hljs-string">@&quot;b&quot;</span>, <span class="hljs-string">@&quot;c&quot;</span>, <span class="hljs-string">@&quot;d&quot;</span>, <span class="hljs-string">@&quot;e&quot;</span>, <span class="hljs-string">@&quot;f&quot;</span>, <span class="hljs-string">@&quot;g&quot;</span>, <span class="hljs-string">@&quot;h&quot;</span>, <span class="hljs-string">@&quot;i&quot;</span>, <span class="hljs-string">@&quot;j&quot;</span>];<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å¼€å§‹&quot;</span>);<br><br>dispatch_apply([array count], concurrentQueue, ^(size_t index) &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++%zu,%@,ON:%@&quot;</span>, index, [array objectAtIndex:index], [<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;);<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ç»“æŸ&quot;</span>);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">++++å¼€å§‹<br>++<span class="hljs-number">1</span>,b,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x6000010407c0</span>&gt;&#123;number = <span class="hljs-number">4</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++<span class="hljs-number">0</span>,a,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x60000100d980</span>&gt;&#123;number = <span class="hljs-number">1</span>, <span class="hljs-type">name</span> = main&#125;<br>++<span class="hljs-number">2</span>,c,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x6000010407c0</span>&gt;&#123;number = <span class="hljs-number">4</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++<span class="hljs-number">3</span>,d,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x60000100d980</span>&gt;&#123;number = <span class="hljs-number">1</span>, <span class="hljs-type">name</span> = main&#125;<br>++<span class="hljs-number">4</span>,e,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x600001055700</span>&gt;&#123;number = <span class="hljs-number">5</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++<span class="hljs-number">5</span>,f,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x6000010407c0</span>&gt;&#123;number = <span class="hljs-number">4</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++<span class="hljs-number">7</span>,h,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x600001055700</span>&gt;&#123;number = <span class="hljs-number">5</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++<span class="hljs-number">6</span>,g,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x60000100d980</span>&gt;&#123;number = <span class="hljs-number">1</span>, <span class="hljs-type">name</span> = main&#125;<br>++<span class="hljs-number">8</span>,i,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x6000010407c0</span>&gt;&#123;number = <span class="hljs-number">4</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++<span class="hljs-number">9</span>,j,<span class="hljs-keyword">ON</span>:&lt;NSThread: <span class="hljs-number">0x60000100d980</span>&gt;&#123;number = <span class="hljs-number">1</span>, <span class="hljs-type">name</span> = main&#125;<br>++++ç»“æŸ<br></code></pre></td></tr></table></figure><p>å¤šè¿è¡Œå‡ æ¬¡ï¼Œå¯ä»¥ä»æ—¥å¿—ä¸­å‘ç°ï¼š</p><ul><li>æ‰“å°çš„ç´¢å¼•å€¼å¹¶éå®Œå…¨æŒ‰ç…§ 0~9 çš„å‡åºæ’åˆ—ï¼›</li><li>éå†å…ƒç´ çš„æ“ä½œå¹¶ééƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼›</li></ul><p>å¦‚æœå¸Œæœ›ç´¢å¼•å€¼å®Œå…¨æŒ‰ç…§ 0~9 çš„å‡åºæ’åˆ—ï¼Œå¯ä»¥ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—ï¼Œè¿™æ ·å°±ç±»ä¼¼äº<code>for</code>å¾ªç¯äº†ã€‚</p><p>#ç¤ºä¾‹7.2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// ä¸²è¡Œé˜Ÿåˆ—</span><br><span class="hljs-built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="hljs-string">&quot;Name&quot;</span>,DISPATCH_QUEUE_SERIAL);<br><span class="hljs-built_in">NSArray</span> *array = @[<span class="hljs-string">@&quot;a&quot;</span>, <span class="hljs-string">@&quot;b&quot;</span>, <span class="hljs-string">@&quot;c&quot;</span>, <span class="hljs-string">@&quot;d&quot;</span>, <span class="hljs-string">@&quot;e&quot;</span>, <span class="hljs-string">@&quot;f&quot;</span>, <span class="hljs-string">@&quot;g&quot;</span>, <span class="hljs-string">@&quot;h&quot;</span>, <span class="hljs-string">@&quot;i&quot;</span>, <span class="hljs-string">@&quot;j&quot;</span>];<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å¼€å§‹&quot;</span>);<br><br>dispatch_apply([array count], concurrentQueue, ^(size_t index) &#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++%zu,%@,ON:%@&quot;</span>, index, [array objectAtIndex:index], [<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;);<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ç»“æŸ&quot;</span>);<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">++++å¼€å§‹</span><br><span class="language-xml">++0,a,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++1,b,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++2,c,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++3,d,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++4,e,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++5,f,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++6,g,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++7,h,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++8,i,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++9,j,ON:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600001999600</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++ç»“æŸ</span><br></code></pre></td></tr></table></figure><p>ä¸è®ºä½¿ç”¨ä¸²è¡Œè¿˜æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œ<code>dispatch_apply</code>å‡½æ•°éƒ½ä¸ä¼šç«‹åˆ»è¿”å›ï¼Œå®ƒä¼šé˜»å¡å½“å‰çº¿ç¨‹å¹¶åœ¨å¾ªç¯å®Œæˆåå†ç»§ç»­æ‰§è¡Œåç»­ä»£ç ã€‚æ‰€ä»¥å¯ä»¥æ¨æµ‹å®ƒä½¿ç”¨äº†åŒæ­¥çš„æ–¹å¼æäº¤éå†å…ƒç´ çš„ä»»åŠ¡ï¼Œè¿™ä¸€ç‚¹ç±»ä¼¼äº<code>for</code>å¾ªç¯ã€‚</p><h3 id="8-ä»»åŠ¡ç»„"><a href="#8-ä»»åŠ¡ç»„" class="headerlink" title="8.ä»»åŠ¡ç»„"></a>8.ä»»åŠ¡ç»„</h3><h4 id="1-dispatch-group"><a href="#1-dispatch-group" class="headerlink" title="1.dispatch_group"></a>1.dispatch_group</h4><p><strong>åœºæ™¯ï¼š</strong>åœ¨å¹¶å‘é˜Ÿåˆ—çš„Nä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç»§ç»­æ‰§è¡ŒæŸä»»åŠ¡ã€‚</p><p>#ç¤ºä¾‹8.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—1</span><br><span class="hljs-built_in">dispatch_queue_t</span> dispatchQueue1 = dispatch_queue_create(<span class="hljs-string">&quot;concurrentQueue1&quot;</span>,DISPATCH_QUEUE_CONCURRENT);<br><br><span class="hljs-comment">//è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—2</span><br><span class="hljs-built_in">dispatch_queue_t</span> dispatchQueue2 = dispatch_queue_create(<span class="hljs-string">&quot;concurrentQueue2&quot;</span>,DISPATCH_QUEUE_CONCURRENT);<br><br>dispatch_group_t dispatchGroup = dispatch_group_create();<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++1:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br><br><span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—1ä¸Šæ‰§è¡Œä»»åŠ¡1</span><br>dispatch_group_async(dispatchGroup, dispatchQueue1, ^()&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">888</span> == i) &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡1:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>        &#125;<br>    &#125;<br>&#125;);<br><br><span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—1ä¸Šæ‰§è¡Œä»»åŠ¡2</span><br>dispatch_group_async(dispatchGroup, dispatchQueue1, ^()&#123;<br>    [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">5</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡2:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;);<br><br><span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—2ä¸Šæ‰§è¡Œä»»åŠ¡3</span><br>dispatch_group_async(dispatchGroup, dispatchQueue2, ^()&#123;<br>    [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">3</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡3:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;);<br><br><span class="hljs-comment">//ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span><br>dispatch_group_notify(dispatchGroup,dispatch_get_main_queue(), ^()&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡å®Œæˆ:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;);<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ç¨ç­‰ä¸€å“ˆ:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br><span class="hljs-built_in">dispatch_async</span>(dispatchQueue2, ^&#123;<br>    dispatch_group_wait(dispatchGroup, DISPATCH_TIME_FOREVER);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å“ˆ~å°±ä¸ç­‰:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;);<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++2:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">++++1:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x60000313a800</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++ç¨ç­‰ä¸€å“ˆ:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x60000313a800</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++ä»»åŠ¡1:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003164780</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 5, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++2:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x60000313a800</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++ä»»åŠ¡3:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003153cc0</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 6, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++ä»»åŠ¡2:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003176480</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 3, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++ä»»åŠ¡å®Œæˆ:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x60000313a800</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++å“ˆ~å°±ä¸ç­‰:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003176880</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 4, name = (null)&#125;</span><br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p><p>1ã€ä¸€ä¸ªGroupå¯ä»¥å’Œå¤šä¸ªqueueå…³è”ã€‚</p><p>2ã€å¦‚æœæäº¤åˆ°é˜Ÿåˆ—ä¸­çš„ä¸Groupå…³è”èµ·æ¥çš„ä»»åŠ¡å…¨éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™ä¼šè°ƒç”¨dispatch_group_notifyå¹¶ä¸”dispatch_group_waitä¼šåœæ­¢ç­‰å¾…ï¼›</p><p>3ã€å‡è®¾ä¸€ä¸ªé˜Ÿåˆ—ä¸­æœ‰2ä¸ªä»»åŠ¡ï¼Œåªæœ‰ç¬¬äºŒä¸ªä¸Groupè¿›è¡Œäº†å…³è”ï¼Œåˆ™åªè¦ç¬¬äºŒä¸ªä»»åŠ¡å®Œæˆï¼Œä¸è®ºç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯å¦å·²å®Œæˆï¼Œéƒ½ä¼šæ”¶åˆ°dispatch_group_notifyé€šçŸ¥ã€‚</p><p>4ã€dispatch_group_waitä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡å…¨éƒ¨å®Œæˆæˆ–ç­‰å¾…æ—¶é—´è¶…è¿‡è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œæ‰€ä»¥ä¸èƒ½åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ã€‚</p><h4 id="2-dispatch-group-enter"><a href="#2-dispatch-group-enter" class="headerlink" title="2.dispatch_group_enter"></a>2.dispatch_group_enter</h4><p><code>dispatch_group_enter</code>+<code>dispatch_group_leave</code>æˆå¯¹ä½¿ç”¨ï¼Œä½œç”¨ä¸<code>dispatch_group_async</code>ç±»ä¼¼:</p><p>#ç¤ºä¾‹8.2.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—</span><br><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">&quot;concurrentQueue1&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br><br>dispatch_group_t group = dispatch_group_create();<br><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++1&quot;</span>);<br><br><span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—ä¸Šæ‰§è¡Œä»»åŠ¡1</span><br>dispatch_group_enter(group);<br><span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">888</span> == i) &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡1&quot;</span>);<br>        &#125;<br>    &#125;<br>    dispatch_group_leave(group);<br>&#125;);<br><br><span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—ä¸Šæ‰§è¡Œä»»åŠ¡2</span><br>dispatch_group_enter(group);<br><span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;<br>    [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">5</span>];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡2&quot;</span>);<br>    dispatch_group_leave(group);<br>&#125;);<br><br><span class="hljs-comment">//ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span><br>dispatch_group_notify(group, dispatch_get_main_queue(), ^()&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡å®Œæˆ&quot;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>ä¸ dispatch_group_async çš„åŒºåˆ«ï¼ˆçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼‰:</strong></p><p>å¦‚æœ <code>dispatch_group_async</code> é‡Œæ‰§è¡Œçš„æ˜¯å¼‚æ­¥ä»£ç ï¼Œ<code>dispatch_group_notify</code> ä¼šç›´æ¥è§¦å‘è€Œä¸ä¼šç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼›è€Œ <code>dispatch_group_enter</code>ã€å’Œ <code>dispatch_group_leave</code> åˆ™ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä»¬åªéœ€è¦åœ¨ä»»åŠ¡å¼€å§‹å‰ <code>enter</code> ç»“æŸå <code>leave</code> å³å¯è¾¾åˆ°çº¿ç¨‹åŒæ­¥çš„æ•ˆæœã€‚</p><p>#ç¤ºä¾‹8.2.2ï¼š<code>dispatch_group_async</code> æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡æ—¶çš„æ•ˆæœï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—1</span><br><span class="hljs-built_in">dispatch_queue_t</span> dispatchQueue1 = dispatch_queue_create(<span class="hljs-string">&quot;concurrentQueue1&quot;</span>,DISPATCH_QUEUE_CONCURRENT);<br><br><span class="hljs-comment">//è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—2</span><br><span class="hljs-built_in">dispatch_queue_t</span> dispatchQueue2 = dispatch_queue_create(<span class="hljs-string">&quot;concurrentQueue2&quot;</span>,DISPATCH_QUEUE_CONCURRENT);<br><br>dispatch_group_t dispatchGroup = dispatch_group_create();<br><br><span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—1ä¸Šæ‰§è¡Œä»»åŠ¡1</span><br>dispatch_group_async(dispatchGroup, dispatchQueue1, ^()&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(dispatchQueue2, ^&#123;<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">5</span>];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡1&quot;</span>);<br>    &#125;);<br>&#125;);<br><br><span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—1ä¸Šæ‰§è¡Œä»»åŠ¡2</span><br>dispatch_group_async(dispatchGroup, dispatchQueue1, ^()&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(dispatchQueue2, ^&#123;<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">8</span>];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡2&quot;</span>);<br>    &#125;);<br>&#125;);<br><br><span class="hljs-comment">//ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span><br>dispatch_group_notify(dispatchGroup,dispatch_get_main_queue(), ^()&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡å®Œæˆ&quot;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ä¸º:</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡å®Œæˆ</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡2</span><br></code></pre></td></tr></table></figure><p><code>notify</code>åœ¨ä»»åŠ¡å¼€å§‹æ—¶å°±è§¦å‘äº†~</p><p>#ç¤ºä¾‹8.2.3ï¼š<code>dispatch_group_enter</code> ä¸ <code>leave</code> æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡æ—¶çš„æ•ˆæœï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—</span><br>dispatch_queue_t queue = dispatch_queue_create(<span class="hljs-string">&quot;concurrentQueue1&quot;</span>,DISPATCH_QUEUE_CONCURRENT);<br><br>dispatch_group_t <span class="hljs-keyword">group</span> = dispatch_group_create();<br><br>dispatch_group_enter(<span class="hljs-keyword">group</span>);<br>dispatch_async(queue, ^&#123;<br>    [<span class="hljs-meta">NSThread sleepForTimeInterval:5</span>];<br>    NSLog(<span class="hljs-string">@&quot;++++ä»»åŠ¡1&quot;</span>);<br>    dispatch_group_leave(<span class="hljs-keyword">group</span>);<br>&#125;);<br><br><span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—1ä¸Šæ‰§è¡Œä»»åŠ¡2</span><br>dispatch_group_enter(<span class="hljs-keyword">group</span>);<br>dispatch_async(queue, ^&#123;<br>    [<span class="hljs-meta">NSThread sleepForTimeInterval:8</span>];<br>    NSLog(<span class="hljs-string">@&quot;++++ä»»åŠ¡2&quot;</span>);<br>    dispatch_group_leave(<span class="hljs-keyword">group</span>);<br>&#125;);<br><br><span class="hljs-comment">//ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span><br>dispatch_group_notify(<span class="hljs-keyword">group</span>,dispatch_get_main_queue(), ^()&#123;<br>    NSLog(<span class="hljs-string">@&quot;++++ä»»åŠ¡å®Œæˆ&quot;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>æ—¥å¿—:</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡å®Œæˆ</span><br></code></pre></td></tr></table></figure><p><code>notify</code> åœ¨ä»»åŠ¡ç»“æŸæ—¶æ‰è§¦å‘!</p><h4 id="3-å…¶ä»–æ–¹æ¡ˆ"><a href="#3-å…¶ä»–æ–¹æ¡ˆ" class="headerlink" title="3.å…¶ä»–æ–¹æ¡ˆ"></a>3.å…¶ä»–æ–¹æ¡ˆ</h4><p>é€šè¿‡ç»„åˆGCDå·²æœ‰çš„å…¶ä»–APIï¼Œç­‰æ•ˆå®ç°<code>dispatch_group</code>çš„åŠŸèƒ½ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs OBJECTIVEC"><span class="hljs-comment">// éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ€»æ•°</span><br><span class="hljs-built_in">NSUInteger</span> totalTasks = <span class="hljs-number">10</span>;<br><span class="hljs-comment">// å½“å‰å·²ç»å®Œæˆçš„ä»»åŠ¡æ•°é‡</span><br><span class="hljs-keyword">volatile</span> <span class="hljs-built_in">NSUInteger</span> completedTasks = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// æœ€å¤§å¹¶å‘æ•°</span><br><span class="hljs-built_in">NSUInteger</span> maxConcurrentTasks = <span class="hljs-number">3</span>;<br><br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œç”¨äºç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆåæ‰§è¡Œæ¥ä¸‹æ¥çš„ä»»åŠ¡</span><br><span class="hljs-built_in">dispatch_queue_t</span> completionQueue = dispatch_queue_create(<span class="hljs-string">&quot;com.example.completion&quot;</span>, DISPATCH_QUEUE_SERIAL);<br><br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ï¼Œç”¨äºæ‰§è¡Œè€—æ—¶ä»»åŠ¡</span><br><span class="hljs-built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="hljs-string">&quot;com.example.concurrent&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br><br><span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªä»»åŠ¡å®Œæˆçš„å›è°ƒå‡½æ•°</span><br><span class="hljs-type">void</span> (^taskCompletionBlock)(<span class="hljs-type">void</span>) = ^&#123;<br>    <span class="hljs-comment">// åŸå­æ“ä½œï¼Œç´¯åŠ å·²å®Œæˆä»»åŠ¡æ•°</span><br>    <span class="hljs-built_in">NSUInteger</span> count = OSAtomicIncrement64(&amp;completedTasks);<br>    <span class="hljs-keyword">if</span> (count == totalTasks) &#123;<br>        <span class="hljs-comment">// æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼Œæ‰§è¡Œæ¥ä¸‹æ¥çš„ä»»åŠ¡</span><br>        <span class="hljs-built_in">dispatch_async</span>(completionQueue, ^&#123;<br>            <span class="hljs-comment">// åœ¨è¿™é‡Œæ‰§è¡Œæ¥ä¸‹æ¥çš„ä»»åŠ¡</span><br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆ&quot;</span>);<br>        &#125;);<br>    &#125;<br>&#125;;<br><br><span class="hljs-comment">// å¾ªç¯æäº¤æ‰€æœ‰ä»»åŠ¡</span><br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSUInteger</span> i = <span class="hljs-number">0</span>; i &lt; totalTasks; i++) &#123;<br>    <span class="hljs-built_in">dispatch_async</span>(concurrentQueue, ^&#123;<br>        <span class="hljs-comment">// åœ¨è¿™é‡Œæ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;ä»»åŠ¡ %lu å¼€å§‹æ‰§è¡Œ&quot;</span>, i);<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">1.0</span>]; <span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;ä»»åŠ¡ %lu å®Œæˆ&quot;</span>, i);<br>        taskCompletionBlock(); <span class="hljs-comment">// è°ƒç”¨ä»»åŠ¡å®Œæˆçš„å›è°ƒå‡½æ•°</span><br>    &#125;);<br>    <span class="hljs-keyword">if</span> (i % maxConcurrentTasks == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// å½“å‰å¹¶å‘ä»»åŠ¡å·²è¾¾åˆ°æœ€å¤§å¹¶å‘æ•°ï¼Œç­‰å¾…æ‰€æœ‰å¹¶å‘ä»»åŠ¡å®Œæˆåå†ç»§ç»­æäº¤</span><br>        dispatch_barrier_sync(concurrentQueue, ^&#123;<br>            <span class="hljs-comment">// do nothing</span><br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="9-æŒ‚èµ·-x2F-æ¢å¤ï¼š"><a href="#9-æŒ‚èµ·-x2F-æ¢å¤ï¼š" class="headerlink" title="9.æŒ‚èµ·&#x2F;æ¢å¤ï¼š"></a>9.æŒ‚èµ·&#x2F;æ¢å¤ï¼š</h3><p><code>dispatch_suspend</code>ï¼Œ<code>dispatch_resume</code> æä¾›äº†â€œæŒ‚èµ·ã€æ¢å¤â€é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œå¯ä»¥æš‚åœã€æ¢å¤é˜Ÿåˆ—ä¸Šçš„ä»»åŠ¡ã€‚ä½†æ˜¯è¿™é‡Œçš„â€œæŒ‚èµ·â€ï¼Œå¹¶ä¸èƒ½ä¿è¯å¯ä»¥ç«‹å³åœæ­¢é˜Ÿåˆ—ä¸Šæ­£åœ¨è¿è¡Œçš„ blockã€‚</p><p>#ç¤ºä¾‹9.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="hljs-string">&quot;Queue&quot;</span>, DISPATCH_QUEUE_SERIAL);<br><br><span class="hljs-comment">//æäº¤ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå»¶æ—¶5ç§’è¾“å‡ºæ—¥å¿—</span><br><span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ç¬¬1ä¸ªä»»åŠ¡ å»¶æ—¶5ç§’å’¯&quot;</span>);<br>&#125;);<br><span class="hljs-comment">//æäº¤ç¬¬äºŒä¸ªä»»åŠ¡ï¼Œå»¶æ—¶5ç§’è¾“å‡ºæ—¥å¿—</span><br><span class="hljs-built_in">dispatch_async</span>(queue, ^&#123;<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ç¬¬2ä¸ªä»»åŠ¡ å»¶æ—¶5ç§’å’¯&quot;</span>);<br>&#125;);<br><br><span class="hljs-comment">//å»¶æ—¶1ç§’</span><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å»¶æ—¶1ç§’&quot;</span>);<br>sleep(<span class="hljs-number">1</span>);<br><br><span class="hljs-comment">//æŒ‚èµ·é˜Ÿåˆ—</span><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æŒ‚èµ·é˜Ÿåˆ—&quot;</span>);<br>dispatch_suspend(queue);<br><br><span class="hljs-comment">//å»¶æ—¶10ç§’</span><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å»¶æ—¶10ç§’&quot;</span>);<br>sleep(<span class="hljs-number">10</span>);<br><br><span class="hljs-comment">//æ¢å¤é˜Ÿåˆ—</span><br><span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ¢å¤é˜Ÿåˆ—&quot;</span>);<br>dispatch_resume(queue);<br></code></pre></td></tr></table></figure><p>æ—¥å¿—:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">11</span>.<span class="hljs-number">187713</span> ++++å»¶æ—¶<span class="hljs-number">1</span>ç§’<br><span class="hljs-attribute">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">12</span>.<span class="hljs-number">189074</span> ++++æŒ‚èµ·é˜Ÿåˆ—<br><span class="hljs-attribute">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">12</span>.<span class="hljs-number">189450</span> ++++å»¶æ—¶<span class="hljs-number">10</span>ç§’<br><span class="hljs-attribute">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">16</span>.<span class="hljs-number">193140</span> ++++ç¬¬<span class="hljs-number">1</span>ä¸ªä»»åŠ¡ å»¶æ—¶<span class="hljs-number">5</span>ç§’å’¯<br><span class="hljs-attribute">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">22</span>.<span class="hljs-number">190424</span> ++++æ¢å¤é˜Ÿåˆ—<br><span class="hljs-attribute">12</span>:<span class="hljs-number">58</span>:<span class="hljs-number">27</span>.<span class="hljs-number">192363</span> ++++ç¬¬<span class="hljs-number">2</span>ä¸ªä»»åŠ¡ å»¶æ—¶<span class="hljs-number">5</span>ç§’å’¯<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨<code>dispatch_suspend</code>æŒ‚èµ·é˜Ÿåˆ—åï¼Œç¬¬ä¸€ä¸ª block è¿˜æ˜¯åœ¨è¿è¡Œï¼Œå¹¶ä¸”æ­£å¸¸è¾“å‡ºã€‚</p><h3 id="10-dispatch-set-target-queue"><a href="#10-dispatch-set-target-queue" class="headerlink" title="10.dispatch_set_target_queue"></a>10.dispatch_set_target_queue</h3><h4 id="1-è®¾ç½®é˜Ÿåˆ—ä¼˜å…ˆçº§"><a href="#1-è®¾ç½®é˜Ÿåˆ—ä¼˜å…ˆçº§" class="headerlink" title="1.è®¾ç½®é˜Ÿåˆ—ä¼˜å…ˆçº§"></a>1.è®¾ç½®é˜Ÿåˆ—ä¼˜å…ˆçº§</h4><p>æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„é˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯é»˜è®¤ä¼˜å…ˆçº§ï¼Œè€Œç³»ç»Ÿæä¾›çš„å…¨å±€é˜Ÿåˆ—åˆ™å¯ä»¥æŒ‡å®šä¼˜å…ˆçº§ï¼Œé€šè¿‡<code>dispatch_set_target_queue</code>æ–¹æ³•æˆ‘ä»¬å¯ä»¥è®©è‡ªå®šä¹‰é˜Ÿåˆ—çš„ä¼˜å…ˆçº§ä¸å…¨å±€é˜Ÿåˆ—ä¿æŒä¸€è‡´ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹è‡ªå®šä¹‰é˜Ÿåˆ—ä¼˜å…ˆçº§çš„ç›®çš„ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">dispatch_queue_t serialQueue = dispatch<span class="hljs-constructor">_queue_create(<span class="hljs-string">&quot;com.xx.xx&quot;</span>,DISPATCH_QUEUE_SERIAL)</span>;<br><br>dispatch_queue_t globalQueue = dispatch<span class="hljs-constructor">_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND,0)</span>;<br><br><span class="hljs-comment">//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡é˜Ÿåˆ—ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‚è€ƒé˜Ÿåˆ—ï¼ˆå…¨å±€é˜Ÿåˆ—ï¼‰ï¼›</span><br>dispatch<span class="hljs-constructor">_set_target_queue(<span class="hljs-params">serialQueue</span>, <span class="hljs-params">globalQueue</span>)</span>;<br></code></pre></td></tr></table></figure><h4 id="2-ä»»åŠ¡è°ƒåº¦"><a href="#2-ä»»åŠ¡è°ƒåº¦" class="headerlink" title="2.ä»»åŠ¡è°ƒåº¦"></a>2.ä»»åŠ¡è°ƒåº¦</h4><p>ä¿®æ”¹é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„ç›®æ ‡é˜Ÿåˆ—ï¼ŒæŠŠéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡å¯¹è±¡æŒ‡å®šåˆ°ç›®æ ‡é˜Ÿåˆ—ä¸­å»å¤„ç†ã€‚</p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)seriaQues&#123;<br>    <span class="hljs-comment">//ä¸‰ä¸ªä¸²è¡Œé˜Ÿåˆ—</span><br>    <span class="hljs-built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="hljs-string">&quot;queue1&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    <span class="hljs-built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="hljs-string">&quot;queue2&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    <span class="hljs-built_in">dispatch_queue_t</span> queue3 = dispatch_queue_create(<span class="hljs-string">&quot;queue3&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    <br>    <span class="hljs-built_in">dispatch_async</span>(queue1, ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡1å¼€å§‹&quot;</span>);<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">3.</span>f];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡1ç»“æŸ&quot;</span>);<br>    &#125;);<br>    <span class="hljs-built_in">dispatch_async</span>(queue2, ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡2å¼€å§‹&quot;</span>);<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">2.</span>f];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡2ç»“æŸ&quot;</span>);<br>    &#125;);<br>    <span class="hljs-built_in">dispatch_async</span>(queue3, ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡3å¼€å§‹&quot;</span>);<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">1.</span>f];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡3ç»“æŸ&quot;</span>);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡2å¼€å§‹</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡1å¼€å§‹</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡3å¼€å§‹</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡3ç»“æŸ</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡2ç»“æŸ</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡1ç»“æŸ</span><br></code></pre></td></tr></table></figure><p>å¤šä¸ªä¸²è¡Œé˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œæ—¶ï¼Œblockä¸­å„ä»»åŠ¡æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå®ƒä»¬ä¹‹é—´å¼€å§‹å’Œç»“æŸçš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚å¦‚æœæƒ³è®©è¿™äº›ä»»åŠ¡æŒ‰ç…§å…ˆåé¡ºåºä¸€ä¸ªä¸ªæ‰§è¡Œï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>dispatch_set_target_queue</code>ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)seriaMultQue&#123;<br>    <span class="hljs-comment">//ä¸‰ä¸ªä¸²è¡Œé˜Ÿåˆ—</span><br>    <span class="hljs-built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="hljs-string">&quot;queue1&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    <span class="hljs-built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="hljs-string">&quot;queue2&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    <span class="hljs-built_in">dispatch_queue_t</span> queue3 = dispatch_queue_create(<span class="hljs-string">&quot;queue3&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    <br>    <span class="hljs-comment">//ç›®æ ‡é˜Ÿåˆ—</span><br>    <span class="hljs-built_in">dispatch_queue_t</span> targetQueue = dispatch_queue_create(<span class="hljs-string">&quot;targetQueue&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    <br>    <span class="hljs-comment">//å°†ä¸‰ä¸ªä¸²è¡Œé˜Ÿåˆ—åˆå¹¶åˆ°ç›®æ ‡ä¸²è¡Œé˜Ÿåˆ—ä¸­</span><br>    dispatch_set_target_queue(queue1, targetQueue);<br>    dispatch_set_target_queue(queue2, targetQueue);<br>    dispatch_set_target_queue(queue3, targetQueue);<br>    <br>    <span class="hljs-built_in">dispatch_async</span>(queue1, ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡1å¼€å§‹&quot;</span>);<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">3.</span>f];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡1ç»“æŸ&quot;</span>);<br>    &#125;);<br>    <span class="hljs-built_in">dispatch_async</span>(queue2, ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡2å¼€å§‹&quot;</span>);<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">2.</span>f];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡2ç»“æŸ&quot;</span>);<br>    &#125;);<br>    <span class="hljs-built_in">dispatch_async</span>(queue3, ^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡3å¼€å§‹&quot;</span>);<br>        [<span class="hljs-built_in">NSThread</span> sleepForTimeInterval:<span class="hljs-number">1.</span>f];<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä»»åŠ¡3ç»“æŸ&quot;</span>);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡1å¼€å§‹</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡1ç»“æŸ</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡2å¼€å§‹</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡2ç»“æŸ</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡3å¼€å§‹</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">ä»»åŠ¡3ç»“æŸ</span><br></code></pre></td></tr></table></figure><p>åŸå…ˆç›¸äº’ä¹‹é—´å¹¶å‘æ‰§è¡Œçš„ä¸‰ä¸ªä»»åŠ¡ï¼Œç°åœ¨æœ‰åºæ‰§è¡Œäº†~</p><p>å¦å¤–ï¼Œæ‰§è¡Œè¿™ä¸ªæ“ä½œåï¼Œ<code>queue1</code>ä¸Šå·²åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šç»§ç»­åœ¨<code>queue1</code>æ‰§è¡Œï¼Œå°šæœªæ‰§è¡Œçš„ä»»åŠ¡ä¼šåœ¨<code>targetQueue</code>ä¸Šæ‰§è¡Œã€‚</p><h3 id="11-è®¾ç½®é˜Ÿåˆ—æ ‡å¿—"><a href="#11-è®¾ç½®é˜Ÿåˆ—æ ‡å¿—" class="headerlink" title="11.è®¾ç½®é˜Ÿåˆ—æ ‡å¿—"></a>11.è®¾ç½®é˜Ÿåˆ—æ ‡å¿—</h3><p>ä½œç”¨ï¼š<code>dispatch_queue_set_specific</code>ç”¨æ¥å‘æŒ‡å®šé˜Ÿåˆ—é‡Œé¢è®¾ç½®ä¸€ä¸ªæ ‡è¯†ï¼Œé…åˆ<code>dispatch_get_specific</code>ä½¿ç”¨ã€‚</p><p>#ç¤ºä¾‹11.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-type">void</span> *key = <span class="hljs-string">&quot;queueKey&quot;</span>;<br>    <span class="hljs-type">void</span> *context = <span class="hljs-string">&quot;myQueueContext&quot;</span>;<br>    <br>    <span class="hljs-built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="hljs-string">&quot;queue1&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    dispatch_queue_set_specific(queue1, key,context, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-keyword">if</span> (dispatch_get_specific(key)) &#123;<br>        <span class="hljs-comment">//å½“å‰é˜Ÿåˆ—æ˜¯ä¸»é˜Ÿåˆ—ï¼Œä¸æ˜¯queue1ï¼Œæ‰€ä»¥å–ä¸åˆ°keyå¯¹åº”çš„å€¼ã€‚</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä¸»é˜Ÿåˆ—++queue1ï¼Ÿï¼šYES&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++ä¸»é˜Ÿåˆ—++queue1ï¼Ÿï¼šNO&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">dispatch_async</span>(queue1, ^&#123;<br>        <span class="hljs-keyword">if</span> (dispatch_get_specific(key)) &#123;<br>            <span class="hljs-comment">//å½“å‰é˜Ÿåˆ—æ˜¯queue1ï¼Œæ‰€ä»¥èƒ½å–åˆ°specificKeyå¯¹åº”çš„å€¼ã€‚</span><br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—++queue1ï¼Ÿï¼šYES&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—++queue1ï¼Ÿï¼šNO&quot;</span>);<br>        &#125;<br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">ä¸»é˜Ÿåˆ—</span><span class="hljs-literal">++</span><span class="hljs-comment">queue1ï¼Ÿï¼šNO</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—</span><span class="hljs-literal">++</span><span class="hljs-comment">queue1ï¼Ÿï¼šYES</span><br></code></pre></td></tr></table></figure><h3 id="12-dispatch-block-cancel"><a href="#12-dispatch-block-cancel" class="headerlink" title="12.dispatch_block_cancel"></a>12.dispatch_block_cancel</h3><p>ä½œç”¨ï¼šå–æ¶ˆå•ä¸ªä»»åŠ¡ã€‚</p><p>GCDä¸­ï¼Œä»»åŠ¡æ˜¯ä»¥blockçš„å½¢å¼è¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚iOS8ä¹‹åæ–°å¢<code>dispatch_block_cancel</code>æ–¹æ³•ï¼Œç”¨ä»¥å–æ¶ˆå·²åŠ å…¥é˜Ÿåˆ—ä½†å°šæœªæ‰§è¡Œçš„ä»»åŠ¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä»»åŠ¡å¿…é¡»æ˜¯ç”¨<code>dispatch_block_create</code>åˆ›å»º<code>dispatch_block_t</code>ã€‚å†è€…ï¼Œæ­¤æ–¹æ³•åªå¯¹å°šæœªæ‰§è¡Œçš„blockæœ‰æ•ˆï¼Œå¯¹æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡æ— æ•ˆã€‚</p><p>#ç¤ºä¾‹12.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//å–æ¶ˆä»»åŠ¡3</span><br><span class="hljs-built_in">dispatch_queue_t</span> conQueue = dispatch_queue_create(<span class="hljs-string">&quot;com.xxx.queue&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br><br>dispatch_block_t block1 = dispatch_block_create(<span class="hljs-number">0</span>, ^&#123;<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++block1&quot;</span>);<br>&#125;);<br><br>dispatch_block_t block2 = dispatch_block_create(<span class="hljs-number">0</span>, ^&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++block2&quot;</span>);<br>&#125;);<br><br>dispatch_block_t block3 = dispatch_block_create(<span class="hljs-number">0</span>, ^&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++block3&quot;</span>);<br>&#125;);<br><br><span class="hljs-built_in">dispatch_async</span>(conQueue, block1);<br><span class="hljs-built_in">dispatch_async</span>(conQueue, block2);<br><span class="hljs-built_in">dispatch_async</span>(conQueue, block3);<br>dispatch_block_cancel(block3);<br></code></pre></td></tr></table></figure><p>æ—¥å¿—:</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">block2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">block1</span><br></code></pre></td></tr></table></figure><h3 id="13-dispatch-semaphore"><a href="#13-dispatch-semaphore" class="headerlink" title="13.dispatch_semaphore"></a>13.dispatch_semaphore</h3><p>ä¿¡å·é‡ï¼šå°±æ˜¯ä¸€ç§å¯ç”¨æ¥æ§åˆ¶è®¿é—®èµ„æºçš„æ•°é‡çš„æ ‡è¯†ã€‚å½“ä¸€ä¸ªçº¿ç¨‹åœ¨è¿›å…¥ä¸€æ®µå…³é”®ä»£ç ä¹‹å‰ï¼Œçº¿ç¨‹å¿…é¡»è·å–ä¸€ä¸ªä¿¡å·é‡ï¼Œä¸€æ—¦è¯¥å…³é”®ä»£ç æ®µå®Œæˆäº†ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å¿…é¡»é‡Šæ”¾ä¿¡å·é‡ã€‚å…¶å®ƒæƒ³è¿›å…¥è¯¥å…³é”®ä»£ç æ®µçš„çº¿ç¨‹å¿…é¡»ç­‰å¾…å‰é¢çš„çº¿ç¨‹é‡Šæ”¾ä¿¡å·é‡ã€‚</p><p>æœ‰ä¸€ä¸ªç»å…¸çš„åœè½¦åœºçš„ä¾‹å­ï¼šä¿¡å·é‡çš„å€¼å°±ç›¸å½“äºå‰©ä½™è½¦ä½çš„æ•°ç›®ï¼Œ<code>dispatch_semaphore_wait</code>å°±ç›¸å½“äºæ¥äº†ä¸€è¾†è½¦ï¼Œ<code>dispatch_semaphore_signal</code>å°±ç›¸å½“äºèµ°äº†ä¸€è¾†è½¦ã€‚åœè½¦ä½çš„å‰©ä½™æ•°ç›®åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±å·²ç»æŒ‡æ˜äº†ï¼ˆdispatch_semaphore_create(value:Int)ï¼‰ï¼‰ï¼Œè°ƒç”¨ä¸€æ¬¡<code>dispatch_semaphore_signal</code>ï¼Œå‰©ä½™çš„è½¦ä½å°±å¢åŠ ä¸€ä¸ªï¼›è°ƒç”¨ä¸€æ¬¡<code>dispatch_semaphore_wait</code>å‰©ä½™è½¦ä½å°±å‡å°‘ä¸€ä¸ªï¼›å½“å‰©ä½™è½¦ä½ä¸º0æ—¶ï¼Œå†æ¥è½¦ï¼ˆå³è°ƒç”¨<code>dispatch_semaphore_wait</code>ï¼‰å°±åªèƒ½ç­‰å¾…ã€‚æœ‰è€å¿ƒçš„è½¦ä¸»ä¼šä¸€ç›´ç­‰ä¸‹å»ï¼Œæ²¡è€å¿ƒçš„è½¦ä¸»åœ¨ç­‰å¾…â€œä¸€æ®µæ—¶é—´â€ä¹‹åå°±ä¼šç¦»å¼€ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>åˆ›å»ºä¿¡å·é‡ï¼Œå‚æ•°ï¼šä¿¡å·é‡çš„åˆå€¼ï¼Œå¦‚æœå°äº<span class="hljs-number">0</span>åˆ™ä¼šè¿”å›NULL<br>dispatch_semaphore_createï¼ˆä¿¡å·é‡å€¼ï¼‰<br><br><span class="hljs-regexp">//</span>å‡å°‘ä¿¡å·é‡ï¼Œæ—¶é—´ï¼šDISPATCH_TIME_NOWã€DISPATCH_TIME_FOREVER<br>dispatch_semaphore_waitï¼ˆä¿¡å·é‡ï¼Œç­‰å¾…æ—¶é—´ï¼‰<br><br><span class="hljs-regexp">//</span>é‡Šæ”¾ä¿¡å·é‡<br>dispatch_semaphore_signal(ä¿¡å·é‡)<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹13.1ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(void)</span>semaphore&#123;<br>    dispatch_queue_t mQueue = dispatch_queue_create<span class="hljs-params">(<span class="hljs-string">&quot;concurrentQueue&quot;</span>, DISPATCH_QUEUE_CONCURRENT)</span>;<br>    dispatch_semaphore_t semaphore = dispatch_semaphore_create<span class="hljs-params">(<span class="hljs-number">0</span>)</span>;<br>    <br>    NSLog<span class="hljs-params">(@<span class="hljs-string">&quot;+++1&quot;</span>)</span>;<br>    dispatch_async<span class="hljs-params">(mQueue, ^&#123;</span><br><span class="hljs-params">        sleep(<span class="hljs-number">2</span>);</span><br><span class="hljs-params">        NSLog(@<span class="hljs-string">&quot;+++first task&quot;</span>);</span><br><span class="hljs-params">        dispatch_semaphore_signal(semaphore);</span><br><span class="hljs-params">    &#125;)</span>;<br>    NSLog<span class="hljs-params">(@<span class="hljs-string">&quot;+++2&quot;</span>)</span>;<br>    dispatch_semaphore_wait<span class="hljs-params">(semaphore, DISPATCH_TIME_FOREVER)</span>;<br>    <br>    NSLog<span class="hljs-params">(@<span class="hljs-string">&quot;+++3&quot;</span>)</span>;<br>    dispatch_async<span class="hljs-params">(mQueue, ^&#123;</span><br><span class="hljs-params">        sleep(<span class="hljs-number">2</span>);</span><br><span class="hljs-params">        NSLog(@<span class="hljs-string">&quot;+++second task&quot;</span>);</span><br><span class="hljs-params">        dispatch_semaphore_signal(semaphore);</span><br><span class="hljs-params">    &#125;)</span>;<br>    NSLog<span class="hljs-params">(@<span class="hljs-string">&quot;+++4&quot;</span>)</span>;<br>    dispatch_semaphore_wait<span class="hljs-params">(semaphore, DISPATCH_TIME_FOREVER)</span>;<br><br>    NSLog<span class="hljs-params">(@<span class="hljs-string">&quot;+++5&quot;</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">13</span>:<span class="hljs-number">18</span>:<span class="hljs-number">59</span> +++<span class="hljs-number">1</span><br><span class="hljs-attribute">13</span>:<span class="hljs-number">18</span>:<span class="hljs-number">59</span> +++<span class="hljs-number">2</span><br><span class="hljs-attribute">13</span>:<span class="hljs-number">19</span>:<span class="hljs-number">01</span> +++first task<br><span class="hljs-attribute">13</span>:<span class="hljs-number">19</span>:<span class="hljs-number">01</span> +++<span class="hljs-number">3</span><br><span class="hljs-attribute">13</span>:<span class="hljs-number">19</span>:<span class="hljs-number">01</span> +++<span class="hljs-number">4</span><br><span class="hljs-attribute">13</span>:<span class="hljs-number">19</span>:<span class="hljs-number">03</span> +++second task<br><span class="hljs-attribute">13</span>:<span class="hljs-number">19</span>:<span class="hljs-number">03</span> +++<span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­åˆ›å»ºäº†åˆå§‹å€¼&#x3D;0çš„ä¿¡å·é‡ï¼Œéšåå¼€å§‹äº†ä¸¤ä¸ªå¼‚æ­¥æ‰“å°æ•°å­—çš„ä»»åŠ¡ã€‚ä»æ—¥å¿—æ¥çœ‹ï¼Œâ€œ+++first taskâ€ åœ¨â€+++3â€ ä¹‹å‰ï¼Œè€Œâ€œ+++5â€æ˜¯æœ€åæ‰æ‰“å°çš„ï¼Œè¿™æ˜¯å› ä¸ºä¿¡å·é‡&#x3D;0æ—¶<code>dispatch_semaphore_wait()</code>å¤„è‡ªåŠ¨é˜»å¡äº†å½“å‰çº¿ç¨‹ï¼Œä¸¤ä¸ªæ‰“å°ä»»åŠ¡æ‰§è¡Œå®Œä¹‹å<code>dispatch_semaphore_signal()</code>ä½¿ä¿¡å·é‡&#x3D;1ï¼Œå½“å‰çº¿ç¨‹æ‰å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚</p><p>#ç¤ºä¾‹13.2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//åˆå§‹ä¿¡å·é‡</span><br>dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="hljs-number">1</span>);<br><span class="hljs-built_in">dispatch_queue_t</span> quene = dispatch_queue_create(<span class="hljs-string">&quot;com.M.D&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br><br><span class="hljs-comment">//ä»»åŠ¡1</span><br><span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;<br>    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ä»»åŠ¡1&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++å®Œæˆä»»åŠ¡1&quot;</span>);<br>    dispatch_semaphore_signal(semaphore);<br>&#125;);<br><br><span class="hljs-comment">//ä»»åŠ¡2</span><br><span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;<br>    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ä»»åŠ¡2&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++å®Œæˆä»»åŠ¡2&quot;</span>);<br>    dispatch_semaphore_signal(semaphore);<br>&#125;);<br><br><span class="hljs-comment">//ä»»åŠ¡3</span><br><span class="hljs-built_in">dispatch_async</span>(quene, ^&#123;<br>    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++ä»»åŠ¡3&quot;</span>);<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++å®Œæˆä»»åŠ¡3&quot;</span>);<br>    dispatch_semaphore_signal(semaphore);<br>&#125;);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡3</span><br></code></pre></td></tr></table></figure><p><strong>ps</strong>ï¼Œä¿¡å·é‡çš„ä½¿ç”¨åªä¿è¯äº†å¹¶å‘åœºæ™¯ä¸‹æ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶ä¸èƒ½ä¿è¯ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼Œå†è¿è¡Œä¸€æ¬¡åæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">ä»»åŠ¡2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">å®Œæˆä»»åŠ¡2</span><br></code></pre></td></tr></table></figure><h3 id="14-GCD-å®ç°å€’è®¡æ—¶"><a href="#14-GCD-å®ç°å€’è®¡æ—¶" class="headerlink" title="14.GCD å®ç°å€’è®¡æ—¶"></a>14.GCD å®ç°å€’è®¡æ—¶</h3><p>#ç¤ºä¾‹14.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//@property (strong, nonatomic) dispatch_source_t aTimer;</span><br><br>- (<span class="hljs-type">void</span>) GCDTimer<br>&#123;<br>    __block <span class="hljs-type">int</span> timeout = <span class="hljs-number">60</span>; <span class="hljs-comment">//å€’è®¡æ—¶æ—¶é—´</span><br>    <span class="hljs-built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>);<br>    <br>    _aTimer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,queue);<br>    <br>    dispatch_source_set_timer(_aTimer,dispatch_walltime(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>),<span class="hljs-number">1.0</span>*<span class="hljs-built_in">NSEC_PER_SEC</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">//æ¯ç§’æ‰§è¡Œ</span><br>    <br>    dispatch_source_set_event_handler(_aTimer, ^&#123;<br>        <span class="hljs-keyword">if</span>(timeout&lt;=<span class="hljs-number">0</span>)&#123; <span class="hljs-comment">//å€’è®¡æ—¶ç»“æŸï¼Œå…³é—­</span><br>            dispatch_source_cancel(_aTimer);<br>            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>                <span class="hljs-comment">//è®¾ç½®ç•Œé¢çš„æŒ‰é’®æ˜¾ç¤º æ ¹æ®è‡ªå·±éœ€æ±‚è®¾ç½®</span><br>            &#125;);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;<br>                <span class="hljs-comment">//è®¾ç½®ç•Œé¢çš„æŒ‰é’®æ˜¾ç¤º æ ¹æ®è‡ªå·±éœ€æ±‚è®¾ç½®</span><br>            &#125;);<br>            timeout--;<br>        &#125;<br>    &#125;);<br>    dispatch_resume(_aTimer);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="15-GCD-å®ç°åŒæ­¥é”"><a href="#15-GCD-å®ç°åŒæ­¥é”" class="headerlink" title="15.GCD å®ç°åŒæ­¥é”"></a>15.GCD å®ç°åŒæ­¥é”</h3><p>ä¸ºäº†ä¿è¯æ•°æ®è®¿é—®æˆ–è€…æ–¹æ³•è°ƒç”¨æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Œä¸€èˆ¬æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>é”</code>æ¥å®ç°åŒæ­¥æœºåˆ¶ï¼Œæ¯”å¦‚<code>@synchronized()</code>å’Œ<code>NSLock</code>ç­‰ã€‚ä½†æ˜¯ï¼Œé¢‘ç¹çš„ä¸Šé”ã€é‡Šæ”¾é”çš„æ“ä½œä¼šé™ä½æ‰§è¡Œæ•ˆç‡ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨<code>dispatch_barrier_async</code>ï¼Œé€šè¿‡ GCD å¯¹ä»»åŠ¡çš„è°ƒåº¦æ¥è¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚</p><p>æ€è·¯ï¼š<code>dispatch_barrier_async</code>èƒ½ç¡®ä¿åœ¨å…¶ä¹‹å‰æäº¤åˆ°é˜Ÿåˆ—çš„ä»»åŠ¡å…ˆæ‰§è¡Œï¼Œç„¶åæ‰§è¡Œå®ƒè‡ªå·±æäº¤çš„ä»»åŠ¡ï¼Œæœ€åæ‰§è¡Œå…¶åæäº¤çš„ä»»åŠ¡ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®çš„è¯»å†™æ“ä½œæ”¾å…¥ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œå†™æ•°æ®çš„ä»»åŠ¡é€šè¿‡<code>æ …æ </code>æäº¤åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¯»æ•°æ®çš„ä»»åŠ¡åˆ™å¯ä»¥åŒæ­¥çš„æäº¤åˆ°é˜Ÿåˆ—ä¸­ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œè¯»æ“ä½œæˆ–å…¶ä»–å†™æ“ä½œéƒ½è¢«é˜»å¡ï¼Œè€Œæ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œå†™æ“ä½œè¢«é˜»å¡ï¼Œå°†è¯»å†™åˆ†å¼€ä»è€Œé¿å…æ•°æ®çš„æ±¡æŸ“ã€‚</p><p>#ç¤ºä¾‹15.1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSMutableArray</span> *mArr;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">dispatch_queue_t</span> mPropertyConcurrentQueue;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br><span class="hljs-keyword">@synthesize</span> mArr = _mArr;<br><br>- (<span class="hljs-built_in">NSMutableArray</span> *)mArr&#123;<br>    __block <span class="hljs-built_in">NSMutableArray</span> *tmpArr;<br>    <span class="hljs-built_in">dispatch_sync</span>(_mPropertyConcurrentQueue, ^&#123;<span class="hljs-comment">//å¹¶å‘é˜Ÿåˆ—+åŒæ­¥=ä¸²è¡Œï¼Œä¸èƒ½ä½¿ç”¨dispatch_asyncï¼Œä¼šç›´æ¥è¿”å›</span><br>        tmpArr = _mArr;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> tmpArr;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)setMArr:(<span class="hljs-built_in">NSMutableArray</span> *)mArr&#123;<br>    dispatch_barrier_async(_mPropertyConcurrentQueue, ^&#123;<br>        _mArr = mArr;<br>    &#125;);<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//ä½¿ç”¨è‡ªå·±åˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ—ï¼Œä¸èƒ½ä½¿ç”¨ç³»ç»Ÿçš„dispatch_get_global_queueï¼Œä¸Šé¢ç« èŠ‚ä¸­æœ‰è®²åˆ°è¿™ä¸€ç‚¹</span><br>    _mPropertyConcurrentQueue = dispatch_queue_create(<span class="hljs-string">&quot;readWriteQueue&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <span class="hljs-built_in">dispatch_queue_t</span> tmpQueue = dispatch_queue_create(<span class="hljs-string">&quot;1&quot;</span>, DISPATCH_QUEUE_CONCURRENT);<br>            <span class="hljs-keyword">if</span> ((i % <span class="hljs-number">2</span>) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-built_in">dispatch_async</span>(tmpQueue, ^&#123;<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++Reset array,thread:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>                    <span class="hljs-keyword">self</span>.mArr = [<span class="hljs-built_in">NSMutableArray</span> array];<br>                &#125;);<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-built_in">dispatch_async</span>(tmpQueue, ^&#123;<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++Add num:%d,thread:%@&quot;</span>,i,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>                    [<span class="hljs-keyword">self</span>.mArr addObject:@(i)];<br>                &#125;);<br>            &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¤šçº¿ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤šçº¿ç¨‹ï¼šNSThread</title>
    <link href="/2017/11/07/nsthread.html"/>
    <url>/2017/11/07/nsthread.html</url>
    
    <content type="html"><![CDATA[<h3 id="1ã€è¿›ç¨‹-amp-çº¿ç¨‹"><a href="#1ã€è¿›ç¨‹-amp-çº¿ç¨‹" class="headerlink" title="1ã€è¿›ç¨‹ &amp; çº¿ç¨‹"></a>1ã€è¿›ç¨‹ &amp; çº¿ç¨‹</h3><p>#å®šä¹‰ä¸åˆ’åˆ†å°ºåº¦ï¼š</p><ul><li>ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯è¿›ç¨‹ï¼Œå®ƒæ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½ã€‚</li><li>çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯è¿›ç¨‹å†…çš„ä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚</li></ul><p>#åœ°å€ç©ºé—´ï¼š</p><ul><li>è¿›ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè€Œçº¿ç¨‹å…±äº«è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</li></ul><p>#æ‹¥æœ‰çš„èµ„æºï¼š</p><ul><li>è¿›ç¨‹æ˜¯èµ„æºåˆ†é…å’Œæ‹¥æœ‰çš„å•ä½ï¼›åŒä¸€ä¸ªè¿›ç¨‹å†…çš„çº¿ç¨‹å…±äº«è¿›ç¨‹èµ„æºã€‚</li></ul><p>#æ‰§è¡Œå•ä½ï¼š</p><ul><li>çº¿ç¨‹æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ï¼Œè€Œè¿›ç¨‹ä¸æ˜¯ã€‚</li></ul><p>#å¹¶å‘ï¼š</p><ul><li>äºŒè€…å‡å¯å¹¶å‘æ‰§è¡Œï¼ˆæ‰“å¼€å¤šä¸ªåº”ç”¨ä¸ºè¿›ç¨‹å¹¶å‘ï¼›å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œä¸‹è½½ä»»åŠ¡ä¸ºçº¿ç¨‹å¹¶å‘ï¼‰ã€‚</li></ul><h3 id="2ã€å¹¶å‘-amp-å¹¶è¡Œ"><a href="#2ã€å¹¶å‘-amp-å¹¶è¡Œ" class="headerlink" title="2ã€å¹¶å‘ &amp; å¹¶è¡Œ"></a>2ã€å¹¶å‘ &amp; å¹¶è¡Œ</h3><p>1ã€åœºæ™¯ï¼š</p><p>å¹¶å‘ï¼Œä¸€ä¸ªå¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ã€‚ </p><p>å¹¶è¡Œï¼Œå¤šä¸ªå¤„ç†å™¨æˆ–å¤šæ ¸çš„å¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä¸åŒçš„ä»»åŠ¡ã€‚<br><br/></p><p>2ã€æ¦‚å¿µåŒºåˆ†ï¼š</p><p><strong>å¹¶å‘</strong>(Concurrency)ï¼šåœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œï¼Œä½†å¤šä¸ªæŒ‡ä»¤è¢«å¿«é€Ÿçš„è½®æ¢æ‰§è¡Œï¼Œä½¿å¾—åœ¨å®è§‚ä¸Šå…·æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œçš„æ•ˆæœï¼Œä½†åœ¨å¾®è§‚ä¸Šå¹¶ä¸æ˜¯åŒæ—¶æ‰§è¡Œçš„ã€‚<br><br/></p><p><strong>å¹¶è¡Œ</strong>(Parallel)ï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ‰å¤šæ¡æŒ‡ä»¤åœ¨å¤šä¸ªå¤„ç†å™¨ä¸ŠåŒæ—¶æ‰§è¡Œï¼Œæ— è®ºä»å¾®è§‚è¿˜æ˜¯ä»å®è§‚æ¥çœ‹ï¼ŒäºŒè€…éƒ½æ˜¯ä¸€èµ·æ‰§è¡Œçš„ã€‚</p><h3 id="3ã€å¤šçº¿ç¨‹"><a href="#3ã€å¤šçº¿ç¨‹" class="headerlink" title="3ã€å¤šçº¿ç¨‹"></a>3ã€å¤šçº¿ç¨‹</h3><p><strong>ä¸ºä»€ä¹ˆè¦æœ‰å¤šçº¿ç¨‹ï¼Ÿ</strong><br><br/></p><p>iOSåº”ç”¨ä¸­ä¸»çº¿ç¨‹ç”¨æ¥å¤„ç†ç•Œé¢æ›´æ–°ã€å“åº”ç”¨æˆ·è§¦æ‘¸äº‹ä»¶ç­‰ã€‚åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œå¤§é‡è€—æ—¶æ“ä½œä¼šé€ æˆä¸»çº¿ç¨‹é˜»å¡ï¼Œè¿›è€Œå‡ºç°å¡é¡¿ç°è±¡ä»¥è‡´å½±å“ä½¿ç”¨å’Œç”¨æˆ·ä½“éªŒã€‚æ•…éœ€è¦å°†è¿™ç§è€—æ—¶æ“ä½œæ”¾åˆ°å…¶ä»–çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚æ‰€ä»¥å¤šçº¿ç¨‹ç¼–ç¨‹æ˜¯é˜²æ­¢ä¸»çº¿ç¨‹å µå¡ï¼Œå¢åŠ è¿è¡Œæ•ˆç‡çš„æœ€ä½³æ–¹æ³•ã€‚</p><br/><p><strong>ä¸ºä»€ä¹ˆä¸æ— é™åˆ¶çš„å¼€è¾ŸNæ¡æ–°çº¿ç¨‹å‘¢ï¼Ÿ</strong></p><ul><li>é¦–å…ˆï¼Œçº¿ç¨‹çš„åˆ›å»ºéœ€è¦å¼€é”€ï¼Œå ç”¨ä¸€å®šå¾—å†…å­˜ç©ºé—´ï¼›</li><li>å…¶æ¬¡ï¼Œæœ‰Næ¡çº¿ç¨‹æ—¶å¤„ç†å™¨éœ€è¦åœ¨å¤šæ¡çº¿ç¨‹ä¹‹é—´é¢‘ç¹è°ƒåº¦ï¼Œè¿™ä¹Ÿéœ€è¦å¤§é‡å¼€é”€ï¼›</li><li>æœ€åï¼ŒNæ¡çº¿ç¨‹æ—¶è¿˜éœ€è¦è€ƒè™‘åˆ°è¿™äº›çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡å’Œèµ„æºå…±äº«ç­‰é—®é¢˜ã€‚</li></ul><p><strong>æœ‰å“ªäº›å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆï¼Ÿ</strong><br><br/></p><p>iOSæ”¯æŒå¤šä¸ªå±‚æ¬¡çš„å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå±‚æ¬¡è¶Šé«˜çš„æŠ½è±¡ç¨‹åº¦è¶Šé«˜ï¼Œä½¿ç”¨ä¹Ÿè¶Šæ–¹ä¾¿ï¼Œä¹Ÿæ˜¯è‹¹æœæœ€æ¨èä½¿ç”¨çš„æ–¹æ³•ã€‚æ ¹æ®æŠ½è±¡ç¨‹åº¦ç”±ä½åˆ°é«˜åˆ—å‡ºå¦‚ä¸‹ï¼š</p><ul><li><strong>NSThread ï¼š</strong></li></ul><p>æ˜¯ä¸‰ç§æ–¹æ³•é‡Œé¢ç›¸å¯¹è½»é‡çº§çš„ï¼Œéœ€è¦è‡ªå·±ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€åŒæ­¥ã€åŠ é”é—®é¢˜ï¼Œè¿™ä¼šå¯¼è‡´ä¸€å®šçš„æ€§èƒ½å¼€é”€ã€‚</p><ul><li><strong>NSOperationï¼š</strong></li></ul><p>æ˜¯åŸºäºOCå®ç°çš„ï¼Œå®ƒä»¥é¢å‘å¯¹è±¡çš„æ–¹å¼å°è£…äº†éœ€è¦æ‰§è¡Œçš„æ“ä½œï¼Œä¸å¿…å…³å¿ƒçº¿ç¨‹ç®¡ç†ã€åŒæ­¥ç­‰é—®é¢˜ã€‚NSOperation æ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼ŒiOSæä¾›äº†ä¸¤ç§é»˜è®¤å®ç°ï¼šNSInvocationOperation å’Œ NSBlockOperationï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ NSOperationã€‚</p><ul><li><strong>Grand Central Dispatch(ç®€ç§°GCDï¼ŒiOS4æ‰å¼€å§‹æ”¯æŒ)ï¼š</strong></li></ul><p>æä¾›äº†ä¸€äº›æ–°ç‰¹æ€§ã€è¿è¡Œåº“æ¥æ”¯æŒå¤šæ ¸å¹¶è¡Œç¼–ç¨‹ï¼Œå®ƒçš„å…³æ³¨ç‚¹æ›´é«˜ï¼šå¦‚ä½•åœ¨å¤šä¸ªCPUä¸Šæå‡æ•ˆç‡ã€‚</p><h3 id="4ã€NSThread"><a href="#4ã€NSThread" class="headerlink" title="4ã€NSThread"></a>4ã€NSThread</h3><h4 id="4-1-ç”Ÿå‘½å‘¨æœŸ"><a href="#4-1-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="4.1.ç”Ÿå‘½å‘¨æœŸ"></a>4.1.ç”Ÿå‘½å‘¨æœŸ</h4><p>#åˆ›å»º</p><ul><li>å®ä¾‹æ–¹æ³•ï¼šåˆ›å»ºåéœ€è¦æ‰‹åŠ¨è°ƒç”¨startå‡½æ•°æ¥å¯åŠ¨çº¿ç¨‹ï¼›</li></ul><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(instancetype)</span>initWithTarget:<span class="hljs-params">(id)</span>target <br>selector:<span class="hljs-params">(SEL)</span>selector <br>object:<span class="hljs-params">(id)</span>argument;<br><br>- <span class="hljs-params">(instancetype)</span>initWithBlock:<span class="hljs-params">(void (^)</span><span class="hljs-params">(void)</span>)block ;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ç§å®ä¾‹åŒ–æ–¹æ³•ä¸­ï¼Œå‚æ•°selectorä¼šåœ¨åˆšåˆ›å»ºçš„çº¿ç¨‹å¯¹è±¡æ‰§è¡Œ<code>start</code>æ–¹æ³•ä¹‹åè¢«è°ƒç”¨ï¼Œä¸”æ˜¯åœ¨å½“å‰æ–°çº¿ç¨‹ä¸­è°ƒç”¨ã€‚</p><ul><li>ç±»æ–¹æ³•ï¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨startå‡½æ•°ã€‚</li></ul><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-operator">+</span> (<span class="hljs-keyword">void</span>)detachNewThreadWithBlock<span class="hljs-operator">:</span>(<span class="hljs-keyword">void</span> (<span class="hljs-operator">^</span>)(<span class="hljs-keyword">void</span>))block ;<br><br><span class="hljs-operator">+</span> (<span class="hljs-keyword">void</span>)detachNewThreadSelector<span class="hljs-operator">:</span>(SEL)selector <br>toTarget<span class="hljs-operator">:</span>(<span class="hljs-built_in">id</span>)target <br>withObject<span class="hljs-operator">:</span>(<span class="hljs-built_in">id</span>)argument;<br></code></pre></td></tr></table></figure><ul><li>åˆ†ç±»åˆ›å»ºï¼šNSObject(NSThreadPerformAdditions)</li></ul><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(void)</span>performSelectorInBackground:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>arg;<br></code></pre></td></tr></table></figure><p>#å°±ç»ª</p><ul><li>å°†çº¿ç¨‹æ”¾è¿›å¯è°ƒåº¦çº¿ç¨‹æ± ,ç­‰å¾…è¢«CPUè°ƒåº¦:</li></ul><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[threadObj start]</span>ï¼›<span class="hljs-comment">//æ³¨æ„ï¼šåŒä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ä¸èƒ½è¿ç»­è°ƒç”¨startæ–¹æ³•ï¼</span><br></code></pre></td></tr></table></figure><p>#è¿è¡Œ</p><ul><li>CPUè´Ÿè´£è°ƒåº¦çº¿ç¨‹æ± ä¸­å¤„äºâ€å°±ç»ªçŠ¶æ€â€çš„çº¿ç¨‹ã€‚</li></ul><p>#é˜»å¡</p><ul><li>æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹,å¯ä»¥ç”¨ä¼‘çœ æˆ–è€…é”æ¥é˜»å¡çº¿ç¨‹çš„æ‰§è¡Œã€‚</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-type">void</span>)sleepUntilDate:(<span class="hljs-built_in">NSDate</span> *)date;<br>+ (<span class="hljs-type">void</span>)sleepForTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti;<br></code></pre></td></tr></table></figure><ul><li>äº’æ–¥é”</li></ul><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">@synchronized</span>(<span class="hljs-keyword">self</span>)<br></code></pre></td></tr></table></figure><p>#æ­»äº¡<br><br/></p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ˆä¸è€ƒè™‘å¼•ç”¨ã€runloopï¼‰ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åä¼šè‡ªåŠ¨é”€æ¯ã€‚ä¹Ÿå¯ä»¥åœ¨æ»¡è¶³æŸæ¡ä»¶åè°ƒç”¨exitæ–¹æ³•ï¼Œå¼ºåˆ¶çº¿ç¨‹é€€å‡ºã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">[NSThread <span class="hljs-keyword">exit</span>];<br></code></pre></td></tr></table></figure><h4 id="4-2-çº¿ç¨‹é—´é€šä¿¡"><a href="#4-2-çº¿ç¨‹é—´é€šä¿¡" class="headerlink" title="4.2.çº¿ç¨‹é—´é€šä¿¡"></a>4.2.çº¿ç¨‹é—´é€šä¿¡</h4><ul><li>æŒ‡å®šå½“å‰çº¿ç¨‹æ‰§è¡Œæ“ä½œ</li></ul><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crystal">[<span class="hljs-keyword">self</span> <span class="hljs-symbol">performSelector:</span><span class="hljs-variable">@selector</span>(run)];<br>[<span class="hljs-keyword">self</span> <span class="hljs-symbol">performSelector:</span><span class="hljs-variable">@selector</span>(run) <span class="hljs-symbol">withObject:</span><span class="hljs-literal">nil</span>];<br>[<span class="hljs-keyword">self</span> <span class="hljs-symbol">performSelector:</span><span class="hljs-variable">@selector</span>(run) <span class="hljs-symbol">withObject:</span><span class="hljs-literal">nil</span> <span class="hljs-symbol">afterDelay:</span><span class="hljs-number">5.0</span>];<br></code></pre></td></tr></table></figure><ul><li>åœ¨ä¸»çº¿ç¨‹æŒ‡å®šå…¶ä»–çº¿ç¨‹æ‰§è¡Œæ“ä½œ</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">[<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(run) onThread:newThread withObject:<span class="hljs-literal">nil</span> waitUntilDone:<span class="hljs-literal">YES</span>]; <br>[<span class="hljs-keyword">self</span> performSelectorInBackground:<span class="hljs-keyword">@selector</span>(run) withObject:<span class="hljs-literal">nil</span>];<br></code></pre></td></tr></table></figure><ul><li>åœ¨å…¶ä»–çº¿ç¨‹ä¸­æŒ‡å®šä¸»çº¿ç¨‹æ‰§è¡Œæ“ä½œ</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">[<span class="hljs-keyword">self</span> performSelectorOnMainThread:<span class="hljs-keyword">@selector</span>(run) withObject:<span class="hljs-literal">nil</span> waitUntilDone:<span class="hljs-literal">YES</span>];<br></code></pre></td></tr></table></figure><h4 id="4-3-çº¿ç¨‹åŒæ­¥"><a href="#4-3-çº¿ç¨‹åŒæ­¥" class="headerlink" title="4.3.çº¿ç¨‹åŒæ­¥"></a>4.3.çº¿ç¨‹åŒæ­¥</h4><p>å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™åŒä¸€ä»½å…±äº«èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šå¼•èµ·å†²çªã€‚<code>çº¿ç¨‹åŒæ­¥</code>æ˜¯æŒ‡åœ¨ä¸€å®šæ—¶é—´å†…åªå…è®¸æŸä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºã€‚OC ä¸­å®ç°çº¿ç¨‹åŠ é”æœ‰ NSLock å’Œ @synchronized ç­‰æ–¹å¼ã€‚</p><ul><li>NSLock åˆ›å»ºé”å¯¹è±¡ã€åŠ é”å’Œè§£é”:</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">NSLock * <span class="hljs-keyword">lock</span> = [[NSLock alloc]init];<br>  <br>dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^&#123;<br>    [<span class="hljs-keyword">lock</span> <span class="hljs-keyword">lock</span>];<br>    // <span class="hljs-keyword">do</span> <span class="hljs-keyword">work</span><br>    [<span class="hljs-keyword">lock</span> unlock];<br>&#125;);<br></code></pre></td></tr></table></figure><ul><li>@synchronized()æŒ‡ä»¤å¯¹ä¸€æ®µä»£ç è¿›è¡ŒåŠ é”ã€‚å®ƒéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°å¯ä»¥æ˜¯ä»»ä½•çš„OCå¯¹è±¡ï¼ŒåŒ…æ‹¬selfã€‚è¿™ä¸ªå¯¹è±¡å°±æ˜¯äº’æ–¥ä¿¡å·é‡ã€‚</li></ul><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-variable">@synchronized</span>(<span class="hljs-variable language_">self</span>)  &#123;<br>    <span class="hljs-regexp">//</span> <span class="hljs-keyword">do</span> work<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5ã€çº¿ç¨‹ä¿æ´»"><a href="#5ã€çº¿ç¨‹ä¿æ´»" class="headerlink" title="5ã€çº¿ç¨‹ä¿æ´»"></a>5ã€çº¿ç¨‹ä¿æ´»</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå­çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åï¼Œä¼šè‡ªåŠ¨é”€æ¯ã€‚å¦‚æœæƒ³å¤ç”¨æ­¤çº¿ç¨‹æˆ–è€…ç»§ç»­åœ¨æ­¤çº¿ç¨‹ä¸Šæ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œåˆ™éœ€è¦è®©æ­¤çº¿ç¨‹ä¸€ç›´æ´»ç€è€Œä¸è¢«é”€æ¯ï¼›<br><br/></p><p>æ€è·¯ï¼šç»™å­çº¿ç¨‹æ‰€åœ¨runloopæ·»åŠ äº‹ä»¶æºï¼Œå¦‚ç«¯å£æˆ–è‡ªå®šä¹‰sourceï¼Œä¿è¯æ­¤runloopä¸é€€å‡ºã€‚éœ€è¦åœæ­¢å­çº¿ç¨‹æ—¶ï¼Œåœæ­¢çº¿ç¨‹æ‰€åœ¨runloopå³å¯~</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-comment">// è‡ªå®šä¹‰çº¿ç¨‹</span><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">HelThread </span>: NSThread<br><span class="hljs-variable">@end</span><br><br><br><span class="hljs-comment">// çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†ç±»</span><br><span class="hljs-variable">@interface</span> <span class="hljs-attribute">HelThreadHelper </span>: NSObject<br><br><span class="hljs-comment">/// çº¿ç¨‹åˆå§‹åŒ–</span><br><span class="hljs-comment">/// @param name çº¿ç¨‹å</span><br><span class="hljs-built_in">-</span>(instancetype)<span class="hljs-attribute">initWithName</span>:(NSString*)name;<br><br><span class="hljs-comment">/// å¼€å¯çº¿ç¨‹</span><br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">start</span>;<br><br><span class="hljs-comment">/// åœæ­¢å½“å‰çº¿ç¨‹</span><br><span class="hljs-selector-tag">-</span> (void)<span class="hljs-selector-tag">stop</span>;<br><br><span class="hljs-comment">/// è·å–çº¿ç¨‹</span><br><span class="hljs-selector-tag">-</span>(NSThread *)<span class="hljs-selector-tag">getThread</span>;<br><br>@<span class="hljs-selector-tag">end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;HelThreadHelper.h&quot;</span></span><br><br><span class="hljs-comment">//MAKR: -HelThread</span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">HelThread</span></span><br><br>- (<span class="hljs-type">void</span>)dealloc&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++THREAD IS DEALLOCED~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-comment">//MAKR: -HelThreadHelper</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">HelThreadHelper</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) HelThread *mThread;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSCondition</span> *mConditionLock;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">HelThreadHelper</span></span><br><br><span class="hljs-comment">//MARK: -APIs</span><br>-(<span class="hljs-keyword">instancetype</span>)initWithName:(<span class="hljs-built_in">NSString</span>*)name&#123;<br>    <span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>) &#123;<br>        _mConditionLock = [[<span class="hljs-built_in">NSCondition</span> alloc] init];<br>        _mThread = [[HelThread alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(onThreadInit:) object:<span class="hljs-literal">nil</span>];<br>        _mThread.name = name;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)start&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++call Start:%@&quot;</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);<br>    [_mConditionLock lock];<br>    [_mThread start];<br>    [_mConditionLock wait]; <span class="hljs-comment">// é˜²æ­¢å¤šçº¿ç¨‹ç¯å¢ƒä¸‹onThreadInitä¸­å°šæœªè®¾ç½®runloopå°±å¼€å§‹åœ¨_mThreadä¸Šæ‰§è¡Œä»»åŠ¡çš„æƒ…å†µ</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++runloop Set finised~&quot;</span>);<br>    [_mConditionLock unlock];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)stop&#123;<br>    <span class="hljs-comment">// å›åˆ°æ‰€åœ¨çº¿ç¨‹ åœæ­¢å…¶runloop</span><br>    [<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(finish) onThread:_mThread withObject:<span class="hljs-literal">nil</span> waitUntilDone:<span class="hljs-literal">NO</span>];<br>&#125;<br><br>-(<span class="hljs-built_in">NSThread</span> *)getThread&#123;<br>    <span class="hljs-keyword">return</span> _mThread;<br>&#125;<br><br><span class="hljs-comment">//MARK: -Self Business</span><br>- (<span class="hljs-type">void</span>)onThreadInit:(<span class="hljs-type">id</span>)obj&#123;<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop Start:%@&quot;</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);<br>    <br>    <span class="hljs-comment">// çº¿ç¨‹ä¿æ´»</span><br>    <span class="hljs-built_in">CFRunLoopSourceContext</span> context = &#123;<span class="hljs-number">0</span>&#125;;<br>    context.perform = DoNothingRunLoopCallback;<br>    <br>    <span class="hljs-built_in">CFRunLoopSourceRef</span> source = <span class="hljs-built_in">CFRunLoopSourceCreate</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;context);<br>    <span class="hljs-built_in">CFRunLoopAddSource</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>(), source, kCFRunLoopCommonModes);<br>    <br>    [_mConditionLock lock];<br>    [_mConditionLock signal]; <span class="hljs-comment">// çº¿ç¨‹åˆ›å»ºå’Œè®¾ç½®å·²å®Œæˆï¼Œå‘Šè¯‰è°ƒç”¨è€…å¯ä»¥åœ¨_mThreadä¸Šæ‰§è¡Œä»»åŠ¡äº†</span><br>    [_mConditionLock unlock];<br>    <br>    <span class="hljs-comment">// å¼€å¯runloopï¼Œå¼€å§‹å¤„ç†ä»»åŠ¡</span><br>    <span class="hljs-built_in">CFRunLoopRun</span>(); <span class="hljs-comment">// å¼€å¯å¾ªç¯ï¼Œåœ¨è¢«åœæ­¢å‰ä¼šä¸€ç›´è¿è¡Œåœ¨è¿™ä¸€è¡Œï¼Œä¸æ‰§è¡Œåé¢ä¸€è¡Œä»£ç </span><br>    <br>    <span class="hljs-comment">// runloopå·²è¢«åœæ­¢ æ‰§è¡Œæ¸…ç†ä»»åŠ¡</span><br>    <span class="hljs-built_in">CFRunLoopRemoveSource</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>(), source, kCFRunLoopCommonModes);<br>    <span class="hljs-built_in">CFRelease</span>(source);<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop stop:%@&quot;</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)finish&#123;<br>    <span class="hljs-built_in">CFRunLoopStop</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>()); <span class="hljs-comment">// ç»“æŸrunloop</span><br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-type">void</span> DoNothingRunLoopCallback(<span class="hljs-type">void</span> *info)&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop å›è°ƒ~&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;HelThreadHelper.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) HelThreadHelper *mHelper;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-variable language_">super</span> viewDidLoad];<br>    _mHelper = [[HelThreadHelper alloc] initWithName:<span class="hljs-string">@&quot;com.Hel.MyThread&quot;</span>];<br>    [_mHelper start];<br>&#125;<br><br><span class="hljs-comment">// è§¦å‘ä»»åŠ¡</span><br>- (<span class="hljs-keyword">IBAction</span>)onClick:(<span class="hljs-type">id</span>)sender &#123;<br>    [<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(onSel:)<br>      onThread:[_mHelper getThread]<br>    withObject:<span class="hljs-literal">nil</span> waitUntilDone:<span class="hljs-literal">NO</span>];<br>&#125;<br><br><span class="hljs-comment">// ç»“æŸçº¿ç¨‹</span><br>- (<span class="hljs-keyword">IBAction</span>)onStop:(<span class="hljs-type">id</span>)sender &#123;<br>    [_mHelper stop];<br>    _mHelper = <span class="hljs-literal">nil</span>; <span class="hljs-comment">// _mHelperç½®ä¸ºnilåï¼Œå…¶ä¸­è¢«å¼ºå¼•ç”¨çš„_mThreadçº¿ç¨‹æ‰ä¼šé”€æ¯</span><br>&#125;<br><br>- (<span class="hljs-type">void</span>)onSel:(<span class="hljs-type">id</span>)obj&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++call onSel: THREAD:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†åˆ«ç‚¹å‡»å¼€å§‹å’Œç»“æŸæŒ‰é’®ï¼Œæ‰§è¡Œä»»åŠ¡å’Œç»“æŸçº¿ç¨‹ï¼š</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs fortran">+++<span class="hljs-keyword">call</span> Start:&lt;NSThread: <span class="hljs-number">0</span>x600003000040&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">1</span>, <span class="hljs-keyword">name</span> = main&#125;<br>+++runloop Start:&lt;HelThread: <span class="hljs-number">0</span>x6000030602c0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">5</span>, <span class="hljs-keyword">name</span> = com.Hel.MyThread&#125;<br>++runloop Set finised~<br>+++<span class="hljs-keyword">call</span> onSel: THREAD:&lt;HelThread: <span class="hljs-number">0</span>x6000030602c0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">5</span>, <span class="hljs-keyword">name</span> = com.Hel.MyThread&#125;<br>+++runloop <span class="hljs-keyword">stop</span>:&lt;HelThread: <span class="hljs-number">0</span>x6000030602c0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">5</span>, <span class="hljs-keyword">name</span> = com.Hel.MyThread&#125;<br>++++THREAD IS DEALLOCED~<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¤šçº¿ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Runloop</title>
    <link href="/2017/09/09/runloop.html"/>
    <url>/2017/09/09/runloop.html</url>
    
    <content type="html"><![CDATA[<h2 id="1-Runloop"><a href="#1-Runloop" class="headerlink" title="1.Runloop"></a>1.Runloop</h2><blockquote><p>Run loops are part of the fundamental infrastructure associated with threads.A run loop is an event processing loop that you use to schedule work and coordinate the receipt of incoming events.The purpose of a run loop is to keep your thread busy when there is work to do and put your thread to sleep when there is none.</p></blockquote><p><code>Runloop</code>æ˜¯å¤„ç†äº‹ä»¶çš„å¾ªç¯ï¼Œä¸çº¿ç¨‹ç´§å¯†ç›¸å…³ã€‚å¯åŠ¨åæ‰€åœ¨çº¿ç¨‹ç›¸å½“äºä¸€ç›´å¤„åœ¨<code>do-while</code>å¾ªç¯ä¸­ï¼Œä»è€Œé¿å…æ²¡äº‹åšè¢«ç³»ç»Ÿè‡ªåŠ¨å›æ”¶ï¼›æ­¤æ—¶è¦é”€æ¯è¿™ä¸ªçº¿ç¨‹å¿…é¡»åœæ­¢è¿™ä¸ª Runloopã€‚</p><h3 id="1-1-ä½œç”¨"><a href="#1-1-ä½œç”¨" class="headerlink" title="1.1.ä½œç”¨"></a>1.1.ä½œç”¨</h3><ol><li>ä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œï¼›</li><li>å¤„ç†Appä¸­çš„å„ç§äº‹ä»¶(å¦‚è§¦æ‘¸äº‹ä»¶ã€å®šæ—¶å™¨äº‹ä»¶ã€Selectoräº‹ä»¶)ï¼›</li><li>ä½¿çº¿ç¨‹æœ‰ä»»åŠ¡æ—¶æ‰§è¡Œä»»åŠ¡ï¼Œæ— ä»»åŠ¡æ—¶ä¼‘çœ ï¼Œä»¥èŠ‚çœCPUèµ„æºï¼Œæé«˜ç¨‹åºæ€§èƒ½ï¼›</li></ol><h3 id="1-2-ä¸çº¿ç¨‹çš„å…³ç³»"><a href="#1-2-ä¸çº¿ç¨‹çš„å…³ç³»" class="headerlink" title="1.2.ä¸çº¿ç¨‹çš„å…³ç³»"></a>1.2.ä¸çº¿ç¨‹çš„å…³ç³»</h3><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç›¸å…³çš„ Runloop å¯¹è±¡ï¼ŒCocoaä¸CFæ¡†æ¶éƒ½æä¾›äº†æ¥å£å¸®åŠ©ç®¡ç†çº¿ç¨‹çš„Runloopï¼Œæ— é¡»æˆ‘ä»¬æ˜¾å¼çš„åˆ›å»ºè¿™äº›å¯¹è±¡ã€‚</p><ul><li><strong>ä¸»çº¿ç¨‹</strong></li></ul><p>åœ¨ç¨‹åºå¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨<code>ä¸»çº¿ç¨‹</code>ä¸Šè®¾ç½®å¹¶å¯åŠ¨äº†ä¸€ä¸ª Runloopã€‚å…·ä½“å…¥å£æ˜¯åœ¨ main æ–‡ä»¶ä¸­çš„å¦‚ä¸‹ä»£ç ä¸­ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;AppDelegate.h&quot;</span></span><br><br><span class="hljs-type">int</span> main(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[]) &#123;<br>    <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">UIApplicationMain</span>(argc, argv, <span class="hljs-literal">nil</span>, <span class="hljs-built_in">NSStringFromClass</span>([AppDelegate <span class="hljs-keyword">class</span>]));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°<code>UIApplicationMain()</code>å†…éƒ¨ä¸ºä¸»çº¿ç¨‹å¯åŠ¨äº†ä¸€ä¸ªrunloopã€‚åº”ç”¨èƒ½åœ¨æ— ä»»ä½•æ“ä½œæ—¶ä¼‘çœ ï¼Œç›‘å¬åˆ°è¾“å…¥äº‹ä»¶æ—¶ç«‹é©¬å“åº”ï¼Œå°±æ˜¯å› ä¸ºæœ‰è¿™ä¸ªrunloopåœ¨ä¸€ç›´ç›‘å¬å’Œå“åº”è¿™äº›äº‹ä»¶ã€‚</p><ul><li><strong>å…¶ä»–çº¿ç¨‹</strong></li></ul><p>é™¤ä¸»çº¿ç¨‹å¤–ï¼Œå…¶ä»–çº¿ç¨‹çš„ runloop é»˜è®¤éƒ½æ˜¯æ²¡æœ‰å¼€å¯çš„ã€‚è¿™äº›çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ—¶æ˜¯ä¸€æ¡ç›´çº¿ç±»å‹ï¼Œä»èµ·ç‚¹åˆ°ç»ˆç‚¹ï¼Œæ‰§è¡Œå®Œä»»åŠ¡åçº¿ç¨‹å°±ä¼šé”€æ¯æ‰ã€‚å¦‚æœæƒ³è®©å­çº¿ç¨‹ä¿æ´»å¹¶ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™å¯è‡ªè¡Œé…ç½®å¹¶å¯åŠ¨å…¶runloopã€‚<br><br/></p><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//è‡ªå®šä¹‰ASDFThread</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ASDFThread</span> : <span class="hljs-title">NSThread</span></span><br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ASDFThread</span></span><br><br>- (<span class="hljs-type">void</span>)dealloc&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++THREAD IS DEALLOCED~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-comment">//AppDelegate åœ¨è‡ªå®šä¹‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ASDFThread.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    ASDFThread *th = [[ASDFThread alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(onHandleEvent) object:<span class="hljs-literal">nil</span>];<br>    [th start];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onHandleEvent&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å½“å‰çº¿ç¨‹:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">++++å½“å‰çº¿ç¨‹:&lt;ASDFThread: <span class="hljs-number">0x600003575e80</span>&gt;&#123;number = <span class="hljs-number">3</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++++THREAD <span class="hljs-keyword">IS</span> DEALLOCED~<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè‡ªå®šä¹‰çš„ ASDFThread çº¿ç¨‹å¯¹è±¡åœ¨æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åï¼Œè‡ªåŠ¨é”€æ¯äº†ã€‚<br><br/></p><p>å¦‚æœè¦çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åï¼Œä»ä¸é”€æ¯ä»¥ä¾¿å¤ç”¨ï¼Œåˆ™å¯ä»¥åœ¨å½“å‰çº¿ç¨‹ä¸­å¼€å¯ Runloopï¼š<br><br/></p><p>#ç¤ºä¾‹2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)onHandleEvent&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å½“å‰çº¿ç¨‹:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    <br>    <span class="hljs-comment">//å¼€å¯runloop</span><br>    <span class="hljs-built_in">CFRunLoopSourceContext</span> context = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">CFRunLoopSourceRef</span> source = <span class="hljs-built_in">CFRunLoopSourceCreate</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;context);<br>    <span class="hljs-built_in">CFRunLoopAddSource</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>(), source, kCFRunLoopCommonModes);<br>    <span class="hljs-built_in">CFRunLoopRun</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡å¾€å­çº¿ç¨‹æ‰€åœ¨çš„runloopä¸­åŠ å…¥ä¸€ä¸ª<code>source</code>å¹¶å¯åŠ¨æ­¤runloopï¼Œçº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åå°±ä¸ä¼šè‡ªåŠ¨é”€æ¯ã€‚<br><br/></p><p><strong>ps</strong>ï¼šçº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰RunLoopå¯¹è±¡ï¼Œåªåœ¨æˆ‘ä»¬ç¬¬ä¸€æ¬¡å»è·å–æ—¶æ‰ä¼šåˆ›å»ºï¼ŒRunLoopä¼šåœ¨çº¿ç¨‹ç»“æŸæ—¶é”€æ¯ã€‚</p><h2 id="2-RunLoopMode"><a href="#2-RunLoopMode" class="headerlink" title="2.RunLoopMode"></a>2.RunLoopMode</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">struct</span> __CFRunLoopMode &#123;<br><span class="hljs-built_in">CFStringRef</span> _name;   <span class="hljs-comment">//Modeçš„åå­—</span><br><br><span class="hljs-built_in">CFMutableSetRef</span> _sources0;<br><span class="hljs-built_in">CFMutableSetRef</span> _sources1;<br><br><span class="hljs-built_in">CFMutableArrayRef</span> _observers;<span class="hljs-comment">//è§‚å¯Ÿè€…</span><br><span class="hljs-built_in">CFMutableArrayRef</span> _timers;<span class="hljs-comment">//è®¡æ—¶å™¨</span><br>.....<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿è¡Œå¾ªç¯æ¨¡å¼ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸ªç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«äº†ä¸ä¹‹å¯¹åº”çš„äº‹ä»¶ç±»å‹ã€è§‚å¯Ÿè€…å’Œè®¡æ—¶å™¨ç­‰ã€‚<br><br/></p><p>Runloop å¯¹è±¡å¯ä»¥å’Œè‹¥å¹²ä¸ª <code>mode</code> å…³è”èµ·æ¥ã€‚ä½†åŒä¸€æ—¶é—´ Runloop åªèƒ½è¿è¡Œåœ¨ä¸€ç§æ¨¡å¼ä¸‹ï¼›è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåªæœ‰æŒ‡å®šæ¨¡å¼ä¸‹çš„è¾“å…¥æºæ‰ä¼šè¢«ç›‘å¬ã€‚åŒç†ä¹Ÿåªæœ‰æŒ‡å®šæ¨¡å¼ä¸‹çš„è§‚å¯Ÿè€…æ‰ä¼šè¢«é€šçŸ¥å½“å‰runloopçš„è¿›åº¦ã€‚<br><br/></p><p>å½“éœ€è¦åˆ‡æ¢ mode æ—¶ï¼Œå¿…é¡»å…ˆé€€å‡ºå½“å‰çš„ RunLoopï¼Œå†é‡æ–°å¯åŠ¨ä¸€ä¸ªæ–°çš„ RunLoopã€‚</p><h3 id="2-1-å…·ä½“æ¨¡å¼"><a href="#2-1-å…·ä½“æ¨¡å¼" class="headerlink" title="2.1.å…·ä½“æ¨¡å¼"></a>2.1.å…·ä½“æ¨¡å¼</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">NSDefaultRunLoopMode</span><br></code></pre></td></tr></table></figure><p>ç³»ç»Ÿé»˜è®¤æ¨¡å¼ï¼Œç³»ç»Ÿä¸åšä»»ä½•æ“ä½œã€ç©ºé—²çŠ¶æ€ï¼›</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">UITrackingRunLoopMode</span><br></code></pre></td></tr></table></figure><p>ç•Œé¢è·Ÿè¸ªæ¨¡å¼ï¼Œç”¨ä»¥åœ¨æ‹–åŠ¨ç•Œé¢æ—¶é™åˆ¶å…¶ä»–äº‹ä»¶çš„è¿›å…¥ï¼Œæ»‘åŠ¨æ—¶ä¸»çº¿ç¨‹çš„runloopä¼šä»Defaultæ¨¡å¼åˆ‡æ¢åˆ°trackingæ¨¡å¼ï¼›</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">NSRunLoopCommonModes</span><br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸ªå¯é…ç½®çš„æ¨¡å¼é›†åˆè€Œéä¸€ä¸ªçœŸæ­£çš„æ¨¡å¼ï¼Œé»˜è®¤åŒ…æ‹¬äº† <code>Default</code> å’Œ <code>EventTracking</code> æ¨¡å¼ã€‚å°† <code>è¾“å…¥æº</code> ä¸è¯¥æ¨¡å¼å…³è”ï¼Œå®è´¨æ˜¯å°†<code>è¾“å…¥æº</code>ä¸è¯¥ç»„ä¸­çš„æ¯ä¸ªæ¨¡å¼è¿›è¡Œäº†å…³è”ã€‚</p><h3 id="2-2-å®šæ—¶å™¨å¤±æ•ˆ"><a href="#2-2-å®šæ—¶å™¨å¤±æ•ˆ" class="headerlink" title="2.2.å®šæ—¶å™¨å¤±æ•ˆ"></a>2.2.å®šæ—¶å™¨å¤±æ•ˆ</h3><p>å®šæ—¶å™¨é»˜è®¤ä½¿ç”¨<code>default</code>æ¨¡å¼ï¼Œè€Œæ‹–æ‹½æ»šåŠ¨ scrollview æ—¶ Runloop å¤„äº<code>Tracking</code>æ¨¡å¼ã€‚ç”±äº Runloop ä¸€æ¬¡åªèƒ½è¿è¡Œåœ¨ä¸€ç§æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥æ»šåŠ¨è¿‡ç¨‹ä¸­ä¸»çº¿ç¨‹Runloopæ— æ³•å¤„ç†æ³¨å†Œåœ¨å…¶<code>default</code>æ¨¡å¼ä¸‹çš„å®šæ—¶å™¨äº‹ä»¶ï¼Œå› æ­¤å®šæ—¶å™¨ä¹Ÿå°±ä¸ä¼šè§¦å‘ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p><h4 id="æ–¹æ¡ˆ1-Mode"><a href="#æ–¹æ¡ˆ1-Mode" class="headerlink" title="æ–¹æ¡ˆ1: Mode"></a>æ–¹æ¡ˆ1: Mode</h4><p>å°†å®šæ—¶å™¨æ ‡è®°ä¸º<code>common</code>æ¨¡å¼ã€‚</p><p>æ€è·¯ï¼šå®šæ—¶å™¨é»˜è®¤è¢«åŠ å…¥åˆ°ä¸»çº¿ç¨‹Runloopçš„<code>default</code>æ¨¡å¼ä¸­ï¼Œè¢«æ ‡è®°ä¸º<code>common</code>åä¼šè‡ªåŠ¨ä¸<code>common</code>æ¨¡å¼ä¸­çš„<code>Tracking</code>æ¨¡å¼è¿›è¡Œå…³è”ã€‚æ»‘åŠ¨æ—¶ä¸»çº¿ç¨‹çš„Runloopå¤„åœ¨<code>Tracking</code>æ¨¡å¼ï¼Œæ‰€ä»¥è®¡æ—¶å™¨äº‹ä»¶ä¹Ÿèƒ½æ­£å¸¸å“åº”äº†ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSTimer</span> *aTimer = [<span class="hljs-built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="hljs-number">1</span><br>                                                       target:<span class="hljs-keyword">self</span><br>                                                     selector:<span class="hljs-keyword">@selector</span>(repeat:)<br>                                                     userInfo:<span class="hljs-literal">nil</span><br>                                                      repeats:<span class="hljs-literal">true</span>];<br>[[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop] addTimer:aTimer forMode:<span class="hljs-built_in">NSRunLoopCommonModes</span>];<br></code></pre></td></tr></table></figure><h4 id="æ–¹æ¡ˆ2-å­çº¿ç¨‹"><a href="#æ–¹æ¡ˆ2-å­çº¿ç¨‹" class="headerlink" title="æ–¹æ¡ˆ2: å­çº¿ç¨‹"></a>æ–¹æ¡ˆ2: å­çº¿ç¨‹</h4><p>å°†å®šæ—¶å™¨æ”¾å…¥å­çº¿ç¨‹ä¸­å¹¶å¼€å¯æ­¤çº¿ç¨‹çš„ runloopï¼š</p><p>æ€è·¯ï¼šæ»‘åŠ¨æ“ä½œå‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ï¼Œå®šæ—¶å™¨æ‰€åœ¨çš„çº¿ç¨‹æ˜¯å­çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸¤è€…äº’ä¸å½±å“ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">dispatch_async</span>(<span class="hljs-title function_ invoke__">dispatch_get_global_queue</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;<br>        [NSTimer <span class="hljs-attr">scheduledTimerWithTimeInterval</span>:<span class="hljs-number">1</span><br>                                         <span class="hljs-attr">target</span>:<span class="hljs-built_in">self</span><br>                                       <span class="hljs-attr">selector</span>:@<span class="hljs-title function_ invoke__">selector</span>(<span class="hljs-attr">aSelector</span>:)<br>                                       <span class="hljs-attr">userInfo</span>:nil <span class="hljs-attr">repeats</span>:<span class="hljs-literal">true</span>];<br>        [[NSRunLoop currentRunLoop] run];<br>    &#125;);<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­çº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨ï¼Œä¸€å®šè¦ä¸»åŠ¨å¼€å¯å­çº¿ç¨‹çš„runloopï¼Œå¦åˆ™å®šæ—¶å™¨ä¸ä¼šè§¦å‘ã€‚</p><h4 id="æ–¹æ¡ˆ3-GCD-timer"><a href="#æ–¹æ¡ˆ3-GCD-timer" class="headerlink" title="æ–¹æ¡ˆ3: GCD timer"></a>æ–¹æ¡ˆ3: GCD timer</h4><p>ä½¿ç”¨GCDæä¾›çš„å®šæ—¶å™¨API:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;GCDTimerTest.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">GCDTimerTest</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">dispatch_queue_t</span> seriaqueue;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) dispatch_source_t timer;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">GCDTimerTest</span></span><br><br>- (<span class="hljs-type">void</span>)gcd_timer&#123;<br>    _seriaqueue = dispatch_queue_create(<span class="hljs-string">&quot;xx&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    __<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) wself = <span class="hljs-keyword">self</span>;<br>    <span class="hljs-built_in">dispatch_async</span>(_seriaqueue, ^&#123;<br>        __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(wself) sself = wself;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop before timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        sself.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sself.seriaqueue);<br>        dispatch_source_set_timer(sself.timer, DISPATCH_TIME_NOW, <span class="hljs-number">1</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>, <span class="hljs-number">0</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>);<br>        dispatch_source_set_event_handler(sself.timer, ^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œè®¡æ—¶ä»»åŠ¡&quot;</span>);<br>            <span class="hljs-comment">//dispatch_source_cancel(sself.timer);</span><br>        &#125;);<br>        dispatch_resume(sself.timer);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop after timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>    &#125;);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>GCDå®šæ—¶å™¨ä¸æ˜¯runloopçš„æºï¼Œä¸å—Modeåˆ‡æ¢çš„å½±å“ï¼Œå¯å‚è€ƒæœ¬æ–‡<code>#3.2å®šæ—¶æº-ç‰¹æ®Šå®šæ—¶å™¨</code>ç« èŠ‚çš„è§£æã€‚</p><h2 id="3-äº‹ä»¶æ¥æº"><a href="#3-äº‹ä»¶æ¥æº" class="headerlink" title="3.äº‹ä»¶æ¥æº"></a>3.äº‹ä»¶æ¥æº</h2><p>Runloopä¸­æœ‰äº†äº‹ä»¶æºæ‰ä¼šæœ‰äº‹åšï¼Œæ‰ä¸ä¼šé€€å‡ºå¾ªç¯ã€‚äº‹ä»¶æºåˆ†ä¸¤å¤§ç±»ï¼š<code>è¾“å…¥æº</code>å’Œ<code>å®šæ—¶æº</code>ã€‚</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_runloop.jpg" alt="image"></p><h3 id="3-1-è¾“å…¥æº"><a href="#3-1-è¾“å…¥æº" class="headerlink" title="3.1.è¾“å…¥æº"></a>3.1.è¾“å…¥æº</h3><p>è¾“å…¥æºäº‹ä»¶åˆ†ä¸º<code>source0</code>å’Œ<code>source1</code>ä¸¤ç§:</p><ul><li>source0ï¼šè¯¸å¦‚UIEventï¼ˆè§¦æ‘¸ï¼Œæ»‘åŠ¨ç­‰ï¼‰ï¼ŒperformSelectorè¿™ç§éœ€è¦æ‰‹åŠ¨è§¦å‘çš„äº‹ä»¶ã€‚</li><li>source1ï¼šåŸºäºç«¯å£çš„äº‹ä»¶ï¼Œå¤„ç†ç³»ç»Ÿå†…æ ¸çš„mach_msgäº‹ä»¶ã€‚è¯¸å¦‚å”¤é†’RunLoopæˆ–è€…è®©RunLoopè¿›å…¥ä¼‘çœ ç­‰ã€‚</li></ul><h4 id="1-åŸºäºç«¯å£çš„è¾“å…¥æº"><a href="#1-åŸºäºç«¯å£çš„è¾“å…¥æº" class="headerlink" title="1.åŸºäºç«¯å£çš„è¾“å…¥æº"></a>1.åŸºäºç«¯å£çš„è¾“å…¥æº</h4><p><code>Source1</code>ç±»å‹ï¼Œèƒ½ä¸»åŠ¨å”¤é†’çº¿ç¨‹çš„ RunLoopã€‚å†…æ ¸ä¸­è¿›ç¨‹é—´çš„é€šä¿¡é€šè¿‡åœ¨ä¸¤ä¸ªç«¯å£ä¹‹é—´ä¼ é€’æ¶ˆæ¯æ¥å®ç°ï¼ŒSource1 ç›‘å¬çš„æ­£æ˜¯è¿™äº›ç«¯å£ã€‚ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºç«¯å£ï¼Œä»¥å®ç°ä¸åŒçº¿ç¨‹é—´çš„é€šä¿¡ã€‚<br><br/></p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)runloopPortTest<br>&#123;<br>    <span class="hljs-comment">//åˆ›å»ºç«¯å£</span><br>    <span class="hljs-type">NSPort</span> <span class="hljs-operator">*</span><span class="hljs-type">PORT1</span> <span class="hljs-operator">=</span> [<span class="hljs-type">NSMachPort</span> new];<br>    <span class="hljs-type">NSPort</span> <span class="hljs-operator">*</span><span class="hljs-type">PORT2</span> <span class="hljs-operator">=</span> [<span class="hljs-type">NSMachPort</span> port];<br><br>    <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;<span class="hljs-subst">\n</span>PORT1:%@ <span class="hljs-subst">\n</span>PORT2:%@&quot;</span>,<span class="hljs-type">PORT1</span>, <span class="hljs-type">PORT2</span>);<br><br>    <span class="hljs-comment">//è®¾ç½®ç«¯å£çš„ä»£ç†</span><br>    <span class="hljs-type">PORT1</span>.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>;<br>    <span class="hljs-type">PORT2</span>.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>;<br><br>    <span class="hljs-comment">//ç»™ä¸»çº¿ç¨‹runloopåŠ ä¸€ä¸ªç«¯å£</span><br>    [[<span class="hljs-type">NSRunLoop</span> currentRunLoop] addPort:<span class="hljs-type">PORT1</span> forMode:<span class="hljs-type">NSDefaultRunLoopMode</span>];<br><br>    <span class="hljs-comment">//ç»™å­çº¿ç¨‹æ·»åŠ ç«¯å£å¹¶å¯åŠ¨å…¶runloop</span><br>    dispatch_async(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-operator">^</span>&#123;<br>        [[<span class="hljs-type">NSRunLoop</span> currentRunLoop] addPort:<span class="hljs-type">PORT2</span> forMode:<span class="hljs-type">NSDefaultRunLoopMode</span>];<br>        [[<span class="hljs-type">NSRunLoop</span> currentRunLoop] runMode:<span class="hljs-type">NSDefaultRunLoopMode</span> beforeDate:[<span class="hljs-type">NSDate</span> distantFuture]];<br>    &#125;);<br><br>    <span class="hljs-comment">//componentå‚æ•°æ•°ç»„ä¸­åªèƒ½åŒ…å«ä¸¤ç§ç±»å‹çš„æ•°æ®ï¼šä¸€ç§æ˜¯NSPortçš„å­ç±»ï¼Œä¸€ç§æ˜¯NSDataçš„å­ç±»ï¼›</span><br>    <span class="hljs-type">NSString</span> <span class="hljs-operator">*</span><span class="hljs-type">STR</span> <span class="hljs-operator">=</span> @<span class="hljs-string">&quot;III&quot;</span>;<br>    <span class="hljs-type">NSData</span>   <span class="hljs-operator">*</span>data <span class="hljs-operator">=</span> [<span class="hljs-type">STR</span> dataUsingEncoding:<span class="hljs-type">NSUTF8StringEncoding</span>];<br>    <span class="hljs-type">NSMutableArray</span> <span class="hljs-operator">*</span>array <span class="hljs-operator">=</span> [<span class="hljs-type">NSMutableArray</span> arrayWithArray:@[<span class="hljs-type">PORT1</span>,data]];<br><br>    <span class="hljs-comment">//2ç§’åå‘PORT2å‘é€æ¶ˆæ¯</span><br>    dispatch_after(dispatch_time(<span class="hljs-type">DISPATCH_TIME_NOW</span>, (int64_t)(<span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-type">NSEC_PER_SEC</span>)), <br>                                    dispatch_get_main_queue(), <span class="hljs-operator">^</span>&#123;<br>        [<span class="hljs-type">PORT2</span> sendBeforeDate:[<span class="hljs-type">NSDate</span> date] msgid:<span class="hljs-number">101</span> components:array from:<span class="hljs-type">PORT1</span> reserved:<span class="hljs-number">0</span>];<br>    &#125;);<br>&#125;<br><br>#pragma mark <span class="hljs-operator">-</span><span class="hljs-type">NSPortDelegate</span><br><span class="hljs-operator">-</span> (void)handlePortMessage:(<span class="hljs-type">NSMessagePort</span><span class="hljs-operator">*</span>)message&#123;<br>    <span class="hljs-comment">//1. æ¶ˆæ¯id</span><br>    <span class="hljs-type">NSUInteger</span> msgId <span class="hljs-operator">=</span> [[message valueForKeyPath:@<span class="hljs-string">&quot;msgid&quot;</span>] integerValue];<br>    <span class="hljs-comment">//2. å½“å‰ä¸»çº¿ç¨‹çš„port</span><br>    <span class="hljs-type">NSPort</span> <span class="hljs-operator">*</span>localPort <span class="hljs-operator">=</span> [message valueForKeyPath:@<span class="hljs-string">&quot;localPort&quot;</span>];<br>    <span class="hljs-comment">//3. æ¥æ”¶åˆ°æ¶ˆæ¯çš„portï¼ˆæ¥è‡ªå…¶ä»–çº¿ç¨‹ï¼‰</span><br>    <span class="hljs-type">NSPort</span> <span class="hljs-operator">*</span>remotePort <span class="hljs-operator">=</span> [message valueForKeyPath:@<span class="hljs-string">&quot;remotePort&quot;</span>];<br><br>    <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;<span class="hljs-subst">\n</span>æ‰§è¡Œç«¯å£ä»£ç†å›è°ƒï¼š<span class="hljs-subst">\n</span>ç«¯å£ID = %lu <span class="hljs-subst">\n</span>localPort:%@ </span><br><span class="hljs-string">    <span class="hljs-subst">\n</span>remotePort:%@&quot;</span>,(unsigned long)msgId, localPort, remotePort);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">101</span> <span class="hljs-operator">==</span> msgId)&#123;<br>        <span class="hljs-comment">//å‘å­çº¿çš„portå‘é€æ¶ˆæ¯</span><br>        [remotePort sendBeforeDate:[<span class="hljs-type">NSDate</span> date] msgid:<span class="hljs-number">102</span> components:<span class="hljs-literal">nil</span> from:localPort reserved:<span class="hljs-number">0</span>];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">102</span> <span class="hljs-operator">==</span> msgId)&#123;<br>    <span class="hljs-comment">//....</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">19</span>:<span class="hljs-number">30:24.335</span><br>PORT1:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000549d70</span>&gt;<br>PORT2:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000340370</span>&gt;<br><span class="hljs-number">19</span>:<span class="hljs-number">30:26.337</span><br>æ‰§è¡Œç«¯å£ä»£ç†å›è°ƒï¼š<br>ç«¯å£ID = <span class="hljs-number">101</span><br>localPort:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000340370</span>&gt;<br>remotePort:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000549d70</span>&gt;<br><span class="hljs-number">19</span>:<span class="hljs-number">30:26.337</span><br>æ‰§è¡Œç«¯å£ä»£ç†å›è°ƒï¼š<br>ç«¯å£ID = <span class="hljs-number">102</span><br>localPort:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000549d70</span>&gt;<br>remotePort:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000340370</span>&gt;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­ä¸¤ä¸ªçº¿ç¨‹é—´äº’ç›¸å‘é€äº†ä¸€æ¡æ¶ˆæ¯ã€‚</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(BOOL)</span>sendBeforeDate:<span class="hljs-params">(NSDate *)</span>limitDate<br>                 msgid:<span class="hljs-params">(NSUInteger)</span>msgID<br>            components:<span class="hljs-params">(NSMutableArray *)</span>components<br>                  from:<span class="hljs-params">(NSPort *)</span>receivePort<br>              reserved:<span class="hljs-params">(NSUInteger)</span>headerSpaceReserved;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ–¹æ³•ä¸­ï¼Œå‚æ•°componentsæ•°ç»„ä¸­åªèƒ½ä¼ NSPortã€NSDataç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥é™¤äº†NSPortå¯¹è±¡å¤–ï¼Œå…¶ä»–æ•°æ®éœ€è¦å…ˆè½¬æˆNSDataç±»å‹ã€‚</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@protocol</span> NSPortDelegate &lt;NSObject&gt;<br><span class="hljs-variable">@optional</span><br><br>- (void)<span class="hljs-attribute">handlePortMessage</span>:(NSPortMessage *)message;<br><span class="hljs-comment">// This is the delegate method that subclasses should send</span><br><span class="hljs-comment">// to their delegates, unless the subclass has something</span><br><span class="hljs-comment">// more specific that it wants to try to send first</span><br><span class="hljs-variable">@end</span><br></code></pre></td></tr></table></figure><p>æ¶ˆæ¯å›è°ƒä¹‹åï¼Œé€šè¿‡ä¸Šé¢çš„ä»£ç†æ¥æ”¶ï¼Œå…¶ä¸­çš„ NSMessagePort ç±»å‹åªèƒ½ç”¨ <code>KVC</code> çš„æ–¹å¼å–å€¼ã€‚</p><h4 id="2-è‡ªå®šä¹‰çš„è¾“å…¥æº"><a href="#2-è‡ªå®šä¹‰çš„è¾“å…¥æº" class="headerlink" title="2.è‡ªå®šä¹‰çš„è¾“å…¥æº"></a>2.è‡ªå®šä¹‰çš„è¾“å…¥æº</h4><p><code>Source0</code>ç±»å‹ï¼Œå®ƒå¹¶ä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ã€‚ä½¿ç”¨æ—¶è¦å…ˆè°ƒç”¨ <code>CFRunLoopSourceSignal()</code>ï¼Œå°†æ­¤ Source æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚ç„¶åçœ‹å½“å‰ Runloop æ˜¯å¦åœ¨ä¼‘çœ ä¸­ï¼Œå¦‚æœæ˜¯åˆ™æ‰‹åŠ¨è°ƒç”¨ <code>CFRunLoopWakeUp()</code> æ¥å”¤é†’ RunLoopï¼Œè®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚<br><br/></p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void source<span class="hljs-constructor">Performor(<span class="hljs-params">void</span><span class="hljs-operator">*</span> <span class="hljs-params">info</span>)</span><br>&#123;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;å¤„ç†è‡ªå®šä¹‰è¾“å…¥æºäº‹ä»¶&quot;</span>)</span>;<br>&#125;<br><br>- (void)customInputsource<br>&#123;<br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">dispatch_get_global_queue</span>(0, 0)</span>, ^&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;å¼€å¯çº¿ç¨‹.......&quot;</span>)</span>;<br>        _mRunLoopRef = <span class="hljs-constructor">CFRunLoopGetCurrent()</span>;<br>        <br>        <span class="hljs-comment">//åˆ›å»ºCFRunLoopSourceContextå¯¹è±¡</span><br>        CFRunLoopSourceContext mContext;<br>        bzero(&amp;mContext, sizeof(mContext));<br>        <br>        <span class="hljs-comment">//ç»™contextå¯¹è±¡ç»‘å®šä¸€ä¸ªå‡½æ•°</span><br>        mContext.perform = sourcePerformor;<br>        mContext.info = <span class="hljs-string">&quot;information&quot;</span>;<br>        <br>        <span class="hljs-comment">//åˆ›å»ºCFRunLoopSourceRefå¯¹è±¡</span><br>        _mSourceRef = <span class="hljs-constructor">CFRunLoopSourceCreate(NULL, 0, &amp;<span class="hljs-params">mContext</span>)</span>;<br>        <br>        <span class="hljs-comment">//å°†sourceæ·»åŠ åˆ°å½“å‰RunLoopä¸­</span><br>        <span class="hljs-constructor">CFRunLoopAddSource(<span class="hljs-params">_mRunLoopRef</span>, <span class="hljs-params">_mSourceRef</span>, <span class="hljs-params">kCFRunLoopDefaultMode</span>)</span>;<br>        <br>        <span class="hljs-comment">//å¼€å¯Runloop</span><br>        <span class="hljs-constructor">CFRunLoopRunInMode(<span class="hljs-params">kCFRunLoopDefaultMode</span>, 10000, YES)</span>;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;çº¿ç¨‹ç»“æŸ.......&quot;</span>)</span>;<br>    &#125;);<br>    <br>    <span class="hljs-comment">//2ç§’åæ‰§è¡Œ</span><br>    dispatch<span class="hljs-constructor">_after(<span class="hljs-params">dispatch_time</span>(DISPATCH_TIME_NOW, (<span class="hljs-params">int64_t</span>)</span>(<span class="hljs-number">2</span><span class="hljs-operator"> * </span>NSEC_PER_SEC)),<br>                   dispatch<span class="hljs-constructor">_get_main_queue()</span>, ^&#123;<br>        <br>        <span class="hljs-keyword">if</span> (<span class="hljs-constructor">CFRunLoopIsWaiting(<span class="hljs-params">_mRunLoopRef</span>)</span>) &#123;<br>            <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;RunLoopæ­£åœ¨ç­‰å¾…äº‹ä»¶è¾“å…¥+++&quot;</span>)</span>;<br>            <span class="hljs-comment">//æ·»åŠ è¾“å…¥äº‹ä»¶</span><br>            <span class="hljs-constructor">CFRunLoopSourceSignal(<span class="hljs-params">_mSourceRef</span>)</span>; <br>            <span class="hljs-comment">//å”¤é†’çº¿ç¨‹ï¼Œçº¿ç¨‹å”¤é†’åå‘ç°ç”±äº‹ä»¶éœ€è¦å¤„ç†ï¼Œäºæ˜¯ç«‹å³å¤„ç†äº‹ä»¶</span><br>            <span class="hljs-constructor">CFRunLoopWakeUp(<span class="hljs-params">_mRunLoopRef</span>)</span>; <span class="hljs-comment">// åœ¨ä¸»çº¿ç¨‹ä¸­å”¤é†’å…¶ä»–å­çº¿ç¨‹çš„runloopã€‚</span><br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;RunLoopæ­£åœ¨å¤„ç†äº‹ä»¶+++&quot;</span>)</span>;<br>            <span class="hljs-comment">//æ·»åŠ è¾“å…¥äº‹ä»¶ï¼Œå½“å‰æ­£åœ¨å¤„ç†ä¸€ä¸ªäº‹ä»¶ï¼Œå½“å‰äº‹ä»¶å¤„ç†å®Œæˆåï¼Œç«‹å³å¤„ç†å½“å‰æ–°è¾“å…¥çš„äº‹ä»¶</span><br>            <span class="hljs-constructor">CFRunLoopSourceSignal(<span class="hljs-params">_mSourceRef</span>)</span>;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œåï¼Œè¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00</span>:<span class="hljs-number">32</span>:<span class="hljs-number">21</span>.<span class="hljs-number">497879</span>+<span class="hljs-number">0800</span>  å¼€å¯çº¿ç¨‹.......<br><span class="hljs-attribute">00</span>:<span class="hljs-number">32</span>:<span class="hljs-number">24</span>.<span class="hljs-number">663180</span>+<span class="hljs-number">0800</span>  RunLoopæ­£åœ¨ç­‰å¾…äº‹ä»¶è¾“å…¥+++<br><span class="hljs-attribute">00</span>:<span class="hljs-number">32</span>:<span class="hljs-number">24</span>.<span class="hljs-number">663498</span>+<span class="hljs-number">0800</span>  å¤„ç†è‡ªå®šä¹‰è¾“å…¥æºäº‹ä»¶<br><span class="hljs-attribute">00</span>:<span class="hljs-number">32</span>:<span class="hljs-number">24</span>.<span class="hljs-number">663881</span>+<span class="hljs-number">0800</span>  çº¿ç¨‹ç»“æŸ.......<br></code></pre></td></tr></table></figure><h4 id="3-Perform-Selector"><a href="#3-Perform-Selector" class="headerlink" title="3.Perform Selector"></a>3.Perform Selector</h4><p><code>Source0</code>ç±»å‹ï¼Œæ˜¯ Cocoa æä¾›çš„ä¸€ç§è‡ªå®šä¹‰çš„æºï¼Œå…è®¸ä½ åœ¨ä»»ä½•çº¿ç¨‹ä¸Šæ‰§è¡Œä¸€ä¸ªselectorã€‚ä¸‹é¢åˆ—ä¸¾äº†<code>NSObject</code>åˆ†ç±»ä¸­å®šä¹‰çš„ä¸‰ç§<code>performSelector</code>æ–¹æ³•ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs erlang">@interface NSObject (NSThreadPerformAdditions)<br><br>- <span class="hljs-params">(void)</span>performSelectorOnMainThread:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>arg <br>waitUntilDone:<span class="hljs-params">(BOOL)</span>wait <br>modes:<span class="hljs-params">(NSArray&lt;NSString *&gt; *)</span>array;<br><br>- <span class="hljs-params">(void)</span>performSelectorOnMainThread:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>arg <br>waitUntilDone:<span class="hljs-params">(BOOL)</span>wait;<br>// equivalent to the first method with kCFRunLoopCommonModes<br><br>- <span class="hljs-params">(void)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector <br>onThread:<span class="hljs-params">(NSThread *)</span>thr <br>withObject:<span class="hljs-params">(id)</span>arg <br>waitUntilDone:<span class="hljs-params">(BOOL)</span>wait <br>modes:<span class="hljs-params">(NSArray&lt;NSString *&gt; *)</span>array;<br><br>- <span class="hljs-params">(void)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector <br>onThread:<span class="hljs-params">(NSThread *)</span>thr <br>withObject:<span class="hljs-params">(id)</span>arg <br>waitUntilDone:<span class="hljs-params">(BOOL)</span>wait;<br>// equivalent to the first method with kCFRunLoopCommonModes<br><br>- <span class="hljs-params">(void)</span>performSelectorInBackground:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>arg;<br><br>@end<br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>OnMainThread</code> æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ï¼›</li><li><code>onThread</code> æ˜¯åœ¨ä½ æŒ‡å®šçš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå¯ä»¥æ˜¯ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥æ˜¯å­çº¿ç¨‹ï¼›</li><li><code>InBackground</code> åˆ™æ˜¯åœ¨ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„ä¸€ä¸ªå­çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼›</li><li><code>withObject</code> æ˜¯ selector æ–¹æ³•çš„å‚æ•°ï¼›</li><li><code>waitUntilDone</code> è¡¨ç¤º <code>performSelector</code> æ‰€å¤„çš„çº¿ç¨‹æ˜¯å¦ç­‰ <code>selector</code> ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œå†ç»§ç»­æ‰§è¡Œä¸‹ä¸€è¡Œï¼›</li></ul><p>#ç¤ºä¾‹ï¼š</p><ul><li>è‡ªå®šä¹‰çš„å­çº¿ç¨‹å·¥å…·ç±»</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ASDFThreadHelper</span> : <span class="hljs-title">NSObject</span></span><br><br>-(<span class="hljs-built_in">NSThread</span> *)getThread;<br>- (<span class="hljs-type">void</span>)finish;<br>-(<span class="hljs-keyword">instancetype</span>)initWithName:(<span class="hljs-built_in">NSString</span>*)name;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ASDFThreadHelper</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSThread</span> *thread;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ASDFThreadHelper</span></span><br><br>-(<span class="hljs-keyword">instancetype</span>)initWithName:(<span class="hljs-built_in">NSString</span>*)name&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) &#123;<br>        _thread = [[<span class="hljs-built_in">NSThread</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(onThreadInit:) object:<span class="hljs-literal">nil</span>];<br>        _thread.name = name;<br>        [_thread start];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>-(<span class="hljs-built_in">NSThread</span> *)getThread&#123;<br>    <span class="hljs-keyword">return</span> _thread;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onThreadInit:(<span class="hljs-type">id</span>)obj&#123;<br>    <span class="hljs-comment">//å› ä¸ºæ˜¯å­çº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å¯åŠ¨å…¶runloopï¼Œä¸ç„¶å­çº¿ç¨‹å¯åŠ¨åå°±ç«‹åˆ»é€€å‡ºï¼Œperformselectoræ—¶ä¼šå´©æºƒ</span><br>    <span class="hljs-built_in">CFRunLoopRun</span>();<br>&#125;<br><br>- (<span class="hljs-type">void</span>)start&#123;<br>    [_thread start];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)finish&#123;<br>    <span class="hljs-built_in">CFRunLoopStop</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>());<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ul><li>è°ƒç”¨performSelector</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) ASDFThreadHelper *threadHelper;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++before:%ld&quot;</span>,(<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(<span class="hljs-keyword">self</span>)));<br>    _threadHelper = [[ASDFThreadHelper alloc] initWithName:<span class="hljs-string">@&quot;asdf&quot;</span>];<br>    <br>    [<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(onSelector:)<br>                 onThread:[_threadHelper getThread]<br>               withObject:<span class="hljs-literal">nil</span> waitUntilDone:<span class="hljs-literal">YES</span>];<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++after:%ld&quot;</span>,(<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(<span class="hljs-keyword">self</span>)));<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>-(<span class="hljs-type">void</span>)onSelector:(<span class="hljs-type">id</span>)obj&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++excute:%ld,thread:%@,&quot;</span>,<br>          (<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(<span class="hljs-keyword">self</span>)),[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    [_threadHelper finish];<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>è¾“å‡ºæ—¥å¿—</li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">+++<span class="hljs-keyword">before</span>:<span class="hljs-number">1</span><br>+++excute:<span class="hljs-number">2</span>,thread:&lt;NSThread: <span class="hljs-number">0x600001850c40</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>, <span class="hljs-built_in">name</span> = asdf&#125;,<br>+++<span class="hljs-keyword">after</span>:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>ä»æ—¥å¿—æ¥çœ‹ï¼š</p><ul><li>selector ä¼šåœ¨æˆ‘ä»¬æŒ‡å®šçš„å­çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼›</li><li>å¦‚æœ <code>waitUntilDone=YES</code>ï¼Œæ‰§è¡Œåˆ° [self perform..onThread..] æ—¶ï¼Œä¸»çº¿ç¨‹ä¼šç­‰å¾… selector æ‰§è¡Œå®Œä¹‹åæ‰ç»§ç»­æ‰§è¡Œä¸‹ä¸€è¡Œï¼›</li><li>ç»™ selector æŒ‡å®šçš„çº¿ç¨‹ä¸€å®šè¦æœ‰æ•ˆï¼Œä¸èƒ½æ˜¯å·²ç»é€€å‡ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å·¥å…·ç±»ä¸­å°†å­çº¿ç¨‹ä¸­çš„ runloop å¯åŠ¨èµ·æ¥ï¼›</li></ul><h3 id="3-2-å®šæ—¶æº"><a href="#3-2-å®šæ—¶æº" class="headerlink" title="3.2.å®šæ—¶æº"></a>3.2.å®šæ—¶æº</h3><p>å®šæ—¶å™¨çš„ä½œç”¨æ˜¯ï¼šåœ¨é¢„è®¾çš„æ—¶é—´ç‚¹æˆ–é‡å¤çš„æ—¶é—´é—´éš”ï¼Œè§¦å‘æŸä¸ªæ“ä½œã€‚</p><h4 id="1-CFRunLoopTimer"><a href="#1-CFRunLoopTimer" class="headerlink" title="1.CFRunLoopTimer"></a>1.CFRunLoopTimer</h4><p>è¿™æ˜¯<code>Core Foundation</code>æ¡†æ¶ä¸­çš„ä½¿ç”¨çš„å®šæ—¶å™¨ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹é¢çš„ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-type">void</span> onScheduleTimer()&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++&quot;</span>);<br>&#125;<br>- (<span class="hljs-type">void</span>)runloop_timer&#123;<br>    <span class="hljs-built_in">CFRunLoopRef</span> runLoop = <span class="hljs-built_in">CFRunLoopGetCurrent</span>();<br>    <span class="hljs-built_in">CFRunLoopTimerContext</span> context = &#123;<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>&#125;;<br><br>    <span class="hljs-built_in">CFRunLoopTimerRef</span> aTimerRef = <span class="hljs-built_in">CFRunLoopTimerCreate</span>(<br>    kCFAllocatorDefault,<br>    <span class="hljs-number">1</span>, <span class="hljs-comment">//fireDate</span><br>    <span class="hljs-number">1</span>, <span class="hljs-comment">//interval</span><br>    <span class="hljs-number">0</span>, <span class="hljs-comment">//flags</span><br>    <span class="hljs-number">0</span>,<br>    &amp;onScheduleTimer, <span class="hljs-comment">//CFRunLoopTimerCallBack å›è°ƒå‡½æ•°</span><br>    &amp;context);<br>    <span class="hljs-built_in">CFRunLoopAddTimer</span>(runLoop, aTimerRef, kCFRunLoopCommonModes);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-NSTimer"><a href="#2-NSTimer" class="headerlink" title="2.NSTimer"></a>2.NSTimer</h4><p>è¿™æ˜¯Cocoaæ¡†æ¶ä¸­ç»å¸¸ä½¿ç”¨éƒ½çš„çš„å®šæ—¶å™¨ï¼Œå…¶åˆ›å»ºæ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-built_in">NSTimer</span> *)timerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti <br>target:(<span class="hljs-type">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="hljs-type">id</span>)userInfo repeats:(<span class="hljs-type">BOOL</span>)yesOrNo;<br><br>+ (<span class="hljs-built_in">NSTimer</span> *)timerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)interval <br>repeats:(<span class="hljs-type">BOOL</span>)repeats block:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSTimer</span> *timer))block;<br><br>+ (<span class="hljs-built_in">NSTimer</span> *)timerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti <br>invocation:(<span class="hljs-built_in">NSInvocation</span> *)invocation repeats:(<span class="hljs-type">BOOL</span>)yesOrNo;<br><br>- (<span class="hljs-keyword">instancetype</span>)initWithFireDate:(<span class="hljs-built_in">NSDate</span> *)date <br>interval:(<span class="hljs-built_in">NSTimeInterval</span>)interval repeats:(<span class="hljs-type">BOOL</span>)repeats block:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSTimer</span> *timer))block;<br><br>- (<span class="hljs-keyword">instancetype</span>)initWithFireDate:(<span class="hljs-built_in">NSDate</span> *)date <br>interval:(<span class="hljs-built_in">NSTimeInterval</span>)ti target:(<span class="hljs-type">id</span>)t selector:(SEL)s userInfo:(<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)ui repeats:(<span class="hljs-type">BOOL</span>)rep;<br></code></pre></td></tr></table></figure><p>è¿™äº”ç§æ–¹å¼åˆ›å»ºçš„<code>NSTimer</code>éœ€é€šè¿‡â€[[NSRunLoop currentRunLoop] addTimer:forMode:]â€æ‰‹åŠ¨åŠ å…¥åˆ° Runloop ä¸­å¹¶æŒ‡å®šæ¨¡å¼æ‰èƒ½æ­£å¸¸å¼€å§‹ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti<br>target:(<span class="hljs-type">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="hljs-type">id</span>)userInfo repeats:(<span class="hljs-type">BOOL</span>)yesOrNo;<br><br>+ (<span class="hljs-built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)interval<br>repeats:(<span class="hljs-type">BOOL</span>)repeats <br>block:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSTimer</span> *timer))block;<br><br>+ (<span class="hljs-built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti <br>invocation:(<span class="hljs-built_in">NSInvocation</span> *)invocation <br>repeats:(<span class="hljs-type">BOOL</span>)yesOrNo;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸‰ç§æ–¹å¼ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>NSTimer</code>å¯¹è±¡å¹¶ä»¥<code>DefaultMode</code>åŠ å…¥åˆ° Runloop ä¸­ã€‚</p><p>NSTimerä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ª<code>CFRunLoopTimerRef</code>ã€‚</p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    _seriaqueue = dispatch_queue_create(<span class="hljs-string">&quot;disafsdfa&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    [<span class="hljs-keyword">self</span> nstimer];<br>&#125;<br>- (<span class="hljs-type">void</span>)nstimer&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(_seriaqueue, ^&#123;<br>        <span class="hljs-comment">//å¼€å§‹å®šæ—¶å™¨ä¹‹å‰</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop before timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        [<span class="hljs-built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="hljs-number">2</span> repeats:<span class="hljs-literal">NO</span> block:^(<span class="hljs-built_in">NSTimer</span> * _Nonnull timer) &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œå®šæ—¶ä»»åŠ¡&quot;</span>);<br>            <span class="hljs-built_in">CFRunLoopStop</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>());<br>        &#125;];<br>        <span class="hljs-comment">// å¼€å§‹å®šæ—¶å™¨ä¹‹å</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop after timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        <span class="hljs-built_in">CFRunLoopRun</span>();<br>        <span class="hljs-comment">// å®šæ—¶ä»»åŠ¡å®Œæˆ</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop exit:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—(æœ‰åˆ å‡ï¼Œä¿ç•™äº†ä¸»è¦å†…å®¹)ï¼š</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-comment">//å¼€å§‹å®šæ—¶å™¨ä¹‹å‰</span><br>+++runloop before timer:&lt;CFRunLoop <span class="hljs-number">0x600002f88500</span>&gt;&#123;<br>modes = &lt;CFBasicHash <span class="hljs-number">0x600001ddc7b0</span> [<span class="hljs-number">0x10388eb48</span>]&gt;&#123;type = mutable <span class="hljs-keyword">set</span>, count <span class="hljs-comment">= 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x600002888f70&gt;&#123;name = kCFRunLoopDefaultMode</span><br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    timers <span class="hljs-comment">= (null)</span> // æ³¨æ„è¿™é‡Œæ­¤æ—¶ä¸ºç©º<br>&#125;<br><span class="hljs-comment">// å¼€å§‹å®šæ—¶å™¨ä¹‹å</span><br>+++runloop <span class="hljs-comment">after timer:&lt;CFRunLoop 0x600002f88500&gt;&#123;</span><br>modes <span class="hljs-comment">= &lt;CFBasicHash 0x600001ddc7b0 [0x10388eb48]&gt;&#123;type = mutable set, count = 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x600002888f70&gt;&#123;name = kCFRunLoopDefaultMode,</span><br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    timers <span class="hljs-comment">= &lt;CFArray 0x600003784ae0&gt;&#123;</span> //æ­¤æ—¶æ•°ç»„ä¸­æœ‰äº†<span class="hljs-comment">CFRunLoopTimer</span>å¯¹è±¡<br>    type <span class="hljs-comment">= mutable-small,</span> <br>    count <span class="hljs-comment">= 1,</span> <br>    values <span class="hljs-comment">= (</span><br>    0 : &lt;CFRunLoopTimer <span class="hljs-comment">0x60000268f000&gt;&#123;valid = Yes, firing = No, interval = 0, tolerance = 0,</span> <br>    next <span class="hljs-comment">fire date = 594361769 (1.99719393 @ 11234440222906),</span> <br>    callout <span class="hljs-comment">= (NSTimer) [_NSTimerBlockTarget fire:]</span><br>)&#125;<br>++++æ‰§è¡Œå®šæ—¶ä»»åŠ¡<br><br><span class="hljs-comment">// å®šæ—¶ä»»åŠ¡å®Œæˆ</span><br>+++runloop <span class="hljs-comment">exit:&lt;CFRunLoop 0x600002f88500&gt;&#123;</span><br>modes <span class="hljs-comment">= &lt;CFBasicHash 0x600001ddc7b0&gt;&#123;type = mutable set, count = 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x600002888f70&gt;&#123;name = kCFRunLoopDefaultMode,</span><br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    <span class="hljs-comment">// æ­¤æ—¶ä»»åŠ¡å·²å®Œæˆï¼Œrunloopé€€å‡ºï¼Œæ•°ç»„ä¸­valuesåˆä¸ºç©ºäº†</span><br>    timers <span class="hljs-comment">= &lt;CFArray 0x600003784ae0 [0x10388eb48]&gt;&#123;type = mutable-small, count = 0, values = ()&#125;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åªçœ‹æ—¥å¿—ä¸­â€œtimers &#x3D;â€éƒ¨åˆ†ï¼Œå®šæ—¶å™¨å¼€å§‹åï¼Œå…¶æ‰€åœ¨çš„runloopä¸­å¤šå‡ºäº†ä¸€ä¸ª<code>CFRunLoopTimer</code>å¯¹è±¡ã€‚å°±æ˜¯è¯´<code>NSTimer</code>çš„åº•å±‚æ˜¯ç”±<code>CFRunLoopTimer</code>æ¥å®ç°çš„ã€‚</p><h5 id="2-1-å†…å­˜æ³„éœ²"><a href="#2-1-å†…å­˜æ³„éœ²" class="headerlink" title="2.1.å†…å­˜æ³„éœ²"></a>2.1.å†…å­˜æ³„éœ²</h5><p>åœ¨ä¸€ä¸ªç•Œé¢ä¸­å¯åŠ¨äº†<code>NSTimer</code>ï¼Œç¦»å¼€ç•Œé¢å‰å¦‚æœ<code>NSTimer</code>è¿˜æ²¡æ‰§è¡Œå®Œï¼Œé‚£ä¹ˆè¿™ä¸ªç•Œé¢å°±æ— æ³•é‡Šæ”¾ï¼Œå³ä½¿æŠŠè¿™ä¸ª<code>NSTimer</code>å¯¹è±¡ç½®ä¸ºnilã€‚è¿™æ˜¯å› ä¸º<code>NSTimer</code>å¯¹è±¡ä¼š<code>å¼ºå¼•ç”¨</code>å®ƒçš„ targetï¼ŒRunloop ä¸­è¿˜æŒæœ‰è¿™ä¸ªå¯¹è±¡ã€‚æ‰€ä»¥è®°å¾—æŠŠ<code>NSTimer</code>ç½®ä¸º<code>invalidate</code>ã€‚</p><h5 id="2-2-å®æ—¶æ€§"><a href="#2-2-å®æ—¶æ€§" class="headerlink" title="2.2.å®æ—¶æ€§"></a>2.2.å®æ—¶æ€§</h5><p>å®šæ—¶å™¨å¯ä»¥äº§ç”ŸåŸºäºæ—¶é—´çš„é€šçŸ¥ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä¸€ç§real-timeçš„æœºåˆ¶ã€‚</p><ol><li>å¦‚æœå­çº¿ç¨‹çš„ Runloop æ ¹æœ¬æ²¡æœ‰è¿è¡Œï¼Œé‚£ä¹ˆå®šæ—¶å™¨ä¹Ÿä¸ä¼šè§¦å‘ï¼›</li><li>å®šæ—¶å™¨ä¹Ÿå’Œ Runloop çš„ mode ç›¸å…³ã€‚å¦‚æœå®šæ—¶å™¨æ‰€åœ¨çš„æ¨¡å¼å½“å‰æœªè¢« Runloop ç›‘è§†ï¼Œé‚£ä¹ˆå®šæ—¶å™¨å°†ä¸ä¼šè§¦å‘ï¼›</li><li>é‡å¤ç±»å‹çš„å®šæ—¶å™¨ï¼Œæ·»åŠ åˆ° RunLoop åï¼ŒRunLoop ä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå¥½äº‹ä»¶ã€‚æ¯”å¦‚tï¼Œt + 5ï¼Œt + 10ã€‚ã€‚å¦‚æœæŸä¸ªæ—¶é—´ç‚¹è¢«é”™è¿‡äº†ï¼Œä¾‹å¦‚æ‰§è¡Œäº†ä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œåˆ™é‚£ä¸ªæ—¶é—´ç‚¹çš„å›è°ƒä¹Ÿä¼šè·³è¿‡å»ï¼Œä¸ä¼šå»¶åæ‰§è¡Œã€‚</li></ol><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;Timer-Runloop.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Timer_Runloop</span></span><br><br>- (<span class="hljs-type">void</span>)scheduleTimer<br>&#123;<br>    <span class="hljs-comment">//åˆ›å»ºtimer é—´éš”1ç§’</span><br>    [<span class="hljs-built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="hljs-number">1</span><br>                                     target:<span class="hljs-keyword">self</span><br>                                   selector:<span class="hljs-keyword">@selector</span>(onScheduleTimer)<br>                                   userInfo:<span class="hljs-literal">nil</span> repeats:<span class="hljs-literal">YES</span>];<br>    <span class="hljs-comment">//åœ¨ç¬¬3ç§’çš„æ—¶ æ¨¡æ‹Ÿä¸€ä¸ªå¤æ‚è¿ç®—</span><br>    [<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(onMassTasks) withObject:<span class="hljs-literal">nil</span> afterDelay:<span class="hljs-number">3</span>];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onScheduleTimer<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++1ç§’é‡å¤å®šæ—¶æ‰§è¡Œ++++&quot;</span>);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onMassTasks<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++å¼€å§‹å¤„ç†å¤æ‚è¿ç®—+++&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">0xffffffff</span>; i++)&#123;<br>    &#125;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++++å¤æ‚è¿ç®—å®Œæˆ++++++&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ä¹‹åè¾“å…¥æ—¥å¿—ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">10</span>.<span class="hljs-number">952360</span> ++++<span class="hljs-number">1</span>ç§’é‡å¤å®šæ—¶æ‰§è¡Œ++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">11</span>.<span class="hljs-number">952263</span> ++++<span class="hljs-number">1</span>ç§’é‡å¤å®šæ—¶æ‰§è¡Œ++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">12</span>.<span class="hljs-number">952284</span> ++++<span class="hljs-number">1</span>ç§’é‡å¤å®šæ—¶æ‰§è¡Œ++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">12</span>.<span class="hljs-number">952628</span> +++å¼€å§‹å¤„ç†å¤æ‚è¿ç®—+++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">24</span>.<span class="hljs-number">104517</span> ++++++å¤æ‚è¿ç®—å®Œæˆ++++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">24</span>.<span class="hljs-number">104825</span> ++++<span class="hljs-number">1</span>ç§’é‡å¤å®šæ—¶æ‰§è¡Œ++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">24</span>.<span class="hljs-number">952362</span> ++++<span class="hljs-number">1</span>ç§’é‡å¤å®šæ—¶æ‰§è¡Œ++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">25</span>.<span class="hljs-number">951624</span> ++++<span class="hljs-number">1</span>ç§’é‡å¤å®šæ—¶æ‰§è¡Œ++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">26</span>.<span class="hljs-number">951637</span> ++++<span class="hljs-number">1</span>ç§’é‡å¤å®šæ—¶æ‰§è¡Œ++++<br></code></pre></td></tr></table></figure><p>ä»æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼šå½“çº¿ç¨‹ç©ºé—²çš„æ—¶å€™å®šæ—¶å™¨çš„æ¶ˆæ¯è§¦å‘è¿˜æ˜¯æ¯”è¾ƒå‡†ç¡®çš„ï¼Œä½†æ˜¯åœ¨30åˆ†12ç§’å¼€å§‹çº¿ç¨‹ä¸€ç›´å¿™ç€åšå¤§é‡è¿ç®—ï¼Œç›´åˆ°30åˆ†24ç§’è¯¥è¿ç®—æ‰ç»“æŸï¼Œè¿™æ—¶å€™å®šæ—¶å™¨å›è°ƒæ‰è§¦å‘ã€‚è¿™ä¸ªçº¿ç¨‹ç¹å¿™çš„è¿‡ç¨‹è¶…è¿‡äº†ä¸€ä¸ªå‘¨æœŸï¼Œä½†æ˜¯å®šæ—¶å™¨å¹¶æ²¡æœ‰è¿ç€è§¦å‘ä¸¤æ¬¡æ¶ˆæ¯ï¼Œè€Œæ˜¯åªè§¦å‘äº†ä¸€æ¬¡ã€‚ä¹Ÿå°±æ˜¯è¯´ç¹å¿™æœŸé—´çš„å‡ æ¬¡å›è°ƒéƒ½è·³è¿‡äº†ï¼Œç¹å¿™è¿‡åç«‹åˆ»æ‰§è¡Œäº†ä¸€æ¬¡å›è°ƒï¼Œä¹‹ååˆæ­£å¸¸1ç§’æ‰§è¡Œä¸€æ¬¡å›è°ƒã€‚</p><h4 id="3-ç‰¹æ®Šçš„å®šæ—¶å™¨"><a href="#3-ç‰¹æ®Šçš„å®šæ—¶å™¨" class="headerlink" title="3.ç‰¹æ®Šçš„å®šæ—¶å™¨"></a>3.ç‰¹æ®Šçš„å®šæ—¶å™¨</h4><h5 id="1-delay"><a href="#1-delay" class="headerlink" title="1.delay"></a>1.delay</h5><p><code>NSTimer</code>æ˜¯æœ€å¸¸è§çš„å®šæ—¶å™¨ï¼Œé™¤æ­¤ä¹‹å¤–<code>NSObject</code>çš„åˆ†ç±»ä¸­è¿˜å®šä¹‰äº†ä¸€äº›ç‰¹æ®Šçš„å®šæ—¶å™¨:</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs erlang">@interface NSObject (NSDelayedPerforming)<br><br>//å»¶æ—¶<br>- <span class="hljs-params">(void)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>anArgument <br>afterDelay:<span class="hljs-params">(NSTimeInterval)</span>delay <br>inModes:<span class="hljs-params">(NSArray&lt;NSRunLoopMode&gt; *)</span>modes;<br><br>- <span class="hljs-params">(void)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>anArgument <br>afterDelay:<span class="hljs-params">(NSTimeInterval)</span>delay;<br><br>//å–æ¶ˆå»¶æ—¶<br>+ <span class="hljs-params">(void)</span>cancelPreviousPerformRequestsWithTarget:<span class="hljs-params">(id)</span>aTarget <br>selector:<span class="hljs-params">(SEL)</span>aSelector <br>object:<span class="hljs-params">(nullable id)</span>anArgument;<br><br>+ <span class="hljs-params">(void)</span>cancelPreviousPerformRequestsWithTarget:<span class="hljs-params">(id)</span>aTarget;<br><br>@end<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">-(<span class="hljs-type">void</span>)onSelector:(<span class="hljs-type">id</span>)obj&#123;<br>    <span class="hljs-comment">// å»¶æ—¶ä»»åŠ¡ç»“æŸ</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++thread:%@,++runloop:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread],[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>&#125;<br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-comment">// å»¶æ—¶ä»»åŠ¡å¼€å§‹å‰</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        [<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(onSelector:) withObject:<span class="hljs-literal">nil</span> afterDelay:<span class="hljs-number">1</span>];<br>        <span class="hljs-comment">// æ·»åŠ å»¶æ—¶ä»»åŠ¡å</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++check timers:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        <span class="hljs-built_in">CFRunLoopRun</span>();<span class="hljs-comment">//å¯åŠ¨å­çº¿ç¨‹çš„runloop</span><br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—(æœ‰åˆ å‡ï¼Œä¿ç•™äº†ä¸»è¦å†…å®¹)ï¼š</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-comment">// å»¶æ—¶ä»»åŠ¡å¼€å§‹å‰</span><br>+++runloop:&lt;CFRunLoop <span class="hljs-number">0x60000222c700</span>&gt;&#123;<br>ã€‚ã€‚ã€‚<br>modes = &lt;CFBasicHash <span class="hljs-number">0x600001062dc0</span>&gt;&#123;type = mutable <span class="hljs-keyword">set</span>, count <span class="hljs-comment">= 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x60000252d040&gt;&#123;name = kCFRunLoopDefaultMode,</span> <br>    port <span class="hljs-comment">set = 0x6107,</span> <br>    queue <span class="hljs-comment">= 0x600003026380,</span> <br>    source <span class="hljs-comment">= 0x600003026b80 (not fired), timer port = 0x9d03,</span> <br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    timers <span class="hljs-comment">= (null),</span>// æ³¨æ„è¿™ä¸€è¡Œï¼Œæ­¤æ—¶<span class="hljs-comment">timers</span>æ•°ç»„æ˜¯ç©ºçš„ï¼ï¼ï¼ï¼<br>&#125;<br><br><span class="hljs-comment">// æ·»åŠ å»¶æ—¶ä»»åŠ¡å</span><br>++++check <span class="hljs-comment">timers:&lt;CFRunLoop 0x60000222c700]&gt;&#123;</span><br>ã€‚ã€‚ã€‚<br>modes <span class="hljs-comment">= &lt;CFBasicHash 0x600001062dc0&gt;&#123;type = mutable set, count = 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x60000252d040&gt;&#123;name = kCFRunLoopDefaultMode,</span> <br>    port <span class="hljs-comment">set = 0x6107,</span> <br>    queue <span class="hljs-comment">= 0x600003026380,</span> <br>    source <span class="hljs-comment">= 0x600003026b80 (not fired), timer port = 0x9d03,</span> <br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    <span class="hljs-comment">// æ³¨æ„ï¼Œè¿™é‡Œtimersæ•°ç»„ä¸­valuesæ˜¯æœ‰å€¼çš„ï¼Œæ˜¯ä¸€ä¸ªCFRunLoopTimerå¯¹è±¡ï¼ï¼ï¼</span><br>    timers <span class="hljs-comment">= &lt;CFArray 0x600003a2f000 [0x10eb3db48]&gt;&#123;</span><br>    type <span class="hljs-comment">= mutable-small, count = 1, values = (</span><br>    0 : &lt;CFRunLoopTimer <span class="hljs-comment">0x600002b2e340]&gt;&#123;valid = Yes,</span> <br>    firing <span class="hljs-comment">= No, interval = 0, tolerance = 0, next fire date = 594358054</span> <br>)&#125;<br><br><span class="hljs-comment">// å»¶æ—¶ä»»åŠ¡ç»“æŸ</span><br>+++thread:&lt;NSThread:&gt;&#123;number <span class="hljs-comment">= 5, name = (null)&#125;,++runloop:&lt;CFRunLoop 0x60000222c700</span><br>ã€‚ã€‚ã€‚<br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x60000252d040&gt;&#123;name = kCFRunLoopDefaultMode,</span> <br>    port <span class="hljs-comment">set = 0x6107,</span> <br>    queue <span class="hljs-comment">= 0x600003026380,</span> <br>    source <span class="hljs-comment">= 0x600003026b80 (not fired), timer port = 0x9d03,</span> <br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    <span class="hljs-comment">// æ³¨æ„ï¼Œè¿™é‡Œtimersæ•°ç»„ä¸­åˆä¸ºç©ºäº†</span><br>    timers <span class="hljs-comment">= &lt;CFArray&gt;&#123;type = mutable-small, count = 0, values = ()&#125;,</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—æ˜¾ç¤ºï¼Œåœ¨è°ƒç”¨<code>perform..afterDelay</code>åï¼Œå­çº¿ç¨‹ runloop çš„ CFRunLoopMode çš„<code>timers</code>æ•°ç»„ä¸­æœ‰äº†ä¸€ä¸ª<code>CFRunLoopTimer</code>å¯¹è±¡ï¼å®ƒå°±æ˜¯ç³»ç»Ÿä¸ºå»¶æ—¶æ“ä½œåˆ›å»ºçš„ä¸€ä¸ªå®šæ—¶å™¨ï¼›å»¶æ—¶æ“ä½œå®Œæˆä¹‹åï¼Œæ­¤å®šæ—¶å™¨å¯¹è±¡åˆè‡ªåŠ¨ä»timersæ•°ç»„ä¸­ç§»é™¤ã€‚<br><br/></p><p>åŒæ—¶ï¼Œå¦‚æœåœ¨è°ƒç”¨<code>-onSelector:</code>æ—¶æ‰“æ–­ç‚¹ï¼Œå¯å¾—åˆ°å¦‚ä¸‹çš„å †æ ˆä¿¡æ¯ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_perform_afterDelay.png" alt="pic_perform_afterDelay"></p><p>ä»å †æ ˆä¸Šä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ<strong>å»¶æ—¶æ“ä½œçš„æœ¬è´¨å®ç°æ˜¯è¿è¡Œæ—¶åœ¨å½“å‰çº¿ç¨‹çš„ runloop ä¸­æ·»åŠ äº†ä¸€ä¸ªâ€œå®šæ—¶æºâ€</strong>~</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨è¿™ç§å»¶æ—¶æ‰§è¡Œæ–¹æ³•æ—¶ï¼Œå¦‚æœä¸ä¸»åŠ¨å¯åŠ¨å­çº¿ç¨‹çš„ runloopï¼Œé‚£ä¹ˆ selector æ˜¯ä¸ä¼šæ‰§è¡Œçš„</strong>ã€‚è¿™ä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„â€œå¦‚æœå­çº¿ç¨‹çš„ Runloop æ ¹æœ¬æ²¡æœ‰è¿è¡Œï¼Œé‚£ä¹ˆå®šæ—¶å™¨ä¹Ÿä¸ä¼šè§¦å‘â€ï¼Œå®é™…çš„å¼€å‘ä¸­ä¸€å®šè¦æ³¨æ„è¿™ä¸€ç‚¹ã€‚</p><p>å¦å¤–ï¼šè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½åªæ˜¯å°†<code>selector</code>çš„è°ƒç”¨å»¶è¿ŸæŸä¸ªæ—¶é—´é•¿åº¦ï¼Œå¹¶ä¸å½±å“è°ƒç”¨æ–¹æ³•æ—¶æ‰€å¤„çš„çº¿ç¨‹ï¼Œå³åœ¨Açº¿ç¨‹è°ƒç”¨è¿™ä¸¤ä¸ª<code>performSelector</code>ï¼Œå»¶è¿Ÿåçš„<code>selector</code>è¿˜æ˜¯åœ¨Açº¿ç¨‹ä¸­æ‰§è¡Œã€‚</p><h5 id="2-GCDå®šæ—¶å™¨"><a href="#2-GCDå®šæ—¶å™¨" class="headerlink" title="2.GCDå®šæ—¶å™¨"></a>2.GCDå®šæ—¶å™¨</h5><p>é¦–å…ˆè¦è¯´æ˜çš„æ˜¯ï¼ŒGCDçš„å®šæ—¶å™¨ä¸ä¸Šé¢ä¸‰ç§ä¸åŒï¼Œå®ƒ<strong>ä¸æ˜¯runloopçš„æº!</strong></p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;GCDTimerTest.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">GCDTimerTest</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">dispatch_queue_t</span> seriaqueue;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) dispatch_source_t timer;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">GCDTimerTest</span></span><br><br>- (<span class="hljs-type">void</span>)gcd_timer&#123;<br>    _seriaqueue = dispatch_queue_create(<span class="hljs-string">&quot;xx&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    __<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) wself = <span class="hljs-keyword">self</span>;<br>    <span class="hljs-built_in">dispatch_async</span>(_seriaqueue, ^&#123;<br>        __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(wself) sself = wself;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop before timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        sself.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sself.seriaqueue);<br>        dispatch_source_set_timer(sself.timer, DISPATCH_TIME_NOW, <span class="hljs-number">1</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>, <span class="hljs-number">0</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>);<br>        dispatch_source_set_event_handler(sself.timer, ^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++æ‰§è¡Œè®¡æ—¶ä»»åŠ¡&quot;</span>);<br>            <span class="hljs-comment">//dispatch_source_cancel(sself.timer);</span><br>        &#125;);<br>        dispatch_resume(sself.timer);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop after timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>    &#125;);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">+++runloop <span class="hljs-keyword">before</span> timer:&lt;CFRunLoop<br>common mode items = (<span class="hljs-keyword">null</span>),<br>modes = &lt;CFBasicHash <span class="hljs-number">0x600001b71dd0</span>&gt;&#123;<br>entries =&gt;<br>    <span class="hljs-number">2</span> : &lt;CFRunLoopMode <span class="hljs-number">0x600002e2a8a0</span>&gt;&#123;<br>    <span class="hljs-type">name</span> = kCFRunLoopDefaultMode, <br>    source = <span class="hljs-number">0x600003b25900</span> (<span class="hljs-keyword">not</span> fired), <br>    timer port = <span class="hljs-number">0x5f03</span>, <br>    sources0 = (<span class="hljs-keyword">null</span>),<br>    sources1 = (<span class="hljs-keyword">null</span>),<br>    observers = (<span class="hljs-keyword">null</span>),<br>    timers = (<span class="hljs-keyword">null</span>),<br>&#125;<br>// å¼€å§‹GCDå®šæ—¶å™¨ä¹‹å<br>+++runloop <span class="hljs-keyword">after</span> timer:&lt;CFRunLoop <span class="hljs-number">0x600002928200</span>&#123;<br>modes = &lt;CFBasicHash <span class="hljs-number">0x600001b71dd0</span><br>entries =&gt;<br>    <span class="hljs-number">2</span> : &lt;CFRunLoopMode <span class="hljs-number">0x600002e2a8a0</span>&gt;&#123;<br>    <span class="hljs-type">name</span> = kCFRunLoopDefaultMode,<br>    sources0 = (<span class="hljs-keyword">null</span>),<br>    sources1 = (<span class="hljs-keyword">null</span>),<br>    observers = (<span class="hljs-keyword">null</span>),<br>    timers = (<span class="hljs-keyword">null</span>),<br>&#125;<br>++++æ‰§è¡Œè®¡æ—¶ä»»åŠ¡<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¼€å¯GCDå®šæ—¶å™¨ä¹‹åï¼Œå½“å‰runloopçš„timersä¸­ä¹Ÿå¹¶æœªå¢åŠ æ–°çš„å®šæ—¶æº~</p><p>æ‰€ä»¥ï¼ŒGCDçš„å®šæ—¶å™¨å¹¶ä¸æ˜¯ç”±<code>NSTimer</code>æˆ–è€…<code>CFRunLoopTimer</code>å®ç°çš„ï¼Œä¹Ÿä¸éœ€è¦åŠ å…¥åˆ°runloopModeä¸­ï¼Œå³<strong>ä¸å—runloopæ¨¡å¼åŒ–åˆ‡æ¢çš„å½±å“</strong>ã€‚</p><h2 id="4-è§‚å¯Ÿè€…"><a href="#4-è§‚å¯Ÿè€…" class="headerlink" title="4.è§‚å¯Ÿè€…"></a>4.è§‚å¯Ÿè€…</h2><p>Runloopåœ¨å¤„ç†è¾“å…¥äº‹ä»¶çš„åŒæ—¶ï¼Œåœ¨å…¶è¿è¡Œçš„ç‰¹å®šé˜¶æ®µè¿˜ä¼šè§¦å‘é€šçŸ¥ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CF çš„æ–¹æ³•ï¼Œæ³¨å†Œè§‚å¯Ÿè€…æ¥æ¥æ”¶é€šçŸ¥å¹¶åœ¨æŸä¸ªç‰¹å®šæ—¶æœŸå¤„ç†ä¸€äº›äº‹æƒ…ã€‚<br><br/></p><p>Runloopå¯ä»¥è¢«è§‚å¯Ÿçš„çŠ¶æ€åŒ…æ‹¬ä»¥ä¸‹é˜¶æ®µï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* Run Loop Observer Activities */</span><br>typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;<br>kCFRunLoopEntry = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">0</span>),         <span class="hljs-regexp">//</span>runloopè¿›å…¥æ—¶ï¼›<br>kCFRunLoopBeforeTimers = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">1</span>),  <span class="hljs-regexp">//</span>å°†è¦å¤„ç†Timeræ—¶;<br>kCFRunLoopBeforeSources = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">2</span>), <span class="hljs-regexp">//</span>å°†è¦å¤„ç†Source0æ—¶ï¼›<br>kCFRunLoopBeforeWaiting = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">5</span>), <span class="hljs-regexp">//</span>å°†è¦è¿›å…¥ç¡çœ æ—¶ï¼›<br>kCFRunLoopAfterWaiting = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">6</span>),  <span class="hljs-regexp">//</span>å°†è¦è¢«å”¤é†’æ—¶ï¼›<br>kCFRunLoopExit = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">7</span>),          <span class="hljs-regexp">//</span>runloopå³å°†é€€å‡ºæ—¶ï¼›<br>kCFRunLoopAllActivities = <span class="hljs-number">0</span>x0FFFFFFFU<br>&#125;;<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)runloopReturnTest<br>&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;<br>        <br>        <span class="hljs-built_in">NSRunLoop</span> *mRunloop = [<span class="hljs-built_in">NSRunLoop</span> currentRunLoop];<br>        <br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªè§‚å¯Ÿè€….</span><br>        <span class="hljs-built_in">CFRunLoopObserverRef</span> observer = <span class="hljs-built_in">CFRunLoopObserverCreateWithHandler</span>(<br>                                             kCFAllocatorDefault,<br>                                             kCFRunLoopAllActivities,<br>                                             <span class="hljs-literal">YES</span>, <span class="hljs-number">0</span>,<br>                                             ^(<span class="hljs-built_in">CFRunLoopObserverRef</span> observer, <span class="hljs-built_in">CFRunLoopActivity</span> activity)&#123;<br>            <span class="hljs-keyword">switch</span> (activity) &#123;<br>                <span class="hljs-keyword">case</span> kCFRunLoopEntry:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observerï¼š kCFRunLoopEntry...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopBeforeTimers:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observerï¼š kCFRunLoopBeforeTimers...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopBeforeSources:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observerï¼š kCFRunLoopBeforeSources...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopBeforeWaiting:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observerï¼š kCFRunLoopBeforeWaiting...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopAfterWaiting:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observerï¼š kCFRunLoopAfterWaiting...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopExit:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observerï¼š kCFRunLoopExit...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;);<br>        <br>        <span class="hljs-keyword">if</span> (observer)&#123;<br>            <span class="hljs-comment">//æŠŠè§‚å¯Ÿè€…é™„åŠ åˆ°runloopä¸Š</span><br>            <span class="hljs-built_in">CFRunLoopRef</span> cfLoop = [mRunloop getCFRunLoop];<br>            <span class="hljs-built_in">CFRunLoopAddObserver</span>(cfLoop, observer, kCFRunLoopDefaultMode);<br>        &#125;<br>        <br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;This thread starting.......&quot;</span>);<br>        <br>        <span class="hljs-comment">//æ–°å¢è®¡æ—¶å™¨æºå¹¶åŠ å…¥runloop</span><br>        <span class="hljs-built_in">NSTimer</span> *timer = [<span class="hljs-built_in">NSTimer</span> timerWithTimeInterval:<span class="hljs-number">5</span><br>                                                 target:<span class="hljs-keyword">self</span><br>                                               selector:<span class="hljs-keyword">@selector</span>(onHandleTask:)<br>                                               userInfo:<span class="hljs-literal">nil</span><br>                                                repeats:<span class="hljs-literal">NO</span>];<br>        [mRunloop addTimer:timer forMode:<span class="hljs-built_in">NSDefaultRunLoopMode</span>];<br>        <br>        <span class="hljs-comment">//æœ€åä¸€ä¸ªå‚æ•°ï¼šæ˜¯å¦å¤„ç†å®Œäº‹ä»¶è¿”å›ï¼Œç»“æŸrunLoop</span><br>        SInt32 result = <span class="hljs-built_in">CFRunLoopRunInMode</span>(kCFRunLoopDefaultMode, <span class="hljs-number">100</span>, <span class="hljs-literal">YES</span>);<br>        <br>        <span class="hljs-keyword">switch</span> (result) &#123;<br>            <span class="hljs-keyword">case</span> kCFRunLoopRunFinished:<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kCFRunLoopRunFinished&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> kCFRunLoopRunStopped:<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kCFRunLoopRunStopped&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>                <br>            <span class="hljs-keyword">case</span> kCFRunLoopRunTimedOut:<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kCFRunLoopRunTimedOut&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>                <br>            <span class="hljs-keyword">case</span> kCFRunLoopRunHandledSource:<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kCFRunLoopRunHandledSource&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>                <br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;This thread end.......&quot;</span>);<br>    &#125;);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onHandleTask:(<span class="hljs-built_in">NSTimer</span> *)timer&#123;<br>    [timer invalidate];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;timer Fired...&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå…ˆå¾€å½“å‰å­çº¿ç¨‹çš„ runloop ä¸­æ·»åŠ äº†ä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œç›‘å¬å¹¶æ‰“å°å„ä¸ªé˜¶æ®µçš„çŠ¶æ€ï¼›éšåå¾€ runloop ä¸­æ·»åŠ äº†ä¸€ä¸ªå®šæ—¶å™¨ã€‚æ‰§è¡Œåˆ°<code>CFRunLoopRunInMode</code>æ—¶ï¼Œç¨‹åºå¡åœ¨è¿™ä¸€è¡Œã€‚5ç§’åè®¡æ—¶å™¨è§¦å‘ï¼Œè®¡æ—¶å™¨<code>invalidate</code>åï¼ŒRunloop ä¸­æ²¡æœ‰äº†ä»»ä½•äº‹ä»¶æºï¼Œæ‰€ä»¥é€€å‡ºå¹¶è¿”å›äº†resultå€¼ï¼Œç¨‹åºç»§ç»­å‘ä¸‹è¿è¡Œï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">831</span>  This thread starting.......<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">831</span>  observerï¼š kCFRunLoopEntry...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">832</span>  observerï¼š kCFRunLoopBeforeTimers...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">832</span>  observerï¼š kCFRunLoopBeforeSources...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">833</span>  observerï¼š kCFRunLoopBeforeWaiting...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">834</span>  observerï¼š kCFRunLoopAfterWaiting...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">835</span>  timer Fired...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">835</span>  observerï¼š kCFRunLoopExit...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">836</span>  kCFRunLoopRunFinished<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">836</span>  This thread end.......<br></code></pre></td></tr></table></figure><h2 id="5-äº‹ä»¶åºåˆ—"><a href="#5-äº‹ä»¶åºåˆ—" class="headerlink" title="5.äº‹ä»¶åºåˆ—"></a>5.äº‹ä»¶åºåˆ—</h2><p>1ã€é€šçŸ¥è§‚å¯Ÿè€… Runloop å·²ç»å¯åŠ¨;</p><p>2ã€é€šçŸ¥è§‚å¯Ÿè€… <code>Timers</code> å³å°†è§¦å‘;</p><p>3ã€é€šçŸ¥è§‚å¯Ÿè€… å°†è¦å¤„ç† <code>Source0</code>;</p><p>4ã€è§¦å‘ <code>Source0</code> å›è°ƒ;</p><p>5ã€å¦‚æœæœ‰ <code>Source1</code> å¤„äº <code>ready</code> çŠ¶æ€ï¼Œç›´æ¥è¿›å…¥æ­¥éª¤9å¤„ç†è¯¥ <code>Source1</code>äº‹ä»¶;</p><p>6ã€é€šçŸ¥è§‚å¯Ÿè€… çº¿ç¨‹å³å°†ä¼‘çœ ;</p><p>7ã€çº¿ç¨‹ä¼‘çœ  ç­‰å¾…ä»¥ä¸‹æƒ…å½¢çš„å”¤é†’ï¼š</p><ul><li>æŸä¸€äº‹ä»¶åˆ°è¾¾åŸºäºç«¯å£çš„æº(Source1);</li><li>å®šæ—¶å™¨æ—¶é—´åˆ°äº†;</li><li>Runloop è®¾ç½®çš„æ—¶é—´å·²ç»è¶…æ—¶;</li><li>Runloop è¢«æ‰‹åŠ¨å”¤é†’;</li></ul><p>8ã€é€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹å°†è¢«å”¤é†’;</p><p>9ã€å¤„ç†å”¤é†’æ—¶æ”¶åˆ°çš„æ¶ˆæ¯ï¼š</p><ul><li>å¦‚æœæ¶ˆæ¯æ˜¯<code>Timer</code>ç±»å‹ï¼Œåˆ™è§¦å‘è¯¥<code>Timer</code>çš„å›è°ƒï¼›</li><li>å¦‚æœæ¶ˆæ¯æ˜¯ dispatch åˆ° <code>main_ queue</code> çš„blockï¼Œæ‰§è¡Œblockï¼›</li><li>å¦‚æœæ¶ˆæ¯æ˜¯<code>Source1</code>ç±»å‹ï¼Œåˆ™å¤„ç†<code>Source1</code>å›è°ƒï¼›</li></ul><p>10ã€ä»¥ä¸‹æ¡ä»¶ä¸­æ»¡è¶³æ—¶å€™é€€å‡ºå¾ªç¯ï¼Œå¦åˆ™ä»ï¼ˆ2ï¼‰ç»§ç»­å¾ªç¯ï¼š</p><ul><li>äº‹ä»¶å¤„ç†å®Œæ¯•ï¼Œä¸”å¯åŠ¨ RunLoop æ—¶å‚æ•°è®¾ç½®ä¸ºä¸€æ¬¡æ€§æ‰§è¡Œï¼›</li><li>å¯åŠ¨ RunLoop æ—¶è®¾ç½®çš„æœ€å¤§è¿è¡Œæ—¶é—´åˆ°æœŸï¼›</li><li>RunLoop è¢«å¤–éƒ¨è°ƒç”¨å¼ºè¡Œåœæ­¢ï¼›</li><li>å¯åŠ¨ RunLoop çš„ mode itemsä¸ºç©ºï¼›</li></ul><p>11ã€é€šçŸ¥è§‚å¯Ÿè€… Runloop ç»“æŸã€‚</p><br/><p>ä¸Šé¢é€»è¾‘å¯¹åº”çš„ <a href="https://opensource.apple.com/source/CF/CF-855.17/CFRunLoop.c.auto.html">CFRunLoop.cæºç </a> å¦‚ä¸‹ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">/// ç”¨DefaultModeå¯åŠ¨</span><br>void CFRunLoopRun(void) &#123;<br>CFRunLoopRunSpecific(CFRunLoopGetCurrent(), <br>kCFRunLoopDefaultMode, <span class="hljs-number">1.0</span>e10, <span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-comment">/// ç”¨æŒ‡å®šçš„Modeå¯åŠ¨ï¼Œå…è®¸è®¾ç½®RunLoopè¶…æ—¶æ—¶é—´</span><br>int CFRunLoopRunInMode(CFStringRef modeName, <br>CFTimeInterval seconds, Boolean stopAfterHandle) &#123;<br><br>return CFRunLoopRunSpecific(CFRunLoopGetCurrent(), <br>modeName, seconds, returnAfterSourceHandled);<br>&#125;<br><br><span class="hljs-comment">/// RunLoopçš„å®ç°</span><br>int CFRunLoopRunSpecific(runloop, modeName,<br>seconds, stopAfterHandle) &#123;<br><br><span class="hljs-comment">/// é¦–å…ˆæ ¹æ®modeNameæ‰¾åˆ°å¯¹åº”mode</span><br>CFRunLoopModeRef currentMode = <span class="hljs-variable">__CFRunLoopFindMode</span>(runloop, modeName, <span class="hljs-literal">false</span>);<br><span class="hljs-comment">/// å¦‚æœmodeé‡Œæ²¡æœ‰source/timer/observer, ç›´æ¥è¿”å›ã€‚</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">__CFRunLoopModeIsEmpty</span>(currentMode)) return;<br><br><span class="hljs-comment">/// 1. é€šçŸ¥ Observers: RunLoop å³å°†è¿›å…¥ loopã€‚</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopEntry);<br><br><span class="hljs-comment">/// å†…éƒ¨å‡½æ•°ï¼Œè¿›å…¥loop</span><br><span class="hljs-variable">__CFRunLoopRun</span>(runloop, currentMode, seconds, returnAfterSourceHandled) &#123;<br><br>Boolean sourceHandledThisLoop = NO;<br>int retVal = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">do</span> &#123;<br><br><span class="hljs-comment">/// 2. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Timer å›è°ƒã€‚</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopBeforeTimers);<br><span class="hljs-comment">/// 3. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Source0 (éport) å›è°ƒã€‚</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopBeforeSources);<br><span class="hljs-comment">/// å¤„ç†éå»¶è¿Ÿçš„ä¸»çº¿ç¨‹è°ƒç”¨</span><br><span class="hljs-variable">__CFRunLoopDoBlocks</span>(runloop, currentMode);<br><br><span class="hljs-comment">/// 4. RunLoop è§¦å‘ Source0 (éport) å›è°ƒã€‚</span><br>sourceHandledThisLoop = <span class="hljs-variable">__CFRunLoopDoSources0</span>(runloop, currentMode, stopAfterHandle);<br><span class="hljs-comment">/// æ‰§è¡Œè¢«åŠ å…¥çš„block</span><br><span class="hljs-variable">__CFRunLoopDoBlocks</span>(runloop, currentMode);<br><br><span class="hljs-comment">/// 5. å¦‚æœæœ‰ Source1 (åŸºäºport) å¤„äº ready çŠ¶æ€ï¼Œç›´æ¥å¤„ç†è¿™ä¸ª Source1 ç„¶åè·³è½¬å»å¤„ç†æ¶ˆæ¯ã€‚</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">__Source0DidDispatchPortLastTime</span>) &#123;<br>Boolean hasMsg = <span class="hljs-variable">__CFRunLoopServiceMachPort</span>(dispatchPort, &amp;msg)<br><span class="hljs-keyword">if</span> (hasMsg) <span class="hljs-built_in">goto</span> handle_msg;<br>&#125;<br><br><span class="hljs-comment">/// é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ (sleep)ã€‚</span><br><span class="hljs-keyword">if</span> (!sourceHandledThisLoop) &#123;<br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopBeforeWaiting);<br>&#125;<br><br><span class="hljs-comment">/// 7. è°ƒç”¨ mach_msg ç­‰å¾…æ¥å— mach_port çš„æ¶ˆæ¯ã€‚çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ , ç›´åˆ°è¢«ä¸‹é¢æŸä¸€ä¸ªäº‹ä»¶å”¤é†’ã€‚</span><br><span class="hljs-comment">/// â€¢ ä¸€ä¸ªåŸºäº port çš„Source çš„äº‹ä»¶ã€‚</span><br><span class="hljs-comment">/// â€¢ ä¸€ä¸ª Timer åˆ°æ—¶é—´äº†</span><br><span class="hljs-comment">/// â€¢ RunLoop è‡ªèº«çš„è¶…æ—¶æ—¶é—´åˆ°äº†</span><br><span class="hljs-comment">/// â€¢ è¢«å…¶ä»–ä»€ä¹ˆè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’</span><br><span class="hljs-variable">__CFRunLoopServiceMachPort</span>(waitSet, &amp;msg, <span class="hljs-built_in">sizeof</span>(msg_buffer), &amp;livePort) &#123;<br>mach_msg(msg, MACH_RCV_MSG, port); <span class="hljs-comment">// thread wait for receive msg</span><br>&#125;<br><br><span class="hljs-comment">/// 8. é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹åˆšåˆšè¢«å”¤é†’äº†ã€‚</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopAfterWaiting);<br><br><span class="hljs-comment">/// æ”¶åˆ°æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ã€‚</span><br>handle_msg:<br><br><span class="hljs-comment">/// 9.1 å¦‚æœä¸€ä¸ª Timer åˆ°æ—¶é—´äº†ï¼Œè§¦å‘è¿™ä¸ªTimerçš„å›è°ƒã€‚</span><br><span class="hljs-keyword">if</span> (msg_is_timer) &#123;<br><span class="hljs-variable">__CFRunLoopDoTimers</span>(runloop, currentMode, mach_absolute_time())<br>&#125;<br><br><span class="hljs-comment">/// 9.2 å¦‚æœæœ‰dispatchåˆ°main_queueçš„blockï¼Œæ‰§è¡Œblockã€‚</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg_is_dispatch) &#123;<br><span class="hljs-variable">__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</span>(msg);<br>&#125;<br><br><span class="hljs-comment">/// 9.3 å¦‚æœä¸€ä¸ª Source1 (åŸºäºport) å‘å‡ºäº‹ä»¶äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶</span><br><span class="hljs-keyword">else</span> &#123;<br>CFRunLoopSourceRef source1 = <span class="hljs-variable">__CFRunLoopModeFindSourceForMachPort</span>(runloop,<br>currentMode, livePort);<br><br>sourceHandledThisLoop = <span class="hljs-variable">__CFRunLoopDoSource1</span>(runloop, <br>currentMode, source1, msg);<br><br><span class="hljs-keyword">if</span> (sourceHandledThisLoop) &#123;<br>mach_msg(reply, MACH_SEND_MSG, reply);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/// æ‰§è¡ŒåŠ å…¥åˆ°Loopçš„block</span><br><span class="hljs-variable">__CFRunLoopDoBlocks</span>(runloop, currentMode);<br><br><br><span class="hljs-keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;<br><span class="hljs-comment">/// è¿›å…¥loopæ—¶å‚æ•°è¯´å¤„ç†å®Œäº‹ä»¶å°±è¿”å›ã€‚</span><br>retVal = kCFRunLoopRunHandledSource;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (timeout) &#123;<br><span class="hljs-comment">/// è¶…å‡ºä¼ å…¥å‚æ•°æ ‡è®°çš„è¶…æ—¶æ—¶é—´äº†</span><br>retVal = kCFRunLoopRunTimedOut;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">__CFRunLoopIsStopped</span>(runloop)) &#123;<br><span class="hljs-comment">/// è¢«å¤–éƒ¨è°ƒç”¨è€…å¼ºåˆ¶åœæ­¢äº†</span><br>retVal = kCFRunLoopRunStopped;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">__CFRunLoopModeIsEmpty</span>(runloop, currentMode)) &#123;<br><span class="hljs-comment">/// source/timer/observerä¸€ä¸ªéƒ½æ²¡æœ‰äº†</span><br>retVal = kCFRunLoopRunFinished;<br>&#125;<br><br><span class="hljs-comment">/// å¦‚æœæ²¡è¶…æ—¶ï¼Œmodeé‡Œæ²¡ç©ºï¼Œloopä¹Ÿæ²¡è¢«åœæ­¢ï¼Œé‚£ç»§ç»­loopã€‚</span><br>&#125; <span class="hljs-keyword">while</span> (retVal == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/// 10. é€šçŸ¥ Observers: RunLoop å³å°†é€€å‡ºã€‚</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(rl, currentMode, kCFRunLoopExit);<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Š RunLoop å°±æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ª<code>do-while</code> å¾ªç¯ã€‚å½“ä½ è°ƒç”¨ <code>CFRunLoopRun()</code> æ—¶ï¼Œçº¿ç¨‹å°±ä¼šä¸€ç›´åœç•™åœ¨è¿™ä¸ªå¾ªç¯é‡Œï¼›ç›´åˆ°è¶…æ—¶æˆ–è¢«æ‰‹åŠ¨åœæ­¢ï¼Œè¯¥å‡½æ•°æ‰ä¼šè¿”å›ã€‚RunLoop çš„æ ¸å¿ƒæ˜¯ <code>mach_msg()</code> å‡½æ•°(è§ä¸Šé¢ä»£ç çš„ç¬¬7æ­¥)ï¼ŒRunLoop è°ƒç”¨è¿™ä¸ªå‡½æ•°å»æ¥æ”¶æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ«äººå‘é€ port æ¶ˆæ¯è¿‡æ¥ï¼Œå†…æ ¸ä¼šå°†çº¿ç¨‹ç½®äºç­‰å¾…çŠ¶æ€ã€‚</p><h2 id="6-ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ"><a href="#6-ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ" class="headerlink" title="6.ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ"></a>6.ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ</h2><ol><li>å¼€å¯å¸¸é©»çº¿ç¨‹æ—¶ï¼Œéœ€è¦åœ¨å½“å‰çº¿ç¨‹ä¸­å¯åŠ¨ runloopï¼Œå¦‚AFNï¼›</li><li>åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨æ—¶ï¼Œéœ€è¦åœ¨å­çº¿ç¨‹ä¸­å¯åŠ¨ runloopï¼Œå®šæ—¶å™¨æ‰èƒ½æ­£å¸¸å¯åŠ¨ï¼›</li><li>è®¾ç½®å®šæ—¶å™¨ï¼Œåœ¨å½“å‰ runloop çš„ç‰¹å®šæ¨¡å¼ä¸‹æ‰§è¡Œï¼›</li><li>è®©æŸäº›è¡Œä¸ºåœ¨å½“å‰ runloop çš„ç‰¹å®šæ¨¡å¼ä¸‹æ‰æ‰§è¡Œï¼Œå¦‚æ»‘åŠ¨æ—¶çš„å®šæ—¶å™¨ã€defaultæ¨¡å¼ä¸‹è®¾ç½®å›¾ç‰‡ã€åŠ è½½ç¼“å­˜ç­‰ã€‚</li><li>æ·»åŠ è§‚å¯Ÿè€…ï¼Œåœ¨ runloop çš„ç‰¹å®šæ—¶åˆ»å¤„ç†æŸäº›äº‹æƒ…ï¼›</li><li>ä½¿ç”¨ç«¯å£æˆ–è‡ªå®šä¹‰è¾“å…¥æºæ¥å’Œå…¶ä»–çº¿ç¨‹é€šä¿¡ï¼›</li></ol><h2 id="7-Runloopå¯¹è±¡"><a href="#7-Runloopå¯¹è±¡" class="headerlink" title="7.Runloopå¯¹è±¡"></a>7.Runloopå¯¹è±¡</h2><p>Runloop å¯¹è±¡æä¾›äº†æ·»åŠ è¾“å…¥æºã€å®šæ—¶å™¨ã€è§‚å¯Ÿè€…ä»¥åŠå¯åŠ¨ Runloop çš„æ¥å£ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ä¸ä¹‹å…³è”çš„ Runloopå¯¹è±¡ã€‚Cocoaå’Œ CF éƒ½æœ‰ç›¸åº”çš„æ¥å£å¯ä»¥æ“ä½œ RunLoopï¼š</p><ul><li>Cocoaä¸­å¯¹åº”çš„æ˜¯ NSRunLoopï¼›</li><li>CF ä¸­å¯¹åº”çš„æ˜¯ CFRunLoopRefï¼›</li></ul><h3 id="7-1-è·å–-RunLoopå¯¹è±¡"><a href="#7-1-è·å–-RunLoopå¯¹è±¡" class="headerlink" title="7.1.è·å– RunLoopå¯¹è±¡"></a>7.1.è·å– RunLoopå¯¹è±¡</h3><ul><li>CFRunLoopRef <a href="https://developer.apple.com/documentation/corefoundation/cfrunloop-rht">ï¼ˆå®˜æ–¹æ–‡æ¡£ï¼‰</a></li></ul><p>è¿™æ˜¯ CF æ¡†æ¶æä¾›çš„ï¼Œå®ƒæä¾›äº†çº¯Cå‡½æ•°çš„APIï¼Œè¿™äº›APIéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">CFRunLoopRef aCFRunloopObjRef <span class="hljs-operator">=</span> CFRunLoopGetCurrent()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><ul><li>NSRunLoop<a href="https://developer.apple.com/documentation/foundation/nsrunloop">ï¼ˆå®˜æ–¹æ–‡æ¡£ï¼‰</a></li></ul><p>è¿™æ˜¯Cocoaæ¡†æ¶æä¾›çš„ï¼Œå®ƒæä¾›äº†é¢å‘å¯¹è±¡çš„ APIï¼Œæ˜¯åŸºäºCFRunLoopRefçš„ä¸€å±‚å°è£…ï¼Œä½†è¿™äº›APIæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼›è‹¹æœå®˜æ–¹æ–‡æ¡£è¯´ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­å»callå¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­ NSRunLoop å¯¹è±¡çš„æ–¹æ³•ï¼Œé‚£æ ·å¾ˆå¯èƒ½ä¼šé€ æˆæ„æƒ³ä¸åˆ°çš„åæœã€‚</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">NSRunLoop *aRunloopObj <span class="hljs-operator">=</span> [NSRunLoop currentRunLoop]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>ä¸è¿‡ï¼Œä¸¤ç§ç±»å‹çš„ Runloop å¯ä»¥æ··åˆä½¿ç”¨ã€‚é‰´äº CFRunLoopRef æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥é€šè¿‡ NSRunLoop ç±»çš„å®ä¾‹æ–¹æ³•è·å–å¯¹åº”çš„ CFRunLoopRef å¯¹è±¡ï¼Œè¿›è€Œè¾¾åˆ°çº¿ç¨‹å®‰å…¨çš„ç›®çš„ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">NSRunLoop *aRunloopObj <span class="hljs-operator">=</span> [NSRunLoop currentRunLoop]<span class="hljs-comment">;</span><br>CFRunLoopRef aCFRunloopObjRef <span class="hljs-operator">=</span> [aRunloopObj getCFRunLoop]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h3 id="7-2-å¯åŠ¨RunLoop"><a href="#7-2-å¯åŠ¨RunLoop" class="headerlink" title="7.2.å¯åŠ¨RunLoop"></a>7.2.å¯åŠ¨RunLoop</h3><h4 id="1-NSRunLoopçš„å¯åŠ¨"><a href="#1-NSRunLoopçš„å¯åŠ¨" class="headerlink" title="1.NSRunLoopçš„å¯åŠ¨"></a>1.NSRunLoopçš„å¯åŠ¨</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">- (<span class="hljs-type">void</span>)run; <span class="hljs-comment">//æ— æ¡ä»¶çš„å¯åŠ¨</span><br></code></pre></td></tr></table></figure><p>ä¸å»ºè®®ä½¿ç”¨ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£ä¼šå¯¼è‡´Run Loopæ°¸ä¹…æ€§çš„åœ¨NSDefaultRunLoopModeæ¨¡å¼ã€‚å³ä½¿ç”¨CFRunLoopStop()å‡½æ•°ä¹Ÿæ— æ³•åœæ­¢Run Loopçš„è¿è¡Œï¼Œé™¤éèƒ½ç§»é™¤è¿™ä¸ªrunloopä¸Šçš„æ‰€æœ‰äº‹ä»¶æºï¼Œä¸ç„¶è¿™ä¸ªå­çº¿ç¨‹å°±æ— æ³•åœæ­¢ï¼Œåªèƒ½æ°¸ä¹…è¿è¡Œä¸‹å»ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)runUntilDate:(<span class="hljs-built_in">NSDate</span> *)limitDate;<span class="hljs-comment">//è®¾ç½®è¶…æ—¶æ—¶é—´</span><br></code></pre></td></tr></table></figure><p>æ¯”ä¸Šé¢çš„æ¥å£å¥½ç‚¹ï¼Œæœ‰ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå¯ä»¥æ§åˆ¶æ¯æ¬¡ Runloop çš„è¿è¡Œæ—¶é—´ï¼Œä¹Ÿæ˜¯è¿è¡Œåœ¨<code>NSDefaultRunLoopMode</code>æ¨¡å¼ã€‚è¿™ä¸ªæ–¹æ³•è¿è¡Œ Runloop ä¸€æ®µæ—¶é—´ä¼šé€€å‡ºç»™ä½ æ£€æŸ¥è¿è¡Œæ¡ä»¶çš„æœºä¼šï¼Œå¦‚æœéœ€è¦å¯ä»¥å†æ¬¡è¿è¡Œ Runloopã€‚<br><br/></p><p>æ³¨æ„ï¼šä½¿ç”¨è¿™ç§æ–¹å¼å¯åŠ¨runloopæ—¶ï¼ŒCFRunLoopStop()å‡½æ•°ä¹Ÿæ— æ³•åœæ­¢è¿™ä¸ªrunloopã€‚<br><br/></p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua">BOOL finished = NO;<br>    <br><span class="hljs-keyword">while</span>(!finished) &#123;<br>    <span class="hljs-string">[[NSRunLoop currentRunLoop] runUntilDate:</span><br><span class="hljs-string">     [NSDate dateWithTimeIntervalSinceNow: 1]]</span>;<br>    <br>    NSLog(@<span class="hljs-string">&quot;exit runloop ......&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªfinishedæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ªBoolå€¼ï¼Œç”¨æ¥æ§åˆ¶æ˜¯å¦è¿˜éœ€è¦å¼€å¯ä¸‹ä¸€æ¬¡ Runloopã€‚<br><br/></p><p>ä¸Šé¢ä¾‹å­æ‰€åšçš„äº‹ï¼šwhileå¾ªç¯å†…éƒ¨æœ‰ä¸ª RunLoop æ¯ç§’å¾ªç¯ä¸€æ¬¡ï¼ŒRunloop ç»“æŸåä¼šè¾“å‡º<code>exit Runloop â€¦â€¦</code>ã€‚whileå¾ªç¯ä¼šæ ¹æ® finished å€¼æ¥åˆ¤æ–­æ˜¯å¦å†å»è¿è¡Œ Runloopã€‚<br><br/></p><p>è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">20.980211</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">21.981915</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">22.983668</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">23.984748</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">24.986541</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">25.988267</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)runMode:(<span class="hljs-built_in">NSRunLoopMode</span>)mode beforeDate:(<span class="hljs-built_in">NSDate</span> *)limitDate;<span class="hljs-comment">//ç‰¹å®šçš„æ¨¡å¼</span><br></code></pre></td></tr></table></figure><p>æ¯”ä¸Šé¢çš„æ–¹æ³•å¤šäº†modeå‚æ•°ï¼Œä¸åŒçš„æ˜¯ï¼Œè¿™ç§è¿è¡Œæ–¹å¼æ˜¯å¯ä»¥è¢«<code>CFRunLoopStop()</code>å‡½æ•°åœæ­¢çš„ã€‚</p><h4 id="2-CFRunLoopRefçš„å¯åŠ¨"><a href="#2-CFRunLoopRefçš„å¯åŠ¨" class="headerlink" title="2.CFRunLoopRefçš„å¯åŠ¨"></a>2.CFRunLoopRefçš„å¯åŠ¨</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CFRunLoopRun</span>()</span>;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ç§æ–¹å¼å¯åŠ¨åï¼ŒRunloop ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°æ˜¾ç¤ºåœ°è°ƒç”¨<code>CFRunLoopStop()</code>æ‰ä¼šåœæ­¢ã€‚å¦å¤–ï¼Œåˆ é™¤ RunLoop çš„æ‰€æœ‰äº‹ä»¶æºåï¼Œä¹Ÿèƒ½åœæ­¢è¿™ä¸ª Runloopã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">SInt32 <span class="hljs-constructor">CFRunLoopRunInMode(<span class="hljs-params">mode</span>, <span class="hljs-params">second</span>, <span class="hljs-params">returnAfterSourceHandled</span>)</span>;<br></code></pre></td></tr></table></figure><ul><li>å‚æ•°modeï¼šæ¨¡å¼ï¼›</li><li>å‚æ•°secondï¼šrunloopçš„å¾ªç¯æ—¶é—´ï¼›</li><li>å‚æ•°returnAfterSourceHandledï¼šæ˜¯å¦åœ¨å¤„ç†äº‹ä»¶åè®©Run Loopé€€å‡ºè¿”å›ï¼›</li></ul><p>è¿™ç§æ–¹å¼å¯åŠ¨çš„ Runloop ä¹Ÿå¯ä»¥ä½¿ç”¨<code>CFRunLoopStop()</code>æ¥ä¸»åŠ¨åœæ­¢ã€‚NSRunloop ä¸­çš„ç¬¬ä¸‰ç§å¯åŠ¨æ–¹å¼ï¼Œå®è´¨ä¸Šå°±æ˜¯åŸºäºè¿™ç§æ–¹å¼çš„å°è£…ï¼Œåªä¸è¿‡æŒ‡å®šäº†æœ€åä¸€ä¸ª<code>returnAfterSourceHandled</code>å‚æ•°ä¸ºYESã€‚</p><ul><li>Runloopçš„è¿”å›å€¼</li></ul><p>å¯åŠ¨ Runloop åï¼Œä»£ç åœåœ¨è¿™ä¸€è¡Œä¸è¿”å›ã€‚å½“æœ‰å€¼è¿”å›æ—¶Runloopå°±ç»“æŸäº†ã€‚è¿™ä¸ªè¿”å›å€¼å°±æ˜¯Runloopç»“æŸåŸå› ï¼Œæšä¸¾å¦‚ä¸‹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* Reasons for CFRunLoopRunInMode() to Return */</span><br>typedef CF_ENUM(SInt32, CFRunLoopRunResult) &#123;<br>    kCFRunLoopRunFinished = <span class="hljs-number">1</span>,  <span class="hljs-regexp">//</span>Runloopç»“æŸï¼Œæ‰€æœ‰çš„Sourceséƒ½å·²è¢«ç§»é™¤ï¼Œæ— äº‹ä»¶æºå¯ç›‘å¬ï¼›<br>    kCFRunLoopRunStopped = <span class="hljs-number">2</span>,   <span class="hljs-regexp">//</span>Runloopè¢«ä½¿ç”¨CFRunLoopStopå‡½æ•°åœæ­¢ï¼›<br>    kCFRunLoopRunTimedOut = <span class="hljs-number">3</span>,  <span class="hljs-regexp">//</span>è¶…æ—¶ï¼›<br>    kCFRunLoopRunHandledSource = <span class="hljs-number">4</span> <span class="hljs-regexp">//</span>Runloopå·²å¤„ç†å®Œäº‹ä»¶ï¼›<br>&#125;;<br></code></pre></td></tr></table></figure><p>å›å¤´çœ‹çœ‹NSRunloopçš„ç¬¬ä¸‰ç§å¯åŠ¨æ–¹å¼ï¼š</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(Bool)</span>runMode:<span class="hljs-params">(NSString *)</span>mode beforeDate:<span class="hljs-params">(NSDate *)</span>limitDate;<br></code></pre></td></tr></table></figure><p>è¿”å›å€¼ä¸ºä¸€ä¸ªBoolå€¼ï¼Œå¦‚æœæ˜¯â€performSelectorâ€ äº‹ä»¶æˆ–è€…å…¶ä»– Input Source äº‹ä»¶è§¦å‘å¹¶å¤„ç†å®Œæˆåï¼ŒRunloopä¼šé€€å‡ºå¹¶è¿”å›YESï¼Œå…¶ä»–æƒ…å†µä¸‹è¿”å›NOã€‚</p><h3 id="7-3-é€€å‡ºRunLoop"><a href="#7-3-é€€å‡ºRunLoop" class="headerlink" title="7.3.é€€å‡ºRunLoop"></a>7.3.é€€å‡ºRunLoop</h3><p>ä¸Šé¢ä¹Ÿæœ‰æåˆ°ï¼Œæœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥è®© Runloop å¤„ç†äº‹ä»¶ä¹‹å‰é€€å‡º:</p><ul><li>æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼š</li></ul><p>è¿™å¯ä»¥ä½¿ Runloop é€€å‡ºå‰å®Œæˆæ‰€æœ‰æ­£å¸¸æ“ä½œï¼ŒåŒ…æ‹¬å‘é€æ¶ˆæ¯ç»™ Runloop è§‚å¯Ÿè€…ï¼Œå¦‚æœå¯ä»¥é…ç½®çš„è¯ï¼Œæ¨èä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚</p><ul><li>ä½¿ç”¨CFRunLoopStopï¼š</li></ul><p>è¿™å¯ä»¥æ˜¾å¼çš„åœæ­¢ Runloopï¼ŒRunloop ä¼šæŠŠæ‰€æœ‰å‰©ä½™çš„é€šçŸ¥å‘é€å‡ºå»å†é€€å‡ºã€‚</p><ul><li>ç§»é™¤ Runloop çš„è¾“å…¥æºå’Œå®šæ—¶å™¨ï¼š</li></ul><p>å°½ç®¡è¿™ç§æ–¹å¼ä¹Ÿå¯èƒ½å¯¼è‡´ Runloop é€€å‡ºï¼Œä½†è¿™å¹¶ä¸æ˜¯å¯é çš„é€€å‡º Runloop çš„æ–¹æ³•ã€‚ä¸€äº›ç³»ç»Ÿä¾‹ç¨‹ä¼šæ·»åŠ è¾“å…¥æºåˆ° Runloop é‡Œé¢æ¥å¤„ç†æ‰€éœ€äº‹ä»¶ã€‚å› ä¸ºä½ çš„ä»£ç æœªå¿…ä¼šè€ƒè™‘åˆ°è¿™äº›è¾“å…¥æºï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´ä½ æ— æ³•ç§»é™¤å®ƒä»¬ï¼Œä»è€Œå¯¼è‡´é€€å‡º Runloop å¤±è´¥ã€‚</p><h2 id="8-åº”ç”¨åœºæ™¯"><a href="#8-åº”ç”¨åœºæ™¯" class="headerlink" title="8.åº”ç”¨åœºæ™¯"></a>8.åº”ç”¨åœºæ™¯</h2><h3 id="8-1-å¡é¡¿æ£€æµ‹"><a href="#8-1-å¡é¡¿æ£€æµ‹" class="headerlink" title="8.1.å¡é¡¿æ£€æµ‹"></a>8.1.å¡é¡¿æ£€æµ‹</h3><p>å¡é¡¿åŸç†ï¼š</p><ol><li>ä¸»çº¿ç¨‹runloopå¤„äºbeforeSourceæˆ–afterWaitingçŠ¶æ€æ—¶è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼›</li><li>è®¾ç½®ä¸€ä¸ªå¡é¡¿æ—¶é•¿é˜ˆå€¼<code>T</code>ï¼Œéš”æ—¶é•¿<code>T</code>æ£€æŸ¥ä¸€æ¬¡å½“å‰runloopçš„çŠ¶æ€(mode)ï¼›</li><li>è‹¥å¤šä¸ªæ£€æŸ¥å‘¨æœŸä¸­ï¼Œä¸€ç›´å¤„äºä»¥ä¸Šä¸¤ç§çŠ¶æ€ï¼Œè€Œæ²¡æœ‰ä¼‘çœ ï¼Œåˆ™è¯´æ˜çº¿ç¨‹å¤„äºå¡é¡¿çŠ¶æ€ï¼›</li><li>è·å–å¡é¡¿æ—¶å †æ ˆçš„æƒ…å†µï¼Œè®°å½•å¹¶ä¸ŠæŠ¥ï¼›</li></ol><p>å®ç°æ–¹æ¡ˆï¼š</p><ol><li>ç›‘å¬å¹¶è®°å½•ä¸»çº¿ç¨‹runloopçš„mode(çŠ¶æ€)ï¼›</li><li>å¼€å¯ä¸€ä¸ªå¸¸é©»çº¿ç¨‹ï¼Œå¤„ç†æ£€æµ‹ã€ä¸ŠæŠ¥ä»»åŠ¡ï¼›</li><li>å¯åŠ¨å®šæ—¶å™¨ï¼Œé˜ˆå€¼Tæ—¶é—´åˆ°åæ¯”å¯¹runloopçš„çŠ¶æ€ï¼›</li><li>å½“é˜ˆå€¼Tæ—¶é—´å†…è¿ç»­æ£€æµ‹åˆ°çŠ¶æ€ä¸ºbeforeSourceæˆ–afterWaitingï¼Œå³ä¸ºå¡é¡¿ï¼Œä¸ŠæŠ¥å †æ ˆï¼›</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RunLoopMonitor</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() &#123;&#125;<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared: <span class="hljs-type">RunLoopMonitor</span> <span class="hljs-operator">=</span> <span class="hljs-type">RunLoopMonitor</span>.<span class="hljs-keyword">init</span>()<br>    <span class="hljs-keyword">var</span> loopObserver: <span class="hljs-type">CFRunLoopObserver</span>?<br>    <span class="hljs-keyword">var</span> loopActivity: <span class="hljs-type">CFRunLoopActivity</span>?<br>    <span class="hljs-keyword">var</span> aSemaphore: <span class="hljs-type">DispatchSemaphore</span>?<br>    <span class="hljs-keyword">var</span> stuckTimes <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-comment">//å‡ºç°å¡é¡¿çš„æ¬¡æ•°</span><br>    <br>    <span class="hljs-comment">/*åŸç†ï¼š</span><br><span class="hljs-comment">     çº¿ç¨‹runloopå¤„äºbeforeSourceæˆ–afterWaitingçŠ¶æ€æ—¶è¡¨ç¤ºæ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼›</span><br><span class="hljs-comment">     å¤šä¸ªæ£€æŸ¥å‘¨æœŸä¸­ï¼Œrunloopä¸€ç›´å¤„äºbeforeSourceæˆ–afterWaitingçŠ¶æ€ï¼Œ</span><br><span class="hljs-comment">     è€Œæ²¡æœ‰ä¼‘çœ ï¼Œåˆ™è¯´æ˜runloopå¤„äºå¡é¡¿çŠ¶æ€ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">startMonitor</span>() &#123;<br>        <span class="hljs-keyword">let</span> uptr <span class="hljs-operator">=</span> <span class="hljs-type">Unmanaged</span>.passRetained(<span class="hljs-keyword">self</span>).toOpaque()<br>        <span class="hljs-keyword">let</span> vptr <span class="hljs-operator">=</span> <span class="hljs-type">UnsafeMutableRawPointer</span>(uptr)<br>        <span class="hljs-keyword">var</span> context <span class="hljs-operator">=</span> <span class="hljs-type">CFRunLoopObserverContext</span>.<span class="hljs-keyword">init</span>(version: <span class="hljs-number">0</span>,<br>                                                    info: vptr,<br>                                                    retain: <span class="hljs-literal">nil</span>,<br>                                                    release: <span class="hljs-literal">nil</span>,<br>                                                    copyDescription: <span class="hljs-literal">nil</span>)<br>        <span class="hljs-comment">//åˆ›å»ºã€æ·»åŠ è§‚å¯Ÿè€…</span><br>        loopObserver <span class="hljs-operator">=</span> <span class="hljs-type">CFRunLoopObserverCreate</span>(kCFAllocatorDefault,<br>                                                  <span class="hljs-type">CFRunLoopActivity</span>.allActivities.rawValue,<br>                                                  <span class="hljs-literal">true</span>,<br>                                                  <span class="hljs-number">0</span>,<br>                                                  observerCallBack(),<br>                                                  <span class="hljs-operator">&amp;</span>context)<br>        <span class="hljs-type">CFRunLoopAddObserver</span>(<span class="hljs-type">CFRunLoopGetMain</span>(), loopObserver, .commonModes)<br>        <br>        aSemaphore <span class="hljs-operator">=</span> <span class="hljs-type">DispatchSemaphore</span>.<span class="hljs-keyword">init</span>(value: <span class="hljs-number">0</span>)<br>        <br>        <span class="hljs-type">DispatchQueue</span>.global().async &#123;<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> &#123;<br>                <span class="hljs-comment">// æ–¹æ¡ˆä¸€ï¼šé€šè¿‡å•æ¬¡è¶…æ—¶æ—¶é—´åˆ¤æ–­ï¼Œå¦‚è¶…è¿‡250æ¯«ç§’å³ä¸ºå¡é¡¿ï¼›</span><br>                <span class="hljs-comment">// æ–¹æ¡ˆäºŒï¼šè¿ç»­å¤šæ¬¡çŸ­æœŸæ£€æµ‹ä¸­å‡è¶…æ—¶å³ä¸ºå¡é¡¿ï¼›</span><br>                <span class="hljs-keyword">let</span> st <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.aSemaphore<span class="hljs-operator">?</span>.wait(timeout: <span class="hljs-type">DispatchTime</span>.now() <span class="hljs-operator">+</span> .milliseconds(<span class="hljs-number">80</span>)) <span class="hljs-comment">//æˆ´é“­åœ¨GCDFetchFeedä¸­è®¤ä¸ºè¿ç»­ä¸‰æ¬¡è¶…æ—¶80ç§’å°±æ˜¯å¡é¡¿</span><br>                <span class="hljs-comment">//80æ¯«ç§’è¶…æ—¶å</span><br>                <span class="hljs-keyword">if</span> st <span class="hljs-operator">==</span> .timedOut &#123;<br>                    <span class="hljs-comment">//æŒ‡é’ˆæ£€æµ‹</span><br>                    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">self</span>.loopObserver <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">self</span>.aSemaphore <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>                        <span class="hljs-keyword">self</span>.loopActivity <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>                        <span class="hljs-keyword">self</span>.stuckTimes <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>                        <span class="hljs-keyword">return</span><br>                    &#125;<br>                    <span class="hljs-comment">//å¦‚æœloopå¤„åœ¨â€œå·¥ä½œâ€çŠ¶æ€ï¼Œå°±æ— æ³•ä¼‘çœ ï¼Œè®°å½•+1</span><br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.loopActivity <span class="hljs-operator">==</span> .afterWaiting <span class="hljs-operator">||</span><br>                       <span class="hljs-keyword">self</span>.loopActivity <span class="hljs-operator">==</span> .beforeSources<br>                    &#123;<br>                        <span class="hljs-comment">//è®°å½•ä¸€æ¬¡å¡é¡¿</span><br>                        <span class="hljs-keyword">self</span>.stuckTimes <span class="hljs-operator">+=</span> <span class="hljs-number">1</span><br>                        <span class="hljs-comment">//æœªè¶…è¿‡3æ¬¡ï¼Œè¡¨ç¤ºæ­£å¸¸</span><br>                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.stuckTimes <span class="hljs-operator">&lt;</span> <span class="hljs-number">3</span> &#123; <span class="hljs-keyword">continue</span> &#125;<br>                        <span class="hljs-comment">//è¶…è¿‡ä¸‰æ¬¡ï¼Œå³ä¸ºå‡ºç°å¡é¡¿</span><br>                        <span class="hljs-type">DispatchQueue</span>.global().async &#123;<br>                            <span class="hljs-comment">//è·å–å½“å‰å¡é¡¿æ—¶çš„å †æ ˆ ä¸ŠæŠ¥</span><br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//è§‚å¯Ÿè€…å›è°ƒ</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">observerCallBack</span>() -&gt; <span class="hljs-type">CFRunLoopObserverCallBack</span> &#123;<br>        <span class="hljs-keyword">return</span> &#123; (observer, activity, context) <span class="hljs-keyword">in</span><br>            <span class="hljs-keyword">let</span> weakself <span class="hljs-operator">=</span> <span class="hljs-type">Unmanaged</span>&lt;<span class="hljs-type">RunLoopMonitor</span>&gt;.fromOpaque(context<span class="hljs-operator">!</span>).takeUnretainedValue()<br>            <span class="hljs-comment">//è®°å½•runloopçš„çŠ¶æ€</span><br>            weakself.loopActivity <span class="hljs-operator">=</span> activity<br>            weakself.aSemaphore<span class="hljs-operator">?</span>.signal()<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//ç»“æŸç›‘æµ‹</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">end</span>() &#123;<br>        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> loopObserver <span class="hljs-keyword">else</span> &#123; <span class="hljs-keyword">return</span> &#125;<br>        <span class="hljs-type">CFRunLoopRemoveObserver</span>(<span class="hljs-type">CFRunLoopGetMain</span>(), loopObserver, .commonModes)<br>        loopObserver <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="8-2-å…¶ä»–åº”ç”¨åœºæ™¯"><a href="#8-2-å…¶ä»–åº”ç”¨åœºæ™¯" class="headerlink" title="8.2.å…¶ä»–åº”ç”¨åœºæ™¯"></a>8.2.å…¶ä»–åº”ç”¨åœºæ™¯</h3><ul><li>AutoreleasePool</li><li>äº‹ä»¶å“åº”</li><li>æ‰‹åŠ¿è¯†åˆ«</li><li>ç•Œé¢æ›´æ–°</li><li>å®šæ—¶å™¨</li><li>GCD</li><li>ç½‘ç»œè¯·æ±‚</li></ul><p><a href="https://blog.ibireme.com/2015/05/18/runloop/">ibireme</a>çš„è¿™ç¯‡åšå®¢é‡Œè®²è§£çš„å¾ˆè¯¦ç»†ï¼Œè†œæ‹œä¸€å“ˆ~</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html">Â©å®˜æ–¹æ–‡æ¡£</a></p><p>#<a href="https://blog.ibireme.com/2015/05/18/runloop/">Â©ibireme</a></p><p>#<a href="http://blog.csdn.net/u011619283/article/details/53666009">Â©å¾®ä¿¡å¡é¡¿æ£€æµ‹</a></p><p>#<a href="http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/">Â©ç™¾åº¦å­™æº-ä¼˜åŒ–UITableViewCellé«˜åº¦è®¡ç®—çš„é‚£äº›äº‹</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runloop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Runtimeï¼šåŠ¨æ€å¢åŠ æ–°ç±»ã€æ–¹æ³•ã€å±æ€§</title>
    <link href="/2017/09/01/runtime_addClass.html"/>
    <url>/2017/09/01/runtime_addClass.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-API"><a href="#1-API" class="headerlink" title="1.API"></a>1.API</h3><blockquote><p>To create a new class, start by calling objc_allocateClassPair. Then set the classâ€™s attributes with functions like class_addMethod and class_addIvar. When you are done building the class, call objc_registerClassPair. The new class is now ready for use.<br>Instance methods and instance variables should be added to the class itself. Class methods should be added to the metaclass.</p></blockquote><h4 id="1-1-å¢åŠ ç±»"><a href="#1-1-å¢åŠ ç±»" class="headerlink" title="1.1.å¢åŠ ç±»"></a>1.1.å¢åŠ ç±»</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Class objc<span class="hljs-constructor">_allocateClassPair(Class <span class="hljs-params">superclass</span>, <span class="hljs-params">const</span> <span class="hljs-params">char</span> <span class="hljs-operator">*</span><span class="hljs-params">name</span>, <span class="hljs-params">size_t</span> <span class="hljs-params">extraBytes</span>)</span>;<br>void objc<span class="hljs-constructor">_registerClassPair(Class <span class="hljs-params">cls</span>)</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ–¹æ³•åº”è¯¥é…å¯¹ä½¿ç”¨ï¼Œåœ¨äºŒè€…ä¹‹é—´å¢åŠ æˆå‘˜å˜é‡ã€å±æ€§ã€å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•ç­‰ã€‚è°ƒç”¨ç¬¬äºŒä¸ªæ–¹æ³•å³æ³¨å†Œç±»ï¼Œè¿™ä¹‹åç±»çš„ç»“æ„ä¹Ÿå°±å›ºå®šä¸‹æ¥ï¼Œä¸èƒ½å†å‘ç±»ä¸­å¢åŠ æ–°çš„æˆå‘˜å˜é‡ï¼Œä½†æ˜¯å¯ä»¥å¢åŠ å±æ€§å’Œæ–¹æ³•ã€‚å…¶ä¸­åç»­å¢åŠ çš„å±æ€§ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆ<code>_å±æ€§å</code>æˆå‘˜å˜é‡ï¼Œä¹Ÿä¸ä¼šæä¾›å±æ€§çš„setterä¸getterå‡½æ•°åŠå…¶å®ç°ã€‚</p><h4 id="1-2-å¢åŠ æ–¹æ³•"><a href="#1-2-å¢åŠ æ–¹æ³•" class="headerlink" title="1.2.å¢åŠ æ–¹æ³•"></a>1.2.å¢åŠ æ–¹æ³•</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">BOOL <span class="hljs-keyword">class</span><span class="hljs-constructor">_addMethod(Class <span class="hljs-params">cls</span>, SEL <span class="hljs-params">name</span>, IMP <span class="hljs-params">imp</span>, <span class="hljs-params">const</span> <span class="hljs-params">char</span> <span class="hljs-operator">*</span><span class="hljs-params">types</span>)</span>;<br></code></pre></td></tr></table></figure><ul><li>å®ä¾‹æ–¹æ³•åº”è¯¥åŠ åˆ°å½“å‰å®ä¾‹çš„isaæŒ‡å‘çš„ç±»ä¸­ï¼›</li><li>ç±»æ–¹æ³•åˆ™åº”è¯¥åŠ åˆ°å½“å‰ç±»çš„å…ƒç±»ä¸­ï¼›</li></ul><h4 id="1-3-å¢åŠ æˆå‘˜å˜é‡"><a href="#1-3-å¢åŠ æˆå‘˜å˜é‡" class="headerlink" title="1.3.å¢åŠ æˆå‘˜å˜é‡"></a>1.3.å¢åŠ æˆå‘˜å˜é‡</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">BOOL <span class="hljs-keyword">class</span><span class="hljs-constructor">_addIvar(Class <span class="hljs-params">cls</span>, <span class="hljs-params">const</span> <span class="hljs-params">char</span> <span class="hljs-operator">*</span><span class="hljs-params">name</span>, <span class="hljs-params">size_t</span> <span class="hljs-params">size</span>, <span class="hljs-params">uint8_t</span> <span class="hljs-params">alignment</span>, <span class="hljs-params">const</span> <span class="hljs-params">char</span> <span class="hljs-operator">*</span><span class="hljs-params">types</span>)</span>;<br></code></pre></td></tr></table></figure><blockquote><p>This function may only be called after objc_allocateClassPair and before objc_registerClassPair. Adding an instance variable to an existing class is not supported.<br>The class must not be a metaclass. Adding an instance variable to a metaclass is not supported.</p></blockquote><p>æ–°å¢æˆå‘˜å˜é‡åº”è¯¥åœ¨ç±»æ³¨å†Œå®Œæˆä¹‹å‰è¿›è¡Œï¼Œç±»æ³¨å†Œå®Œæˆä¹‹åç±»ç»“æ„å·²å›ºå®šï¼Œå®ä¾‹çš„å†…å­˜ç©ºé—´å·²ç»ç¡®å®šï¼Œä¸èƒ½å†å¢åŠ æ–°çš„æˆå‘˜å˜é‡ã€‚<br><br/></p><p>æ–°å¢åŠ çš„æˆå‘˜å˜é‡åº”è¯¥åŠ åˆ°å®ä¾‹å¯¹è±¡æ‰€å±çš„ç±»ä¸­ï¼Œè€Œä¸èƒ½åŠ åˆ°å…¶æ‰€å±ç±»çš„å…ƒç±»ä¸­ã€‚</p><h4 id="1-4-å¢åŠ å±æ€§"><a href="#1-4-å¢åŠ å±æ€§" class="headerlink" title="1.4.å¢åŠ å±æ€§"></a>1.4.å¢åŠ å±æ€§</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">BOOL <span class="hljs-keyword">class</span><span class="hljs-constructor">_addProperty(Class <span class="hljs-params">cls</span>, <span class="hljs-params">const</span> <span class="hljs-params">char</span> <span class="hljs-operator">*</span><span class="hljs-params">name</span>, <span class="hljs-params">const</span> <span class="hljs-params">objc_property_attribute_t</span> <span class="hljs-operator">*</span><span class="hljs-params">attributes</span>, <span class="hljs-params">unsigned</span> <span class="hljs-params">int</span> <span class="hljs-params">attributeCount</span>)</span>;<br></code></pre></td></tr></table></figure><h3 id="2-ç¤ºä¾‹"><a href="#2-ç¤ºä¾‹" class="headerlink" title="2.ç¤ºä¾‹"></a>2.ç¤ºä¾‹</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">#import <span class="hljs-string">&quot;AppDelegate.h&quot;</span><br>#import &lt;objc/message.h&gt;<br>#import &lt;objc/runtime.h&gt;<br><br>@implementation AppDelegate<br><br>void learn<span class="hljs-constructor">OnTV(<span class="hljs-params">id</span> <span class="hljs-params">self</span>,SEL <span class="hljs-params">_cmd</span>)</span><br>&#123;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++æ‰§è¡ŒlearnOnTVæ–¹æ³•&quot;</span>)</span>;<br>&#125;<br><br>void lear<span class="hljs-constructor">OnBook(<span class="hljs-params">id</span> <span class="hljs-params">self</span>,SEL <span class="hljs-params">_cmd</span>)</span><br>&#123;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++æ‰§è¡ŒlearOnBookæ–¹æ³•&quot;</span>)</span>;<br>&#125;<br><br>- (BOOL)application:(UIApplication *)application<br>didFinishLaunchingWithOptions:(NSDictionary *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//åˆ›å»ºæ–°çš„ç±»</span><br>    Class ASDClass = objc<span class="hljs-constructor">_allocateClassPair([NSObject <span class="hljs-params">class</span>], <span class="hljs-string">&quot;ASDClass&quot;</span>, 0)</span>;<br>    <br>    <span class="hljs-comment">//å¢åŠ æˆå‘˜å˜é‡</span><br>    const <span class="hljs-built_in">char</span> *height = <span class="hljs-string">&quot;height&quot;</span>;<br>    BOOL status1 = <span class="hljs-keyword">class</span><span class="hljs-constructor">_addIvar(ASDClass, <span class="hljs-params">height</span>, <span class="hljs-params">sizeof</span>(<span class="hljs-params">id</span>)</span>, rint(log2(sizeof(id))), @encode(id));<br>    <span class="hljs-keyword">if</span> (status1) &#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++++æˆåŠŸæ·»åŠ æˆå‘˜å˜é‡&#x27;height&#x27;~&quot;</span>)</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++++æ·»åŠ æˆå‘˜å˜é‡&#x27;height&#x27;å¤±è´¥~&quot;</span>)</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">//ä¸ºç±»å¢åŠ å±æ€§</span><br>    objc_property_attribute_t <span class="hljs-keyword">type</span>  = &#123;<span class="hljs-string">&quot;T&quot;</span>,<span class="hljs-string">&quot;@\&quot;NSString\&quot;&quot;</span>&#125;;<br>    objc_property_attribute_t ownership1 = &#123;<span class="hljs-string">&quot;C&quot;</span>,<span class="hljs-string">&quot;&quot;</span>&#125;;      <span class="hljs-comment">// C = copy</span><br>    objc_property_attribute_t ownership2 = &#123; <span class="hljs-string">&quot;N&quot;</span>, <span class="hljs-string">&quot;&quot;</span> &#125;;   <span class="hljs-comment">// N = nonatomic</span><br>    objc_property_attribute_t backIvars  = &#123;<span class="hljs-string">&quot;V&quot;</span>,<span class="hljs-string">&quot;_name&quot;</span>&#125;; <span class="hljs-comment">//å±æ€§å</span><br>    objc_property_attribute_t atts<span class="hljs-literal">[]</span> = &#123;<span class="hljs-keyword">type</span>,ownership1,ownership2,backIvars&#125;;<br>    BOOL status2 = <span class="hljs-keyword">class</span><span class="hljs-constructor">_addProperty(ASDClass, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-params">atts</span>, 4)</span>;<br>    <span class="hljs-keyword">if</span> (status2) &#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++++æˆåŠŸæ·»åŠ å±æ€§&#x27;name&#x27;~&quot;</span>)</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++++æ·»åŠ å±æ€§&#x27;name&#x27;å¤±è´¥~&quot;</span>)</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">//ä¸ºç±»å¢åŠ æ–¹æ³•</span><br>    <span class="hljs-keyword">class</span><span class="hljs-constructor">_addMethod(ASDClass, @<span class="hljs-params">selector</span>(<span class="hljs-params">learn</span>)</span>, (IMP)learnOnTV, <span class="hljs-string">&quot;v@:&quot;</span>);<br>    <span class="hljs-comment">//&quot;v@:&quot;å­—ç¬¦ï¼Œä¾æ¬¡è¡¨ç¤ºå‡½æ•°è¿”å›å€¼ç±»å‹å’Œæ¯ä¸ªå‚æ•°çš„ç±»å‹ï¼Œè¿™é‡Œvè¡¨ç¤ºè¿”å›å€¼voidï¼Œ@è¡¨ç¤ºè°ƒç”¨è€…ï¼Œï¼šè¡¨ç¤ºSEL</span><br>    <br>    <span class="hljs-comment">//æ³¨å†Œç±»</span><br>    objc<span class="hljs-constructor">_registerClassPair(ASDClass)</span>;<br>    <br>    <span class="hljs-comment">//å¢åŠ æˆå‘˜å˜é‡(ï¼ï¼ä¼šå¤±è´¥ï¼Œå› ä¸ºç±»ç»“æ„å·²å›ºå®šï¼Œå®ä¾‹å¤§å°å·²ç¡®å®š)</span><br>    const <span class="hljs-built_in">char</span> *width = <span class="hljs-string">&quot;width&quot;</span>;<br>    BOOL status3 = <span class="hljs-keyword">class</span><span class="hljs-constructor">_addIvar(ASDClass, <span class="hljs-params">width</span>, <span class="hljs-params">sizeof</span>(<span class="hljs-params">id</span>)</span>, rint(log2(sizeof(id))), @encode(id));<br>    <span class="hljs-keyword">if</span> (status3) &#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++++æˆåŠŸæ·»åŠ æˆå‘˜å˜é‡&#x27;width&#x27;~&quot;</span>)</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++++æ·»åŠ æˆå‘˜å˜é‡&#x27;width&#x27;å¤±è´¥~&quot;</span>)</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">//ä¸ºç±»å¢åŠ å±æ€§(ä¼šæˆåŠŸ)</span><br>    objc_property_attribute_t type2  = &#123;<span class="hljs-string">&quot;T&quot;</span>,<span class="hljs-string">&quot;@\&quot;NSString\&quot;&quot;</span>&#125;;<br>    objc_property_attribute_t ownership3 = &#123;<span class="hljs-string">&quot;C&quot;</span>,<span class="hljs-string">&quot;&quot;</span>&#125;;      <span class="hljs-comment">// C = copy</span><br>    objc_property_attribute_t ownership4 = &#123; <span class="hljs-string">&quot;N&quot;</span>, <span class="hljs-string">&quot;&quot;</span> &#125;;   <span class="hljs-comment">// N = nonatomic</span><br>    objc_property_attribute_t backIvars2  = &#123;<span class="hljs-string">&quot;V&quot;</span>,<span class="hljs-string">&quot;_name&quot;</span>&#125;; <span class="hljs-comment">//å±æ€§å</span><br>    objc_property_attribute_t atts2<span class="hljs-literal">[]</span> = &#123;type2,ownership3,ownership4,backIvars2&#125;;<br>    BOOL status4 = <span class="hljs-keyword">class</span><span class="hljs-constructor">_addProperty(ASDClass, <span class="hljs-string">&quot;nick&quot;</span>, <span class="hljs-params">atts2</span>, 4)</span>;<br>    <span class="hljs-keyword">if</span> (status4) &#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++++æˆåŠŸæ·»åŠ å±æ€§&#x27;nick&#x27;~&quot;</span>)</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;+++++æ·»åŠ å±æ€§&#x27;nick&#x27;å¤±è´¥~&quot;</span>)</span>;<br>    &#125;<br>    NSArray *ivarsArr = <span class="hljs-literal">[R<span class="hljs-identifier">untimeTool</span> <span class="hljs-identifier">ivarListWithClass</span>:ASDC<span class="hljs-identifier">lass</span>]</span>;<br>    NSArray *propsArr  = <span class="hljs-literal">[R<span class="hljs-identifier">untimeTool</span> <span class="hljs-identifier">propertyListWithClass</span>:ASDC<span class="hljs-identifier">lass</span>]</span>;<br>    NSArray *methodArr = <span class="hljs-literal">[R<span class="hljs-identifier">untimeTool</span> <span class="hljs-identifier">methodListWithClass</span>:ASDC<span class="hljs-identifier">lass</span>]</span>;<br>    <br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++æ‰€æœ‰æˆå‘˜å˜é‡:%@&quot;</span>,<span class="hljs-params">ivarsArr</span>)</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++æ‰€æœ‰å±æ€§:%@&quot;</span>,<span class="hljs-params">propsArr</span>)</span>;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++æ‰€æœ‰æ–¹æ³•:%@&quot;</span>,<span class="hljs-params">methodArr</span>)</span>;<br>    <br>    <span class="hljs-comment">//è°ƒç”¨learnæ–¹æ³•</span><br>    objc<span class="hljs-constructor">_msgSend([ASDClass <span class="hljs-params">new</span>],@<span class="hljs-params">selector</span>(<span class="hljs-params">learn</span>)</span>);<br>    <br>    <span class="hljs-comment">//æ›¿æ¢learnæ–¹æ³•çš„å®ç°å‡½æ•°ä¸ºlearOnBook</span><br>    <span class="hljs-keyword">class</span><span class="hljs-constructor">_replaceMethod(ASDClass, @<span class="hljs-params">selector</span>(<span class="hljs-params">learn</span>)</span>, (IMP)learOnBook, <span class="hljs-string">&quot;v@:&quot;</span>);<br>    <br>    <span class="hljs-comment">//å†æ¬¡è°ƒç”¨learnæ–¹æ³•</span><br>    objc<span class="hljs-constructor">_msgSend([ASDClass <span class="hljs-params">new</span>],@<span class="hljs-params">selector</span>(<span class="hljs-params">learn</span>)</span>);<br>    <br>    return YES;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>RuntimeTool</code>æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å–æˆå‘˜å˜é‡ã€å±æ€§å’Œæ–¹æ³•åˆ—è¡¨ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;RuntimeTool.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt; //åŒ…å«å¯¹ç±»ã€æˆå‘˜å˜é‡ã€å±æ€§ã€æ–¹æ³•çš„æ“ä½œ</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/message.h&gt; //åŒ…å«æ¶ˆæ¯æœºåˆ¶</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RuntimeTool</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">è·å–ç±»ä¸­æ‰€æœ‰æˆå‘˜å˜é‡çš„åç§°ä¸ç±»å‹</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">@param aClass ç›®æ ‡ç±»å</span><br><span class="hljs-comment">@return è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œ&#123;é”®ï¼šå˜é‡åï¼Œå€¼ï¼šç±»å‹&#125;</span><br><span class="hljs-comment">*/</span><br>+ (<span class="hljs-built_in">NSArray</span> *)ivarListWithClass:(Class)aClass<br>&#123;<br>    <span class="hljs-keyword">if</span> (!object_isClass(aClass))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">NSMutableArray</span> *resultArr = [<span class="hljs-built_in">NSMutableArray</span> array];<br><br>    Ivar *ivars = class_copyIvarList([aClass <span class="hljs-keyword">class</span>], &amp;count);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt;count; i++)&#123;<br>        Ivar ivar = ivars[i];<br>        <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charName = ivar_getName(ivar);<br>        <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charType = ivar_getTypeEncoding(ivar);<br><br>        <span class="hljs-built_in">NSString</span> *name = [<span class="hljs-built_in">NSString</span> stringWithCString:charName encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br><br>        <span class="hljs-built_in">NSString</span> *type = [<span class="hljs-built_in">NSString</span> stringWithCString:charType encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br><br>        <span class="hljs-built_in">NSDictionary</span> *dic = @&#123;<span class="hljs-string">@&quot;ivar_name&quot;</span>:name,<span class="hljs-string">@&quot;objc_type&quot;</span>:type&#125;;<br><br>        [resultArr addObject:dic];<br>    &#125;<br><br>    free(ivars);<br><br>    <span class="hljs-keyword">return</span> resultArr;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">è·å–ç±»ä¸­æ‰€æœ‰å±æ€§çš„åç§°ä¸ç±»å‹</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">@param aClass ç›®æ ‡ç±»å</span><br><span class="hljs-comment">@return è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œ&#123;é”®ï¼šå±æ€§åï¼Œå€¼ï¼šç±»å‹&#125;</span><br><span class="hljs-comment">*/</span><br>+ (<span class="hljs-built_in">NSArray</span> *)propertyListWithClass:(Class)aClass<br>&#123;<br>    <span class="hljs-keyword">if</span> (!object_isClass(aClass))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">NSMutableArray</span> *resultArr = [<span class="hljs-built_in">NSMutableArray</span> array];<br><br>    objc_property_t *properties = class_copyPropertyList([aClass <span class="hljs-keyword">class</span>], &amp;count);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt;count; i++)&#123;<br>        objc_property_t aProperty = properties[i];<br>        <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charName = property_getName(aProperty);<br>        <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charType = property_getAttributes(aProperty);<br><br>        <span class="hljs-built_in">NSString</span> *name = [<span class="hljs-built_in">NSString</span> stringWithCString:charName encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br><br>        <span class="hljs-built_in">NSString</span> *type = [<span class="hljs-built_in">NSString</span> stringWithCString:charType encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br><br>        <span class="hljs-built_in">NSDictionary</span> *dic = @&#123;<span class="hljs-string">@&quot;property_name&quot;</span>:name,<span class="hljs-string">@&quot;objc_type&quot;</span>:type&#125;;<br><br>        [resultArr addObject:dic];<br>    &#125;<br><br>    free(properties);<br><br>    <span class="hljs-keyword">return</span> resultArr;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">è·å–ç±»ä¸­æ‰€æœ‰æ–¹æ³•å</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">@param aClass ç›®æ ‡ç±»</span><br><span class="hljs-comment">@return è¿”å›æ‰€æœ‰æ–¹æ³•åç»„æˆçš„ä¸€ä¸ªæ•°ç»„</span><br><span class="hljs-comment">*/</span><br>+ (<span class="hljs-built_in">NSArray</span> *)methodListWithClass:(Class)aClass<br>&#123;<br>    <span class="hljs-keyword">if</span> (!object_isClass(aClass))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-built_in">NSMutableArray</span> *methodArr = [<span class="hljs-built_in">NSMutableArray</span> array];<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    Method *methods = class_copyMethodList(aClass, &amp;count);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>        SEL sel_name = method_getName(methods[i]);<br>        <span class="hljs-built_in">NSString</span> *name = [<span class="hljs-built_in">NSString</span> stringWithCString:sel_getName(sel_name) encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br><br>        [methodArr addObject:name];<br>    &#125;<br>    free(methods);<br><br>    <span class="hljs-keyword">return</span> methodArr;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼šç›´æ¥è°ƒç”¨<code>objc_msgSend</code>åœ¨ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ï¼Œéœ€è¦åœ¨ â€œBuild Settingâ€ä¸­ï¼ŒæŠŠâ€œ Enable Strict Checking of objc_msgSend Callsâ€ å…³æ‰ã€‚<br><br/></p><p>ç¤ºä¾‹è¿è¡Œåè¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">+++++æˆåŠŸæ·»åŠ æˆå‘˜å˜é‡<span class="hljs-string">&#x27;height&#x27;</span>~<br>+++++æˆåŠŸæ·»åŠ å±æ€§<span class="hljs-string">&#x27;name&#x27;</span>~<br>+++++æ·»åŠ æˆå‘˜å˜é‡<span class="hljs-string">&#x27;width&#x27;</span>å¤±è´¥~<br>+++++æˆåŠŸæ·»åŠ å±æ€§<span class="hljs-string">&#x27;nick&#x27;</span>~<br>++++æ‰€æœ‰æˆå‘˜å˜é‡:(<br>        &#123;<br>        &quot;ivar_name&quot; = height;<br>        &quot;objc_type&quot; = &quot;@&quot;;<br>    &#125;<br>)<br>++++æ‰€æœ‰å±æ€§:(<br>        &#123;<br>        &quot;objc_type&quot; = &quot;T@\&quot;NSString\&quot;,C,N,V_name&quot;;<br>        &quot;property_name&quot; = nick;<br>    &#125;,<br>        &#123;<br>        &quot;objc_type&quot; = &quot;T@\&quot;NSString\&quot;,C,N,V_name&quot;;<br>        &quot;property_name&quot; = <span class="hljs-type">name</span>;<br>    &#125;<br>)<br>++++æ‰€æœ‰æ–¹æ³•:(<br>    learn<br>)<br>++++æ‰§è¡ŒlearnOnTVæ–¹æ³•<br>++++æ‰§è¡ŒlearOnBookæ–¹æ³•<br></code></pre></td></tr></table></figure><p>ä»æ—¥å¿—ä¸­ä¹Ÿå¯ä»¥å¾—å‡ºç»“è®ºï¼š<br><br/></p><p>1ã€åœ¨ç±»<code>allocate</code>ä¸<code>register</code>ä¹‹é—´å¯ä»¥æ·»åŠ <code>æˆå‘˜å˜é‡</code>ã€<code>å±æ€§</code>å’Œ<code>æ–¹æ³•</code>ï¼›<br><br/></p><p>2ã€åœ¨<code>register</code>ä¹‹åï¼Œå³ç±»ç»“æ„å›ºå®šä¹‹å<code>ä¸èƒ½</code>å†æ·»åŠ <code>æˆå‘˜å˜é‡</code>ï¼Œä½†å¯ä»¥ç»§ç»­æ·»åŠ <code>å±æ€§</code>å’Œ<code>æ–¹æ³•</code>ï¼›<br><br/></p><p>3ã€åŠ¨æ€æ·»åŠ çš„å±æ€§ï¼Œå¹¶ä¸ä¼šåˆ›å»ºå…¶å¯¹åº”çš„ä»¥<code>_</code>å¼€å¤´çš„æˆå‘˜å˜é‡ï¼Œå®é™…ä¸Šè¿™ä¸€æ­¥éœ€è¦ç”±ç¼–è¯‘å™¨æ¥å®Œæˆã€‚<br><br/></p><p>ps: çƒ­æ›´æ–°<code>JSPatch</code>å°±æ˜¯åœ¨OCçš„ runtime åŸºç¡€ä¸Šå®ç°çš„ï¼Œå¤§è‡´åŸç†æ˜¯ï¼šJSä¼ é€’å­—ç¬¦ä¸²ç»™OCï¼ŒOCé€šè¿‡ Runtime çš„è¿è¡Œæ—¶å‡½æ•°ï¼Œè°ƒç”¨å’Œæ›¿æ¢ç›¸åº”çš„OCæ–¹æ³•ã€‚å¾…åæœŸæ…¢æ…¢ç ”ç©¶ã€‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runtime</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Runtimeï¼šé»‘é­”æ³•ï¼šæ–¹æ³•äº¤æ¢ã€æ•°ç»„å¯¹å¯¹è±¡æ£€æµ‹</title>
    <link href="/2017/09/01/runtime_swizzle.html"/>
    <url>/2017/09/01/runtime_swizzle.html</url>
    
    <content type="html"><![CDATA[<h3 id="æ–¹æ³•äº¤æ¢"><a href="#æ–¹æ³•äº¤æ¢" class="headerlink" title="æ–¹æ³•äº¤æ¢"></a>æ–¹æ³•äº¤æ¢</h3><p>Method Swizzling<br><br/></p><p>ä½œç”¨ï¼šåŠ¨æ€äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°(å³IMPæŒ‡é’ˆ)ï¼›<br><br/></p><p>åŸç†ï¼šåœ¨ç±»çš„æ•°æ®ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªâ€æ–¹æ³•åˆ—è¡¨â€ï¼Œå®ƒå­˜æ”¾ç€ SEL ä¸ IMP çš„æ˜ å°„å…³ç³»ã€‚Method Swizzling å°±æ˜¯å¯¹è¿™ä¸ªåˆ—è¡¨è¿›è¡Œçš„æ“ä½œï¼Œé€šè¿‡æ”¹å˜è¿™ç§æ˜ å°„å…³ç³»ï¼Œå®Œæˆä¸¤ä¸ªæ–¹æ³•IMPçš„äº¤æ¢ï¼›</p><br/><p>ä½¿ç”¨åœºæ™¯ï¼š</p><ol><li>ç±»çš„æŸä¸ªåŸæœ‰æ–¹æ³•æ— æ³•æ»¡è¶³æ–°çš„éœ€æ±‚ï¼Œéœ€è¦æ‰©å±•å¹¶æ›¿æ¢ä¹‹ã€‚å¦‚æ•°ç»„æ–°å¢å¯¹è±¡æ—¶ï¼Œæ£€æµ‹å¯¹è±¡æ˜¯å¦ä¸ºnilï¼›</li><li>æ–°å¢é¡µé¢ç»Ÿè®¡ç­‰åŠŸèƒ½æ—¶ï¼Œæ–°å»ºçˆ¶ç±»å®ç°ç»Ÿè®¡ä¸šåŠ¡ï¼Œä¹‹åè®©ç›¸å…³ç±»ç»§æ‰¿æ­¤ç±»æ—¶ï¼Œä¼šé€ æˆé‡å¤åŠ³åŠ¨ã€‚è€Œåœ¨è¿è¡Œæ—¶ï¼Œå¦‚æœäº‹å…ˆæ›¿æ¢viewDidLoadç­‰ä¸ºè‡ªå·±çš„ç»Ÿè®¡æ–¹æ³•ï¼Œåˆ™åªéœ€è¦ä¸€æ¬¡æ“ä½œä¾¿å¯æˆåŠŸï¼›</li></ol><p>å…¶æ ¸å¿ƒä»£ç æ˜¯runtimeçš„ä¸‹é¢ä¸¤ä¸ªCè¯­è¨€APIï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs smali">/** <br> * Exchanges the implementations of two methods.<br> * <br> * @param m1 Method to exchange with second method.<br> * @param m2 Method to exchange with first method.<br> * <br> * @note This is an atomic version of the following:<br> *  \code <br> *  IMP imp1 = method_getImplementation(m1);<br> *  IMP imp2 = method_getImplementation(m2);<br> *  method_setImplementation(m1, imp2);<br> *  method_setImplementation(m2, imp1);<br> *  \endcode<br> */<br>OBJC_EXPORT void method_exchangeImplementations(Method m1, Method m2)<br><br><br>/** <br> * Returns a specified<span class="hljs-built_in"> instance </span>method for a given class.<br> * <br> * @param cls The class you want to inspect.<br> * @param name The selector of the method you want to retrieve.<br> * <br> * @return The method that corresponds to the implementation of the selector specified by <br> *  \e name for the class specified by \e cls,<span class="hljs-built_in"> or </span>\c NULL<span class="hljs-built_in"> if </span>the specified class<span class="hljs-built_in"> or </span>its <br> *  superclasses do<span class="hljs-built_in"> not </span>contain an<span class="hljs-built_in"> instance </span>method with the specified selector.<br> *<br> * @note This function searches superclasses for implementations, whereas \c class_copyMethodList does not.<br> */<br>OBJC_EXPORT Method class_getInstanceMethod(Class cls, SEL name)<br></code></pre></td></tr></table></figure><h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h3><p>æ•°ç»„æ–°å¢å¯¹è±¡æ—¶æ£€æµ‹nilå¯¹è±¡ï¼Œé˜²æ­¢é—ªé€€ã€‚</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;NSMutableArray+Extension.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NSMutableArray</span> (<span class="hljs-title">Extension</span>)</span><br><br>+(<span class="hljs-type">void</span>)load&#123;<br>    [<span class="hljs-keyword">self</span> swizzle_install];<br>&#125;<br><br>+ (<span class="hljs-type">void</span>)swizzle_install<br>&#123;<br>    Method method1 = class_getInstanceMethod(objc_getClass(<span class="hljs-string">&quot;__NSArrayM&quot;</span>),<br>    <span class="hljs-keyword">@selector</span>(addObject:));<br>    Method method2 = class_getInstanceMethod(objc_getClass(<span class="hljs-string">&quot;__NSArrayM&quot;</span>),<br>    <span class="hljs-keyword">@selector</span>(swizzle_addObject:));<br>    <span class="hljs-comment">// äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°å‡½æ•°</span><br>    method_exchangeImplementations(method1, method2);<br>&#125;<br><br>-(<span class="hljs-type">void</span>)swizzle_addObject:(<span class="hljs-type">id</span>)anObject<br>&#123;<br>    <span class="hljs-comment">// å‘ç°ç©ºå¯¹è±¡</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">nil</span> == anObject)<br>    &#123;<br>        <span class="hljs-keyword">@try</span> &#123;<br>            <span class="hljs-comment">// æ³¨æ„ï¼šå› ä¸ºå·²ç»äº¤æ¢è¿‡æ–¹æ³•äº†ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„æ˜¯æ•°ç»„çš„addObject:æ–¹æ³•ã€‚</span><br>            [<span class="hljs-keyword">self</span> swizzle_addObject:anObject];<br>        &#125; <span class="hljs-keyword">@catch</span> (<span class="hljs-built_in">NSException</span> *exception) &#123;<br>            <span class="hljs-comment">// æ•è·å¼‚å¸¸ï¼Œæ‰“å°æ—¥å¿—ï¼Œé¿å…é—ªé€€ã€‚</span><br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Crash reason:\n %@&quot;</span>, [exception callStackSymbols]);<br>        &#125; <span class="hljs-keyword">@finally</span> &#123;&#125;<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœå¯¹è±¡ä¸ä¸ºç©º</span><br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">// æ­£å¸¸è°ƒç”¨æ•°ç»„åŸç”Ÿçš„addObject:æ–¹æ³•ï¼Œä¸æ•è·å¼‚å¸¸ã€‚</span><br>        [<span class="hljs-keyword">self</span> swizzle_addObject:anObject];<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>åœ¨APPå¯åŠ¨åï¼Œè¿è¡Œæ—¶ä¼šå…ˆæ‰§è¡Œ NSMutableArray åˆ†ç±»ä¸­çš„ <code>+load</code> å‡½æ•°ï¼Œè¿™é‡Œä¼šè°ƒç”¨<code>swizzle_install</code>ï¼Œå¯åŠ¨æ–¹æ³•äº¤æ¢ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//æ·»åŠ å¯¹è±¡</span><br>    <span class="hljs-built_in">NSMutableArray</span> *array = [<span class="hljs-built_in">NSMutableArray</span> new];<br>    [array addObject:<span class="hljs-literal">nil</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ï¼Œè™½ç„¶å‘æ•°ç»„ä¸­åŠ å…¥nilå¯¹è±¡ï¼Œä½†å› ä¸ºå·²ç»å¯¹addObjectæ–¹æ³•åšäº†äº¤æ¢å¹¶åšäº†å®¹é”™å¤„ç†ï¼Œæ‰€ä»¥åªæ˜¯ä¼šæ‰“å°å´©æºƒæ—¥å¿—ï¼Œåº”ç”¨å¹¶ä¸ä¼šå´©æºƒã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runtime</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Runtimeï¼šå¯¹è±¡å…³è”</title>
    <link href="/2017/08/30/runtime_associate.html"/>
    <url>/2017/08/30/runtime_associate.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-å¯¹è±¡å…³è”"><a href="#1-å¯¹è±¡å…³è”" class="headerlink" title="1.å¯¹è±¡å…³è”"></a>1.å¯¹è±¡å…³è”</h3><p>ä½¿ç”¨å…³è”ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¿®æ”¹ç±»å®šä¹‰çš„å‰æä¸‹ï¼Œä¸ºå…¶å¯¹è±¡å¢åŠ å­˜å‚¨ç©ºé—´ã€‚<br><br/></p><p>é€‚åˆçš„åœºæ™¯ï¼š</p><ol><li>æŠŠæŸå¯¹è±¡ä¸ç‰¹å®šå¯¹è±¡ç›¸å…³è”ï¼›</li><li>OCå…è®¸ç»™åˆ†ç±»å¢åŠ å±æ€§ï¼Œä½†ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆgetterã€setterå‡½æ•°ï¼Œå› æ­¤è°ƒç”¨æ—¶ä¼šå´©æºƒï¼Œä½¿ç”¨å…³è”å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼›</li></ol><h4 id="1-1-åˆ›å»ºå…³è”"><a href="#1-1-åˆ›å»ºå…³è”" class="headerlink" title="1.1.åˆ›å»ºå…³è”"></a>1.1.åˆ›å»ºå…³è”</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">OBJC_EXPORT void objc<span class="hljs-constructor">_setAssociatedObject(<span class="hljs-params">id</span> <span class="hljs-params">object</span>, <span class="hljs-params">const</span> <span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">key</span>, <span class="hljs-params">id</span> <span class="hljs-params">value</span>, <span class="hljs-params">objc_AssociationPolicy</span> <span class="hljs-params">policy</span>)</span>;<br></code></pre></td></tr></table></figure><p>å‚æ•°ï¼š</p><ul><li>objectï¼šæºå¯¹è±¡ï¼›</li><li>*keyï¼šé”®ï¼›</li><li>valueï¼šå°†å…³è”åˆ°æºå¯¹è±¡ä¸­çš„å¯¹è±¡ï¼›</li><li>policyï¼šå…³è”ç­–ç•¥ï¼›</li></ul><p>å…³è”ç­–ç•¥å­—æ®µä¸å£°æ˜å±æ€§æ—¶çš„å…³é”®å­—ç±»ä¼¼ï¼š</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elm">typedef <span class="hljs-type">OBJC_ENUM</span>(uintptr_t, objc_AssociationPolicy) &#123;<br><span class="hljs-type">OBJC_ASSOCIATION_ASSIGN</span> = 0,<br><span class="hljs-type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span> = 1, <br><span class="hljs-type">OBJC_ASSOCIATION_COPY_NONATOMIC</span> = 3,<br><span class="hljs-type">OBJC_ASSOCIATION_RETAIN</span> = 01401,<br><span class="hljs-type">OBJC_ASSOCIATION_COPY</span> = 01403<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä½œç”¨ï¼šè¯´æ˜ç›¸å…³çš„å¯¹è±¡æ˜¯é€šè¿‡èµ‹å€¼ã€ä¿ç•™å¼•ç”¨è¿˜æ˜¯å¤åˆ¶çš„æ–¹å¼è¿›è¡Œå…³è”çš„ï¼›è¿˜æœ‰è¿™ç§å…³è”æ˜¯åŸå­çš„è¿˜æ˜¯éåŸå­çš„ã€‚</p><h4 id="1-2-è·å–å…³è”"><a href="#1-2-è·å–å…³è”" class="headerlink" title="1.2.è·å–å…³è”"></a>1.2.è·å–å…³è”</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">OBJC_EXPORT id objc<span class="hljs-constructor">_getAssociatedObject(<span class="hljs-params">id</span> <span class="hljs-params">object</span>, <span class="hljs-params">const</span> <span class="hljs-params">void</span> <span class="hljs-operator">*</span><span class="hljs-params">key</span>)</span>;<br></code></pre></td></tr></table></figure><h4 id="1-3-æ–­å¼€å…³è”"><a href="#1-3-æ–­å¼€å…³è”" class="headerlink" title="1.3.æ–­å¼€å…³è”"></a>1.3.æ–­å¼€å…³è”</h4><p>æ–­å¼€å…³è”å¯ä½¿ç”¨<code>objc_setAssociatedObject</code>å‡½æ•°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥nilå€¼å³å¯ï¼Œæ­¤æ—¶å…³è”ç­–ç•¥ä¹Ÿå°±æ— æ‰€è°“äº†ã€‚</p><br/><p><code>objc_removeAssociatedObjects</code>ä¹Ÿå¯ä»¥æ–­å¼€å…³è”ï¼Œä½†ä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œå®ƒä¼šæ–­å¼€æ‰€æœ‰çš„å…³è”ã€‚åªæœ‰åœ¨éœ€è¦æŠŠå¯¹è±¡æ¢å¤åˆ°åŸå§‹çŠ¶æ€æ—¶æ‰æ¨èä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">OBJC_EXPORT</span> <span class="hljs-variable">void</span> <span class="hljs-function"><span class="hljs-title">objc_removeAssociatedObjects</span>(<span class="hljs-variable">id</span> <span class="hljs-variable"><span class="hljs-class">object</span></span>)</span><br></code></pre></td></tr></table></figure><h4 id="1-4-ç¤ºä¾‹"><a href="#1-4-ç¤ºä¾‹" class="headerlink" title="1.4.ç¤ºä¾‹"></a>1.4.ç¤ºä¾‹</h4><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSObject</span> (<span class="hljs-title">Associate</span>)</span><br><br><span class="hljs-comment">//å±æ€§ åˆ†ç±»ä¸­å…è®¸å£°æ˜å±æ€§ï¼Œä½†ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆgetterã€setterå‡½æ•°ï¼›</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-type">id</span> mAssociateObj;<br><br><span class="hljs-comment">//ç§»é™¤å…³è”</span><br>- (<span class="hljs-type">void</span>)removeAssociate;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;NSObject+Associate.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><br><span class="hljs-keyword">static</span> <span class="hljs-type">void</span> *mAssociateObjKey = &amp;mAssociateObjKey;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NSObject</span> (<span class="hljs-title">Associate</span>)</span><br><br><br>- (<span class="hljs-type">void</span>)setMAssociateObj:(<span class="hljs-type">id</span>)obj<br>&#123;<br>    <span class="hljs-comment">//åˆ›å»ºå…³è”</span><br>    objc_setAssociatedObject(<span class="hljs-keyword">self</span>, mAssociateObjKey, obj, OBJC_ASSOCIATION_COPY_NONATOMIC);<br>&#125;<br><br>- (<span class="hljs-type">id</span>)mAssociateObj<br>&#123;<br>    <span class="hljs-comment">//è·å–å…³è”çš„å¯¹è±¡</span><br>    <span class="hljs-keyword">return</span> objc_getAssociatedObject(<span class="hljs-keyword">self</span>, mAssociateObjKey);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)removeAssociate<br>&#123;<br>    objc_setAssociatedObject(<span class="hljs-keyword">self</span>, mAssociateObjKey, <span class="hljs-literal">nil</span>, OBJC_ASSOCIATION_COPY_NONATOMIC);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">NSObject *obj = <span class="hljs-literal">[NSO<span class="hljs-identifier">bject</span> <span class="hljs-identifier">new</span>]</span>;<br>obj.mAssociateObj = @<span class="hljs-string">&quot;THIS IS A STRING&quot;</span>;<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++å…³è”å¯¹è±¡ï¼š%@&quot;</span>,<span class="hljs-params">obj</span>.<span class="hljs-params">mAssociateObj</span>)</span>;<br><br><span class="hljs-literal">[<span class="hljs-identifier">obj</span> <span class="hljs-identifier">removeAssociate</span>]</span>;<br><span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;++++ç§»é™¤åçš„å…³è”å¯¹è±¡ï¼š%@&quot;</span>,<span class="hljs-params">obj</span>.<span class="hljs-params">mAssociateObj</span>)</span>;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—ï¼š</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">++++å…³è”å¯¹è±¡ï¼šTHIS <span class="hljs-keyword">IS</span> A <span class="hljs-built_in">STRING</span><br>++++ç§»é™¤åçš„å…³è”å¯¹è±¡ï¼š(<span class="hljs-keyword">null</span>)<br></code></pre></td></tr></table></figure><p>#ç¤ºä¾‹2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated<br>&#123;<br>    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];<br><br>    <span class="hljs-built_in">UIAlertController</span> *alertControler = [<span class="hljs-built_in">UIAlertController</span> <br>        alertControllerWithTitle:<span class="hljs-string">@&quot;Title&quot;</span><br>        message:<span class="hljs-string">@&quot;This is Mess&quot;</span><br>        preferredStyle:<span class="hljs-built_in">UIAlertControllerStyleAlert</span>];<br><br>    <span class="hljs-built_in">UIAlertAction</span> *action = [<span class="hljs-built_in">UIAlertAction</span> actionWithTitle:<span class="hljs-string">@&quot;OK&quot;</span> <br>        style:<span class="hljs-built_in">UIAlertActionStyleCancel</span> <br>        handler:^(<span class="hljs-built_in">UIAlertAction</span> * _Nonnull action) &#123;<br><br>        <span class="hljs-built_in">NSString</span> *associateObj = objc_getAssociatedObject(alertControler, mAssociateObjKey);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å…³è”å¯¹è±¡ï¼š%@&quot;</span>,associateObj);<br>        objc_setAssociatedObject(alertControler, mAssociateObjKey, <span class="hljs-literal">nil</span>, OBJC_ASSOCIATION_COPY_NONATOMIC);<br><br>        <span class="hljs-built_in">NSString</span> *associateObj2 = objc_getAssociatedObject(alertControler, mAssociateObjKey);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++å…³è”å¯¹è±¡ï¼š%@&quot;</span>,associateObj2);<br>    &#125;];<br>    [alertControler addAction:action];<br><br>    objc_setAssociatedObject(alertControler, mAssociateObjKey, <span class="hljs-string">@&quot;This is a string obj&quot;</span>, OBJC_ASSOCIATION_COPY_NONATOMIC);<br><br>    [<span class="hljs-keyword">self</span> presentViewController:alertControler animated:<span class="hljs-literal">YES</span> completion:^&#123;<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>ç‚¹å‡»å¼¹çª—ä¹‹åï¼Œè¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">++++å…³è”å¯¹è±¡ï¼šThis <span class="hljs-keyword">is</span> a <span class="hljs-built_in">string</span> obj<br>++++ç§»é™¤å…³è”å¯¹è±¡åï¼š(<span class="hljs-literal">null</span>)<br></code></pre></td></tr></table></figure><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼š</p><ol><li>é€šè¿‡å…³è”å¢åŠ å±æ€§ï¼Œåªæ˜¯æŠŠå±æ€§å¯¹è±¡ä¸ç±»å¯¹è±¡çš„å®ä¾‹ç›¸å…³è”ï¼Œå¹¶æœªçœŸæ­£å¢åŠ ç±»çš„æˆå‘˜å˜é‡ï¼›</li><li>å…³è”çš„å¯¹è±¡ä¸è¢«å…³è”çš„å¯¹è±¡ï¼Œä¸¤è€…çš„å†…å­˜ç©ºé—´æ˜¯åˆ†å¼€çš„ï¼›</li></ol><h4 id="1-5-åŸç†"><a href="#1-5-åŸç†" class="headerlink" title="1.5.åŸç†"></a>1.5.åŸç†</h4><p>é€šè¿‡å…³è”æŠ€æœ¯æˆ‘ä»¬å¯ä»¥å°†å¯¹è±¡ä¸æŸä¸ªå®ä¾‹ç»‘å®šåˆ°ä¸€èµ·ï¼Œæˆ–è€…åœ¨æŸä¸ªåˆ†ç±»ä¸­å®ç°å±æ€§çš„å­˜å–ã€‚ä½†æ˜¯åœ¨è¿è¡Œæ—¶è¢«å…³è”çš„å±æ€§å¹¶æ²¡æœ‰æ·»åŠ åˆ° <code>category_t</code> ç»“æ„ä½“ä¸­ï¼Œä¹Ÿä¸ä¼šåˆå¹¶åˆ°åŸç±»å¯¹è±¡é‡Œï¼Œè€Œæ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€çš„ <code>AssociationsManager</code> é‡Œã€‚</p><blockquote><p>æ‰€æœ‰çš„å…³è”å±æ€§ã€è·å–å…³è”å±æ€§ã€ç§»é™¤å…³è”å±æ€§éƒ½æ˜¯é€šè¿‡ä¸€ä¸ª<code>AssociationsManager</code>æ¥æ“ä½œï¼Œç±»ä¼¼äº OC ä¸­ NSFileManager çš„è§’è‰²ï¼Œé€šè¿‡ä¼ é€’è¿›æ¥çš„å¯¹è±¡ä½œä¸ºåœ°å€å–å‡ºè¿™ä¸ªå¯¹è±¡æ‰€å¯¹åº”çš„å…³è”åˆ—è¡¨ï¼Œç„¶åé€šè¿‡<code>key</code>å–å‡ºè¿™ä¸ªå…³è”åˆ—è¡¨çš„å…³è”å±æ€§ ObjcAssociationã€‚ObjcAssociation åŒ…å«äº† <code>å…³è”ç­–ç•¥</code> å’Œ <code>å…³è”å€¼</code>.</p></blockquote><p>æ›´å…·ä½“çš„æºç å¯ä»¥å‚è€ƒâ€œå¤§å…µå¸ƒè±æ©ç‰¹â€çš„ <a href="https://www.jianshu.com/p/21555a36a29d">è¿™ç¯‡æ–‡ç« </a>~</p><h3 id="2-åˆ†ç±»ç‰¹æ®Šæ€§"><a href="#2-åˆ†ç±»ç‰¹æ®Šæ€§" class="headerlink" title="2.åˆ†ç±»ç‰¹æ®Šæ€§"></a>2.åˆ†ç±»ç‰¹æ®Šæ€§</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NSObject</span> (<span class="hljs-title">Associate</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> aInt;<span class="hljs-comment">//æ­¤å¤„ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ï¼šâ€œinstance variables may not be placed in categoriesâ€</span><br>&#125;<br><span class="hljs-comment">//å±æ€§ åˆ†ç±»ä¸­å…è®¸å£°æ˜å±æ€§ï¼Œä½†ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆgetterã€setterå‡½æ•°ï¼›</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-type">id</span> mAssociateObj;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ul><li>åˆ†ç±»ä¸­ä¸èƒ½å£°æ˜æˆå‘˜å˜é‡ï¼›</li><li>åˆ†ç±»ä¸­å…è®¸å£°æ˜å±æ€§ï¼Œä½†ä¸ä¼šç”Ÿæˆå±æ€§å¯¹åº”çš„æˆå‘˜å˜é‡åŠå…¶ getter\setterï¼›</li><li>åˆ†ç±»ä¸­å¯ä»¥å¢åŠ æ–°çš„æ–¹æ³•ï¼Œæˆ–è€…è¦†ç›–åŸç±»çš„æ–¹æ³•ï¼›</li></ul><h4 id="2-1-âœ˜æˆå‘˜å˜é‡"><a href="#2-1-âœ˜æˆå‘˜å˜é‡" class="headerlink" title="2.1.âœ˜æˆå‘˜å˜é‡"></a>2.1.âœ˜æˆå‘˜å˜é‡</h4><p>ç»“è®ºï¼šä¸èƒ½é€šè¿‡åˆ†ç±»å‘åŸç±»ä¸­å¢åŠ æ–°çš„æˆå‘˜å˜é‡ã€‚<br><br/></p><p>åŸå› åˆ†æï¼šOCä¸­çš„ç±»æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>objc_class</code> çš„ç»“æ„ä½“ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_class</span> &#123;<br>Class isa<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !__OBJC2__</span><br>Class super_class <br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name <br><span class="hljs-type">long</span> version<br><span class="hljs-type">long</span> info<br><span class="hljs-type">long</span> instance_size <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_ivar_list</span> *ivars  <span class="hljs-comment">//æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_method_list</span> **methodLists <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_cache</span> *cache<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_protocol_list</span> *protocols<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><ul><li>å®ä¾‹çš„å†…å­˜å¸ƒå±€åœ¨ç¼–è¯‘æœŸå·²ç¡®å®š</li></ul><p>å¢åŠ æ–°æˆå‘˜å˜é‡ï¼Œå°±éœ€è¦é¢å¤–çš„å†…å­˜æ¥å­˜å‚¨æ–°çš„å€¼ã€‚è€Œç±»ç»“æ„åœ¨<code>ç¼–è¯‘æ—¶</code>å°±å·²ç»ç¡®å®šäº†ï¼Œå³ç±»å®ä¾‹çš„å†…å­˜ç©ºé—´å¤§å°<code>&quot;instance_size&quot;</code>å’Œæˆå‘˜å˜é‡åˆ—è¡¨<code>&quot;ivars&quot;</code>çš„å†…å®¹åœ¨ç¼–è¯‘é˜¶æ®µå°±å·²ç»ç¡®å®šã€‚</p><ul><li>åˆ†ç±»çš„åŠ è½½æ™šäºåŸç±»</li></ul><p>åˆ†ç±»ä¸­çš„å±æ€§å’Œæ–¹æ³•æ˜¯åœ¨åº”ç”¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼ŒåŸç±»æ³¨å†Œå®Œæˆä¹‹åæ‰æ³¨å†Œåˆ°åŸç±»ä¸­çš„ï¼Œå³åˆ†ç±»åŠ è½½æ—¶åŸç±»çš„ç»“æ„æ—©å·²å›ºå®šã€‚<br><br/></p><p>åŸºäºä»¥ä¸Šä¸¤ç‚¹ï¼Œåˆ†ç±»ä¸èƒ½å‘ä¸€ä¸ªå·²ç»<code>å®Œæˆç¼–è¯‘å’ŒåŠ è½½</code>çš„åŸç±»ä¸­å†å¢åŠ æˆå‘˜å˜é‡~<br><br/></p><p>æœ‰äººè¯´å¯ä»¥ä½¿ç”¨<code>class_addIvar()</code>å¢åŠ æˆå‘˜å˜é‡ï¼Œéœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œè¿™æ˜¯ä¸ª<code>è¿è¡Œæ—¶</code>å‡½æ•°~ä¸”è‹¹æœæ–‡æ¡£ä¸­å·²ç»æ˜ç¡®è¯´æ˜ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs smali">/** <br>* Adds a<span class="hljs-built_in"> new </span>instance variable to a class.<br>* @note This function may only be called after objc_allocateClassPair<br>*      <span class="hljs-built_in"> and </span>before objc_registerClassPair. <br>*       Adding an<span class="hljs-built_in"> instance </span>variable to an existing class is<span class="hljs-built_in"> not </span>supported.<br>* @note The class must<span class="hljs-built_in"> not </span>be a metaclass. <br>*       Adding an<span class="hljs-built_in"> instance </span>variable to a metaclass is<span class="hljs-built_in"> not </span>supported.<br>* @note The<span class="hljs-built_in"> instance </span>variable&#x27;s minimum alignment in bytes is 1&lt;&lt;align. <br>*       The minimum alignment of an<span class="hljs-built_in"> instance </span><br>*       variable depends on the ivar&#x27;s type<span class="hljs-built_in"> and </span>the machine architecture. <br>*       For variables of any pointer type, pass log2(sizeof(pointer_type)).<br>*/<br>OBJC_EXPORT BOOL class_addIvar(Class cls,<span class="hljs-built_in"> const </span>char *name, size_t size, <br>uint8_t alignment,<span class="hljs-built_in"> const </span>char *types)<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°åªèƒ½åœ¨<code>objc_allocateClassPair</code>ä¸<code>objc_registerClassPair</code>ä¹‹é—´ä½¿ç”¨ã€‚å°±æ˜¯è¯´ä¸€æ—¦ç±»çš„å®šä¹‰å®Œæˆä¹‹åï¼Œå°±ä¸èƒ½å†å¢åŠ æˆå‘˜å˜é‡ã€‚æˆ‘ä»¬ç”¨åˆ°çš„ç±»ï¼Œåœ¨ç¼–è¯‘æ—¶å…¶ç»“æ„å°±å·²ç»å›ºå®šäº†ã€‚å³ä½¿åœ¨<code>è¿è¡Œæ—¶</code>ï¼Œä¹Ÿä¸èƒ½åœ¨<code>objc_registerClassPair()</code>ä¹‹åå†å¢åŠ æˆå‘˜å˜é‡ï¼</p><br/><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/message.h&gt;</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//åˆ›å»ºæ–°çš„ç±»</span><br>    Class Person = objc_allocateClassPair([<span class="hljs-built_in">NSObject</span> <span class="hljs-keyword">class</span>], <span class="hljs-string">&quot;Person&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">//å¢åŠ æˆå‘˜å˜é‡</span><br>    <span class="hljs-type">BOOL</span> status = class_addIvar(Person, <span class="hljs-string">&quot;nick&quot;</span>,<br>    <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">NSString</span>*), log2(<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">NSString</span>*)), <span class="hljs-keyword">@encode</span>(<span class="hljs-built_in">NSString</span>*));<br><br>    <span class="hljs-keyword">if</span> (status)<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å˜é‡nickæ·»åŠ æˆåŠŸ&quot;</span>); <span class="hljs-comment">// æˆåŠŸ</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å˜é‡nickæ·»åŠ å¤±è´¥&quot;</span>);<br><br>    <span class="hljs-comment">//æ³¨å†Œç±»</span><br>    objc_registerClassPair(Person);<br><br>    status = class_addIvar(Person, <span class="hljs-string">&quot;city&quot;</span>,<br>    <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">NSString</span>*), log2(<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">NSString</span>*)), <span class="hljs-keyword">@encode</span>(<span class="hljs-built_in">NSString</span>*));<br><br>    <span class="hljs-keyword">if</span> (status)<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å˜é‡cityæ·»åŠ æˆåŠŸ&quot;</span>);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å˜é‡cityæ·»åŠ å¤±è´¥&quot;</span>); <span class="hljs-comment">// å¤±è´¥</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++++</span><span class="hljs-comment">å˜é‡nickæ·»åŠ æˆåŠŸ</span><br><span class="hljs-literal">+++++</span><span class="hljs-comment">å˜é‡cityæ·»åŠ å¤±è´¥</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ä¸­åœ¨<code>objc_registerClassPair()</code>ä¹‹åæ·»åŠ æˆå‘˜å˜é‡<code>city</code>å¤±è´¥~</p><h4 id="2-2-âœ”ï¸å±æ€§"><a href="#2-2-âœ”ï¸å±æ€§" class="headerlink" title="2.2.âœ”ï¸å±æ€§"></a>2.2.âœ”ï¸å±æ€§</h4><p>ç»“è®ºï¼šåˆ†ç±»ä¸­å¯ä»¥å¢åŠ å±æ€§ï¼Œä½†ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„æˆå‘˜å˜é‡å’Œgetter&#x2F;setterã€‚<br><br/></p><p>1ã€åˆ†ç±»ä¸ºä»€ä¹ˆå¯ä»¥å£°æ˜å±æ€§å‘¢ï¼Ÿ<br><br/></p><p>è¿™æ˜¯å› ä¸ºåˆ†ç±»çš„ç»“æ„ä½“ä¸­æœ¬èº«å°±å®šä¹‰äº†<code>proper_list_t *properties</code>å­—æ®µï¼Œå‚è€ƒ<a href="https://www.jianshu.com/p/eebc2acd7da0">è¿™é‡Œ</a>ã€‚<br><br/></p><p>2ã€ä¸ºä»€ä¹ˆä¸èƒ½è‡ªåŠ¨ç”Ÿæˆå±æ€§å¯¹åº”çš„æˆå‘˜å˜é‡å’Œå­˜å–å‡½æ•°å‘¢ï¼Ÿ<br><br/></p><p>åŸç±»ä¸­å±æ€§å¯¹åº”çš„æˆå‘˜å˜é‡å’Œå­˜å–å‡½æ•°éƒ½æ˜¯ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µç”Ÿæˆçš„ï¼Œè€Œåˆ†ç±»çš„åˆ™æ˜¯åœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µåŸç±»åŠ è½½å®Œæˆä¹‹åæ‰æ³¨å†Œåˆ°åŸç±»ä¸­çš„ï¼Œæ‰€ä»¥æ²¡æ³•å®ç°å±æ€§çš„@synthesizeåŠŸèƒ½ã€‚å¦‚æœæƒ³å®ç°è¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢æåˆ°çš„å…³è”æŠ€æœ¯ã€‚<br><br/></p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/message.h&gt;</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-comment">//åˆ›å»ºæ–°çš„ç±»</span><br>    Class Person = objc_allocateClassPair([<span class="hljs-built_in">NSObject</span> <span class="hljs-keyword">class</span>], <span class="hljs-string">&quot;Person&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">//å¢åŠ æˆå‘˜å˜é‡</span><br>    <span class="hljs-type">BOOL</span> status = class_addIvar(Person, <span class="hljs-string">&quot;nick&quot;</span>,<br>    <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">NSString</span>*), log2(<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">NSString</span>*)), <span class="hljs-keyword">@encode</span>(<span class="hljs-built_in">NSString</span>*));<br><br>    <span class="hljs-keyword">if</span> (status)<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å˜é‡nickæ·»åŠ æˆåŠŸ&quot;</span>); <span class="hljs-comment">// æˆåŠŸ</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å˜é‡nickæ·»åŠ å¤±è´¥&quot;</span>);<br><br>    <span class="hljs-comment">//æ³¨å†Œç±»</span><br>    objc_registerClassPair(Person);<br><br>    <span class="hljs-comment">//ä¸ºç±»å¢åŠ å±æ€§</span><br>    objc_property_attribute_t type  = &#123;<span class="hljs-string">&quot;T&quot;</span>,<span class="hljs-string">&quot;@\&quot;NSString\&quot;&quot;</span>&#125;;<br>    objc_property_attribute_t ownership1 = &#123;<span class="hljs-string">&quot;C&quot;</span>,<span class="hljs-string">&quot;&quot;</span>&#125;;      <span class="hljs-comment">// C = copy</span><br>    objc_property_attribute_t ownership2 = &#123; <span class="hljs-string">&quot;N&quot;</span>, <span class="hljs-string">&quot;&quot;</span> &#125;;   <span class="hljs-comment">// N = nonatomic</span><br>    objc_property_attribute_t backIvars  = &#123;<span class="hljs-string">&quot;V&quot;</span>,<span class="hljs-string">&quot;_name&quot;</span>&#125;; <span class="hljs-comment">//å±æ€§å</span><br>    objc_property_attribute_t atts[] = &#123;type,ownership1,ownership2,backIvars&#125;;<br><br>    status = class_addProperty(Person, <span class="hljs-string">&quot;name&quot;</span>, atts, <span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">if</span> (status)<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å±æ€§nameæ·»åŠ æˆåŠŸ&quot;</span>); <span class="hljs-comment">// æˆåŠŸ</span><br>    <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++å±æ€§nameæ·»åŠ æˆåŠŸ&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ—¥å¿—ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++++</span><span class="hljs-comment">å˜é‡nickæ·»åŠ æˆåŠŸ</span><br><span class="hljs-literal">+++++</span><span class="hljs-comment">å±æ€§nameæ·»åŠ æˆåŠŸ</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—æ˜¾ç¤ºï¼Œ<code>objc_registerClassPair</code>ä¹‹åæ˜¯å¯ä»¥åŠ¨æ€æ·»åŠ <code>å±æ€§</code>çš„ï¼Œä½†æ˜¯å¦‚æœä½ æ‰“å°æ­¤æ—¶ç±»çš„æˆå‘˜å˜é‡åˆ—è¡¨ä½ ä¼šå‘ç°ï¼Œå¹¶æœªåˆ›å»ºå±æ€§å¯¹åº”çš„ä»¥ä¸‹åˆ’çº¿<code>_</code>å¼€å¤´çš„æˆå‘˜å˜é‡ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¹³æ—¶æ‰€è§åˆ°çš„<code>&quot;_å±æ€§å&quot;</code>æˆå‘˜å˜é‡æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ›å»ºçš„ï¼Œè¿™é‡Œçš„ä»£ç æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œå¹¶æœªç»è¿‡ç¼–è¯‘å™¨~</p><h4 id="2-3-âœ”ï¸æ–¹æ³•"><a href="#2-3-âœ”ï¸æ–¹æ³•" class="headerlink" title="2.3.âœ”ï¸æ–¹æ³•"></a>2.3.âœ”ï¸æ–¹æ³•</h4><p>ç»“è®ºï¼šåˆ†ç±»ä¸­å¯ä»¥å¢åŠ æ–°çš„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥è¦†ç›–åŸç±»çš„æ–¹æ³•ã€‚</p><br/><p>ç±»çš„ç»“æ„ä½“ä¸­ï¼Œ<code>**methodLists</code>æ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_method_list</code>æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´<code>**methodLists</code>åªæ˜¯æŠŠè£…æ–¹æ³•ä»¬çš„å®¹å™¨çš„åœ°å€ä¿å­˜åœ¨ç±»çš„ç»“æ„ä½“é‡Œã€‚ç±»ç¼–è¯‘å®Œæˆåï¼Œè¿™ä¸ªå®¹å™¨çš„åœ°å€ä¸å¯å˜äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¾€è¿™ä¸ªå®¹å™¨é‡Œç»§ç»­æ·»åŠ å…ƒç´ ã€‚å› ä¸ºå¢åŠ æ–¹æ³•ä¸ä¼šå½±å“ç±»çš„å†…å­˜ç©ºé—´ã€‚<br><br/></p><p>åˆ†ç±»ä¸­å®šä¹‰çš„æ–¹æ³•ä¹Ÿä¼šè¢«åŠ å…¥åˆ°åŸç±»<code>**methodLists</code>å®¹å™¨ä¸­ï¼Œä¸”åˆ†ç±»çš„æ–¹æ³•ä¼šåœ¨åŸç±»çš„æ–¹æ³•ä¹‹å‰ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œæˆ‘ä»¬åœ¨åˆ†ç±»ä¸­é‡å†™åŸç±»çš„æ–¹æ³•æ—¶ï¼ŒåŸç±»çš„æ–¹æ³•ä¼šå¤±æ•ˆï¼Œå› ä¸ºåœ¨æŸ¥æ‰¾æ–¹æ³•çš„è¿‡ç¨‹ä¸­åˆ†ç±»çš„æ–¹æ³•é å‰è€Œæœ€å…ˆè¢«æ‰¾åˆ°ï¼Œç›´æ¥ç»ˆæ­¢å¯»æ‰¾è¿‡ç¨‹å¹¶è°ƒç”¨åˆ†ç±»ä¸­çš„å®ç°å»äº†ã€‚<br><br/></p><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// åŸç±»å¤´æ–‡ä»¶</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">Person</span> : <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">NSCoding</span>&gt;</span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">NSInteger</span> age;<br><br>- (<span class="hljs-type">void</span>)callMe;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">// åŸç±»mæ–‡ä»¶</span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Person</span></span><br><br>- (<span class="hljs-type">void</span>)callMe&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++My name is:%@&quot;</span>,<span class="hljs-keyword">self</span>.name);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-comment">// åˆ†ç±»Person+C.m</span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Person</span> (<span class="hljs-title">C</span>)</span><br><br><span class="hljs-comment">// é‡å†™åŸç±»çš„æ–¹æ³•å¹¶æä¾›æ–°çš„å®ç°</span><br>- (<span class="hljs-type">void</span>)callMe&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++My name is not:%@&quot;</span>,<span class="hljs-keyword">self</span>.name);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://www.jianshu.com/p/21555a36a29d">Â©å¤§å…µå¸ƒè±æ©ç‰¹-å…³è”å¯¹è±¡æŠ€æœ¯åŸç†</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runtime</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Runtimeï¼šæˆå‘˜å˜é‡ã€å±æ€§åŠå…¶åº”ç”¨</title>
    <link href="/2017/08/25/runtime_ivar.html"/>
    <url>/2017/08/25/runtime_ivar.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-æˆå‘˜å˜é‡"><a href="#1-æˆå‘˜å˜é‡" class="headerlink" title="1.æˆå‘˜å˜é‡"></a>1.æˆå‘˜å˜é‡</h3><h4 id="Ivar"><a href="#Ivar" class="headerlink" title="Ivar"></a>Ivar</h4><p>åœ¨<code>objc/runtime.h</code>ä¸­ï¼ŒIvarçš„æè¿°å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// An opaque type that represents an instance variable.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_ivar</span> *Ivar;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_ivar</span> &#123;<br><span class="hljs-type">char</span> *ivar_name<br><span class="hljs-type">char</span> *ivar_type<br><span class="hljs-type">int</span> ivar_offset<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __LP64__</span><br><span class="hljs-type">int</span> space<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>Ivarï¼Œå¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œæ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_ivar</code>ç»“æ„ä½“çš„æŒ‡é’ˆï¼ŒåŒ…æ‹¬åå­—ä¸ç±»å‹ã€‚</p><h4 id="è·å–æˆå‘˜å˜é‡"><a href="#è·å–æˆå‘˜å˜é‡" class="headerlink" title="è·å–æˆå‘˜å˜é‡"></a>è·å–æˆå‘˜å˜é‡</h4><p>å¸¸ç”¨æ“ä½œå‡½æ•°æœ‰ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> è·å–æ‰€æœ‰æˆå‘˜å˜é‡<br>class_copyIvarList<br><br><span class="hljs-regexp">//</span> è·å–æˆå‘˜å˜é‡å<br>ivar_getName<br><br><span class="hljs-regexp">//</span> è·å–æˆå‘˜å˜é‡ç±»å‹ç¼–ç <br>ivar_getTypeEncoding<br><br><span class="hljs-regexp">//</span> è·å–æŒ‡å®šåç§°çš„æˆå‘˜å˜é‡<br>class_getInstanceVariable<br><br><span class="hljs-regexp">//</span> è·å–æŸä¸ªå¯¹è±¡æˆå‘˜å˜é‡çš„å€¼<br>object_getIvar<br><br><span class="hljs-regexp">//</span> è®¾ç½®æŸä¸ªå¯¹è±¡æˆå‘˜å˜é‡çš„å€¼<br>object_setIvar<br></code></pre></td></tr></table></figure><h3 id="2-å±æ€§"><a href="#2-å±æ€§" class="headerlink" title="2.å±æ€§"></a>2.å±æ€§</h3><h4 id="å±æ€§çš„å®šä¹‰"><a href="#å±æ€§çš„å®šä¹‰" class="headerlink" title="å±æ€§çš„å®šä¹‰"></a>å±æ€§çš„å®šä¹‰</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// An opaque type that represents an Objective-C declared property.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_property</span> *<span class="hljs-type">objc_property_t</span>;<br></code></pre></td></tr></table></figure><p>å±æ€§ï¼Œä¸€ä¸ªæŒ‡å‘<code>objc_property</code>ç»“æ„ä½“ï¼Œé€šå¸¸ä»¥<code>@property</code>å…³é”®å­—æ¥å£°æ˜ã€‚<br><br/></p><p><code>å±æ€§</code>ä¸<code>æˆå‘˜å˜é‡</code>æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç»“æ„ä½“ï¼Œä½†ä¸¤è€…è¢«ç´§ç´§å…³è”åœ¨äº†ä¸€èµ·ï¼Œåªä¸è¿‡åœ¨ä¸åŒç‰ˆæœ¬çš„ç¼–è¯‘å™¨ä¸­ç¨æœ‰ä¸åŒã€‚</p><ul><li><strong>iOS 5ä»¥å‰</strong></li></ul><p><code>iOS5</code>ä»¥å‰ï¼Œä½¿ç”¨å±æ€§é€šå¸¸éœ€è¦ä¸‰æ­¥ï¼š</p><ol><li>å¤§æ‹¬å·å£°æ˜æˆå‘˜å˜é‡ï¼›</li><li>@property å£°æ˜å±æ€§ï¼›</li><li>@synthesize åˆæˆå±æ€§ä¸æˆå‘˜å˜é‡ï¼›</li></ol><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">People</span>()</span><br>&#123;<br>    <span class="hljs-comment">//å£°æ˜æˆå‘˜å˜é‡</span><br>    <span class="hljs-built_in">NSString</span> *_name;<span class="hljs-comment">//ä»¥ä¸‹åˆ’çº¿å¼€å¤´çš„æˆå‘˜å˜é‡</span><br>    <span class="hljs-built_in">NSString</span> *nick;<br>&#125;<br><span class="hljs-comment">//å£°æ˜å±æ€§</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *name;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *aliasName;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">People</span></span><br><span class="hljs-comment">//åˆæˆå±æ€§ ç»‘å®šæˆå‘˜å˜é‡åˆ°æŒ‡å®šçš„å±æ€§ä¸Š å¹¶åœ¨ getterã€setterä¸­ä½¿ç”¨æ­¤æˆå‘˜å˜é‡èµ‹å€¼</span><br><span class="hljs-keyword">@synthesize</span> name = _name;<br><span class="hljs-keyword">@synthesize</span> aliasName = nick;<br><br>- (<span class="hljs-type">void</span>)test&#123;<br>    <span class="hljs-keyword">self</span>.name = <span class="hljs-string">@&quot;A&quot;</span>;<br>    <span class="hljs-keyword">self</span>.aliasName = <span class="hljs-string">@&quot;B&quot;</span>;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++self.name=&#x27;%@&#x27;,++self.aliasName=&#x27;%@&#x27;,++_name=&#x27;%@&#x27;,++nick=&#x27;%@&#x27;&quot;</span>,<span class="hljs-keyword">self</span>.name,<span class="hljs-keyword">self</span>.aliasName,_name,nick);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>1.ç¤ºä¾‹ä¸­<code>&#123; &#125;</code>é‡Œå£°æ˜æˆå‘˜å˜é‡æ—¶å¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿<code>_</code>å¼€å¤´ï¼Œä¹Ÿå¯ä»¥ä¸å¸¦ä¸‹åˆ’çº¿ï¼›<br><br/></p><p>2.<code>@property</code>çš„ä½œç”¨æ˜¯è‡ªåŠ¨ç”Ÿæˆå±æ€§çš„ setter\getter æ–¹æ³•çš„<code>å£°æ˜</code>ï¼Œå³</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">-</span>(void)setName:(NSString*)aName;<br><span class="hljs-built_in">-</span>(NSString*)name;<br></code></pre></td></tr></table></figure><p>3.<code>@synthesize</code>çš„ä½œç”¨æ˜¯æŒ‡å®šä¸€ä¸ª<code>æˆå‘˜å˜é‡</code>ï¼Œå°†å…¶ç»‘å®šåˆ°å±æ€§ä¸Šã€‚ç„¶åå®ç°å±æ€§çš„ getter\setter å¹¶åœ¨å…¶ä¸­ä½¿ç”¨æ­¤æˆå‘˜å˜é‡å­˜å–å€¼ï¼›</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sqf">- (NSString *)<span class="hljs-built_in">name</span>&#123;<br>    return <span class="hljs-variable">_name</span>;<br>&#125;<br><br>- (void)<span class="hljs-built_in">setName</span>:(NSString *)aName&#123;<br>    <span class="hljs-keyword">if</span> (aName &amp;&amp; <span class="hljs-variable">_name</span> &amp;&amp; ![aName isEqualToString:<span class="hljs-variable">_name</span>]) &#123;<br>        return;<br>    &#125;<br>    <span class="hljs-variable">_name</span> = aName;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><strong>iOS 5ä»¥å</strong></li></ul><p>åœ¨<code>iOS5ä»¥å</code>ï¼Œè‹¹æœå°†ç¼–è¯‘å™¨ä» GCC è½¬ä¸º LLVMï¼Œä»¥ @property å£°æ˜çš„å±æ€§<code>name</code>ï¼Œç¼–è¯‘å™¨ä¼šé»˜è®¤ä¸ºå…¶ç”Ÿæˆä¸€ä¸ªä»¥<code>ä¸‹åˆ’çº¿å¼€å¤´çš„æˆå‘˜å˜é‡</code>ï¼ŒåŒæ—¶å®ç° setter&#x2F;getter æ–¹æ³•å¹¶åœ¨å…¶ä¸­ä½¿ç”¨<code>&quot;_name&quot;</code>å­˜å–å€¼ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å¸®æˆ‘ä»¬çœå»äº†éƒ¨åˆ†æ“ä½œã€‚ åœ¨.mæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨<code>_name</code>ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>self.name</code>ã€‚å…¶ä¸­ï¼Œåè€…å®é™…ä¸Šæ˜¯è°ƒç”¨äº†å±æ€§<code>name</code>çš„ getter\setter å‡½æ•°ã€‚<br><br/></p><p><strong>psï¼š</strong>iOS5ä¹‹åï¼Œ<code>@synthesize</code>ä»å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚å¦‚æœ<code>@synthesize</code>åä¸ºå±æ€§æŒ‡å®šçš„è¿™ä¸ªæˆå‘˜å˜é‡å¹¶ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„åŒç±»å‹çš„æˆå‘˜å˜é‡ã€‚ä¾‹å¦‚<code>@synthesize aliasName = NotExistIvar;</code>ï¼Œæˆ‘ä»¬çš„<code>&#123; &#125;</code>ä¸­å¹¶æœªå£°æ˜æ­¤æˆå‘˜å˜é‡<code>NotExistIvar</code>ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»º~</p><h4 id="è·å–å±æ€§"><a href="#è·å–å±æ€§" class="headerlink" title="è·å–å±æ€§"></a>è·å–å±æ€§</h4><p>å±æ€§çš„å¸¸ç”¨æ“ä½œå‡½æ•°ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>Â è·å–æ‰€æœ‰å±æ€§<br>class_copyPropertyList<br><br><span class="hljs-regexp">//</span> è·å–å±æ€§å<br>property_getName<br><br><span class="hljs-regexp">//</span> è·å–å±æ€§ç‰¹æ€§æè¿°å­—ç¬¦ä¸²<br>property_getAttributes<br><br><span class="hljs-regexp">//</span> è·å–æ‰€æœ‰å±æ€§ç‰¹æ€§<br>property_copyAttributeList<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>property_getAttributes</code>è¿”å›çš„æ˜¯ä¸€ä¸ª<code>objc_property_attribute_t</code>ç»“æ„ä½“åˆ—è¡¨ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// Defines a property attribute</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;           <span class="hljs-comment">/**&lt; The name of the attribute */</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *value;          <span class="hljs-comment">/**&lt; The value of the attribute (usually empty) */</span><br>&#125; <span class="hljs-type">objc_property_attribute_t</span>;<br></code></pre></td></tr></table></figure><p>å¸¸ç”¨çš„å€¼å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">å±æ€§ç±»å‹  nameå€¼ï¼šT  valueï¼š<span class="hljs-built_in">NSString</span>ç­‰<br>ç¼–ç ç±»å‹  nameå€¼ï¼šC(<span class="hljs-keyword">copy</span>)ã€&amp;(<span class="hljs-keyword">strong</span>\<span class="hljs-keyword">retain</span>)ã€W(<span class="hljs-keyword">weak</span>)ã€R(<span class="hljs-keyword">readonly</span>)ã€ç©º(<span class="hljs-keyword">assign</span>) ç­‰ valueï¼šæ— <br>é/åŸå­æ€§ nameå€¼ï¼šç©º(atomic) N(Nonatomic)  valueï¼šæ— <br>å±æ€§åç§°  nameå€¼ï¼šV  valueï¼šè‡ªå®šä¹‰çš„åå­—<br></code></pre></td></tr></table></figure><h3 id="3-æŸ¥è¯¢ç¤ºä¾‹"><a href="#3-æŸ¥è¯¢ç¤ºä¾‹" class="headerlink" title="3.æŸ¥è¯¢ç¤ºä¾‹"></a>3.æŸ¥è¯¢ç¤ºä¾‹</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//IvarTool.h</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">IvarTool</span> : <span class="hljs-title">NSObject</span></span><br>&#123;<br>    <span class="hljs-type">double</span> ivar_defaultDouble;<span class="hljs-comment">//é»˜è®¤ä½œç”¨åŸŸ</span><br><span class="hljs-keyword">@package</span><br>    <span class="hljs-type">int</span> ivar_packInt;<br><span class="hljs-keyword">@public</span><br>    <span class="hljs-type">float</span>  ivar_publicFloat;<br><span class="hljs-keyword">@protected</span><br>    <span class="hljs-built_in">NSString</span> *ivar_protectedStr;<br><span class="hljs-keyword">@private</span><br>    <span class="hljs-built_in">NSDictionary</span> *ivar_privateDic;<br>&#125;<br><span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nonatomic</span>,<span class="hljs-keyword">copy</span>)  <span class="hljs-built_in">NSString</span> *property_string;<br><span class="hljs-comment">//æˆå‘˜å˜é‡åˆ—è¡¨</span><br>+ (<span class="hljs-type">void</span>)ivarList;<br><span class="hljs-comment">//å±æ€§åˆ—è¡¨</span><br>+ (<span class="hljs-type">void</span>)propertyList;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//IvarTool.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;IvarTool.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">IvarTool</span>()</span><br>&#123;<br>    <span class="hljs-type">int</span> ivar_int;<br><span class="hljs-keyword">@public</span><br>    <span class="hljs-built_in">NSArray</span> *ivar_array;<br>&#125;<br><span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSDictionary</span> *property_dic;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">IvarTool</span></span><br><br>+ (<span class="hljs-type">void</span>)ivarList<br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    Ivar *ivars = class_copyIvarList([IvarTool <span class="hljs-keyword">class</span>], &amp;count);<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt;count; i++)<br>    &#123;<br>        Ivar ivar = ivars[i];<br>        <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charName = ivar_getName(ivar);<br>        <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charType = ivar_getTypeEncoding(ivar);<br>        <br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Name:%s,Type:%s&quot;</span>,charName,charType);<br>    &#125;<br>    <br>    free(ivars);<br>&#125;<br><br><br>+ (<span class="hljs-type">void</span>)propertyList<br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    objc_property_t *properties = class_copyPropertyList([IvarTool <span class="hljs-keyword">class</span>], &amp;count);<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt;count; i++)<br>    &#123;<br>        objc_property_t aProperty = properties[i];<br>        <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charName = property_getName(aProperty);<br>        <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charType = property_getAttributes(aProperty);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Name:%s,Type:%s&quot;</span>,charName,charType);<br>    &#125;<br>    <br>    free(properties);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>[IvarTool ivarList]</code>ï¼ŒæŸ¥çœ‹æˆå‘˜å˜é‡ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-type">Name</span>:ivar_defaultDouble,<span class="hljs-keyword">Type</span>:d<br><span class="hljs-type">Name</span>:ivar_packInt,<span class="hljs-keyword">Type</span>:i<br><span class="hljs-type">Name</span>:ivar_publicFloat,<span class="hljs-keyword">Type</span>:f<br><span class="hljs-type">Name</span>:ivar_protectedStr,<span class="hljs-keyword">Type</span>:@&quot;NSString&quot;<br><span class="hljs-type">Name</span>:ivar_privateDic,<span class="hljs-keyword">Type</span>:@&quot;NSDictionary&quot;<br><span class="hljs-type">Name</span>:ivar_int,<span class="hljs-keyword">Type</span>:i<br><span class="hljs-type">Name</span>:ivar_array,<span class="hljs-keyword">Type</span>:@&quot;NSArray&quot;<br><span class="hljs-type">Name</span>:_property_string,<span class="hljs-keyword">Type</span>:@&quot;NSString&quot;<br><span class="hljs-type">Name</span>:_property_dic,<span class="hljs-keyword">Type</span>:@&quot;NSDictionary&quot;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨<code>[IvarTool propertyList]</code>ï¼ŒæŸ¥çœ‹å±æ€§åˆ—è¡¨ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs excel"><span class="hljs-built_in">Na</span><span class="hljs-symbol">me:pr</span>operty_dic,Ty<span class="hljs-symbol">pe:T</span>@<span class="hljs-string">&quot;NSDictionary&quot;</span>,&amp;,<span class="hljs-built_in">N</span>,V_property_dic<br><span class="hljs-built_in">Na</span><span class="hljs-symbol">me:pr</span>operty_string,Ty<span class="hljs-symbol">pe:T</span>@<span class="hljs-string">&quot;NSString&quot;</span>,C,<span class="hljs-built_in">N</span>,V_property_string<br></code></pre></td></tr></table></figure><p><strong>å°ç»“</strong>ï¼š</p><ul><li>ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºå±æ€§ç”Ÿæˆå¯¹åº”çš„ä»¥ä¸‹åˆ’çº¿å¼€å¤´çš„æˆå‘˜å˜é‡ï¼›</li><li>æ— è®ºæˆå‘˜å˜é‡çš„è®¿é—®æƒé™å¦‚ä½•ï¼Œæ˜¯åœ¨.h è¿˜æ˜¯ .m ä¸­å£°æ˜çš„ï¼Œclass_copyIvarList éƒ½èƒ½è·å–çš„åˆ°ï¼›</li><li>æ— è®ºå±æ€§å®šä¹‰åœ¨ .h è¿˜æ˜¯ .m ä¸­ï¼Œclass_copyPropertyList èƒ½è·å–å…¨éƒ¨å±æ€§ï¼›</li><li>class_copyIvarList ä¸ class_copyPropertyList éƒ½åªèƒ½è·å–åˆ°å½“å‰ç±»ä¸­å®šä¹‰çš„æˆå‘˜å˜é‡æˆ–å±æ€§ï¼Œè·å–ä¸åˆ°å…¶çˆ¶ç±»çš„ä¸­å®šä¹‰çš„ï¼›</li></ul><h3 id="4-è®¿é—®æƒé™"><a href="#4-è®¿é—®æƒé™" class="headerlink" title="4.è®¿é—®æƒé™"></a>4.è®¿é—®æƒé™</h3><p>å…³äºæˆå‘˜å˜é‡çš„è®¿é—®æƒé™ï¼Œ<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjectiveC/Chapters/ocDefiningClasses.html#//apple_ref/doc/uid/TP30001163-CH12-SW1">Appleå®˜æ–¹</a>æè¿°å¦‚ä¸‹ï¼š<br><br/></p><p>@public: å¯¼å…¥å¤´æ–‡ä»¶çš„åœ°æ–¹ï¼Œéƒ½èƒ½ç›´æ¥è®¿é—®ï¼ˆ<code>.m</code>æ–‡ä»¶ä¸­å£°æ˜çš„æˆå‘˜å˜é‡é™¤å¤–ï¼‰ï¼›</p><p>@protected: æœ¬ç±»åŠå…¶å­ç±»å®ä¾‹æ–¹æ³•ä¸­å¯è§ï¼›</p><p>@private: åªå¯¹æœ¬ç±»å¯è§ï¼Œå¯¹å…¶å­ç±»ä¸å¯è§ï¼›</p><p>@package: æ¯”è¾ƒç‰¹æ®Šï¼Œè®¿é—®èŒƒå›´ä»‹äº<code>public</code>å’Œ<code>private</code>ä¹‹é—´ï¼Œåªè¦å¤„äºåŒä¸€ä¸ªé•œåƒæˆ–å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ—¶ç›¸å½“äº<code>public</code>ï¼Œåœ¨å®ç°å…¶çš„é•œåƒæˆ–å¯æ‰§è¡Œæ–‡ä»¶ä¹‹å¤–æ—¶ç›¸å½“äº<code>private</code>ï¼Œä¸‹é¢æ˜¯AppleåŸæ–‡ä¸­çš„æè¿°ï¼›</p><blockquote><p>Using the modern runtime, an @package instance variable has @public scope inside the executable image that implements the class, but acts like @private outside.<br>The @package scope for Objective-C instance variables is analogous to private_extern for C variables and functions. Any code outside the class implementationâ€™s image that tries to use the instance variable gets a link error.<br>This scope is most useful for instance variables in framework classes, where @private may be too restrictive but @protected or @public too permissive.</p></blockquote><br/><p><strong>é»˜è®¤å€¼ï¼š</strong></p><p><code>.h</code>ä¸­é»˜è®¤ä¸º @protectedï¼›</p><p><code>.m</code>ä¸­é»˜è®¤ä¸º @privateï¼›</p><br/><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xl">- (BOOL)application:(UIApplication *)application<br>didFinishLaunchingWithOptions:(NSDictionary *)launchOptions<br>&#123;<br>    IvarTool *tool = [[IvarTool alloc] init];<br>   <br>    <span class="hljs-comment">//ä¸‹é¢å‡ ä¸ªä¼šæŠ¥é”™ </span><br>    <span class="hljs-function"><span class="hljs-title">tool</span> -&gt;</span> ivar_defaultDouble;<br>    <span class="hljs-function"><span class="hljs-title">tool</span> -&gt;</span> ivar_protectedStr;<br>    <span class="hljs-function"><span class="hljs-title">tool</span> -&gt;</span> ivar_privateDic;<br>    <span class="hljs-function"><span class="hljs-title">tool</span> -&gt;</span> ivar_int;<br>    <span class="hljs-function"><span class="hljs-title">tool</span> -&gt;</span> ivar_array;<br>    tool.property_dic;<br>    <br>    <span class="hljs-comment">//ä¸‹é¢çš„è°ƒç”¨èƒ½æ­£å¸¸ä½¿ç”¨</span><br>    <span class="hljs-function"><span class="hljs-title">tool</span> -&gt;</span> ivar_packInt;<br>    <span class="hljs-function"><span class="hljs-title">tool</span> -&gt;</span> ivar_publicFloat;<br>    tool.property_string;<br>    <br>    return YES;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥æƒ³å®ç°æˆå‘˜å˜é‡æ”¯æŒå¤–éƒ¨è®¿é—®ï¼Œéœ€è¦åœ¨å¤´æ–‡ä»¶çš„å£°æ˜ä¸­ç»™è¯¥æˆå‘˜å˜é‡æ·»åŠ <code>@public</code>ä¿®é¥°ç¬¦ï¼ŒåŒæ—¶åœ¨å¤–éƒ¨è®¿é—®æ—¶ä½¿ç”¨<code>-&gt;</code>ã€‚mæ–‡ä»¶å†…å³ä½¿æˆå‘˜å˜é‡æ·»åŠ <code>@public</code>ä¿®é¥°ç¬¦ï¼Œå¤–éƒ¨è®¿é—®æ—¶ä»ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒåªå¯¹mæ–‡ä»¶å†…å¯è§ã€‚</p><h3 id="5-å¿«é€Ÿåºåˆ—åŒ–"><a href="#5-å¿«é€Ÿåºåˆ—åŒ–" class="headerlink" title="5.å¿«é€Ÿåºåˆ—åŒ–"></a>5.å¿«é€Ÿåºåˆ—åŒ–</h3><p>åŸç†ï¼šåˆ©ç”¨<code>runtime</code>æä¾›çš„å‡½æ•°ï¼Œéå†<code>model</code>çš„å±æ€§ï¼Œå¹¶å¯¹å±æ€§è¿›è¡Œ<code>decode</code>ä¸<code>encode</code>ã€‚</p><br/><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs llvm">//ModelSerialiseHelper.h<br><br>#ifndef ModelSerialiseHelper_h<br>#<span class="hljs-keyword">define</span> ModelSerialiseHelper_h<br><br>#import &lt;objc/runtime.h&gt;<br>/*<br> åºåˆ—åŒ–å·¥å…·ä½¿ç”¨ç¤ºä¾‹:<br> <br> <span class="hljs-number">1</span>ã€TLObjectå¤´æ–‡ä»¶ä¸­å£°æ˜NSCodingåè®®<br> <br> <span class="hljs-title">@interface</span> TLObject : NSObject&lt;NSCoding&gt;<br> <span class="hljs-title">@property</span> (nonatomic<span class="hljs-punctuation">,</span> copy) NSString *mName<span class="hljs-comment">;</span><br> <span class="hljs-title">@property</span> (nonatomic) BOOL mIsTrue<span class="hljs-comment">;</span><br> <span class="hljs-title">@property</span> (nonatomic) NSInteger mInteger<span class="hljs-comment">;</span><br> <span class="hljs-title">@property</span> (nonatomic) UIImage *mImage<span class="hljs-comment">;</span><br> <span class="hljs-title">@end</span><br> <br> <span class="hljs-number">2</span>ã€mæ–‡ä»¶ä¸­å¯¼å…¥å¤´æ–‡ä»¶å’Œå®å³å¯<br> <br> #import <span class="hljs-string">&quot;TLObject.h&quot;</span><br> #import <span class="hljs-string">&quot;ModelSerialiseHelper.h&quot;</span><br> <span class="hljs-title">@implementation</span> TLObject<br> <br> ModelCodingProtocol()<br> <br> <span class="hljs-title">@end</span><br> */<br><br><br>#<span class="hljs-keyword">define</span> ModelCodingProtocol()\<br>- (id)initWithCoder:(NSCoder *)coder\<br>&#123;\<br>    Class cls <span class="hljs-operator">=</span> [self class]<span class="hljs-comment">;\</span><br>    while (cls !<span class="hljs-operator">=</span> [NSObject class])\<br>    &#123;\<br>        unsigned int count <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-comment">;\</span><br>        Ivar *ivarList <span class="hljs-operator">=</span> class_copyIvarList([cls class]<span class="hljs-punctuation">,</span> &amp;count)<span class="hljs-comment">;\</span><br>        for (int i <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; count; i++)\</span><br>        &#123;\<br>            const char *varName <span class="hljs-operator">=</span> ivar_getName(*(ivarList + i))<span class="hljs-comment">;\</span><br>            NSString *key <span class="hljs-operator">=</span> [NSString stringWithUTF<span class="hljs-number">8</span>String:varName]<span class="hljs-comment">;\</span><br>            NSString *aStr <span class="hljs-operator">=</span> [key substringToIndex:<span class="hljs-number">1</span>]<span class="hljs-comment">;\</span><br>            if ([aStr isEqualToString:@<span class="hljs-string">&quot;_&quot;</span>]) &#123;\<br>                key <span class="hljs-operator">=</span> [key substringFromIndex:<span class="hljs-number">1</span>]<span class="hljs-comment">;\</span><br>            &#125;\<br>            id varValue <span class="hljs-operator">=</span> [coder decodeObjectForKey:key]<span class="hljs-comment">;\</span><br>            if (varValue) &#123;\<br>                [self setValue:varValue forKey:key]<span class="hljs-comment">;\</span><br>            &#125;\<br>        &#125;\<br>        <span class="hljs-keyword">free</span>(ivarList)<span class="hljs-comment">;\</span><br>        cls <span class="hljs-operator">=</span> class_getSuperclass(cls)<span class="hljs-comment">;\</span><br>    &#125;\<br>    return self<span class="hljs-comment">;\</span><br>&#125;\<br>- (void)encodeWithCoder:(NSCoder *)coder\<br>&#123;\<br>    Class cls <span class="hljs-operator">=</span> [self class]<span class="hljs-comment">;\</span><br>    while (cls !<span class="hljs-operator">=</span> [NSObject class])\<br>    &#123;\<br>        unsigned int count <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-comment">;\</span><br>        Ivar *ivarList <span class="hljs-operator">=</span> class_copyIvarList([cls class]<span class="hljs-punctuation">,</span> &amp;count)<span class="hljs-comment">;\</span><br>        for (int i <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; count; i++)\</span><br>        &#123;\<br>            const char *varName <span class="hljs-operator">=</span> ivar_getName(*(ivarList + i))<span class="hljs-comment">;\</span><br>            NSString *key <span class="hljs-operator">=</span> [NSString stringWithUTF<span class="hljs-number">8</span>String:varName]<span class="hljs-comment">;\</span><br>            NSString *aStr <span class="hljs-operator">=</span> [key substringToIndex:<span class="hljs-number">1</span>]<span class="hljs-comment">;\</span><br>            if ([aStr isEqualToString:@<span class="hljs-string">&quot;_&quot;</span>]) &#123;\<br>                key <span class="hljs-operator">=</span> [key substringFromIndex:<span class="hljs-number">1</span>]<span class="hljs-comment">;\</span><br>            &#125;\<br>            id varValue <span class="hljs-operator">=</span> [self valueForKey:key]<span class="hljs-comment">;\</span><br>            if (varValue) &#123;\<br>                [coder encodeObject:varValue forKey:key]<span class="hljs-comment">;\</span><br>            &#125;\<br>        &#125;\<br>        <span class="hljs-keyword">free</span>(ivarList)<span class="hljs-comment">;\</span><br>        cls <span class="hljs-operator">=</span> class_getSuperclass(cls)<span class="hljs-comment">;\</span><br>    &#125;\<br>&#125;\<br><br>#<span class="hljs-keyword">define</span> ModelCopyProtocol()\<br>- (id)copyWithZone:(NSZone *)zone\<br>&#123;\<br>    id copy <span class="hljs-operator">=</span> [[[self class] allocWithZone:zone] init]<span class="hljs-comment">;\</span><br>    Class cls <span class="hljs-operator">=</span> [self class]<span class="hljs-comment">;\</span><br>    while (cls !<span class="hljs-operator">=</span> [NSObject class])\<br>    &#123;\<br>        unsigned int count <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-comment">;\</span><br>        Ivar *ivarList <span class="hljs-operator">=</span> class_copyIvarList([cls class]<span class="hljs-punctuation">,</span> &amp;count)<span class="hljs-comment">;\</span><br>        for (int i <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; count; i++)\</span><br>        &#123;\<br>            const char *varName <span class="hljs-operator">=</span> ivar_getName(*(ivarList + i))<span class="hljs-comment">;\</span><br>            NSString *key <span class="hljs-operator">=</span> [NSString stringWithUTF<span class="hljs-number">8</span>String:varName]<span class="hljs-comment">;\</span><br>            NSString *aStr <span class="hljs-operator">=</span> [key substringToIndex:<span class="hljs-number">1</span>]<span class="hljs-comment">;\</span><br>            if ([aStr isEqualToString:@<span class="hljs-string">&quot;_&quot;</span>]) &#123;\<br>                key <span class="hljs-operator">=</span> [key substringFromIndex:<span class="hljs-number">1</span>]<span class="hljs-comment">;\</span><br>            &#125;\<br>            id varValue <span class="hljs-operator">=</span> [self valueForKey:key]<span class="hljs-comment">;\</span><br>            if (varValue) &#123;\<br>                [copy setValue:varValue forKey:key]<span class="hljs-comment">;\</span><br>            &#125;\<br>        &#125;\<br>        <span class="hljs-keyword">free</span>(ivarList)<span class="hljs-comment">;\</span><br>        cls <span class="hljs-operator">=</span> class_getSuperclass(cls)<span class="hljs-comment">;\</span><br>    &#125;\<br>    return copy<span class="hljs-comment">;\</span><br>&#125;\<br><br>#endif /* ModelSerialiseHelper_h */<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸º<code>ModelSerialiseHelper.h</code>ï¼Œå…¶ä¸­ï¼š</p><ul><li>ModelCopyProtocol()    å°è£…äº†copyåè®®çš„ç›¸å…³å®ç°ä»£ç ï¼›</li><li>ModelCodingProtocol()  å°è£…äº†encodeå’Œdecodeçš„ç›¸å…³ä»£ç ï¼›</li></ul><p>åœ¨éœ€è¦å®ç°è¿™ä¸¤ä¸ªåè®®çš„<code>model</code>ä¸­ï¼Œåªéœ€å¯¼å…¥<code>ModelSerialiseHelper.h</code>å¹¶å¼•ç”¨ä¸Šè¿°ä¸¤ä¸ªå®å®šä¹‰å³å¯ã€‚</p><h3 id="6-json-å­—å…¸è½¬Model"><a href="#6-json-å­—å…¸è½¬Model" class="headerlink" title="6.json\å­—å…¸è½¬Model"></a>6.json\å­—å…¸è½¬Model</h3><p>åŸç†ï¼šè·å–æ¨¡å‹çš„<code>å±æ€§åˆ—è¡¨</code>ï¼Œé€šè¿‡<code>kvc</code>ä»å­—å…¸ä¸­å–å€¼å¹¶èµ‹å€¼ç»™å¯¹åº”çš„å±æ€§å­—æ®µã€‚</p><br/><p>#ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;NSObject+JsonToModel.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NSObject</span> (<span class="hljs-title">JsonToModel</span>)</span><br><br>- (<span class="hljs-keyword">instancetype</span>)initModelWithDictionary:(<span class="hljs-built_in">NSDictionary</span> *)jsonDic<br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-keyword">self</span> init])<br>    &#123;<br>        <span class="hljs-built_in">NSMutableArray</span> * keysArr;<br>        <span class="hljs-keyword">if</span> (!jsonDic) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;<br>        <br>        keysArr = [<span class="hljs-built_in">NSMutableArray</span> array];<br>        <br>        <span class="hljs-comment">//è·å–ç±»çš„å±æ€§åŠå±æ€§å¯¹åº”çš„ç±»å‹</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count;<br>        objc_property_t * properties = class_copyPropertyList([<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>], &amp;count);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++)<br>        &#123;<br>            objc_property_t property = properties[i];<br>            <span class="hljs-comment">//è·å–å±æ€§å</span><br>            <span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *charName = property_getName(property);<br>            <span class="hljs-built_in">NSString</span> *propertyName = [<span class="hljs-built_in">NSString</span> stringWithCString:charName encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>            <br>            <span class="hljs-keyword">if</span> (propertyName.length) &#123;<br>                [keysArr addObject:propertyName];<br>            &#125;<br>        &#125;<br>        free(properties);<br>        <br>        <span class="hljs-comment">//ç»™å±æ€§èµ‹å€¼</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> * key <span class="hljs-keyword">in</span> keysArr) &#123;<br>            [<span class="hljs-keyword">self</span> setValue:jsonDic[key] forKey:key];<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">NSDictionary <span class="hljs-symbol">*</span>dic = <span class="hljs-meta">@&#123;</span><span class="hljs-meta">@&quot;name&quot;:</span><span class="hljs-meta">@&quot;xxx&quot;,</span><span class="hljs-meta">@&quot;sex&quot;:</span><span class="hljs-meta">@(1),</span><span class="hljs-meta">@&quot;age&quot;:</span><span class="hljs-meta">@(20)&#125;;</span><br>PersonModel <span class="hljs-symbol">*</span>person = [[PersonModel alloc] initModelWithDictionary:dic];<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ç¤ºä¾‹åªæ˜¯ä¸€ä¸ªç®€å•çš„åœºæ™¯ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½ä¼šæœ‰æ›´å¤æ‚çš„éœ€æ±‚ï¼Œè§†æƒ…å†µåšå“åº”ä¿®æ”¹å³å¯ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjectiveC/Chapters/ocDefiningClasses.html#//apple_ref/doc/uid/TP30001163-CH12-SW1">Â©Apple</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runtime</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Runtimeï¼šæ¶ˆæ¯æœºåˆ¶</title>
    <link href="/2017/08/23/runtime_message.html"/>
    <url>/2017/08/23/runtime_message.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-id"><a href="#1-id" class="headerlink" title="1.id"></a>1.id</h3><p>åœ¨<code>objc/objc.h</code>ä¸­ï¼Œidçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs smali">/// Represents an<span class="hljs-built_in"> instance </span>of a class.<br>struct objc_object &#123;<br>Class isa  OBJC_ISA_AVAI<span class="hljs-class">LABILITY;</span><br>&#125;;<br><br>/// A pointer to an<span class="hljs-built_in"> instance </span>of a class.<br>typedef struct objc_object *id;<br><span class="hljs-comment">#endif</span><br></code></pre></td></tr></table></figure><p>idæ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆç±»å‹ï¼Œå®ƒæŒ‡å‘OCä¸­çš„ä»»ä½•å¯¹è±¡ã€‚</p><h3 id="2-ç±»ï¼ˆclassï¼‰"><a href="#2-ç±»ï¼ˆclassï¼‰" class="headerlink" title="2.ç±»ï¼ˆclassï¼‰"></a>2.ç±»ï¼ˆclassï¼‰</h3><p>åœ¨<code>objc/runtime.h</code>ä¸­ï¼Œç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_class</span> &#123;<br>Class isa  OBJC_ISA_AVAILABILITY;       <span class="hljs-comment">//æŒ‡é’ˆ</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !__OBJC2__</span><br>Class super_class                       <span class="hljs-comment">//çˆ¶ç±»;</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name                        <span class="hljs-comment">//ç±»å;</span><br><span class="hljs-type">long</span> version                                             <span class="hljs-comment">//ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œé»˜è®¤ä¸º0;</span><br><span class="hljs-type">long</span> info                               <span class="hljs-comment">//ä½æ ‡è¯†;</span><br><span class="hljs-type">long</span> instance_size                      <span class="hljs-comment">//ç±»çš„å®ä¾‹å˜é‡å¤§å°;</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_ivar_list</span> *ivars            <span class="hljs-comment">//ç±»çš„æˆå‘˜å˜é‡é“¾è¡¨;</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_method_list</span> **methodLists   <span class="hljs-comment">//æ–¹æ³•å®šä¹‰çš„é“¾è¡¨;</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_cache</span> *cache                <span class="hljs-comment">//æ–¹æ³•ç¼“å­˜;</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_protocol_list</span> *protocols    <span class="hljs-comment">//åè®®é“¾è¡¨;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>&#125; OBJC2_UNAVAILABLE;<br></code></pre></td></tr></table></figure><h3 id="3-Method"><a href="#3-Method" class="headerlink" title="3.Method"></a>3.Method</h3><p><code>Method</code>å³æ–¹æ³•ï¼Œclass ç»“æ„ä½“å†…å®šä¹‰äº†<code>objc_method_list</code>é“¾è¡¨ï¼Œå…¶ä¸­ä¿å­˜çš„æ­£æ˜¯<code>objc_method</code> å¯¹è±¡:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">struct objc_method &#123;<br>    SEL _Nonnull method_name        <span class="hljs-regexp">//</span>æ–¹æ³•åç§°<br>    char * _Nullable method_types   <span class="hljs-regexp">//</span>æ–¹æ³•çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹<br>    IMP _Nonnull method_imp         <span class="hljs-regexp">//</span>æŒ‡å‘è¯¥æ–¹æ³•çš„å…·ä½“å®ç°çš„å‡½æ•°æŒ‡é’ˆ<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-built_in">NSString</span> *)methodNameWithParam1:(<span class="hljs-type">int</span>)intValue param2:(<span class="hljs-type">BOOL</span>)boolvalue<br>&#123;<br>    <span class="hljs-built_in">NSString</span> *result = [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;param1:%d, param2:%d&quot;</span>,intValue,boolvalue];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++result:%@&quot;</span>,result);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“åˆç¤ºä¾‹æ¥çœ‹ä¸‰ä¸ªå­—æ®µçš„å«ä¹‰ï¼š<br><br/></p><p>#<strong>SEL:</strong><br><br/></p><p>è¡¨ç¤ºæ–¹æ³•åï¼Œè¿è¡Œæ—¶ä¸­ç”¨æ¥ä»£æ›¿æ˜æ–‡æ–¹æ³•åï¼›</p><br/><p>#<strong>method_types:</strong><br><br/></p><p>è¡¨ç¤ºæ–¹æ³•çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ï¼Œå…·ä½“åˆ°æœ¬ç¤ºä¾‹ä¸ºâ€œ@@:iBâ€ï¼š</p><ul><li>ç¬¬ä¸€ä¸ª<code>@</code>è¡¨ç¤ºæ–¹æ³•çš„è¿”å›å€¼ä¸ºidç±»å‹ï¼›</li><li>ç¬¬äºŒä¸ª<code>@</code>è¡¨ç¤ºæ–¹æ³•çš„è°ƒç”¨è€…ï¼›</li><li><code>:</code>è¡¨ç¤ºæ–¹æ³•é€‰æ‹©å™¨SELï¼›</li><li><code>i</code>è¡¨ç¤ºå‚æ•°1ä¸ºintç±»å‹ï¼›</li><li><code>B</code>è¡¨ç¤ºå‚æ•°2ä¸ºboolç±»å‹ï¼›</li></ul><p>è¯¦ç»†ç¼–ç æ ¼å¼å¯å‚è€ƒå®˜ç½‘<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW1">#Type Encodings</a></p><br/><p>#<strong>IMP:</strong><br><br/></p><p>è¡¨ç¤ºæŒ‡å‘è¯¥æ–¹æ³•çš„å…·ä½“å®ç°çš„å‡½æ•°æŒ‡é’ˆã€‚</p><h3 id="4-Selectors"><a href="#4-Selectors" class="headerlink" title="4.Selectors"></a>4.Selectors</h3><blockquote><p>In Objective-C, selector has two meanings. It can be used to refer simply to the name of a method when itâ€™s used in a source-code message to an object. It also, though, refers to the unique identifier that replaces the name when the source code is compiled. Compiled selectors are of type SEL. All methods with the same name have the same selector. You can use a selector to invoke a method on an objectâ€”this provides the basis for the implementation of the target-action design pattern in Cocoa.</p></blockquote><p><code>selector</code>ï¼Œæ–¹æ³•é€‰æ‹©å™¨ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š</p><ul><li>ç¼–è¯‘ä¹‹å‰ï¼Œè¡¨ç¤ºä¸€ä¸ªå¯¹è±¡æ‰€è°ƒç”¨æ–¹æ³•çš„æ–¹æ³•åï¼›</li><li>ç¼–è¯‘ä¹‹åï¼Œè¡¨ç¤ºç”¨æ¥æ›¿æ¢æ–¹æ³•åçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆSELï¼‰ï¼›</li></ul><p>ç›¸åŒå‘½åçš„æ–¹æ³•æœ‰ç€ç›¸åŒçš„selectorã€‚</p><h3 id="5-SEL"><a href="#5-SEL" class="headerlink" title="5.SEL"></a>5.SEL</h3><p>åœ¨<code>objc/objc.h</code>ä¸­ï¼ŒSELçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// An opaque type that represents a method selector.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">objc_selector</span> *SEL;<br></code></pre></td></tr></table></figure><blockquote><p>Compiled selectors are assigned to a special type, SEL.</p></blockquote><p><code>SEL</code>æ˜¯æ–¹æ³•åç»è¿‡ç¼–è¯‘åï¼Œåœ¨è¿è¡Œæ—¶ä¸­çš„è¡¨ç¤ºå½¢å¼ã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</strong><br><br/></p><p>1ã€åŒä¸€ä¸ªç±»ä¸­ï¼Œä¸èƒ½åŒæ—¶å­˜åœ¨åç§°å’Œå‚æ•°ä¸ªæ•°éƒ½ç›¸åŒçš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå³ä½¿å®ƒä»¬çš„å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ä¸åŒã€‚<br><br/></p><p>è¿™æ˜¯å› ä¸ºå‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹ä¿¡æ¯éƒ½ä¿å­˜åœ¨<code>Method</code>ç»“æ„ä½“çš„<code>*method_types</code>å­—æ®µä¸­ï¼Œå¦‚ä¸Šé¢æåˆ°çš„â€œ@@:iBâ€ï¼›è€ŒSELæ˜¯<code>Method</code>çš„<code>method_name</code>å­—æ®µï¼Œæ— å…³å‚æ•°å’Œè¿”å›å€¼çš„ç±»å‹ã€‚è¿è¡Œæ—¶åªè®¤SELï¼Œåç§°ç›¸åŒä¸”å‚æ•°ä¸ªæ•°ç›¸åŒçš„ä¸¤ä¸ªæ–¹æ³•å¯¹åº”åŒä¸€ä¸ª<code>SEL</code>ï¼Œä¸€æ—¦ç›¸åŒå®ƒå°±ä¸çŸ¥é“è¯¥é€‰å“ªä¸ªã€‚ä¸ºé˜²æ­¢è¿™ç§æƒ…å†µï¼ŒXcodeåœ¨ç¼–è¯‘æ—¶ä¼šæŠ¥é”™ï¼›</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)methodName&#123; <span class="hljs-comment">//å®ä¾‹æ–¹æ³•</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++&quot;</span>);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)sameName&#123; <span class="hljs-comment">//åŸæ–¹æ³•</span><br>&#125;<br><br>- (<span class="hljs-type">void</span>)sameName:(<span class="hljs-type">int</span>)p1&#123; <span class="hljs-comment">//æ­£å¸¸ï¼ˆæ–¹æ³•ã€è¿”å›å€¼ç±»å‹åç›¸åŒï¼Œå‚æ•°ä¸ªæ•°ä¸åŒï¼‰</span><br>&#125;<br><br>- (<span class="hljs-type">int</span>)sameName:(<span class="hljs-type">int</span>)p1&#123; <span class="hljs-comment">//æŠ¥é”™ï¼ˆæ–¹æ³•åã€å‚æ•°ç±»å‹å’Œä¸ªæ•°ç›¸åŒï¼Œè¿”å›å€¼ä¸åŒï¼‰</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>- (<span class="hljs-type">int</span>)sameName:(<span class="hljs-type">int</span>)p1 param2:(<span class="hljs-type">int</span>)p2&#123;<br>&#125;<br><br>- (<span class="hljs-type">int</span>)sameName:(<span class="hljs-type">int</span>)p1 param2:(<span class="hljs-built_in">NSString</span>*)p3&#123; <span class="hljs-comment">// æŠ¥é”™ï¼ˆæ–¹æ³•åã€è¿”å›å€¼ç±»å‹ã€å‚æ•°ä¸ªæ•°ç›¸åŒï¼Œåªæ˜¯å‚æ•°ç±»å‹ä¸åŒï¼‰</span><br>&#125;<br></code></pre></td></tr></table></figure><p>2ã€åŒä¸€ä¸ªç±»ä¸­ï¼Œå…è®¸å­˜åœ¨ä¸€å¯¹æ–¹æ³•åç›¸åŒçš„å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•ã€‚<br><br/></p><p>å› ä¸ºè™½ç„¶äºŒè€…çš„SELç›¸åŒï¼Œä½†å®ä¾‹æ–¹æ³•ä¿å­˜åœ¨å…¶ç±»å¯¹è±¡ä¸­ï¼Œç±»æ–¹æ³•ä¿å­˜åœ¨å…¶å…ƒç±»å¯¹è±¡ä¸­ï¼Œè¿è¡Œæ—¶èƒ½åˆ†æ¸…ï¼›<br><br/></p><p>3ã€ä¸åŒçš„ç±»ä¸­ï¼Œå¯ä»¥å­˜åœ¨ä¸¤ä¸ªåç§°ç›¸åŒçš„æ–¹æ³•ï¼Œè¿™å¯¹å¤šæ€æœºåˆ¶å’ŒåŠ¨æ€ç»‘å®šè‡³å…³é‡è¦ï¼›</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span> : <span class="hljs-title">UIResponder</span> &lt;<span class="hljs-title">UIApplicationDelegate</span>&gt;</span><br><br><span class="hljs-comment">// ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•åç›¸åŒ</span><br>+ (<span class="hljs-type">void</span>)methodName;<br>- (<span class="hljs-type">void</span>)methodName;<br><br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br><span class="hljs-comment">//MARK: å…è®¸ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•åŒå</span><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    SEL aSEL = <span class="hljs-keyword">@selector</span>(methodName);<br><br>    <span class="hljs-comment">// è°ƒç”¨ç›¸åŒçš„SEL</span><br>    [AppDelegate performSelector:aSEL withObject:<span class="hljs-literal">nil</span>]; <span class="hljs-comment">// è°ƒç”¨ç±»æ–¹æ³•</span><br>    [<span class="hljs-keyword">self</span> performSelector:aSEL withObject:<span class="hljs-literal">nil</span>]; <span class="hljs-comment">// è°ƒç”¨å®ä¾‹æ–¹æ³•</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>+ (<span class="hljs-type">void</span>)methodName&#123; <span class="hljs-comment">//ç±»æ–¹æ³•</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><h3 id="6-æ˜ å°„å…³ç³»"><a href="#6-æ˜ å°„å…³ç³»" class="headerlink" title="6.æ˜ å°„å…³ç³»"></a>6.æ˜ å°„å…³ç³»</h3><blockquote><p>For efficiency, full ASCII names are not used as method selectors in compiled code. Instead, the compiler writes each method name into a table, then pairs the name with a unique identifier that represents the method at runtime. The runtime system makes sure each identifier is unique: No two selectors are the same, and all methods with the same name have the same selector.</p></blockquote><ul><li>åœ¨ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šå°†æ‰€æœ‰æ–¹æ³•åå†™å…¥ä¸€å¼ è¡¨ä¸­ï¼›</li><li>åœ¨ç¨‹åºè¿è¡Œé˜¶æ®µï¼Œè¿è¡Œæ—¶ä½¿ç”¨SELä»£è¡¨ä¸€ä¸ªæ–¹æ³•ï¼ˆmethodï¼‰ï¼›</li><li>runtime ä¼šå°†æ–¹æ³•åä¸SELè¿›è¡Œæ˜ å°„ï¼›</li><li>è°ƒç”¨æ–¹æ³•æ—¶ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿæ ¹æ®SELä»ç›¸å…³ç±»çš„æ–¹æ³•åˆ—è¡¨(methodLists)ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ–¹æ³•ï¼›</li><li>æ‰¾åˆ°äº†æ–¹æ³•å³å¯è°ƒç”¨å…¶ç»“æ„ä½“ä¸­çš„IMPï¼›</li></ul><h3 id="7-IMP"><a href="#7-IMP" class="headerlink" title="7.IMP"></a>7.IMP</h3><p>åœ¨<code>objc/objc.h</code>ä¸­ï¼ŒIMPçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/// A pointer to the function of a method implementation. </span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !OBJC_OLD_DISPATCH_PROTOTYPES</span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*IMP)</span><span class="hljs-params">(<span class="hljs-type">void</span> <span class="hljs-comment">/* id, SEL, ... */</span> )</span></span>; <br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">id</span> <span class="hljs-params">(*IMP)</span><span class="hljs-params">(id, SEL, ...)</span></span>; <br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p><code>IMP</code>æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªè¢«æŒ‡å‘çš„å‡½æ•°åŒ…å«ä¸€ä¸ªæ¥æ”¶æ¶ˆæ¯çš„å¯¹è±¡<code>id</code>, è°ƒç”¨æ–¹æ³•çš„é€‰æ‹©å™¨<code>SEL</code>ï¼Œä»¥åŠä¸å®šä¸ªæ•°çš„æ–¹æ³•å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª<code>id</code>ã€‚<code>IMP</code>æ˜¯æ¶ˆæ¯æœ€ç»ˆè°ƒç”¨çš„æ‰§è¡Œä»£ç ï¼Œæ˜¯æ–¹æ³•çœŸæ­£çš„å®ç°ã€‚</p><h3 id="8-æ¶ˆæ¯"><a href="#8-æ¶ˆæ¯" class="headerlink" title="8.æ¶ˆæ¯"></a>8.æ¶ˆæ¯</h3><p>åœ¨Cè¯­è¨€ä¸­ï¼Œå‡½æ•°çš„è°ƒç”¨åœ¨ç¼–è¯‘æ—¶å°±å·²ç»å†³å®šäº†ã€‚è€ŒOCæ˜¯ä¸€ç§åŠ¨æ€è¯­è¨€ã€‚å¯¹äºOCçš„å‡½æ•°ï¼Œåœ¨ç¼–è¯‘æ—¶å¹¶ä¸èƒ½å†³å®šçœŸæ­£è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œåªæœ‰åœ¨çœŸæ­£è¿è¡Œçš„æ—¶å€™æ‰ä¼šæ ¹æ®å‡½æ•°çš„åç§°æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°æ¥è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œä½ ä¼šå‘ç°ï¼šåœ¨ç¼–è¯‘é˜¶æ®µï¼Œåªè¦å£°æ˜è¿‡ï¼ŒOCå¯ä»¥è°ƒç”¨ä»»ä½•å‡½æ•°ä¸”ä¸ä¼šæŠ¥é”™ï¼Œå³ä½¿è¿™ä¸ªå‡½æ•°å¹¶æœªå®ç°ã€‚ç›¸åï¼Œç¼–è¯‘é˜¶æ®µCè¯­è¨€è°ƒç”¨æœªå®ç°çš„å‡½æ•°æ—¶ä¼šæŠ¥é”™ã€‚</p><blockquote><p>OCä¸­ï¼Œæ–¹æ³•è°ƒç”¨çš„æœ¬è´¨ï¼Œå°±æ˜¯å‘å¯¹è±¡å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚</p></blockquote><p>æ‰“å¼€<code>objc/message.h</code>æ–‡ä»¶ï¼Œå¯è§å¦‚ä¸‹å®šä¹‰ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">OBJC_EXPORT void objc<span class="hljs-constructor">_msgSend(<span class="hljs-params">void</span> <span class="hljs-operator">/</span><span class="hljs-operator">*</span> <span class="hljs-params">id</span> <span class="hljs-params">self</span>, SEL <span class="hljs-params">op</span>, <span class="hljs-operator">...</span> <span class="hljs-operator">*</span><span class="hljs-operator">/</span> )</span><br></code></pre></td></tr></table></figure><h3 id="9-æ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹"><a href="#9-æ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹" class="headerlink" title="9.æ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹"></a>9.æ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹</h3><p>1ã€è°ƒç”¨æ–¹æ³•æ—¶runtimeæŠŠæ–¹æ³•çš„è°ƒç”¨è½¬åŒ–ä¸º<code>æ¶ˆæ¯å‘é€</code>ï¼Œå³<code>objc_msgSend(id self, SEL selector, [å‚æ•°]...)</code>ï¼›<br><br/></p><p>2ã€å…¶ä¸­<code>SEL</code>æ˜¯è¿è¡Œæ—¶æ ¹æ®æ–¹æ³•åè½¬åŒ–è€Œæ¥çš„ï¼Œ<code>SEL</code>ä¸è°ƒç”¨è€…ä¸€èµ·ä½œä¸ºå‚æ•°ä¼ é€’ç»™<code>objc_msgSend()</code>ï¼Œåç»­å°±æ˜¯æ ¹æ®<code>SEL</code>æ¥æŸ¥æ‰¾æ–¹æ³•åŠå…¶<code>IMP</code>ï¼›<br><br/></p><p>2ã€æ–¹æ³•çš„è°ƒç”¨è€…ä¼šé€šè¿‡<code>isa</code>æŒ‡é’ˆæ‰¾åˆ°å…¶æ‰€å±çš„ç±»ã€‚åœ¨ç±»ä¸­æœ‰ä¸€å—æœ€è¿‘è°ƒç”¨çš„æ–¹æ³•çš„æŒ‡é’ˆç¼“å­˜ï¼ˆå³cacheï¼Œå‚è§ä¸Šé¢ç±»çš„å®šä¹‰ï¼‰ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ runtime ä¼šå…ˆå»<code>cache</code>ä¸­æ ¹æ®SELæŸ¥æ‰¾å¯¹åº”çš„æ–¹æ³•;<br><br/></p><p>3ã€è‹¥<code>cache</code>ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™å»<code>methodLists</code>ä¸­æŸ¥æ‰¾è¯¥æ–¹æ³•ã€‚æ‰¾åˆ°åé€šè¿‡å‡½æ•°æŒ‡é’ˆè·³è½¬åˆ°æ–¹æ³•ç»“æ„ä½“ä¸­ï¼Œæ‰§è¡Œç»“æ„ä½“ä¸­çš„<code>IMP</code>ï¼Œä¹‹åå°†è¯¥æ–¹æ³•åŠ å…¥åˆ°<code>cache</code>ä¸­ï¼›<br><br/></p><p>4ã€è‹¥æœªæ‰¾åˆ°è¯¥æ–¹æ³•ï¼Œåˆ™é€šè¿‡<code>super_class</code>å¾€ä¸Šä¸€çº§çˆ¶ç±»æŸ¥æ‰¾ï¼Œé‡å¤ç¬¬2ã€3æ­¥ï¼›<br><br/></p><p>5ã€å¦‚æœä¸€ç›´æ‰¾åˆ°<code>NSObject</code>éƒ½æ²¡æœ‰æ‰¾åˆ°è¯¥æ–¹æ³•æ—¶ï¼Œåœ¨ä¸åšç‰¹æ®Šå¤„ç†çš„æƒ…å†µä¸‹ï¼ˆå¦‚æ¶ˆæ¯è½¬å‘ï¼‰ï¼Œåº”ç”¨ä¼šæŠ¥è¿è¡Œæ—¶é”™è¯¯ï¼šunrecognized selector sent to instance xxxï¼‰ï¼›</p><h3 id="10-åŠ¨æ€æ–¹æ³•å†³è®®"><a href="#10-åŠ¨æ€æ–¹æ³•å†³è®®" class="headerlink" title="10.åŠ¨æ€æ–¹æ³•å†³è®®"></a>10.åŠ¨æ€æ–¹æ³•å†³è®®</h3><p>ä¸ºé˜²æ­¢ä¸Šè¿°ç¬¬5ç§æƒ…å†µä¸‹å‘ç”Ÿçš„crashï¼ŒOCæä¾›äº†åŠ¨æ€æ–¹æ³•å†³è®®ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ä¸ºä¸€ä¸ª <code>selector</code> æä¾›å®ç°ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">+ (BOOL)resolveClassMethod:(SEL)name;    <span class="hljs-regexp">//</span>ç±»æ–¹æ³•<br>+ (BOOL)resolveInstanceMethod:(SEL)name; <span class="hljs-regexp">//</span>å®ä¾‹æ–¹æ³•<br></code></pre></td></tr></table></figure><ul><li>nameå‚æ•°ï¼Œè¡¨ç¤ºéœ€è¦è¢«åŠ¨æ€å†³è®®çš„selectorï¼›</li><li>Boolè¿”å›å€¼ï¼Œè¡¨ç¤ºåŠ¨æ€å†³è®®æ˜¯å¦æˆåŠŸï¼›</li></ul><p>ä¸Šè¿°æ–¹æ³•æ˜¯NSObjectç±»ä¸­çš„ä¸¤ä¸ªç±»æ–¹æ³•ï¼ŒåŠ¨æ€æ–¹æ³•å†³è®®æ—¶ï¼Œé¡»å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­ä¸ºæŒ‡å®šçš„selectoræä¾›å®ç°ï¼ˆé€šè¿‡è°ƒç”¨è¿è¡Œæ—¶å‡½æ•°class_addMethodæ¥æ·»åŠ ï¼Œä¸‹é¢æœ‰ç¤ºä¾‹ï¼‰ã€‚<br><br/></p><p>åœ¨ä¸æ¶‰åŠæ¶ˆæ¯è½¬å‘çš„æƒ…å†µä¸‹ï¼š</p><ul><li>è‹¥ä¸Šè¿°ä¸¤å‡½æ•°å†…ä¸ºæŒ‡å®šçš„selectoræä¾›å®ç°ï¼Œæ— è®ºè¿”å›YESæˆ–NOï¼Œç¼–è¯‘è¿è¡Œéƒ½ä¼šæ­£å¸¸ï¼›</li><li>è‹¥ä¸Šè¿°ä¸¤å‡½æ•°å†…å¹¶æ²¡æœ‰ä¸ºselectoræä¾›å®ç°ï¼Œæ— è®ºè¿”å›YESæˆ–NOï¼Œç¼–è¯‘è¿è¡Œéƒ½ä¼šcrashï¼›</li></ul><p>#ç¤ºä¾‹1ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-comment">//DynamicToolå¤´æ–‡ä»¶å¦‚ä¸‹ï¼š</span><br><br>#<span class="hljs-keyword">import</span> &lt;Foundation/Foundation.h&gt;<br><br>@<span class="hljs-keyword">interface</span> <span class="hljs-symbol">DynamicTool</span> : <span class="hljs-symbol">NSObject</span><br><br>@<span class="hljs-symbol">end</span><br></code></pre></td></tr></table></figure><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//DynamicToolå®ç°æ–‡ä»¶å¦‚ä¸‹ï¼š</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DynamicTool.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><br><span class="hljs-type">void</span> instanceMethod(<span class="hljs-type">id</span> <span class="hljs-keyword">self</span>,SEL sel)<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;instance method&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> classMethod(<span class="hljs-type">id</span> <span class="hljs-keyword">self</span>,SEL sel,<span class="hljs-built_in">NSString</span>* str1,<span class="hljs-built_in">NSString</span>* str2)<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;class method param1:%@,param2:%@&quot;</span>,str1,str2);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DynamicTool</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -åŠ¨æ€å†³è®®</span><br><span class="hljs-comment">//å®ä¾‹æ–¹æ³•</span><br>+ (<span class="hljs-type">BOOL</span>)resolveInstanceMethod:(SEL)sel<br>&#123;<br>    <span class="hljs-keyword">if</span> (sel == <span class="hljs-keyword">@selector</span>(instanceMethodSelector)) &#123;<br>        class_addMethod([<span class="hljs-keyword">self</span> <span class="hljs-keyword">class</span>], sel, (IMP)instanceMethod, <span class="hljs-string">&quot;v@:&quot;</span>);<br>        <span class="hljs-comment">/*æ¯ä¸ªæ–¹æ³•éƒ½æœ‰ self å’Œ_cmd ä¸¤ä¸ªé»˜è®¤çš„éšè—å‚æ•°ï¼Œ</span><br><span class="hljs-comment">        self å³æ¥æ”¶æ¶ˆæ¯çš„å¯¹è±¡æœ¬èº«ï¼Œ_cmd å³æ˜¯ selector é€‰æ‹©å™¨ï¼›</span><br><span class="hljs-comment">        vè¡¨ç¤ºvoidè¿”å›å€¼ï¼›@è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™é‡ŒæŒ‡selfï¼›&quot;:&quot;è¡¨ç¤ºSELï¼Œå³_cmdã€‚</span><br><span class="hljs-comment">        å…¶ä»–ç¬¦å·çš„æ„ä¹‰å¯å‚è€ƒæ–‡ç« åº•éƒ¨é“¾æ¥</span><br><span class="hljs-comment">        */</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>&#125;<br><span class="hljs-comment">//ç±»æ–¹æ³•</span><br>+(<span class="hljs-type">BOOL</span>)resolveClassMethod:(SEL)sel<br>&#123;<br>    <span class="hljs-keyword">if</span> (sel == <span class="hljs-keyword">@selector</span>(classMethodSelector)) &#123;<br>        class_addMethod(objc_getMetaClass(<span class="hljs-string">&quot;DynamicTool&quot;</span>), sel,<br>        (IMP)classMethod, <span class="hljs-string">&quot;s#:@@&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">DynamicTool *insObj = [DynamicTool <span class="hljs-keyword">new</span>];<br><span class="hljs-type">Class</span> <span class="hljs-variable">classObj</span> <span class="hljs-operator">=</span> NSClassFromString(@<span class="hljs-string">&quot;DynamicTool&quot;</span>);<br><br>[insObj performSelector:<span class="hljs-meta">@selector(instanceMethodSelector)</span>];<br><br>[classObj performSelector:<span class="hljs-meta">@selector(classMethodSelector)</span> <br>withObject:@<span class="hljs-string">&quot;A&quot;</span> withObject:@<span class="hljs-string">&quot;B&quot;</span>];<br></code></pre></td></tr></table></figure><p>DynamicTool çš„å¤´æ–‡ä»¶å¹¶æœªå®šä¹‰å®ä¾‹æ–¹æ³•<code>instanceMethodSelector</code> å’Œç±»æ–¹æ³•<code>classMethodSelector</code>ã€‚å› æ­¤é€šè¿‡ performSelector è°ƒç”¨æ—¶ï¼Œruntimeä¼šæŒ‰ç…§ä¸Šä¸€å°ç»“æ‰€è¿°æµç¨‹ä»ç±»ä¸­æŸ¥æ‰¾è¯¥æ–¹æ³•ï¼Œå› ä¸ºæœªå®šä¹‰ï¼Œæ‰€ä»¥æŸ¥æ‰¾å¤±è´¥å¹¶èµ°åŠ¨æ€æ–¹æ³•å†³è®®æµç¨‹ï¼Œåˆ†åˆ«é€šè¿‡<code>resolveInstanceMethod</code>ä¸ <code>resolveClassMethod</code>æŸ¥æ‰¾å…·ä½“çš„æ–¹æ³•å®ç°ã€‚</p><h3 id="11-æ¶ˆæ¯è½¬å‘æœºåˆ¶"><a href="#11-æ¶ˆæ¯è½¬å‘æœºåˆ¶" class="headerlink" title="11.æ¶ˆæ¯è½¬å‘æœºåˆ¶"></a>11.æ¶ˆæ¯è½¬å‘æœºåˆ¶</h3><p>å¦‚æœæ²¡æœ‰å®ç°åŠ¨æ€æ–¹æ³•å†³è®®æœºåˆ¶ï¼Œæˆ–è€…åœ¨åŠ¨æ€æ–¹æ³•å†³è®®æ—¶å¹¶æœªä¸ºselectoræä¾›å®ç°ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿcrashã€‚ä¸ºé˜²æ­¢è¿™ç§å´©æºƒï¼ŒOCè¿˜æä¾›äº†æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œä»¥å°†æ¶ˆæ¯è½¬å‘ç»™å…¶ä»–å¯¹è±¡ã€‚<br><br/></p><p>å¦‚æœåŒæ—¶æä¾›äº†åŠ¨æ€æ–¹æ³•å†³è®®å’Œæ¶ˆæ¯è½¬å‘ï¼Œé‚£ä¹ˆåŠ¨æ€æ–¹æ³•å†³è®®å…ˆäºæ¶ˆæ¯è½¬å‘ï¼Œåªæœ‰å½“åŠ¨æ€æ–¹æ³•å†³è®®ä¾ç„¶æ— æ³•æ­£ç¡®å†³è®®selectorçš„å®ç°ï¼Œæ‰ä¼šå°è¯•è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚</p><ul><li>ç¬¬ä¸€æ¬¡è½¬å‘æœºä¼š</li></ul><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(id)</span>forwardingTargetForSelector:<span class="hljs-params">(SEL)</span>sel;<br></code></pre></td></tr></table></figure><blockquote><p>Returns the object to which unrecognized messages should first be directed.</p></blockquote><p>è¿”å›æœªè¯†åˆ«æ–¹æ³•çš„æ–°æ¥æ”¶è€…ã€‚</p><blockquote><p>If an object implements (or inherits) this method, and returns a non-nil (and non-self) result, that returned object is used as the new receiver object and the message dispatch resumes to that new object. (Obviously if you return self from this method, the code would just fall into an infinite loop.)</p></blockquote><p>å®ç°æ­¤æ–¹æ³•å¹¶è¿”å›éç©ºå’Œéselfå¯¹è±¡æ—¶ï¼Œæ­¤æ–°å¯¹è±¡ä¼šè¢«ä½œä¸ºåŸæ–¹æ³•çš„æ¥æ”¶è€…ï¼Œé‡æ–°å¼€å§‹æ–¹æ³•çš„æ´¾å‘æµç¨‹ã€‚å¦‚æœåœ¨æ–¹æ³•ä¸­è¿”å›äº†selfå¯¹è±¡ï¼Œåˆ™ä»£ç ä¼šé™·å…¥æ— é™å¾ªç¯ä¸­~</p><ul><li>ç¬¬äºŒæ¬¡è½¬å‘æœºä¼š</li></ul><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(NSMethodSignature *)</span>methodSignatureForSelector:<span class="hljs-params">(SEL)</span>selï¼›<br>- <span class="hljs-params">(void)</span>forwardInvocation:<span class="hljs-params">(NSInvocation *)</span>invo;<br></code></pre></td></tr></table></figure><blockquote><p>When an object is sent a message for which it has no corresponding method, the runtime system gives the receiver an opportunity to delegate the message to another receiver. It delegates the message by creating an NSInvocation object representing the message and sending the receiver a forwardInvocation: message containing this NSInvocation object as the argument. The receiverâ€™s forwardInvocation: method can then choose to forward the message to another object. (If that object canâ€™t respond to the message either, it too will be given a chance to forward it.)</p></blockquote><p>å¦‚æœæ¶ˆæ¯çš„æ¥æ”¶è€…ä¸èƒ½å“åº”æ¶ˆæ¯ï¼Œåˆ™è¿è¡Œæ—¶ä¼šå†ç»™æ¥æ”¶è€…ä¸€æ¬¡å°†æ¶ˆæ¯ä»£ç†ç»™å…¶ä»–å¯¹è±¡çš„æœºä¼šã€‚è¿è¡Œæ—¶ä¼šä¸ºæ¶ˆæ¯åˆ›å»ºä¸€ä¸ª<code>NSInvocation</code>å¯¹è±¡ï¼Œéšåè°ƒç”¨åŸæ¥æ”¶è€…çš„forwardInvocation:æ–¹æ³•ï¼Œå¹¶ä¼ å…¥æ­¤<code>NSInvocation</code>ä½œä¸ºå‚æ•°ã€‚forwardInvocation:ä¸­å°†æ­¤æ–¹æ³•è½¬å‘ç»™å…¶ä»–å¯¹è±¡ã€‚<br><br/></p><p>#ç¤ºä¾‹2ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//DynamicToolå®ç°æ–‡ä»¶å¦‚ä¸‹ï¼š</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;DynamicTool.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;objc/runtime.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ForwardTool.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">DynamicTool</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -åŠ¨æ€å†³è®®</span><br><span class="hljs-comment">//å®ä¾‹æ–¹æ³•</span><br>+ (<span class="hljs-type">BOOL</span>)resolveInstanceMethod:(SEL)sel<br>&#123;<br>    <span class="hljs-comment">// æ³¨æ„ï¼šä¸ºäº†å±•ç¤ºæ¶ˆæ¯è½¬å‘çš„å®ç°ï¼Œè¿™é‡Œæ²¡æœ‰ç»™SELæä¾›å…·ä½“çš„å®ç°</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>&#125;<br><span class="hljs-comment">//ç±»æ–¹æ³•</span><br>+(<span class="hljs-type">BOOL</span>)resolveClassMethod:(SEL)sel<br>&#123;<br>    <span class="hljs-comment">// æ³¨æ„ï¼šä¸ºäº†å±•ç¤ºæ¶ˆæ¯è½¬å‘çš„å®ç°ï¼Œè¿™é‡Œæ²¡æœ‰ç»™SELæä¾›å…·ä½“çš„å®ç°</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -æ¶ˆæ¯è½¬å‘</span><br>- (<span class="hljs-type">id</span>)forwardingTargetForSelector:(SEL)sel<br>&#123;<br>    <span class="hljs-comment">//if (sel == @selector(unknownSelector)) &#123;</span><br>    <span class="hljs-comment">//    return [ForwardTool new];</span><br>    <span class="hljs-comment">//&#125;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>&#125;<br><br>- (<span class="hljs-built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector<br>&#123;<br>    <span class="hljs-built_in">NSMethodSignature</span> *methodSignature = [<span class="hljs-variable language_">super</span> methodSignatureForSelector:aSelector];<br>    <span class="hljs-keyword">if</span> (!methodSignature) &#123;<br>        methodSignature = [<span class="hljs-built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="hljs-string">&quot;v@:*&quot;</span>];<br>    &#125;<br>    <span class="hljs-keyword">return</span> methodSignature;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)forwardInvocation:(<span class="hljs-built_in">NSInvocation</span> *)anInvocation<br>&#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ å°†æ¶ˆæ¯è½¬å‘ç»™å®ƒä»¬</span><br>    ForwardTool *forwardTool = [ForwardTool new];<br>    <span class="hljs-keyword">if</span> ([forwardTool respondsToSelector:<span class="hljs-keyword">@selector</span>(unknownSelector)]) &#123;<br>        <span class="hljs-comment">//è¿™é‡Œå¯ä»¥è½¬å‘ç»™å¤šä¸ªå¯¹è±¡ï¼Œæœ€ç»ˆçš„è¿”å›å€¼ä»¥æœ€åä¸€ä¸ªè°ƒç”¨çš„è¿”å›å€¼ä¸ºå‡†</span><br>        [anInvocation invokeWithTarget:forwardTool];<br>    &#125;<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p><code>ForwardTool</code>ç±»çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ForwardTool</span> : <span class="hljs-title">NSObject</span></span><br>- (<span class="hljs-type">void</span>)unknownSelector;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-comment">//ForwardToolå®ç°æ–‡ä»¶å¦‚ä¸‹ï¼š</span><br><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ForwardTool.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ForwardTool</span></span><br><br>- (<span class="hljs-type">void</span>)unknownSelector<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;æ¶ˆæ¯è½¬å‘&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">DynamicTool *insObj = [DynamicTool <span class="hljs-keyword">new</span>];<br><span class="hljs-type">Class</span> <span class="hljs-variable">classObj</span> <span class="hljs-operator">=</span> NSClassFromString(@<span class="hljs-string">&quot;DynamicTool&quot;</span>);<br>[insObj performSelector:<span class="hljs-meta">@selector(unknownSelector)</span>];<br></code></pre></td></tr></table></figure><h3 id="12-æ¶ˆæ¯è½¬å‘çš„è¿‡ç¨‹"><a href="#12-æ¶ˆæ¯è½¬å‘çš„è¿‡ç¨‹" class="headerlink" title="12.æ¶ˆæ¯è½¬å‘çš„è¿‡ç¨‹"></a>12.æ¶ˆæ¯è½¬å‘çš„è¿‡ç¨‹</h3><p>1ã€åŠ¨æ€æ–¹æ³•å†³è®®è¿›å…¥<code>resolveInstanceMethod</code>æ–¹æ³•æ—¶ï¼ŒæŒ‡å®šæ˜¯å¦åŠ¨æ€æ·»åŠ æ–¹æ³•ã€‚è‹¥æŒ‡å®šäº†å®ç°å‡½æ•°ï¼Œåˆ™é€šè¿‡<code>class_addMethod</code>å‡½æ•°åŠ¨æ€åœ°æ·»åŠ æ–¹æ³•ï¼Œå¹¶æ­£å¸¸æ‰§è¡Œä½œä¸ºæ›¿ä»£çš„Cå‡½æ•°ï¼Œå¦‚ä¸Šé¢ç¤ºä¾‹ä¸­çš„<code>dynamicResolution</code>æ–¹æ³•ï¼›å¦åˆ™ï¼Œè¿›å…¥ç¬¬2æ­¥ï¼›<br><br/></p><p>2ã€<code>resolveInstanceMethod</code>æ–¹æ³•ä¸­æœªæŒ‡å®šå®ç°å‡½æ•°æ—¶ï¼Œä¸è®ºè¿”å›YESæˆ–NOï¼Œéƒ½ä¼šè¿›å…¥æ¶ˆæ¯è½¬å‘æµç¨‹ï¼Œè°ƒç”¨<code>forwardingTargetForSelector</code>æ–¹æ³•ï¼Œè¿™æ˜¯runtimeç»™æˆ‘ä»¬çš„ç¬¬äºŒæ¬¡æœºä¼šï¼Œç”¨äºæŒ‡å®šå“ªä¸ªå¯¹è±¡å“åº”è¿™ä¸ªselectorã€‚è‹¥è¿”å›æŸä¸ªå¯¹è±¡ï¼Œåˆ™ä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•ï¼›è‹¥è¿”å›nilï¼Œè¿›å…¥ç¬¬3æ­¥;<br><br/></p><p>3ã€<code>forwardingTargetForSelector</code>è¿”å›nilæ—¶ï¼Œåˆ™è¦é€šè¿‡ <code>methodSignatureForSelector</code>æ¥æŒ‡å®šæ–¹æ³•ç­¾åã€‚è‹¥è¿”å›nilï¼Œè¡¨ç¤ºä¸å¤„ç†ï¼Œç¨‹åºä¼šcrashï¼›è‹¥è¿”å›æ–¹æ³•ç­¾åï¼Œåˆ™è¿›å…¥ç¬¬4æ­¥ã€‚<br><br/></p><p>4ã€<code>methodSignatureForSelector</code>è¿”å›æ–¹æ³•ç­¾åæ—¶ï¼Œä¼šè°ƒç”¨<code>forwardInvocation</code>æ–¹æ³•ã€‚åˆ°è¿™ä¸ªæ–¹æ³•ä¸­åå³ä½¿ä¸åšä»»ä½•å¤„ç†ç¨‹åºä¹Ÿä¸ä¼šå´©æºƒï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡<code>anInvocation</code>å†æ¬¡å°†æ¶ˆæ¯è½¬å‘ç»™æŸäº›å¯¹è±¡ï¼Œæˆ–è€…ä¿®æ”¹å®ç°æ–¹æ³•ï¼Œä¿®æ”¹å“åº”å¯¹è±¡ç­‰ã€‚</p><h3 id="13-NSInvocation"><a href="#13-NSInvocation" class="headerlink" title="13.NSInvocation"></a>13.NSInvocation</h3><p>OCä¸­ ç›´æ¥è°ƒç”¨ç±»çš„æ–¹æ³•æœ‰ä¸¤ç§é€”å¾„ï¼š</p><ul><li>é€šè¿‡ NSObject åˆ†ç±»ä¸­å®šä¹‰çš„ <code>-performSelector:withObject:withObject:</code> æ–¹æ³•ï¼›</li><li>é€šè¿‡ <code>NSInvocation</code>ï¼›</li></ul><p>ç¬¬ä¸€ç§é€‚åˆå¤„ç†å‚æ•°è¾ƒå°‘çš„æ–¹æ³•è°ƒç”¨ï¼›å½“æœ‰å¤šä¸ªå‚æ•°æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ã€‚<br><br/></p><p>#ç¤ºä¾‹3ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSMethodSignature</span> *signature = [<span class="hljs-built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="hljs-string">&quot;@@:@B&quot;</span>];<br>    <span class="hljs-built_in">NSInvocation</span> *invocation = [<span class="hljs-built_in">NSInvocation</span> invocationWithMethodSignature:signature];<br>    invocation.target = <span class="hljs-keyword">self</span>;<br>    invocation.selector = <span class="hljs-keyword">@selector</span>(onSendMessageWithParam1:param2:);<span class="hljs-comment">//æ–¹æ³•å¿…é¡»å’Œç­¾åä¸­çš„æ–¹æ³•ä¸€è‡´</span><br>    <br>    <span class="hljs-built_in">NSString</span>*str1 = <span class="hljs-string">@&quot;THIS IS A STR~&quot;</span>;<br>    <span class="hljs-type">BOOL</span> boolValue = <span class="hljs-literal">YES</span>;<br><br>    <span class="hljs-comment">//ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‚æ•°å¯¹è±¡çš„æŒ‡é’ˆï¼›</span><br>    <span class="hljs-comment">//ç¬¬äºŒä¸ªå‚æ•°ä¸ºå‚æ•°çš„ç´¢å¼•ï¼Œæ³¨æ„ä¸èƒ½ä»0å¼€å§‹ï¼Œå› ä¸º0å·²ç»è¢«selfå ç”¨ï¼Œ1å·²ç»è¢«_cmdå ç”¨</span><br>    [invocation setArgument:&amp;str1 atIndex:<span class="hljs-number">2</span>];<br>    [invocation setArgument:&amp;boolValue atIndex:<span class="hljs-number">3</span>];<br>    <br>    [invocation invoke];<span class="hljs-comment">//æ‰§è¡Œæ–¹æ³•</span><br>    <span class="hljs-type">id</span> retLoc = <span class="hljs-literal">nil</span>;<br>    [invocation getReturnValue:&amp;retLoc];<span class="hljs-comment">//è·å–è¿”å›å€¼</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-built_in">NSString</span> *)onSendMessageWithParam1:(<span class="hljs-built_in">NSString</span>*)str1 param2:(<span class="hljs-type">BOOL</span>)boolvalue<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++%@++++%d&quot;</span>,str1,boolvalue);<br>    <span class="hljs-keyword">return</span> str1;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjectiveC/Chapters/ocSelectors.html#//apple_ref/doc/uid/TP30001163-CH23-SW1">Â©Apple-Selectors</a></p><p>#<a href="https://blog.csdn.net/zhaochen_009/article/details/54602930">Â©WoodBear009-forwardInvocation</a></p><p>#<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW1">Â©Apple-Type Encodings</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runtime</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Runtimeï¼šå…ƒç±»</title>
    <link href="/2017/08/22/runtime_metaclass.html"/>
    <url>/2017/08/22/runtime_metaclass.html</url>
    
    <content type="html"><![CDATA[<h3 id="1-runtime"><a href="#1-runtime" class="headerlink" title="1.runtime"></a>1.runtime</h3><p><code>runtime</code>ï¼Œç›´è¯‘è¿‡æ¥æ˜¯è¿è¡Œæ—¶ï¼Œå®ƒæ˜¯ä¸€å¥—åº•å±‚çš„Cè¯­è¨€APIï¼ŒåŒ…å«å¾ˆå¤šå¼ºå¤§å®ç”¨çš„Cè¯­è¨€æ•°æ®ç±»å‹å’ŒCè¯­è¨€å‡½æ•°ã€‚æˆ‘ä»¬çš„OCä»£ç åœ¨è¿è¡Œé˜¶æ®µéƒ½æ˜¯åŸºäºruntimeç¯å¢ƒæ‰èƒ½æ­£å¸¸è¿è¡Œçš„ã€‚</p><h3 id="2-å¸¸ç”¨åœºæ™¯"><a href="#2-å¸¸ç”¨åœºæ™¯" class="headerlink" title="2.å¸¸ç”¨åœºæ™¯"></a>2.å¸¸ç”¨åœºæ™¯</h3><ul><li>å‘é€æ¶ˆæ¯ï¼›</li><li>è¯»å–æˆå‘˜å˜é‡ï¼›</li><li>åŠ¨æ€ä¸ºæŸä¸ªç±»å¢åŠ å±æ€§ï¼›</li><li>äº¤æ¢ç±»ä¸­çš„æ–¹æ³•ã€åŠ¨æ€ä¸ºæŸä¸ªç±»æ·»åŠ æ–¹æ³•ï¼›</li><li>åŠ¨æ€åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ä¸€ä¸ªç±»ï¼›</li></ul><h3 id="3-å¯¹è±¡"><a href="#3-å¯¹è±¡" class="headerlink" title="3.å¯¹è±¡"></a>3.å¯¹è±¡</h3><blockquote><p>OCä¸­ï¼Œå«æœ‰isaæŒ‡é’ˆä¸”è¯¥æŒ‡é’ˆå¯ä»¥æ­£ç¡®æŒ‡å‘ç±»çš„æ•°æ®ç»“æ„ï¼Œéƒ½å¯ä»¥è§†ä¸ºå¯¹è±¡ã€‚</p></blockquote><p>ä¸‹é¢æ˜¯<code>objc.h</code>ä¸­çš„ç›¸å…³å®šä¹‰:</p><pre><code class="hljs">#if !OBJC_TYPES_DEFINED/// An opaque type that represents an Objective-C class.typedef struct objc_class *Class;/// Represents an instance of a class.struct objc_object &#123;Class isa  OBJC_ISA_AVAILABILITY;&#125;;/// A pointer to an instance of a class.typedef struct objc_object *id;#endif</code></pre><p>ä»<code>objc_object</code>ç»“æ„ä½“çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼šå¯¹è±¡å®è´¨ä¸Šæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶ç»“æ„ä½“å†…å«æœ‰<code>isa</code>æŒ‡é’ˆï¼ŒæŒ‡å‘å…¶æ‰€å±çš„ç±»ã€‚</p><h3 id="4-ç±»"><a href="#4-ç±»" class="headerlink" title="4.ç±»"></a>4.ç±»</h3><p>ä¸‹é¢æ˜¯<code>runtime.h</code>ä¸­å¯¹<code>ç±»</code>çš„å®šä¹‰ï¼š</p><pre><code class="hljs">struct objc_class &#123;Class isa  OBJC_ISA_AVAILABILITY;       //æŒ‡é’ˆ#if !__OBJC2__Class super_class                       //çˆ¶ç±»;const char *name                        //ç±»å;long version                                             //ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œé»˜è®¤ä¸º0;long info                               //ä½æ ‡è¯†;long instance_size                      //ç±»çš„å®ä¾‹å˜é‡å¤§å°;struct objc_ivar_list *ivars            //ç±»çš„æˆå‘˜å˜é‡é“¾è¡¨;struct objc_method_list **methodLists   //æ–¹æ³•å®šä¹‰çš„é“¾è¡¨;struct objc_cache *cache                //æ–¹æ³•ç¼“å­˜;struct objc_protocol_list *protocols    //åè®®é“¾è¡¨;#endif&#125; OBJC2_UNAVAILABLE;</code></pre><p>ä»ç»“æ„ä½“çš„å®šä¹‰æ¥çœ‹ï¼Œç±»ä¹Ÿæ˜¯ä»¥<code>isa</code>å¼€å§‹å¹¶æŒ‡å‘ç±»çš„æ•°æ®ç»“æ„ã€‚OCä¸­ç±»ä¸å…ƒç±»åœ¨è¿è¡Œæ—¶éƒ½æ˜¯<code>objc_class</code>ç±»å‹ï¼Œæ‰€ä»¥ï¼Œ<strong>ç±»å’Œå…ƒç±»ä¹Ÿæ˜¯ä¸€ç§å¯¹è±¡</strong>ã€‚</p><h3 id="5-å…ƒç±»"><a href="#5-å…ƒç±»" class="headerlink" title="5.å…ƒç±»"></a>5.å…ƒç±»</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Objc"><span class="hljs-built_in">NSObject</span> *obj = [<span class="hljs-built_in">NSObject</span> alloc];<br></code></pre></td></tr></table></figure><h4 id="5-1-å®ä¾‹å¯¹è±¡"><a href="#5-1-å®ä¾‹å¯¹è±¡" class="headerlink" title="5.1.å®ä¾‹å¯¹è±¡"></a>5.1.å®ä¾‹å¯¹è±¡</h4><p>å®ä¾‹å¯¹è±¡ï¼Œinstance objectï¼Œæ˜¯æŒ‡ä»æŸä¸ªç±»å®ä¾‹åŒ–è€Œæ¥çš„å¯¹è±¡ï¼Œå¦‚ç¤ºä¾‹ä¸­çš„<code>obj</code>ã€‚</p><h4 id="5-2-ç±»å¯¹è±¡"><a href="#5-2-ç±»å¯¹è±¡" class="headerlink" title="5.2.ç±»å¯¹è±¡"></a>5.2.ç±»å¯¹è±¡</h4><p>ç±»å¯¹è±¡ï¼ŒClass objectï¼Œç±»ä½œä¸ºå¯¹è±¡æ—¶ï¼Œå°±ç§°ä¹‹ä¸ºç±»å¯¹è±¡ã€‚è°ƒç”¨ä¸€ä¸ª â€œç±»æ–¹æ³•â€ ï¼Œå¦‚ [NSObject alloc]ï¼Œå®è´¨ä¸Šæ˜¯å‘å®ƒçš„ç±»å¯¹è±¡(NSObject)å‘é€äº†ä¸€ä¸ªæ¶ˆæ¯ã€‚ç±»å¯¹è±¡æ˜¯ç”±ç¼–è¯‘å™¨åˆ›å»ºçš„ï¼Œä»»ä½•ç»§æ‰¿è‡ªNSObjectçš„ç±»ï¼Œå®ƒçš„å®ä¾‹å¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ªisaæŒ‡é’ˆï¼ŒæŒ‡å‘å®ƒçš„ç±»å¯¹è±¡ã€‚</p><h4 id="5-3-å…ƒç±»"><a href="#5-3-å…ƒç±»" class="headerlink" title="5.3.å…ƒç±»"></a>5.3.å…ƒç±»</h4><p>ä»ä¸€ä¸ªç±»å®ä¾‹åŒ–è€Œæ¥çš„å¯¹è±¡å«å®ä¾‹å¯¹è±¡ï¼›ç±»ä½œä¸ºå¯¹è±¡ï¼Œåˆæ˜¯å…ƒç±»ï¼ˆMetaclassï¼‰çš„å®ä¾‹ï¼Œ<strong>å…ƒç±»æ˜¯ç±»å¯¹è±¡æ‰€å±çš„ç±»</strong>ã€‚</p><p>æ³¨æ„åŒºåˆ†ç±»å¯¹è±¡å’Œå…ƒç±»ï¼šç±»å¯¹è±¡ä¸­ä¿å­˜çš„æ˜¯å…³äºå…¶å®ä¾‹å¯¹è±¡çš„ä¿¡æ¯(å˜é‡ï¼Œå®ä¾‹æ–¹æ³•ã€éµå®ˆçš„åè®®ç­‰)ï¼›å…ƒç±»ä¸­ä¿å­˜çš„æ˜¯å…³äºç±»çš„ä¿¡æ¯(ç±»æ–¹æ³•ï¼Œç±»çš„ç‰ˆæœ¬ï¼Œåå­—ç­‰)ï¼›</p><p>å€Ÿç”¨ç½‘ä¸Šçš„ä¸€å¼ å›¾ï¼Œæ¼”ç¤ºå…ƒç±»ä¸ç»§æ‰¿çš„å°é—­å¾ªç¯ï¼š</p><p><img src="https://davidlii.nos-eastchina1.126.net/pic_metaclass.png" alt="isaä¸superclass"></p><p>å›¾ä¸­å®çº¿æ˜¯ super_class æŒ‡é’ˆï¼Œè™šçº¿æ˜¯<code>isa</code>æŒ‡é’ˆã€‚</p><ul><li>å®ä¾‹å¯¹è±¡æ˜¯ç±»çš„å®ä¾‹ï¼›</li><li>ç±»ä½œä¸ºå¯¹è±¡åˆæ˜¯å…ƒç±»çš„å®ä¾‹;</li><li>å…ƒç±»ä½œä¸ºå¯¹è±¡æ˜¯æ ¹å…ƒç±»çš„å®ä¾‹ï¼›</li><li>æ ¹å…ƒç±»æ˜¯å…¶è‡ªèº«çš„å®ä¾‹ã€‚</li><li>æ ¹å…ƒç±»çš„superclassä¸ºæ ¹ç±»è‡ªå·±ï¼›</li><li>æ ¹ç±»çš„superclassä¸ºnilï¼›</li></ul><h3 id="6-isa"><a href="#6-isa" class="headerlink" title="6.isa"></a>6.isa</h3><p>isa ç­‰ä»·äº is kind ofï¼š</p><ul><li>å®ä¾‹å¯¹è±¡ isa æŒ‡å‘ç±»å¯¹è±¡;</li><li>ç±»å¯¹è±¡æŒ‡ isa å‘å…ƒç±»å¯¹è±¡;</li><li>å…ƒç±»å¯¹è±¡çš„ isa æŒ‡å‘æ ¹å…ƒç±»;</li></ul><h3 id="7-ç›¸å…³å‡½æ•°"><a href="#7-ç›¸å…³å‡½æ•°" class="headerlink" title="7.ç›¸å…³å‡½æ•°"></a>7.ç›¸å…³å‡½æ•°</h3><pre><code class="hljs">-class</code></pre><p>å¯¹äºå®ä¾‹å¯¹è±¡ï¼Œè¿”å›å…¶ isa æŒ‡é’ˆæŒ‡å‘çš„<code>ç±»</code>ï¼›å¯¹äºç±»å¯¹è±¡ï¼Œè¿”å›å…¶<code>æœ¬èº«</code>ã€‚</p><pre><code class="hljs">object_getClass(id obj)</code></pre><p>è¿”å›isaæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ã€‚å¯¹äºå®ä¾‹å¯¹è±¡ï¼Œè¿”å›å…¶ isa æŒ‡å‘çš„<code>ç±»</code>ï¼›å¯¹äºç±»å¯¹è±¡ï¼Œè¿”å›å…¶å¯¹åº”çš„<code>å…ƒç±»</code>ã€‚</p><pre><code class="hljs">objc_getMetaClass(const char *name)</code></pre><p>è¿”å›æ­¤ç±»å¯¹åº”çš„<code>å…ƒç±»</code>ã€‚</p><hr><p>ç›¸å…³å‚è€ƒï¼š</p><p>#<a href="https://developer.apple.com/documentation/objectivec/">Â©Objective-C Runtime</a></p>]]></content>
    
    
    <categories>
      
      <category>æŠ€æœ¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>runtime</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2017/07/24/hello-world.html"/>
    <url>/2017/07/24/hello-world.html</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;file name&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo s<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo g<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo d<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html">Deployment</a></p>]]></content>
    
    
    <categories>
      
      <category>å…¥é—¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FQA</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>

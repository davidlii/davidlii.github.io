

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Davidli">
  <meta name="keywords" content="Davidli">
  
    <meta name="description" content="1.Runloop Run loops are part of the fundamental infrastructure associated with threads.A run loop is an event processing loop that you use to schedule work and coordinate the receipt of incoming event">
<meta property="og:type" content="article">
<meta property="og:title" content="Runloop">
<meta property="og:url" content="https://davidlii.cn/2017/09/09/runloop.html">
<meta property="og:site_name" content="Davidli">
<meta property="og:description" content="1.Runloop Run loops are part of the fundamental infrastructure associated with threads.A run loop is an event processing loop that you use to schedule work and coordinate the receipt of incoming event">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://davidlii.nos-eastchina1.126.net/pic_runloop.jpg">
<meta property="og:image" content="https://davidlii.nos-eastchina1.126.net/pic_perform_afterDelay.png">
<meta property="article:published_time" content="2017-09-09T09:39:17.000Z">
<meta property="article:modified_time" content="2019-11-02T02:51:17.000Z">
<meta property="article:author" content="Davidli">
<meta property="article:tag" content="runloop">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://davidlii.nos-eastchina1.126.net/pic_runloop.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Runloop - Davidli</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"davidlii.cn","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>嵇风</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Runloop"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2017-09-09 17:39" pubdate>
          2017年9月9日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          35k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          290 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Runloop</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-Runloop"><a href="#1-Runloop" class="headerlink" title="1.Runloop"></a>1.Runloop</h2><blockquote>
<p>Run loops are part of the fundamental infrastructure associated with threads.A run loop is an event processing loop that you use to schedule work and coordinate the receipt of incoming events.The purpose of a run loop is to keep your thread busy when there is work to do and put your thread to sleep when there is none.</p>
</blockquote>
<p><code>Runloop</code>是处理事件的循环，与线程紧密相关。启动后所在线程相当于一直处在<code>do-while</code>循环中，从而避免没事做被系统自动回收；此时要销毁这个线程必须停止这个 Runloop。</p>
<h3 id="1-1-作用"><a href="#1-1-作用" class="headerlink" title="1.1.作用"></a>1.1.作用</h3><ol>
<li>保持程序的持续运行；</li>
<li>处理App中的各种事件(如触摸事件、定时器事件、Selector事件)；</li>
<li>使线程有任务时执行任务，无任务时休眠，以节省CPU资源，提高程序性能；</li>
</ol>
<h3 id="1-2-与线程的关系"><a href="#1-2-与线程的关系" class="headerlink" title="1.2.与线程的关系"></a>1.2.与线程的关系</h3><p>每个线程都有相关的 Runloop 对象，Cocoa与CF框架都提供了接口帮助管理线程的Runloop，无须我们显式的创建这些对象。</p>
<ul>
<li><strong>主线程</strong></li>
</ul>
<p>在程序启动的过程中，系统会自动在<code>主线程</code>上设置并启动了一个 Runloop。具体入口是在 main 文件中的如下代码中：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;AppDelegate.h&quot;</span></span><br><br><span class="hljs-type">int</span> main(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[]) &#123;<br>    <span class="hljs-keyword">@autoreleasepool</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">UIApplicationMain</span>(argc, argv, <span class="hljs-literal">nil</span>, <span class="hljs-built_in">NSStringFromClass</span>([AppDelegate <span class="hljs-keyword">class</span>]));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>函数<code>UIApplicationMain()</code>内部为主线程启动了一个runloop。应用能在无任何操作时休眠，监听到输入事件时立马响应，就是因为有这个runloop在一直监听和响应这些事件。</p>
<ul>
<li><strong>其他线程</strong></li>
</ul>
<p>除主线程外，其他线程的 runloop 默认都是没有开启的。这些线程在执行任务时是一条直线类型，从起点到终点，执行完任务后线程就会销毁掉。如果想让子线程保活并继续执行任务，则可自行配置并启动其runloop。</p>
<p>#示例1：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//自定义ASDFThread</span><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ASDFThread</span> : <span class="hljs-title">NSThread</span></span><br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ASDFThread</span></span><br><br>- (<span class="hljs-type">void</span>)dealloc&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++THREAD IS DEALLOCED~&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><br><span class="hljs-comment">//AppDelegate 在自定义线程中执行任务</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;ASDFThread.h&quot;</span></span><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    ASDFThread *th = [[ASDFThread alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(onHandleEvent) object:<span class="hljs-literal">nil</span>];<br>    [th start];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onHandleEvent&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++当前线程:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出日志：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">++++当前线程:&lt;ASDFThread: <span class="hljs-number">0x600003575e80</span>&gt;&#123;number = <span class="hljs-number">3</span>, <span class="hljs-type">name</span> = (<span class="hljs-keyword">null</span>)&#125;<br>++++THREAD <span class="hljs-keyword">IS</span> DEALLOCED~<br></code></pre></td></tr></table></figure>

<p>可以看到，自定义的 ASDFThread 线程对象在执行完任务之后，自动销毁了。</p>
<p>如果要线程执行完任务后，仍不销毁以便复用，则可以在当前线程中开启 Runloop：</p>
<p>#示例2：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)onHandleEvent&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++当前线程:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    <br>    <span class="hljs-comment">//开启runloop</span><br>    <span class="hljs-built_in">CFRunLoopSourceContext</span> context = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">CFRunLoopSourceRef</span> source = <span class="hljs-built_in">CFRunLoopSourceCreate</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;context);<br>    <span class="hljs-built_in">CFRunLoopAddSource</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>(), source, kCFRunLoopCommonModes);<br>    <span class="hljs-built_in">CFRunLoopRun</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>往子线程所在的RunLoop中加入一个<code>source</code>并启动此RunLoop，线程执行完任务后就不会自动销毁。</p>
<p>线程刚创建时并没有RunLoop对象，只在第一次获取时才会自动创建，并在线程结束时销毁。</p>
<h2 id="2-RunLoopMode"><a href="#2-RunLoopMode" class="headerlink" title="2.RunLoopMode"></a>2.RunLoopMode</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-keyword">struct</span> __CFRunLoopMode &#123;<br><span class="hljs-built_in">CFStringRef</span> _name;   <span class="hljs-comment">//Mode的名字</span><br><br><span class="hljs-built_in">CFMutableSetRef</span> _sources0;<br><span class="hljs-built_in">CFMutableSetRef</span> _sources1;<br><br><span class="hljs-built_in">CFMutableArrayRef</span> _observers;<span class="hljs-comment">//观察者</span><br><span class="hljs-built_in">CFMutableArrayRef</span> _timers;<span class="hljs-comment">//计时器</span><br>.....<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>运行循环模式，本质上是个结构体，其中包含了与之对应的<code>事件类型</code>、<code>观察者</code>和<code>计时器</code>等。</p>
<p>Runloop对象可以和若干个<code>mode</code>关联起来。但同一时间 Runloop 只能运行在一种模式下；</p>
<p>运行过程中，只有指定模式下的输入源才会被监听，也只有指定模式下的观察者才能收到当前Runloop进度的通知。</p>
<p>当需要切换mode时，须先退出当前的 RunLoop，再重新启动一个新的 RunLoop。</p>
<h3 id="2-1-具体模式"><a href="#2-1-具体模式" class="headerlink" title="2.1.具体模式"></a>2.1.具体模式</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">NSDefaultRunLoopMode</span><br></code></pre></td></tr></table></figure>

<p>系统默认模式，系统不做任何操作、空闲状态；</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">UITrackingRunLoopMode</span><br></code></pre></td></tr></table></figure>

<p>界面跟踪模式，用以在拖动界面时限制其他事件的进入，滑动时主线程的RunLoop会从<code>Default</code>模式切换到<code>Tracking</code>模式；</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">NSRunLoopCommonModes</span><br></code></pre></td></tr></table></figure>

<p>这是个可配置的模式集合而非一个真正的模式，默认包括了<code>Default</code>和<code>EventTracking</code>模式。将<code>输入源</code>与该模式关联，实质是将<code>输入源</code>与该组中的每个模式进行了关联。</p>
<h3 id="2-2-定时器失效"><a href="#2-2-定时器失效" class="headerlink" title="2.2.定时器失效"></a>2.2.定时器失效</h3><p>定时器默认使用<code>default</code>模式，而拖拽滚动 scrollview 时 Runloop 处于<code>Tracking</code>模式。由于 Runloop 一次只能运行在一种模式下，所以滚动过程中主线程Runloop无法处理注册在其<code>default</code>模式下的定时器事件，因此定时器也就不会触发。</p>
<p><strong>解决方案：</strong></p>
<h4 id="方案1-Mode"><a href="#方案1-Mode" class="headerlink" title="方案1: Mode"></a>方案1: Mode</h4><p>将定时器标记为<code>common</code>模式。</p>
<p>思路：定时器默认被加入到主线程Runloop的<code>default</code>模式中，被标记为<code>common</code>后会自动与<code>common</code>模式中的<code>Tracking</code>模式进行关联。滑动时主线程的Runloop处在<code>Tracking</code>模式，所以计时器事件也能正常响应了。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">NSTimer</span> *aTimer = [<span class="hljs-built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="hljs-number">1</span><br>                                                       target:<span class="hljs-keyword">self</span><br>                                                     selector:<span class="hljs-keyword">@selector</span>(repeat:)<br>                                                     userInfo:<span class="hljs-literal">nil</span><br>                                                      repeats:<span class="hljs-literal">true</span>];<br>[[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop] addTimer:aTimer forMode:<span class="hljs-built_in">NSRunLoopCommonModes</span>];<br></code></pre></td></tr></table></figure>

<h4 id="方案2-子线程"><a href="#方案2-子线程" class="headerlink" title="方案2: 子线程"></a>方案2: 子线程</h4><p>将定时器放入子线程中并开启此线程的RunLoop：</p>
<p>思路：滑动操作发生在主线程，定时器所在的线程是子线程，所以两者互不影响。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">dispatch_async</span>(<span class="hljs-title function_ invoke__">dispatch_get_global_queue</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;<br>        [NSTimer <span class="hljs-attr">scheduledTimerWithTimeInterval</span>:<span class="hljs-number">1</span><br>                                         <span class="hljs-attr">target</span>:<span class="hljs-built_in">self</span><br>                                       <span class="hljs-attr">selector</span>:@<span class="hljs-title function_ invoke__">selector</span>(<span class="hljs-attr">aSelector</span>:)<br>                                       <span class="hljs-attr">userInfo</span>:nil <span class="hljs-attr">repeats</span>:<span class="hljs-literal">true</span>];<br>        [[NSRunLoop currentRunLoop] run];<br>    &#125;);<br></code></pre></td></tr></table></figure>

<p>需要注意的是，子线程中使用定时器，一定要主动开启子线程的RunLoop，否则定时器不会触发。</p>
<h4 id="方案3-GCD-timer"><a href="#方案3-GCD-timer" class="headerlink" title="方案3: GCD timer"></a>方案3: GCD timer</h4><p>使用GCD提供的定时器API:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;GCDTimerTest.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">GCDTimerTest</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">dispatch_queue_t</span> seriaqueue;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) dispatch_source_t timer;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">GCDTimerTest</span></span><br><br>- (<span class="hljs-type">void</span>)gcd_timer&#123;<br>    _seriaqueue = dispatch_queue_create(<span class="hljs-string">&quot;xx&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    __<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) wself = <span class="hljs-keyword">self</span>;<br>    <span class="hljs-built_in">dispatch_async</span>(_seriaqueue, ^&#123;<br>        __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(wself) sself = wself;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop before timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        sself.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sself.seriaqueue);<br>        dispatch_source_set_timer(sself.timer, DISPATCH_TIME_NOW, <span class="hljs-number">1</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>, <span class="hljs-number">0</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>);<br>        dispatch_source_set_event_handler(sself.timer, ^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行计时任务&quot;</span>);<br>            <span class="hljs-comment">//dispatch_source_cancel(sself.timer);</span><br>        &#125;);<br>        dispatch_resume(sself.timer);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop after timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>    &#125;);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<p>GCD定时器不是RunLoop的源，不受Mode切换的影响，可参考<code>#3.2定时源-特殊定时器</code>章节的解析。</p>
<h2 id="3-事件来源"><a href="#3-事件来源" class="headerlink" title="3.事件来源"></a>3.事件来源</h2><p>Runloop中有了事件源才会有事做，才不会退出循环。事件源分两大类：<code>输入源</code>和<code>定时源</code>。</p>
<p><img src="https://davidlii.nos-eastchina1.126.net/pic_runloop.jpg" srcset="/img/loading.gif" lazyload alt="image"></p>
<h3 id="3-1-输入源"><a href="#3-1-输入源" class="headerlink" title="3.1.输入源"></a>3.1.输入源</h3><p>输入源事件分为<code>source0</code>和<code>source1</code>两种:</p>
<ul>
<li>source0：诸如UIEvent（触摸，滑动等），performSelector这种需要手动触发的事件。</li>
<li>source1：基于端口的事件，处理系统内核的mach_msg事件。诸如唤醒RunLoop或者让RunLoop进入休眠等。</li>
</ul>
<h4 id="1-基于端口的输入源"><a href="#1-基于端口的输入源" class="headerlink" title="1.基于端口的输入源"></a>1.基于端口的输入源</h4><p><code>Source1</code>类型，能主动唤醒线程的RunLoop。内核中进程间的通信通过在两个端口之间传递消息来实现，Source1 监听的正是这些端口。你也可以手动创建端口，以实现不同线程间的通信。</p>
<p>#示例：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)runloopPortTest<br>&#123;<br>    <span class="hljs-comment">//创建端口</span><br>    <span class="hljs-type">NSPort</span> <span class="hljs-operator">*</span><span class="hljs-type">PORT1</span> <span class="hljs-operator">=</span> [<span class="hljs-type">NSMachPort</span> new];<br>    <span class="hljs-type">NSPort</span> <span class="hljs-operator">*</span><span class="hljs-type">PORT2</span> <span class="hljs-operator">=</span> [<span class="hljs-type">NSMachPort</span> port];<br><br>    <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;<span class="hljs-subst">\n</span>PORT1:%@ <span class="hljs-subst">\n</span>PORT2:%@&quot;</span>,<span class="hljs-type">PORT1</span>, <span class="hljs-type">PORT2</span>);<br><br>    <span class="hljs-comment">//设置端口的代理</span><br>    <span class="hljs-type">PORT1</span>.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>;<br>    <span class="hljs-type">PORT2</span>.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>;<br><br>    <span class="hljs-comment">//给主线程runloop加一个端口</span><br>    [[<span class="hljs-type">NSRunLoop</span> currentRunLoop] addPort:<span class="hljs-type">PORT1</span> forMode:<span class="hljs-type">NSDefaultRunLoopMode</span>];<br><br>    <span class="hljs-comment">//给子线程添加端口并启动其runloop</span><br>    dispatch_async(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-operator">^</span>&#123;<br>        [[<span class="hljs-type">NSRunLoop</span> currentRunLoop] addPort:<span class="hljs-type">PORT2</span> forMode:<span class="hljs-type">NSDefaultRunLoopMode</span>];<br>        [[<span class="hljs-type">NSRunLoop</span> currentRunLoop] runMode:<span class="hljs-type">NSDefaultRunLoopMode</span> beforeDate:[<span class="hljs-type">NSDate</span> distantFuture]];<br>    &#125;);<br><br>    <span class="hljs-comment">//component参数数组中只能包含两种类型的数据：一种是NSPort的子类，一种是NSData的子类；</span><br>    <span class="hljs-type">NSString</span> <span class="hljs-operator">*</span><span class="hljs-type">STR</span> <span class="hljs-operator">=</span> @<span class="hljs-string">&quot;III&quot;</span>;<br>    <span class="hljs-type">NSData</span>   <span class="hljs-operator">*</span>data <span class="hljs-operator">=</span> [<span class="hljs-type">STR</span> dataUsingEncoding:<span class="hljs-type">NSUTF8StringEncoding</span>];<br>    <span class="hljs-type">NSMutableArray</span> <span class="hljs-operator">*</span>array <span class="hljs-operator">=</span> [<span class="hljs-type">NSMutableArray</span> arrayWithArray:@[<span class="hljs-type">PORT1</span>,data]];<br><br>    <span class="hljs-comment">//2秒后向PORT2发送消息</span><br>    dispatch_after(dispatch_time(<span class="hljs-type">DISPATCH_TIME_NOW</span>, (int64_t)(<span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-type">NSEC_PER_SEC</span>)), <br>                                    dispatch_get_main_queue(), <span class="hljs-operator">^</span>&#123;<br>        [<span class="hljs-type">PORT2</span> sendBeforeDate:[<span class="hljs-type">NSDate</span> date] msgid:<span class="hljs-number">101</span> components:array from:<span class="hljs-type">PORT1</span> reserved:<span class="hljs-number">0</span>];<br>    &#125;);<br>&#125;<br><br>#pragma mark <span class="hljs-operator">-</span><span class="hljs-type">NSPortDelegate</span><br><span class="hljs-operator">-</span> (void)handlePortMessage:(<span class="hljs-type">NSMessagePort</span><span class="hljs-operator">*</span>)message&#123;<br>    <span class="hljs-comment">//1. 消息id</span><br>    <span class="hljs-type">NSUInteger</span> msgId <span class="hljs-operator">=</span> [[message valueForKeyPath:@<span class="hljs-string">&quot;msgid&quot;</span>] integerValue];<br>    <span class="hljs-comment">//2. 当前主线程的port</span><br>    <span class="hljs-type">NSPort</span> <span class="hljs-operator">*</span>localPort <span class="hljs-operator">=</span> [message valueForKeyPath:@<span class="hljs-string">&quot;localPort&quot;</span>];<br>    <span class="hljs-comment">//3. 接收到消息的port（来自其他线程）</span><br>    <span class="hljs-type">NSPort</span> <span class="hljs-operator">*</span>remotePort <span class="hljs-operator">=</span> [message valueForKeyPath:@<span class="hljs-string">&quot;remotePort&quot;</span>];<br><br>    <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;<span class="hljs-subst">\n</span>执行端口代理回调：<span class="hljs-subst">\n</span>端口ID = %lu <span class="hljs-subst">\n</span>localPort:%@ </span><br><span class="hljs-string">    <span class="hljs-subst">\n</span>remotePort:%@&quot;</span>,(unsigned long)msgId, localPort, remotePort);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">101</span> <span class="hljs-operator">==</span> msgId)&#123;<br>        <span class="hljs-comment">//向子线的port发送消息</span><br>        [remotePort sendBeforeDate:[<span class="hljs-type">NSDate</span> date] msgid:<span class="hljs-number">102</span> components:<span class="hljs-literal">nil</span> from:localPort reserved:<span class="hljs-number">0</span>];<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-number">102</span> <span class="hljs-operator">==</span> msgId)&#123;<br>    <span class="hljs-comment">//....</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出日志：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">19</span>:<span class="hljs-number">30:24.335</span><br>PORT1:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000549d70</span>&gt;<br>PORT2:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000340370</span>&gt;<br><span class="hljs-number">19</span>:<span class="hljs-number">30:26.337</span><br>执行端口代理回调：<br>端口ID = <span class="hljs-number">101</span><br>localPort:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000340370</span>&gt;<br>remotePort:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000549d70</span>&gt;<br><span class="hljs-number">19</span>:<span class="hljs-number">30:26.337</span><br>执行端口代理回调：<br>端口ID = <span class="hljs-number">102</span><br>localPort:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000549d70</span>&gt;<br>remotePort:&lt;NSMachPort: <span class="hljs-number">0</span>x6<span class="hljs-number">00000340370</span>&gt;<br></code></pre></td></tr></table></figure>

<p>示例中两个线程间互相发送了一条消息。</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(BOOL)</span>sendBeforeDate:<span class="hljs-params">(NSDate *)</span>limitDate<br>                 msgid:<span class="hljs-params">(NSUInteger)</span>msgID<br>            components:<span class="hljs-params">(NSMutableArray *)</span>components<br>                  from:<span class="hljs-params">(NSPort *)</span>receivePort<br>              reserved:<span class="hljs-params">(NSUInteger)</span>headerSpaceReserved;<br></code></pre></td></tr></table></figure>

<p>上面方法中，参数components数组中只能传NSPort、NSData类型的数据，所以除了NSPort对象外，其他数据需要先转成NSData类型。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@protocol</span> NSPortDelegate &lt;NSObject&gt;<br><span class="hljs-variable">@optional</span><br><br>- (void)<span class="hljs-attribute">handlePortMessage</span>:(NSPortMessage *)message;<br><span class="hljs-comment">// This is the delegate method that subclasses should send</span><br><span class="hljs-comment">// to their delegates, unless the subclass has something</span><br><span class="hljs-comment">// more specific that it wants to try to send first</span><br><span class="hljs-variable">@end</span><br></code></pre></td></tr></table></figure>

<p>消息回调之后，通过上面的代理接收，其中的 NSMessagePort 类型只能用 <code>KVC</code> 的方式取值。</p>
<h4 id="2-自定义的输入源"><a href="#2-自定义的输入源" class="headerlink" title="2.自定义的输入源"></a>2.自定义的输入源</h4><p><code>Source0</code>类型，它并不能主动触发事件。使用时要先调用<code>CFRunLoopSourceSignal()</code>，将此 Source 标记为待处理。然后看当前Runloop是否在休眠中，如果是则手动调用<code>CFRunLoopWakeUp()</code>来唤醒RunLoop，让其处理这个事件。</p>
<p>#示例：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void source<span class="hljs-constructor">Performor(<span class="hljs-params">void</span><span class="hljs-operator">*</span> <span class="hljs-params">info</span>)</span><br>&#123;<br>    <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;处理自定义输入源事件&quot;</span>)</span>;<br>&#125;<br><br>- (void)customInputsource<br>&#123;<br>    dispatch<span class="hljs-constructor">_async(<span class="hljs-params">dispatch_get_global_queue</span>(0, 0)</span>, ^&#123;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;开启线程.......&quot;</span>)</span>;<br>        _mRunLoopRef = <span class="hljs-constructor">CFRunLoopGetCurrent()</span>;<br>        <br>        <span class="hljs-comment">//创建CFRunLoopSourceContext对象</span><br>        CFRunLoopSourceContext mContext;<br>        bzero(&amp;mContext, sizeof(mContext));<br>        <br>        <span class="hljs-comment">//给context对象绑定一个函数</span><br>        mContext.perform = sourcePerformor;<br>        mContext.info = <span class="hljs-string">&quot;information&quot;</span>;<br>        <br>        <span class="hljs-comment">//创建CFRunLoopSourceRef对象</span><br>        _mSourceRef = <span class="hljs-constructor">CFRunLoopSourceCreate(NULL, 0, &amp;<span class="hljs-params">mContext</span>)</span>;<br>        <br>        <span class="hljs-comment">//将source添加到当前RunLoop中</span><br>        <span class="hljs-constructor">CFRunLoopAddSource(<span class="hljs-params">_mRunLoopRef</span>, <span class="hljs-params">_mSourceRef</span>, <span class="hljs-params">kCFRunLoopDefaultMode</span>)</span>;<br>        <br>        <span class="hljs-comment">//开启Runloop</span><br>        <span class="hljs-constructor">CFRunLoopRunInMode(<span class="hljs-params">kCFRunLoopDefaultMode</span>, 10000, YES)</span>;<br>        <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;线程结束.......&quot;</span>)</span>;<br>    &#125;);<br>    <br>    <span class="hljs-comment">//2秒后执行</span><br>    dispatch<span class="hljs-constructor">_after(<span class="hljs-params">dispatch_time</span>(DISPATCH_TIME_NOW, (<span class="hljs-params">int64_t</span>)</span>(<span class="hljs-number">2</span><span class="hljs-operator"> * </span>NSEC_PER_SEC)),<br>                   dispatch<span class="hljs-constructor">_get_main_queue()</span>, ^&#123;<br>        <br>        <span class="hljs-keyword">if</span> (<span class="hljs-constructor">CFRunLoopIsWaiting(<span class="hljs-params">_mRunLoopRef</span>)</span>) &#123;<br>            <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;RunLoop正在等待事件输入+++&quot;</span>)</span>;<br>            <span class="hljs-comment">//添加输入事件</span><br>            <span class="hljs-constructor">CFRunLoopSourceSignal(<span class="hljs-params">_mSourceRef</span>)</span>; <br>            <span class="hljs-comment">//唤醒线程，线程唤醒后发现由事件需要处理，于是立即处理事件</span><br>            <span class="hljs-constructor">CFRunLoopWakeUp(<span class="hljs-params">_mRunLoopRef</span>)</span>; <span class="hljs-comment">// 在主线程中唤醒其他子线程的runloop。</span><br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-constructor">NSLog(@<span class="hljs-string">&quot;RunLoop正在处理事件+++&quot;</span>)</span>;<br>            <span class="hljs-comment">//添加输入事件，当前正在处理一个事件，当前事件处理完成后，立即处理当前新输入的事件</span><br>            <span class="hljs-constructor">CFRunLoopSourceSignal(<span class="hljs-params">_mSourceRef</span>)</span>;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>执行后，输出日志：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00</span>:<span class="hljs-number">32</span>:<span class="hljs-number">21</span>.<span class="hljs-number">497879</span>+<span class="hljs-number">0800</span>  开启线程.......<br><span class="hljs-attribute">00</span>:<span class="hljs-number">32</span>:<span class="hljs-number">24</span>.<span class="hljs-number">663180</span>+<span class="hljs-number">0800</span>  RunLoop正在等待事件输入+++<br><span class="hljs-attribute">00</span>:<span class="hljs-number">32</span>:<span class="hljs-number">24</span>.<span class="hljs-number">663498</span>+<span class="hljs-number">0800</span>  处理自定义输入源事件<br><span class="hljs-attribute">00</span>:<span class="hljs-number">32</span>:<span class="hljs-number">24</span>.<span class="hljs-number">663881</span>+<span class="hljs-number">0800</span>  线程结束.......<br></code></pre></td></tr></table></figure>

<h4 id="3-Perform-Selector"><a href="#3-Perform-Selector" class="headerlink" title="3.Perform Selector"></a>3.Perform Selector</h4><p><code>Source0</code>类型，是 Cocoa 提供的一种自定义的源，允许你在任何线程上执行一个selector。下面列举了<code>NSObject</code>分类中定义的三种<code>performSelector</code>方法：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs erlang">@interface NSObject (NSThreadPerformAdditions)<br><br>- <span class="hljs-params">(void)</span>performSelectorOnMainThread:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>arg <br>waitUntilDone:<span class="hljs-params">(BOOL)</span>wait <br>modes:<span class="hljs-params">(NSArray&lt;NSString *&gt; *)</span>array;<br><br>- <span class="hljs-params">(void)</span>performSelectorOnMainThread:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>arg <br>waitUntilDone:<span class="hljs-params">(BOOL)</span>wait;<br>// equivalent to the first method with kCFRunLoopCommonModes<br><br>- <span class="hljs-params">(void)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector <br>onThread:<span class="hljs-params">(NSThread *)</span>thr <br>withObject:<span class="hljs-params">(id)</span>arg <br>waitUntilDone:<span class="hljs-params">(BOOL)</span>wait <br>modes:<span class="hljs-params">(NSArray&lt;NSString *&gt; *)</span>array;<br><br>- <span class="hljs-params">(void)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector <br>onThread:<span class="hljs-params">(NSThread *)</span>thr <br>withObject:<span class="hljs-params">(id)</span>arg <br>waitUntilDone:<span class="hljs-params">(BOOL)</span>wait;<br>// equivalent to the first method with kCFRunLoopCommonModes<br><br>- <span class="hljs-params">(void)</span>performSelectorInBackground:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>arg;<br><br>@end<br></code></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>OnMainThread</code> 是在主线程上执行任务；</li>
<li><code>onThread</code> 是在你指定的线程中执行任务，可以是主线程也可以是子线程；</li>
<li><code>InBackground</code> 则是在由系统自动分配的一个子线程中执行任务；</li>
<li><code>withObject</code> 是 selector 方法的参数；</li>
<li><code>waitUntilDone</code> 表示 <code>performSelector</code> 所处的线程是否等 <code>selector</code> 中的任务执行完再继续执行下一行；</li>
</ul>
<p>#示例：</p>
<ul>
<li>自定义的子线程工具类</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ASDFThreadHelper</span> : <span class="hljs-title">NSObject</span></span><br><br>-(<span class="hljs-built_in">NSThread</span> *)getThread;<br>- (<span class="hljs-type">void</span>)finish;<br>-(<span class="hljs-keyword">instancetype</span>)initWithName:(<span class="hljs-built_in">NSString</span>*)name;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ASDFThreadHelper</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSThread</span> *thread;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ASDFThreadHelper</span></span><br><br>-(<span class="hljs-keyword">instancetype</span>)initWithName:(<span class="hljs-built_in">NSString</span>*)name&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) &#123;<br>        _thread = [[<span class="hljs-built_in">NSThread</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(onThreadInit:) object:<span class="hljs-literal">nil</span>];<br>        _thread.name = name;<br>        [_thread start];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>-(<span class="hljs-built_in">NSThread</span> *)getThread&#123;<br>    <span class="hljs-keyword">return</span> _thread;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onThreadInit:(<span class="hljs-type">id</span>)obj&#123;<br>    <span class="hljs-comment">//因为是子线程，所以需要启动其runloop，不然子线程启动后就立刻退出，performselector时会崩溃</span><br>    <span class="hljs-built_in">CFRunLoopRun</span>();<br>&#125;<br><br>- (<span class="hljs-type">void</span>)start&#123;<br>    [_thread start];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)finish&#123;<br>    <span class="hljs-built_in">CFRunLoopStop</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>());<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<ul>
<li>调用performSelector</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">AppDelegate</span>()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) ASDFThreadHelper *threadHelper;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">AppDelegate</span></span><br><br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++before:%ld&quot;</span>,(<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(<span class="hljs-keyword">self</span>)));<br>    _threadHelper = [[ASDFThreadHelper alloc] initWithName:<span class="hljs-string">@&quot;asdf&quot;</span>];<br>    <br>    [<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(onSelector:)<br>                 onThread:[_threadHelper getThread]<br>               withObject:<span class="hljs-literal">nil</span> waitUntilDone:<span class="hljs-literal">YES</span>];<br>    <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++after:%ld&quot;</span>,(<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(<span class="hljs-keyword">self</span>)));<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>-(<span class="hljs-type">void</span>)onSelector:(<span class="hljs-type">id</span>)obj&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++excute:%ld,thread:%@,&quot;</span>,<br>          (<span class="hljs-type">long</span>)<span class="hljs-built_in">CFGetRetainCount</span>((__bridge <span class="hljs-built_in">CFTypeRef</span>)(<span class="hljs-keyword">self</span>)),[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    [_threadHelper finish];<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>输出日志</li>
</ul>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">+++<span class="hljs-keyword">before</span>:<span class="hljs-number">1</span><br>+++excute:<span class="hljs-number">2</span>,thread:&lt;NSThread: <span class="hljs-number">0x600001850c40</span>&gt;&#123;<span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>, <span class="hljs-built_in">name</span> = asdf&#125;,<br>+++<span class="hljs-keyword">after</span>:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>从日志来看：</p>
<ul>
<li>selector 会在我们指定的子线程中执行任务；</li>
<li>如果 <code>waitUntilDone=YES</code>，执行到 [self perform..onThread..] 时，主线程会等待 selector 执行完之后才继续执行下一行；</li>
<li>给 selector 指定的线程一定要有效，不能是已经退出的，所以我们需要在工具类中将子线程中的 runloop 启动起来；</li>
</ul>
<h3 id="3-2-定时源"><a href="#3-2-定时源" class="headerlink" title="3.2.定时源"></a>3.2.定时源</h3><p>定时器的作用是：在预设的时间点或重复的时间间隔，触发某个操作。</p>
<h4 id="1-CFRunLoopTimer"><a href="#1-CFRunLoopTimer" class="headerlink" title="1.CFRunLoopTimer"></a>1.CFRunLoopTimer</h4><p>这是<code>Core Foundation</code>框架中的使用的定时器，使用方式如下面的示例：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-type">void</span> onScheduleTimer()&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++++&quot;</span>);<br>&#125;<br>- (<span class="hljs-type">void</span>)runloop_timer&#123;<br>    <span class="hljs-built_in">CFRunLoopRef</span> runLoop = <span class="hljs-built_in">CFRunLoopGetCurrent</span>();<br>    <span class="hljs-built_in">CFRunLoopTimerContext</span> context = &#123;<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>&#125;;<br><br>    <span class="hljs-built_in">CFRunLoopTimerRef</span> aTimerRef = <span class="hljs-built_in">CFRunLoopTimerCreate</span>(<br>    kCFAllocatorDefault,<br>    <span class="hljs-number">1</span>, <span class="hljs-comment">//fireDate</span><br>    <span class="hljs-number">1</span>, <span class="hljs-comment">//interval</span><br>    <span class="hljs-number">0</span>, <span class="hljs-comment">//flags</span><br>    <span class="hljs-number">0</span>,<br>    &amp;onScheduleTimer, <span class="hljs-comment">//CFRunLoopTimerCallBack 回调函数</span><br>    &amp;context);<br>    <span class="hljs-built_in">CFRunLoopAddTimer</span>(runLoop, aTimerRef, kCFRunLoopCommonModes);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-NSTimer"><a href="#2-NSTimer" class="headerlink" title="2.NSTimer"></a>2.NSTimer</h4><p>这是Cocoa框架中经常使用都的的定时器，其创建方式有以下几种：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-built_in">NSTimer</span> *)timerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti <br>target:(<span class="hljs-type">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="hljs-type">id</span>)userInfo repeats:(<span class="hljs-type">BOOL</span>)yesOrNo;<br><br>+ (<span class="hljs-built_in">NSTimer</span> *)timerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)interval <br>repeats:(<span class="hljs-type">BOOL</span>)repeats block:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSTimer</span> *timer))block;<br><br>+ (<span class="hljs-built_in">NSTimer</span> *)timerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti <br>invocation:(<span class="hljs-built_in">NSInvocation</span> *)invocation repeats:(<span class="hljs-type">BOOL</span>)yesOrNo;<br><br>- (<span class="hljs-keyword">instancetype</span>)initWithFireDate:(<span class="hljs-built_in">NSDate</span> *)date <br>interval:(<span class="hljs-built_in">NSTimeInterval</span>)interval repeats:(<span class="hljs-type">BOOL</span>)repeats block:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSTimer</span> *timer))block;<br><br>- (<span class="hljs-keyword">instancetype</span>)initWithFireDate:(<span class="hljs-built_in">NSDate</span> *)date <br>interval:(<span class="hljs-built_in">NSTimeInterval</span>)ti target:(<span class="hljs-type">id</span>)t selector:(SEL)s userInfo:(<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>)ui repeats:(<span class="hljs-type">BOOL</span>)rep;<br></code></pre></td></tr></table></figure>

<p>这五种方式创建的<code>NSTimer</code>需通过”[[NSRunLoop currentRunLoop] addTimer:forMode:]”手动加入到 Runloop 中并指定模式才能正常开始。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">+ (<span class="hljs-built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti<br>target:(<span class="hljs-type">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="hljs-type">id</span>)userInfo repeats:(<span class="hljs-type">BOOL</span>)yesOrNo;<br><br>+ (<span class="hljs-built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)interval<br>repeats:(<span class="hljs-type">BOOL</span>)repeats <br>block:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSTimer</span> *timer))block;<br><br>+ (<span class="hljs-built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in">NSTimeInterval</span>)ti <br>invocation:(<span class="hljs-built_in">NSInvocation</span> *)invocation <br>repeats:(<span class="hljs-type">BOOL</span>)yesOrNo;<br></code></pre></td></tr></table></figure>

<p>以上三种方式会自动创建一个<code>NSTimer</code>对象并以<code>DefaultMode</code>加入到 Runloop 中。</p>
<p>NSTimer从本质上来说，就是一个<code>CFRunLoopTimerRef</code>。</p>
<p>#示例：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)viewDidLoad &#123;<br>    _seriaqueue = dispatch_queue_create(<span class="hljs-string">&quot;disafsdfa&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    [<span class="hljs-keyword">self</span> nstimer];<br>&#125;<br>- (<span class="hljs-type">void</span>)nstimer&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(_seriaqueue, ^&#123;<br>        <span class="hljs-comment">//开始定时器之前</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop before timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        [<span class="hljs-built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="hljs-number">2</span> repeats:<span class="hljs-literal">NO</span> block:^(<span class="hljs-built_in">NSTimer</span> * _Nonnull timer) &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行定时任务&quot;</span>);<br>            <span class="hljs-built_in">CFRunLoopStop</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>());<br>        &#125;];<br>        <span class="hljs-comment">// 开始定时器之后</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop after timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        <span class="hljs-built_in">CFRunLoopRun</span>();<br>        <span class="hljs-comment">// 定时任务完成</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop exit:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>日志(有删减，保留了主要内容)：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-comment">//开始定时器之前</span><br>+++runloop before timer:&lt;CFRunLoop <span class="hljs-number">0x600002f88500</span>&gt;&#123;<br>modes = &lt;CFBasicHash <span class="hljs-number">0x600001ddc7b0</span> [<span class="hljs-number">0x10388eb48</span>]&gt;&#123;type = mutable <span class="hljs-keyword">set</span>, count <span class="hljs-comment">= 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x600002888f70&gt;&#123;name = kCFRunLoopDefaultMode</span><br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    timers <span class="hljs-comment">= (null)</span> // 注意这里此时为空<br>&#125;<br><span class="hljs-comment">// 开始定时器之后</span><br>+++runloop <span class="hljs-comment">after timer:&lt;CFRunLoop 0x600002f88500&gt;&#123;</span><br>modes <span class="hljs-comment">= &lt;CFBasicHash 0x600001ddc7b0 [0x10388eb48]&gt;&#123;type = mutable set, count = 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x600002888f70&gt;&#123;name = kCFRunLoopDefaultMode,</span><br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    timers <span class="hljs-comment">= &lt;CFArray 0x600003784ae0&gt;&#123;</span> //此时数组中有了<span class="hljs-comment">CFRunLoopTimer</span>对象<br>    type <span class="hljs-comment">= mutable-small,</span> <br>    count <span class="hljs-comment">= 1,</span> <br>    values <span class="hljs-comment">= (</span><br>    0 : &lt;CFRunLoopTimer <span class="hljs-comment">0x60000268f000&gt;&#123;valid = Yes, firing = No, interval = 0, tolerance = 0,</span> <br>    next <span class="hljs-comment">fire date = 594361769 (1.99719393 @ 11234440222906),</span> <br>    callout <span class="hljs-comment">= (NSTimer) [_NSTimerBlockTarget fire:]</span><br>)&#125;<br>++++执行定时任务<br><br><span class="hljs-comment">// 定时任务完成</span><br>+++runloop <span class="hljs-comment">exit:&lt;CFRunLoop 0x600002f88500&gt;&#123;</span><br>modes <span class="hljs-comment">= &lt;CFBasicHash 0x600001ddc7b0&gt;&#123;type = mutable set, count = 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x600002888f70&gt;&#123;name = kCFRunLoopDefaultMode,</span><br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    <span class="hljs-comment">// 此时任务已完成，runloop退出，数组中values又为空了</span><br>    timers <span class="hljs-comment">= &lt;CFArray 0x600003784ae0 [0x10388eb48]&gt;&#123;type = mutable-small, count = 0, values = ()&#125;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>只看日志中“timers &#x3D;”部分，定时器开始后，其所在的runloop中多出了一个<code>CFRunLoopTimer</code>对象。就是说<code>NSTimer</code>的底层是由<code>CFRunLoopTimer</code>来实现的。</p>
<h5 id="2-1-内存泄露"><a href="#2-1-内存泄露" class="headerlink" title="2.1.内存泄露"></a>2.1.内存泄露</h5><p>在一个界面中启动了<code>NSTimer</code>，离开界面前如果<code>NSTimer</code>还没执行完，那么这个界面就无法释放，即使把这个<code>NSTimer</code>对象置为nil。这是因为<code>NSTimer</code>对象会<code>强引用</code>它的 target，Runloop 中还持有这个对象。所以记得把<code>NSTimer</code>置为<code>invalidate</code>。</p>
<h5 id="2-2-实时性"><a href="#2-2-实时性" class="headerlink" title="2.2.实时性"></a>2.2.实时性</h5><p>定时器可以产生基于时间的通知，但它并不是一种real-time的机制。</p>
<ol>
<li>如果子线程的 Runloop 根本没有运行，那么定时器也不会触发；</li>
<li>定时器也和 Runloop 的 mode 相关。如果定时器所在的模式当前未被 Runloop 监视，那么定时器将不会触发；</li>
<li>重复类型的定时器，添加到 RunLoop 后，RunLoop 会为其重复的时间点注册好事件。比如t，t + 5，t + 10。。如果某个时间点被错过了，例如执行了一个很长的任务，则那个时间点的回调也会跳过去，不会延后执行。</li>
</ol>
<p>#示例：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;Timer-Runloop.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">Timer_Runloop</span></span><br><br>- (<span class="hljs-type">void</span>)scheduleTimer<br>&#123;<br>    <span class="hljs-comment">//创建timer 间隔1秒</span><br>    [<span class="hljs-built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="hljs-number">1</span><br>                                     target:<span class="hljs-keyword">self</span><br>                                   selector:<span class="hljs-keyword">@selector</span>(onScheduleTimer)<br>                                   userInfo:<span class="hljs-literal">nil</span> repeats:<span class="hljs-literal">YES</span>];<br>    <span class="hljs-comment">//在第3秒的时 模拟一个复杂运算</span><br>    [<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(onMassTasks) withObject:<span class="hljs-literal">nil</span> afterDelay:<span class="hljs-number">3</span>];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onScheduleTimer<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++1秒重复定时执行++++&quot;</span>);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onMassTasks<br>&#123;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++开始处理复杂运算+++&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">0xffffffff</span>; i++)&#123;<br>    &#125;<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++++复杂运算完成++++++&quot;</span>);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<p>调用之后输入日志：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">10</span>.<span class="hljs-number">952360</span> ++++<span class="hljs-number">1</span>秒重复定时执行++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">11</span>.<span class="hljs-number">952263</span> ++++<span class="hljs-number">1</span>秒重复定时执行++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">12</span>.<span class="hljs-number">952284</span> ++++<span class="hljs-number">1</span>秒重复定时执行++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">12</span>.<span class="hljs-number">952628</span> +++开始处理复杂运算+++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">24</span>.<span class="hljs-number">104517</span> ++++++复杂运算完成++++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">24</span>.<span class="hljs-number">104825</span> ++++<span class="hljs-number">1</span>秒重复定时执行++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">24</span>.<span class="hljs-number">952362</span> ++++<span class="hljs-number">1</span>秒重复定时执行++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">25</span>.<span class="hljs-number">951624</span> ++++<span class="hljs-number">1</span>秒重复定时执行++++<br><span class="hljs-attribute">20</span>:<span class="hljs-number">30</span>:<span class="hljs-number">26</span>.<span class="hljs-number">951637</span> ++++<span class="hljs-number">1</span>秒重复定时执行++++<br></code></pre></td></tr></table></figure>

<p>从日志可以看到：当线程空闲的时候定时器的消息触发还是比较准确的，但是在30分12秒开始线程一直忙着做大量运算，直到30分24秒该运算才结束，这时候定时器回调才触发。这个线程繁忙的过程超过了一个周期，但是定时器并没有连着触发两次消息，而是只触发了一次。也就是说繁忙期间的几次回调都跳过了，繁忙过后立刻执行了一次回调，之后又正常1秒执行一次回调。</p>
<h4 id="3-特殊的定时器"><a href="#3-特殊的定时器" class="headerlink" title="3.特殊的定时器"></a>3.特殊的定时器</h4><h5 id="1-delay"><a href="#1-delay" class="headerlink" title="1.delay"></a>1.delay</h5><p><code>NSTimer</code>是最常见的定时器，除此之外<code>NSObject</code>的分类中还定义了一些特殊的定时器:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs erlang">@interface NSObject (NSDelayedPerforming)<br><br>//延时<br>- <span class="hljs-params">(void)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>anArgument <br>afterDelay:<span class="hljs-params">(NSTimeInterval)</span>delay <br>inModes:<span class="hljs-params">(NSArray&lt;NSRunLoopMode&gt; *)</span>modes;<br><br>- <span class="hljs-params">(void)</span>performSelector:<span class="hljs-params">(SEL)</span>aSelector <br>withObject:<span class="hljs-params">(id)</span>anArgument <br>afterDelay:<span class="hljs-params">(NSTimeInterval)</span>delay;<br><br>//取消延时<br>+ <span class="hljs-params">(void)</span>cancelPreviousPerformRequestsWithTarget:<span class="hljs-params">(id)</span>aTarget <br>selector:<span class="hljs-params">(SEL)</span>aSelector <br>object:<span class="hljs-params">(nullable id)</span>anArgument;<br><br>+ <span class="hljs-params">(void)</span>cancelPreviousPerformRequestsWithTarget:<span class="hljs-params">(id)</span>aTarget;<br><br>@end<br></code></pre></td></tr></table></figure>

<p>#示例：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">-(<span class="hljs-type">void</span>)onSelector:(<span class="hljs-type">id</span>)obj&#123;<br>    <span class="hljs-comment">// 延时任务结束</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++thread:%@,++runloop:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread],[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>&#125;<br>- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;<br>        <span class="hljs-comment">// 延时任务开始前</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        [<span class="hljs-keyword">self</span> performSelector:<span class="hljs-keyword">@selector</span>(onSelector:) withObject:<span class="hljs-literal">nil</span> afterDelay:<span class="hljs-number">1</span>];<br>        <span class="hljs-comment">// 添加延时任务后</span><br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++check timers:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        <span class="hljs-built_in">CFRunLoopRun</span>();<span class="hljs-comment">//启动子线程的runloop</span><br>    &#125;);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出日志(有删减，保留了主要内容)：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-comment">// 延时任务开始前</span><br>+++runloop:&lt;CFRunLoop <span class="hljs-number">0x60000222c700</span>&gt;&#123;<br>。。。<br>modes = &lt;CFBasicHash <span class="hljs-number">0x600001062dc0</span>&gt;&#123;type = mutable <span class="hljs-keyword">set</span>, count <span class="hljs-comment">= 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x60000252d040&gt;&#123;name = kCFRunLoopDefaultMode,</span> <br>    port <span class="hljs-comment">set = 0x6107,</span> <br>    queue <span class="hljs-comment">= 0x600003026380,</span> <br>    source <span class="hljs-comment">= 0x600003026b80 (not fired), timer port = 0x9d03,</span> <br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    timers <span class="hljs-comment">= (null),</span>// 注意这一行，此时<span class="hljs-comment">timers</span>数组是空的！！！！<br>&#125;<br><br><span class="hljs-comment">// 添加延时任务后</span><br>++++check <span class="hljs-comment">timers:&lt;CFRunLoop 0x60000222c700]&gt;&#123;</span><br>。。。<br>modes <span class="hljs-comment">= &lt;CFBasicHash 0x600001062dc0&gt;&#123;type = mutable set, count = 1,</span><br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x60000252d040&gt;&#123;name = kCFRunLoopDefaultMode,</span> <br>    port <span class="hljs-comment">set = 0x6107,</span> <br>    queue <span class="hljs-comment">= 0x600003026380,</span> <br>    source <span class="hljs-comment">= 0x600003026b80 (not fired), timer port = 0x9d03,</span> <br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    <span class="hljs-comment">// 注意，这里timers数组中values是有值的，是一个CFRunLoopTimer对象！！！</span><br>    timers <span class="hljs-comment">= &lt;CFArray 0x600003a2f000 [0x10eb3db48]&gt;&#123;</span><br>    type <span class="hljs-comment">= mutable-small, count = 1, values = (</span><br>    0 : &lt;CFRunLoopTimer <span class="hljs-comment">0x600002b2e340]&gt;&#123;valid = Yes,</span> <br>    firing <span class="hljs-comment">= No, interval = 0, tolerance = 0, next fire date = 594358054</span> <br>)&#125;<br><br><span class="hljs-comment">// 延时任务结束</span><br>+++thread:&lt;NSThread:&gt;&#123;number <span class="hljs-comment">= 5, name = (null)&#125;,++runloop:&lt;CFRunLoop 0x60000222c700</span><br>。。。<br>entries <span class="hljs-comment">=&gt;</span><br>    2 : &lt;CFRunLoopMode <span class="hljs-comment">0x60000252d040&gt;&#123;name = kCFRunLoopDefaultMode,</span> <br>    port <span class="hljs-comment">set = 0x6107,</span> <br>    queue <span class="hljs-comment">= 0x600003026380,</span> <br>    source <span class="hljs-comment">= 0x600003026b80 (not fired), timer port = 0x9d03,</span> <br>    sources0 <span class="hljs-comment">= (null),</span><br>    sources1 <span class="hljs-comment">= (null),</span><br>    observers <span class="hljs-comment">= (null),</span><br>    <span class="hljs-comment">// 注意，这里timers数组中又为空了</span><br>    timers <span class="hljs-comment">= &lt;CFArray&gt;&#123;type = mutable-small, count = 0, values = ()&#125;,</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>日志显示，在调用<code>perform..afterDelay</code>后，子线程 runloop 的 CFRunLoopMode 的<code>timers</code>数组中有了一个<code>CFRunLoopTimer</code>对象！它就是系统为延时操作创建的一个定时器；延时操作完成之后，此定时器对象又自动从timers数组中移除。</p>
<p>同时，如果在调用<code>-onSelector:</code>时打断点，可得到如下的堆栈信息：</p>
<p><img src="https://davidlii.nos-eastchina1.126.net/pic_perform_afterDelay.png" srcset="/img/loading.gif" lazyload alt="pic_perform_afterDelay"></p>
<p>从堆栈上也可以看到，<strong>延时操作的本质实现是运行时在当前线程的 runloop 中添加了一个“定时源”</strong>~</p>
<p>需要注意的是：<strong>在子线程中使用这种延时执行方法时，如果不主动启动子线程的 runloop，那么 selector 是不会执行的</strong>。这也就是前面提到的“如果子线程的 Runloop 根本没有运行，那么定时器也不会触发”，实际的开发中一定要注意这一点。</p>
<p>另外：这两个方法都只是将<code>selector</code>的调用延迟某个时间长度，并不影响调用方法时所处的线程，即在A线程调用这两个<code>performSelector</code>，延迟后的<code>selector</code>还是在A线程中执行。</p>
<h5 id="2-GCD定时器"><a href="#2-GCD定时器" class="headerlink" title="2.GCD定时器"></a>2.GCD定时器</h5><p>首先要说明的是，GCD的定时器与上面三种不同，它<strong>不是runloop的源!</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-string">&quot;GCDTimerTest.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">GCDTimerTest</span> ()</span><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">dispatch_queue_t</span> seriaqueue;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) dispatch_source_t timer;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">GCDTimerTest</span></span><br><br>- (<span class="hljs-type">void</span>)gcd_timer&#123;<br>    _seriaqueue = dispatch_queue_create(<span class="hljs-string">&quot;xx&quot;</span>, DISPATCH_QUEUE_SERIAL);<br>    __<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) wself = <span class="hljs-keyword">self</span>;<br>    <span class="hljs-built_in">dispatch_async</span>(_seriaqueue, ^&#123;<br>        __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(wself) sself = wself;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop before timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>        sself.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sself.seriaqueue);<br>        dispatch_source_set_timer(sself.timer, DISPATCH_TIME_NOW, <span class="hljs-number">1</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>, <span class="hljs-number">0</span> * <span class="hljs-built_in">NSEC_PER_SEC</span>);<br>        dispatch_source_set_event_handler(sself.timer, ^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行计时任务&quot;</span>);<br>            <span class="hljs-comment">//dispatch_source_cancel(sself.timer);</span><br>        &#125;);<br>        dispatch_resume(sself.timer);<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++runloop after timer:%@&quot;</span>,[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]);<br>    &#125;);<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">+++runloop <span class="hljs-keyword">before</span> timer:&lt;CFRunLoop<br>common mode items = (<span class="hljs-keyword">null</span>),<br>modes = &lt;CFBasicHash <span class="hljs-number">0x600001b71dd0</span>&gt;&#123;<br>entries =&gt;<br>    <span class="hljs-number">2</span> : &lt;CFRunLoopMode <span class="hljs-number">0x600002e2a8a0</span>&gt;&#123;<br>    <span class="hljs-type">name</span> = kCFRunLoopDefaultMode, <br>    source = <span class="hljs-number">0x600003b25900</span> (<span class="hljs-keyword">not</span> fired), <br>    timer port = <span class="hljs-number">0x5f03</span>, <br>    sources0 = (<span class="hljs-keyword">null</span>),<br>    sources1 = (<span class="hljs-keyword">null</span>),<br>    observers = (<span class="hljs-keyword">null</span>),<br>    timers = (<span class="hljs-keyword">null</span>),<br>&#125;<br>// 开始GCD定时器之后<br>+++runloop <span class="hljs-keyword">after</span> timer:&lt;CFRunLoop <span class="hljs-number">0x600002928200</span>&#123;<br>modes = &lt;CFBasicHash <span class="hljs-number">0x600001b71dd0</span><br>entries =&gt;<br>    <span class="hljs-number">2</span> : &lt;CFRunLoopMode <span class="hljs-number">0x600002e2a8a0</span>&gt;&#123;<br>    <span class="hljs-type">name</span> = kCFRunLoopDefaultMode,<br>    sources0 = (<span class="hljs-keyword">null</span>),<br>    sources1 = (<span class="hljs-keyword">null</span>),<br>    observers = (<span class="hljs-keyword">null</span>),<br>    timers = (<span class="hljs-keyword">null</span>),<br>&#125;<br>++++执行计时任务<br></code></pre></td></tr></table></figure>

<p>日志中可以看到，开启GCD定时器之后，当前runloop的timers中也并未增加新的定时源~</p>
<p>所以，GCD的定时器并不是由<code>NSTimer</code>或者<code>CFRunLoopTimer</code>实现的，也不需要加入到runloopMode中，即<strong>不受runloop模式切换的影响</strong>。</p>
<h2 id="4-观察者"><a href="#4-观察者" class="headerlink" title="4.观察者"></a>4.观察者</h2><p>Runloop在处理输入事件的同时，在其运行的特定阶段还会触发通知。我们可以使用 CF 的方法，注册观察者来接收通知并在某个特定时期处理一些事情。</p>
<p>Runloop可以被观察的状态包括以下阶段：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* Run Loop Observer Activities */</span><br>typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;<br>kCFRunLoopEntry = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">0</span>),         <span class="hljs-regexp">//</span>runloop进入时；<br>kCFRunLoopBeforeTimers = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">1</span>),  <span class="hljs-regexp">//</span>将要处理Timer时;<br>kCFRunLoopBeforeSources = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">2</span>), <span class="hljs-regexp">//</span>将要处理Source0时；<br>kCFRunLoopBeforeWaiting = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">5</span>), <span class="hljs-regexp">//</span>将要进入睡眠时；<br>kCFRunLoopAfterWaiting = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">6</span>),  <span class="hljs-regexp">//</span>将要被唤醒时；<br>kCFRunLoopExit = (<span class="hljs-number">1</span>UL &lt;&lt; <span class="hljs-number">7</span>),          <span class="hljs-regexp">//</span>runloop即将退出时；<br>kCFRunLoopAllActivities = <span class="hljs-number">0</span>x0FFFFFFFU<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>#示例：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)runloopReturnTest<br>&#123;<br>    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), ^&#123;<br>        <br>        <span class="hljs-built_in">NSRunLoop</span> *mRunloop = [<span class="hljs-built_in">NSRunLoop</span> currentRunLoop];<br>        <br>        <span class="hljs-comment">// 创建一个观察者.</span><br>        <span class="hljs-built_in">CFRunLoopObserverRef</span> observer = <span class="hljs-built_in">CFRunLoopObserverCreateWithHandler</span>(<br>                                             kCFAllocatorDefault,<br>                                             kCFRunLoopAllActivities,<br>                                             <span class="hljs-literal">YES</span>, <span class="hljs-number">0</span>,<br>                                             ^(<span class="hljs-built_in">CFRunLoopObserverRef</span> observer, <span class="hljs-built_in">CFRunLoopActivity</span> activity)&#123;<br>            <span class="hljs-keyword">switch</span> (activity) &#123;<br>                <span class="hljs-keyword">case</span> kCFRunLoopEntry:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observer： kCFRunLoopEntry...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopBeforeTimers:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observer： kCFRunLoopBeforeTimers...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopBeforeSources:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observer： kCFRunLoopBeforeSources...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopBeforeWaiting:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observer： kCFRunLoopBeforeWaiting...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopAfterWaiting:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observer： kCFRunLoopAfterWaiting...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">case</span> kCFRunLoopExit:<br>                    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;observer： kCFRunLoopExit...&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                    <br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;);<br>        <br>        <span class="hljs-keyword">if</span> (observer)&#123;<br>            <span class="hljs-comment">//把观察者附加到runloop上</span><br>            <span class="hljs-built_in">CFRunLoopRef</span> cfLoop = [mRunloop getCFRunLoop];<br>            <span class="hljs-built_in">CFRunLoopAddObserver</span>(cfLoop, observer, kCFRunLoopDefaultMode);<br>        &#125;<br>        <br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;This thread starting.......&quot;</span>);<br>        <br>        <span class="hljs-comment">//新增计时器源并加入runloop</span><br>        <span class="hljs-built_in">NSTimer</span> *timer = [<span class="hljs-built_in">NSTimer</span> timerWithTimeInterval:<span class="hljs-number">5</span><br>                                                 target:<span class="hljs-keyword">self</span><br>                                               selector:<span class="hljs-keyword">@selector</span>(onHandleTask:)<br>                                               userInfo:<span class="hljs-literal">nil</span><br>                                                repeats:<span class="hljs-literal">NO</span>];<br>        [mRunloop addTimer:timer forMode:<span class="hljs-built_in">NSDefaultRunLoopMode</span>];<br>        <br>        <span class="hljs-comment">//最后一个参数：是否处理完事件返回，结束runLoop</span><br>        SInt32 result = <span class="hljs-built_in">CFRunLoopRunInMode</span>(kCFRunLoopDefaultMode, <span class="hljs-number">100</span>, <span class="hljs-literal">YES</span>);<br>        <br>        <span class="hljs-keyword">switch</span> (result) &#123;<br>            <span class="hljs-keyword">case</span> kCFRunLoopRunFinished:<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kCFRunLoopRunFinished&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br><br>            <span class="hljs-keyword">case</span> kCFRunLoopRunStopped:<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kCFRunLoopRunStopped&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>                <br>            <span class="hljs-keyword">case</span> kCFRunLoopRunTimedOut:<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kCFRunLoopRunTimedOut&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>                <br>            <span class="hljs-keyword">case</span> kCFRunLoopRunHandledSource:<br>                <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;kCFRunLoopRunHandledSource&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>                <br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;This thread end.......&quot;</span>);<br>    &#125;);<br>&#125;<br><br>- (<span class="hljs-type">void</span>)onHandleTask:(<span class="hljs-built_in">NSTimer</span> *)timer&#123;<br>    [timer invalidate];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;timer Fired...&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面的示例中，先往当前子线程的 runloop 中添加了一个观察者，监听并打印各个阶段的状态；随后往 runloop 中添加了一个定时器。执行到<code>CFRunLoopRunInMode</code>时，程序卡在这一行。5秒后计时器触发，计时器<code>invalidate</code>后，Runloop 中没有了任何事件源，所以退出并返回了result值，程序继续向下运行，输出日志如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">831</span>  This thread starting.......<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">831</span>  observer： kCFRunLoopEntry...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">832</span>  observer： kCFRunLoopBeforeTimers...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">832</span>  observer： kCFRunLoopBeforeSources...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">10</span>.<span class="hljs-number">833</span>  observer： kCFRunLoopBeforeWaiting...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">834</span>  observer： kCFRunLoopAfterWaiting...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">835</span>  timer Fired...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">835</span>  observer： kCFRunLoopExit...<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">836</span>  kCFRunLoopRunFinished<br><span class="hljs-attribute">23</span>:<span class="hljs-number">48</span>:<span class="hljs-number">15</span>.<span class="hljs-number">836</span>  This thread end.......<br></code></pre></td></tr></table></figure>

<h2 id="5-事件序列"><a href="#5-事件序列" class="headerlink" title="5.事件序列"></a>5.事件序列</h2><p>1、通知观察者 Runloop 已经启动;</p>
<p>2、通知观察者 <code>Timers</code> 即将触发;</p>
<p>3、通知观察者 将要处理 <code>Source0</code>;</p>
<p>4、触发 <code>Source0</code> 回调;</p>
<p>5、如果有 <code>Source1</code> 处于 <code>ready</code> 状态，直接进入步骤9处理该 <code>Source1</code>事件;</p>
<p>6、通知观察者 线程即将休眠;</p>
<p>7、线程休眠 等待以下情形的唤醒：</p>
<ul>
<li>某一事件到达基于端口的源(Source1);</li>
<li>定时器时间到了;</li>
<li>Runloop 设置的时间已经超时;</li>
<li>Runloop 被手动唤醒;</li>
</ul>
<p>8、通知观察者线程将被唤醒;</p>
<p>9、处理唤醒时收到的消息：</p>
<ul>
<li>如果消息是<code>Timer</code>类型，则触发该<code>Timer</code>的回调；</li>
<li>如果消息是 dispatch 到 <code>main_ queue</code> 的block，执行block；</li>
<li>如果消息是<code>Source1</code>类型，则处理<code>Source1</code>回调；</li>
</ul>
<p>10、以下条件中满足时候退出循环，否则从（2）继续循环：</p>
<ul>
<li>事件处理完毕，且启动 RunLoop 时参数设置为一次性执行；</li>
<li>启动 RunLoop 时设置的最大运行时间到期；</li>
<li>RunLoop 被外部调用强行停止；</li>
<li>启动 RunLoop 的 mode items为空；</li>
</ul>
<p>11、通知观察者 Runloop 结束。</p>
<p>上面逻辑对应的 <a target="_blank" rel="noopener" href="https://opensource.apple.com/source/CF/CF-855.17/CFRunLoop.c.auto.html">CFRunLoop.c源码</a> 如下：</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">/// 用DefaultMode启动</span><br>void CFRunLoopRun(void) &#123;<br>CFRunLoopRunSpecific(CFRunLoopGetCurrent(), <br>kCFRunLoopDefaultMode, <span class="hljs-number">1.0</span>e10, <span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-comment">/// 用指定的Mode启动，允许设置RunLoop超时时间</span><br>int CFRunLoopRunInMode(CFStringRef modeName, <br>CFTimeInterval seconds, Boolean stopAfterHandle) &#123;<br><br>return CFRunLoopRunSpecific(CFRunLoopGetCurrent(), <br>modeName, seconds, returnAfterSourceHandled);<br>&#125;<br><br><span class="hljs-comment">/// RunLoop的实现</span><br>int CFRunLoopRunSpecific(runloop, modeName,<br>seconds, stopAfterHandle) &#123;<br><br><span class="hljs-comment">/// 首先根据modeName找到对应mode</span><br>CFRunLoopModeRef currentMode = <span class="hljs-variable">__CFRunLoopFindMode</span>(runloop, modeName, <span class="hljs-literal">false</span>);<br><span class="hljs-comment">/// 如果mode里没有source/timer/observer, 直接返回。</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">__CFRunLoopModeIsEmpty</span>(currentMode)) return;<br><br><span class="hljs-comment">/// 1. 通知 Observers: RunLoop 即将进入 loop。</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopEntry);<br><br><span class="hljs-comment">/// 内部函数，进入loop</span><br><span class="hljs-variable">__CFRunLoopRun</span>(runloop, currentMode, seconds, returnAfterSourceHandled) &#123;<br><br>Boolean sourceHandledThisLoop = NO;<br>int retVal = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">do</span> &#123;<br><br><span class="hljs-comment">/// 2. 通知 Observers: RunLoop 即将触发 Timer 回调。</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopBeforeTimers);<br><span class="hljs-comment">/// 3. 通知 Observers: RunLoop 即将触发 Source0 (非port) 回调。</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopBeforeSources);<br><span class="hljs-comment">/// 处理非延迟的主线程调用</span><br><span class="hljs-variable">__CFRunLoopDoBlocks</span>(runloop, currentMode);<br><br><span class="hljs-comment">/// 4. RunLoop 触发 Source0 (非port) 回调。</span><br>sourceHandledThisLoop = <span class="hljs-variable">__CFRunLoopDoSources0</span>(runloop, currentMode, stopAfterHandle);<br><span class="hljs-comment">/// 执行被加入的block</span><br><span class="hljs-variable">__CFRunLoopDoBlocks</span>(runloop, currentMode);<br><br><span class="hljs-comment">/// 5. 如果有 Source1 (基于port) 处于 ready 状态，直接处理这个 Source1 然后跳转去处理消息。</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">__Source0DidDispatchPortLastTime</span>) &#123;<br>Boolean hasMsg = <span class="hljs-variable">__CFRunLoopServiceMachPort</span>(dispatchPort, &amp;msg)<br><span class="hljs-keyword">if</span> (hasMsg) <span class="hljs-built_in">goto</span> handle_msg;<br>&#125;<br><br><span class="hljs-comment">/// 通知 Observers: RunLoop 的线程即将进入休眠(sleep)。</span><br><span class="hljs-keyword">if</span> (!sourceHandledThisLoop) &#123;<br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopBeforeWaiting);<br>&#125;<br><br><span class="hljs-comment">/// 7. 调用 mach_msg 等待接受 mach_port 的消息。线程将进入休眠, 直到被下面某一个事件唤醒。</span><br><span class="hljs-comment">/// • 一个基于 port 的Source 的事件。</span><br><span class="hljs-comment">/// • 一个 Timer 到时间了</span><br><span class="hljs-comment">/// • RunLoop 自身的超时时间到了</span><br><span class="hljs-comment">/// • 被其他什么调用者手动唤醒</span><br><span class="hljs-variable">__CFRunLoopServiceMachPort</span>(waitSet, &amp;msg, <span class="hljs-built_in">sizeof</span>(msg_buffer), &amp;livePort) &#123;<br>mach_msg(msg, MACH_RCV_MSG, port); <span class="hljs-comment">// thread wait for receive msg</span><br>&#125;<br><br><span class="hljs-comment">/// 8. 通知 Observers: RunLoop 的线程刚刚被唤醒了。</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(runloop, currentMode, kCFRunLoopAfterWaiting);<br><br><span class="hljs-comment">/// 收到消息，处理消息。</span><br>handle_msg:<br><br><span class="hljs-comment">/// 9.1 如果一个 Timer 到时间了，触发这个Timer的回调。</span><br><span class="hljs-keyword">if</span> (msg_is_timer) &#123;<br><span class="hljs-variable">__CFRunLoopDoTimers</span>(runloop, currentMode, mach_absolute_time())<br>&#125;<br><br><span class="hljs-comment">/// 9.2 如果有dispatch到main_queue的block，执行block。</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg_is_dispatch) &#123;<br><span class="hljs-variable">__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</span>(msg);<br>&#125;<br><br><span class="hljs-comment">/// 9.3 如果一个 Source1 (基于port) 发出事件了，处理这个事件</span><br><span class="hljs-keyword">else</span> &#123;<br>CFRunLoopSourceRef source1 = <span class="hljs-variable">__CFRunLoopModeFindSourceForMachPort</span>(runloop,<br>currentMode, livePort);<br><br>sourceHandledThisLoop = <span class="hljs-variable">__CFRunLoopDoSource1</span>(runloop, <br>currentMode, source1, msg);<br><br><span class="hljs-keyword">if</span> (sourceHandledThisLoop) &#123;<br>mach_msg(reply, MACH_SEND_MSG, reply);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/// 执行加入到Loop的block</span><br><span class="hljs-variable">__CFRunLoopDoBlocks</span>(runloop, currentMode);<br><br><br><span class="hljs-keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;<br><span class="hljs-comment">/// 进入loop时参数说处理完事件就返回。</span><br>retVal = kCFRunLoopRunHandledSource;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (timeout) &#123;<br><span class="hljs-comment">/// 超出传入参数标记的超时时间了</span><br>retVal = kCFRunLoopRunTimedOut;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">__CFRunLoopIsStopped</span>(runloop)) &#123;<br><span class="hljs-comment">/// 被外部调用者强制停止了</span><br>retVal = kCFRunLoopRunStopped;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">__CFRunLoopModeIsEmpty</span>(runloop, currentMode)) &#123;<br><span class="hljs-comment">/// source/timer/observer一个都没有了</span><br>retVal = kCFRunLoopRunFinished;<br>&#125;<br><br><span class="hljs-comment">/// 如果没超时，mode里没空，loop也没被停止，那继续loop。</span><br>&#125; <span class="hljs-keyword">while</span> (retVal == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/// 10. 通知 Observers: RunLoop 即将退出。</span><br><span class="hljs-variable">__CFRunLoopDoObservers</span>(rl, currentMode, kCFRunLoopExit);<br></code></pre></td></tr></table></figure>

<p>可以看到，实际上 RunLoop 就是这样一个函数，其内部是一个<code>do-while</code> 循环。当你调用 <code>CFRunLoopRun()</code> 时，线程就会一直停留在这个循环里；直到超时或被手动停止，该函数才会返回。RunLoop 的核心是 <code>mach_msg()</code> 函数(见上面代码的第7步)，RunLoop 调用这个函数去接收消息，如果没有别人发送 port 消息过来，内核会将线程置于等待状态。</p>
<h2 id="6-什么时候用？"><a href="#6-什么时候用？" class="headerlink" title="6.什么时候用？"></a>6.什么时候用？</h2><ol>
<li>开启常驻线程时，需要在当前线程中启动 runloop，如AFN；</li>
<li>在子线程中使用定时器时，需要在子线程中启动 runloop，定时器才能正常启动；</li>
<li>设置定时器，在当前 runloop 的特定模式下执行；</li>
<li>让某些行为在当前 runloop 的特定模式下才执行，如滑动时的定时器、default模式下设置图片、加载缓存等。</li>
<li>添加观察者，在 runloop 的特定时刻处理某些事情；</li>
<li>使用端口或自定义输入源来和其他线程通信；</li>
</ol>
<h2 id="7-Runloop对象"><a href="#7-Runloop对象" class="headerlink" title="7.Runloop对象"></a>7.Runloop对象</h2><p>Runloop 对象提供了添加输入源、定时器、观察者以及启动 Runloop 的接口。每个线程都有唯一的与之关联的 Runloop对象。Cocoa和 CF 都有相应的接口可以操作 RunLoop：</p>
<ul>
<li>Cocoa中对应的是 NSRunLoop；</li>
<li>CF 中对应的是 CFRunLoopRef；</li>
</ul>
<h3 id="7-1-获取-RunLoop对象"><a href="#7-1-获取-RunLoop对象" class="headerlink" title="7.1.获取 RunLoop对象"></a>7.1.获取 RunLoop对象</h3><ul>
<li>CFRunLoopRef <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/cfrunloop-rht">（官方文档）</a></li>
</ul>
<p>这是 CF 框架提供的，它提供了纯C函数的API，这些API都是线程安全的。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">CFRunLoopRef aCFRunloopObjRef <span class="hljs-operator">=</span> CFRunLoopGetCurrent()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>NSRunLoop<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsrunloop">（官方文档）</a></li>
</ul>
<p>这是Cocoa框架提供的，它提供了面向对象的 API，是基于CFRunLoopRef的一层封装，但这些API是非线程安全的；苹果官方文档说，我们不能在当前线程中去call另外一个线程中 NSRunLoop 对象的方法，那样很可能会造成意想不到的后果。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">NSRunLoop *aRunloopObj <span class="hljs-operator">=</span> [NSRunLoop currentRunLoop]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>不过，两种类型的 Runloop 可以混合使用。鉴于 CFRunLoopRef 是线程安全的，所以，可以通过 NSRunLoop 类的实例方法获取对应的 CFRunLoopRef 对象，进而达到线程安全的目的：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">NSRunLoop *aRunloopObj <span class="hljs-operator">=</span> [NSRunLoop currentRunLoop]<span class="hljs-comment">;</span><br>CFRunLoopRef aCFRunloopObjRef <span class="hljs-operator">=</span> [aRunloopObj getCFRunLoop]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<h3 id="7-2-启动RunLoop"><a href="#7-2-启动RunLoop" class="headerlink" title="7.2.启动RunLoop"></a>7.2.启动RunLoop</h3><h4 id="1-NSRunLoop的启动"><a href="#1-NSRunLoop的启动" class="headerlink" title="1.NSRunLoop的启动"></a>1.NSRunLoop的启动</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">- (<span class="hljs-type">void</span>)run; <span class="hljs-comment">//无条件的启动</span><br></code></pre></td></tr></table></figure>

<p>不建议使用，因为这个接口会导致Run Loop永久性的在NSDefaultRunLoopMode模式。即使用CFRunLoopStop()函数也无法停止Run Loop的运行，除非能移除这个runloop上的所有事件源，不然这个子线程就无法停止，只能永久运行下去。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)runUntilDate:(<span class="hljs-built_in">NSDate</span> *)limitDate;<span class="hljs-comment">//设置超时时间</span><br></code></pre></td></tr></table></figure>

<p>比上面的接口好点，有个超时时间，可以控制每次 Runloop 的运行时间，也是运行在<code>NSDefaultRunLoopMode</code>模式。这个方法运行 Runloop 一段时间会退出给你检查运行条件的机会，如果需要可以再次运行 Runloop。</p>
<p>注意：使用这种方式启动runloop时，CFRunLoopStop()函数也无法停止这个runloop。</p>
<p>#示例：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua">BOOL finished = NO;<br>    <br><span class="hljs-keyword">while</span>(!finished) &#123;<br>    <span class="hljs-string">[[NSRunLoop currentRunLoop] runUntilDate:</span><br><span class="hljs-string">     [NSDate dateWithTimeIntervalSinceNow: 1]]</span>;<br>    <br>    NSLog(@<span class="hljs-string">&quot;exit runloop ......&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个finished是我们自定义的一个Bool值，用来控制是否还需要开启下一次 Runloop。</p>
<p>上面例子所做的事：while循环内部有个 RunLoop 每秒循环一次，Runloop 结束后会输出<code>exit Runloop ……</code>。while循环会根据 finished 值来判断是否再去运行 Runloop。</p>
<p>输出日志如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">20.980211</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">21.981915</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">22.983668</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">23.984748</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">24.986541</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br><span class="hljs-number">21</span>:<span class="hljs-number">20</span>:<span class="hljs-number">25.988267</span>+<span class="hljs-number">0800</span> <span class="hljs-keyword">exit</span> runloop ......<br></code></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)runMode:(<span class="hljs-built_in">NSRunLoopMode</span>)mode beforeDate:(<span class="hljs-built_in">NSDate</span> *)limitDate;<span class="hljs-comment">//特定的模式</span><br></code></pre></td></tr></table></figure>

<p>比上面的方法多了mode参数，不同的是，这种运行方式是可以被<code>CFRunLoopStop()</code>函数停止的。</p>
<h4 id="2-CFRunLoopRef的启动"><a href="#2-CFRunLoopRef的启动" class="headerlink" title="2.CFRunLoopRef的启动"></a>2.CFRunLoopRef的启动</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CFRunLoopRun</span>()</span>;<br></code></pre></td></tr></table></figure>

<p>使用这种方式启动后，Runloop 会一直运行，直到显示地调用<code>CFRunLoopStop()</code>才会停止。另外，删除 RunLoop 的所有事件源后，也能停止这个 Runloop。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">SInt32 <span class="hljs-constructor">CFRunLoopRunInMode(<span class="hljs-params">mode</span>, <span class="hljs-params">second</span>, <span class="hljs-params">returnAfterSourceHandled</span>)</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li>参数mode：模式；</li>
<li>参数second：runloop的循环时间；</li>
<li>参数returnAfterSourceHandled：是否在处理事件后让Run Loop退出返回；</li>
</ul>
<p>这种方式启动的 Runloop 也可以使用<code>CFRunLoopStop()</code>来主动停止。NSRunloop 中的第三种启动方式，实质上就是基于这种方式的封装，只不过指定了最后一个<code>returnAfterSourceHandled</code>参数为YES。</p>
<ul>
<li>Runloop的返回值</li>
</ul>
<p>启动 Runloop 后，代码停在这一行不返回。当有值返回时Runloop就结束了。这个返回值就是Runloop结束原因，枚举如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/* Reasons for CFRunLoopRunInMode() to Return */</span><br>typedef CF_ENUM(SInt32, CFRunLoopRunResult) &#123;<br>    kCFRunLoopRunFinished = <span class="hljs-number">1</span>,  <span class="hljs-regexp">//</span>Runloop结束，所有的Sources都已被移除，无事件源可监听；<br>    kCFRunLoopRunStopped = <span class="hljs-number">2</span>,   <span class="hljs-regexp">//</span>Runloop被使用CFRunLoopStop函数停止；<br>    kCFRunLoopRunTimedOut = <span class="hljs-number">3</span>,  <span class="hljs-regexp">//</span>超时；<br>    kCFRunLoopRunHandledSource = <span class="hljs-number">4</span> <span class="hljs-regexp">//</span>Runloop已处理完事件；<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>回头看看NSRunloop的第三种启动方式：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">- <span class="hljs-params">(Bool)</span>runMode:<span class="hljs-params">(NSString *)</span>mode beforeDate:<span class="hljs-params">(NSDate *)</span>limitDate;<br></code></pre></td></tr></table></figure>

<p>返回值为一个Bool值，如果是”performSelector” 事件或者其他 Input Source 事件触发并处理完成后，Runloop会退出并返回YES，其他情况下返回NO。</p>
<h3 id="7-3-退出RunLoop"><a href="#7-3-退出RunLoop" class="headerlink" title="7.3.退出RunLoop"></a>7.3.退出RunLoop</h3><p>上面也有提到，有三种方法可以让 Runloop 处理事件之前退出:</p>
<ul>
<li>指定超时时间：</li>
</ul>
<p>这可以使 Runloop 退出前完成所有正常操作，包括发送消息给 Runloop 观察者，如果可以配置的话，推荐使用这种方法。</p>
<ul>
<li>使用CFRunLoopStop：</li>
</ul>
<p>这可以显式的停止 Runloop，Runloop 会把所有剩余的通知发送出去再退出。</p>
<ul>
<li>移除 Runloop 的输入源和定时器：</li>
</ul>
<p>尽管这种方式也可能导致 Runloop 退出，但这并不是可靠的退出 Runloop 的方法。一些系统例程会添加输入源到 Runloop 里面来处理所需事件。因为你的代码未必会考虑到这些输入源，这样可能导致你无法移除它们，从而导致退出 Runloop 失败。</p>
<h2 id="8-应用场景"><a href="#8-应用场景" class="headerlink" title="8.应用场景"></a>8.应用场景</h2><h3 id="8-1-卡顿检测"><a href="#8-1-卡顿检测" class="headerlink" title="8.1.卡顿检测"></a>8.1.卡顿检测</h3><p>卡顿原理：</p>
<ol>
<li>主线程runloop处于beforeSource或afterWaiting状态时表示正在执行任务；</li>
<li>设置一个卡顿时长阈值<code>T</code>，隔时长<code>T</code>检查一次当前runloop的状态(mode)；</li>
<li>若多个检查周期中，一直处于以上两种状态，而没有休眠，则说明线程处于卡顿状态；</li>
<li>获取卡顿时堆栈的情况，记录并上报；</li>
</ol>
<p>实现方案：</p>
<ol>
<li>监听并记录主线程runloop的mode(状态)；</li>
<li>开启一个常驻线程，处理检测、上报任务；</li>
<li>启动定时器，阈值T时间到后比对runloop的状态；</li>
<li>当阈值T时间内连续检测到状态为beforeSource或afterWaiting，即为卡顿，上报堆栈；</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RunLoopMonitor</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() &#123;&#125;<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared: <span class="hljs-type">RunLoopMonitor</span> <span class="hljs-operator">=</span> <span class="hljs-type">RunLoopMonitor</span>.<span class="hljs-keyword">init</span>()<br>    <span class="hljs-keyword">var</span> loopObserver: <span class="hljs-type">CFRunLoopObserver</span>?<br>    <span class="hljs-keyword">var</span> loopActivity: <span class="hljs-type">CFRunLoopActivity</span>?<br>    <span class="hljs-keyword">var</span> aSemaphore: <span class="hljs-type">DispatchSemaphore</span>?<br>    <span class="hljs-keyword">var</span> stuckTimes <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-comment">//出现卡顿的次数</span><br>    <br>    <span class="hljs-comment">/*原理：</span><br><span class="hljs-comment">     线程runloop处于beforeSource或afterWaiting状态时表示正在执行任务；</span><br><span class="hljs-comment">     多个检查周期中，runloop一直处于beforeSource或afterWaiting状态，</span><br><span class="hljs-comment">     而没有休眠，则说明runloop处于卡顿状态。</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">startMonitor</span>() &#123;<br>        <span class="hljs-keyword">let</span> uptr <span class="hljs-operator">=</span> <span class="hljs-type">Unmanaged</span>.passRetained(<span class="hljs-keyword">self</span>).toOpaque()<br>        <span class="hljs-keyword">let</span> vptr <span class="hljs-operator">=</span> <span class="hljs-type">UnsafeMutableRawPointer</span>(uptr)<br>        <span class="hljs-keyword">var</span> context <span class="hljs-operator">=</span> <span class="hljs-type">CFRunLoopObserverContext</span>.<span class="hljs-keyword">init</span>(version: <span class="hljs-number">0</span>,<br>                                                    info: vptr,<br>                                                    retain: <span class="hljs-literal">nil</span>,<br>                                                    release: <span class="hljs-literal">nil</span>,<br>                                                    copyDescription: <span class="hljs-literal">nil</span>)<br>        <span class="hljs-comment">//创建、添加观察者</span><br>        loopObserver <span class="hljs-operator">=</span> <span class="hljs-type">CFRunLoopObserverCreate</span>(kCFAllocatorDefault,<br>                                                  <span class="hljs-type">CFRunLoopActivity</span>.allActivities.rawValue,<br>                                                  <span class="hljs-literal">true</span>,<br>                                                  <span class="hljs-number">0</span>,<br>                                                  observerCallBack(),<br>                                                  <span class="hljs-operator">&amp;</span>context)<br>        <span class="hljs-type">CFRunLoopAddObserver</span>(<span class="hljs-type">CFRunLoopGetMain</span>(), loopObserver, .commonModes)<br>        <br>        aSemaphore <span class="hljs-operator">=</span> <span class="hljs-type">DispatchSemaphore</span>.<span class="hljs-keyword">init</span>(value: <span class="hljs-number">0</span>)<br>        <br>        <span class="hljs-type">DispatchQueue</span>.global().async &#123;<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> &#123;<br>                <span class="hljs-comment">// 方案一：通过单次超时时间判断，如超过250毫秒即为卡顿；</span><br>                <span class="hljs-comment">// 方案二：连续多次短期检测中均超时即为卡顿；</span><br>                <span class="hljs-keyword">let</span> st <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.aSemaphore<span class="hljs-operator">?</span>.wait(timeout: <span class="hljs-type">DispatchTime</span>.now() <span class="hljs-operator">+</span> .milliseconds(<span class="hljs-number">80</span>)) <span class="hljs-comment">//戴铭在GCDFetchFeed中认为连续三次超时80秒就是卡顿</span><br>                <span class="hljs-comment">//80毫秒超时后</span><br>                <span class="hljs-keyword">if</span> st <span class="hljs-operator">==</span> .timedOut &#123;<br>                    <span class="hljs-comment">//指针检测</span><br>                    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">self</span>.loopObserver <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">self</span>.aSemaphore <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>                        <span class="hljs-keyword">self</span>.loopActivity <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>                        <span class="hljs-keyword">self</span>.stuckTimes <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>                        <span class="hljs-keyword">return</span><br>                    &#125;<br>                    <span class="hljs-comment">//如果loop处在“工作”状态，就无法休眠，记录+1</span><br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.loopActivity <span class="hljs-operator">==</span> .afterWaiting <span class="hljs-operator">||</span><br>                       <span class="hljs-keyword">self</span>.loopActivity <span class="hljs-operator">==</span> .beforeSources<br>                    &#123;<br>                        <span class="hljs-comment">//记录一次卡顿</span><br>                        <span class="hljs-keyword">self</span>.stuckTimes <span class="hljs-operator">+=</span> <span class="hljs-number">1</span><br>                        <span class="hljs-comment">//未超过3次，表示正常</span><br>                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.stuckTimes <span class="hljs-operator">&lt;</span> <span class="hljs-number">3</span> &#123; <span class="hljs-keyword">continue</span> &#125;<br>                        <span class="hljs-comment">//超过三次，即为出现卡顿</span><br>                        <span class="hljs-type">DispatchQueue</span>.global().async &#123;<br>                            <span class="hljs-comment">//获取当前卡顿时的堆栈 上报</span><br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//观察者回调</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">observerCallBack</span>() -&gt; <span class="hljs-type">CFRunLoopObserverCallBack</span> &#123;<br>        <span class="hljs-keyword">return</span> &#123; (observer, activity, context) <span class="hljs-keyword">in</span><br>            <span class="hljs-keyword">let</span> weakself <span class="hljs-operator">=</span> <span class="hljs-type">Unmanaged</span>&lt;<span class="hljs-type">RunLoopMonitor</span>&gt;.fromOpaque(context<span class="hljs-operator">!</span>).takeUnretainedValue()<br>            <span class="hljs-comment">//记录runloop的状态</span><br>            weakself.loopActivity <span class="hljs-operator">=</span> activity<br>            weakself.aSemaphore<span class="hljs-operator">?</span>.signal()<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//结束监测</span><br>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">end</span>() &#123;<br>        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> loopObserver <span class="hljs-keyword">else</span> &#123; <span class="hljs-keyword">return</span> &#125;<br>        <span class="hljs-type">CFRunLoopRemoveObserver</span>(<span class="hljs-type">CFRunLoopGetMain</span>(), loopObserver, .commonModes)<br>        loopObserver <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-2-其他应用场景"><a href="#8-2-其他应用场景" class="headerlink" title="8.2.其他应用场景"></a>8.2.其他应用场景</h3><ul>
<li>AutoreleasePool</li>
<li>事件响应</li>
<li>手势识别</li>
<li>界面更新</li>
<li>定时器</li>
<li>GCD</li>
<li>网络请求</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/05/18/runloop/">ibireme</a>的这篇博客里讲解的很详细，膜拜一哈~</p>
<hr>
<p>相关参考：</p>
<p>#<a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html">©官方文档</a></p>
<p>#<a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/05/18/runloop/">©ibireme</a></p>
<p>#<a target="_blank" rel="noopener" href="http://blog.csdn.net/u011619283/article/details/53666009">©微信卡顿检测</a></p>
<p>#<a target="_blank" rel="noopener" href="http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/">©百度孙源-优化UITableViewCell高度计算的那些事</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/OC/" class="category-chain-item">OC</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/runloop/">#runloop</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Runloop</div>
      <div>https://davidlii.cn/2017/09/09/runloop.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Davidli</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2017年9月9日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2017/11/07/nsthread.html" title="NSThread">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">NSThread</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2017/09/01/runtime-addClass.html" title="动态注册类">
                        <span class="hidden-mobile">动态注册类</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/davidli-" target="_blank" rel="nofollow noopener"><span>嵇风</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>



<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Davidli">
  <meta name="keywords" content="Davidli">
  
    <meta name="description" content="iOS2 时 OS X 与 iOS 的程序都普遍采用 NSOperation 来编写线程代码，而之后出现的 GCD 技术大体是依照前者的原则来实现的。随着 GCD 的普及，在iOS4 与 OS X 10.6 以后，OperationQueue 的底层都是用 GCD 来实现的。  1.与 GCD 的对比1.1.GCD 的特点：GCD 是面向过程的，它是由 C 语言构成的 API，一般与 block">
<meta property="og:type" content="article">
<meta property="og:title" content="多线程：NSOperation">
<meta property="og:url" content="http://yoursite.com/2017/11/17/nsoperation.html">
<meta property="og:site_name" content="Davidli">
<meta property="og:description" content="iOS2 时 OS X 与 iOS 的程序都普遍采用 NSOperation 来编写线程代码，而之后出现的 GCD 技术大体是依照前者的原则来实现的。随着 GCD 的普及，在iOS4 与 OS X 10.6 以后，OperationQueue 的底层都是用 GCD 来实现的。  1.与 GCD 的对比1.1.GCD 的特点：GCD 是面向过程的，它是由 C 语言构成的 API，一般与 block">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-11-17T14:50:02.000Z">
<meta property="article:modified_time" content="2019-10-23T09:35:02.000Z">
<meta property="article:author" content="Davidli">
<meta property="article:tag" content="多线程">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>多线程：NSOperation - Davidli</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"<","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Davidlii</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/IMG_0.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="多线程：NSOperation"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2017-11-17 22:50" pubdate>
          2017年11月17日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          22k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          186 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">多线程：NSOperation</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>iOS2 时 OS X 与 iOS 的程序都普遍采用 NSOperation 来编写线程代码，而之后出现的 GCD 技术大体是依照前者的原则来实现的。随着 GCD 的普及，在iOS4 与 OS X 10.6 以后，OperationQueue 的底层都是用 GCD 来实现的。</p>
</blockquote>
<h3 id="1-与-GCD-的对比"><a href="#1-与-GCD-的对比" class="headerlink" title="1.与 GCD 的对比"></a>1.与 GCD 的对比</h3><h4 id="1-1-GCD-的特点："><a href="#1-1-GCD-的特点：" class="headerlink" title="1.1.GCD 的特点："></a>1.1.GCD 的特点：</h4><p>GCD 是面向过程的，它是由 C 语言构成的 API，一般与 block 结合使用，简洁高效；</p>
<h4 id="1-2-NSOperation的特点："><a href="#1-2-NSOperation的特点：" class="headerlink" title="1.2.NSOperation的特点："></a>1.2.NSOperation的特点：</h4><p><strong>复用率：</strong> NSOperation 是面向对象的，拥有更多的函数可用；同时它能被继承，这一方面方便了我们重写其部分方法以实现特殊功能；另一方面也让我们可以根据需求定义不同的子类，从而提高代码的复用率；<br><br/></p>
<p><strong>依赖关系：</strong> NSOperation 能够方便地设置依赖关系，这样可以方便的让处于同一个并行队列中的两个任务按照我们指定的先后顺序执行；<br><br/></p>
<p><strong>属性监测：</strong> NSOperation 提供了部分属性，我们可通过 KVO 监听一个任务是否完成或取消。这让我们能比 GCD 更加有效地掌任务的进度和状态；<br><br/></p>
<p><strong>优先级设置：</strong> NSOperation 中能设置任务的优先级，使同一个并行队列中的任务区分先后地执行。GCD 中只能区分不同任务队列的优先级，如果要区分 block 内任务的优先级，需要复杂的代码；</p>
<h3 id="2-NSOperation"><a href="#2-NSOperation" class="headerlink" title="2.NSOperation"></a>2.NSOperation</h3><p>NSOperation 是一个基类，不能直接使。系统给我们提供了它的两个可以直接使用的子类：NSInvocationOperation 和 NSBlockOperation。当然你也可以自定义一个基于 NSOperation 的子类。</p>
<h4 id="2-1-子类"><a href="#2-1-子类" class="headerlink" title="2.1.子类"></a>2.1.子类</h4><p>#示例1（NSInvocationOperation）</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)operationGo<br>&#123;<br>    <span class="hljs-comment">//invocation Operation</span><br>    <span class="hljs-type">NSInvocationOperation</span> <span class="hljs-operator">*</span>invocOperation <span class="hljs-operator">=</span> [[<span class="hljs-type">NSInvocationOperation</span> alloc] <br>    initWithTarget:<span class="hljs-keyword">self</span> <br>    selector:<span class="hljs-meta">@selector</span>(operationAction) <br>    object:<span class="hljs-literal">nil</span>];<br>    <br>    <span class="hljs-comment">//执行结束后调用的Block</span><br>    [invocOperation setCompletionBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++invocation Finished&quot;</span>);<br>    &#125;];<br>    [invocOperation start];<br>&#125;<br><br><span class="hljs-operator">-</span> (void)operationAction<br>&#123;<br>    <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++execute invocation，</span><br><span class="hljs-string">    <span class="hljs-subst">\n</span>++++线程:%@&quot;</span>,[<span class="hljs-type">NSThread</span> currentThread]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出日志：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">execute invocation，</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">线程:</span>&lt;<span class="hljs-comment">NSThread: 0x600000065f80</span>&gt;<span class="hljs-comment">&#123;number = 1</span><span class="hljs-string">,</span> <span class="hljs-comment">name = main&#125;</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">invocation Finished</span><br></code></pre></td></tr></table></figure>

<p>#示例2（NSBlockOperation）</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)blockOperationGo<br>&#123;<br>    <span class="hljs-comment">//block Operation</span><br>    <span class="hljs-type">NSBlockOperation</span> <span class="hljs-operator">*</span>blockOperation <span class="hljs-operator">=</span> [<span class="hljs-type">NSBlockOperation</span> blockOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++execute block，<span class="hljs-subst">\n</span>++++线程:%@&quot;</span>,[<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    [blockOperation addExecutionBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++added block, <span class="hljs-subst">\n</span>++++线程:%@&quot;</span>,[<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    [blockOperation setCompletionBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++block Finished&quot;</span>);<br>    &#125;];<br>    [blockOperation start];<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出日志：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran">++++added <span class="hljs-keyword">block</span>,<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x60400027c4c0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++execute <span class="hljs-keyword">block</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x604000078080&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">1</span>, <span class="hljs-keyword">name</span> = main&#125;<br>++++<span class="hljs-keyword">block</span> Finished<br></code></pre></td></tr></table></figure>

<p>从上述示例及其输出结果中可以看到：<br><br/></p>
<p>NSOperation 的俩子类在单独使用时都没有开辟新线程的能力，任务会在当前线程中同步执行。<br><br/></p>
<p>NSBlockOperation 使用 addExecutionBlock 添加额外任务时，这些任务会在不同线程中并发执行。</p>
<h4 id="2-2-状态"><a href="#2-2-状态" class="headerlink" title="2.2.状态"></a>2.2.状态</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs abnf">BOOL executing<span class="hljs-comment">;</span><br>BOOL finished<span class="hljs-comment">;</span><br>BOOL asynchronous<span class="hljs-comment">;</span><br>BOOL ready<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>isReady</li>
</ul>
<p>表示这个 operation 是否已做好准备去执行。&#x3D;NO 表示它依赖的相关 operation 尚未完成。</p>
<ul>
<li>isExecuting</li>
</ul>
<p>表示当前 operation 中的任务是否正在执行。</p>
<ul>
<li>isFinished</li>
</ul>
<p>&#x3D; YES 时表示当任务已完成或者已被取消。只有此属性为YES时 operation 才会从队列中出列。</p>
<ul>
<li>isCancelled</li>
</ul>
<p>当前 operation 是否被取消了。在自定义子类的任务开始前，需要在 start 方法中检查此属性。当 &#x3D; YES 时应该立刻退出，同时将 finished属性设置为YES，executing 属性设置为 NO。</p>
<ul>
<li>isAsynchronous</li>
</ul>
<p>表示 operation 在当前线程是异步还是同步执行，默认值为NO。执行异步 operation 时必须重写此属性并返回 YES。<br><br/></p>
<p>注意：NSOperationQueue 是通过 KVO 观察内部的 NSOperation 状态的变化，来自动管理 NSOperation 的执行的。重写 start 方法时，我们必须自己维护 isExecuting、isFinished 的值并正确的发送相关 KVO 通知。</p>
<h4 id="2-3-优先级"><a href="#2-3-优先级" class="headerlink" title="2.3.优先级"></a>2.3.优先级</h4><p>NSOperation的优先级可以由其属性<code>queuePriority</code>指定：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elm">typedef <span class="hljs-type">NS_ENUM</span>(<span class="hljs-type">NSInteger</span>, <span class="hljs-type">NSOperationQueuePriority</span>) &#123;<br>    <span class="hljs-type">NSOperationQueuePriorityVeryLow</span> = -8L,<br>    <span class="hljs-type">NSOperationQueuePriorityLow</span> = -4L,<br>    <span class="hljs-type">NSOperationQueuePriorityNormal</span> = 0,<br>    <span class="hljs-type">NSOperationQueuePriorityHigh</span> = 4,<br>    <span class="hljs-type">NSOperationQueuePriorityVeryHigh</span> = 8<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>从名字来看似乎是和GCD一样的<code>队列</code>的优先级，实际上这个属性却是operation即<code>任务</code>的优先级：</p>
<blockquote>
<p>The execution priority of the operation in an operation queue.</p>
</blockquote>
<p>从这一点来说，Operation就比GCD的功能更丰富，因为GCD只能给队列设置优先级，队列中的任务之间没法单独设置优先级。并且GCD只能给<code>GlobalQueue</code>设置优先级，其他队列想要设置优先级，需要通过下面这种方式进行：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">dispatch_queue_t serialQueue = dispatch<span class="hljs-constructor">_queue_create(<span class="hljs-string">&quot;com.xx.xx&quot;</span>,DISPATCH_QUEUE_SERIAL)</span>;<br><br>dispatch_queue_t globalQueue = dispatch<span class="hljs-constructor">_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND,0)</span>;<br><br><span class="hljs-comment">//第一个参数是目标队列，第二个参数是参考队列（全局队列）；</span><br>dispatch<span class="hljs-constructor">_set_target_queue(<span class="hljs-params">serialQueue</span>, <span class="hljs-params">globalQueue</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>对于<code>queuePriority</code>有三点需要说明：</p>
<ul>
<li>优先级决定了各 operation 之间的开始顺序；</li>
<li>这种优先级只针对同一 OperationQueue 中的 operation，不同队列中的任务之间比较优先级无意义；</li>
<li>这种优先级是针对并发队列，对于并发数为 1 的串行队列来说无意义，它们还是按入队列的顺序执行。</li>
</ul>
<p><strong>ps</strong>：理论上来说优先级高的先执行，但实际使用中发现通过这个属性标记的任务，其开始的顺序并不一定按照我们指定的优先级来：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)operationPriority&#123;<br>    <span class="hljs-built_in">NSBlockOperation</span> *op1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++1&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++2&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++3&quot;</span>);<br>    &#125;];<br>    <br>    op1.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityNormal</span>;<br>    op2.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityVeryHigh</span>;<br>    op3.queuePriority = <span class="hljs-built_in">NSOperationQueuePriorityVeryLow</span>;<br>    <br>    <span class="hljs-built_in">NSOperationQueue</span> *aQueue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    [aQueue addOperations:@[op1,op2,op3] waitUntilFinished:<span class="hljs-literal">NO</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">2</span><br></code></pre></td></tr></table></figure>

<p>三个任务实际执行时并未按照我们指定的<code>2-&gt;1-&gt;3</code>的顺序来。<br><br/></p>
<p>有种说法是决定任务开始顺序的不仅是优先级，还要看任务是否处在<code>isReady</code>状态。</p>
<blockquote>
<p>The readiness of operations is determined by their dependencies on other operations and potentially by custom conditions that you define. The NSOperation class manages dependencies on other operations and reports the readiness of the receiver based on those dependencies.</p>
</blockquote>
<blockquote>
<p>By default, an operation object that has dependencies is not considered ready until all of its dependent operation objects have finished executing. Once the last dependent operation finishes, however, the operation object becomes ready and able to execute.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsoperation/1412992-ready?language=objc">官文</a>中说<code>ready</code>是根据当前任务“是否有依赖任务及该任务是否已完成”而定的。示例中的三个任务之间是并发且没有依赖关系的，所以按理它们被加入队列后，是否处在就绪状态是由队列或线程池状况来决定的，至于最终设置了优先级但失效了的问题，这不是我们能控制的了。</p>
<br/>

<p>鉴于此，为了更精确控制任务优先级，还是推荐使用接下来介绍的<code>qualityOfService</code>服务质量属性来指定任务优先级。这里只是说更精确的控制，不是说服务质量能完全保证任务按指定顺序执行，下面会具体介绍。</p>
<h4 id="2-4-服务质量"><a href="#2-4-服务质量" class="headerlink" title="2.4.服务质量"></a>2.4.服务质量</h4><p><code>qualityOfService</code>，这是在iOS 8后推出的新属性，通过设置服务质量来决定任务在队列中的优先级，NSOperation和NSOperationQueue都有这个属性。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs elm">typedef <span class="hljs-type">NS_ENUM</span>(<span class="hljs-type">NSInteger</span>, <span class="hljs-type">NSQualityOfService</span>) &#123;<br>    <span class="hljs-type">NSQualityOfServiceUserInteractive</span> = 0x21,<br>    <span class="hljs-type">NSQualityOfServiceUserInitiated</span> = 0x19,<br>    <span class="hljs-type">NSQualityOfServiceUtility</span> = 0x11,<br>    <span class="hljs-type">NSQualityOfServiceBackground</span> = 0x09,<br>    <span class="hljs-type">NSQualityOfServiceDefault</span> = -1<br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>UserInteractive</strong></li>
</ul>
<blockquote>
<p>Used for work directly involved in providing an interactive UI. For example, processing control events or drawing to the screen.</p>
</blockquote>
<p>用于涉及到UI交互的场景，例如处理点击事件或绘制图片到屏幕上。</p>
<ul>
<li><strong>UserInitiated</strong></li>
</ul>
<blockquote>
<p>Used for performing work that has been explicitly requested by the user, and for which results must be immediately presented in order to allow for further user interaction. For example, loading an email after a user has selected it in a message list.</p>
</blockquote>
<p>用于用户触发的、需要立刻返回结果的任务，例如用户点击邮件列表后立刻加载邮件内容。</p>
<ul>
<li><strong>Default</strong></li>
</ul>
<blockquote>
<p>Indicates no explicit quality of service information. Whenever possible, an appropriate quality of service is determined from available sources. Otherwise, some quality of service level between NSQualityOfServiceUserInteractive and NSQualityOfServiceUtility is used.</p>
</blockquote>
<p>默认值，表示未指明服务质量，系统会根据当前可用资源的状况，使用介于<code>UserInteractive</code>和<code>Utility</code>之间的某个优先级。</p>
<ul>
<li><strong>Utility</strong></li>
</ul>
<blockquote>
<p>Used for performing work which the user is unlikely to be immediately waiting for the results. This work may have been requested by the user or initiated automatically, and often operates at user-visible timescales using a non-modal progress indicator. For example, periodic content updates or bulk file operations, such as media import.</p>
</blockquote>
<p>用于不需要立刻返回结果的任务，比如周期性的更新内容，或者导入媒体文件。</p>
<ul>
<li><strong>Background</strong></li>
</ul>
<blockquote>
<p>Used for work that is not user initiated or visible. In general, a user is unaware that this work is even happening. For example, pre-fetching content, search indexing, backups, or syncing of data with external systems.</p>
</blockquote>
<p>后台任务，优先级最低，用于非用户触发的、不可见的任务，比如发起的网络请求、检索结果、同步数据。</p>
<br/>

<p><strong>一般来说</strong>，服务质量对应的优先级排序是：UserInteractive &gt; UserInitiated &gt; Default &gt; Utility &gt; Background。<br><br/></p>
<p>#示例：服务质量决定优先级</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application<br>didFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    [<span class="hljs-keyword">self</span> operationServiceQuality];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)operationServiceQuality&#123;<br>    <span class="hljs-built_in">NSBlockOperation</span> *op1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++1&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++2&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++3&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op4 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++4&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op5 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;+++5&quot;</span>);<br>    &#125;];<br>    <br>    op1.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceUserInitiated</span>;<br>    op2.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceDefault</span>;<br>    op3.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceUserInteractive</span>;<br>    op4.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceUtility</span>;<br>    op5.qualityOfService = <span class="hljs-built_in">NSQualityOfServiceBackground</span>;<br>    <br>    <span class="hljs-built_in">NSOperationQueue</span> *aQueue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    [aQueue addOperations:@[op1,op2,op3,op4,op5] waitUntilFinished:<span class="hljs-literal">NO</span>];<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">4</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">5</span><br></code></pre></td></tr></table></figure>

<p><strong>但是</strong>，多次运行同样一段代码之后，会得到这样的日志：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">4</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">5</span><br></code></pre></td></tr></table></figure>

<p>和这样的日志：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">+++</span><span class="hljs-comment">3</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">1</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">5</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">2</span><br><span class="hljs-literal">+++</span><span class="hljs-comment">4</span><br></code></pre></td></tr></table></figure>

<p><strong>结论：</strong>服务质量也不能保证任务的执行顺序。</p>
<br/>

<p>那咋办呢？为了精确控制任务的顺序，还是建议使用依赖关系，或者将任务放到最大并发数&#x3D;1的串行队列中。</p>
<h3 id="3-NSOperationQueue"><a href="#3-NSOperationQueue" class="headerlink" title="3.NSOperationQueue"></a>3.NSOperationQueue</h3><p>NSOperation 单独使用时，不具备开启新线程的能力，只有配合 NSOperationQueue 才能另辟新线程执行任务。配合使用时，NSOperation 相当于GCD中的任务，而 NSOperationQueue 则相当于GCD中的队列。将任务加入到队列中后，系统会自动将 NSOperationQueue 中的 NSOperation 取出来，在新线程中执行操作，不需要再手动调用start。</p>
<h4 id="3-1-两种队列"><a href="#3-1-两种队列" class="headerlink" title="3.1.两种队列"></a>3.1.两种队列</h4><ul>
<li>主队列：（任务会在主线程执行）</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">NSOperationQueue *mainQueue <span class="hljs-operator">=</span> [NSOperationQueue mainQueue]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>其他队列：（任务会放到子线程中执行）。</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-type">NSOperationQueue</span> <span class="hljs-operator">*</span>queue <span class="hljs-operator">=</span> [[<span class="hljs-type">NSOperationQueue</span> alloc] <span class="hljs-keyword">init</span>];<br></code></pre></td></tr></table></figure>

<h4 id="3-2-添加任务"><a href="#3-2-添加任务" class="headerlink" title="3.2.添加任务"></a>3.2.添加任务</h4><p>#示例3：-addOperation:(NSOperation *)op;</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)addOperation<br>&#123;<br>    <span class="hljs-type">NSOperationQueue</span> <span class="hljs-operator">*</span>queue <span class="hljs-operator">=</span> [[<span class="hljs-type">NSOperationQueue</span> alloc] <span class="hljs-keyword">init</span>];<br>    <br>    <span class="hljs-type">NSInvocationOperation</span> <span class="hljs-operator">*</span>op1 <span class="hljs-operator">=</span> [[<span class="hljs-type">NSInvocationOperation</span> alloc] <br>    initWithTarget:<span class="hljs-keyword">self</span> <br>    selector:<span class="hljs-meta">@selector</span>(run) <br>    object:<span class="hljs-literal">nil</span>];<br>    <br>    <span class="hljs-type">NSBlockOperation</span> <span class="hljs-operator">*</span>op2 <span class="hljs-operator">=</span> [<span class="hljs-type">NSBlockOperation</span> <br>    blockOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++执行block任务，</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++线程:%@&quot;</span>, <br>        [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    [queue addOperation:op1];<br>    [queue addOperation:op2];<br>&#125;<br><br><span class="hljs-operator">-</span> (void)run<br>&#123;<br>    <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++执行invocation operation任务，</span><br><span class="hljs-string">    <span class="hljs-subst">\n</span>++++线程:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主线程调用之后，输出日志：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs fortran">++++执行<span class="hljs-keyword">block</span>任务，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x604000268cc0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++执行invocation operation任务，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x604000268c80&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">4</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br></code></pre></td></tr></table></figure>

<p>#示例4：-addOperationWithBlock:(void (^)(void))block;</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-operator">-</span> (void)addBlockOperation<br>&#123;<br>    <span class="hljs-type">NSOperationQueue</span> <span class="hljs-operator">*</span>queue <span class="hljs-operator">=</span> [[<span class="hljs-type">NSOperationQueue</span> alloc] <span class="hljs-keyword">init</span>];<br>    <span class="hljs-comment">//最大并发数</span><br>    <span class="hljs-comment">//queue.maxConcurrentOperationCount = 1;</span><br>    <span class="hljs-comment">//queue.maxConcurrentOperationCount = 2;</span><br>    <br>    [queue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++执行block任务1，</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++线程:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    [queue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++执行block任务2，</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++线程:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    [queue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++执行block任务3，</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++线程:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    [queue addOperationWithBlock:<span class="hljs-operator">^</span>&#123;<br>        <span class="hljs-type">NSLog</span>(@<span class="hljs-string">&quot;++++执行block任务4，</span><br><span class="hljs-string">        <span class="hljs-subst">\n</span>++++线程:%@&quot;</span>, [<span class="hljs-type">NSThread</span> currentThread]);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主线程调用之后，输出日志：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs fortran">++++执行<span class="hljs-keyword">block</span>任务<span class="hljs-number">3</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x60000046c180&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++执行<span class="hljs-keyword">block</span>任务<span class="hljs-number">4</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x60000046c1c0&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">5</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++执行<span class="hljs-keyword">block</span>任务<span class="hljs-number">1</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x60400026a000&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">4</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++执行<span class="hljs-keyword">block</span>任务<span class="hljs-number">2</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x60400026a280&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">6</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br></code></pre></td></tr></table></figure>

<p>结合 NSOperationQueue 后，任务都在不同线程里并发执行，具备了开启新线程的能力。</p>
<h4 id="3-3-并发数"><a href="#3-3-并发数" class="headerlink" title="3.3.并发数"></a>3.3.并发数</h4><ul>
<li>-1，默认值，表示不进行限制，默认为并发执行；</li>
<li>&#x3D;0，阻塞、都不执行；</li>
<li>&#x3D;1，串行；</li>
<li>&gt;1，并发；</li>
</ul>
<p>上面#示例4中，如果让 maxConcurrentOperationCount &#x3D; 1，则队列为串行，输出日志如下：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs fortran">++++执行<span class="hljs-keyword">block</span>任务<span class="hljs-number">1</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x604000272240&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++执行<span class="hljs-keyword">block</span>任务<span class="hljs-number">2</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x604000272240&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++执行<span class="hljs-keyword">block</span>任务<span class="hljs-number">3</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x604000272240&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br>++++执行<span class="hljs-keyword">block</span>任务<span class="hljs-number">4</span>，<br>++++线程:&lt;NSThread: <span class="hljs-number">0</span>x604000272240&gt;&#123;<span class="hljs-keyword">number</span> = <span class="hljs-number">3</span>, <span class="hljs-keyword">name</span> = (null)&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出，队列中的任务按照串行的方式在执行。不设置或者&#x3D;2时，任务会并发执行，开启线程数量是由系统决定的，不需要我们来管理。</p>
<h4 id="3-4-依赖关系"><a href="#3-4-依赖关系" class="headerlink" title="3.4.依赖关系"></a>3.4.依赖关系</h4><p>#示例5：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)dependenceGo<br>&#123;<br>    <span class="hljs-built_in">NSOperationQueue</span> *queue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op1&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op2&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op3&quot;</span>);<br>    &#125;];<br>    <br>    [op1 addDependency:op2];<br>    [op2 addDependency:op3];<br>    <br>    [queue addOperation:op1];<br>    [queue addOperation:op2];<br>    [queue addOperation:op3];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出日志如下：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">执行op3</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">执行op2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">执行op1</span><br></code></pre></td></tr></table></figure>

<p>如果不添加依赖，则3个任务会并发执行，先后顺序不定。添加依赖后，3个任务则按照设定倒序执行。</p>
<h4 id="3-5-取消任务"><a href="#3-5-取消任务" class="headerlink" title="3.5.取消任务"></a>3.5.取消任务</h4><ul>
<li>取消单个任务</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">- (<span class="hljs-keyword">void</span>)cancel;<span class="hljs-comment">//NSOperation的方法 取消单个任务。</span><br></code></pre></td></tr></table></figure>

<p>作用：<code>建议</code>operation对象停止执行它包含着的任务。</p>
<blockquote>
<p>Advises the operation object that it should stop executing its task.</p>
</blockquote>
<p>注意这个方法并不会强制你的operation对象停止执行，它只是更新对象中的标记位来反映任务状态的变化。如果任务已经完成，则取消对它没有影响；如果是在某个队列中但尚未开始的任务，则执行取消操作时任务会从队列中移除。</p>
<blockquote>
<p>This method does not force your operation code to stop. Instead, it updates the object’s internal flags to reflect the change in state. If the operation has already finished executing, this method has no effect. Canceling an operation that is currently in an operation queue, but not yet executing, makes it possible to remove the operation from the queue sooner than usual.<br>In macOS 10.6 and later, if an operation is in a queue but waiting on unfinished dependent operations, those operations are subsequently ignored. Because it is already cancelled, this behavior allows the operation queue to call the operation’s start method sooner and clear the object out of the queue. If you cancel an operation that is not in a queue, this method immediately marks the object as finished. In each case, marking the object as ready or finished results in the generation of the appropriate KVO notifications.<br>In versions of macOS prior to 10.6, an operation object remains in the queue until all of its dependencies are removed through the normal processes. Thus, the operation must wait until all of its dependent operations finish executing or are themselves cancelled and have their start method called.<br>For more information on what you must do in your operation objects to support cancellation, see Responding to the Cancel Command.</p>
</blockquote>
<p>Xcode 方法详情面板中提到一点，在macOS10.6之前此取消方法并不会立刻将当前operation移出队列，而是要待到它所依赖的其他operation全部执行完，或者是都被取消并且执行完它们的start方法。而在macOS10.6之后，取消一个operation时会自动忽略它所依赖的其他operation，并且队列会提前调用当前operation的start方法，随后将其移出队列。如果你取消了一个尚未加入队列中的operation，则operation会立刻被标记为finished。</p>
<br/>

<p>上面这段话提示我们，<strong>即使operation被取消了，operation中的start方法仍会被调用</strong>。所以我们在重写operation的start方法时，要注意检测当前任务的<code>isCancelled</code>属性，如果任务已经被取消则应立刻返回，不再继续后续操作。</p>
<ul>
<li>取消所有任务</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">- (<span class="hljs-keyword">void</span>)cancelAllOperations;<span class="hljs-comment">//NSOperationQueue的方法，取消队列中的所有任务。</span><br></code></pre></td></tr></table></figure>

<p>作用：取消队列中所有的operation，包括尚未执行和已执行的operation。</p>
<blockquote>
<p>This method calls the cancel method on all operations currently in the queue.<br>Canceling the operations does not automatically remove them from the queue or stop those that are currently executing. For operations that are queued and waiting execution, the queue must still attempt to execute the operation before recognizing that it is canceled and moving it to the finished state. For operations that are already executing, the operation object itself must check for cancellation and stop what it is doing so that it can move to the finished state. In both cases, a finished (or canceled) operation is still given a chance to execute its completion block before it is removed from the queue.</p>
</blockquote>
<p>此方法会调用队列中的所有operation的cancel方法，但不会立刻将这些operation移出队列，也不会立刻停止正在执行的operation。对于尚未执行的任务，队列仍然会去尝试执行它们，即前面提到的继续执行start方法，直到检测到任务被取消并且其状态为finished。对于正在执行中的operation，其内部必须检查<code>isCancelled</code>属性是否为YES，如果是则需要立刻停止后续操作。这两种情况下，被取消或状态为finished的operation没有被立刻停止和移出队列，从而让它们还有机会执行自己的完成回调。</p>
<h4 id="3-6-暂停-x2F-恢复"><a href="#3-6-暂停-x2F-恢复" class="headerlink" title="3.6.暂停&#x2F;恢复"></a>3.6.暂停&#x2F;恢复</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)setSuspended:(<span class="hljs-type">BOOL</span>)b; <span class="hljs-comment">// NSOperationQueue中的方法</span><br></code></pre></td></tr></table></figure>

<p>作用：暂停或恢复当前队列中所有的operations。</p>
<blockquote>
<p>When the value of this property is NO, the queue actively starts operations that are in the queue and ready to execute. Setting this property to YES prevents the queue from starting any queued operations, but already executing operations continue to execute. You may continue to add operations to a queue that is suspended but those operations are not scheduled for execution until you change this property to NO.<br>Operations are removed from the queue only when they finish executing. However, in order to finish executing, an operation must first be started. Because a suspended queue does not start any new operations, it does not remove any operations (including cancelled operations) that are currently queued and not executing.<br>You may monitor changes to the value of this property using Key-value observing. Configure an observer to monitor the suspended key path of the operation queue.<br>The default value of this property is NO.</p>
</blockquote>
<p>该字段是队列的一个属性，当值为NO时，队列会start队列中已准备就绪的任务；值为YES时，队列会暂时停止start队列中尚未执行的任务，已经在执行的任务会继续执行。已经被暂停的队列再往其中添加任务时，这些任务也会被暂停，直到暂停状态解除。<br><br/></p>
<p>operation只有在finished状态时才会从队列中出列，要想让一个任务finished，你必须先start此任务；而暂停状态的队列并不会start任何新的任务，所以队列也就不会移除任何任务，包括已经被cancel的任务。<br><br/></p>
<p>这句话隐含的场景是：一个已经被暂停的队列中有N个任务，其中任务A还在排队中尚未开始执行，此时对任务A执行cancel方法，则任务A不会出列。这是因为此时队列在暂停状态，任务A又没开始执行，所以其start方法也就不会被调用，isFinished状态也就还不是YES，因此也就不会出列~</p>
<br/>

<p><strong>小结</strong>：对于上面三个方法，可以这么简单的理解，operation必须跑起来才能更新和检测自己的isCanceled及isFinished状态，从而决定自己是不是该取消和出列。</p>
<h3 id="4-实现Group任务"><a href="#4-实现Group任务" class="headerlink" title="4.实现Group任务"></a>4.实现Group任务</h3><p>GCD中提供了<code>dispatch_group</code>以便将多个任务组合在一起，同时可以在这些任务执行完成后通过<code>dispatch_group_notify</code>的block执行某些特殊任务。NSOperation并没有<code>Group</code>相关字眼的接口，但是我们仍然可以在NSOperation已有接口的基础上变相实现此功能。</p>
<h4 id="4-1-通过依赖关系"><a href="#4-1-通过依赖关系" class="headerlink" title="4.1.通过依赖关系"></a>4.1.通过依赖关系</h4><p>思路：给封装了最后任务的 Operation 设置依赖关系，使其依赖于前面的所有任务。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)monitorGroupTasks<br>&#123;<br>    <span class="hljs-built_in">NSOperationQueue</span> *queue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op1 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op1&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op2 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op2&quot;</span>);<br>    &#125;];<br>    <span class="hljs-built_in">NSBlockOperation</span> *op3 = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op3&quot;</span>);<br>    &#125;];<br>    <br>    <span class="hljs-comment">//最后需要执行的UI任务</span><br>    <span class="hljs-built_in">NSBlockOperation</span> *finOp = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        [[<span class="hljs-built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++最后执行UI任务~&quot;</span>);<br>        &#125;];<br>    &#125;];<br>    <br>    <span class="hljs-comment">//添加依赖，让finOp依赖于Grop中的所有任务</span><br>    [finOp addDependency:op1];<br>    [finOp addDependency:op2];<br>    [finOp addDependency:op3];<br>    <br>    [queue addOperations:@[finOp,op3,op2,op1] waitUntilFinished:<span class="hljs-literal">NO</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-literal">++++</span><span class="hljs-comment">执行op2</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">执行op1</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">执行op3</span><br><span class="hljs-literal">++++</span><span class="hljs-comment">最后执行UI任务~</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-通过completionBlock"><a href="#4-2-通过completionBlock" class="headerlink" title="4.2.通过completionBlock"></a>4.2.通过completionBlock</h4><p>思路：NSBlockOperation中的<code>addExecutionBlock</code>接口可以给<code>operation</code>添加额外任务并在异步线程中执行。同时NSOperation提供了<code>completionBlock</code>属性，我们可以利用它来在所有任务执行完成后执行某个特殊任务。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">- (<span class="hljs-type">void</span>)monitorGroupTasks<br>&#123;<br>    <span class="hljs-built_in">NSBlockOperation</span> *blockOpration = [<span class="hljs-built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op1，线程:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    &#125;];<br>    [blockOpration addExecutionBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op2，线程:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    &#125;];<br>    [blockOpration addExecutionBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++执行op3，线程:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>    &#125;];<br>    <br>    <span class="hljs-comment">//最后需要执行的UI任务</span><br>    [blockOpration setCompletionBlock:^&#123;<br>        [[<span class="hljs-built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++最后执行UI任务~，线程:%@&quot;</span>,[<span class="hljs-built_in">NSThread</span> currentThread]);<br>        &#125;];<br>    &#125;];<br><br>    <span class="hljs-comment">//开启任务</span><br>    <span class="hljs-built_in">NSOperationQueue</span> *queue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    [queue addOperation:blockOpration];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">++++执行op1，线程:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x600003594d40</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 3, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++执行op3，线程:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x6000035d9c80</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 5, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++执行op2，线程:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x6000035eeb40</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 4, name = (null)&#125;</span><span class="language-xml"></span><br><span class="language-xml">++++最后执行UI任务~，线程:<span class="hljs-tag">&lt;<span class="hljs-name">NSThread:</span> <span class="hljs-attr">0x6000035f5dc0</span>&gt;</span></span><span class="hljs-template-variable">&#123;number = 1, name = main&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-自定义NSOperation"><a href="#5-自定义NSOperation" class="headerlink" title="5.自定义NSOperation"></a>5.自定义NSOperation</h3><p>自定义时，需要重写 NSOperation 的<code>start</code>或<code>main</code>方法。</p>
<h4 id="5-1-重写main"><a href="#5-1-重写main" class="headerlink" title="5.1.重写main"></a>5.1.重写main</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">- (void)main<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsoperation/1407732-main?language=objc">Performs the receiver’s non-concurrent task</a>，执行非并发任务时重写此函数。<br><br/></p>
<p>NSOperation 默认是非并发的，在不加入 Queue 的情况下，通过调用 <code>-(void)start</code> 对象方法在当前线程执行任务时， 会一直阻塞当前线程，直到任务完成。<code>-(void)main</code>方法默认情况下不做任何事，执行完成后属性<code>isExecuting</code>会被置为 NO， 属性<code>isFinished</code>被置为 YES。我们可以重写此方法以实现自定义的任务。重写时不能调用<code>super</code>，也不需要手动创建 autorelease pool，因为系统已自动帮你实现。<br><br/></p>
<p>#示例6：自定义非并发 NSOperation</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lua">- (void)main<br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.isCancelled) <span class="hljs-keyword">return</span>;<br>    NSData *imageData = <span class="hljs-string">[[NSData alloc] initWithContentsOfURL:</span><br><span class="hljs-string">    [NSURL URLWithString:_mUrlStr]]</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.isCancelled) &#123;<br>        imageData = <span class="hljs-literal">nil</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.isCancelled) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:@selector(downloadFinishedWithData:)]) &#123;<br>        [_delegate downloadFinishedWithData:imageData];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-2-重写start"><a href="#5-2-重写start" class="headerlink" title="5.2.重写start"></a>5.2.重写start</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">- (<span class="hljs-type">void</span>)<span class="hljs-keyword">start</span>;<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsoperation/1416837-start?language=objc">Begins the execution of the operation</a>，If you are implementing a concurrent operation, you must override this method and use it to initiate your operation。<br><br/></p>
<p>执行并发任务时“必须”重写此方法。<br><br/></p>
<p>在没有被重写时，<code>start</code>方法的默认实现里会更新当前任务的执行状态，之后执行<code>-main</code>函数。此方法也会做一些检查，以确保当前任务能正常执行：如果任务已被取消或已完成，则<code>-start</code>方法直接返回并且不会再调用<code>-main</code>方法；如果任务正在执行或者尚未准备就绪，则会抛出异常；</p>
<blockquote>
<p>An operation is not considered ready to execute if it is still dependent on other operations that have not yet finished.</p>
</blockquote>
<p>重写<code>start</code>方法时也不能调用<code>super</code>函数，另外需要及时更新 isExecuting 和 isFinished 属性，并发出对应的 KVO 通知，因为在并发情况下系统不知道任务什么时候完成。自定义时，我们一般会将任务定义为异步执行，也就是说<code>start</code>函数返回了任务不一定就是完成了。 这个要你自己来控制，只有将 isFinished 置为 YES 时，operation 才算完成，才能出列和销毁。</p>
<h4 id="5-3-自定义示例"><a href="#5-3-自定义示例" class="headerlink" title="5.3.自定义示例"></a>5.3.自定义示例</h4><p>#示例7：自定义NSOperation子类</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//NetOperation.h</span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;Foundation/Foundation.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-string">&lt;UIKit/UIKit.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">NetOperation</span>;</span><br><span class="hljs-comment">//代理协议</span><br><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">NetOperationDelegate</span>&lt;<span class="hljs-title">NSObject</span>&gt;</span><br>- (<span class="hljs-type">void</span>)downloadFinishedWithData:(<span class="hljs-type">id</span>)data;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NetOperation</span> : <span class="hljs-title">NSOperation</span></span><br>- (<span class="hljs-keyword">instancetype</span>)initWithUrl:(<span class="hljs-built_in">NSString</span> *)url <br>delegate:(<span class="hljs-type">id</span>&lt;NetOperationDelegate&gt;)delegate;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//NetOperation.m</span><br><span class="hljs-meta">#import <span class="hljs-string">&quot;NetOperation.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">NetOperation</span>()</span><br><br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *mUrlStr;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">weak</span>) <span class="hljs-type">id</span>&lt;NetOperationDelegate&gt;delegate;<br><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSURLSessionDownloadTask</span> *dataTask;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NetOperation</span></span><br><span class="hljs-comment">//因为父类的属性是readonly的，重载时如果需要setter的话则需要手动合成。</span><br><span class="hljs-keyword">@synthesize</span> finished = _finished, executing = _executing;<br><br><span class="hljs-comment">// 这里需要实现KVO相关的方法，NSOperationQueue是通过KVO来判断任务状态的</span><br><br>- (<span class="hljs-type">void</span>)setFinished:(<span class="hljs-type">BOOL</span>)finished &#123;<br>    [<span class="hljs-keyword">self</span> willChangeValueForKey:<span class="hljs-string">@&quot;isFinished&quot;</span>];<br>    _finished = finished;<br>    [<span class="hljs-keyword">self</span> didChangeValueForKey:<span class="hljs-string">@&quot;isFinished&quot;</span>];<br>&#125;<br><br>- (<span class="hljs-type">void</span>)setExecuting:(<span class="hljs-type">BOOL</span>)executing &#123;<br>    [<span class="hljs-keyword">self</span> willChangeValueForKey:<span class="hljs-string">@&quot;isExecuting&quot;</span>];<br>    _executing = executing;<br>    [<span class="hljs-keyword">self</span> didChangeValueForKey:<span class="hljs-string">@&quot;isExecuting&quot;</span>];<br>&#125;<br><br>- (<span class="hljs-type">BOOL</span>)isAsynchronous&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-keyword">instancetype</span>)initWithUrl:(<span class="hljs-built_in">NSString</span> *)url<br>delegate:(<span class="hljs-type">id</span>&lt;NetOperationDelegate&gt;)delegate&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) &#123;<br>        _delegate = delegate;<br>        _mUrlStr = url;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)dealloc&#123;<br>    _delegate = <span class="hljs-literal">nil</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -重载start方法 实现业务需求</span><br>- (<span class="hljs-type">void</span>)start &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.isCancelled) &#123;<br>            <span class="hljs-keyword">self</span>.finished = <span class="hljs-literal">YES</span>;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        [<span class="hljs-keyword">self</span> main];<br>        <span class="hljs-keyword">self</span>.executing = <span class="hljs-literal">YES</span>;<br>    &#125;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)cancel &#123;<br>    <span class="hljs-keyword">@synchronized</span> (<span class="hljs-keyword">self</span>) &#123;<br>        [<span class="hljs-variable language_">super</span> cancel];<br>        <span class="hljs-comment">// 如果正在执行中则表示已经start过，可以将isFinished设为yes</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.isExecuting) &#123;<br>            <span class="hljs-keyword">self</span>.finished = <span class="hljs-literal">YES</span>;<br>            <span class="hljs-keyword">self</span>.executing = <span class="hljs-literal">NO</span>;<br>        &#125;<br>        [_dataTask cancel];<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark -BUSINESS</span><br>-(<span class="hljs-type">void</span>)main&#123;<br>    <span class="hljs-built_in">NSURLSession</span> *session = [<span class="hljs-built_in">NSURLSession</span> sharedSession];<br>    __<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;<br>    _dataTask = [session downloadTaskWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:_mUrlStr]<br>    completionHandler:^(<span class="hljs-built_in">NSURL</span> *location,<span class="hljs-built_in">NSURLResponse</span> *response, <span class="hljs-built_in">NSError</span> *error) &#123;<br>        <span class="hljs-keyword">if</span> (!error) &#123;<br>            __<span class="hljs-keyword">strong</span> <span class="hljs-keyword">typeof</span>(weakSelf) strongSelf = weakSelf;<br>            <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-built_in">NSData</span> dataWithContentsOfFile:location.path];<br>            strongSelf.finished = <span class="hljs-literal">YES</span>;<br>            strongSelf.executing = <span class="hljs-literal">NO</span>;<br>            <span class="hljs-keyword">if</span> ([strongSelf.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(downloadFinishedWithData:)]) &#123;<br>                [strongSelf.delegate downloadFinishedWithData:data];<br>            &#125;<br>        &#125;<br>    &#125;];<br>    <span class="hljs-comment">//开始任务</span><br>    [_dataTask resume];<br>&#125;<br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<p>导入头文件，创建并执行任务。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">-(<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application <br>willFinishLaunchingWithOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions<br>&#123;<br>    <span class="hljs-built_in">NSOperationQueue</span> *aQueue = [[<span class="hljs-built_in">NSOperationQueue</span> alloc] init];<br>    NetOperation *anOperation = [[NetOperation alloc] initWithUrl:<span class="hljs-string">@&quot;xxx&quot;</span> delegate:<span class="hljs-keyword">self</span>];<br>    [aQueue addOperation:anOperation];<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>&#125;<br><br>- (<span class="hljs-type">void</span>)downloadFinishedWithData:(<span class="hljs-type">id</span>)data<br>&#123;<br>    <span class="hljs-built_in">UIImage</span> *image = [<span class="hljs-built_in">UIImage</span> imageWithData:data];<br>    [[<span class="hljs-built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;++++++Reqest Finished!&quot;</span>);<br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure>

<p>本示例只是最简单的自定义，更复杂的可以参考AFN和SD中Operation相关的类~</p>
<hr>
<p>相关参考：</p>
<p>#<a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationObjects/OperationObjects.html#//apple_ref/doc/uid/TP40008091-CH101-SW9">©Apple-Operation Queues</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">#多线程</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>多线程：NSOperation</div>
      <div>http://yoursite.com/2017/11/17/nsoperation.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Davidli</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2017年11月17日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2017/11/21/lock.html" title="iOS中的八大锁">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">iOS中的八大锁</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2017/11/08/gcd.html" title="多线程：GCD">
                        <span class="hidden-mobile">多线程：GCD</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/davidli-" target="_blank" rel="nofollow noopener"><span>Davidlii</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>

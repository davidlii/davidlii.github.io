<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="This is Davidli&#39;s blog ~">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" type="image/ico" href="/image/logo.png"/> 
  
  <title>
    
      RAC-信号与订阅者 | Davidli
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">

  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  
<script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>

  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


<meta name="generator" content="Hexo 6.2.0"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Davidli</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Davidli</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">归档</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">标签</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">关于</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Davidli</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">归档</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">标签</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">关于</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>RAC-信号与订阅者</h2>
  <p class="post-date">2019-05-25</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h3 id="一-信号"><a href="#一-信号" class="headerlink" title="一.信号"></a>一.信号</h3><h4 id="1-信号是啥"><a href="#1-信号是啥" class="headerlink" title="1.信号是啥"></a>1.信号是啥</h4><p><a target="_blank" rel="noopener" href="https://github.com/ReactiveCocoa/ReactiveObjC/blob/master/Documentation/FrameworkOverview.md">RAC文档</a> 中关于<code>RACSignal</code>的描述:</p>
<blockquote>
<p>A signal, represented by the RACSignal class, is a push-driven stream.<br>Signals generally represent data that will be delivered in the future. As work is performed or data is received, values are sent on the signal, which pushes them out to any subscribers. Users must subscribe to a signal in order to access its values.</p>
</blockquote>
<ul>
<li>信号是一种 “推送” 类型的流。</li>
<li>信号代表着将来要传输的数据，值通过信号传递给订阅者；</li>
<li>用户须订阅信号才能接收到这些值。</li>
</ul>
<h4 id="2-冷热信号"><a href="#2-冷热信号" class="headerlink" title="2.冷热信号"></a>2.冷热信号</h4><p>信号分为<code>冷信号</code>和<code>热信号</code>两种：</p>
<ul>
<li>冷信号是被动的，被订阅之后才能发送消息；</li>
<li>热信号是主动的，即使未被订阅也能不断推送新消息；</li>
<li>冷信号只能1-1，对应一个订阅者，当有新订阅者时消息会重新发送一遍；</li>
<li>热信号可以1-N，可以有多个订阅者，信号可与多个订阅者共享信息；</li>
</ul>
<h5 id="2-1-冷信号"><a href="#2-1-冷信号" class="headerlink" title="#2.1.冷信号"></a>#2.1.冷信号</h5><ul>
<li>RACDynamicSignal</li>
<li>RACEmptySignal</li>
<li>RACErrorSignal</li>
<li>RACReturnSignal</li>
<li>RACChannelTerminal</li>
</ul>
<h5 id="2-2-热信号"><a href="#2-2-热信号" class="headerlink" title="#2.2.热信号"></a>#2.2.热信号</h5><ul>
<li>RACSubject</li>
<li>RACBehaviorSubject</li>
<li>RACGroupedSignal</li>
<li>RACReplaySubject</li>
</ul>
<h3 id="二-订阅者"><a href="#二-订阅者" class="headerlink" title="二.订阅者"></a>二.订阅者</h3><p>关于<code>RACSubscriber</code>的描述:</p>
<blockquote>
<p>A subscriber is anything that is waiting or capable of waiting for events from a signal. Within RAC, a subscriber is represented as any object that conforms to the RACSubscriber protocol.</p>
</blockquote>
<blockquote>
<p>Subscriptions retain their signals, and are automatically disposed of when the signal completes or errors. Subscriptions can also be disposed of manually.</p>
</blockquote>
<ul>
<li>订阅者表示正在等待信号发送事件的对象。</li>
<li>当信号有新数据时，通过这个订阅者发送新值。</li>
<li>订阅者在信号发送完成或者错误事件时会自动销毁。</li>
</ul>
<hr>
<p>这些关于<code>信号</code>与<code>订阅者</code>的描述很容易让人联想到<code>APNs</code>，两者机制很相似：</p>
<ul>
<li>iOS设备提前注册推送服务（订阅）；</li>
<li>苹果的推送服务器推送消息（事件）；</li>
<li>iOS设备接收到消息并处理自己的业务（响应）。</li>
</ul>
<p>这里，iOS设备就是订阅者，苹果的 APNs 服务作为一个整体而被视为信号流。二者是 N 对 1 的关系。</p>
<h3 id="三-冷信号解读"><a href="#三-冷信号解读" class="headerlink" title="三.冷信号解读"></a>三.冷信号解读</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, strong) id&lt;RACSubscriber&gt; subscriber;</span><br><span class="line"></span><br><span class="line">- (void)coldSignal &#123;</span><br><span class="line">    //1.创建信号</span><br><span class="line">    RACSignal *s1 = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        //^didSubscribe中执行任务</span><br><span class="line">        </span><br><span class="line">        _subscriber = subscriber;</span><br><span class="line">        //[subscriber sendError:];</span><br><span class="line">        //[subscriber sendCompleted];</span><br><span class="line">        </span><br><span class="line">        return [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">            //清理资源</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">    //2.订阅信号</span><br><span class="line">    [s1 subscribeNext:^(id x) &#123;</span><br><span class="line">        //4.接收数据</span><br><span class="line">        NSLog(@&quot;+++received value1:%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    //3.订阅信号</span><br><span class="line">    [s1 subscribeNext:^(id x) &#123;</span><br><span class="line">        //5.接收数据</span><br><span class="line">        NSLog(@&quot;+++received value2:%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    [_subscriber sendNext:@&quot;x&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+++received value2:x</span><br></pre></td></tr></table></figure>

<h4 id="1-创建信号"><a href="#1-创建信号" class="headerlink" title="1.创建信号"></a>1.创建信号</h4><p>#1.1.类方法:</p>
<p>&amp;emsp;</p>
<p>调用<code>RACSignal</code>的类方法创建一个信号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *s1 = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        //^didSubscribe中执行任务</span><br><span class="line">        return [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">            //清理资源</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>

<p>此方法的定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/// Creates a new signal. This is the preferred way to create a new signal</span><br><span class="line">/// operation or behavior.</span><br><span class="line">///</span><br><span class="line">/// Events can be sent to new subscribers immediately in the `didSubscribe`</span><br><span class="line">/// block, but the subscriber will not be able to dispose of the signal until</span><br><span class="line">/// a RACDisposable is returned from `didSubscribe`. In the case of infinite</span><br><span class="line">/// signals, this won&#x27;t _ever_ happen if events are sent immediately.</span><br><span class="line">///</span><br><span class="line">/// To ensure that the signal is disposable, events can be scheduled on the</span><br><span class="line">/// +[RACScheduler currentScheduler] (so that they&#x27;re deferred, not sent</span><br><span class="line">/// immediately), or they can be sent in the background. The RACDisposable</span><br><span class="line">/// returned by the `didSubscribe` block should cancel any such scheduling or</span><br><span class="line">/// asynchronous work.</span><br><span class="line">///</span><br><span class="line">/// didSubscribe - Called when the signal is subscribed to. The new subscriber is</span><br><span class="line">///                passed in. You can then manually control the &lt;RACSubscriber&gt; by</span><br><span class="line">///                sending it -sendNext:, -sendError:, and -sendCompleted,</span><br><span class="line">///                as defined by the operation you&#x27;re implementing. This block</span><br><span class="line">///                should return a RACDisposable which cancels any ongoing work</span><br><span class="line">///                triggered by the subscription, and cleans up any resources or</span><br><span class="line">///                disposables created as part of it. When the disposable is</span><br><span class="line">///                disposed of, the signal must not send any more events to the</span><br><span class="line">///                `subscriber`. If no cleanup is necessary, return nil.</span><br><span class="line">///</span><br><span class="line">/// **Note:** The `didSubscribe` block is called every time a new subscriber</span><br><span class="line">/// subscribes. Any side effects within the block will thus execute once for each</span><br><span class="line">/// subscription, not necessarily on one thread, and possibly even</span><br><span class="line">/// simultaneously!</span><br><span class="line">+ (RACSignal&lt;ValueType&gt; *)createSignal:(RACDisposable * _Nullable (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe RAC_WARN_UNUSED_RESULT;</span><br></pre></td></tr></table></figure>

<p>方法的参数为<code>didSubscribe</code>，返回值为新的信号。<br>&amp;emsp;</p>
<p>#1.2.didSubscribe:<br>&amp;emsp;</p>
<p><code>didSubscribe</code>是创建信号时由我们定义的用于处理业务的block，信号也是在这里发送数据、错误和完成事件；<br>&amp;emsp;</p>
<p><code>didSubscribe</code>的参数为实现了<code>RACSubscriber</code>协议的<code>订阅者</code>，在信号被订阅后可用于向订阅者发送数据；<br>&amp;emsp;</p>
<p><code>didSubscribe</code>的返回值是一个用于清理资源的<code>RACDisposable</code>对象，当没有资源需要清理时可返回 nil；<br>&amp;emsp;</p>
<p><code>didSubscribe</code>在创建信号时被作为参数传入并保存在<code>RACSignal</code>实例对象内(属性)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// The block to invoke for each subscriber.</span><br><span class="line">@property (nonatomic, copy, readonly) RACDisposable * (^didSubscribe)(id&lt;RACSubscriber&gt; subscriber);</span><br><span class="line"></span><br><span class="line">+ (RACSignal *)createSignal:(RACDisposable * (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe &#123;</span><br><span class="line"></span><br><span class="line">    RACDynamicSignal *signal = [[self alloc] init];</span><br><span class="line">    // 保存block为属性</span><br><span class="line">    signal-&gt;_didSubscribe = [didSubscribe copy];</span><br><span class="line">	</span><br><span class="line">    return [signal setNameWithFormat:@&quot;+createSignal:&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>#1.3.冷信号<br>&amp;emsp;</p>
<p>执行完上面的类方法之后，我们已经成功创建了一个<code>信号</code>。但新创建的信号默认是<code>冷</code>信号，还不能立刻用它发送数据，因为：<br>&amp;emsp;</p>
<p>发送数据需要用到<code>sendNext</code>方法；<br>&amp;emsp;</p>
<p><code>sendNext</code>方法的调用者为<code>subscriber</code>，即订阅者；<br>&amp;emsp;</p>
<p>所以，我们还缺少一个订阅者，这就是所谓的<strong>冷信号需要被订阅之后才能发送数据</strong>。</p>
<h4 id="2-订阅信号"><a href="#2-订阅信号" class="headerlink" title="2.订阅信号"></a>2.订阅信号</h4><p>订阅信号的语句为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//2.订阅信号</span><br><span class="line">[s1 subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;+++received value:%@&quot;,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>其中<code>subscribeNext:</code>方法的实现为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock &#123;</span><br><span class="line">	NSCParameterAssert(nextBlock != NULL);</span><br><span class="line">	// 1.创建订阅者</span><br><span class="line">	RACSubscriber *o = [RACSubscriber subscriberWithNext:nextBlock error:NULL completed:NULL];</span><br><span class="line">	// 2.调用 ^didSubscribe</span><br><span class="line">	return [self subscribe:o];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>#2.1.保存事件的block<br>&amp;emsp;</p>
<p>首先，<code>subscribeNext:</code>内会创建一个订阅者，且冷信号每次被订阅都会创建新的订阅者，<strong>多次订阅只会保留最后一次订阅关系</strong>，即信号被多次订阅后，<code>sendNext:</code>通过订阅者发送数据时，只有最后一个订阅者会收到数据回调；<br>&amp;emsp;</p>
<p>其次，方法将传进来的<code>next</code>、<code>error</code>、<code>completed</code> 三个 block 保存到此订阅者对象中（属性）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@interface RACSubscriber ()</span><br><span class="line"></span><br><span class="line">// These callbacks should only be accessed while synchronized on self.</span><br><span class="line">@property (nonatomic, copy) void (^next)(id value);</span><br><span class="line">@property (nonatomic, copy) void (^error)(NSError *error);</span><br><span class="line">@property (nonatomic, copy) void (^completed)(void);</span><br><span class="line"></span><br><span class="line">@property (nonatomic, strong, readonly) RACCompoundDisposable *disposable;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">+ (instancetype)subscriberWithNext:(void (^)(id x))next</span><br><span class="line">                             error:(void (^)(NSError *error))error</span><br><span class="line">                         completed:(void (^)(void))completed </span><br><span class="line">&#123;</span><br><span class="line">	RACSubscriber *subscriber = [[self alloc] init];</span><br><span class="line"></span><br><span class="line">	subscriber-&gt;_next = [next copy];</span><br><span class="line">	subscriber-&gt;_error = [error copy];</span><br><span class="line">	subscriber-&gt;_completed = [completed copy];</span><br><span class="line"></span><br><span class="line">	return subscriber;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这三个 block 分别代表了信号的三种事件：</p>
<ul>
<li>next 表示将要发送数据；</li>
<li>error 表示出现错误；</li>
<li>completed 表示信号已完成。</li>
</ul>
<p>调用完<code>subscribeNext:</code>方法后，就成功创建了订阅者对象，也就是之前的<code>didSubscribe</code> block 所缺少的那个参数。<br>&amp;emsp;</p>
<p>至此，信号具备了发送数据的完整前提条件!<br>&amp;emsp;</p>
<p>#2.2.调用didSubscribe block<br>&amp;emsp;</p>
<p>订阅者创建完成后，方法内部会继续调用 self.didSubscribe(subscriber)，传入刚才的订阅者作为参数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)subscribe:(id&lt;RACSubscriber&gt;)subscriber &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	if (self.didSubscribe != NULL) &#123;</span><br><span class="line">            RACDisposable *schedulingDisposable = [RACScheduler.subscriptionScheduler schedule:^&#123;</span><br><span class="line">                //调用之前创建和保存起来的*didSubscribe* block，传入订阅者参数</span><br><span class="line">                RACDisposable *innerDisposable = self.didSubscribe(subscriber);</span><br><span class="line">                [disposable addDisposable:innerDisposable];</span><br><span class="line">            &#125;];</span><br><span class="line">		[disposable addDisposable:schedulingDisposable];</span><br><span class="line">	&#125;</span><br><span class="line">	return disposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里 self.didSubscribe 属性指向的正是之前在创建信号时我们自定义的<code>didSubscribe</code>，所以 self.didSubscribe(subscriber) 就是调用我们自己的<code>didSubscribe</code> block。即<strong>订阅信号后，信号的<code>didSubscribe</code>会自动调用一次</strong>。</p>
<h4 id="3-发送消息"><a href="#3-发送消息" class="headerlink" title="3.发送消息"></a>3.发送消息</h4><p>订阅完成后自动创建了订阅者，接下来就可以向订阅者发送<code>事件</code>和<code>数据</code>了。上面说过信号内有三种消息：</p>
<ul>
<li>next</li>
<li>error</li>
<li>completed</li>
</ul>
<p>三种消息对应的接口分别为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/// Sends the next value to subscribers.</span><br><span class="line">///</span><br><span class="line">/// value - The value to send. This can be `nil`.</span><br><span class="line">- (void)sendNext:(nullable id)value;</span><br><span class="line"></span><br><span class="line">/// Sends the error to subscribers.</span><br><span class="line">///</span><br><span class="line">/// error - The error to send. This can be `nil`.</span><br><span class="line">///</span><br><span class="line">/// This terminates the subscription, and invalidates the subscriber (such that</span><br><span class="line">/// it cannot subscribe to anything else in the future).</span><br><span class="line">- (void)sendError:(nullable NSError *)error;</span><br><span class="line"></span><br><span class="line">/// Sends completed to subscribers.</span><br><span class="line">///</span><br><span class="line">/// This terminates the subscription, and invalidates the subscriber (such that</span><br><span class="line">/// it cannot subscribe to anything else in the future).</span><br><span class="line">- (void)sendCompleted;</span><br></pre></td></tr></table></figure>

<p>其实现为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (void)sendNext:(id)value &#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        void (^nextBlock)(id) = [self.next copy];</span><br><span class="line">        if (nextBlock == nil) return;</span><br><span class="line"></span><br><span class="line">        nextBlock(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)sendError:(NSError *)e &#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        void (^errorBlock)(NSError *) = [self.error copy];</span><br><span class="line">        [self.disposable dispose];</span><br><span class="line"></span><br><span class="line">        if (errorBlock == nil) return;</span><br><span class="line">        errorBlock(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)sendCompleted &#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        void (^completedBlock)(void) = [self.completed copy];</span><br><span class="line">        [self.disposable dispose];</span><br><span class="line"></span><br><span class="line">        if (completedBlock == nil) return;</span><br><span class="line">        completedBlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向订阅者发送<code>next</code>、<code>error</code>、<code>completed</code>事件，实际上是调用之前保存在订阅者对象中的三种 block 属性。<br>&amp;emsp;</p>
<p><strong>注意</strong>：信号向订阅者发送了<code>error</code>或者<code>completed</code>后，订阅关系随即结束，订阅者后续不会再收到任何事件和数据。<br>&amp;emsp;</p>
<p>#冷信号使用示例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">@interface HelloRACController ()</span><br><span class="line">@property (nonatomic, strong) id&lt;RACSubscriber&gt; subscriber;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation HelloRACController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    //1.信号的使用</span><br><span class="line">    //1.1.创建信号，此时信号为冷信号，被订阅之后才能发送消息</span><br><span class="line">    RACSignal *s1 = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        </span><br><span class="line">        //当有订阅者订阅信号，就会调用此block</span><br><span class="line">        _subscriber = subscriber;</span><br><span class="line">        </span><br><span class="line">        //1.3.发送信号</span><br><span class="line">        [subscriber sendNext:@&quot;Hello from s1~&quot;];</span><br><span class="line">        </span><br><span class="line">        //回抛错误</span><br><span class="line">        [subscriber sendError:[NSError errorWithDomain:@&quot;NetError&quot; code:1022 userInfo:@&#123;@&quot;code&quot;:@(1022)&#125;]];</span><br><span class="line">        </span><br><span class="line">        //如果不再发送数据，发送信号完成</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        </span><br><span class="line">        //返回一个信号，内部会自动调用[RACDisposable disposable]取消订阅。</span><br><span class="line">        return [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">            NSLog(@&quot;++s1 Disposed~&quot;);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    //1.2.订阅信号(被订阅后，如果向订阅者发送了信号，则此时subscribeNext的block被调用)</span><br><span class="line">    [s1 subscribeNext:^(id x) &#123;</span><br><span class="line">        NSLog(@&quot;~~第1个订阅消息：%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [s1 subscribeNext:^(id x) &#123;</span><br><span class="line">        NSLog(@&quot;~~第2个订阅消息：%@&quot;,x);</span><br><span class="line">    &#125; error:^(NSError * error) &#123;</span><br><span class="line">        NSLog(@&quot;+++error:%@&quot;,error.description);</span><br><span class="line">    &#125; completed:^&#123;</span><br><span class="line">        NSLog(@&quot;++s1 completed&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [_subscriber sendNext:@&quot;Hello2 from s1~&quot;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~~第1个订阅消息：Hello from s1~</span><br><span class="line">++s1 Disposed~</span><br><span class="line">~~第2个订阅消息：Hello from s1~</span><br><span class="line">+++error:Error Domain=NetError Code=1022 &quot;(null)&quot; UserInfo=&#123;code=1022&#125;</span><br><span class="line">++s1 Disposed~</span><br></pre></td></tr></table></figure>

<p>结合日志来分析，有几点可以得到印证：<br>&amp;emsp;</p>
<p>1.调用完 [s1 subscribeNext:] 订阅信号之后，<code>s1</code>的 block 会立刻执行。<br>&amp;emsp;</p>
<p>2.订阅者调用 [subscriber sendNext:] 后订阅者的<code>subscribeNext</code> block 会立刻执行。同理调用 [subscriber sendError:] 或者 [subscriber sendCompleted] 后，对应的<code>error</code>和<code>completed</code>回调也会立刻执行。<br>&amp;emsp;</p>
<p>3.block 内调用 [subscriber sendError:] 或者 [subscriber sendCompleted] 之后，信号<code>s1</code>会立刻调用其<code>RACDisposable</code>的 block 清理资源。<br>&amp;emsp;</p>
<p>4.一旦信号调用<code>RACDisposable</code>之后，它后续将不能再接收任何事件。比如示例中第二个订阅者调用了 <code>sendError</code> 之后，s1 自动调用了<code>RACDisposable</code>，后续调用 <code>setCompleted</code> 时<code>completed</code>回调不再执行，并且后面的 [_subscriber sendNext:] 也不会有任何响应或日志输出。</p>
<h3 id="四-热信号解读"><a href="#四-热信号解读" class="headerlink" title="四.热信号解读"></a>四.热信号解读</h3><p>热信号本身不需要订阅也能发送消息，主要是因为它们一般都直接或间接地实现了<code>&lt;RACSubscriber&gt;</code>协议，此协议定义了以下方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@protocol RACSubscriber &lt;NSObject&gt;</span><br><span class="line">@required</span><br><span class="line"></span><br><span class="line">/// Sends the next value to subscribers.</span><br><span class="line">///</span><br><span class="line">/// value - The value to send. This can be `nil`.</span><br><span class="line">- (void)sendNext:(nullable id)value;</span><br><span class="line"></span><br><span class="line">/// Sends the error to subscribers.</span><br><span class="line">///</span><br><span class="line">/// error - The error to send. This can be `nil`.</span><br><span class="line">///</span><br><span class="line">/// This terminates the subscription, and invalidates the subscriber (such that</span><br><span class="line">/// it cannot subscribe to anything else in the future).</span><br><span class="line">- (void)sendError:(nullable NSError *)error;</span><br><span class="line"></span><br><span class="line">/// Sends completed to subscribers.</span><br><span class="line">///</span><br><span class="line">/// This terminates the subscription, and invalidates the subscriber (such that</span><br><span class="line">/// it cannot subscribe to anything else in the future).</span><br><span class="line">- (void)sendCompleted;</span><br><span class="line"></span><br><span class="line">/// Sends the subscriber a disposable that represents one of its subscriptions.</span><br><span class="line">///</span><br><span class="line">/// A subscriber may receive multiple disposables if it gets subscribed to</span><br><span class="line">/// multiple signals; however, any error or completed events must terminate _all_</span><br><span class="line">/// subscriptions.</span><br><span class="line">- (void)didSubscribeWithDisposable:(RACCompoundDisposable *)disposable;</span><br></pre></td></tr></table></figure>

<p>以上几个方法主要用来向订阅者发送数据或更新状态。<br>&amp;emsp;</p>
<p>热信号正是实现了此协议，才能在没有订阅者的情况下也能主动发送数据。以<code>RACSubject</code>为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/// A subject can be thought of as a signal that you can manually control by</span><br><span class="line">/// sending next, completed, and error.</span><br><span class="line">///</span><br><span class="line">/// They&#x27;re most helpful in bridging the non-RAC world to RAC, since they let you</span><br><span class="line">/// manually control the sending of events.</span><br><span class="line">@interface RACSubject&lt;ValueType&gt; : RACSignal&lt;ValueType&gt; &lt;RACSubscriber&gt;</span><br></pre></td></tr></table></figure>

<p>继承自<code>RACSignal</code>，说明它是一种信号；实现了<code>&lt;RACSubscriber&gt;</code>协议，说明它能在不被订阅的情况下主动发送数据。<br>&amp;emsp;</p>
<p>#示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)hotSignal &#123;</span><br><span class="line">    RACSubject *sub = [RACSubject subject];</span><br><span class="line">    [sub sendNext:@&quot;1&quot;];</span><br><span class="line">    </span><br><span class="line">    [sub subscribeNext:^(id x) &#123;</span><br><span class="line">        NSLog(@&quot;+++sub1:%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [sub sendNext:@&quot;2&quot;];</span><br><span class="line">    </span><br><span class="line">    [sub subscribeNext:^(id x) &#123;</span><br><span class="line">        NSLog(@&quot;+++sub2:%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [sub sendNext:@&quot;3&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+++sub1:2</span><br><span class="line">+++sub1:3</span><br><span class="line">+++sub2:3</span><br></pre></td></tr></table></figure>

<p>1.从<code>[sub sendNext:@&quot;1&quot;]</code>可以看到，<code>sub</code>对象不需要被订阅也能发送消息，只是此时没订阅者接收消息而已；<br>&amp;emsp;</p>
<p>2.当订阅了两次之后，发送数据3时收到两次回调，也说明了热信号是1~N的关系，信号与N个订阅者共享信息。<br>&amp;emsp;</p>
<p>下面将介绍<code>RACSubject</code>的实现：</p>
<h4 id="1-创建信号-1"><a href="#1-创建信号-1" class="headerlink" title="1.创建信号"></a>1.创建信号</h4><p>创建方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RACSubject *sub = [RACSubject subject];</span><br></pre></td></tr></table></figure>

<p>其实现为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)subject &#123;</span><br><span class="line">    return [[self alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self == nil) return nil;</span><br><span class="line"></span><br><span class="line">    _disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line">    _subscribers = [[NSMutableArray alloc] initWithCapacity:1];</span><br><span class="line">    </span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这个<code>_subscribers</code>数组，后面会有重要作用。</p>
<h4 id="2-订阅信号-1"><a href="#2-订阅信号-1" class="headerlink" title="2.订阅信号"></a>2.订阅信号</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sub subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;+++sub1:%@&quot;,x);</span><br><span class="line">&#125;];</span><br><span class="line">[sub subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;+++sub2:%@&quot;,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p><code>subscribeNext:</code>的实现为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock &#123;</span><br><span class="line">    NSCParameterAssert(nextBlock != NULL);</span><br><span class="line">    </span><br><span class="line">    RACSubscriber *o = [RACSubscriber subscriberWithNext:nextBlock error:NULL completed:NULL];</span><br><span class="line">    return [self subscribe:o];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和冷信号一样，这里会先创建一个订阅者对象，随后调用<code>subscribe:</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)subscribe:(id&lt;RACSubscriber&gt;)subscriber &#123;</span><br><span class="line">    NSCParameterAssert(subscriber != nil);</span><br><span class="line"></span><br><span class="line">    RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line">    subscriber = [[RACPassthroughSubscriber alloc] initWithSubscriber:subscriber signal:self disposable:disposable];</span><br><span class="line"></span><br><span class="line">    NSMutableArray *subscribers = self.subscribers;</span><br><span class="line">    @synchronized (subscribers) &#123;</span><br><span class="line">        // 将订阅者添加进数组</span><br><span class="line">        [subscribers addObject:subscriber];</span><br><span class="line">    &#125;</span><br><span class="line">    // 略。。</span><br><span class="line">    return disposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法将传进来的订阅者添加进之前提到的<code>subscribers</code>数组中，等待随后的调用。</p>
<h4 id="3-发送消息-1"><a href="#3-发送消息-1" class="headerlink" title="3.发送消息"></a>3.发送消息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[sub sendNext:@&quot;1&quot;];</span><br></pre></td></tr></table></figure>

<p><code>sendNext:</code>的实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)sendNext:(id)value &#123;</span><br><span class="line">    [self enumerateSubscribersUsingBlock:^(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:value];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)enumerateSubscribersUsingBlock:(void (^)(id&lt;RACSubscriber&gt; subscriber))block &#123;</span><br><span class="line">    NSArray *subscribers;</span><br><span class="line">    @synchronized (self.subscribers) &#123;</span><br><span class="line">        subscribers = [self.subscribers copy];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (id&lt;RACSubscriber&gt; subscriber in subscribers) &#123;</span><br><span class="line">        block(subscriber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sub</code>对象从<code>subscribers</code>数组中取出所有的订阅者，依次向其发送数据~</p>
<h4 id="4-用作代理"><a href="#4-用作代理" class="headerlink" title="4.用作代理"></a>4.用作代理</h4><p><code>RACSubject</code>的实现并不难理解，它与订阅者之间是<code>1~N</code>的关系并可主动发送消息，常用来代替OC中的<code>delegate</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewControllerII : UIViewController</span><br><span class="line"></span><br><span class="line">@property (nonatomic, strong) RACSubject *delegate;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewControllerII</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (IBAction)onDismiss:(id)sender</span><br><span class="line">&#123;</span><br><span class="line">    //RAC回调</span><br><span class="line">    if (self.delegate) &#123;</span><br><span class="line">        [self.delegate sendNext:@&quot;++ViewControllerII Closed~&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">    //关闭</span><br><span class="line">    [self.navigationController popViewControllerAnimated:YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在某个页面设置代理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (IBAction)onAction2:(id)sender &#123;</span><br><span class="line">    ViewControllerII *controller = [[UIStoryboard storyboardWithName:@&quot;Main&quot; bundle:nil]</span><br><span class="line">                                    instantiateViewControllerWithIdentifier:@&quot;ViewControllerII&quot;];</span><br><span class="line">    //设置代理信号</span><br><span class="line">    controller.delegate = [RACSubject subject];</span><br><span class="line">    </span><br><span class="line">    //订阅代理</span><br><span class="line">    [controller.delegate subscribeNext:^(id x) &#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.navigationController pushViewController:controller animated:YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="五-组播"><a href="#五-组播" class="headerlink" title="五.组播"></a>五.组播</h3><blockquote>
<p>Signals are cold by default, meaning that they start doing work each time a new subscription is added. This behavior is usually desirable, because it means that data will be freshly recalculated for each subscriber, but it can be problematic if the signal has side effects or the work is expensive (for example, sending a network request).</p>
</blockquote>
<p>信号有多个订阅者时，每被订阅一次其<code>block</code>都自动触发一次，这种情况有时会有<code>副作用</code>。比如<code>block</code>内封装了耗时操作，每次订阅都单独触发一遍显然浪费性能。理想的情况是多个订阅者都订阅完成后，<code>block</code>只触发一次而所有订阅者都收到回调。这种场景RAC考虑到了，此时<code>RACMulticastConnection</code>就派上用场了。</p>
<blockquote>
<p>A multicast connection encapsulates the idea of sharing one subscription to a signal to many subscribers. This is most often needed if the subscription to the underlying signal involves side-effects or shouldn’t be called more than once.</p>
</blockquote>
<p>组播，用于在多个订阅者之间共享对某个信号的订阅，在发送者和每一订阅者之间实现<code>1~N</code>的连接。</p>
<h4 id="1-示例"><a href="#1-示例" class="headerlink" title="1.示例"></a>1.示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    RACSignal *s2 = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@&quot;Hello from s2~&quot;];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        return [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">            NSLog(@&quot;++s2 Disposed~&quot;);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    //连接类(单次订阅之后不会立刻收到回调，所有订阅完成后调用 connect 时才会先后触发)</span><br><span class="line">    RACMulticastConnection *cnn = [s2 publish];</span><br><span class="line">    </span><br><span class="line">    //订阅连接类信号</span><br><span class="line">    [cnn.signal subscribeNext:^(id x) &#123;</span><br><span class="line">        NSLog(@&quot;~~第1个订阅消息：%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    [cnn.signal subscribeNext:^(id x) &#123;</span><br><span class="line">        NSLog(@&quot;~~第2个订阅消息：%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    [cnn.signal subscribeNext:^(id x) &#123;</span><br><span class="line">        NSLog(@&quot;~~第3个订阅消息：%@&quot;,x);</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    [cnn connect];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~~第1个订阅消息：Hello from s2~</span><br><span class="line">~~第2个订阅消息：Hello from s2~</span><br><span class="line">~~第3个订阅消息：Hello from s2~</span><br><span class="line">++s2 Disposed~</span><br></pre></td></tr></table></figure>

<p>如果在订阅者的回调中打断点你就会发现，调用<code>[cnn connect]</code>后三个 block 都触发了且依次触发。</p>
<h4 id="2-实现"><a href="#2-实现" class="headerlink" title="2.实现"></a>2.实现</h4><ul>
<li>创建多播实例</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RACMulticastConnection *cnn = [s2 publish];</span><br></pre></td></tr></table></figure>

<p>来看看<code>publish</code>都做了什么：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (RACMulticastConnection *)publish &#123;</span><br><span class="line">    RACSubject *subject = [[RACSubject subject] setNameWithFormat:@&quot;[%@] -publish&quot;, self.name];</span><br><span class="line">    RACMulticastConnection *connection = [self multicast:subject];</span><br><span class="line">    return connection;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (RACMulticastConnection *)multicast:(RACSubject *)subject &#123;</span><br><span class="line">    [subject setNameWithFormat:@&quot;[%@] -multicast: %@&quot;, self.name, subject.name];</span><br><span class="line">    RACMulticastConnection *connection = [[RACMulticastConnection alloc] initWithSourceSignal:self subject:subject];</span><br><span class="line">    return connection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>publish</code>内创建了一个<code>RACSubject</code>对象，随后将其作为参数传入<code>RACMulticastConnection</code>的构造函数中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@interface RACMulticastConnection () &#123;</span><br><span class="line">    RACSubject *_signal;</span><br><span class="line">    int32_t volatile _hasConnected;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, readonly, strong) RACSignal *sourceSignal;</span><br><span class="line">@property (strong) RACSerialDisposable *serialDisposable;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithSourceSignal:(RACSignal *)source subject:(RACSubject *)subject &#123;</span><br><span class="line">    NSCParameterAssert(source != nil);</span><br><span class="line">    NSCParameterAssert(subject != nil);</span><br><span class="line"></span><br><span class="line">    self = [super init];</span><br><span class="line"></span><br><span class="line">    _sourceSignal = source;</span><br><span class="line">    _serialDisposable = [[RACSerialDisposable alloc] init];</span><br><span class="line">    _signal = subject;</span><br><span class="line">    </span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数将源信号<code>s2</code>保存为<code>sourceSignal</code>，将刚才创建的<code>subject</code>保存为<code>signal</code>，之后返回一个多播实例。</p>
<ul>
<li>订阅信号</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[cnn.signal subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;~~第1个订阅消息：%@&quot;,x);</span><br><span class="line">&#125;];</span><br><span class="line">    </span><br><span class="line">[cnn.signal subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;~~第2个订阅消息：%@&quot;,x);</span><br><span class="line">&#125;];</span><br><span class="line">    </span><br><span class="line">[cnn.signal subscribeNext:^(id x) &#123;</span><br><span class="line">    NSLog(@&quot;~~第3个订阅消息：%@&quot;,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>这里订阅的不再是<code>s2</code>，而是刚才的<code>RACSubject</code>类型属性<code>signal</code>，此订阅的内部实现为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// RACSignal.m</span><br><span class="line">- (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock &#123;</span><br><span class="line">    NSCParameterAssert(nextBlock != NULL);</span><br><span class="line">    </span><br><span class="line">    RACSubscriber *o = [RACSubscriber subscriberWithNext:nextBlock error:NULL completed:NULL];</span><br><span class="line">    return [self subscribe:o];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// RACSubject.m</span><br><span class="line">- (RACDisposable *)subscribe:(id&lt;RACSubscriber&gt;)subscriber &#123;</span><br><span class="line">    NSCParameterAssert(subscriber != nil);</span><br><span class="line"></span><br><span class="line">    RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line">    subscriber = [[RACPassthroughSubscriber alloc] initWithSubscriber:subscriber signal:self disposable:disposable];</span><br><span class="line"></span><br><span class="line">    NSMutableArray *subscribers = self.subscribers;</span><br><span class="line">    @synchronized (subscribers) &#123;</span><br><span class="line">        // 将订阅者保存到数组中</span><br><span class="line">        [subscribers addObject:subscriber];</span><br><span class="line">    &#125;</span><br><span class="line">    // 略。。。</span><br><span class="line"></span><br><span class="line">    return disposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即订阅<code>signal</code>时，先创建新的订阅者，随后将订阅者添加到多播实例的数组<code>subscribers</code>中。此时还没有调用<code>s2</code>的<code>didSubscribe</code>!</p>
<ul>
<li>连接 connect</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[cnn connect];</span><br></pre></td></tr></table></figure>

<p><code>connect</code>的内部实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)connect &#123;</span><br><span class="line">    BOOL shouldConnect = OSAtomicCompareAndSwap32Barrier(0, 1, &amp;_hasConnected);</span><br><span class="line"></span><br><span class="line">    if (shouldConnect) &#123;</span><br><span class="line">        // 这里的</span><br><span class="line">        self.serialDisposable.disposable = [self.sourceSignal subscribe:_signal];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return self.serialDisposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了<code>self.sourceSignal</code>的<code>subscribe</code>，参数为之前 RACSubject 类型的属性<code>_signal</code>（信号订阅了信号）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (RACDisposable *)subscribe:(id&lt;RACSubscriber&gt;)subscriber &#123;</span><br><span class="line">    NSCParameterAssert(subscriber != nil);</span><br><span class="line"></span><br><span class="line">    RACCompoundDisposable *disposable = [RACCompoundDisposable compoundDisposable];</span><br><span class="line">    // 对subscriber做了变换</span><br><span class="line">    subscriber = [[RACPassthroughSubscriber alloc] initWithSubscriber:subscriber signal:self disposable:disposable];</span><br><span class="line"></span><br><span class="line">    if (self.didSubscribe != NULL) &#123;</span><br><span class="line">        RACDisposable *schedulingDisposable = [RACScheduler.subscriptionScheduler schedule:^&#123;</span><br><span class="line">            // 回调s2的^didSubscribe</span><br><span class="line">            RACDisposable *innerDisposable = self.didSubscribe(subscriber);</span><br><span class="line">            [disposable addDisposable:innerDisposable];</span><br><span class="line">        &#125;];</span><br><span class="line"></span><br><span class="line">        [disposable addDisposable:schedulingDisposable];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return disposable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>subscribe:</code>内对<code>_signal</code>做了变换，调了<code>self.didSubscribe(subscriber)</code>回调了<code>s2</code>的<code>didSubscribe</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *s2 = [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        // 此 subscriber 为 RACSubject 类型</span><br><span class="line">        [subscriber sendNext:@&quot;Hello from s2~&quot;];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        </span><br><span class="line">        return [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">            NSLog(@&quot;++s2 Disposed~&quot;);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>

<p><code>didSubscribe</code>内随即通过<code>sendNext:</code>向订阅者（即<code>_signal</code>）发送数据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)sendNext:(id)value &#123;</span><br><span class="line">    [self enumerateSubscribersUsingBlock:^(id&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:value];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)enumerateSubscribersUsingBlock:(void (^)(id&lt;RACSubscriber&gt; subscriber))block &#123;</span><br><span class="line">    NSArray *subscribers;</span><br><span class="line">    @synchronized (self.subscribers) &#123;</span><br><span class="line">        subscribers = [self.subscribers copy];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (id&lt;RACSubscriber&gt; subscriber in subscribers) &#123;</span><br><span class="line">        block(subscriber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_signal</code> 的<code>sendNext:</code>方法遍历之前保存在<code>subscribers</code>数组中的订阅者，向其一一发送数据，三个订阅者依次收到回调~<br>&amp;emsp;</p>
<p><strong>小结</strong>：多播主要是在内部产生<code>RACSubject</code>类型的热信号<code>_signal</code>，进而将多个订阅者保存在其数组中并最终一一向其发送数据。</p>
<h3 id="六-结束语"><a href="#六-结束语" class="headerlink" title="六.结束语"></a>六.结束语</h3><p>以上就是关于RAC中<code>信号</code>和<code>订阅者</code>的分析和简单使用。实践中可以结合RAC其他功能一起使用，后续文章中会继续研究~</p>
<hr>
<p>相关参考：</p>
<p>#<a target="_blank" rel="noopener" href="https://github.com/ReactiveCocoa/ReactiveObjC/blob/master/Documentation/FrameworkOverview.md">©RAC-Github</a></p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#源码" >
    <span class="tag-code">源码</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2019/04/18/majia.html">
        <span class="nav-arrow">← </span>
        
          分包配置
        
      </a>
    
    
      <a class="nav-right" href="/2019/05/25/RAC-async.html">
        
          RAC-异步行为
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
    <!-- 二维码 END -->
    
      <!-- No Comment -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%B8%80-%E4%BF%A1%E5%8F%B7"><span class="toc-nav-text">一.信号</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#1-%E4%BF%A1%E5%8F%B7%E6%98%AF%E5%95%A5"><span class="toc-nav-text">1.信号是啥</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-%E5%86%B7%E7%83%AD%E4%BF%A1%E5%8F%B7"><span class="toc-nav-text">2.冷热信号</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#2-1-%E5%86%B7%E4%BF%A1%E5%8F%B7"><span class="toc-nav-text">#2.1.冷信号</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#2-2-%E7%83%AD%E4%BF%A1%E5%8F%B7"><span class="toc-nav-text">#2.2.热信号</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BA%8C-%E8%AE%A2%E9%98%85%E8%80%85"><span class="toc-nav-text">二.订阅者</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%B8%89-%E5%86%B7%E4%BF%A1%E5%8F%B7%E8%A7%A3%E8%AF%BB"><span class="toc-nav-text">三.冷信号解读</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#1-%E5%88%9B%E5%BB%BA%E4%BF%A1%E5%8F%B7"><span class="toc-nav-text">1.创建信号</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-%E8%AE%A2%E9%98%85%E4%BF%A1%E5%8F%B7"><span class="toc-nav-text">2.订阅信号</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#3-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-nav-text">3.发送消息</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9B%9B-%E7%83%AD%E4%BF%A1%E5%8F%B7%E8%A7%A3%E8%AF%BB"><span class="toc-nav-text">四.热信号解读</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#1-%E5%88%9B%E5%BB%BA%E4%BF%A1%E5%8F%B7-1"><span class="toc-nav-text">1.创建信号</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-%E8%AE%A2%E9%98%85%E4%BF%A1%E5%8F%B7-1"><span class="toc-nav-text">2.订阅信号</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#3-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF-1"><span class="toc-nav-text">3.发送消息</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#4-%E7%94%A8%E4%BD%9C%E4%BB%A3%E7%90%86"><span class="toc-nav-text">4.用作代理</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BA%94-%E7%BB%84%E6%92%AD"><span class="toc-nav-text">五.组播</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#1-%E7%A4%BA%E4%BE%8B"><span class="toc-nav-text">1.示例</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-%E5%AE%9E%E7%8E%B0"><span class="toc-nav-text">2.实现</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%85%AD-%E7%BB%93%E6%9D%9F%E8%AF%AD"><span class="toc-nav-text">六.结束语</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://yoursite.com/2019/05/25/RAC-signal.html';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()
        
        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "RAC-信号与订阅者",
        owner: "",
        repo: "",
        oauth: {
          client_id: "",
          client_secret: ""
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2022 | <a href="https://github.com/davidlii" target="_blank">Davidli</a>
    <br>
    <a href="https://hexo.io" target="_blank">Hexo</a> | Theme-<a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>

  </body>
</html>